<div id="Amortized_Framework0">
<div class="head">
<h1>Theory Amortized_Framework0</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Amortized Complexity (Unary Operations)"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Amortized_Framework0
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
This theory provides a simple amortized analysis framework where all operations
act on a single data type, i.e. no union-like operations. This is the basis of
the ITP 2015 paper by Nipkow. Although it is superseded by the model in
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Amortized_Framework›</span></span></span></span> that allows arbitrarily many parameters, it is still
of interest because of its simplicity.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Amortized <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'o</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> inv_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">init</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> inv_nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">inv</span><span class="main">(</span><span class="free">nxt</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> ppos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="free">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free">init</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">T</span> <span class="free">f</span> <span class="free">s</span> <span class="main">+</span> <span class="free">Φ</span><span class="main">(</span><span class="free">nxt</span> <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="free">Φ</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">U</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free">init</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nxt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">state</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Framework0-inv_state"><span class="command">lemma</span></span> inv_state<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span><span class="main">(</span>state <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_init inv_nxt<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free">T</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">Φ</span><span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="free">Φ</span><span class="main">(</span>state <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Framework0-aeq"><span class="command">lemma</span></span> aeq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>state <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> A <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> <span class="free">Φ</span><span class="main">(</span>state <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p0<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> TA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>state <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> A <span class="free">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute aeq diff_add_cancel le_add_same_cancel2 ppos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv_state<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Amortized_Framework0-aa1"><span class="command">lemma</span></span> aa1<span class="main">:</span> <span class="quoted"><span class="quoted">"A <span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">U</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>state <span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def U inv_state<span class="main">)</span>

<span class="keyword1" id="Amortized_Framework0-ub"><span class="command">lemma</span></span> ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>state <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">U</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>state <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> aa1 order.trans sum_mono TA<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Binary Counter"</span></span>

<span class="keyword1"><span class="command">locale</span></span> BinCounter
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">incr</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">incr</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>True<span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr</span> <span class="main">(</span>False<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> True <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr</span> <span class="main">(</span>True<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> False <span class="main">#</span> <span class="free">incr</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_incr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_incr</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_incr</span> <span class="main">(</span>False<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_incr</span> <span class="main">(</span>True<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">T_incr</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p_incr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> real"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Φ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Φ</span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> length<span class="main">(</span>filter id <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Framework0-A_incr"><span class="command">lemma</span></span> A_incr<span class="main">:</span> <span class="quoted"><span class="quoted">"T_incr <span class="free">bs</span> <span class="main">+</span> <span class="keyword1">Φ</span><span class="main">(</span>incr <span class="free">bs</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1">Φ</span> <span class="free">bs</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_incr_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> incr<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> incr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> T_incr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="keyword1">Φ</span></span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_incr_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_incr_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_incr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> incr.ub

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Dynamic tables: insert only"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_ins</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ins<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">n</span><span class="main">&lt;</span><span class="bound">l</span> <span class="keyword1">then</span> <span class="bound">l</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="bound">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> T_ins"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">-</span> <span class="bound">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> table_insert <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">assumes</span></span> c1<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> ac2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">c</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Amortized_Framework0-ac"><span class="command">lemma</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ac2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Amortized_Framework0-a0"><span class="command">lemma</span></span> a0<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ac <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ac dual_order.strict_trans1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Framework0-b0"><span class="command">lemma</span></span> b0<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ac <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">ins</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">*</span> nat <span class="main">⇒</span> nat <span class="main">*</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> nat<span class="main">(</span>ceiling<span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">*</span> nat <span class="main">=&gt;</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pins</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> b<span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ins<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ins"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="bound">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="main">(</span>b<span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">*</span><span class="bound">l</span> <span class="main">≤</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> T_ins"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">pins</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Pair <span class="skolem">n</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 ac
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>b<span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>b<span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span><span class="main">*</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">c</span><span class="main">*</span><span class="main">(</span>real <span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">/</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">/</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ac2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> real <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> of_int<span class="main">(</span>int<span class="main">(</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> real <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> int_less_real_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_ceiling_iff<span class="main">)</span>
              <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_less_cancel_right1<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>›</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le zero_less_mult_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Pair <span class="skolem">n</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 ac <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> b_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_ins <span class="skolem">s</span> <span class="main">+</span> pins <span class="main">(</span>ins <span class="skolem">s</span><span class="main">)</span> <span class="main">-</span> pins <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">+</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> b<span class="main">*</span>ceiling<span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> b<span class="main">*</span><span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> less_trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span><span class="main">::</span>real"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> b <span class="main">*</span> ceiling<span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> b <span class="main">*</span> <span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_correct<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">-</span> b<span class="main">*</span><span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> b<span class="main">*</span><span class="skolem">l</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">*</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> b<span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b<span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>real <span class="skolem">l</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> ins.ub

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Stack with multipop"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>k</sub> <span class="main">=</span> Push <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Pop <span class="quoted">nat</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxT_stk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>k</sub> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nxT_stk</span> <span class="main">(</span>Push <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nxT_stk</span> <span class="main">(</span>Pop <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> drop <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_stk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>k</sub> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_stk</span> <span class="main">(</span>Push <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_stk</span> <span class="main">(</span>Pop <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> min <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> stack<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted">nxT_stk</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted">T_stk</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"length"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Push <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">|</span> Pop <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Queue"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹See, for example, the book by Okasaki~\cite{Okasaki}.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>q</sub> <span class="main">=</span> Enq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Deq

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> queue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">*</span> <span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxT_q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>q</sub> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nxT_q</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nxT_q</span> Deq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> tl<span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span>tl <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>q</sub> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_q</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_q</span> Deq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> queue<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted">nxT_q</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted">T_q</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Enq <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">|</span> Deq <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balance</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balance</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxt_q2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>q</sub> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nxt_q2</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> balance <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nxt_q2</span> Deq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> balance <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> tl <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_q2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op<span class="hidden">⇩</span><sub>q</sub> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_q2</span> <span class="main">(</span>Enq <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_q2</span> Deq <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> queue2<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted">nxt_q2</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> size <span class="bound">xs</span> <span class="main">≤</span> size <span class="bound">ys</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted">T_q2</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> size <span class="bound">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Enq <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">3</span> <span class="main">|</span> Deq <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Dynamic tables: insert and delete"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> op<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>b</sub> <span class="main">=</span> Ins <span class="main">|</span> Del

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxT_tb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>b</sub> <span class="main">⇒</span> nat<span class="main">*</span>nat <span class="main">⇒</span> nat<span class="main">*</span>nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nxT_tb</span> Ins <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nxT_tb</span> Del <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_tb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>b</sub> <span class="main">⇒</span> nat<span class="main">*</span>nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_tb</span> Ins <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_tb</span> Del <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">=</span><span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> tb<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted">nxT_tb</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="bound">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted">T_tb</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="bound">l</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Ins <span class="main">⇒</span> <span class="numeral">3</span> <span class="main">|</span> Del <span class="main">⇒</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Amortized_Framework">
<div class="head">
<h1>Theory Amortized_Framework</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Amortized Complexity Framework"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Amortized_Framework
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory provides a framework for amortized analysis.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rose_tree <span class="main">=</span> T <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rose_tree list"</span></span>

<span class="keyword1"><span class="command">declare</span></span> length_Suc_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">locale</span></span> Amortized <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> inv_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">.</span> <span class="free">inv</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ss</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">inv</span><span class="main">(</span><span class="free">exec</span> <span class="free">f</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> ppos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">Φ</span> <span class="free">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">.</span> <span class="free">inv</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ss</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span>
 <span class="main">⟹</span> <span class="free">cost</span> <span class="free">f</span> <span class="free">ss</span> <span class="main">+</span> <span class="free">Φ</span><span class="main">(</span><span class="free">exec</span> <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">-</span> sum_list <span class="main">(</span>map <span class="free">Φ</span> <span class="free">ss</span><span class="main">)</span> <span class="main">≤</span> <span class="free">U</span> <span class="free">f</span> <span class="free">ss</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> rose_tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free">arity</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="free">wf</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> rose_tree <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="free">state</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Framework-inv_state"><span class="command">lemma</span></span> inv_state<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">ot</span> <span class="main">⟹</span> <span class="free">inv</span><span class="main">(</span>state <span class="free">ot</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ot</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_exec<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">acost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'s</span> list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">acost</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> <span class="free">cost</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="main">(</span><span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">-</span> sum_list <span class="main">(</span>map <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">acost_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> rose_tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">acost_sum</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> acost <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map state <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">acost_sum</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> rose_tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost_sum</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">cost</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map state <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">cost_sum</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> rose_tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U_sum</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">U</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map state <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">U_sum</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Framework-t_sum_a_sum"><span class="command">lemma</span></span> t_sum_a_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">ot</span> <span class="main">⟹</span> cost_sum <span class="free">ot</span> <span class="main">=</span> acost_sum <span class="free">ot</span> <span class="main">-</span> <span class="free">Φ</span><span class="main">(</span>state <span class="free">ot</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ot</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> acost_def Let_def sum_list_subtractf <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> t_sum_le_a_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">ot</span> <span class="main">⟹</span> cost_sum <span class="free">ot</span> <span class="main">≤</span> acost_sum <span class="free">ot</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute t_sum_a_sum diff_add_cancel le_add_same_cancel2 ppos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv_state<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Amortized_Framework-a_le_U"><span class="command">lemma</span></span> a_le_U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">.</span> <span class="free">inv</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ss</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> acost <span class="free">f</span> <span class="free">ss</span> <span class="main">≤</span> <span class="free">U</span> <span class="free">f</span> <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> acost_def U<span class="main">)</span>

<span class="keyword1" id="Amortized_Framework-a_sum_le_U_sum"><span class="command">lemma</span></span> a_sum_le_U_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">ot</span> <span class="main">⟹</span> acost_sum <span class="free">ot</span> <span class="main">≤</span> U_sum <span class="free">ot</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ot</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T <span class="skolem">f</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> a_le_U<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map state <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> sum_list_mono <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_state<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> t_sum_le_U_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">ot</span> <span class="main">⟹</span> cost_sum <span class="free">ot</span> <span class="main">≤</span> U_sum <span class="free">ot</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> t_sum_le_a_sum a_sum_le_U_sum order.trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> T

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Amortized2›</span></span></span></span> supports the transfer of amortized analysis of one datatype
(<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Amortized arity exec inv cost Φ U›</span></span></span></span> on type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'s›</span></span></span></span>) to an implementation
(primed identifiers on type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'t›</span></span></span></span>).
Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>hom›</span></span></span></span> is assumed to be a homomorphism from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'t›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'s›</span></span></span></span>,
not just w.r.t. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>exec›</span></span></span></span> but also <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>cost›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>U›</span></span></span></span>. The assumptions about
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv'›</span></span></span></span> are weaker than the obvious <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv' = inv ∘ hom›</span></span></span></span>: the latter does
not allow <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv›</span></span></span></span> to be weaker than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>inv'›</span></span></span></span> (which we need in one application).›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Amortized2 <span class="main">=</span> Amortized <span class="quoted"><span class="free">arity</span></span> <span class="quoted"><span class="free">exec</span></span> <span class="quoted"><span class="free">inv</span></span> <span class="quoted"><span class="free">cost</span></span> <span class="quoted"><span class="free">Φ</span></span> <span class="quoted"><span class="free">U</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">exec</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cost</span> <span class="free">Φ</span> <span class="free">U</span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">exec'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'t</span> list <span class="main">⇒</span> <span class="tfree">'t</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cost'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'t</span> list <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">U'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'op</span> <span class="main">⇒</span> <span class="tfree">'t</span> list <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">hom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> exec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> <span class="free">inv'</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ts</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">hom</span><span class="main">(</span><span class="free">exec'</span> <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free">exec</span> <span class="free">f</span> <span class="main">(</span>map <span class="free">hom</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> inv_exec'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">.</span> <span class="free">inv'</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ss</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">inv'</span><span class="main">(</span><span class="free">exec'</span> <span class="free">f</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> inv_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv'</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">inv</span> <span class="main">(</span><span class="free">hom</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> cost'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> <span class="free">inv'</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ts</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">cost'</span> <span class="free">f</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">cost</span> <span class="free">f</span> <span class="main">(</span>map <span class="free">hom</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> U'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ts</span><span class="main">.</span> <span class="free">inv'</span> <span class="bound">s</span><span class="main">;</span> length <span class="free">ts</span> <span class="main">=</span> <span class="free">arity</span> <span class="free">f</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">U'</span> <span class="free">f</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">U</span> <span class="free">f</span> <span class="main">(</span>map <span class="free">hom</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> A'<span class="main">:</span> Amortized <span class="quoted"><span class="free">arity</span></span> <span class="quoted"><span class="free">exec'</span></span> <span class="quoted"><span class="free">inv'</span></span> <span class="quoted"><span class="free">cost'</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="keyword1">o</span> <span class="free">hom</span>"</span></span> <span class="quoted"><span class="free">U'</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec' inv_exec' inv_exec<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_hom ppos<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> U exec' U' map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cost' inv_exec inv_hom <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Amortized_Examples">
<div class="head">
<h1>Theory Amortized_Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Simple Examples"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Amortized_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Amortized_Framework.html">Amortized_Framework</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
This theory applies the amortized analysis framework to a number
of simple classical examples.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Binary Counter"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Bin_Counter
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> op <span class="main">=</span> Empty <span class="main">|</span> Incr

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Incr <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">incr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> bool list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">incr</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>True<span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr</span> <span class="main">(</span>False<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> True <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr</span> <span class="main">(</span>True<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> False <span class="main">#</span> <span class="free">incr</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span>False<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span>True<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> length<span class="main">(</span>filter id <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Examples-a_incr"><span class="command">lemma</span></span> a_incr<span class="main">:</span> <span class="quoted"><span class="quoted">"t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free">bs</span> <span class="main">+</span> Φ<span class="main">(</span>incr <span class="free">bs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">bs</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Φ_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> bool list list <span class="main">⇒</span> bool list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Incr <span class="main">[</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">]</span> <span class="main">=</span> incr <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> bool list list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Incr <span class="main">[</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">]</span> <span class="main">=</span> t<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>r</sub> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Incr <span class="main">⇒</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Φ_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_incr <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Φ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> op.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Bin_Counter *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Stack with multipop"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Multipop
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Push <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Pop <span class="quoted">nat</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Push <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Pop <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Push <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Pop <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span> <span class="main">=</span> drop <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> list list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Push <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Pop <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span> <span class="main">=</span> min <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"length"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Push <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">|</span> Pop <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> op.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Multipop *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Dynamic tables: insert only"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Dyn_Tab1
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tab <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> op <span class="main">=</span> Empty <span class="main">|</span> Ins

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Ins <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> tab list <span class="main">⇒</span> tab"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Ins <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> tab list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Ins <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> arity <span class="main">=</span> <span class="quoted">arity</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="bound">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">-</span> <span class="bound">l</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Ins <span class="main">⇒</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> op.split<span class="main">)</span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Dyn_Tab1 *)</span>

<span class="keyword1"><span class="command">locale</span></span> Dyn_Tab2 <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">assumes</span></span> c1<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
<span class="keyword2"><span class="keyword">assumes</span></span> ac2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">c</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Amortized_Examples-ac"><span class="command">lemma</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ac2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Amortized_Examples-a0"><span class="command">lemma</span></span> a0<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ac <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ac dual_order.strict_trans1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Amortized_Examples-b0"><span class="command">lemma</span></span> b0<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ac <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> tab <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> op <span class="main">=</span> Empty <span class="main">|</span> Ins

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Ins <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">ins</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tab <span class="main">⇒</span> tab"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> nat<span class="main">(</span>ceiling<span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> tab list <span class="main">⇒</span> tab"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Ins <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="main">=</span> ins <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="comment1">(* otherwise fun goes wrong with odd error msg *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> tab list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Ins <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tab <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> b<span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> arity <span class="main">=</span> <span class="quoted">arity</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="bound">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="main">(</span>b<span class="main">/</span><span class="free">a</span><span class="main">)</span><span class="main">*</span><span class="bound">l</span> <span class="main">≤</span> <span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Ins <span class="main">⇒</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Ins
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">l</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 ac
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>b<span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>b<span class="main">/</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span><span class="main">*</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">c</span><span class="main">*</span><span class="main">(</span>real <span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">/</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">/</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ac2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> real <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> of_int<span class="main">(</span>int<span class="main">(</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> ceiling<span class="main">(</span><span class="free">c</span> <span class="main">*</span> real <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> int_less_real_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> less_ceiling_iff<span class="main">)</span>
              <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_less_cancel_right1<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>›</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le zero_less_mult_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Ins
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">l</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 ac <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> b_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span><span class="main">&lt;</span><span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cost Ins <span class="main">[</span><span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">l</span><span class="main">)</span><span class="main">]</span> <span class="main">+</span> Φ <span class="main">(</span>ins <span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ<span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">+</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> b<span class="main">*</span>ceiling<span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> b<span class="main">*</span><span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≠</span><span class="main">0</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> less_trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span><span class="main">::</span>real"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> b <span class="main">*</span> ceiling<span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span> b <span class="main">*</span> <span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_correct<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">-</span> b<span class="main">*</span><span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> b<span class="main">*</span><span class="skolem">l</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">l</span><span class="main">*</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> b<span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b<span class="main">*</span><span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>real <span class="skolem">l</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Dyn_Tab2 *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Dynamic tables: insert and delete"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Dyn_Tab3
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tab <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> op <span class="main">=</span> Empty <span class="main">|</span> Ins <span class="main">|</span> Del

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Ins <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Del <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> tab list <span class="main">⇒</span> tab"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Ins <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">≤</span><span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"op <span class="main">⇒</span> tab list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Ins <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">≤</span><span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="numeral">4</span><span class="main">*</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">l</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="bound">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">else</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">*</span><span class="bound">n</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">l</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="bound">l</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">n</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Ins <span class="main">⇒</span> <span class="numeral">3</span> <span class="main">|</span> Del <span class="main">⇒</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Dyn_Tab3 *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Queue"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹See, for example, the book by Okasaki~\cite{Okasaki}.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Queue
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Enq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Deq

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> queue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">*</span> <span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Enq <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Deq <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> queue list <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Deq <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> tl<span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span>tl <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> queue list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Deq <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Enq <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">|</span> Deq <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> op.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Queue *)</span>

<span class="keyword1"><span class="command">locale</span></span> Queue2
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Enq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Deq

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> queue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">*</span> <span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Enq <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Deq <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">adjust</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">adjust</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> queue list <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> adjust<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Deq <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> adjust <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> tl <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> queue list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Deq <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> tl <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> size <span class="bound">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Enq <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">|</span> Deq <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Queue2 *)</span>

<span class="keyword1"><span class="command">locale</span></span> Queue3
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Enq <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Deq

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> queue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">*</span> <span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Enq <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Deq <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balance</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balance</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> queue list <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> balance<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Deq <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> balance <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> tl <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> <span class="tfree">'a</span> queue list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Enq <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Deq <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> size <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> size <span class="bound">xs</span> <span class="main">≤</span> size <span class="bound">ys</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> size <span class="bound">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span> Empty <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Enq <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="numeral">3</span> <span class="main">|</span> Deq <span class="main">⇒</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Queue3 *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Priority_Queue_ops_merge">
<div class="head">
<h1>Theory Priority_Queue_ops_merge</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Priority_Queue_ops_merge
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Insert <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Del_min <span class="main">|</span> Merge

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Insert <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Del_min <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Merge <span class="main">=</span> <span class="numeral">2</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Skew_Heap_Analysis">
<div class="head">
<h1>Theory Skew_Heap_Analysis</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Skew Heap Analysis"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Skew_Heap_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="../Skew_Heap/Skew_Heap.html">Skew_Heap.Skew_Heap</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <a href="Priority_Queue_ops_merge.html">Priority_Queue_ops_merge</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following proof is a simplified version of the one by Kaldewaij and
Schoenmakers~\cite{KaldewaijS-IPL91}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹right-heavy:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">=&gt;</span> <span class="tfree">'a</span> tree <span class="main">=&gt;</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rh</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> size <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ›</span></span></span></span> in \cite{KaldewaijS-IPL91}: number of right-heavy nodes on left spine.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lrh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lrh</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lrh</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> rh <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="free">lrh</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span> in \cite{KaldewaijS-IPL91}: number of not-right-heavy nodes on right spine.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rlh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rlh</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">rlh</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> rh <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">rlh</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Skew_Heap_Analysis-Gexp"><span class="command">lemma</span></span> Gexp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> lrh <span class="free">t</span> <span class="main">≤</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rh_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> Glog<span class="main">:</span> <span class="quoted"><span class="quoted">"lrh <span class="free">t</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Gexp le_log2_of_power size1_size<span class="main">)</span>

<span class="keyword1" id="Skew_Heap_Analysis-Dexp"><span class="command">lemma</span></span> Dexp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> rlh <span class="free">t</span> <span class="main">≤</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rh_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> Dlog<span class="main">:</span> <span class="quoted"><span class="quoted">"rlh <span class="free">t</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Dexp le_log2_of_power size1_size<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">T_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_merge</span> Leaf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_merge</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_merge</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="keyword1">then</span> <span class="free">T_merge</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="keyword1">else</span> <span class="free">T_merge</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> size <span class="bound">x</span> <span class="main">+</span> size <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> rh <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Skew_Heap_Analysis-Φ_nneg"><span class="command">lemma</span></span> Φ_nneg<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Skew_Heap_Analysis-plus_log_le_2log_plus"><span class="command">lemma</span></span> plus_log_le_2log_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟧</span>
  <span class="main">⟹</span> log <span class="free">b</span> <span class="free">x</span> <span class="main">+</span> log <span class="free">b</span> <span class="free">y</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> mult_2<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> add_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Skew_Heap_Analysis-rh1"><span class="command">lemma</span></span> rh1<span class="main">:</span> <span class="quoted"><span class="quoted">"rh <span class="free">l</span> <span class="free">r</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rh_def<span class="main">)</span>

<span class="keyword1" id="Skew_Heap_Analysis-amor_le_long"><span class="command">lemma</span></span> amor_le_long<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_merge <span class="free">t1</span> <span class="free">t2</span> <span class="main">+</span> Φ <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t1</span> <span class="main">-</span> Φ <span class="free">t2</span> <span class="main">≤</span>
   lrh<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">+</span> rlh <span class="free">t1</span> <span class="main">+</span> rlh <span class="free">t2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l1</span> <span class="skolem">a1</span> <span class="skolem">r1</span> <span class="skolem">l2</span> <span class="skolem">a2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">≤</span> <span class="skolem">a2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l1</span> <span class="skolem">a1</span> <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l2</span> <span class="skolem">a2</span> <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"merge <span class="var">?t2</span> <span class="skolem">r1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_merge <span class="var">?t1</span> <span class="var">?t2</span> <span class="main">+</span> Φ <span class="main">(</span>merge <span class="var">?t1</span> <span class="var">?t2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?t1</span> <span class="main">-</span> Φ <span class="var">?t2</span>
          <span class="main">=</span> T_merge <span class="var">?t2</span> <span class="skolem">r1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="var">?m</span> <span class="main">+</span> Φ <span class="skolem">l1</span> <span class="main">+</span> rh <span class="var">?m</span> <span class="skolem">l1</span> <span class="main">-</span> Φ <span class="var">?t1</span> <span class="main">-</span> Φ <span class="var">?t2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> T_merge <span class="var">?t2</span> <span class="skolem">r1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="var">?m</span> <span class="main">+</span> rh <span class="var">?m</span> <span class="skolem">l1</span> <span class="main">-</span> Φ <span class="skolem">r1</span> <span class="main">-</span> rh <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="main">-</span> Φ <span class="var">?t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lrh <span class="var">?m</span> <span class="main">+</span> rlh <span class="var">?t2</span> <span class="main">+</span> rlh <span class="skolem">r1</span> <span class="main">+</span> rh <span class="var">?m</span> <span class="skolem">l1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">-</span> rh <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lrh <span class="var">?m</span> <span class="main">+</span> rlh <span class="var">?t2</span> <span class="main">+</span> rlh <span class="skolem">r1</span> <span class="main">+</span> rh <span class="var">?m</span> <span class="skolem">l1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> rh <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rh1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lrh <span class="var">?m</span> <span class="main">+</span> rlh <span class="var">?t2</span> <span class="main">+</span> rlh <span class="var">?t1</span> <span class="main">+</span> rh <span class="var">?m</span> <span class="skolem">l1</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lrh <span class="main">(</span>merge <span class="var">?t1</span> <span class="var">?t2</span><span class="main">)</span> <span class="main">+</span> rlh <span class="var">?t1</span> <span class="main">+</span> rlh <span class="var">?t2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Skew_Heap_Analysis-amor_le"><span class="command">lemma</span></span> amor_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_merge <span class="free">t1</span> <span class="free">t2</span> <span class="main">+</span> Φ <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t1</span> <span class="main">-</span> Φ <span class="free">t2</span> <span class="main">≤</span>
   lrh<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">+</span> rlh <span class="free">t1</span> <span class="main">+</span> rlh <span class="free">t2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Skew_Heap_Analysis-a_merge"><span class="command">lemma</span></span> a_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_merge <span class="free">t1</span> <span class="free">t2</span> <span class="main">+</span> Φ<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t1</span> <span class="main">-</span> Φ <span class="free">t2</span> <span class="main">≤</span>
   <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t1</span> <span class="main">+</span> size1 <span class="free">t2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> lrh<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">+</span> rlh <span class="free">t1</span> <span class="main">+</span> rlh <span class="free">t2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> amor_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real<span class="main">(</span>lrh<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> rlh <span class="free">t1</span> <span class="main">+</span> rlh <span class="free">t2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real<span class="main">(</span>lrh<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real<span class="main">(</span>rlh <span class="free">t1</span><span class="main">)</span> <span class="main">+</span> rlh <span class="free">t2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rlh <span class="free">t1</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Dlog<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rlh <span class="free">t2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Dlog<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lrh <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Glog<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size1<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> size1 <span class="free">t1</span> <span class="main">+</span> size1 <span class="free">t2</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size size_merge<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t1</span> <span class="main">+</span> size1 <span class="free">t2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t1</span> <span class="main">+</span> size1 <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t2</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span>size1 <span class="free">t1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>size1 <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plus_log_le_2log_plus<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_insert</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_merge <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1" id="Skew_Heap_Analysis-a_insert"><span class="command">lemma</span></span> a_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"T_insert <span class="free">a</span> <span class="free">t</span> <span class="main">+</span> Φ<span class="main">(</span>skew_heap.insert <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> a_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Node Leaf <span class="free">a</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc T_insert_def rh_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_del_min</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Node <span class="bound">t1</span> <span class="bound">a</span> <span class="bound">t2</span> <span class="main">⇒</span> T_merge <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Skew_Heap_Analysis-a_del_min"><span class="command">lemma</span></span> a_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"T_del_min <span class="free">t</span> <span class="main">+</span> Φ<span class="main">(</span>skew_heap.del_min <span class="free">t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_del_min_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">t1</span> _ <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">t1</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">t1</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Node <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size T_del_min_def rh_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Instantiation of Amortized Framework"</span></span>

<span class="keyword1" id="Skew_Heap_Analysis-T_merge_nneg"><span class="command">lemma</span></span> T_merge_nneg<span class="main">:</span> <span class="quoted"><span class="quoted">"T_merge <span class="free">t1</span> <span class="free">t2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> T_merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> skew_heap.insert <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> skew_heap.del_min <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> T_merge <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Node <span class="bound">t1</span> <span class="bound">a</span> <span class="bound">t2</span> <span class="main">⇒</span> T_merge <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> <span class="main">=</span> T_merge <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">+</span> size1 <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Φ_nneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Insert <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Node Leaf <span class="skolem">a</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc insert_def rh_def T_merge_nneg<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Del_min
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword1"><span class="command">with</span></span> Del_min <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">t1</span> _ <span class="skolem">t2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">t1</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
               log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">t1</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> Del_min Node <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size T_merge_nneg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Merge
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t1</span><span class="main">,</span><span class="skolem">t2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_merge_nneg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lemmas_log">
<div class="head">
<h1>Theory Lemmas_log</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Lemmas_log
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Lemmas_log-ld_sum_inequality"><span class="command">lemma</span></span> ld_sum_inequality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">y</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="free">x</span><span class="main">*</span><span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> numeral_eq_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> powr_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lemmas_log-ld_ld_1_less"><span class="command">lemma</span></span> ld_ld_1_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ld_sum_inequality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="comment1">(*
proof -
  have 1: "2*x*y &lt; (x+y)^2" using assms
    by(simp add: numeral_eq_Suc algebra_simps add_pos_pos)
  show ?thesis
    apply(rule powr_less_cancel_iff[of 2, THEN iffD1])
     apply simp
    using assms 1 by(simp add: powr_add log_powr[symmetric] powr_numeral)
qed
*)</span>

<span class="keyword1" id="Lemmas_log-ld_le_2ld"><span class="command">lemma</span></span> ld_le_2ld<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="free">x</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span><span class="free">x</span><span class="main">+</span><span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">y</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lemmas_log-ld_ld_less2"><span class="command">lemma</span></span> ld_ld_less2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free">y</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main">*</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="free">y</span> <span class="main">≤</span> <span class="free">y</span><span class="main">*</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add log_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> powr_numeral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Splay_Tree_Analysis_Base">
<div class="head">
<h1>Theory Splay_Tree_Analysis_Base</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Splay Tree"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Basics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Tree_Analysis_Base
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Lemmas_log.html">Lemmas_log</a>
  <a href="../Splay_Tree/Splay_Tree.html">Splay_Tree.Splay_Tree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> size1_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> φ <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_splay</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
   EQ <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
   LT <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="keyword1">of</span>
          Leaf <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
          Node <span class="bound">A</span> <span class="bound">a</span> <span class="bound">B</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">a</span> <span class="keyword1">of</span> EQ <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
             LT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">A</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">A</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span>
             GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">B</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">B</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
   GT <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span> <span class="keyword1">of</span>
          Leaf <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
          Node <span class="bound">C</span> <span class="bound">c</span> <span class="bound">D</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">c</span> <span class="keyword1">of</span> EQ <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
             LT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">C</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">C</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span>
             GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">D</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Base-T_splay_simps"><span class="command">lemma</span></span> T_splay_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_splay <span class="free">a</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> T_splay <span class="free">x</span> <span class="main">(</span>Node Leaf <span class="free">b</span> <span class="free">CD</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> T_splay <span class="free">a</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free">A</span> <span class="free">a</span> <span class="free">B</span><span class="main">)</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">a</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> T_splay <span class="free">x</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free">A</span> <span class="free">a</span> <span class="free">B</span><span class="main">)</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">A</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_splay <span class="free">x</span> <span class="free">A</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">&lt;</span><span class="free">x</span> <span class="main">⟹</span> T_splay <span class="free">x</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free">A</span> <span class="free">a</span> <span class="free">B</span><span class="main">)</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">B</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_splay <span class="free">x</span> <span class="free">B</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">x</span> <span class="main">⟹</span> T_splay <span class="free">x</span> <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">a</span> <span class="main">⟹</span> T_splay <span class="free">a</span> <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="main">(</span>Node <span class="free">C</span> <span class="free">a</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">&lt;</span><span class="free">c</span> <span class="main">⟹</span> T_splay <span class="free">x</span> <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="main">(</span>Node <span class="free">C</span> <span class="free">c</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">C</span><span class="main">=</span>Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_splay <span class="free">x</span> <span class="free">C</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">x</span> <span class="main">⟹</span> <span class="free">c</span><span class="main">&lt;</span><span class="free">x</span> <span class="main">⟹</span> T_splay <span class="free">x</span> <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="main">(</span>Node <span class="free">C</span> <span class="free">c</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">D</span><span class="main">=</span>Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_splay <span class="free">x</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> T_splay.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> T_splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_splay_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_splay_max</span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_splay_max</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_splay_max</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">=</span>Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_splay_max</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">0</span>
   <span class="keyword1">else</span> T_splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span>
     <span class="main">(</span><span class="keyword1">case</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
        Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> T_splay_max <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Base-ex_in_set_tree"><span class="command">lemma</span></span> ex_in_set_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> bst <span class="free">t</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">x'</span> <span class="main">∈</span> set_tree <span class="free">t</span><span class="main">.</span> splay <span class="bound">x'</span> <span class="free">t</span> <span class="main">=</span> splay <span class="free">x</span> <span class="free">t</span> <span class="main">∧</span> T_splay <span class="bound">x'</span> <span class="free">t</span> <span class="main">=</span> T_splay <span class="free">x</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">A2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">=</span> Node <span class="skolem">A1</span> <span class="skolem">u</span> <span class="skolem">A2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"6.IH"</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">A</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_tree <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x'</span> <span class="skolem">A</span> <span class="main">=</span> splay <span class="skolem">x</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"T_splay <span class="skolem">x'</span> <span class="skolem">A</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span><span class="main">&lt;</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">B2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">=</span> Node <span class="skolem">B1</span> <span class="skolem">u</span> <span class="skolem">B2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"8.IH"</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">B</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_tree <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x'</span> <span class="skolem">B</span> <span class="main">=</span> splay <span class="skolem">x</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"T_splay <span class="skolem">x'</span> <span class="skolem">B</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">x'</span> <span class="main">&amp;</span> <span class="skolem">x'</span><span class="main">&lt;</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">C</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">C2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">C</span> <span class="main">=</span> Node <span class="skolem">C1</span> <span class="skolem">u</span> <span class="skolem">C2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"11.IH"</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">C</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_tree <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x'</span> <span class="skolem">C</span> <span class="main">=</span> splay <span class="skolem">x</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"T_splay <span class="skolem">x'</span> <span class="skolem">C</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">x'</span> <span class="main">&amp;</span> <span class="skolem">x'</span><span class="main">&lt;</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">D</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D1</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">D2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">D</span> <span class="main">=</span> Node <span class="skolem">D1</span> <span class="skolem">u</span> <span class="skolem">D2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"14.IH"</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">D</span>›</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_tree <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x'</span> <span class="skolem">D</span> <span class="main">=</span> splay <span class="skolem">x</span> <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"T_splay <span class="skolem">x'</span> <span class="skolem">D</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">&lt;</span><span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Splay <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Insert <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Delete <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Splay <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Splay <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> Splay_Tree.insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> Splay_Tree.delete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Splay <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> T_splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> T_insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> T_delete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Splay_Tree_Analysis">
<div class="head">
<h1>Theory Splay_Tree_Analysis</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Splay Tree Analysis"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Tree_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Splay_Tree_Analysis_Base.html">Splay_Tree_Analysis_Base</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Analysis of splay"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A_splay</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A_splay</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_splay <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> Φ<span class="main">(</span>splay <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">-</span> Φ <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following lemma is an attempt to prove a generic lemma that covers
both zig-zig cases. However, the lemma is not as nice as one would like.
Hence it is used only once, as a demo. Ideally the lemma would involve
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> A_splay<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but that is impossible because this involves <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> splay<span class="antiquote"><span class="antiquote">}</span></span></span></span>
and thus depends on the ordering. We would need a truly symmetric version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> splay<span class="antiquote"><span class="antiquote">}</span></span></span></span>
that takes the ordering as an explicit argument. Then we could define
all the symmetric cases by one final equation
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">splay2</span></span> less <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">splay2</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">not</span></span> <span class="keyword1"><span class="keyword1">o</span></span> less<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>mirror <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
This would simplify the code and the proofs.›</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-zig_zig"><span class="command">lemma</span></span> zig_zig<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">lx</span> <span class="free">x</span> <span class="free">rx</span> <span class="free">lb</span> <span class="free">b</span> <span class="free">rb</span> <span class="free">a</span> <span class="free">ra</span> <span class="free">u</span> <span class="free">lb1</span> <span class="free">lb2</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">==</span> Node <span class="free">lx</span> <span class="main">(</span><span class="free">x</span><span class="main">)</span> <span class="free">rx</span>"</span></span> <span class="keyword2"><span class="keyword">defines</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">==</span> Node <span class="free">lb</span> <span class="free">b</span> <span class="free">rb</span>"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">==</span> Node <span class="free">B</span> <span class="free">a</span> <span class="free">ra</span>"</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">==</span> Node <span class="free">rb</span> <span class="free">a</span> <span class="free">ra</span>"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">==</span> Node <span class="free">lb1</span> <span class="free">u</span> <span class="main">(</span>Node <span class="free">lb2</span> <span class="free">b</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> hyps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lb</span> <span class="main">≠</span> <span class="main">⟨⟩</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"T_splay <span class="free">x</span> <span class="free">lb</span> <span class="main">+</span> Φ <span class="free">lb1</span> <span class="main">+</span> Φ <span class="free">lb2</span> <span class="main">-</span> Φ <span class="free">lb</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">lb</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">X</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
 prems<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">lb</span> <span class="main">=</span> size <span class="free">lb1</span> <span class="main">+</span> size <span class="free">lb2</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> subtrees <span class="free">lb</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_splay <span class="free">x</span> <span class="free">lb</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="free">t</span> <span class="main">-</span> φ <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> Node <span class="free">lb2</span> <span class="free">b</span> <span class="free">A'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_splay <span class="free">x</span> <span class="free">lb</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">=</span> T_splay <span class="free">x</span> <span class="free">lb</span> <span class="main">+</span> Φ <span class="free">lb1</span> <span class="main">+</span> Φ <span class="free">lb2</span> <span class="main">-</span> Φ <span class="free">lb</span> <span class="main">+</span> φ <span class="skolem">B'</span> <span class="main">+</span> φ <span class="free">A'</span> <span class="main">-</span> φ <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prems
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_splay_def size_if_splay <span class="dynamic"><span class="dynamic">algebra_simps</span></span> in_set_tree_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">lb</span> <span class="main">+</span> φ <span class="skolem">B'</span> <span class="main">+</span> φ <span class="free">A'</span> <span class="main">-</span> φ <span class="free">B</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">X</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> φ <span class="free">lb</span> <span class="main">+</span> φ <span class="skolem">B'</span> <span class="main">+</span> φ <span class="free">A'</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">X</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> φ <span class="skolem">B'</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">X</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> prems ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="free">lb</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="free">A'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-A_splay_ub"><span class="command">lemma</span></span> A_splay_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bst <span class="free">t</span><span class="main">;</span> Node <span class="free">l</span> <span class="free">x</span> <span class="free">r</span> <span class="main">:</span> subtrees <span class="free">t</span> <span class="main">⟧</span>
  <span class="main">⟹</span> A_splay <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="free">t</span> <span class="main">-</span> φ<span class="main">(</span>Node <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 10 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 12 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 13 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">CD</span><span class="main">)</span>
  <span class="comment1">(* A readable proof *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">B</span><span class="main">⟩</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">CD</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">B</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">CD</span><span class="main">⟩</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="skolem">x</span> <span class="var">?t</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="var">?t'</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> φ <span class="var">?t'</span> <span class="main">+</span> φ <span class="main">⟨</span><span class="skolem">B</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">CD</span><span class="main">⟩</span>  <span class="main">-</span> φ <span class="var">?t</span> <span class="main">-</span> φ <span class="main">⟨</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">B</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> φ <span class="main">⟨</span><span class="skolem">B</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">CD</span><span class="main">⟩</span> <span class="main">-</span> φ <span class="main">⟨</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">B</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span>  <span class="main">1</span> <span class="main">+</span> φ <span class="var">?t</span> <span class="main">-</span> φ<span class="main">(</span>Node <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size1<span class="main">(</span>Node <span class="skolem">B</span> <span class="skolem">b</span> <span class="skolem">CD</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="var">?t</span> <span class="main">-</span> φ<span class="main">(</span>Node <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size1<span class="main">(</span>Node <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">AB</span> <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="comment1">(* An automatic proof *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">AB</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="main">⟨</span><span class="skolem">C</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">D</span><span class="main">⟩</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">AB</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 9 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span>
    log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size1<span class="main">(</span>Node <span class="skolem">AB</span> <span class="skolem">b</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?A</span>"</span></span><span class="main">]</span>
    log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size1<span class="main">(</span>Node <span class="skolem">C</span> <span class="skolem">x</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?A</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_splay_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>log_le_cancel_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> subtrees <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">A2</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">=</span> Node <span class="skolem">A1</span> <span class="skolem">a'</span> <span class="skolem">A2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> splay_not_Leaf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="free">l</span> <span class="skolem">x</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AB</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">B</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ABC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="var">?AB</span> <span class="skolem">b</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A1</span> <span class="skolem">a'</span> <span class="skolem">A2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?BC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">B</span> <span class="skolem">b</span> <span class="skolem">C</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A2BC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A2</span> <span class="skolem">a</span> <span class="var">?BC</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A1A2BC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A1</span> <span class="skolem">a'</span> <span class="var">?A2BC</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="var">?A1A2BC</span> <span class="main">=</span> φ <span class="var">?ABC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="var">?A1A2BC</span> <span class="main">-</span> Φ <span class="var">?ABC</span> <span class="main">=</span> Φ <span class="skolem">A1</span> <span class="main">+</span> Φ <span class="skolem">A2</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> Φ <span class="skolem">A</span> <span class="main">-</span> φ <span class="var">?AB</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="skolem">x</span> <span class="var">?ABC</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="var">?A1A2BC</span> <span class="main">-</span> Φ <span class="var">?ABC</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.hyps"</span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="skolem">A1</span> <span class="main">+</span> Φ <span class="skolem">A2</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> Φ <span class="skolem">A</span> <span class="main">-</span> φ <span class="var">?AB</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">+</span> Φ <span class="var">?A'</span> <span class="main">-</span> φ <span class="var">?A'</span> <span class="main">-</span> Φ <span class="skolem">A</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> A_splay <span class="skolem">x</span> <span class="skolem">A</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">-</span> φ <span class="var">?A'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="skolem">A</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">-</span> φ <span class="var">?A'</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.IH"</span> <span class="quoted">"6.prems"</span><span class="main">(</span>1<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="skolem">A</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> φ <span class="skolem">A</span> <span class="main">+</span> φ <span class="var">?A2BC</span> <span class="main">+</span> φ <span class="var">?BC</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> φ <span class="var">?A2BC</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="var">?ABC</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?BC</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?ABC</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">B</span> <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> subtrees <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B1</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">B2</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">=</span> Node <span class="skolem">B1</span> <span class="skolem">b'</span> <span class="skolem">B2</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> splay_not_Leaf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="free">l</span> <span class="skolem">x</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AB</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">B</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ABC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="var">?AB</span> <span class="skolem">b</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">B1</span> <span class="skolem">b'</span> <span class="skolem">B2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AB1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">B1</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B2C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">B2</span> <span class="skolem">b</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AB1B2C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="var">?AB1</span> <span class="skolem">b'</span> <span class="var">?B2C</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="var">?AB1B2C</span> <span class="main">=</span> φ <span class="var">?ABC</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="var">?AB1B2C</span> <span class="main">-</span> Φ <span class="var">?ABC</span> <span class="main">=</span> Φ <span class="skolem">B1</span> <span class="main">+</span> Φ <span class="skolem">B2</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> Φ <span class="skolem">B</span> <span class="main">-</span> φ <span class="var">?AB</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="skolem">x</span> <span class="var">?ABC</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="var">?AB1B2C</span> <span class="main">-</span> Φ <span class="var">?ABC</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.hyps"</span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="skolem">B1</span> <span class="main">+</span> Φ <span class="skolem">B2</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> Φ <span class="skolem">B</span> <span class="main">-</span> φ <span class="var">?AB</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> T_splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">+</span> Φ <span class="var">?B'</span> <span class="main">-</span> φ <span class="var">?B'</span> <span class="main">-</span> Φ <span class="skolem">B</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> A_splay <span class="skolem">x</span> <span class="skolem">B</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">-</span> φ <span class="var">?B'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="skolem">B</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">-</span> φ <span class="var">?B'</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.IH"</span> <span class="quoted">"8.prems"</span><span class="main">(</span>1<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="skolem">B</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> φ <span class="var">?AB</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> φ <span class="skolem">B</span> <span class="main">+</span> φ <span class="var">?AB1</span> <span class="main">+</span> φ <span class="var">?B2C</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> φ <span class="skolem">B</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="var">?ABC</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="var">?AB1</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?B2C</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?ABC</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="skolem">C</span> <span class="skolem">A</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">∈</span> subtrees <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C1</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="skolem"><span class="skolem">C2</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">C</span> <span class="main">=</span> Node <span class="skolem">C1</span> <span class="skolem">c'</span> <span class="skolem">C2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> splay_not_Leaf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="free">l</span> <span class="skolem">x</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?CD</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">C</span> <span class="skolem">c</span> <span class="skolem">D</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ACD</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A</span> <span class="skolem">b</span> <span class="var">?CD</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">C1</span> <span class="skolem">c'</span> <span class="skolem">C2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C2D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">C2</span> <span class="skolem">c</span> <span class="skolem">D</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AC1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">A</span> <span class="skolem">b</span> <span class="skolem">C1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="skolem">x</span> <span class="var">?ACD</span> <span class="main">=</span> A_splay <span class="skolem">x</span> <span class="skolem">C</span> <span class="main">+</span> φ <span class="var">?C2D</span> <span class="main">+</span> φ <span class="var">?AC1</span> <span class="main">-</span> φ <span class="var">?CD</span> <span class="main">-</span> φ <span class="var">?C'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.hyps"</span> sp
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_splay_def size_if_splay <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="skolem">C</span> <span class="main">+</span> φ <span class="var">?C2D</span> <span class="main">+</span> φ <span class="var">?AC1</span> <span class="main">-</span> φ <span class="var">?CD</span> <span class="main">-</span> φ <span class="var">?C'</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.IH"</span> <span class="quoted">"11.prems"</span><span class="main">(</span>1<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="skolem">C</span> <span class="main">+</span> φ <span class="var">?C2D</span> <span class="main">+</span> φ <span class="var">?AC1</span> <span class="main">-</span> φ <span class="var">?CD</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> φ <span class="skolem">C</span> <span class="main">+</span> φ <span class="var">?C2D</span> <span class="main">+</span> φ <span class="var">?AC1</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> φ <span class="skolem">C</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="var">?ACD</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sp ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="var">?C2D</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?AC1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_splay <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?ACD</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?X</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">CD</span> <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">B</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">CD</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">CD</span> <span class="main">=</span> Node <span class="skolem">C</span> <span class="skolem">c</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> splay_not_Leaf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">CD</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> zig_zig<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">CD</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span> 14 sp 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_splay_def size_if_splay <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="comment1">(* The explicit version:
  have "A_splay x ?A = A_splay x ?R + φ ?B' + φ ?A' - φ ?B - φ ?R' + 1"
    using "14.prems" 1 sp
    by(auto simp: A_splay_def size_if_splay algebra_simps split: tree.split)
  also have "… ≤ 3 * φ ?R + φ ?B' + φ ?A' - φ ?B - φ ?R' - 3 * φ ?X + 2"
    using 14 0 by(auto simp: algebra_simps)
  also have "… = 2 * φ rb + φ ?B' + φ ?A' - φ ?B - 3 * φ ?X + 2"
    using sp by(simp add: size_if_splay)
  also have "… ≤ φ ?R + φ ?B' + φ ?A' - 3 * φ ?X + 2" by(simp)
  also have "… ≤ φ ?B' + 2 * φ ?A - 3 * φ ?X + 1"
    using sp ld_ld_1_less[of "size1 ?R" "size1 ?A'"]
    by(simp add: size_if_splay algebra_simps)
  also have "… ≤ 3 * φ ?A - 3 * φ ?X + 1"
    using sp by(simp add: size_if_splay)
  finally show ?case by simp
*)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-A_splay_ub2"><span class="command">lemma</span></span> A_splay_ub2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">:</span> set_tree <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">:</span> subtrees <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_treeE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="free">t</span> <span class="main">-</span> φ<span class="main">(</span>Node <span class="skolem">l</span> <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> A_splay_ub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> N<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-A_splay_ub3"><span class="command">lemma</span></span> A_splay_ub3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"A_splay <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ex_in_set_tree<span class="main">[</span><span class="operator">OF</span> this assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> set_tree <span class="free">t</span>"</span></span>  <span class="quoted"><span class="quoted">"splay <span class="skolem">x'</span> <span class="free">t</span> <span class="main">=</span> splay <span class="free">x</span> <span class="free">t</span>"</span></span>  <span class="quoted"><span class="quoted">"T_splay <span class="skolem">x'</span> <span class="free">t</span> <span class="main">=</span> T_splay <span class="free">x</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A_splay_ub2<span class="main">[</span><span class="operator">OF</span> assms a'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def a'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Analysis of insert"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-amor_insert"><span class="command">lemma</span></span> amor_insert<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_insert <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> Φ<span class="main">(</span>Splay_Tree.insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_insert_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">e</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust splay_Leaf_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>T_splay <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Plr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">l</span> <span class="main">+</span> Φ <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?slr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> real<span class="main">(</span>size1 <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?slr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> Φ <span class="main">(</span>splay <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="var">?Ps</span>  <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_splay_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="free">t</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span> A_splay_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> less_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span><span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> nneg<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> Leaf›</span></span> opt <span class="quoted"><span class="quoted">‹<span class="skolem">e</span><span class="main">=</span><span class="free">x</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_insert_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span><span class="main">)</span> <span class="main">+</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?LR</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span><span class="main">&lt;</span><span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_insert_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> opt size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?slr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>distrib_left_numeral<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> real<span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span><span class="main">)</span> <span class="main">+</span> <span class="var">?R</span> <span class="main">+</span> <span class="var">?LR</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_insert_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> opt size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?slr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>distrib_left_numeral<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Analysis of delete"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A_splay_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A_splay_max</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_splay_max <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> Φ<span class="main">(</span>splay_max <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">-</span> Φ <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-A_splay_max_ub"><span class="command">lemma</span></span> A_splay_max_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> A_splay_max <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> one_le_log_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">A</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_max_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> one_le_log_cancel_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">b</span> <span class="skolem">rl</span> <span class="skolem">c</span> <span class="skolem">rr</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">=</span> Leaf"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> one_le_log_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> size1 <span class="skolem">rl</span>"</span></span><span class="main">]</span>
        one_le_log_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> size1 <span class="skolem">l</span> <span class="main">+</span> size1 <span class="skolem">rl</span>"</span></span><span class="main">]</span>
        log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">l</span> <span class="main">+</span> size1 <span class="skolem">rl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> size1 <span class="skolem">l</span> <span class="main">+</span> size1 <span class="skolem">rl</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_splay_max_def <span class="dynamic"><span class="dynamic">field_simps</span></span>
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> log_le_cancel_iff one_le_log_cancel_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">≠</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay_max <span class="skolem">rr</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">u</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> splay_max_Leaf_iff tree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">rr</span> <span class="main">=</span> size <span class="skolem">l'</span> <span class="main">+</span> size <span class="skolem">r'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_splay_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rr</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">rl</span> <span class="skolem">c</span> <span class="skolem">rr</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">b</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">b</span> <span class="skolem">rl</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="var">?B'</span> <span class="skolem">c</span> <span class="skolem">l'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A_splay_max <span class="var">?B</span> <span class="main">=</span> A_splay_max <span class="skolem">rr</span> <span class="main">+</span> φ <span class="var">?B'</span> <span class="main">+</span> φ <span class="var">?C'</span> <span class="main">-</span> φ <span class="skolem">rr</span> <span class="main">-</span> φ <span class="var">?C</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> sp 1
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_max_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>φ <span class="skolem">rr</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> φ <span class="var">?B'</span> <span class="main">+</span> φ <span class="var">?C'</span> <span class="main">-</span> φ <span class="skolem">rr</span> <span class="main">-</span> φ <span class="var">?C</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="quoted"><span class="quoted">‹<span class="skolem">rr</span> <span class="main">≠</span> Leaf›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="skolem">rr</span> <span class="main">+</span> φ <span class="var">?B'</span> <span class="main">+</span> φ <span class="var">?C'</span> <span class="main">-</span> φ <span class="var">?C</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> φ <span class="skolem">rr</span> <span class="main">+</span> φ <span class="var">?B'</span> <span class="main">+</span> φ <span class="var">?C'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="var">?B</span> <span class="main">+</span> φ <span class="var">?C'</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="var">?B'</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">rr</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="var">?B</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-A_splay_max_ub3"><span class="command">lemma</span></span> A_splay_max_ub3<span class="main">:</span> <span class="quoted"><span class="quoted">"A_splay_max <span class="free">t</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_max_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A_splay_max_ub<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis-amor_delete"><span class="command">lemma</span></span> amor_delete<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_delete <span class="free">a</span> <span class="free">t</span> <span class="main">+</span> Φ<span class="main">(</span>Splay_Tree.delete <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">6</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">x</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="free">a</span> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">x</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">e</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust splay_Leaf_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>T_splay <span class="free">a</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Plr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">l</span> <span class="main">+</span> Φ <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?slr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> real<span class="main">(</span>size1 <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?slr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lslr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">ls</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">rs</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lslr</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> Φ <span class="main">(</span>splay <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="var">?Ps</span>  <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_splay_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="free">t</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span> A_splay_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span><span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> opt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lslr</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Leaf opt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="quoted"><span class="quoted">‹<span class="var">?lslr</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">y</span> <span class="skolem">lr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay_max <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">y</span> <span class="skolem">lr</span><span class="main">)</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">y'</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> splay_max_Leaf_iff tree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bst_splay<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="free">t</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">r'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> optm<span class="main">:</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>T_splay_max <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> Φ <span class="main">(</span>splay_max <span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">l</span>  <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> φ <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_splay_max_ub3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">,</span> <span class="operator">simplified</span> A_splay_max_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> Node<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span><span class="main">+</span><span class="main">(</span>real<span class="main">(</span>size <span class="skolem">l'</span><span class="main">)</span><span class="main">+</span>real<span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span><span class="main">+</span><span class="main">(</span>real<span class="main">(</span>size <span class="skolem">l</span><span class="main">)</span><span class="main">+</span>real<span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> size_splay_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> Node <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">l'</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="skolem">l'</span> <span class="main">+</span> size1 <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="skolem">l'</span> <span class="main">+</span> size1 <span class="skolem">r'</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="var">?slr</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span>size <span class="skolem">ll</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real<span class="main">(</span>size <span class="skolem">lr</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?lslr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> size_if_splay<span class="main">[</span><span class="operator">OF</span> sp<span class="main">]</span> Node <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> add_mono<span class="main">[</span><span class="operator">OF</span> opt optm<span class="main">]</span> Node 3
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 4 <span class="quoted"><span class="quoted">‹Φ <span class="skolem">r'</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Overall analysis"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Splay <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Delete <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted">bst</span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Splay <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Splay bst_splay<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bst_splay<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> splay_bstL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main"><span class="main">]</span></span> splay_bstR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 1 Delete <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_delete<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Splay <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Splay A_splay_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_splay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Insert <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> amor_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Delete <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> amor_delete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Splay_Tree_Analysis_Optimal">
<div class="head">
<h1>Theory Splay_Tree_Analysis_Optimal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Splay Tree Analysis (Optimal)"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Tree_Analysis_Optimal
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Splay_Tree_Analysis_Base.html">Splay_Tree_Analysis_Base</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Sum_of_Squares.html">HOL-Library.Sum_of_Squares</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This analysis follows Schoenmakers~\cite{Schoenmakers-IPL93}.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Analysis of splay"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Splay_Analysis <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">β</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">assumes</span></span> a1<span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">y</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">z</span><span class="main">⟧</span> <span class="main">⟹</span>
 <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span><span class="main">+</span><span class="free">z</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">+</span><span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">1</span> <span class="main">≤</span> <span class="free">l'</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">r'</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">lr</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span><span class="main">+</span><span class="free">r</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span><span class="main">+</span><span class="free">r'</span><span class="main">+</span><span class="free">r</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span>
    <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">r'</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">lr</span><span class="main">+</span><span class="free">r'</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">lr</span><span class="main">+</span><span class="free">r'</span><span class="main">+</span><span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">1</span> <span class="main">≤</span> <span class="free">l'</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">r'</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">ll</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">α</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">ll</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">r'</span><span class="main">+</span><span class="free">r</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span>
  <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">r'</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">ll</span><span class="main">+</span><span class="free">r'</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span><span class="main">+</span><span class="free">ll</span><span class="main">+</span><span class="free">r'</span><span class="main">+</span><span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl2"><span class="command">lemma</span></span> nl2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ll</span> <span class="main">≥</span> <span class="main">1</span><span class="main">;</span> <span class="free">lr</span> <span class="main">≥</span> <span class="main">1</span><span class="main">;</span> <span class="free">r</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  log <span class="free">α</span> <span class="main">(</span><span class="free">ll</span> <span class="main">+</span> <span class="free">lr</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="free">lr</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">≤</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="free">ll</span> <span class="main">+</span> <span class="free">lr</span><span class="main">)</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="free">ll</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> a1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">β</span></span><span class="main"><span class="main">]</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> A1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">+</span> size1 <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> φ <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_splay <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> Φ<span class="main">(</span>splay <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">-</span> Φ <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-A_simps"><span class="command">lemma</span></span> A_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"A <span class="free">a</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&lt;</span><span class="free">b</span> <span class="main">⟹</span> A <span class="free">a</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free">ll</span> <span class="free">a</span> <span class="free">lr</span><span class="main">)</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> φ <span class="free">lr</span> <span class="free">r</span> <span class="main">-</span> φ <span class="free">lr</span> <span class="free">ll</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&lt;</span><span class="free">a</span> <span class="main">⟹</span> A <span class="free">a</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">b</span> <span class="main">(</span>Node <span class="free">rl</span> <span class="free">a</span> <span class="free">rr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> φ <span class="free">rl</span> <span class="free">l</span> <span class="main">-</span> φ <span class="free">rr</span> <span class="free">rl</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def φ_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1" id="Splay_Tree_Analysis_Optimal-A_ub"><span class="command">lemma</span></span> A_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bst <span class="free">t</span><span class="main">;</span> Node <span class="free">la</span> <span class="free">a</span> <span class="free">ra</span> <span class="main">:</span> subtrees <span class="free">t</span> <span class="main">⟧</span>
  <span class="main">⟹</span> A <span class="free">a</span> <span class="free">t</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span><span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">/</span><span class="main">(</span>size1 <span class="free">la</span> <span class="main">+</span> size1 <span class="free">ra</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 10 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 12 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 13 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_tree_if<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">b</span> <span class="skolem">a</span> <span class="skolem">lb</span> <span class="skolem">rb</span> <span class="skolem">ra</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> set_tree <span class="skolem">ra</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> nl2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">lb</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">rb</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">ra</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def log_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">la</span> <span class="skolem">lb</span> <span class="skolem">rb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> set_tree <span class="skolem">la</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> nl2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">rb</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">lb</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">la</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ_def log_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">a</span> <span class="skolem">lb</span> <span class="skolem">rb</span> <span class="skolem">ra</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">rb</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">ra</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">lb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lu</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">ru</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">lb</span> <span class="main">=</span> Node <span class="skolem">lu</span> <span class="skolem">u</span> <span class="skolem">ru</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">lb</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">lu</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">ru</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">rb</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">ra</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?rb</span> <span class="main">+</span> <span class="var">?r</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?rb</span> <span class="main">+</span> <span class="var">?ru</span> <span class="main">+</span> <span class="var">?r</span><span class="main">)</span> <span class="main">≤</span>
        <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?rb</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?rb</span> <span class="main">+</span> <span class="var">?ru</span> <span class="main">+</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">≤</span><span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> a1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?L</span> <span class="main">≤</span> <span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A2<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="var"><span class="quoted"><span class="var">?rb</span></span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add add_ac mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">β</span></span><span class="main"><span class="main">]</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 0 1 sp
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def φ_def size_if_splay <span class="dynamic"><span class="dynamic">algebra_simps</span></span> log_divide<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">rb</span> <span class="skolem">lb</span> <span class="skolem">ra</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">lb</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">ra</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">rb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lu</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">ru</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">rb</span> <span class="main">=</span> Node <span class="skolem">lu</span> <span class="skolem">u</span> <span class="skolem">ru</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">rb</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">lu</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">ru</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">lb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">ra</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?lb</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?ru</span> <span class="main">+</span> <span class="var">?r</span><span class="main">)</span> <span class="main">≤</span>
        <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?lb</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?lb</span> <span class="main">+</span> <span class="var">?ru</span> <span class="main">+</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">≤</span><span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> a1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?L</span> <span class="main">≤</span> <span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A3<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">β</span></span><span class="main"><span class="main">]</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 8 0 1 sp
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def size_if_splay φ_def log_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">lb</span> <span class="skolem">la</span> <span class="skolem">rb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">rb</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">la</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">lb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.prems"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lu</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">ru</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">lb</span> <span class="main">=</span> Node <span class="skolem">lu</span> <span class="skolem">u</span> <span class="skolem">ru</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"11.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">lb</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">lu</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">ru</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">la</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">rb</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?l</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?ru</span> <span class="main">+</span> <span class="var">?rb</span><span class="main">)</span> <span class="main">≤</span>
        <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span> <span class="main">+</span> <span class="var">?rb</span><span class="main">)</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?ru</span> <span class="main">+</span> <span class="var">?rb</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">≤</span><span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> a1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?L</span> <span class="main">≤</span> <span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A3<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="var"><span class="quoted"><span class="var">?rb</span></span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">β</span></span><span class="main"><span class="main">]</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 11 0 1 sp
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def size_if_splay φ_def log_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">a</span> <span class="skolem">x</span> <span class="skolem">b</span> <span class="skolem">rb</span> <span class="skolem">la</span> <span class="skolem">lb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">lb</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> set_tree <span class="skolem">la</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_tree <span class="skolem">rb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">&lt;</span><span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lu</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">ru</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">rb</span> <span class="main">=</span> Node <span class="skolem">lu</span> <span class="skolem">u</span> <span class="skolem">ru</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"14.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">x</span> <span class="skolem">rb</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?la</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">la</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">lb</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">lu</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">ru</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?la</span> <span class="main">+</span> <span class="var">?lb</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?la</span> <span class="main">+</span> <span class="var">?lb</span><span class="main">)</span> <span class="main">≤</span>
        <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?lb</span> <span class="main">+</span> <span class="var">?ru</span><span class="main">)</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?lu</span> <span class="main">+</span> <span class="var">?lb</span> <span class="main">+</span> <span class="var">?ru</span> <span class="main">+</span> <span class="var">?la</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">≤</span><span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> a1<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?L</span> <span class="main">≤</span> <span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A2<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="var"><span class="quoted"><span class="var">?la</span></span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add add_ac mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">β</span></span><span class="main"><span class="main">]</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 14 0 1 sp
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def size_if_splay φ_def log_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-A_ub2"><span class="command">lemma</span></span> A_ub2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> set_tree <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"A <span class="free">a</span> <span class="free">t</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span><span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="skolem"><span class="skolem">ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">la</span> <span class="free">a</span> <span class="skolem">ra</span> <span class="main">:</span> subtrees <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_treeE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A <span class="free">a</span> <span class="free">t</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span><span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">/</span><span class="main">(</span>size1 <span class="skolem">la</span> <span class="main">+</span> size1 <span class="skolem">ra</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> A_ub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> N<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span><span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-A_ub3"><span class="command">lemma</span></span> A_ub3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"A <span class="free">a</span> <span class="free">t</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ex_in_set_tree<span class="main">[</span><span class="operator">OF</span> this assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    a'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> set_tree <span class="free">t</span>"</span></span>  <span class="quoted"><span class="quoted">"splay <span class="skolem">a'</span> <span class="free">t</span> <span class="main">=</span> splay <span class="free">a</span> <span class="free">t</span>"</span></span>  <span class="quoted"><span class="quoted">"T_splay <span class="skolem">a'</span> <span class="free">t</span> <span class="main">=</span> T_splay <span class="free">a</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="free">α</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A_ub2<span class="main">[</span><span class="operator">OF</span> assms a'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def a' log_divide<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Am</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Am</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_splay_max <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> Φ<span class="main">(</span>splay_max <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">-</span> Φ <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-Am_simp3'"><span class="command">lemma</span></span> Am_simp3'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">c</span><span class="main">&lt;</span><span class="free">b</span><span class="main">;</span> bst <span class="free">rr</span><span class="main">;</span> <span class="free">rr</span> <span class="main">≠</span> Leaf<span class="main">⟧</span> <span class="main">⟹</span>
  Am <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="main">(</span>Node <span class="free">rl</span> <span class="free">b</span> <span class="free">rr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> splay_max <span class="free">rr</span> <span class="keyword1">of</span> Node <span class="bound">rrl</span> <span class="main"><span class="bound">_</span></span> <span class="bound">rrr</span> <span class="main">⇒</span>
   Am <span class="free">rr</span> <span class="main">+</span> φ <span class="bound">rrl</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">c</span> <span class="free">rl</span><span class="main">)</span> <span class="main">+</span> φ <span class="free">l</span> <span class="free">rl</span> <span class="main">-</span> φ <span class="free">rl</span> <span class="free">rr</span> <span class="main">-</span> φ <span class="bound">rrl</span> <span class="bound">rrr</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Am_def φ_def size_if_splay_max <span class="dynamic"><span class="dynamic">algebra_simps</span></span> neq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-Am_ub"><span class="command">lemma</span></span> Am_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bst <span class="free">t</span><span class="main">;</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟧</span> <span class="main">⟹</span> Am <span class="free">t</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span><span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Am_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">l</span> <span class="skolem">b</span> <span class="skolem">rl</span> <span class="skolem">c</span> <span class="skolem">rr</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">=</span> Leaf"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nl2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">rl</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">l</span>"</span></span><span class="main">]</span> log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">+</span> real<span class="main">(</span>size <span class="skolem">rl</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Am_def φ_def log_divide <span class="dynamic"><span class="dynamic">field_simps</span></span>
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> log_le_cancel_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">≠</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"splay_max <span class="skolem">rr</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">u</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> splay_max_Leaf_iff tree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">rr</span> <span class="main">=</span> size <span class="skolem">l'</span> <span class="main">+</span> size <span class="skolem">r'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_splay_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rr</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">rl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size1 <span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?l'</span> <span class="main">+</span> <span class="var">?r'</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?l</span> <span class="main">+</span> <span class="var">?rl</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?l'</span> <span class="main">+</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?rl</span><span class="main">)</span> <span class="main">≤</span>
      <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?l'</span> <span class="main">+</span> <span class="var">?r'</span><span class="main">)</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?l'</span> <span class="main">+</span> <span class="var">?rl</span> <span class="main">+</span> <span class="var">?r'</span><span class="main">)</span> <span class="main">+</span> log <span class="free">α</span> <span class="main">(</span><span class="var">?l'</span> <span class="main">+</span> <span class="var">?rl</span> <span class="main">+</span> <span class="var">?r'</span> <span class="main">+</span> <span class="var">?l</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">≤</span><span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> powr_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> a1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?L</span> <span class="main">≤</span> <span class="free">α</span> <span class="keyword1">powr</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A2<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="var"><span class="quoted"><span class="var">?rl</span></span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_add add.commute add.left_commute mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">β</span></span><span class="main"><span class="main">]</span></span> powr_powr<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 sp 1 <span class="quoted"><span class="quoted">‹<span class="skolem">rr</span> <span class="main">≠</span> Leaf›</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Am_simp3' φ_def log_divide <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-Am_ub3"><span class="command">lemma</span></span> Am_ub3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Am <span class="free">t</span> <span class="main">≤</span> log <span class="free">α</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Am_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="free">α</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Am_ub<span class="main">[</span><span class="operator">OF</span> assms <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Am_def log_divide<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Optimal Interpretation"</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-mult_root_eq_root"><span class="command">lemma</span></span> mult_root_eq_root<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root <span class="free">n</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> root <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_root_mult real_root_pos2<span class="main">)</span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-mult_root_eq_root2"><span class="command">lemma</span></span> mult_root_eq_root2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">*</span> root <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> root <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_root_mult real_root_pos2<span class="main">)</span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-powr_inverse_numeral"><span class="command">lemma</span></span> powr_inverse_numeral<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> numeral <span class="free">n</span><span class="main">)</span> <span class="main">=</span> root <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_powr_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> root_simps <span class="main">=</span> mult_root_eq_root mult_root_eq_root2 powr_inverse_numeral


<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl31"><span class="command">lemma</span></span> nl31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">l'</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span><span class="main">;</span> <span class="free">r'</span> <span class="main">≥</span> <span class="main">1</span><span class="main">;</span> <span class="free">lr</span> <span class="main">≥</span> <span class="main">1</span><span class="main">;</span> <span class="free">r</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"(((A&lt;0 * R&lt;1) + (R&lt;1 * (R&lt;1 * [r + ~1*l' + lr + ~1*r']^2))))"</span><span class="main">)</span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl32"><span class="command">lemma</span></span> nl32<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">lr</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zero_le_power2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> nl31<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> 1 2 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl3"><span class="command">lemma</span></span> nl3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">lr</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>
       <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">lr</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> nl32<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> 1 2 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl41"><span class="command">lemma</span></span> nl41<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sos</span> <span class="quoted">"(((A&lt;0 * R&lt;1) + (R&lt;1 * (R&lt;1 * [r + ~1*l' + ~1*ll + r']^2))))"</span><span class="main">)</span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl42"><span class="command">lemma</span></span> nl42<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zero_le_power2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> nl41<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> 1 2 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> numeral_eq_Suc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> distrib_right_numeral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-nl4"><span class="command">lemma</span></span> nl4<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ll</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span>
    <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="free">ll</span> <span class="main">+</span> <span class="free">r'</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span><span class="main">^</span><span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">+</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> nl42<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> 1 2 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-cancel"><span class="command">lemma</span></span> cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&gt;</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">y</span> <span class="main">*</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">*</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free">y</span> <span class="main">*</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">*</span> <span class="free">u</span> <span class="main">*</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square power3_eq_cube<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> S34<span class="main">:</span> Splay_Analysis <span class="quoted"><span class="quoted">"root <span class="numeral">3</span> <span class="numeral">4</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_simps<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc split_mult_pos_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_simps cancel nl3<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_simps cancel nl4<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1" id="Splay_Tree_Analysis_Optimal-log4_log2"><span class="command">lemma</span></span> log4_log2<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">4</span> <span class="free">x</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">4</span> <span class="free">x</span> <span class="main">=</span> log <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> log_base_pow<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> log_base_root<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-A34_ub"><span class="command">lemma</span></span> A34_ub<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S34.A <span class="free">a</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S34.A <span class="free">a</span> <span class="free">t</span> <span class="main">≤</span> log <span class="main">(</span>root <span class="numeral">3</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> S34.A_ub3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log4_log2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Tree_Analysis_Optimal-Am34_ub"><span class="command">lemma</span></span> Am34_ub<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"S34.Am <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S34.Am <span class="free">t</span> <span class="main">≤</span> log <span class="main">(</span>root <span class="numeral">3</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> S34.Am_ub3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log4_log2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Overall analysis"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Splay <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">5</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Delete <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted">bst</span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">S34.Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Splay <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Splay bst_splay<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bst_splay<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> splay_bstL<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main"><span class="main">]</span></span> splay_bstR<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 1 Delete <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_delete<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.A_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Splay <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> S34.A_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">]</span> Splay
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.A_def log4_log2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Insert <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def log4_log2 T_insert_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≠</span> Leaf"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">a</span> <span class="skolem">t</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">e</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust splay_Leaf_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>T_splay <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Plr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"S34.Φ <span class="skolem">l</span> <span class="main">+</span> S34.Φ <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"S34.Φ <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?slr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> real<span class="main">(</span>size1 <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?slr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> S34.Φ <span class="main">(</span>splay <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="var">?Ps</span>  <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S34.A_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span> S34.A_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log4_log2<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> less_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span><span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> nneg<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≠</span> Leaf›</span></span> opt <span class="quoted"><span class="quoted">‹<span class="skolem">e</span><span class="main">=</span><span class="skolem">a</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> T_insert_def<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> nneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">&lt;</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span><span class="main">)</span> <span class="main">+</span> <span class="var">?L</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="var">?LR</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span><span class="main">&lt;</span><span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def log4_log2 T_insert_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> opt size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def log4_log2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?slr</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>distrib_left_numeral<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> real<span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span><span class="main">)</span> <span class="main">+</span> <span class="var">?R</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="var">?LR</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≠</span> Leaf›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&lt;</span><span class="skolem">e</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def log4_log2 T_insert_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> <span class="var">?Plr</span> <span class="main">-</span> <span class="var">?Ps</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> opt size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def log4_log2<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LR</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="var">?slr</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="var">?slr</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>distrib_left_numeral<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Delete <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def S34.φ_def log4_log2<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">x</span> <span class="skolem">rs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="skolem">a</span> <span class="main">(</span>Node <span class="skolem">ls</span> <span class="skolem">x</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">e</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust splay_Leaf_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>T_splay <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Plr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"S34.Φ <span class="skolem">l</span> <span class="main">+</span> S34.Φ <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"S34.Φ <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?slr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> real<span class="main">(</span>size1 <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?LR</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?slr</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lslr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">ls</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">rs</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lslr</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">+</span> S34.Φ <span class="main">(</span>splay <span class="skolem">a</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="var">?Ps</span>  <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S34.A_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span> S34.A_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log4_log2 <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">=</span><span class="skolem">a</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> opt
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lslr</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Leaf
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S34.φ Leaf <span class="skolem">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Leaf opt
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lslr</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">y</span> <span class="skolem">lr</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
            <span class="quoted"><span class="quoted">"splay_max <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">y</span> <span class="skolem">lr</span><span class="main">)</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">y'</span> <span class="skolem">r'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> splay_max_Leaf_iff tree.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bst <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bst_splay<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">t</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S34.Φ <span class="skolem">r'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> optm<span class="main">:</span> <span class="quoted"><span class="quoted">"real<span class="main">(</span>T_splay_max <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> S34.Φ <span class="main">(</span>splay_max <span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> S34.Φ <span class="skolem">l</span>
            <span class="main">≤</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> S34.Am_ub3<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst <span class="skolem">l</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span> S34.Am_def<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log4_log2 <span class="dynamic"><span class="dynamic">field_simps</span></span> Node<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">4</span> <span class="main">(</span><span class="numeral">2</span><span class="main">+</span><span class="main">(</span>real<span class="main">(</span>size <span class="skolem">l'</span><span class="main">)</span><span class="main">+</span>real<span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            log <span class="numeral">4</span> <span class="main">(</span><span class="numeral">2</span><span class="main">+</span><span class="main">(</span>real<span class="main">(</span>size <span class="skolem">l</span><span class="main">)</span><span class="main">+</span>real<span class="main">(</span>size <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> size_splay_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> Node <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">4</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">l'</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"S34.φ <span class="skolem">l'</span> <span class="skolem">r</span> <span class="main">≤</span> S34.φ <span class="skolem">l'</span> <span class="skolem">r'</span> <span class="main">+</span> S34.φ <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S34.φ_def<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span>size <span class="skolem">ll</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real<span class="main">(</span>size <span class="skolem">lr</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?lslr</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> size_if_splay<span class="main">[</span><span class="operator">OF</span> sp<span class="main">]</span> Node <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> add_mono<span class="main">[</span><span class="operator">OF</span> opt optm<span class="main">]</span> Node 3
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Splay_Tree.delete_def T_delete_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> 4 <span class="quoted"><span class="quoted">‹S34.Φ <span class="skolem">r'</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Priority_Queue_ops">
<div class="head">
<h1>Theory Priority_Queue_ops</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Priority_Queue_ops
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> op <span class="main">=</span> Empty <span class="main">|</span> Insert <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Del_min

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> op <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Insert <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> Del_min <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Splay_Heap_Analysis">
<div class="head">
<h1>Theory Splay_Heap_Analysis</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Splay Heap"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Heap_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Splay_Tree/Splay_Heap.html">Splay_Tree.Splay_Heap</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <a href="Priority_Queue_ops.html">Priority_Queue_ops</a>
  <a href="Lemmas_log.html">Lemmas_log</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Timing functions must be kept in sync with the corresponding functions
on splay heaps.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_part</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_part</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_part</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
     <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
       Leaf <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
       Node <span class="bound">rl</span> <span class="bound">b</span> <span class="bound">rr</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free">T_part</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">rr</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_part</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">rl</span> <span class="main">+</span> <span class="main">1</span>
   <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span>
       Leaf <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
       Node <span class="bound">ll</span> <span class="bound">b</span> <span class="bound">lr</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free">T_part</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">lr</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_part</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">ll</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_in</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> T_part <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_dm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_dm</span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_dm</span> <span class="main">(</span>Node Leaf <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_dm</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span><span class="main">=</span>Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">T_dm</span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> φ <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Splay_Heap_Analysis-amor_del_min"><span class="command">lemma</span></span> amor_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"T_dm <span class="free">t</span> <span class="main">+</span> Φ <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> T_dm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ll</span> <span class="skolem">a</span> <span class="skolem">lr</span> <span class="skolem">b</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">a</span> <span class="skolem">lr</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ll</span> <span class="main">=</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="skolem">lr</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size1 <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>
        <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="skolem">lr</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>size1 <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size1 <span class="skolem">lr</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ll<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">ll</span> <span class="main">=</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"del_min <span class="skolem">ll</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">ll</span> <span class="skolem">a</span> <span class="skolem">lr</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="var">?s</span> <span class="skolem">b</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">lr</span> <span class="skolem">b</span> <span class="skolem">r</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="var">?l'</span> <span class="skolem">a</span> <span class="var">?s'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="var">?t'</span> <span class="main">≤</span> φ <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="skolem">ll</span> <span class="main">&lt;</span> φ <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="skolem">ll</span> <span class="main">+</span> size1 <span class="var">?s'</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="var">?t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_dm <span class="var">?t</span> <span class="main">+</span> Φ <span class="main">(</span>del_min <span class="var">?t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?t</span>
        <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> T_dm <span class="skolem">ll</span> <span class="main">+</span> Φ <span class="main">(</span>del_min <span class="var">?t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="skolem">ll</span> <span class="main">+</span> Φ <span class="skolem">ll</span> <span class="main">-</span> Φ <span class="var">?l'</span>  <span class="main">+</span> Φ <span class="main">(</span>del_min <span class="var">?t</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 ll <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="skolem">ll</span> <span class="main">+</span> φ <span class="var">?t'</span> <span class="main">+</span> φ <span class="var">?s'</span> <span class="main">-</span> φ <span class="var">?t</span> <span class="main">-</span> φ <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> φ <span class="skolem">ll</span> <span class="main">+</span> φ <span class="var">?s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="var">?t</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">ll</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="var">?s'</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Splay_Heap_Analysis-zig_zig"><span class="command">lemma</span></span> zig_zig<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">u</span> <span class="free">r</span> <span class="free">r1'</span> <span class="free">r2'</span> <span class="free">T</span> <span class="free">a</span> <span class="free">b</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">==</span> Node <span class="free">s</span> <span class="free">a</span> <span class="main">(</span>Node <span class="free">u</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">==</span> Node <span class="main">(</span>Node <span class="free">s</span> <span class="free">a</span> <span class="free">u</span><span class="main">)</span> <span class="free">b</span> <span class="free">r1'</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"size <span class="free">r1'</span> <span class="main">≤</span> size <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"T_part <span class="free">p</span> <span class="free">r</span> <span class="main">+</span> Φ <span class="free">r1'</span> <span class="main">+</span> Φ <span class="free">r2'</span> <span class="main">-</span> Φ <span class="free">r</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_part <span class="free">p</span> <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">+</span> Φ <span class="free">r2'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="free">r</span> <span class="main">≤</span> φ <span class="main">(</span>Node <span class="free">u</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size1 <span class="free">s</span> <span class="main">+</span> size1 <span class="free">u</span> <span class="main">+</span> size1 <span class="free">r1'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> φ <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ld_ld_1_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="free">s</span> <span class="main">+</span> size1 <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="free">r</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> φ <span class="free">r</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">s</span> <span class="main">+</span> size1 <span class="free">u</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">s</span> <span class="main">+</span> size1 <span class="free">u</span> <span class="main">+</span> size1 <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Heap_Analysis-zig_zag"><span class="command">lemma</span></span> zig_zag<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="free">u</span> <span class="free">r</span> <span class="free">r1'</span> <span class="free">r2'</span> <span class="free">a</span> <span class="free">b</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≡</span> Node <span class="free">s</span> <span class="free">a</span> <span class="main">(</span>Node <span class="free">r</span> <span class="free">b</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1'</span> <span class="main">==</span> Node <span class="free">s</span> <span class="free">a</span> <span class="free">r1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t2'</span> <span class="main">≡</span> Node <span class="free">u</span> <span class="free">b</span> <span class="free">r2'</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"size <span class="free">r</span> <span class="main">=</span> size <span class="free">r1'</span> <span class="main">+</span> size <span class="free">r2'</span>"</span></span>
    <span class="quoted"><span class="quoted">"T_part <span class="free">p</span> <span class="free">r</span> <span class="main">+</span> Φ <span class="free">r1'</span> <span class="main">+</span> Φ <span class="free">r2'</span> <span class="main">-</span> Φ <span class="free">r</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_part <span class="free">p</span> <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> Φ <span class="free">t1'</span> <span class="main">+</span> Φ <span class="free">t2'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="free">r</span> <span class="main">≤</span> φ <span class="main">(</span>Node <span class="free">u</span> <span class="free">b</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="free">r</span> <span class="main">≤</span> φ <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ld_ld_less2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size1 <span class="free">s</span> <span class="main">+</span> size1 <span class="free">r1'</span>"</span></span> <span class="quoted"><span class="quoted">"size1 <span class="free">u</span> <span class="main">+</span> size1 <span class="free">r2'</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">s</span> <span class="main">+</span> size1 <span class="free">r1'</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">u</span> <span class="main">+</span> size1 <span class="free">r2'</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> size1_size t_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Splay_Heap_Analysis-amor_partition"><span class="command">lemma</span></span> amor_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"bst_wrt <span class="main">(≤)</span> <span class="free">t</span> <span class="main">⟹</span> partition <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span>
  <span class="main">⟹</span> T_part <span class="free">p</span> <span class="free">t</span> <span class="main">+</span> Φ <span class="free">l'</span> <span class="main">+</span> Φ <span class="free">r'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> partition.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">rl</span> <span class="skolem">b</span> <span class="skolem">rr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rrl</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="skolem">p</span> <span class="skolem">rr</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">rrl</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">rl</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">rrl</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">rrl</span> <span class="main">≤</span> size <span class="skolem">rr</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> size_partition<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 0 <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node <span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rrl</span></span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span>
          zig_zig<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rl</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r1'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rrl</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r2'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rll</span></span> <span class="skolem"><span class="skolem">rlr</span></span> 
          <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="skolem">p</span> <span class="skolem">rl</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">rll</span><span class="main">,</span> <span class="skolem">rlr</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">rll</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> Node <span class="skolem">rlr</span> <span class="skolem">b</span> <span class="skolem">rr</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 0 <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rll</span></span> <span class="quoted"><span class="skolem">rlr</span></span><span class="main">]</span>
          size_partition<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          zig_zag<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rl</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r1'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rll</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r2'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">rlr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">b</span> <span class="skolem">lr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lrl</span></span> <span class="skolem"><span class="skolem">lrr</span></span> 
          <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="skolem">p</span> <span class="skolem">lr</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lrl</span><span class="main">,</span> <span class="skolem">lrr</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> Node <span class="skolem">ll</span> <span class="skolem">b</span> <span class="skolem">lrl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> Node <span class="skolem">lrr</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 0 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2.IH"</span><span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">lrl</span></span> <span class="quoted"><span class="skolem">lrr</span></span><span class="main">]</span>
          size_partition<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          zig_zag<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ll</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">lr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r1'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">lrr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r2'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">lrl</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">llr</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="skolem">p</span> <span class="skolem">ll</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">llr</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> Node <span class="skolem">llr</span> <span class="skolem">b</span> <span class="main">(</span>Node <span class="skolem">lr</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">llr</span> <span class="main">≤</span> size <span class="skolem">ll</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> size_partition<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 0 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"2.IH"</span><span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">l'</span></span> <span class="quoted"><span class="skolem">llr</span></span><span class="main">]</span>
          zig_zig<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> u<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">lr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ll</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r1'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">llr</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r2'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> del_min <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> T_in <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> T_dm <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> φ <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"bst_wrt <span class="main">(≤)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_def bst_del_min <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bst_partition <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">h</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Del_min <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> amor_del_min<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Insert <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"bst_wrt <span class="main">(≤)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="skolem">x</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size <span class="skolem">t</span><span class="main">)</span> <span class="main">&lt;</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> size <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> 1 amor_partition<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹bst_wrt <span class="main">(≤)</span> <span class="skolem">t</span>›</span></span> 1<span class="main">]</span> size_partition<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_in_def insert_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> size1_size
             <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> log_less_cancel_iff<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_Tree_Analysis">
<div class="head">
<h1>Theory Pairing_Heap_Tree_Analysis</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Hauke Brinkop and Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pairing Heaps›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binary Tree Representation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_Tree_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>  
  <a href="../Pairing_Heap/Pairing_Heap_Tree.html">Pairing_Heap.Pairing_Heap_Tree</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <a href="Priority_Queue_ops_merge.html">Priority_Queue_ops_merge</a>
  <a href="Lemmas_log.html">Lemmas_log</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹Verification of logarithmic bounds on the amortized complexity of
pairing heaps \cite{FredmanSST86,Brinkop}.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">len</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">len</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-link_size"><span class="command">lemma</span></span> link_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>link <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> size <span class="free">hp</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">hp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-size_pass"><span class="command">lemma</span></span> size_pass<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> size <span class="free">hp</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-size_pass"><span class="command">lemma</span></span> size_pass<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> size <span class="free">hp</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>2</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-size_merge"><span class="command">lemma</span></span> size_merge<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_root <span class="free">h1</span> <span class="main">⟹</span> is_root <span class="free">h2</span> <span class="main">⟹</span> size <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-ΔΦ_insert"><span class="command">lemma</span></span> ΔΦ_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">hp</span> <span class="main">⟹</span> Φ <span class="main">(</span>insert <span class="free">x</span> <span class="free">hp</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hp</span> <span class="main">≤</span> log <span class="numeral">2</span>  <span class="main">(</span>size <span class="free">hp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-ΔΦ_merge"><span class="command">lemma</span></span> ΔΦ_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h1</span> <span class="main">=</span> Node <span class="free">hs1</span> <span class="free">x1</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h2</span> <span class="main">=</span> Node <span class="free">hs2</span> <span class="free">x2</span> Leaf"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="free">hs1</span> <span class="free">x1</span> <span class="main">(</span>Node <span class="free">hs2</span> <span class="free">x2</span> Leaf<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> Φ <span class="main">(</span>link <span class="var">?hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Φ <span class="free">hs1</span> <span class="main">+</span> Φ <span class="free">hs2</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Φ <span class="free">hs1</span> <span class="main">+</span> Φ <span class="free">hs2</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span> <span class="main">=</span>
   log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span>
   <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ld_le_2ld<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size <span class="free">hs1</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="free">hs2</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ub_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ub_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ub_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hs1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hs2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">hs1</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">hs2</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ub_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hs1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hs2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">hs1</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">hs2</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> 
    <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">ub_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-ΔΦ_pass1_ub_pass1"><span class="command">lemma</span></span> ΔΦ_pass1_ub_pass1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span>  <span class="main">≤</span> ub_pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ub_pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">ly</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span>  <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span>  <span class="main">(</span>size <span class="skolem">ly</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> 
    <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">ly</span> <span class="skolem">y</span> <span class="skolem">lz</span> <span class="skolem">z</span> <span class="skolem">rz</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ry</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">lz</span> <span class="skolem">z</span> <span class="skolem">rz</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">ly</span> <span class="skolem">y</span> <span class="var">?ry</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="var">?rx</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span><span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">ly</span> <span class="main">+</span> size <span class="var">?ry</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?h</span> <span class="main">≤</span> <span class="var">?t</span> <span class="main">+</span> ub_pass<span class="hidden">⇩</span><sub>1</sub> <span class="var">?ry</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_pass<span class="hidden">⇩</span><sub>1</sub> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?ry</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>
    <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?h</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">ly</span> <span class="main">+</span> size <span class="var">?ry</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> size <span class="var">?ry</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?ry</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ld_sum_inequality <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="var">?ry</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">ly</span> <span class="main">+</span> size <span class="var">?ry</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?ry</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-ΔΦ_pass1"><span class="command">lemma</span></span> ΔΦ_pass1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ub_pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ub_pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass1_ub_pass1 <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-ΔΦ_pass2"><span class="command">lemma</span></span> ΔΦ_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">rx</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rx</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">ly</span> <span class="skolem">y</span> <span class="skolem">ry</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">rx</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">rx</span> <span class="main">=</span> Node <span class="skolem">la</span> <span class="skolem">a</span> Leaf"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_struct 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">rx</span> <span class="main">=</span> size <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> size_pass<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> link<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>link<span class="main">(</span>Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">rx</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">lx</span> <span class="main">-</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">rx</span><span class="main">)</span> <span class="main">=</span>
          log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">rx</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">rx</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">rx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?h</span> <span class="main">=</span>
        Φ <span class="main">(</span>link <span class="main">(</span>Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">rx</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">lx</span> <span class="main">-</span> Φ <span class="skolem">rx</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">rx</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">rx</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">rx</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">rx</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">rx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> link <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span> <span class="main">+</span> size <span class="skolem">rx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="comment1">(*
lemma ΔΦ_mergepairs: assumes "hs ≠ Leaf"
  shows "Φ (merge_pairs hs) - Φ hs ≤ 3 * log 2 (size hs) - len hs + 2"
proof -
  have "pass<span class="hidden">⇩</span><sub>1</sub> hs ≠ Leaf" by (metis assms eq_size_0 size_pass<span class="hidden">⇩</span><sub>1</sub>)
  with assms ΔΦ_pass1[of hs] ΔΦ_pass2[of "pass<span class="hidden">⇩</span><sub>1</sub> hs"]
  show ?thesis by (auto simp add: size_pass<span class="hidden">⇩</span><sub>1</sub> pass12_merge_pairs)
qed
*)</span>
<span class="keyword1" id="Pairing_Heap_Tree_Analysis-ΔΦ_del_min"><span class="command">lemma</span></span> ΔΦ_del_min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> Leaf"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="main">(</span>Node <span class="free">hs</span> <span class="free">x</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="main">(</span>Node <span class="free">hs</span> <span class="free">x</span> Leaf<span class="main">)</span> 
  <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="free">hs</span> <span class="free">x</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="free">hs</span> <span class="main">-</span> Φ <span class="var">?h</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?h</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span>  <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass2 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> eq_size_0 size_pass<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span> <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span><span class="main">…</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ΔΦ_pass1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ΔΦ</span> <span class="main">≤</span> <span class="var">?ΔΦ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-is_root_merge"><span class="command">lemma</span></span> is_root_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_root <span class="free">h1</span> <span class="main">⟹</span> is_root <span class="free">h2</span> <span class="main">⟹</span> is_root <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-is_root_insert"><span class="command">lemma</span></span> is_root_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span> <span class="main">⟹</span> is_root <span class="main">(</span>insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-is_root_del_min"><span class="command">lemma</span></span> is_root_del_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_root <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">rx</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rx</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">lx</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ly</span> <span class="skolem">y</span> <span class="skolem">ry</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">lx</span> <span class="main">=</span> Node <span class="skolem">a</span> <span class="skolem">la</span> <span class="skolem">ra</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lb</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">…</span> <span class="main">=</span> Node <span class="skolem">b</span> <span class="skolem">lb</span> Leaf"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis-pass"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_len<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">h</span><span class="main">)</span> <span class="main">≤</span> len <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span> 
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> del_min <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ry</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">ry</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">rx</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">rx</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span>Leaf<span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span>Node <span class="free"><span class="bound"><span class="entity">lx</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">lx</span></span></span><span class="main">)</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">lx</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> Merge <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted">is_root</span> 
<span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_root_insert is_root_del_min is_root_merge
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"is_root <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Insert ΔΦ_insert 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Del_min<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">rx</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">lx</span><span class="main">)</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub> <span class="skolem">lx</span> <span class="main">≤</span> len <span class="skolem">lx</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">lx</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cost <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="skolem">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">h</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">lx</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">lx</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">ly</span> <span class="skolem">y</span> <span class="skolem">ry</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="skolem">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">h</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">lx</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">lx</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span>  ΔΦ_del_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">lx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span><span class="main">]</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">lx</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 3<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Merge
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h1</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">h2</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="skolem">h1</span>"</span></span> <span class="quoted"><span class="quoted">"is_root <span class="skolem">h2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h1</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> h1<span class="main">:</span> Node
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> h2<span class="main">:</span> Node
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="skolem">h1</span> <span class="skolem">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">h1</span> <span class="main">-</span> Φ <span class="skolem">h2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size <span class="skolem">h1</span> <span class="main">+</span> size <span class="skolem">h2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ΔΦ_merge<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> h1 h2 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">h1</span> <span class="main">+</span> size <span class="skolem">h2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_Tree_Analysis2">
<div class="head">
<h1>Theory Pairing_Heap_Tree_Analysis2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Hauke Brinkop and Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pairing Heaps›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binary Tree Representation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_Tree_Analysis2
<span class="keyword2"><span class="keyword">imports</span></span>  
  <a href="../Pairing_Heap/Pairing_Heap_Tree.html">Pairing_Heap.Pairing_Heap_Tree</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <a href="Priority_Queue_ops_merge.html">Priority_Queue_ops_merge</a>
  <a href="Lemmas_log.html">Lemmas_log</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹Verification of logarithmic bounds on the amortized complexity of pairing heaps.
As in \cite{FredmanSST86,Brinkop}, except that the treatment of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> pass<span class="hidden">⇩</span><sub>1</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span> is simplified.
TODO: convert the other Pairing Heap analyses to this one.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">len</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">len</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-link_size"><span class="command">lemma</span></span> link_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>link <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> size <span class="free">hp</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">hp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-size_pass"><span class="command">lemma</span></span> size_pass<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> size <span class="free">hp</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-size_pass"><span class="command">lemma</span></span> size_pass<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> size <span class="free">hp</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>2</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-size_merge"><span class="command">lemma</span></span> size_merge<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_root <span class="free">h1</span> <span class="main">⟹</span> is_root <span class="free">h2</span> <span class="main">⟹</span> size <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-ΔΦ_insert"><span class="command">lemma</span></span> ΔΦ_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">hp</span> <span class="main">⟹</span> Φ <span class="main">(</span>insert <span class="free">x</span> <span class="free">hp</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hp</span> <span class="main">≤</span> log <span class="numeral">2</span>  <span class="main">(</span>size <span class="free">hp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-ΔΦ_merge"><span class="command">lemma</span></span> ΔΦ_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h1</span> <span class="main">=</span> Node <span class="free">hs1</span> <span class="free">x1</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h2</span> <span class="main">=</span> Node <span class="free">hs2</span> <span class="free">x2</span> Leaf"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="free">hs1</span> <span class="free">x1</span> <span class="main">(</span>Node <span class="free">hs2</span> <span class="free">x2</span> Leaf<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> Φ <span class="main">(</span>link <span class="var">?hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Φ <span class="free">hs1</span> <span class="main">+</span> Φ <span class="free">hs2</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Φ <span class="free">hs1</span> <span class="main">+</span> Φ <span class="free">hs2</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span> <span class="main">=</span>
   log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span>
   <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ld_le_2ld<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size <span class="free">hs1</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="free">hs2</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-ΔΦ_pass1"><span class="command">lemma</span></span> ΔΦ_pass1<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span>  <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="skolem">hs2</span> <span class="skolem">y</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="main">(</span>Node <span class="skolem">hs2</span> <span class="skolem">y</span> <span class="skolem">hs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">hs1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">hs2</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="skolem">hs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?h</span> <span class="main">=</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n1</span><span class="main">+</span><span class="var">?n2</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">hs</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n2</span><span class="main">+</span><span class="var">?m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_pass<span class="hidden">⇩</span><sub>1</sub> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n1</span><span class="main">+</span><span class="var">?n2</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n2</span><span class="main">+</span><span class="var">?m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n1</span><span class="main">+</span><span class="var">?n2</span><span class="main">+</span><span class="var">?m</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n2</span><span class="main">+</span><span class="var">?m</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">hs</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> ld_sum_inequality <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?n1</span><span class="main">+</span><span class="var">?n2</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="var">?n1</span><span class="main">+</span><span class="var">?n2</span><span class="main">+</span><span class="var">?m</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> len <span class="var">?h</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="var">?h</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-ΔΦ_pass2"><span class="command">lemma</span></span> ΔΦ_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">hs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1<span class="main">:</span> <span class="main">(</span>Node <span class="skolem">hs2</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="skolem">hs</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hs3</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span> <span class="main">=</span> Node <span class="skolem">hs3</span> <span class="skolem">a</span> Leaf"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_struct 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">hs</span> <span class="main">=</span> size <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> size_pass<span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> link<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>link<span class="main">(</span>Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">hs1</span> <span class="main">-</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span><span class="main">)</span> <span class="main">=</span>
          log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs1</span> <span class="main">+</span> size <span class="skolem">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs1</span> <span class="main">+</span> size <span class="skolem">hs</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="var">?h</span> <span class="main">=</span>
        Φ <span class="main">(</span>link <span class="main">(</span>Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">hs1</span> <span class="main">-</span> Φ <span class="skolem">hs</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs1</span> <span class="main">+</span> size <span class="skolem">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">hs</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs1</span> <span class="main">+</span> size <span class="skolem">hs</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> link <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs1</span> <span class="main">+</span> size <span class="skolem">hs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="var">?h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> ΔΦ_pass2'<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_size_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">hs</span> <span class="main">≠</span> Leaf›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-ΔΦ_del_min"><span class="command">lemma</span></span> ΔΦ_del_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="main">(</span>Node <span class="free">hs</span> <span class="free">x</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="main">(</span>Node <span class="free">hs</span> <span class="free">x</span> Leaf<span class="main">)</span> 
  <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="main">(</span>Node <span class="free">hs</span> <span class="free">x</span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="main">(</span>Node <span class="free">hs</span> <span class="free">x</span> Leaf<span class="main">)</span> <span class="main">=</span>
        Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size <span class="free">hs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> Φ <span class="free">hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">hs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass2' <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_pass<span class="hidden">⇩</span><sub>1</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">hs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ΔΦ_pass1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-is_root_merge"><span class="command">lemma</span></span> is_root_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_root <span class="free">h1</span> <span class="main">⟹</span> is_root <span class="free">h2</span> <span class="main">⟹</span> is_root <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-is_root_insert"><span class="command">lemma</span></span> is_root_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span> <span class="main">⟹</span> is_root <span class="main">(</span>insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-is_root_del_min"><span class="command">lemma</span></span> is_root_del_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_root <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">hs1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">hs2</span> <span class="skolem">y</span> <span class="skolem">hs'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs1</span> <span class="main">=</span> Node <span class="skolem">a</span> <span class="skolem">la</span> <span class="skolem">ra</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lb</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">…</span> <span class="main">=</span> Node <span class="skolem">b</span> <span class="skolem">lb</span> Leaf"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-pass"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_len<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">h</span><span class="main">)</span> <span class="main">≤</span> len <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span> 
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> del_min <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">hs'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">T_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs'</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T_pass<span class="hidden">⇩</span><sub>2</sub></span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T_pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">T_pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_del_min</span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T_del_min</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> T_pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">+</span> T_pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_insert</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_merge</span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-A_del_min"><span class="command">lemma</span></span> A_del_min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_del_min <span class="free">h</span> <span class="main">+</span> Φ<span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">hs1</span> <span class="skolem">x</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs1</span><span class="main">)</span> <span class="main">+</span> real<span class="main">(</span>T_pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs1</span><span class="main">)</span> <span class="main">≤</span> real<span class="main">(</span>len <span class="skolem">hs1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">hs1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">hs1</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="skolem">hs1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">hs1</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  ΔΦ_del_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">hs1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> len <span class="skolem">hs1</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-A_insert"><span class="command">lemma</span></span> A_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span> <span class="main">⟹</span> T_insert <span class="free">a</span> <span class="free">h</span> <span class="main">+</span> Φ<span class="main">(</span>insert <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">drule</span> ΔΦ_insert<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_Tree_Analysis2-A_merge"><span class="command">lemma</span></span> A_merge<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_root <span class="free">h1</span>"</span></span> <span class="quoted"><span class="quoted">"is_root <span class="free">h2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_merge <span class="free">h1</span> <span class="free">h2</span> <span class="main">+</span> Φ<span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h2</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> h1<span class="main">:</span> Node
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> h1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> h2<span class="main">:</span> Node
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ΔΦ_merge<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> h1 h2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">h1</span> <span class="main">+</span> size <span class="free">h2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h1<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> T_del_min <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> T_insert <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">cost</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> T_merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> tree list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted">is_root</span> 
<span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_root_insert is_root_del_min is_root_merge
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Insert
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"is_root <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Insert ΔΦ_insert 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Del_min
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A_del_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> 3 Del_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Merge
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h1</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h1</span><span class="main">,</span><span class="skolem">h2</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"is_root <span class="skolem">h1</span>"</span></span> <span class="quoted"><span class="quoted">"is_root <span class="skolem">h2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> A_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h1</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">]</span> Merge <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_List1_Analysis">
<div class="head">
<h1>Theory Pairing_Heap_List1_Analysis</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow (based on Hauke Brinkop's tree proofs) *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Okasaki's Pairing Heap›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_List1_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Pairing_Heap/Pairing_Heap_List1.html">Pairing_Heap.Pairing_Heap_List1</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <a href="Priority_Queue_ops_merge.html">Priority_Queue_ops_merge</a>
  <a href="Lemmas_log.html">Lemmas_log</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹Amortized analysis of pairing heaps as defined by Okasaki \cite{Okasaki}.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hps</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">hps</span> <span class="main">(</span>Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-merge_Empty"><span class="command">lemma</span></span> merge_Empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"merge heap.Empty <span class="free">h</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-merge2"><span class="command">lemma</span></span> merge2<span class="main">:</span> <span class="quoted"><span class="quoted">"merge <span class="main">(</span>Hp <span class="free">x</span> <span class="free">lx</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="keyword1">of</span> heap.Empty <span class="main">⇒</span> Hp <span class="free">x</span> <span class="free">lx</span> <span class="main">|</span> <span class="main">(</span>Hp <span class="bound">y</span> <span class="bound">ly</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="keyword1">then</span> Hp <span class="free">x</span> <span class="main">(</span>Hp <span class="bound">y</span> <span class="bound">ly</span> <span class="main">#</span> <span class="free">lx</span><span class="main">)</span> <span class="keyword1">else</span> Hp <span class="bound">y</span> <span class="main">(</span>Hp <span class="free">x</span> <span class="free">lx</span> <span class="main">#</span> <span class="bound">ly</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> heap.split<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-pass1_Nil_iff"><span class="command">lemma</span></span> pass1_Nil_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.cases<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">no_Empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">no_Empty</span> heap.Empty <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">no_Empty</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">.</span> <span class="free">no_Empty</span> <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">no_Emptys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder heap list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">no_Emptys</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">.</span> no_Empty <span class="bound">h</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_root</span> heap.Empty <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_root</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> no_Emptys <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>


<span class="keyword1" id="Pairing_Heap_List1_Analysis-is_root_if_no_Empty"><span class="command">lemma</span></span> is_root_if_no_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Empty <span class="free">h</span> <span class="main">⟹</span> is_root <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-no_Emptys_hps"><span class="command">lemma</span></span> no_Emptys_hps<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Empty <span class="free">h</span> <span class="main">⟹</span> no_Emptys<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-no_Empty_merge"><span class="command">lemma</span></span> no_Empty_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_Empty <span class="free">h1</span><span class="main">;</span> no_Empty <span class="free">h2</span><span class="main">⟧</span> <span class="main">⟹</span> no_Empty <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h1</span><span class="main">,</span><span class="free">h2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-is_root_merge"><span class="command">lemma</span></span> is_root_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_root <span class="free">h1</span><span class="main">;</span> is_root <span class="free">h2</span><span class="main">⟧</span> <span class="main">⟹</span> is_root <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">h1</span><span class="main">,</span><span class="free">h2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-no_Emptys_pass1"><span class="command">lemma</span></span> no_Emptys_pass1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span> no_Emptys <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> no_Empty_merge<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-is_root_pass2"><span class="command">lemma</span></span> is_root_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span> is_root<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons _ <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_root_if_no_Empty<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_root_merge is_root_if_no_Empty<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Complexity›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_hp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_hp</span> heap.Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_hp</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> sum_list<span class="main">(</span>map <span class="free">size_hp</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">size_hps</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_hps</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">≡</span> sum_list<span class="main">(</span>map size_hp <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ_hps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ_hps</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ_hps</span> <span class="main">(</span>heap.Empty <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Φ_hps</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ_hps</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hsr</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="free">Φ_hps</span> <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">+</span> <span class="free">Φ_hps</span> <span class="free"><span class="bound"><span class="entity">hsr</span></span></span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">hsr</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> heap.Empty <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> Φ_hps <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps<span class="main">(</span><span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-Φ_hps_ge0"><span class="command">lemma</span></span> Φ_hps_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ_hps <span class="free">hs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Φ_hps.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-no_Empty_ge0"><span class="command">lemma</span></span> no_Empty_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Empty <span class="free">h</span> <span class="main">⟹</span> size_hp <span class="free">h</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-Φ_hps1"><span class="command">lemma</span></span> Φ_hps1<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ_hps <span class="main">[</span><span class="free">h</span><span class="main">]</span> <span class="main">=</span> Φ <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-size_hp_merge"><span class="command">lemma</span></span> size_hp_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"size_hp<span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> size_hp <span class="free">h1</span> <span class="main">+</span> size_hp <span class="free">h2</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-pass"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> size_hps <span class="free">hs</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_hp_merge<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-ΔΦ_insert"><span class="command">lemma</span></span> ΔΦ_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>Pairing_Heap_List1.insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_hp_merge<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-ΔΦ_merge"><span class="command">lemma</span></span> ΔΦ_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h1</span> <span class="main">-</span> Φ <span class="free">h2</span>
  <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free">h1</span> <span class="main">+</span> size_hp <span class="free">h2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">lx</span> <span class="skolem">y</span> <span class="skolem">ly</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ld_le_2ld<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size_hps <span class="skolem">lx</span>"</span></span> <span class="quoted"><span class="quoted">"size_hps <span class="skolem">ly</span>"</span></span><span class="main">]</span>
      log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size_hps <span class="skolem">lx</span> <span class="main">+</span> size_hps <span class="skolem">ly</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"size_hps <span class="skolem">lx</span> <span class="main">+</span> size_hps <span class="skolem">ly</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> log_le_cancel_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sum_ub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">+</span> size_hp <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">+</span> size_hp <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> 
    <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">sum_ub</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-ΔΦ_pass1_sum_ub"><span class="command">lemma</span></span> ΔΦ_pass1_sum_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span>
  Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="free">hs</span>  <span class="main">≤</span> sum_ub <span class="free">hs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="free">hs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sum_ub.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">h1</span> <span class="skolem">h2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">hsx</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">hsy</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h1</span> <span class="main">=</span> Hp <span class="skolem">x</span> <span class="skolem">hsx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">=</span> Hp <span class="skolem">y</span> <span class="skolem">hsy</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> no_Empty.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>real<span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing 0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">h1</span> <span class="skolem">h2</span> <span class="skolem">h3</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span><span class="main">(</span><span class="skolem">h3</span><span class="main">#</span><span class="skolem">hs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"4.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">hsx</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">hsy</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h1</span> <span class="main">=</span> Hp <span class="skolem">x</span> <span class="skolem">hsx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">=</span> Hp <span class="skolem">y</span> <span class="skolem">hsy</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> no_Empty.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"4.prems"</span> <span class="keyword1"><span class="command">have</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"size_hp <span class="skolem">h3</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> size_hp.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ry</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">h3</span> <span class="main">#</span> <span class="skolem">hs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Hp <span class="skolem">y</span> <span class="skolem">hsy</span> <span class="main">#</span> <span class="var">?ry</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Hp <span class="skolem">x</span> <span class="skolem">hsx</span> <span class="main">#</span> <span class="var">?rx</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ_hps<span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="var">?h</span>  
    <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span> <span class="main">+</span> size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">+</span> sum_ub <span class="var">?ry</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span> <span class="main">+</span> size_hps <span class="var">?ry</span><span class="main">)</span> 
    <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> 
      <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span><span class="main">/</span><span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> <span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span> <span class="main">/</span> size_hps <span class="var">?h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">-</span><span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">+</span> <span class="main">…</span>
        <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">/</span> size_hps <span class="var">?h</span> <span class="main">+</span>  size_hps <span class="var">?ry</span> <span class="main">/</span> size_hps <span class="var">?h</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">using</span></span> ld_sum_inequality <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">/</span> size_hps <span class="var">?h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>size_hps <span class="var">?ry</span> <span class="main">/</span> size_hps <span class="var">?h</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> s3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> log_divide add_pos_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>
      <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?rx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">-</span> <span class="main">…</span> 
      <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-ΔΦ_pass1"><span class="command">lemma</span></span> ΔΦ_pass1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="free">hs</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> length <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_ub <span class="free">hs</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> length <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sum_ub.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_Empty_ge0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass1_sum_ub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-size_hps_pass2"><span class="command">lemma</span></span> size_hps_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> no_Emptys <span class="free">hs</span> <span class="main">⟹</span>
  no_Empty<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">&amp;</span> size_hps <span class="free">hs</span> <span class="main">=</span> size_hps<span class="main">(</span>hps<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Φ_hps.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> heap.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-ΔΦ_pass2"><span class="command">lemma</span></span> ΔΦ_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> no_Emptys <span class="free">hs</span> <span class="main">⟹</span>
  Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="free">hs</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Φ_hps1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_Empty_ge0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">hs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> Hp <span class="skolem">x</span> <span class="skolem">hs2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span><span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> no_Empty.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Φ_hps_ge0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">hs</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing xt1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> add_increasing<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hp <span class="skolem">y</span> <span class="skolem">hs3</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons * size_hps_pass2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">hs</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis-ΔΦ_del_min"><span class="command">lemma</span></span> ΔΦ_del_min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hps <span class="free">h</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"no_Empty <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> 
  <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">hs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> Hp <span class="skolem">x</span> <span class="skolem">hs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>hps <span class="free">h</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pass1_Nil_iff no_Emptys_pass1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> no_Emptys_hps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span><span class="main">…</span> <span class="main">-</span> length <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> no_Emptys_hps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ΔΦ</span> <span class="main">=</span> <span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="var">?ΔΦ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> heap list <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> heap.Empty"</span></span> <span class="main">|</span> 
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> del_min <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> Pairing_Heap_List1.insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> heap list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span>heap.Empty<span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">]</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Merge <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> heap list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">+</span> size_hp <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pairing<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"is_root"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Insert <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_root_merge<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Merge
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_root_merge numeral_eq_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Del_min
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Hp _ <span class="skolem">hs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> no_Emptys_pass1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_root_pass2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Φ_hps_ge0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Insert <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ΔΦ_insert 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Del_min
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Hp <span class="skolem">x</span> <span class="skolem">hs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs</span><span class="main">)</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="skolem">hs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"cost <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="skolem">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">h</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="skolem">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="skolem">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">h</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="skolem">hs</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span>  ΔΦ_del_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="skolem">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False 3<span class="main">(</span>1<span class="main">)</span> size_hps_pass2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Merge
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h1</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h1</span><span class="main">,</span> <span class="skolem">h2</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">h1</span> <span class="main">=</span> heap.Empty <span class="main">∨</span> <span class="skolem">h2</span> <span class="main">=</span> heap.Empty"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>                  
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="skolem"><span class="skolem">hs1</span></span> <span class="skolem"><span class="skolem">hs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h1</span> <span class="main">=</span> Hp <span class="skolem">x1</span> <span class="skolem">hs1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">=</span> Hp <span class="skolem">x2</span> <span class="skolem">hs2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> hps.cases<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="skolem">h1</span> <span class="skolem">h2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">h1</span> <span class="main">-</span> Φ <span class="skolem">h2</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="skolem">h1</span> <span class="main">+</span> size_hp <span class="skolem">h2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ΔΦ_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h1</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_List1_Analysis2">
<div class="head">
<h1>Theory Pairing_Heap_List1_Analysis2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer of Tree Analysis to List Representation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_List1_Analysis2
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Pairing_Heap_List1_Analysis.html">Pairing_Heap_List1_Analysis</a>
  <a href="Pairing_Heap_Tree_Analysis.html">Pairing_Heap_Tree_Analysis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory transfers the amortized analysis of the tree-based
pairing heaps to Okasaki's pairing heaps.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_root'</span> <span class="main">==</span> Pairing_Heap_List1_Analysis.is_root"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">del_min'</span> <span class="main">==</span> Pairing_Heap_List1.del_min"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert'</span> <span class="main">==</span> Pairing_Heap_List1.insert"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">merge'</span> <span class="main">==</span> Pairing_Heap_List1.merge"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">==</span> Pairing_Heap_List1.pass<span class="hidden">⇩</span><sub>1</sub>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">==</span> Pairing_Heap_List1.pass<span class="hidden">⇩</span><sub>2</sub>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">==</span> Pairing_Heap_List1_Analysis.T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">==</span> Pairing_Heap_List1_Analysis.T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">homs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">homs</span> <span class="main">[]</span> <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">homs</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">lhs</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span><span class="free">homs</span> <span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">homs</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">hom</span> heap.Empty <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">hom</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Node <span class="main">(</span>homs <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span>"</span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-homs_pass1'"><span class="command">lemma</span></span> homs_pass1'<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span> homs<span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub>' <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> pass<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span>homs <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Pairing_Heap_List1.pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> h1 h2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">h1</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> h
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-hom_merge'"><span class="command">lemma</span></span> hom_merge'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> no_Emptys <span class="free">lhs</span><span class="main">;</span> Pairing_Heap_List1_Analysis.is_root <span class="free">h</span><span class="main">⟧</span>
       <span class="main">⟹</span> hom <span class="main">(</span>merge' <span class="main">(</span>Hp <span class="free">x</span> <span class="free">lhs</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> link <span class="main">⟨</span>homs <span class="free">lhs</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> hom <span class="free">h</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-hom_pass2'"><span class="command">lemma</span></span> hom_pass2'<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span> hom<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub>' <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>homs <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> homs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_merge' is_root_pass2<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-del_min'"><span class="command">lemma</span></span> del_min'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root' <span class="free">h</span> <span class="main">⟹</span> hom<span class="main">(</span>del_min' <span class="free">h</span><span class="main">)</span> <span class="main">=</span> del_min <span class="main">(</span>hom <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> homs_pass1' hom_pass2' no_Emptys_pass1 is_root_pass2<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-insert'"><span class="command">lemma</span></span> insert'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root' <span class="free">h</span> <span class="main">⟹</span> hom<span class="main">(</span>insert' <span class="free">x</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>hom <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-merge'"><span class="command">lemma</span></span> merge'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_root' <span class="free">h1</span><span class="main">;</span> is_root' <span class="free">h2</span> <span class="main">⟧</span> <span class="main">⟹</span> hom<span class="main">(</span>merge' <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> merge <span class="main">(</span>hom <span class="free">h1</span><span class="main">)</span> <span class="main">(</span>hom <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h1</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h2</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-T_pass1'"><span class="command">lemma</span></span> T_pass1'<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub>' <span class="free">hs</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>homs <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Pairing_Heap_List1.pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> h1 h2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">h1</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> h
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-T_pass2'"><span class="command">lemma</span></span> T_pass2'<span class="main">:</span> <span class="quoted"><span class="quoted">"no_Emptys <span class="free">hs</span> <span class="main">⟹</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub>' <span class="free">hs</span> <span class="main">=</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>homs <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> homs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_merge' is_root_pass2<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List1_Analysis2-size_hp"><span class="command">lemma</span></span> size_hp<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root' <span class="free">h</span> <span class="main">⟹</span> size_hp <span class="free">h</span> <span class="main">=</span> size <span class="main">(</span>hom <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hp _ <span class="skolem">hs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> homs.induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> Amortized2
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted">is_root</span>
<span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword2"><span class="keyword">and</span></span> hom <span class="main">=</span> <span class="quoted">hom</span>
<span class="keyword2"><span class="keyword">and</span></span> exec' <span class="main">=</span> <span class="quoted">Pairing_Heap_List1_Analysis.exec</span>
<span class="keyword2"><span class="keyword">and</span></span> cost' <span class="main">=</span> <span class="quoted">Pairing_Heap_List1_Analysis.cost</span> <span class="keyword2"><span class="keyword">and</span></span> inv' <span class="main">=</span> <span class="quoted"><span class="quoted">"is_root'"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U' <span class="main">=</span> <span class="quoted">Pairing_Heap_List1_Analysis.U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> merge' del_min' numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">ts</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Del_min
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_root_pass2 no_Emptys_pass1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 2<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pairing_Heap_List1_Analysis.is_root_merge numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">ts</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Del_min
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_pass1' T_pass2' no_Emptys_pass1 homs_pass1'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> 4<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 _ <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_hp numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_List2_Analysis">
<div class="head">
<h1>Theory Pairing_Heap_List2_Analysis</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow (based on Hauke Brinkop's tree proofs) *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Okasaki's Pairing Heap (Modified)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_List2_Analysis
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Pairing_Heap/Pairing_Heap_List2.html">Pairing_Heap.Pairing_Heap_List2</a>
  <a href="Amortized_Framework.html">Amortized_Framework</a>
  <a href="Priority_Queue_ops_merge.html">Priority_Queue_ops_merge</a>
  <a href="Lemmas_log.html">Lemmas_log</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹Amortized analysis of a modified version of the pairing heaps
defined by Okasaki \cite{Okasaki}.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lift_hp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> hp <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lift_hp</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> None <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lift_hp</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_hps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_hps</span><span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hsr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size_hps</span> <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">+</span> <span class="free">size_hps</span> <span class="free"><span class="bound"><span class="entity">hsr</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_hps</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">size_hp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size_hp</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> size_hps<span class="main">(</span>hps <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ_hps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ_hps</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ_hps</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hsr</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Φ_hps</span> <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">+</span> <span class="free">Φ_hps</span> <span class="free"><span class="bound"><span class="entity">hsr</span></span></span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free"><span class="bound"><span class="entity">hsl</span></span></span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">hsr</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Φ_hp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ_hp</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Φ_hps <span class="main">(</span>hps <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps<span class="main">(</span>hps<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">≡</span> lift_hp <span class="main">0</span> Φ_hp"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">size_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_heap</span> <span class="main">≡</span> lift_hp <span class="main">0</span> size_hp"</span></span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-Φ_hps_ge0"><span class="command">lemma</span></span> Φ_hps_ge0<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ_hps <span class="free">hs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> size_hps.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-size_hps_Cons"><span class="command">lemma</span></span> size_hps_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_hps<span class="main">(</span><span class="free">h</span> <span class="main">#</span> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> size_hp <span class="free">h</span> <span class="main">+</span> size_hps <span class="free">hs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-link2"><span class="command">lemma</span></span> link2<span class="main">:</span> <span class="quoted"><span class="quoted">"link <span class="main">(</span>Hp <span class="free">x</span> <span class="free">lx</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="keyword1">of</span> <span class="main">(</span>Hp <span class="bound">y</span> <span class="bound">ly</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="keyword1">then</span> Hp <span class="free">x</span> <span class="main">(</span>Hp <span class="bound">y</span> <span class="bound">ly</span> <span class="main">#</span> <span class="free">lx</span><span class="main">)</span> <span class="keyword1">else</span> Hp <span class="bound">y</span> <span class="main">(</span>Hp <span class="free">x</span> <span class="free">lx</span> <span class="main">#</span> <span class="bound">ly</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hp.split<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-size_hps_link"><span class="command">lemma</span></span> size_hps_link<span class="main">:</span> <span class="quoted"><span class="quoted">"size_hps<span class="main">(</span>hps <span class="main">(</span>link <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> size_hp <span class="free">h1</span> <span class="main">+</span> size_hp <span class="free">h2</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-pass"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> size_hps <span class="free">hs</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_hps_link<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-pass"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-ΔΦ_insert"><span class="command">lemma</span></span> ΔΦ_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>Pairing_Heap_List2.insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">h</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> link2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hp.split<span class="main">)</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-ΔΦ_link"><span class="command">lemma</span></span> ΔΦ_link<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ_hp <span class="main">(</span>link <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">-</span> Φ_hp <span class="free">h1</span> <span class="main">-</span> Φ_hp <span class="free">h2</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="free">h1</span> <span class="main">+</span> size_hp <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sum_ub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">[</span>Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">[</span>Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">lx</span></span></span><span class="main">,</span> Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ly</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">lx</span></span></span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">ly</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sum_ub</span> <span class="main">(</span>Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">lx</span></span></span> <span class="main">#</span> Hp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ly</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ry</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">lx</span></span></span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">ly</span></span></span> <span class="main">+</span> size_hps <span class="free"><span class="bound"><span class="entity">ry</span></span></span><span class="main">)</span> 
    <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free"><span class="bound"><span class="entity">ry</span></span></span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">sum_ub</span> <span class="free"><span class="bound"><span class="entity">ry</span></span></span>"</span></span>


<span class="keyword1" id="Pairing_Heap_List2_Analysis-ΔΦ_pass1_sum_ub"><span class="command">lemma</span></span> ΔΦ_pass1_sum_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="free">h</span>  <span class="main">≤</span> sum_ub <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sum_ub.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">ly</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>real<span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing 0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">hsx</span> <span class="skolem">y</span> <span class="skolem">hsy</span> <span class="skolem">z</span> <span class="skolem">hsize_hp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ry</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">#</span> <span class="skolem">hsize_hp</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Hp <span class="skolem">y</span> <span class="skolem">hsy</span> <span class="main">#</span> <span class="var">?ry</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Hp <span class="skolem">x</span> <span class="skolem">hsx</span> <span class="main">#</span> <span class="var">?rx</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ_hps<span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="var">?h</span>  
    <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span> <span class="main">+</span> size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">+</span> sum_ub <span class="var">?ry</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">-</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span> <span class="main">+</span> size_hps <span class="var">?ry</span><span class="main">)</span> 
    <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> 
      <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span><span class="main">/</span><span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> <span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span> <span class="main">/</span> size_hps <span class="var">?h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">-</span><span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">+</span> <span class="main">…</span>
        <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">/</span> size_hps <span class="var">?h</span> <span class="main">+</span>  size_hps <span class="var">?ry</span> <span class="main">/</span> size_hps <span class="var">?h</span><span class="main">)</span>"</span></span>  
        <span class="keyword1"><span class="command">using</span></span> ld_sum_inequality <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">/</span> size_hps <span class="var">?h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>size_hps <span class="var">?ry</span> <span class="main">/</span> size_hps <span class="var">?h</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> log_divide add_pos_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>
      <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?rx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_hps <span class="skolem">hsx</span> <span class="main">+</span> size_hps <span class="skolem">hsy</span><span class="main">)</span> <span class="main">-</span> <span class="main">…</span> 
      <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?h</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="var">?ry</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1" id="Pairing_Heap_List2_Analysis-ΔΦ_pass1"><span class="command">lemma</span></span> ΔΦ_pass1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="free">hs</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> length <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_ub <span class="free">hs</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> length <span class="free">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sum_ub.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass1_sum_ub<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">hs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-size_hps_pass2"><span class="command">lemma</span></span> size_hps_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span> <span class="main">=</span> Some <span class="free">h</span> <span class="main">⟹</span> size_hps <span class="free">hs</span> <span class="main">=</span> size_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Φ_hps.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> link2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split hp.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-ΔΦ_pass2"><span class="command">lemma</span></span> ΔΦ_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> Φ <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="free">hs</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">hs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">hs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> Hp <span class="skolem">x</span> <span class="skolem">hs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hp.exhaust<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="skolem">hs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Some <span class="skolem">h2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">hs3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h2</span> <span class="main">=</span> Hp <span class="skolem">y</span> <span class="skolem">hs3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hp.exhaust<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> size_hps_pass2<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pairing_Heap_List2_Analysis-ΔΦ_del_min"><span class="command">lemma</span></span> ΔΦ_del_min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"hps <span class="free">h</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> 
  <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">-</span> Φ_hp <span class="free">h</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ΔΦ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ <span class="main">(</span>Some <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ<span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub><span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_hps<span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub><span class="main">(</span>hps <span class="free">h</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> size_hps.elims assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ_hps <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ_hps <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">≤</span>  <span class="numeral">2</span><span class="main">*</span><span class="main">…</span> <span class="main">-</span> length <span class="main">(</span>hps <span class="free">h</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ΔΦ_pass1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ΔΦ</span> <span class="main">=</span> <span class="var">?ΔΦ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="var">?ΔΦ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> heap list <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Empty <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="main">|</span> 
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> del_min <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> Pairing_Heap_List2.insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> heap list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span>None<span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Del_min <span class="main">[</span>Some<span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cost</span> Merge <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder op <span class="main">⇒</span> <span class="tfree">'a</span> heap list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Empty <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Del_min <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">U</span> Merge <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">+</span> size_heap <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pairing<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> arity <span class="main">=</span> <span class="quoted">arity</span> <span class="keyword2"><span class="keyword">and</span></span> exec <span class="main">=</span> <span class="quoted">exec</span> <span class="keyword2"><span class="keyword">and</span></span> cost <span class="main">=</span> <span class="quoted">cost</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ</span> <span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted">U</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Φ_hps_ge0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ss</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Insert
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Insert ΔΦ_insert 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Del_min
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ho</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ho</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ho</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Some <span class="skolem">h</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Hp <span class="skolem">x</span> <span class="skolem">hs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs</span><span class="main">)</span> <span class="main">+</span> T<span class="hidden">⇩</span><sub>p</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>1</sub> <span class="skolem">hs</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="skolem">hs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"cost <span class="skolem">f</span> <span class="skolem">ss</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="skolem">ho</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">ho</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="skolem">ho</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">hs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>del_min <span class="skolem">ho</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">ho</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_hps <span class="skolem">hs</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span>  ΔΦ_del_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="skolem">ho</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> length <span class="skolem">hs</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> False size_hps.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> Merge
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ho1</span></span> <span class="skolem"><span class="skolem">ho2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ho1</span><span class="main">,</span> <span class="skolem">ho2</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ho1</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">ho2</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h1</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ho1</span> <span class="main">=</span> Some <span class="skolem">h1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ho2</span> <span class="main">=</span> Some <span class="skolem">h2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="main">(</span>merge <span class="skolem">ho1</span> <span class="skolem">ho2</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">ho1</span> <span class="main">-</span> Φ <span class="skolem">ho2</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_heap <span class="skolem">ho1</span> <span class="main">+</span> size_heap <span class="skolem">ho2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ΔΦ_link<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">h1</span></span> <span class="quoted"><span class="skolem">h2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size_hp <span class="skolem">h1</span> <span class="main">+</span> size_hp <span class="skolem">h2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>