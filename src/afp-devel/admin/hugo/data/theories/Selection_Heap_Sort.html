<div id="Sort">
<div class="head">
<h1>Theory Sort</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sort.thy
    Author:     Danijela Petrovi\'c, Facylty of Mathematics, University of Belgrade *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Locale Sort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sort
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/List_Permutation.html">HOL-Library.List_Permutation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
First, we start from the definition of sorting algorithm. {\em What
  are the basic properties that any sorting algorithm must satisfy? }
There are two
basic features any sorting algorithm must satisfy:
\begin{itemize}
\item The elements of sorted array must be in some order,
  e.g. ascending or descending order. In this paper we are sorting in
  ascending order.
  $$sorted\ (sort\ \ l)$$

\item The algorithm does not change or delete elements of the given
  array, e.g. the sorted array is the permutation of the input
  array. 
  $$sort\ l\ &lt;\sim \sim&gt;\ l$$
\end{itemize}

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Sort <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="free">sort</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> permutation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sort</span> <span class="free">l</span> <span class="main">&lt;~~&gt;</span> <span class="free">l</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RemoveMax">
<div class="head">
<h1>Theory RemoveMax</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sort.thy
    Author:     Danijela Petrovi\'c, Facylty of Mathematics, University of Belgrade *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Defining data structure and \\
          key function remove\_max›</span></span>

<span class="keyword1"><span class="command">theory</span></span> RemoveMax
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Sort.html">Sort</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Describing data structure›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We have already said that we are going to formalize heap and selection
sort and to show connections between these two sorts.  However, one
can immediately notice that selection sort is using list and heap sort
is using heap during its work. It would be very difficult to show
equivalency between these two sorts if it is continued straightforward
and independently proved that they satisfy conditions of locale
\verb|Sort|. They work with different objects. Much better thing to do
is to stay on the abstract level and to add the new locale, one that
describes characteristics of both list and heap. 
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Collection <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
  <span class="comment1">― ‹-- Represents empty element of the object (for example, for list it is $[]$)›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="comment1">― ‹-- Function that checks weather the object is empty or not›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="comment1">― ‹-- Function transforms given list to desired object (for example, 
    for heap sort, function {\em of\_list} transforms list to heap)›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">multiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> 
  <span class="comment1">― ‹-- Function makes a multiset from the given object. A multiset is a collection without order.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_empty_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">=</span> <span class="free">empty</span>"</span></span> 
  <span class="comment1">― ‹-- It must be assured that the empty element is {\em empty}›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_empty_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free">empty</span>"</span></span>
  <span class="comment1">― ‹-- Must be satisfied that function {\em is\_empty} returns true for element {\em empty}›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> multiset_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="free">empty</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
  <span class="comment1">― ‹-- Multiset of an empty object is empty multiset.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> multiset_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="main">(</span><span class="free">of_list</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">i</span>"</span></span>
  <span class="comment1">― ‹-- Multiset of an object gained by
  applying function {\em of\_list} must be the same as the multiset of
  the list. This, practically, means that function {\em of\_list} does
  not delete or change elements of the starting list.›</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="RemoveMax-is_empty_as_list"><span class="command">lemma</span></span> is_empty_as_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">multiset</span> <span class="free">e</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_empty_inj multiset_empty
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">set</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> set_mset <span class="main">(</span><span class="free">multiset</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function remove\_max›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
We wanted to emphasize that algorithms are same. Due to
the complexity of the implementation it usually happens that simple
properties are omitted, such as the connection between these two
sorting algorithms. This is a key feature that should be presented to
students in order to understand these algorithms. It is not unknown
that students usually prefer selection sort for its simplicity whereas
avoid heap sort for its complexity. However, if we can present them as
the algorithms that are same they may hesitate less in using the heap
sort. This is why the refinement is important. Using this technique we
were able to notice these characteristics. Separate verification would
not bring anything new. Being on the abstract level does not only
simplify the verifications, but also helps us to notice and to show
students important features. Even further, we can prove them formally
and completely justify our observation.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> RemoveMax <span class="main">=</span> Collection <span class="quoted"><span class="free">empty</span></span> <span class="quoted"><span class="free">is_empty</span></span> <span class="quoted"><span class="free">of_list</span></span>  <span class="quoted"><span class="free">multiset</span></span> <span class="keyword2"><span class="keyword">for</span></span> 
  <span class="free">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">multiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder multiset"</span></span> <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">remove_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
  <span class="comment1">― ‹--- Function that removes maximum element from the object of type $'b$. 
      It returns maximum element and the object without that maximum element.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="comment1">― ‹--- It checks weather the object is in required condition.
      For example, if we expect to work with heap it checks weather the object 
      is heap. This is called {\em invariant condition}›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> of_list_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span><span class="free">of_list</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹--- This condition assures that function {\em of\_list}
      made a object with desired property.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> remove_max_max<span class="main">:</span> 
     <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> <span class="free">inv</span> <span class="free">l</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹--- First parameter of the return value of the 
      function {\em remove\_max} is the maximum element›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> remove_max_multiset<span class="main">:</span> 
     <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> <span class="free">inv</span> <span class="free">l</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> 
      add_mset <span class="free">m</span> <span class="main">(</span><span class="free">multiset</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free">l</span>"</span></span>
  <span class="comment1">― ‹--- Condition for multiset, ensures that nothing new is added or nothing 
      is lost after applying {\em remove\_max} function.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> remove_max_inv<span class="main">:</span> 
     <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> <span class="free">inv</span> <span class="free">l</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">inv</span> <span class="free">l'</span>"</span></span>
  <span class="comment1">― ‹--- Ensures that invariant condition is true after removing maximum element. 
      Invariant condition must be true in each step of sorting algorithm, for example
      if we are sorting using heap than in each iteration we must have heap and function
      {\em remove\_max} must not change that.›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="RemoveMax-remove_max_multiset_size"><span class="command">lemma</span></span> remove_max_multiset_size<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> <span class="free">inv</span> <span class="free">l</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> 
               size <span class="main">(</span><span class="free">multiset</span> <span class="free">l</span><span class="main">)</span> <span class="main">&gt;</span> size <span class="main">(</span><span class="free">multiset</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> remove_max_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_subset_size multi_psub_of_add_self<span class="main">)</span>

<span class="keyword1" id="RemoveMax-remove_max_set"><span class="command">lemma</span></span> remove_max_set<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> <span class="free">inv</span> <span class="free">l</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> 
                                 set <span class="free">l'</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> set <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> remove_max_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right local.set_def set_mset_add_mset_insert sup_bot_right<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As it is said before
in each iteration invariant condition must be satisfied, so the {\em
  inv l} is always true, e.g. before and after execution of any
function. This is also the reason why sort function must be defined as
partial. This function parameters stay the same in each step of
iteration -- list stays list, and heap stays heap. As we said before,
in Isabelle/HOL we can only define total function, but there is a
mechanism that enables total function to appear as partial one:›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">ssort'</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ssort'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> 
          <span class="free"><span class="bound"><span class="entity">sl</span></span></span>
       <span class="keyword1">else</span> 
          <span class="keyword1">let</span> 
            <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> 
          <span class="keyword1">in</span>
            <span class="free">ssort'</span> <span class="bound">l'</span> <span class="main">(</span><span class="bound">m</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> ssort'.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ssort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ssort</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> ssort' <span class="main">(</span><span class="free">of_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ssort'_dom</span> <span class="keyword2"><span class="keyword">where</span></span>
   step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">m</span> <span class="bound">l'</span><span class="main">.</span> <span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> 
                  <span class="free">ssort'_dom</span> <span class="main">(</span><span class="bound">l'</span><span class="main">,</span> <span class="bound">m</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ssort'_dom</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1" id="RemoveMax-ssort'_termination"><span class="command">lemma</span></span> ssort'_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ssort'_dom <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">sl</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="main"><span class="main">(</span></span><span class="free"><span class="free">multiset</span></span> <span class="bound"><span class="bound">l</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">sl</span><span class="main">)</span><span class="main">.</span> size <span class="main">(</span><span class="free">multiset</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> 
         <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span> <span class="main">⟶</span> <span class="free">inv</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> ssort'_dom <span class="bound">y</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">sl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">sl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssort'_dom <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">sl</span><span class="main">)</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ssort'_dom.step<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssort'_dom <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">m</span><span class="main">#</span><span class="skolem">sl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">m</span><span class="main">#</span><span class="skolem">sl</span><span class="main">)</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">m</span><span class="main">#</span><span class="skolem">sl</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">sl</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">inv</span> <span class="main">(</span>fst <span class="skolem">p</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l</span>›</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> remove_max_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> remove_max_multiset_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="RemoveMax-ssort'Induct"><span class="command">lemma</span></span> ssort'Induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">l</span> <span class="free">sl</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span> <span class="bound">sl</span> <span class="bound">m</span> <span class="bound">l'</span><span class="main">.</span> 
    <span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="bound">l</span><span class="main">;</span> <span class="free">inv</span> <span class="bound">l</span><span class="main">;</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="bound">l</span><span class="main">;</span> <span class="free">P</span> <span class="bound">l</span> <span class="bound">sl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">l'</span> <span class="main">(</span><span class="bound">m</span> <span class="main">#</span> <span class="bound">sl</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">empty</span> <span class="main">(</span>ssort' <span class="free">l</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">inv</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ssort'_dom <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ssort'_termination
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">sl</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">sl</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ssort'_dom.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">l</span> <span class="skolem">sl</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4<span class="main">)</span> step<span class="main">(</span>5<span class="main">)</span> ssort'.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">]</span> is_empty_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">remove_max</span> <span class="skolem">l</span>"</span></span> 
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="var">?p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="var">?p</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span><span class="main">]</span> step<span class="main">(</span>3<span class="main">)</span> 
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4<span class="main">)</span> step<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">]</span> step<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> remove_max_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> ssort'.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">sl</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RemoveMax-mset_ssort'"><span class="command">lemma</span></span> mset_ssort'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>ssort' <span class="free">l</span> <span class="free">sl</span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free">l</span> <span class="main">+</span> mset <span class="free">sl</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="free">empty</span> <span class="main">+</span> mset <span class="main">(</span>ssort' <span class="free">l</span> <span class="free">sl</span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free">l</span> <span class="main">+</span> mset <span class="free">sl</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ssort'Induct<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l1</span> <span class="skolem">sl1</span> <span class="skolem">m</span> <span class="skolem">l'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l1</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="skolem">l1</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l1</span>"</span></span> 
             <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="skolem">l1</span> <span class="main">+</span> mset <span class="skolem">sl1</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free">l</span> <span class="main">+</span> mset <span class="free">sl</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="skolem">l'</span> <span class="main">+</span> mset <span class="main">(</span><span class="skolem">m</span> <span class="main">#</span> <span class="skolem">sl1</span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free">l</span> <span class="main">+</span> mset <span class="free">sl</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> remove_max_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_mset_add_mset_left union_mset_add_mset_right mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> multiset_empty
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RemoveMax-sorted_ssort'"><span class="command">lemma</span></span> sorted_ssort'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">sl</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> List.set <span class="free">sl</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>ssort' <span class="free">l</span> <span class="free">sl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>ssort' <span class="free">l</span> <span class="free">sl</span><span class="main">)</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">empty</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> List.set <span class="main">(</span>ssort' <span class="free">l</span> <span class="free">sl</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ssort'Induct<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">sl</span> <span class="skolem">m</span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l</span>"</span></span> 
           <span class="quoted"><span class="quoted">"<span class="free">inv</span> <span class="skolem">l</span>"</span></span> 
           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l</span>"</span></span> 
           <span class="quoted"><span class="quoted">"sorted <span class="skolem">sl</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>List.set <span class="skolem">sl</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">m</span> <span class="main">#</span> <span class="skolem">sl</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">l'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>List.set <span class="main">(</span><span class="skolem">m</span> <span class="main">#</span> <span class="skolem">sl</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_max_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span> remove_max_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_ge<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RemoveMax-sorted_ssort"><span class="command">lemma</span></span> sorted_ssort<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>ssort <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ssort_def
<span class="keyword1"><span class="command">using</span></span> sorted_ssort'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">of_list</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> of_list_inv
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="RemoveMax-permutation_ssort"><span class="command">lemma</span></span> permutation_ssort<span class="main">:</span> <span class="quoted"><span class="quoted">"ssort <span class="free">l</span> <span class="main">&lt;~~&gt;</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> mset_eq_perm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>ssort <span class="free">l</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ssort_def
    <span class="keyword1"><span class="command">using</span></span> mset_ssort'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">of_list</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> multiset_of_list of_list_inv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Using assumptions given in the definitions of the locales {\em
  Collection} and {\em RemoveMax} for the functions {\em multiset},
{\em is\_empty}, {\em of\_list} and {\em remove\_max} it is no
difficulty to show:›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RemoveMax <span class="main">&lt;</span> Sort <span class="quoted">ssort</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_ssort permutation_ssort<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SelectionSort_Functional">
<div class="head">
<h1>Theory SelectionSort_Functional</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sort.thy
    Author:     Danijela Petrovi\'c, Facylty of Mathematics, University of Belgrade *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of functional Selection Sort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SelectionSort_Functional
<span class="keyword2"><span class="keyword">imports</span></span> <a href="RemoveMax.html">RemoveMax</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining data structure›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Selection sort works with list and that is the reason why {\em
  Collection} should be interpreted as list.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Collection <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted">id</span> <span class="quoted">mset</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining function remove\_max›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following is definition of {\em remove\_max} function. 
The idea is very well known -- assume that the maximum element is the
first one and then compare with each element of the list. Function
{\em f} is one step in iteration, it compares current maximum {\em m}
with one element {\em x}, if it is bigger then {\em m} stays current
maximum and {\em x} is added in the resulting list, otherwise {\em x}
is current maximum and {\em m} is added in the resulting
list.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_max</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_max</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> foldl f <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SelectionSort_Functional-max_Max_commute"><span class="command">lemma</span></span> max_Max_commute<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> max <span class="main">(</span>Max <span class="main">(</span>insert <span class="free">m</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> max <span class="free">m</span> <span class="main">(</span>Max <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_insert max.commute max.left_commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The function really returned the
maximum value.›</span></span>

<span class="keyword1" id="SelectionSort_Functional-remove_max_max_lemma"><span class="command">lemma</span></span> remove_max_max_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>foldl f <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span>  Max <span class="main">(</span>set <span class="main">(</span><span class="free">m</span> <span class="main">#</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl f <span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="var">?a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>foldl f <span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> max <span class="var">?m'</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_Max_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SelectionSort_Functional-remove_max_max"><span class="command">lemma</span></span> remove_max_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> remove_max <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> remove_max_def
<span class="keyword1"><span class="command">using</span></span> remove_max_max_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">l</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">using</span></span> fst_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Nothing new is added in the list and noting is deleted
from the list except the maximum element.›</span></span>

<span class="keyword1" id="SelectionSort_Functional-remove_max_mset_lemma"><span class="command">lemma</span></span> remove_max_mset_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> foldl f <span class="main">(</span><span class="free">m'</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">m</span> <span class="main">#</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">m'</span> <span class="main">#</span> <span class="free">t'</span> <span class="main">@</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">m'</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"foldl f <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="var">?a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="var">?m'</span> <span class="main">#</span> <span class="var">?t'</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">m'</span> <span class="main">#</span> <span class="skolem">t'</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?m'</span></span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="quoted"><span class="skolem">m'</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="SelectionSort_Functional-remove_max_mset"><span class="command">lemma</span></span> remove_max_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> remove_max <span class="free">l</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">m</span> <span class="main">(</span>mset <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> remove_max_def
<span class="keyword1"><span class="command">using</span></span> remove_max_mset_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">l</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ssf_ssort'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssf_ssort'</span> <span class="main">=</span> RemoveMax.ssort' <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> remove_max"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ssf_ssort</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ssf_ssort</span> <span class="main">=</span> RemoveMax.ssort <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> id remove_max"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> SSRemoveMax<span class="main">:</span> 
  RemoveMax <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted">id</span> <span class="quoted">mset</span> <span class="quoted">remove_max</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span> 
  <span class="keyword2"><span class="keyword">rewrites</span></span>
 <span class="quoted"><span class="quoted">"RemoveMax.ssort' <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> remove_max <span class="main">=</span> ssf_ssort'"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
 <span class="quoted"><span class="quoted">"RemoveMax.ssort <span class="main">(</span><span class="main">λ</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> id remove_max <span class="main">=</span> ssf_ssort"</span></span>
<span class="keyword1"><span class="command">using</span></span> remove_max_max
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_max_mset<span class="main">)</span>


  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Heap">
<div class="head">
<h1>Theory Heap</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sort.thy
    Author:     Danijela Petrovi\'c, Facylty of Mathematics, University of Belgrade *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of Heap Sort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Heap
<span class="keyword2"><span class="keyword">imports</span></span> <a href="RemoveMax.html">RemoveMax</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defining tree and properties of heap›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> Tree <span class="main">=</span> <span class="quoted">"E"</span> <span class="main">|</span> <span class="quoted">"T"</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹With {\em E} is represented empty tree and with {\em T\ \ \ 'a\ \ \ 'a
  Tree\ \ \ 'a Tree} is represented a node whose root element is of
type {\em 'a} and its left and right branch is also a tree of
type {\em 'a}.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size</span> E <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">size</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">size</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of the function that makes a multiset from the given tree:›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">multiset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">multiset</span> E <span class="main">=</span> <span class="main">{#}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#}</span> <span class="main">+</span> <span class="free">multiset</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">val</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of the function that has the value {\em True} if the tree is
heap, otherwise it is {\em False}:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder Tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> E <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E E<span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">is_heap</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> E<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">is_heap</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">is_heap</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">is_heap</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Heap-heap_top_geq"><span class="command">lemma</span></span> heap_top_geq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈#</span> multiset <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_heap.induct<span class="main">)</span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="Heap-heap_top_max"><span class="command">lemma</span></span> heap_top_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">=</span> Max_mset <span class="main">(</span>multiset <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max_eqI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_mset <span class="main">(</span>multiset <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> val <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> heap_top_geq <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹is_heap <span class="free">t</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">∈</span> set_mset <span class="main">(</span>multiset <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> E›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The next step is to define function {\em remove\_max}, but the
question is weather implementation of {\em remove\_max} depends on
implementation of the functions {\em is\_heap} and {\em multiset}. The
answer is negative. This suggests that another step of refinement
could be added before definition of function {\em
  remove\_max}. Additionally, there are other reasons why this should
be done, for example, function {\em remove\_max} could be implemented
in functional or in imperative manner.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Heap <span class="main">=</span>  Collection <span class="quoted"><span class="free">empty</span></span> <span class="quoted"><span class="free">is_empty</span></span> <span class="quoted"><span class="free">of_list</span></span>  <span class="quoted"><span class="free">multiset</span></span> <span class="keyword2"><span class="keyword">for</span></span> 
  <span class="free">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
  <span class="free">multiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder multiset"</span></span> <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">as_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder Tree"</span></span>
  <span class="comment1">― ‹This function is not very important, but it is needed in order to avoide problems with types and to detect that observed object is a tree.›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">remove_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> multiset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">multiset</span> <span class="free">l</span> <span class="main">=</span> Heap.multiset <span class="main">(</span><span class="free">as_tree</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is_heap_of_list<span class="main">:</span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="main">(</span><span class="free">of_list</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> as_tree_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as_tree</span> <span class="free">t</span> <span class="main">=</span> E <span class="main">⟷</span> <span class="free">is_empty</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> remove_max_multiset'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> add_mset <span class="free">m</span> <span class="main">(</span><span class="free">multiset</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> remove_max_is_heap<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">is_empty</span> <span class="free">l</span><span class="main">;</span> is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="free">l</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> 
  is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="free">l'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> remove_max_val<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">is_empty</span> <span class="free">t</span><span class="main">;</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> val <span class="main">(</span><span class="free">as_tree</span> <span class="free">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹It is very easy to prove that locale {\em Heap} is sublocale of locale {\em RemoveMax}›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Heap <span class="main">&lt;</span> 
  RemoveMax <span class="quoted"><span class="free">empty</span></span> <span class="quoted"><span class="free">is_empty</span></span> <span class="quoted"><span class="free">of_list</span></span> <span class="quoted"><span class="free">multiset</span></span> <span class="quoted"><span class="free">remove_max</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="main">(</span><span class="free">of_list</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_heap_of_list<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">m</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">m</span> <span class="main">(</span><span class="free">multiset</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">multiset</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> remove_max_multiset'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">m</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> remove_max_is_heap<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">m</span> <span class="skolem">l'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">is_empty</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span><span class="free">as_tree</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_max</span> <span class="skolem">l</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_def
    <span class="keyword1"><span class="command">using</span></span> heap_top_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as_tree</span> <span class="skolem">l</span>"</span></span><span class="main">]</span> remove_max_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> multiset is_empty_inj as_tree_empty
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">in_tree</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> E <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">∨</span> <span class="free">in_tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∨</span> <span class="free">in_tree</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Heap-is_heap_max"><span class="command">lemma</span></span> is_heap_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">≥</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HeapFunctional">
<div class="head">
<h1>Theory HeapFunctional</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sort.thy
    Author:     Danijela Petrovi\'c, Facylty of Mathematics, University of Belgrade *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of Functional Heap Sort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HeapFunctional
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Heap.html">Heap</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹As we
said before, maximum element of the heap is its root. So, finding
maximum element is not difficulty. But, this element should also be
removed and remainder after deleting this element is two trees, left
and right branch of original heap. Those branches are also heaps by
the definition of the heap. To maintain consistency, branches should
be combined into one tree that satisfies heap condition:›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder Tree <span class="main">⇒</span> <span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> E <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> E <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="keyword1">then</span> T <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span>
      <span class="keyword1">else</span> T <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">(</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> size <span class="bound">t1</span> <span class="main">+</span> size <span class="bound">t2</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">,</span> T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">,</span> T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">∈</span> 
        measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> Heap.size <span class="bound">t1</span> <span class="main">+</span> Heap.size <span class="bound">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">l2</span><span class="main">,</span> T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">,</span> T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">,</span> T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">∈</span> 
        measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> Heap.size <span class="bound">t1</span> <span class="main">+</span> Heap.size <span class="bound">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="HeapFunctional-merge_val"><span class="command">lemma</span></span> merge_val<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val<span class="main">(</span>merge <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> val <span class="free">l</span> <span class="main">∨</span> val<span class="main">(</span>merge <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> val <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>merge.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function {\em merge} merges two heaps into one:›</span></span>

<span class="keyword1" id="HeapFunctional-merge_heap_is_heap"><span class="command">lemma</span></span> merge_heap_is_heap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>merge <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>merge.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust is_heap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span>  3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">l1</span> <span class="main">∨</span> val<span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">v1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> E"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">=</span> E›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> val <span class="skolem">l1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust in_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap_max val.simps<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">=</span> E›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">l1</span> 
                     <span class="main">∨</span> val<span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v2</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust is_heap.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
              is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> merge.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> val.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> val <span class="skolem">r1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust in_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap_max val.simps<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">v1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">r1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> val <span class="skolem">r1</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust Tree.inject Tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
              True is_heap.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> merge.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
              merge.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_eq_iff val.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> val <span class="skolem">l1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust in_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap_max val.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">≠</span> E"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust Tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> merge.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>    
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">≠</span> E›</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ll1</span></span> <span class="skolem"><span class="skolem">lr1</span></span> <span class="skolem"><span class="skolem">lv1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> T <span class="skolem">lv1</span> <span class="skolem">ll1</span> <span class="skolem">lr1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">≠</span> E›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rl1</span></span> <span class="skolem"><span class="skolem">rr1</span></span> <span class="skolem"><span class="skolem">rv1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">rv1</span> <span class="skolem">rl1</span> <span class="skolem">rr1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">≠</span> E›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">l1</span> <span class="main">∨</span> 
                 val<span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v2</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> val <span class="skolem">l1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_heap.simps<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">lv1</span></span> <span class="quoted"><span class="skolem">ll1</span></span> <span class="quoted"><span class="skolem">lr1</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">rl1</span></span>  <span class="quoted"><span class="skolem">rr1</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r1</span> <span class="main">=</span> T <span class="skolem">lv1</span> <span class="skolem">ll1</span> <span class="skolem">lr1</span>›</span></span> <span class="quoted"><span class="quoted">‹merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">rv1</span> <span class="skolem">rl1</span> <span class="skolem">rr1</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="skolem">r1</span>›</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> val <span class="skolem">r1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust is_heap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
          is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span>  3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">l2</span> <span class="main">∨</span> 
          val<span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">v2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> E"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">=</span> E›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> val <span class="skolem">l2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust in_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap_max val.simps<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">=</span> E›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>›</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">l2</span> <span class="main">∨</span> 
                 val<span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust is_heap.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 
              is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> linorder_linear merge.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> val.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> val <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust in_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap_max val.simps<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> E"</span></span><span class="main">)</span> 
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">v2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">r2</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> val <span class="skolem">r2</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust Tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
              is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> linorder_linear val.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> val <span class="skolem">l2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust in_tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap_max val.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">≠</span> E"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust Tree.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> merge.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>    
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">≠</span> E›</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ll1</span></span> <span class="skolem"><span class="skolem">lr1</span></span> <span class="skolem"><span class="skolem">lv1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> T <span class="skolem">lv1</span> <span class="skolem">ll1</span> <span class="skolem">lr1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">≠</span> E›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rl1</span></span> <span class="skolem"><span class="skolem">rr1</span></span> <span class="skolem"><span class="skolem">rv1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">rv1</span> <span class="skolem">rl1</span> <span class="skolem">rr1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">≠</span> E›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">v2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">l2</span> <span class="main">∨</span> 
                 val<span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> val <span class="skolem">l2</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_heap.simps<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">lv1</span></span> <span class="quoted"><span class="skolem">ll1</span></span> <span class="quoted"><span class="skolem">lr1</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">rl1</span></span> <span class="quoted"><span class="skolem">rr1</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r2</span> <span class="main">=</span> T <span class="skolem">lv1</span> <span class="skolem">ll1</span> <span class="skolem">lr1</span>›</span></span> <span class="quoted"><span class="quoted">‹merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">rv1</span> <span class="skolem">rl1</span> <span class="skolem">rr1</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="skolem">r2</span>›</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> val <span class="skolem">r2</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>  merge <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E E<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">hs_of_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hs_of_list</span> <span class="main">[]</span> <span class="main">=</span> E"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hs_of_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">hs_of_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hs_is_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs_is_empty</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span>  <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> E"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of function {\em remove\_max}:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hs_remove_max</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder Tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> Tree"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hs_remove_max</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> merge <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="HeapFunctional-merge_multiset"><span class="command">lemma</span></span> merge_multiset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"multiset <span class="free">l</span> <span class="main">+</span> multiset <span class="free">g</span> <span class="main">=</span> multiset <span class="main">(</span>merge <span class="free">l</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>merge.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span>  True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>merge <span class="skolem">l1</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>  multiset <span class="skolem">r1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l1</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">+</span> multiset <span class="skolem">r1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l1</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>merge <span class="skolem">l2</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> multiset <span class="skolem">r2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>merge <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> multiset <span class="skolem">r2</span> <span class="main">+</span>  multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_commute<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Proof that defined functions are interpretation of abstract functions from locale {\em Collection}:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> HS<span class="main">:</span> Collection <span class="quoted"><span class="quoted">"E"</span></span> <span class="quoted">hs_is_empty</span> <span class="quoted">hs_of_list</span> <span class="quoted">multiset</span>
<span class="keyword1"><span class="command">proof</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hs_is_empty <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> E"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hs_is_empty E"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset E <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>hs_of_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> multiset <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hs_of_list <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">a</span> E E"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">unfolding</span></span> insert_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Proof that defined functions are interpretation of abstract functions from locale {\em Heap}:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Heap <span class="quoted"><span class="quoted">"E"</span></span> <span class="quoted">hs_is_empty</span> <span class="quoted">hs_of_list</span> <span class="quoted">multiset</span> <span class="quoted">id</span> <span class="quoted">hs_remove_max</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset <span class="skolem">l</span> <span class="main">=</span> Heap.multiset <span class="main">(</span>id <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>id <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hs_of_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> merge <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">a</span> E E<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">unfolding</span></span> insert_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">a</span> E E<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>merge <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">a</span> E E<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons merge_heap_is_heap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hs_of_list <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">a</span> E E"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹hs_of_list <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> merge <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">a</span> E E<span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>     
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span>id <span class="skolem">t</span> <span class="main">=</span> E<span class="main">)</span> <span class="main">=</span> hs_is_empty <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">m</span> <span class="skolem">t'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> T <span class="skolem">m</span> <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Tree.exhaust hs_is_empty_def hs_remove_max.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">m</span> <span class="main">(</span>multiset <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> multiset <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> merge_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">m</span> <span class="skolem">t'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust hs_is_empty_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> merge <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l</span> <span class="main">∧</span> is_heap <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust id_apply is_heap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        is_heap.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>id <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> merge <span class="skolem">l</span> <span class="skolem">r</span>›</span></span> 
    <span class="keyword1"><span class="command">using</span></span> merge_heap_is_heap
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">m</span> <span class="skolem">t'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> val <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Tree.exhaust hs_is_empty_def 
        hs_remove_max.simps id_apply val.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HeapImperative">
<div class="head">
<h1>Theory HeapImperative</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Sort.thy
    Author:     Danijela Petrovi\'c, Facylty of Mathematics, University of Belgrade *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification of Imperative Heap Sort›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HeapImperative
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Heap.html">Heap</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">left</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">left</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">left_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">left_val</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> val <span class="main">(</span>left <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">right</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">right_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">right_val</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> val <span class="main">(</span>right <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">set_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_val</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> T <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>left <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>right <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The first step is to implement function {\em siftDown}. If some node
does not satisfy heap property, this function moves it down the heap
until it does. For a node is checked weather it satisfies heap property or not. If it
does nothing is changed. If it does not, value of the root node
becomes a value of the larger child and the value of that child
becomes the value of the root node. This is the reason this function
is called {\tt siftDown} -- value of the node is places down in the
heap. Now, the problem is that the child node may not satisfy the heap
property and that is the reason why function {\tt siftDown} is
recursively applied.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">siftDown</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder Tree <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">siftDown</span> E <span class="main">=</span> E"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">siftDown</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E E<span class="main">)</span> <span class="main">=</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E E"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">siftDown</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> E<span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> E <span class="keyword1">else</span> T <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">siftDown</span> <span class="main">(</span>set_val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> E<span class="main">)</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">siftDown</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> T <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> E <span class="main">(</span><span class="free">siftDown</span> <span class="main">(</span>set_val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">siftDown</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="keyword1">if</span> val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> 
            <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> T <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">siftDown</span> <span class="main">(</span>set_val <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
        <span class="keyword1">else</span>
            <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> T <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free">siftDown</span> <span class="main">(</span>set_val <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="HeapImperative-siftDown_Node"><span class="command">lemma</span></span> siftDown_Node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> T <span class="free">v</span> <span class="free">l</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">l'</span> <span class="bound">v'</span> <span class="bound">r'</span><span class="main">.</span> siftDown <span class="free">t</span> <span class="main">=</span> T <span class="bound">v'</span> <span class="bound">l'</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">≥</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>siftDown.induct<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="HeapImperative-siftDown_in_tree"><span class="command">lemma</span></span> siftDown_in_tree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="main">(</span>val <span class="main">(</span>siftDown <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>siftDown.induct<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="HeapImperative-siftDown_in_tree_set"><span class="command">lemma</span></span> siftDown_in_tree_set<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="free">t</span> <span class="main">⟷</span> in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>siftDown.induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>siftDown.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v1</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v2</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 3
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> <span class="free">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span> 3<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> <span class="free">v</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">v2</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 4
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> <span class="free">v</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v2</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span> 4<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> <span class="free">v</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_1"</span> <span class="skolem">v'</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span><span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_1"</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v'</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_1"</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v'</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_2"</span> <span class="skolem">v'</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span><span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_2"</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v'</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_2"</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v'</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="free">v</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v1</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">v2</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="HeapImperative-siftDown_heap_is_heap"><span class="command">lemma</span></span> siftDown_heap_is_heap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> T <span class="free">v</span> <span class="free">l</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>siftDown <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>siftDown.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v2</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> 3<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"siftDown <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v'</span> <span class="skolem">l'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> siftDown_Node<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span> <span class="quoted"><span class="skolem">v2</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">r1</span></span> <span class="quoted"><span class="skolem">v2</span></span><span class="main">]</span> False 3
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> *
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> *
          <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree_set<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3
          <span class="keyword1"><span class="command">using</span></span> is_heap_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> * <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">v2</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>2-4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"siftDown <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v'</span> <span class="skolem">l'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> siftDown_Node<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span> <span class="quoted"><span class="skolem">v2</span></span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False  4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l1</span></span> <span class="quoted"><span class="skolem">r1</span></span> <span class="quoted"><span class="skolem">v2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> *
        <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * siftDown_in_tree_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_heap_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span> 4
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> False *
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_1"</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span> <span class="skolem">v3</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> <span class="quoted">"5_1"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"siftDown <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v'</span> <span class="skolem">l'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> siftDown_Node
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>3<span class="main">,</span> 5<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">r2</span></span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> False 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * siftDown_in_tree
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l2</span> <span class="skolem">r2</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> is_heap_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span>"</span></span><span class="main">]</span> <span class="quoted">"5_1"</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> * False <span class="quoted">"5_1"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v3</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> <span class="quoted">"5_1"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"siftDown <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v'</span> <span class="skolem">l'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> siftDown_Node
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l3</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r3</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>4<span class="main">,</span> 5<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l3</span></span> <span class="quoted"><span class="skolem">r3</span></span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> False 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">≥</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * siftDown_in_tree
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l3</span> <span class="skolem">r3</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v3</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> is_heap_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v3</span> <span class="skolem">l3</span> <span class="skolem">r3</span>"</span></span><span class="main">]</span> <span class="quoted">"5_1"</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> * False <span class="quoted">"5_1"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>          
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_2"</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span> <span class="skolem">v3</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> <span class="quoted">"5_2"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"siftDown <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v'</span> <span class="skolem">l'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≤</span> <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> siftDown_Node
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>3<span class="main">,</span> 5<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l2</span></span> <span class="quoted"><span class="skolem">r2</span></span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> False 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * siftDown_in_tree
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l2</span> <span class="skolem">r2</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> is_heap_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span>"</span></span><span class="main">]</span> <span class="quoted">"5_2"</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> * False <span class="quoted">"5_2"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v3</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> <span class="quoted">"5_2"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"siftDown <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v'</span> <span class="skolem">l'</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> siftDown_Node
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l3</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r3</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>4<span class="main">,</span> 5<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>is_heap.induct<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l3</span></span> <span class="quoted"><span class="skolem">r3</span></span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> False 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">≥</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="var">?t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * siftDown_in_tree
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> siftDown_in_tree_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l3</span> <span class="skolem">r3</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"in_tree <span class="skolem">v'</span> <span class="main">(</span>T <span class="skolem">v3</span> <span class="skolem">l3</span> <span class="skolem">r3</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> is_heap_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v3</span> <span class="skolem">l3</span> <span class="skolem">r3</span>"</span></span><span class="main">]</span> <span class="quoted">"5_2"</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v2</span> <span class="main">≥</span> <span class="skolem">v3</span>›</span></span> * False <span class="quoted">"5_2"</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>          
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of the function {\em heapify} which
makes a heap from any given binary tree.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">heapify</span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">heapify</span> E <span class="main">=</span> E"</span></span>
<span class="main">|</span>  <span class="quoted"><span class="quoted">"<span class="free">heapify</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> siftDown <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">heapify</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">heapify</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="HeapImperative-heapify_heap_is_heap"><span class="command">lemma</span></span> heapify_heap_is_heap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>heapify <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> E
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> siftDown_heap_is_heap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"heapify <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"heapify <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v</span> <span class="main">(</span>heapify <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>heapify <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of {\em removeLeaf} function.  Function returns two values. The first one
is the value of romoved leaf element. The second returned value is tree without that leaf.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">removeLeaf</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder Tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">removeLeaf</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E E<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> E<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">removeLeaf</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> E<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">removeLeaf</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">,</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>snd <span class="main">(</span><span class="free">removeLeaf</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> E<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">removeLeaf</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">removeLeaf</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> E <span class="main">(</span>snd <span class="main">(</span><span class="free">removeLeaf</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">removeLeaf</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">removeLeaf</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">,</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>snd <span class="main">(</span><span class="free">removeLeaf</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Function {\em of\_list\_tree} makes a binary tree from any given
list.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">of_list_tree</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder list <span class="main">⇒</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">of_list_tree</span> <span class="main">[]</span> <span class="main">=</span> E"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">of_list_tree</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">tail</span></span></span><span class="main">)</span> <span class="main">=</span> T <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free">of_list_tree</span> <span class="free"><span class="bound"><span class="entity">tail</span></span></span><span class="main">)</span> E"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹By applying {\em heapify} binary tree is transformed into
heap.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hs_of_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hs_of_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> heapify <span class="main">(</span>of_list_tree <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of function {\em hs\_remove\_max}. As it is already well
established, finding maximum is not a problem, since it is in the root
element of the heap. The root element is replaced with leaf of the
heap and that leaf is erased from its previous position. However, now
the new root element may not satisfy heap property and that is the
reason to apply function {\em siftDown}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hs_remove_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder Tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> Tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hs_remove_max</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v'</span> <span class="main">=</span> fst <span class="main">(</span>removeLeaf <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">;</span>
          <span class="bound">t'</span> <span class="main">=</span> snd <span class="main">(</span>removeLeaf <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="bound">t'</span> <span class="main">=</span> E <span class="keyword1">then</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> E<span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> siftDown <span class="main">(</span>set_val <span class="bound">t'</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hs_is_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hs_is_empty</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span>  <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> E"</span></span>

<span class="keyword1" id="HeapImperative-siftDown_multiset"><span class="command">lemma</span></span> siftDown_multiset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="free">t</span><span class="main">)</span> <span class="main">=</span> multiset <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>siftDown.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v1</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v1</span> <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> E<span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> E<span class="main">)</span> <span class="main">=</span> 
          multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">=</span> 
          multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">v1</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">=</span> 
          multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v1</span> E <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span>  multiset <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">v1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4 False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v1</span> E <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹multiset <span class="main">(</span>set_val <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">=</span> 
             multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v1</span> E <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>  
          <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation monoid_add_class.add.left_neutral 
          multiset.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> multiset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_commute union_lcomm<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">=</span> 
          <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_1"</span> <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> 
             multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span>
              multiset<span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> 
            multiset<span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> 
                multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> 
                multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
             multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> 
             multiset <span class="skolem">l2</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_1"</span><span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> 
         <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> 
         multiset <span class="skolem">r2</span> <span class="main">=</span> 
            multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> 
            <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"5_2"</span> <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> 
               multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> 
              <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset<span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> 
            multiset<span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">=</span> 
              multiset <span class="skolem">l1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r1</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v1</span><span class="main">#}</span> <span class="main">+</span> 
              multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>siftDown <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> 
               multiset <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">v1</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span> <span class="quoted">"5_2"</span><span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> 
              multiset <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> 
            multiset <span class="skolem">r2</span> <span class="main">=</span> 
              multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v2</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l2</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> 
              multiset <span class="skolem">r2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="HeapImperative-mset_list_tree"><span class="command">lemma</span></span> mset_list_tree<span class="main">:</span>
 <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>of_list_tree <span class="free">l</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">tail</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>of_list_tree <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">tail</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">tail</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">tail</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>of_list_tree <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">tail</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">tail</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1" id="HeapImperative-multiset_heapify"><span class="command">lemma</span></span> multiset_heapify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>heapify <span class="free">t</span><span class="main">)</span> <span class="main">=</span> multiset <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> E
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>heapify <span class="main">(</span>T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> siftDown_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v</span> <span class="main">(</span>heapify <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>heapify <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword1" id="HeapImperative-multiset_heapify_of_list_tree"><span class="command">lemma</span></span> multiset_heapify_of_list_tree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>heapify <span class="main">(</span>of_list_tree <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> multiset_heapify<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"of_list_tree <span class="free">l</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">using</span></span> mset_list_tree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="HeapImperative-removeLeaf_val_val"><span class="command">lemma</span></span> removeLeaf_val_val<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>removeLeaf <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> E"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">=</span> val <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>removeLeaf.induct<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="HeapImperative-removeLeaf_heap_is_heap"><span class="command">lemma</span></span> removeLeaf_heap_is_heap<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>removeLeaf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> val <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False removeLeaf_val_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> E<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust is_heap.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> val <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False removeLeaf_val_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v</span> E <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Tree.exhaust is_heap.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 3
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"4_1"</span> <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1'</span></span> <span class="skolem"><span class="skolem">l1'</span></span> <span class="skolem"><span class="skolem">r1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> val <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False removeLeaf_val_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span> <span class="quoted"><span class="quoted">‹<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"4_2"</span> <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1'</span></span> <span class="skolem"><span class="skolem">l1'</span></span> <span class="skolem"><span class="skolem">r1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span><span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> val <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False removeLeaf_val_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v1'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>T <span class="skolem">v</span> <span class="main">(</span>T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≥</span> <span class="skolem">v2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span> <span class="quoted"><span class="quoted">‹<span class="var">?t</span> <span class="main">=</span> T <span class="skolem">v1'</span> <span class="skolem">l1'</span> <span class="skolem">r1'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Difined functions satisfy conditions of locale {\em Collection} and thus represent 
       interpretation of this locale.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> HS<span class="main">:</span> Collection <span class="quoted"><span class="quoted">"E"</span></span> <span class="quoted">hs_is_empty</span> <span class="quoted">hs_of_list</span> <span class="quoted">multiset</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hs_is_empty <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> E"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hs_is_empty E"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset E <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>hs_of_list <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hs_of_list_def
    <span class="keyword1"><span class="command">using</span></span> multiset_heapify_of_list_tree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="HeapImperative-removeLeaf_multiset"><span class="command">lemma</span></span> removeLeaf_multiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v'</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> removeLeaf <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t'</span> <span class="main">=</span> multiset <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>removeLeaf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> E"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
           <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
           multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
           <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> E›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
        multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
           <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
           multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> E <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
          <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
          multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
          <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> E <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
        multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
           <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
           multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> monoid_add_class.add.right_neutral 
        multiset.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> multiset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"4_1"</span> <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
         <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
         multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
         <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
        multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_1"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
           multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
           <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
           multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
           <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"4_2"</span> <span class="skolem">v</span> <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span> <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span><span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
         <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
         multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
         <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
        multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4_2"</span><span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
         multiset <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="skolem">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">t'</span> <span class="main">=</span> 
           <span class="main">{#</span>fst <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">#}</span> <span class="main">+</span> 
           multiset <span class="main">(</span>snd <span class="main">(</span>removeLeaf <span class="main">(</span>T <span class="skolem">v1</span> <span class="skolem">l1</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> 
           <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="main">(</span>T <span class="skolem">v2</span> <span class="skolem">l2</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="HeapImperative-set_val_multiset"><span class="command">lemma</span></span> set_val_multiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>set_val <span class="free">t</span> <span class="free">v'</span><span class="main">)</span> <span class="main">+</span>  <span class="main">{#</span>val <span class="free">t</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="main">(</span>set_val <span class="free">t</span> <span class="free">v'</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span>val <span class="free">t</span><span class="main">#}</span> <span class="main">=</span> 
         multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t</span> <span class="main">=</span> 
        <span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> T <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> union_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">=</span> 
        multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute union_lcomm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹multiset <span class="main">(</span>set_val <span class="free">t</span> <span class="free">v'</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span>val <span class="free">t</span><span class="main">#}</span> <span class="main">=</span> 
           multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t</span> <span class="main">=</span> 
           <span class="main">{#</span><span class="free">v'</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">l</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">v</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="skolem">r</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="HeapImperative-hs_remove_max_multiset"><span class="command">lemma</span></span> hs_remove_max_multiset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> E"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">m</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t'</span> <span class="main">=</span> multiset <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>removeLeaf <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>removeLeaf <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">m</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t'</span> <span class="main">=</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> hs_remove_max_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">=</span> val <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>removeLeaf.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v1</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> True
      <span class="keyword1"><span class="command">unfolding</span></span> hs_remove_max_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="free">t</span> <span class="main">=</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> removeLeaf_multiset<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> True assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_neutral<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> multiset.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{#</span><span class="free">m</span><span class="main">#}</span> <span class="main">+</span> multiset <span class="free">t'</span> <span class="main">=</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> siftDown <span class="main">(</span>set_val <span class="var">?t1</span> <span class="var">?v1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hs_remove_max_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="free">t'</span> <span class="main">+</span> <span class="main">{#</span>val <span class="var">?t1</span><span class="main">#}</span> <span class="main">=</span> multiset <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> siftDown_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set_val <span class="var">?t1</span> <span class="var">?v1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> removeLeaf_multiset<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> set_val_multiset<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span><span class="main">]</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="var">?t1</span> <span class="main">=</span> val <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>removeLeaf.induct<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> False
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t'</span> <span class="main">=</span> siftDown <span class="main">(</span>set_val <span class="var">?t1</span> <span class="var">?v1</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> hs_remove_max_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> fst_conv removeLeaf.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val <span class="var">?t1</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹val <span class="var">?t1</span> <span class="main">=</span> val <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiset <span class="free">t'</span> <span class="main">+</span> <span class="main">{#</span><span class="free">m</span><span class="main">#}</span> <span class="main">=</span> multiset <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹multiset <span class="free">t'</span> <span class="main">+</span> <span class="main">{#</span>val <span class="var">?t1</span><span class="main">#}</span> <span class="main">=</span> multiset <span class="free">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Difined functions satisfy conditions of locale {\em Heap} and thus represent 
       interpretation of this locale.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Heap <span class="quoted"><span class="quoted">"E"</span></span> <span class="quoted">hs_is_empty</span> <span class="quoted">hs_of_list</span> <span class="quoted">multiset</span> <span class="quoted">id</span> <span class="quoted">hs_remove_max</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiset <span class="skolem">t</span> <span class="main">=</span> multiset <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" is_heap <span class="main">(</span>id <span class="main">(</span>hs_of_list <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> hs_of_list_def
    <span class="keyword1"><span class="command">using</span></span> heapify_heap_is_heap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"of_list_tree <span class="skolem">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id <span class="skolem">t</span> <span class="main">=</span> E<span class="main">)</span> <span class="main">=</span> hs_is_empty <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">m</span> <span class="skolem">t'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">m</span> <span class="main">(</span>multiset <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> multiset <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hs_remove_max_multiset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">v'</span> <span class="skolem">t'</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>removeLeaf <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>removeLeaf <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="var">?t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> removeLeaf_heap_is_heap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>id <span class="skolem">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> E"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> hs_remove_max_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v_t1</span></span> <span class="skolem"><span class="skolem">l_t1</span></span> <span class="skolem"><span class="skolem">r_t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> T <span class="skolem">v_t1</span> <span class="skolem">l_t1</span> <span class="skolem">r_t1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tree.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">l_t1</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">r_t1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="var">?t1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Tree.exhaust 
         is_heap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Tree.exhaust 
          is_heap.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> is_heap.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_val <span class="var">?t1</span> <span class="var">?v1</span> <span class="main">=</span> T <span class="var">?v1</span> <span class="skolem">l_t1</span> <span class="skolem">r_t1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?t1</span> <span class="main">=</span> T <span class="skolem">v_t1</span> <span class="skolem">l_t1</span> <span class="skolem">r_t1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="var">?t1</span> <span class="var">?v1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="skolem">l_t1</span>›</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="skolem">r_t1</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> siftDown_heap_is_heap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l_t1</span></span> <span class="quoted"><span class="skolem">r_t1</span></span> <span class="quoted"><span class="quoted">"set_val <span class="var">?t1</span> <span class="var">?v1</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?v1</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> siftDown <span class="main">(</span>set_val <span class="var">?t1</span> <span class="var">?v1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>›</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hs_remove_max_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_heap <span class="main">(</span>siftDown <span class="main">(</span>set_val <span class="var">?t1</span> <span class="var">?v1</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">m</span> <span class="skolem">t'</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>removeLeaf <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hs_is_empty <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> hs_remove_max <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> val <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hs_remove_max_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?t1</span> <span class="main">=</span> E"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> prod.inject<span class="main">)</span>    
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> val <span class="main">(</span>id <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword2"><span class="keyword">end</span></span> 
</pre>
</div>