<div id="Grid_Point">
<div class="head">
<h1>Theory Grid_Point</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Grid Points ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Grid_Point
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Analysis/Multivariate_Analysis.html">HOL-Analysis.Multivariate_Analysis</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> grid_point <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> int<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lv</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ix</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">level</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">level</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> lv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Grid_Point-level_all_eq"><span class="command">lemma</span></span> level_all_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> lv <span class="free">p</span> <span class="bound">d</span> <span class="main">=</span> lv <span class="free">p'</span> <span class="bound">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p'</span> <span class="main">=</span> level <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> level_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">datatype</span></span> dir <span class="main">=</span> left <span class="main">|</span> right

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sgn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dir <span class="main">⇒</span> int"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sgn</span> left  <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sgn</span> right <span class="main">=</span>  <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"dir <span class="main">⇒</span> dir"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">inv</span> left <span class="main">=</span> right"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inv</span> right <span class="main">=</span> left"</span></span>

<span class="keyword1" id="Grid_Point-inv_inv"><span class="command">lemma</span></span> inv_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="main">=</span> <span class="free">dir</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Grid_Point-sgn_inv"><span class="command">lemma</span></span> sgn_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sgn <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> sgn <span class="free">dir</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">child</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> dir <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">child</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span> <span class="main">(</span>lv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">+</span> sgn <span class="free"><span class="bound"><span class="entity">dir</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Grid_Point-child_length"><span class="command">lemma</span></span> child_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> length <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_odd"><span class="command">lemma</span></span> child_odd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> odd <span class="main">(</span>ix <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Grid_Point-child_eq"><span class="command">lemma</span></span> child_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">=</span> <span class="free">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>

<span class="keyword1" id="Grid_Point-child_other"><span class="command">lemma</span></span> child_other<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="free">d'</span> <span class="main">⟹</span> child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">!</span> <span class="free">d'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="free">d'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def lv_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Grid_Point-child_invariant"><span class="command">lemma</span></span> child_invariant<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">!</span> <span class="free">d'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="free">d'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span> <span class="main">≠</span> <span class="free">d'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod.exhaust <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid_Point-child_single_level"><span class="command">lemma</span></span> child_single_level<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> lv <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">&gt;</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lv_def child_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_lv"><span class="command">lemma</span></span> child_lv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> lv <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_lv_other"><span class="command">lemma</span></span> child_lv_other<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">≠</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lv <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d'</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> child_other<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_ix_left"><span class="command">lemma</span></span> child_ix_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> ix <span class="main">(</span>child <span class="free">p</span> left <span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_ix_right"><span class="command">lemma</span></span> child_ix_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> ix <span class="main">(</span>child <span class="free">p</span> right <span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_ix"><span class="command">lemma</span></span> child_ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">⟹</span> ix <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> sgn <span class="free">dir</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-child_level"><span class="command">lemma</span></span> child_level<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> level <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">p</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">d'</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="keyword1">then</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> lv <span class="free">p</span> <span class="bound">d'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_lv_other child_lv level_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">d'</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="keyword1">then</span> lv <span class="free">p</span> <span class="free">d</span> <span class="keyword1">else</span> lv <span class="free">p</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_lv_other child_lv level_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum.If_cases<span class="main">[</span><span class="operator">OF</span> finite_atLeastLessThan<span class="main">]</span> inter
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid_Point-child_ex_neighbour"><span class="command">lemma</span></span> child_ex_neighbour<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">=</span> child <span class="bound">b'</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">=</span> child <span class="main">(</span><span class="free">b</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span>lv <span class="free">b</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">b</span> <span class="free">d</span> <span class="main">+</span> sgn <span class="free">dir</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def lv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid_Point-child_level_gt"><span class="command">lemma</span></span> child_level_gt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">&gt;=</span> level <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def<span class="main">)</span>

<span class="keyword1" id="Grid_Point-child_estimate_child"><span class="command">lemma</span></span> child_estimate_child<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i'_range<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">∧</span>
                   ix <span class="free">p</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
                  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?top</span> <span class="free">p</span> <span class="main">∧</span> <span class="var">?bottom</span> <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> is_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?top</span> <span class="free">p'</span> <span class="main">∧</span> <span class="var">?bottom</span> <span class="free">p'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> is_child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p'</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">p</span> <span class="free">d</span> <span class="main">&gt;=</span> <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> pow_l''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?top</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> is_child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p'</span> <span class="free">d</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def lv_def ix_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i'_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pow_l'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bottom</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pow_l'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i'_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def lv_def ix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid_Point-child_neighbour"><span class="command">lemma</span></span> child_neighbour<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"child <span class="free">p</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> child <span class="free">ps</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c_p</span> <span class="main">=</span> <span class="var">?c_ps</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="free">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> sgn <span class="free">dir</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?ps</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?c_ps</span> <span class="main">=</span> length <span class="var">?c_p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?c_p</span> <span class="main">=</span> <span class="var">?c_ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="var">?ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?ps</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that len_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?ps</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c_p</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?c_ps</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?c_p</span> <span class="main">=</span> <span class="var">?c_ps</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="skolem">i</span> <span class="main">=</span> ix <span class="free">ps</span> <span class="free">d</span> <span class="main">+</span> sgn <span class="free">dir</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="skolem">i</span> <span class="main">=</span> lv <span class="free">ps</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def
          nth_list_update_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span><span class="main"><span class="main">]</span></span>
          nth_list_update_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ps</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lv_def ix_def <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> child_other<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">dir</span></span><span class="main">]</span> child_other<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"inv <span class="free">dir</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">start</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> grid_point"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Grid_Point-start_lv"><span class="command">lemma</span></span> start_lv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">⟹</span> lv <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> start_def lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-start_ix"><span class="command">lemma</span></span> start_ix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">⟹</span> ix <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> start_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid_Point-start_length"><span class="command">lemma</span></span> start_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">=</span> <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid_Point-level_start_0"><span class="command">lemma</span></span> level_start_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> level_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Grid">
<div class="head">
<h1>Theory Grid</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Sparse Grids ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Grid
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Grid_Point.html">Grid_Point</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Vectors"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> vector <span class="main">=</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> real"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">null_vector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vector"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">null_vector</span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_vector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vector <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sum_vector</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="bound">p</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="bound">p</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Inductive enumeration of all grid points ›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">grid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat set <span class="main">⇒</span> grid_point set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">ds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
    Start<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="free">grid</span> <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="main">|</span> Child<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="free">grid</span> <span class="free">b</span> <span class="free">ds</span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">⟧</span> <span class="main">⟹</span> child <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">dir</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> <span class="free">grid</span> <span class="free">b</span> <span class="free">ds</span>"</span></span>

<span class="keyword1" id="Grid-grid_length"><span class="command">lemma</span></span> grid_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="free">ds</span> <span class="main">⟹</span> length <span class="free">p'</span> <span class="main">=</span> length <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> grid.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Grid-grid_union_dims"><span class="command">lemma</span></span> grid_union_dims<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ds</span> <span class="main">⊆</span> <span class="free">ds'</span> <span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> grid.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Grid-grid_transitive"><span class="command">lemma</span></span> grid_transitive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">;</span> <span class="free">b</span> <span class="main">∈</span> grid <span class="free">c</span> <span class="free">ds'</span> <span class="main">;</span> <span class="free">ds'</span> <span class="main">⊆</span> <span class="free">ds''</span> <span class="main">;</span> <span class="free">ds</span> <span class="main">⊆</span> <span class="free">ds''</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> grid <span class="free">c</span> <span class="free">ds''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> grid.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> grid_union_dims<span class="main">)</span>

<span class="keyword1" id="Grid-grid_child"><span class="command">lemma</span></span> grid_child<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span>›</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-grid_single_level"><span class="command">lemma</span></span> grid_single_level<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p'</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-grid_child_level"><span class="command">lemma</span></span> grid_child_level<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_lv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_grid assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> grid_single_level<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-child_out"><span class="command">lemma</span></span> child_out<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span> child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> child_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-grid_dim_remove"><span class="command">lemma</span></span> grid_dim_remove<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">(</span><span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inset eq
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p'</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">≥</span> length <span class="skolem">p'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> child_out<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> <span class="free">d</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="skolem">p'</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="main">(</span>child <span class="skolem">p'</span> <span class="skolem">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> child_single_level Child <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">=</span> <span class="free">d</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lv_def <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">d'</span> <span class="main">≥</span> length <span class="skolem">p'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span> <span class="main">⟹</span> <span class="skolem">p'</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p'</span> <span class="skolem">dir</span> <span class="skolem">d'</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">!</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_invariant <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> grid.Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-gridgen_dim_restrict"><span class="command">lemma</span></span> gridgen_dim_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≥</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inset eq
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p'</span> <span class="skolem">d</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> child_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-grid_dim_remove_outer"><span class="command">lemma</span></span> grid_dim_remove_outer<span class="main">:</span> <span class="quoted"><span class="quoted">"grid <span class="free">b</span> <span class="free">ds</span> <span class="main">=</span> grid <span class="free">b</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_union_dims<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"grid <span class="free">b</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">=</span> <span class="main">(</span><span class="free">ds</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"grid <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">ds</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> grid <span class="free">b</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">(</span><span class="free">ds</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">(</span><span class="free">ds</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≥</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gridgen_dim_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"grid <span class="free">b</span> <span class="free">ds</span> <span class="main">⊆</span> grid <span class="free">b</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_level"><span class="command">lemma</span></span> grid_level<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"level <span class="free">b</span> <span class="main">≤</span> level <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_length assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="skolem">i</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid_single_level * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> level_def * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_empty_ds"><span class="command">lemma</span></span> grid_empty_ds<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"grid <span class="free">b</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{</span> <span class="free">b</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> grid.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_Start"><span class="command">lemma</span></span> grid_Start<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> inset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">=</span> level <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inset eq
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> Child
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">≥</span> level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">≤</span> level <span class="main">(</span>child <span class="skolem">p</span> <span class="skolem">dir</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> child_level_gt<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">≤</span> level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">=</span> level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">b</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> Child<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Child<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="free">b</span> <span class="skolem">dir</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="free">b</span> <span class="skolem">dir</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">≠</span>  level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_level <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">=</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> <span class="skolem">dir</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Child <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">=</span> level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Child<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_estimate"><span class="command">lemma</span></span> grid_estimate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="free">b</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">b</span> <span class="free">d</span><span class="main">)</span> <span class="main">∧</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">(</span>ix <span class="free">b</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">b</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_grid
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> child_def lv_def ix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> child_estimate_child <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> grid_single_level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_odd"><span class="command">lemma</span></span> grid_odd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_grid <span class="keyword2"><span class="keyword">and</span></span> p_diff
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> child_odd <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> child_def <span class="keyword2"><span class="keyword">and</span></span> ix_def <span class="keyword2"><span class="keyword">and</span></span> lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_invariant"><span class="command">lemma</span></span> grid_invariant<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_grid
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">≠</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> child_def <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_part"><span class="command">lemma</span></span> grid_part<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> level<span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="free">p'</span> <span class="free">d</span> <span class="main">≥</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> right<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="free">p'</span> <span class="free">d</span> <span class="main">≤</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?right</span> <span class="free">p</span> <span class="free">p'</span> <span class="free">d</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="free">p'</span> <span class="free">d</span> <span class="main">≥</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="free">p</span> <span class="free">p'</span> <span class="free">d</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p'_valid left right level <span class="keyword2"><span class="keyword">and</span></span> p_valid
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p'</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?child</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p'</span> <span class="skolem">dir</span> <span class="skolem">d'</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">=</span> lv <span class="var">?child</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="var">?child</span> <span class="free">d</span> <span class="main">=</span> lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_lv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> lv<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">=</span> Suc <span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="free">p</span> <span class="skolem">p'</span> <span class="free">d</span> <span class="main">∧</span> <span class="var">?right</span> <span class="free">p</span> <span class="skolem">p'</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> left
      <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> left_r<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">≤</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> left <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> right_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ix <span class="skolem">p'</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> left_r <span class="keyword2"><span class="keyword">and</span></span> right_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right
      <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> left_r<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">≤</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> right <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def ix_def lv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>ix <span class="skolem">p'</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> right_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ix <span class="skolem">p'</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> left_r <span class="keyword2"><span class="keyword">and</span></span> right_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> lv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Child <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="free">p</span> <span class="var">?child</span> <span class="free">d</span> <span class="main">∧</span> <span class="var">?right</span> <span class="free">p</span> <span class="var">?child</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> ix <span class="var">?child</span> <span class="free">d</span> <span class="main">∧</span> ix <span class="var">?child</span> <span class="free">d</span> <span class="main">≤</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">≠</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">p</span> <span class="free">d</span> <span class="main">=</span> lv <span class="var">?child</span> <span class="free">d</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">=</span> lv <span class="var">?child</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">=</span> lv <span class="skolem">p'</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="skolem">p'</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> Child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid_single_level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_odd <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> odd_child<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="var">?child</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_odd <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> ix <span class="var">?child</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> ix <span class="var">?child</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> odd_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> ix <span class="var">?child</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> ix <span class="var">?child</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> odd_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> odd <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">=</span> ix <span class="var">?child</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> d_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="var">?child</span><span class="main">)</span> <span class="main">!</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_eqI ix_def lv_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="var">?child</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="skolem">d''</span> <span class="main">=</span> <span class="var">?child</span> <span class="main">!</span> <span class="skolem">d''</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d''</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d''</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d''</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="skolem">d''</span> <span class="main">=</span> <span class="var">?child</span> <span class="main">!</span> <span class="skolem">d''</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">d''</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> d_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d''</span> <span class="main">∉</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d''</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="skolem">d''</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="skolem">d''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> grid_invariant<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d''</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d''</span> <span class="main">∉</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> grid_invariant<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?child</span> <span class="main">!</span> <span class="skolem">d''</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d''</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d''</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?child</span> <span class="main">!</span> <span class="skolem">d''</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_invariant <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">≠</span> <span class="skolem">d''</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="var">?child</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?child</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Start
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_single_level <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">=</span> level <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="skolem">d'</span> <span class="main">=</span> lv <span class="free">p</span> <span class="skolem">d'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">b</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∉</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="skolem">d'</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> grid_invariant<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> level_all_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_Start <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_disjunct"><span class="command">lemma</span></span> grid_disjunct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grid <span class="main">(</span>child <span class="free">p</span> left <span class="free">d</span><span class="main">)</span> <span class="free">ds</span> <span class="main">∩</span> grid <span class="main">(</span>child <span class="free">p</span> right <span class="free">d</span><span class="main">)</span> <span class="free">ds</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"grid <span class="var">?l</span> <span class="free">ds</span> <span class="main">∩</span> grid <span class="var">?r</span> <span class="free">ds</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="free">ds</span> <span class="main">∩</span> grid <span class="var">?r</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ix <span class="skolem">x</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="var">?l</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="var">?l</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ix <span class="skolem">x</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">(</span>ix <span class="var">?r</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="var">?r</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grid_estimate <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_lv <span class="keyword2"><span class="keyword">and</span></span> child_ix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-grid_level_eq"><span class="command">lemma</span></span> grid_level_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">d</span> <span class="main">∈</span> <span class="free">ds</span><span class="main">.</span> lv <span class="free">p</span> <span class="bound">d</span> <span class="main">=</span> lv <span class="free">b</span> <span class="bound">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">=</span> level <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> level_all_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="skolem">i</span> <span class="main">=</span> lv <span class="free">p</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> lv_def ix_def grid_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_partition"><span class="command">lemma</span></span> grid_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∪</span> grid <span class="main">(</span>child <span class="free">p</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">∪</span> grid <span class="main">(</span>child <span class="free">p</span> right <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∪</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">∪</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">∉</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nr_r</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ix <span class="skolem">x</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nr_l</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">&gt;</span> ix <span class="skolem">x</span> <span class="free">d</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> ix_r_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="var">?r</span> <span class="free">d</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_ix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lv_r_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="var">?r</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> ix_l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="var">?l</span> <span class="free">d</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_ix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lv_l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="var">?l</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="skolem">x</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_single_level <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">≠</span> lv <span class="skolem">x</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">≠</span> lv <span class="skolem">x</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">x</span> <span class="main">=</span> level <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid_level_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_Start <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">x</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="var">?r</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="skolem">x</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_lv <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> r_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?nr_r</span> <span class="var">?r</span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?nr_l</span> <span class="var">?r</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> grid_part<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">⟹</span> <span class="var">?nr_l</span> <span class="var">?r</span> <span class="main">∨</span> <span class="var">?nr_r</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_range<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nr_l</span> <span class="var">?r</span> <span class="main">∨</span> <span class="var">?nr_r</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> gt0<span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">x</span> <span class="free">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> ix_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="var">?r</span> <span class="free">d</span> <span class="main">=</span> ix <span class="var">?l</span> <span class="free">d</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lv_lr<span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="var">?r</span> <span class="free">d</span> <span class="main">=</span> lv <span class="var">?l</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> right1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">x</span> <span class="main">::</span> int<span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_ix <span class="keyword2"><span class="keyword">and</span></span> child_lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span> <span class="main">=</span> Suc <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> lv_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">y</span> <span class="main">::</span> int<span class="main">.</span> <span class="bound">y</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ix <span class="skolem">x</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> grid_estimate <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ix <span class="var">?r</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="var">?r</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">x</span> <span class="free">d</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ix_r_eq <span class="keyword2"><span class="keyword">and</span></span> lv_r_eq lv_shift<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nr_l</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?nr_l</span> <span class="var">?r</span> <span class="main">∨</span> <span class="var">?nr_r</span> <span class="var">?r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> r_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ix <span class="var">?l</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="var">?l</span> <span class="free">d</span><span class="main">)</span> <span class="main">&gt;</span> ix <span class="skolem">x</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ix_shift lv_lr <span class="keyword1"><span class="command">using</span></span> right1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ix <span class="var">?l</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="var">?l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ix_l_eq lv_l_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lv_shift<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">…</span> <span class="main">&lt;</span> ix <span class="skolem">x</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> grid_estimate <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> l_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ix <span class="var">?l</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">x</span> <span class="free">d</span> <span class="main">-</span> lv <span class="var">?l</span> <span class="free">d</span><span class="main">)</span> <span class="main">&lt;</span> ix <span class="skolem">x</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> l_bound r_bound <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹lv <span class="var">?r</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="skolem">x</span> <span class="free">d</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lv_lr
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_part<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?l</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> grid_child<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_change_dim"><span class="command">lemma</span></span> grid_change_dim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="free">X</span><span class="main">]</span> <span class="main">∈</span> grid <span class="main">(</span><span class="free">b</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> grid
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="skolem">d'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>child <span class="skolem">p</span> <span class="skolem">dir</span> <span class="skolem">d'</span><span class="main">)</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="free">X</span><span class="main">]</span> <span class="main">=</span> child <span class="main">(</span><span class="skolem">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="free">X</span><span class="main">]</span><span class="main">)</span> <span class="skolem">dir</span> <span class="skolem">d'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> child_def <span class="keyword2"><span class="keyword">and</span></span> ix_def <span class="keyword2"><span class="keyword">and</span></span> lv_def
      <span class="keyword1"><span class="command">unfolding</span></span> list_update_swap<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">≠</span> <span class="skolem">d'</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> nth_list_update_neq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">≠</span> <span class="skolem">d'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> child_def <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">=</span> <span class="skolem">d'</span>›</span></span> list_update_overwrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_change_dim_child"><span class="command">lemma</span></span> grid_change_dim_child<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> grid_change_dim<span class="main">[</span><span class="operator">OF</span> grid<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> child_def lv_def ix_def grid_invariant<span class="main">[</span><span class="operator">OF</span> True <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> grid<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> child_def <span class="keyword1"><span class="command">using</span></span> list_update_beyond assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_split"><span class="command">lemma</span></span> grid_split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="bound">x</span> <span class="free">ds'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> grid
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p</span> <span class="skolem">d</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="free">ds'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Child <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">x</span> <span class="skolem">dir</span> <span class="skolem">d</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> <span class="free">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> <span class="skolem">dir</span> <span class="skolem">d</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">x</span> <span class="skolem">dir</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">ds'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>›</span></span> False <span class="keyword2"><span class="keyword">and</span></span> grid_change_dim_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_union_eq"><span class="command">lemma</span></span> grid_union_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span><span class="main">.</span> grid <span class="bound">p</span> <span class="free">ds'</span><span class="main">)</span> <span class="main">=</span> grid <span class="free">b</span> <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> grid_split <span class="keyword2"><span class="keyword">and</span></span> grid_transitive<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds''<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ds'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ds</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ Un_upper2 Un_upper1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1" id="Grid-grid_onedim_split"><span class="command">lemma</span></span> grid_onedim_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"grid <span class="free">b</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">∪</span> grid <span class="main">(</span>child <span class="free">b</span> left <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> grid <span class="main">(</span>child <span class="free">b</span> right <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">∪</span> <span class="var">?l</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?r</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∪</span> <span class="var">?l</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?r</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">.</span> grid <span class="bound">p</span> <span class="free">ds</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">.</span> grid <span class="bound">p</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grid_union_eq <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> grid <span class="bound">p</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">.</span> grid <span class="bound">p</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> grid_partition<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> grid_union_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_child_without_parent"><span class="command">lemma</span></span> grid_child_without_parent<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="var">?c</span> <span class="free">ds</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="var">?c</span> <span class="main">≤</span> level <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> grid_level<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="free">b</span> <span class="main">&lt;</span> level <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_level <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_disjunct'"><span class="command">lemma</span></span> grid_disjunct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="free">ds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> grid <span class="free">p'</span> <span class="free">ds'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">∉</span> grid <span class="free">p'</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> grid <span class="free">p'</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> length <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> length <span class="free">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p'</span> <span class="main">=</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">d</span></span> <span class="main">&lt;</span> length <span class="free">p'</span><span class="main">.</span> <span class="free">p'</span> <span class="main">!</span> <span class="bound">d</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="bound">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> dl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">p'</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> dl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="free">ds'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> dl' False <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> grid <span class="free">p'</span> <span class="free">ds'</span>›</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> dl False <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="free">ds'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_split1"><span class="command">lemma</span></span> grid_split1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="bound">x</span> <span class="free">ds'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_split<span class="main">[</span><span class="operator">OF</span> grid<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="bound">x</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">y</span> <span class="free">ds'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">y</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> grid_disjunct'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">y</span> <span class="free">ds'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Grid Restricted to a Level ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lgrid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat set <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lgrid</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> grid <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">.</span> level <span class="bound">p</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Grid-lgridI"><span class="command">lemma</span></span> lgridI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">;</span> level <span class="free">p</span> <span class="main">&lt;</span> <span class="free">lm</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="free">ds</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Grid-lgridE"><span class="command">lemma</span></span> lgridE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="free">ds</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">;</span> level <span class="free">p</span> <span class="main">&lt;</span> <span class="free">lm</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-lgridI_child"><span class="command">lemma</span></span> lgridI_child<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="free">ds</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> grid_child<span class="main">)</span>

<span class="keyword1" id="Grid-lgrid_empty"><span class="command">lemma</span></span> lgrid_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lgrid <span class="free">p</span> <span class="free">ds</span> <span class="main">(</span>level <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equals0I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="free">p</span> <span class="free">ds</span> <span class="main">(</span>level <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p'</span> <span class="main">&lt;</span> level <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">≤</span> level <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-lgrid_empty'"><span class="command">lemma</span></span> lgrid_empty'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">lm</span> <span class="main">≤</span> level <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lgrid <span class="free">p</span> <span class="free">ds</span> <span class="free">lm</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equals0I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="free">p</span> <span class="free">ds</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p'</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">≤</span> level <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">lm</span> <span class="main">≤</span> level <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_not_child"><span class="command">lemma</span></span> grid_not_child<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> grid <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">&lt;</span> level <span class="main">(</span>child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> grid_level<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="var">?thesis</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> not_not<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Unbounded Sparse Grid ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sparsegrid'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> grid_point set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sparsegrid'</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">=</span> grid <span class="main">(</span>start <span class="free"><span class="bound"><span class="entity">dm</span></span></span><span class="main">)</span> <span class="main">{</span> <span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Grid-grid_subset_alldim"><span class="command">lemma</span></span> grid_subset_alldim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">dm</span> <span class="main">≡</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="main">{</span><span class="free">dm</span><span class="main">..}</span> <span class="main">∪</span> <span class="free">ds</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gridgen_dim_restrict<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="main">{</span><span class="free">dm</span><span class="main">..}</span>"</span></span><span class="main">]</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> grid_union_dims<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-sparsegrid'_length"><span class="command">lemma</span></span> sparsegrid'_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">⟹</span> length <span class="free">b</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-sparsegrid'I"><span class="command">lemma</span></span> sparsegrid'I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sparsegrid'_length<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> b
       grid_transitive<span class="main">[</span><span class="operator">OF</span> grid_subset_alldim<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds''<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-sparsegrid'_start"><span class="command">lemma</span></span> sparsegrid'_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def
  <span class="keyword1"><span class="command">using</span></span> grid_subset_alldim<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Sparse Grid ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sparsegrid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sparsegrid</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="main">=</span> lgrid <span class="main">(</span>start <span class="free"><span class="bound"><span class="entity">dm</span></span></span><span class="main">)</span> <span class="main">{</span> <span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span>"</span></span>

<span class="keyword1" id="Grid-sparsegrid_length"><span class="command">lemma</span></span> sparsegrid_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> length <span class="free">p</span> <span class="main">=</span> <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparsegrid_def<span class="main">)</span>

<span class="keyword1" id="Grid-sparsegrid_subset"><span class="command">lemma</span></span> sparsegrid_subset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def sparsegrid'_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-sparsegridI"><span class="command">lemma</span></span> sparsegridI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-sparsegrid_start"><span class="command">lemma</span></span> sparsegrid_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> lgrid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="free">ds</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sparsegrid'_start<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Grid-sparsegridE"><span class="command">lemma</span></span> sparsegridE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Compute Sparse Grid Points ›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gridgen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat set <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gridgen</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gridgen</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">sub</span> <span class="main">=</span> <span class="main">λ</span> <span class="bound">d</span><span class="main">.</span> <span class="free">gridgen</span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> left <span class="bound">d</span><span class="main">)</span> <span class="main">{</span> <span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="bound">d</span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span>
                 <span class="free">gridgen</span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> right <span class="bound">d</span><span class="main">)</span> <span class="main">{</span> <span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="bound">d</span> <span class="main">}</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
      <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> concat <span class="main">(</span>map <span class="bound">sub</span> <span class="main">[</span> <span class="bound">d</span> <span class="main">←</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Grid-gridgen_lgrid_eq"><span class="command">lemma</span></span> gridgen_lgrid_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>gridgen <span class="free">p</span> <span class="free">ds</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> lgrid <span class="free">p</span> <span class="free">ds</span> <span class="main">(</span>level <span class="free">p</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ds</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subg</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>gridgen <span class="main">(</span>child <span class="skolem">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span> <span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span> <span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span>  <span class="free">d</span> <span class="main">}</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sub</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lgrid <span class="main">(</span>child <span class="skolem">p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span> <span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span> <span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span>  <span class="free">d</span> <span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?union</span> <span class="free">F</span> <span class="free">dm</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">}</span><span class="main">.</span> <span class="free">F</span> left <span class="bound">d</span> <span class="main">∪</span> <span class="free">F</span> right <span class="bound">d</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span> <span class="main">⟹</span> <span class="var">?subg</span> <span class="bound">dir</span> <span class="bound">d</span> <span class="main">=</span> <span class="var">?sub</span> <span class="bound">dir</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">using</span></span> child_level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dm</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">≤</span> length <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?union</span> <span class="var">?sub</span> <span class="skolem">dm</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span><span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">dm</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">dm</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">≤</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="skolem">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> right <span class="skolem">dm</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> p_lgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">p</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span><span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">∈</span> <span class="skolem">ds</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">dm</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> ds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="skolem">dm</span><span class="main">}</span> <span class="main">=</span> <span class="var">?ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> ds_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">dm</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">dm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?union</span> <span class="var">?sub</span> <span class="main">(</span>Suc <span class="skolem">dm</span><span class="main">)</span> <span class="main">=</span> <span class="var">?union</span> <span class="var">?sub</span> <span class="skolem">dm</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?sub</span> left <span class="skolem">dm</span> <span class="main">∪</span> <span class="var">?sub</span> right <span class="skolem">dm</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ds_eq' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span><span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?sub</span> left <span class="skolem">dm</span> <span class="main">∪</span> <span class="var">?sub</span> right <span class="skolem">dm</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">≤</span> length <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> p_lgrid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p'</span></span> <span class="main">∈</span> grid <span class="skolem">p</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span><span class="main">&lt;</span><span class="skolem">dm</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>grid <span class="var">?l</span> <span class="var">?ds</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>grid <span class="var">?r</span> <span class="var">?ds</span><span class="main">)</span><span class="main">.</span>
          level <span class="bound">p'</span> <span class="main">&lt;</span> level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">dm</span><span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def ds_eq' <span class="keyword1"><span class="command">unfolding</span></span> grid_onedim_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">dm</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span> <span class="main">∨</span> <span class="bound">d</span> <span class="main">=</span> <span class="skolem">dm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> ds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">dm</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">∉</span> <span class="skolem">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ds_eq Suc.hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">≤</span> length <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?union</span> <span class="var">?sub</span> <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span><span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> union_lgrid_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?union</span> <span class="var">?sub</span> <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="skolem">ds</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">using</span></span> grid_dim_remove_outer <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>gridgen <span class="skolem">p</span> <span class="skolem">ds</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?union</span> <span class="var">?subg</span> <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gridgen.simps <span class="keyword2"><span class="keyword">and</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>gridgen <span class="skolem">p</span> <span class="skolem">ds</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?union</span> <span class="var">?sub</span> <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="skolem">ds</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> Suc <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> union_lgrid_eq <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-gridgen_distinct"><span class="command">lemma</span></span> gridgen_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>gridgen <span class="free">p</span> <span class="free">ds</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ds</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">d</span> <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">p</span><span class="main">]</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="free">d</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gridgen <span class="main">(</span>child <span class="skolem">p</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span> <span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span> <span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">}</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?right</span> <span class="free">d</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gridgen <span class="main">(</span>child <span class="skolem">p</span> right <span class="free">d</span><span class="main">)</span> <span class="main">{</span> <span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span> <span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">}</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sub</span> <span class="free">d</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?left</span> <span class="free">d</span> <span class="main">@</span> <span class="var">?right</span> <span class="free">d</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>concat <span class="main">(</span>map <span class="var">?sub</span> <span class="var">?ds</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?sub</span> <span class="main">(</span>set <span class="var">?ds</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">d'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> set <span class="var">?ds</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sub</span> <span class="skolem">d</span> <span class="main">=</span> <span class="var">?sub</span> <span class="skolem">d'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> in_d<span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="skolem">d</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>›</span></span> Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gridgen_lgrid_eq lgrid_def grid_Start<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> in_d'<span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="skolem">d'</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>›</span></span> Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gridgen_lgrid_eq lgrid_def grid_Start<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">&lt;</span> lv <span class="skolem">p'</span> <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> grid_child_level
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gridgen_lgrid_eq lgrid_def grid_child_level<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> level_less <span class="main">=</span> this

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="skolem">d'</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> in_d' <span class="quoted"><span class="quoted">‹<span class="var">?sub</span> <span class="skolem">d</span> <span class="main">=</span> <span class="var">?sub</span> <span class="skolem">d'</span>›</span></span> level_less<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">&lt;</span> lv <span class="main">(</span>child <span class="skolem">p</span> left <span class="skolem">d'</span><span class="main">)</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def
          <span class="keyword1"><span class="command">using</span></span> child_invariant<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">left</span> <span class="quoted"><span class="skolem">d'</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="skolem">d'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="skolem">d'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> in_d <span class="quoted"><span class="quoted">‹<span class="var">?sub</span> <span class="skolem">d</span> <span class="main">=</span> <span class="var">?sub</span> <span class="skolem">d'</span>›</span></span> level_less<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">∈</span> set <span class="var">?ds</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">d'</span> <span class="main">&lt;</span> lv <span class="main">(</span>child <span class="skolem">p</span> left <span class="skolem">d</span><span class="main">)</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def
          <span class="keyword1"><span class="command">using</span></span> child_invariant<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">left</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="skolem">d'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_concat<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="var">?sub</span> <span class="var">?ds</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinct_map <span class="keyword1"><span class="command">using</span></span> inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="var">?sub</span> <span class="var">?ds</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="skolem">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="var">?sub</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *
        <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
          gridgen_lgrid_eq lgrid_def <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="var">?left</span> <span class="skolem">d</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="var">?right</span> <span class="skolem">d</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span> <span class="skolem">zs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="var">?sub</span> <span class="var">?ds</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="var">?sub</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="var">?sub</span> <span class="var">?ds</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="var">?sub</span> <span class="skolem">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> set <span class="var">?ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">≠</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys zs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">∩</span> set <span class="skolem">zs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ys zs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">&lt;</span> lv <span class="skolem">p'</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">d'</span> <span class="main">&lt;</span> lv <span class="skolem">p'</span> <span class="skolem">d'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> grid_child_level <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> set <span class="var">?ds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">∈</span> set <span class="var">?ds</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gridgen_lgrid_eq lgrid_def grid_child_level<span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d'</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> grid_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d'</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> right <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> grid_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d'</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d'</span> <span class="main">≤</span> <span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> child_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d'</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> gridgen_lgrid_eq lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lv <span class="skolem">p</span> <span class="skolem">d'</span> <span class="main">&lt;</span> lv <span class="skolem">p'</span> <span class="skolem">d'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">≠</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?sub</span> <span class="skolem">d'</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> grid_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> right <span class="skolem">d'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="skolem">d'</span><span class="main">}</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> grid_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="skolem">d'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="skolem">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≤</span> <span class="skolem">d'</span><span class="main">}</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> child_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">d'</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> gridgen_lgrid_eq lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lv <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">&lt;</span> lv <span class="skolem">p'</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_replicate_const<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set <span class="main">(</span>concat <span class="main">(</span>map <span class="var">?sub</span> <span class="var">?ds</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gridgen_lgrid_eq lgrid_def grid_not_child<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gridgen.simps Let_def distinct.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-lgrid_finite"><span class="command">lemma</span></span> lgrid_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>lgrid <span class="free">b</span> <span class="free">ds</span> <span class="free">lm</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"level <span class="free">b</span> <span class="main">≤</span> <span class="free">lm</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">from</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> le_iff_add True<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lm</span> <span class="main">=</span> level <span class="free">b</span> <span class="main">+</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> l gridgen_lgrid_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> level <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">lm</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> grid_level<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> level <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lgrid <span class="free">b</span> <span class="free">ds</span> <span class="free">lm</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-lgrid_sum"><span class="command">lemma</span></span> lgrid_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="free">b</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="free">F</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>child <span class="free">b</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="free">F</span> <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>child <span class="free">b</span> right <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="free">F</span> <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> <span class="free">F</span> <span class="free">b</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> <span class="var">?grid</span> <span class="free">b</span><span class="main">.</span> <span class="free">F</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p</span> <span class="main">∈</span> <span class="var">?grid</span> <span class="var">?l</span> <span class="main">.</span> <span class="free">F</span> <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?sum</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">F</span> <span class="free">b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> <span class="free">b</span> <span class="main">∉</span> <span class="var">?grid</span> <span class="main">(</span>child <span class="free">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grid_child_without_parent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> b_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?l</span> <span class="main">∪</span> <span class="var">?grid</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?grid</span> <span class="var">?l</span> <span class="main">∩</span> <span class="var">?grid</span> <span class="var">?r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">using</span></span> grid_disjunct <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> lgrid_finite lgrid_finite <span class="keyword2"><span class="keyword">and</span></span> this
  <span class="keyword1"><span class="command">have</span></span> child_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">(</span><span class="main">(</span><span class="var">?grid</span> <span class="var">?l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?sum</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?l</span><span class="main">)</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?grid</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def grid_partition<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">(</span><span class="var">?grid</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="free">b</span> <span class="main">+</span> <span class="var">?sum</span> <span class="main">(</span><span class="main">(</span><span class="var">?grid</span> <span class="var">?l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?grid</span> <span class="var">?r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_distinct <span class="keyword2"><span class="keyword">and</span></span> lgrid_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> child_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Base Points ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> grid_point <span class="main">⇒</span> grid_point"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">base</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> grid <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Grid-baseE"><span class="command">lemma</span></span> baseE<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p_grid<span class="main">[</span><span class="operator">unfolded</span> sparsegrid'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="bound">x</span> <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> grid_split1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> grid_union_dims<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-baseI"><span class="command">lemma</span></span> baseI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_xgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">x</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> p_xgrid x_grid<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds''<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="bound">x</span> <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grid_split1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ds</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_grid p_xgrid <span class="keyword1"><span class="command">unfolding</span></span> base_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-base_empty"><span class="command">lemma</span></span> base_empty<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{}</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> grid_empty_ds <span class="keyword2"><span class="keyword">and</span></span> p_grid <span class="keyword2"><span class="keyword">and</span></span> grid_split1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> base_def sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-base_start_eq"><span class="command">lemma</span></span> base_start_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"start <span class="free">dm</span> <span class="main">=</span> base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p_spg
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"start <span class="free">dm</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> baseI<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-base_in_grid"><span class="command">lemma</span></span> base_in_grid<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="var">?ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="main">0</span><span class="main">..&lt;</span> <span class="free">dm</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="var">?ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grid_union_dims<span class="main">[</span><span class="operator">OF</span> _ baseE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> p_grid<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ds</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ds</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> grid_dim_remove_outer<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?ds</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-base_grid"><span class="command">lemma</span></span> base_grid<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span> <span class="free">ds</span> <span class="main">⊆</span> sparsegrid' <span class="free">dm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> xgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> xgrid base_in_grid<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p_grid<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds''<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">∪</span> <span class="free">ds</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def
    <span class="keyword1"><span class="command">using</span></span> grid_dim_remove_outer<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">∪</span> <span class="free">ds</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ds_eq <span class="keyword1"><span class="command">unfolding</span></span> Un_ac<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-base_length"><span class="command">lemma</span></span> base_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">dm</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> baseE<span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-base_in"><span class="command">lemma</span></span> base_in<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> start <span class="free">dm</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> this ds<span class="main">]</span> baseE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-base_out"><span class="command">lemma</span></span> base_out<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="free">p</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_length<span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span><span class="main">]</span> baseE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-base_base"><span class="command">lemma</span></span> base_base<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def
    <span class="keyword1"><span class="command">using</span></span> grid_union_dims<span class="main">[</span><span class="operator">OF</span> Diff_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">ds'</span>"</span></span><span class="main"><span class="main">]</span></span> baseE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> p_grid<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> base_length<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> base_length<span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">p</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that base_length<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">p</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">from</span></span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>›</span></span> p_grid<span class="main">]</span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> this b_spg<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>›</span></span> p_grid<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> b_spg<span class="main">]</span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds'</span>›</span></span> p_grid<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>›</span></span> p_grid<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> b_spg<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds'</span>›</span></span> p_grid<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_base_out"><span class="command">lemma</span></span> grid_base_out<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">!</span> <span class="free">d</span> <span class="main">=</span> base <span class="free">ds</span> <span class="free">b</span> <span class="main">!</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_grid_inj_on"><span class="command">lemma</span></span> grid_grid_inj_on<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on snd <span class="main">(</span><span class="main">⋃</span><span class="bound">p'</span><span class="main">∈</span>grid <span class="free">b</span> <span class="free">ds</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">p''</span><span class="main">∈</span>grid <span class="bound">p'</span> <span class="free">ds'</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p'</span><span class="main">∈</span>grid <span class="free">b</span> <span class="free">ds</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">p''</span><span class="main">∈</span>grid <span class="bound">p'</span> <span class="free">ds'</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="free">ds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p'</span><span class="main">∈</span>grid <span class="free">b</span> <span class="free">ds</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">p''</span><span class="main">∈</span>grid <span class="bound">p'</span> <span class="free">ds'</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">y</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="free">ds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≠</span> fst <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> grid_disjunct'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">y</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="free">ds'</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">y</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="free">ds'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_eqI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_level_d"><span class="command">lemma</span></span> grid_level_d<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">&gt;</span> lv <span class="free">b</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p_grid<span class="main">[</span><span class="operator">unfolded</span> grid_partition<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> grid_child_level <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_base_base"><span class="command">lemma</span></span> grid_base_base<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="free">b</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_union_dims<span class="main">[</span><span class="operator">OF</span> _ baseE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ds</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_base_union"><span class="command">lemma</span></span> grid_base_union<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> b_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span> <span class="free">ds'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ds_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span> <span class="main">=</span> <span class="free">ds'</span> <span class="main">∪</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> p_grid <span class="keyword1"><span class="command">have</span></span> p_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> grid_base_base <span class="keyword1"><span class="command">have</span></span> base_b'<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="main">(</span>base <span class="free">ds'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> base <span class="free">ds'</span> <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> <span class="var">?p</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bb_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> grid.Start <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">dm</span> <span class="main">=</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> bp_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg<span class="main">]</span> grid.Start <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?b</span> <span class="main">=</span> length <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_length<span class="main">[</span><span class="operator">OF</span> bp_spg<span class="main">]</span> base_length<span class="main">[</span><span class="operator">OF</span> bb_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that base_length<span class="main">[</span><span class="operator">OF</span> bb_spg<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">dm</span> <span class="main">=</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">x</span><span class="main">.</span> base <span class="free">ds</span> <span class="bound">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">⟹</span> base <span class="free">ds'</span> <span class="main">(</span>base <span class="free">ds</span> <span class="bound">x</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xb_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="free">ds</span> <span class="skolem">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="main">(</span>base <span class="free">ds</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">from</span></span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> this xb_spg<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> False xb_spg<span class="main">]</span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> this x_spg<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> bp_spg p_spg<span class="main">]</span> this<span class="main">[</span><span class="operator">OF</span> bb_spg b_spg<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> p_grid<span class="main">]</span>
          base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds'</span>›</span></span> bp_spg<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> p_spg<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">ds'</span>›</span></span> bb_spg<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> base_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p_spg<span class="main"><span class="main">]</span></span> base_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> b_spg<span class="main"><span class="main">]</span></span> Un_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> x_grid this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ds_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_base_dim_add"><span class="command">lemma</span></span> grid_base_dim_add<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds'</span> <span class="main">⊆</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds'</span> <span class="free">b</span><span class="main">)</span> <span class="free">ds'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">b</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> p_grid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="free">ds</span> <span class="free">p</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> baseE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_base_union<span class="main">[</span><span class="operator">OF</span> b_spg p_grid this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1" id="Grid-grid_replace_dim"><span class="command">lemma</span></span> grid_replace_dim<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b'</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">]</span> <span class="main">∈</span> grid <span class="main">(</span><span class="free">b</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="free">b'</span> <span class="main">!</span> <span class="free">d</span><span class="main">]</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> grid <span class="var">?b</span> <span class="free">ds</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> p'_grid <span class="keyword2"><span class="keyword">and</span></span> p_grid
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Child <span class="skolem">p''</span> <span class="skolem">d'</span> <span class="skolem">dir</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> p''_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="skolem">p''</span> <span class="main">!</span> <span class="free">d</span><span class="main">]</span> <span class="main">∈</span> grid <span class="var">?b</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">p''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_grid assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> grid.Child<span class="main">[</span><span class="operator">OF</span> p''_grid <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">∈</span> <span class="free">ds</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> child_def ix_def lv_def list_update_overwrite <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">=</span> <span class="free">d</span>›</span></span> nth_list_update_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">p''</span>›</span></span><span class="main">]</span> nth_list_update_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> child_def nth_list_update_neq<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> Child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> grid_change_dim<span class="main">)</span>
<span class="keyword1" id="Grid-grid_shift_base"><span class="command">lemma</span></span> grid_shift_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ds_dj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">∩</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"base <span class="free">ds'</span> <span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">(</span><span class="free">ds</span> <span class="main">∪</span> <span class="free">ds'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> grid_split<span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_xgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="free">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_union_dims<span class="main">[</span><span class="operator">OF</span> _ this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> x_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> b_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>base <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_length<span class="main">[</span><span class="operator">OF</span> b_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">≤</span> <span class="free">dm</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">d'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> b_len <span class="keyword1"><span class="command">have</span></span> d'_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="main">(</span><span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> <span class="free">ds'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∉</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> <span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ds_dj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">d'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">d'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d'</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">d'</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">d'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="skolem">d'</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">d'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> d'_b <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">∉</span> <span class="free">ds</span>›</span></span> x_grid<span class="main">]</span> base_in<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">d'</span> <span class="main">∈</span> <span class="free">ds'</span> <span class="main">∪</span> <span class="free">ds</span>›</span></span> b_spg<span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d'</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">!</span> <span class="skolem">d'</span> <span class="main">=</span> start <span class="free">dm</span> <span class="main">!</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> grid_dim_remove<span class="main">[</span><span class="operator">OF</span> x_g this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> Suc <span class="skolem">d'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span> <span class="main">∨</span> <span class="bound">d</span> <span class="main">=</span> <span class="skolem">d'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="skolem">d'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> x_spg<span class="main">[</span><span class="operator">unfolded</span> sparsegrid'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds'</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">d</span></span> <span class="main">∈</span> <span class="free">ds'</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="free">ds'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> baseI<span class="main">[</span><span class="operator">OF</span> this p_xgrid<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> x_grid
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Lift Operation over all Grid Points ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> vector <span class="main">⇒</span> vector<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="main">-</span> level <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>gridgen <span class="main">(</span>start <span class="free"><span class="bound"><span class="entity">dm</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">{</span> <span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Grid-lift"><span class="command">lemma</span></span> lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Fintro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span> <span class="bound">b</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">b</span> <span class="main">∈</span> lgrid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="free">lm</span> <span class="main">;</span>
                          <span class="bound">l</span> <span class="main">+</span> level <span class="bound">b</span> <span class="main">=</span> <span class="free">lm</span> <span class="main">;</span> <span class="bound">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟧</span>
             <span class="main">⟹</span> <span class="free">F</span> <span class="free">d</span> <span class="bound">l</span> <span class="bound">b</span> <span class="bound">α</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="bound">p</span>
                               <span class="keyword1">then</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="bound">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="bound">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">p'</span><span class="main">)</span>
                               <span class="keyword1">else</span> <span class="bound">α</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lift <span class="free">F</span> <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">α</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="free">S</span> <span class="main">(</span><span class="free">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="free">p</span> <span class="bound">p'</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lift</span> <span class="main">=</span> <span class="var">?S</span> <span class="free">p</span> <span class="free">α</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gridgen</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gridgen <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">d</span> <span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="free">p</span><span class="main">)</span> <span class="free">p</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bs</span> <span class="skolem">β</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">bs</span> <span class="main">⊆</span> set <span class="var">?gridgen</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldr <span class="var">?f</span> <span class="skolem">bs</span> <span class="skolem">β</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span> <span class="main">∈</span> set <span class="skolem">bs</span> <span class="keyword1">then</span> <span class="var">?S</span> <span class="free">p</span> <span class="skolem">β</span> <span class="keyword1">else</span> <span class="skolem">β</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> lgrid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="free">lm</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="skolem">b</span><span class="main">)</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> b_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lgrid_def gridgen_lgrid_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> F <span class="main">=</span> Fintro<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main">]</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="skolem">b</span><span class="main">#</span><span class="skolem">bs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">b</span><span class="main">#</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> base_in_set <span class="main">=</span> this

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p'</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> b_grid<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span>
              baseI<span class="main">[</span><span class="operator">OF</span> b_grid <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∉</span> set <span class="skolem">bs</span>›</span></span>
              Cons.prems Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldr <span class="var">?f</span> <span class="skolem">bs</span> <span class="skolem">β</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">β</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> F base_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> base_in_set <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> Cons.prems
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldr <span class="var">?f</span> <span class="skolem">bs</span> <span class="skolem">β</span> <span class="skolem">p</span> <span class="main">=</span> <span class="var">?S</span> <span class="skolem">p</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> F base_in_set False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> False Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> Cons.prems
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldr <span class="var">?f</span> <span class="skolem">bs</span> <span class="skolem">β</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">β</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False F <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span> <span class="main">∈</span> set <span class="var">?gridgen</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> sparsegrid_subset<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> baseE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> grid_level<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> baseE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> sparsegrid_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gridgen_lgrid_eq sparsegrid'_def lgrid_def sparsegrid_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lift_def
    <span class="keyword1"><span class="command">using</span></span> gridgen_distinct <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Parent Points ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parents</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> grid_point <span class="main">⇒</span> grid_point set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">parents</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> grid <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> grid <span class="bound">x</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">}</span> <span class="main">}</span>"</span></span>

<span class="keyword1" id="Grid-parents_split"><span class="command">lemma</span></span> parents_split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{</span> <span class="free">b</span> <span class="main">}</span> <span class="main">∪</span> parents <span class="free">d</span> <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?chd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?chid</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="free">b</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> x_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> grid <span class="var">?chd</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">∪</span> grid <span class="var">?chid</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_onedim_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> grid_empty_ds
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> parents <span class="free">d</span> <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">d'</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">.</span> <span class="bound">d'</span> <span class="main">&lt;</span> length <span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> grid_dim_remove_outer<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> empty
        <span class="keyword1"><span class="command">using</span></span> grid_empty_ds <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="var">?chid</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span> <span class="main">∉</span> grid <span class="var">?chid</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="var">?chid</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> grid <span class="var">?chd</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="var">?chd</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword2"><span class="keyword">and</span></span> x_split
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="var">?chd</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?chd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?chid</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="free">b</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> parents <span class="free">d</span> <span class="var">?chd</span> <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="var">?chd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">using</span></span> grid_child<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> p_grid <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_child<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-parents_no_parent"><span class="command">lemma</span></span> parents_no_parent<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> parents <span class="free">d</span> <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∉</span> parents <span class="main">_</span> <span class="var">?ch</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="var">?ch</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> grid <span class="var">?ch</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_level<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="free">b</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> level <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> child_level<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-parents_subset_lgrid"><span class="command">lemma</span></span> parents_subset_lgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span> <span class="main">⊆</span> lgrid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span>level <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="skolem">x</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">x</span> <span class="main">≤</span> level <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">x</span> <span class="main">&lt;</span> level <span class="free">p</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span>level <span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-parents_finite"><span class="command">lemma</span></span> parents_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> parents_subset_lgrid lgrid_finite<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Grid-parent_sum"><span class="command">lemma</span></span> parent_sum<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">p</span><span class="main">.</span> <span class="free">F</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parents_split<span class="main">[</span><span class="operator">OF</span> p_grid<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> parents_no_parent<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dir<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">dir</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> parents_finite
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Grid-parents_single"><span class="command">lemma</span></span> parents_single<span class="main">:</span> <span class="quoted"><span class="quoted">"parents <span class="free">d</span> <span class="free">b</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span> <span class="free">b</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"parents <span class="free">d</span> <span class="free">b</span> <span class="free">b</span> <span class="main">⊆</span> lgrid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span>level <span class="free">b</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parents_subset_lgrid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gridgen_lgrid_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> gridgen.simps Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"parents <span class="free">d</span> <span class="free">b</span> <span class="free">b</span> <span class="main">⊆</span> <span class="main">{</span> <span class="free">b</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="free">b</span> <span class="main">}</span> <span class="main">⊆</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_single_dimensional_specification"><span class="command">lemma</span></span> grid_single_dimensional_specification<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">+</span> <span class="free">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="free">b</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">(</span>ix <span class="free">b</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> ix <span class="skolem">b</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> lv <span class="skolem">b</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ix_def lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> ix <span class="skolem">b</span> <span class="free">d</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"even <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> ix <span class="skolem">b</span> <span class="free">d</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> left <span class="free">d</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="var">?b</span> <span class="free">d</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="var">?b</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">l'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ix <span class="var">?b</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> child_ix_left<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems * child_lv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> grid <span class="var">?b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.hyps<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> grid_child<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted">left</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="skolem">b</span> <span class="free">d</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> right <span class="free">d</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="var">?b</span> <span class="free">d</span> <span class="main">+</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="var">?b</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">l'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ix <span class="var">?b</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> child_ix_right<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems * child_lv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">∈</span> grid <span class="var">?b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.hyps<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> grid_child<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted">right</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-grid_multi_dimensional_specification"><span class="command">lemma</span></span> grid_multi_dimensional_specification<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">dm</span> <span class="main">≤</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">⟹</span>
    odd <span class="main">(</span>ix <span class="free">p</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span>
    lv <span class="free">b</span> <span class="bound">d</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="bound">d</span> <span class="main">∧</span>
    ix <span class="free">p</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="free">b</span> <span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="bound">d</span> <span class="main">-</span> lv <span class="free">b</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span>
    ix <span class="free">p</span> <span class="bound">d</span> <span class="main">&gt;</span> <span class="main">(</span>ix <span class="free">b</span> <span class="bound">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="bound">d</span> <span class="main">-</span> lv <span class="free">b</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">⟹</span> <span class="var">?bounded</span> <span class="free">p</span> <span class="bound">d</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">d</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">dm</span> <span class="main">≤</span> <span class="bound">d</span> <span class="main">;</span> <span class="bound">d</span> <span class="main">&lt;</span> length <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">!</span> <span class="bound">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="bound">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">dm</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">dm</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">≤</span> length <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">[</span><span class="skolem">dm</span> <span class="main">:=</span> <span class="free">b</span> <span class="main">!</span> <span class="skolem">dm</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">≤</span> length <span class="free">b</span>›</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?p</span> <span class="main">=</span> length <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">p</span> <span class="main">=</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">dm</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> Suc <span class="skolem">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">≠</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_list_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">≠</span> <span class="skolem">d</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?bounded</span> <span class="var">?p</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> lv_def ix_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">dm</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">p</span> <span class="main">=</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">dm</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">≤</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">dm</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Suc.hyps<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="skolem">dm</span> <span class="main">≤</span> lv <span class="skolem">p</span> <span class="skolem">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lessI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="var">?p</span> <span class="skolem">dm</span> <span class="main">=</span> lv <span class="free">b</span> <span class="skolem">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lv_def <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="var">?p</span> <span class="skolem">dm</span> <span class="main">=</span> ix <span class="free">b</span> <span class="skolem">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ix_def <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">[</span><span class="skolem">dm</span> <span class="main">:=</span> <span class="main">(</span>lv <span class="skolem">p</span> <span class="skolem">dm</span><span class="main">,</span> ix <span class="skolem">p</span> <span class="skolem">dm</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lv_def ix_def <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dm</span> <span class="main">&lt;</span> length <span class="var">?p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="skolem">dm</span> <span class="main">+</span> <span class="main">(</span>lv <span class="skolem">p</span> <span class="skolem">dm</span> <span class="main">-</span> lv <span class="free">b</span> <span class="skolem">dm</span><span class="main">)</span> <span class="main">=</span> lv <span class="skolem">p</span> <span class="skolem">dm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">dm</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">b</span> <span class="skolem">dm</span> <span class="main">≤</span> lv <span class="skolem">p</span> <span class="skolem">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> grid_single_dimensional_specification<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">dm</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ix <span class="skolem">p</span> <span class="skolem">dm</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> l'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">dm</span> <span class="main">-</span> lv <span class="free">b</span> <span class="skolem">dm</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?p</span> <span class="main">{</span><span class="skolem">dm</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lessI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> this *<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Grid-sparsegrid"><span class="command">lemma</span></span> sparsegrid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span>
    length <span class="bound">p</span> <span class="main">=</span> <span class="free">dm</span> <span class="main">∧</span> level <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">lm</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">d</span></span> <span class="main">&lt;</span> <span class="free">dm</span><span class="main">.</span> odd <span class="main">(</span>ix <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> ix <span class="bound">p</span> <span class="bound">d</span> <span class="main">∧</span> ix <span class="bound">p</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="bound">p</span> <span class="bound">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?set</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsetI subsetI<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="skolem">p</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> start <span class="free">dm</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> ix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> grid_odd<span class="main">[</span><span class="operator">OF</span> _ this **<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>ix <span class="skolem">p</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> ix <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">∧</span> ix <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> grid_estimate<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span>›</span></span> **<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ix_def lv_def start_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?set</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?set</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> grid_multi_dimensional_specification<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">dm</span></span> <span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Triangular_Function">
<div class="head">
<h1>Theory Triangular_Function</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Hat Functions ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Triangular_Function
<span class="keyword2"><span class="keyword">imports</span></span>
 <span class="quoted">"<a href="../../HOL/HOL-Analysis/Equivalence_Lebesgue_Henstock_Integration.html">HOL-Analysis.Equivalence_Lebesgue_Henstock_Integration</a>"</span>
 <a href="Grid.html">Grid</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Triangular_Function-continuous_on_max"><span class="command">lemma</span></span> continuous_on_max<span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder_topology"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">S</span> <span class="free">f</span> <span class="main">⟹</span> continuous_on <span class="free">S</span> <span class="free">g</span> <span class="main">⟹</span> continuous_on <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> max <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> continuous_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tendsto_max<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> int<span class="main">)</span> <span class="main">⇒</span> real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> max <span class="main">0</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">¦</span> <span class="bound">x</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="bound">i</span> <span class="main">¦</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> int<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">d</span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> φ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">!</span> <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">l2_φ</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2_φ</span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> φ <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="bound">x</span> <span class="main">*</span> φ <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="bound">x</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">l2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> Φ <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">x</span> <span class="main">*</span> Φ <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">x</span> <span class="main">∂</span><span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">d</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Triangular_Function-measurable_φ"><span class="command">lemma</span></span> measurable_φ<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"φ <span class="free">p</span> <span class="main">∈</span> borel_measurable borel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ_def<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-φ_nonneg"><span class="command">lemma</span></span> φ_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> φ <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-φ_zero_iff"><span class="command">lemma</span></span> φ_zero_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> <span class="main">{</span>real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;..&lt;</span> real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_max<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-φ_zero"><span class="command">lemma</span></span> φ_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">{</span>real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;..&lt;</span> real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> φ_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Triangular_Function-φ_eq_0"><span class="command">lemma</span></span> φ_eq_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span>Suc <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> x
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> φ_zero <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> divide_le_eq_1_pos<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_int_add power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> φ_zero <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-ix_lt"><span class="command">lemma</span></span> ix_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">⟹</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def
  <span class="keyword1"><span class="command">using</span></span> grid_estimate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">dm</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Triangular_Function-ix_gt"><span class="command">lemma</span></span> ix_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> ix <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def
  <span class="keyword1"><span class="command">using</span></span> grid_estimate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="quoted">"start <span class="free">dm</span>"</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">dm</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Triangular_Function-Φ_eq_0"><span class="command">lemma</span></span> Φ_eq_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&lt;</span>length <span class="free">p</span><span class="main">.</span> <span class="free">x</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="bound">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Φ_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> d <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> p<span class="main">[</span><span class="operator">THEN</span> ix_lt<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> p<span class="main">[</span><span class="operator">THEN</span> ix_gt<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> p
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="main">{..&lt;</span>length <span class="free">p</span><span class="main">}</span><span class="main">.</span> φ <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">!</span><span class="skolem">d</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">d</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> φ_eq_0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparsegrid_length ix_def lv_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Triangular_Function-φ_left_support'"><span class="command">lemma</span></span> φ_left_support'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> real_of_int <span class="free">i</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_max<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-φ_left_support"><span class="command">lemma</span></span> φ_left_support<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span> <span class="main">..</span> <span class="main">0</span><span class="main">::</span>real<span class="main">}</span> <span class="main">⟹</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> real_of_int <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_max<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-φ_right_support'"><span class="command">lemma</span></span> φ_right_support'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="free">i</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> real_of_int <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">x</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> real_of_int <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_max<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-φ_right_support"><span class="command">lemma</span></span> φ_right_support<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">1</span><span class="main">::</span>real<span class="main">}</span> <span class="main">⟹</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> real <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_max<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-integrable_φ"><span class="command">lemma</span></span> integrable_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span>φ <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span>real_of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> real_of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> φ <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_integrable_compact<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_zero_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-integrable_φ2"><span class="command">lemma</span></span> integrable_φ2<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> φ <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> φ <span class="free">q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prod.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> prod.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair_Pair <span class="skolem">l</span> <span class="skolem">i</span> <span class="skolem">l'</span> <span class="skolem">i'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable lborel
      <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span>real_of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> real_of_int <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>φ <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> φ <span class="main">(</span><span class="skolem">l'</span><span class="main">,</span> <span class="skolem">i'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> borel_integrable_compact<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Pair_Pair
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integrable_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_zero_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_φI_DERIV"><span class="command">lemma</span></span> l2_φI_DERIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span> <span class="main">(</span>real_of_int <span class="free">i'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">}</span> <span class="main">⟹</span>
    <span class="keyword1">DERIV</span> <span class="free">Φ_n</span> <span class="bound">x</span> <span class="main">:&gt;</span> <span class="main">(</span>φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?a</span><span class="main">..</span><span class="var">?b</span><span class="main">}</span> <span class="main">⟹</span> <span class="keyword1">DERIV</span> <span class="main">_</span> <span class="main">_</span> <span class="main">:&gt;</span> <span class="var">?P</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span> real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">..</span> <span class="main">(</span>real_of_int <span class="free">i'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">}</span> <span class="main">⟹</span>
    <span class="keyword1">DERIV</span> <span class="free">Φ_p</span> <span class="bound">x</span> <span class="main">:&gt;</span> <span class="main">(</span>φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?b</span><span class="main">..</span><span class="var">?c</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Φ_n</span> <span class="var">?b</span> <span class="main">-</span> <span class="free">Φ_n</span> <span class="var">?a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">Φ_p</span> <span class="var">?c</span> <span class="main">-</span> <span class="free">Φ_p</span> <span class="var">?b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_bochner_integral lborel
      <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="main">{</span><span class="var">?a</span><span class="main">..</span><span class="var">?b</span><span class="main">}</span> <span class="bound">x</span> <span class="main">+</span> <span class="var">?P</span> <span class="bound">x</span> <span class="main">*</span> indicator <span class="main">{</span><span class="var">?b</span><span class="main">..</span><span class="var">?c</span><span class="main">}</span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free">Φ_n</span> <span class="var">?b</span> <span class="main">-</span> <span class="free">Φ_n</span> <span class="var">?a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">Φ_p</span> <span class="var">?c</span> <span class="main">-</span> <span class="free">Φ_p</span> <span class="var">?b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_bochner_integral_add has_bochner_integral_FTC_Icc_nonneg n p<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_nonneg <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_bochner_integral lborel<span class="var">?P</span> <span class="main">(</span><span class="main">(</span><span class="free">Φ_n</span> <span class="var">?b</span> <span class="main">-</span> <span class="free">Φ_n</span> <span class="var">?a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">Φ_p</span> <span class="var">?c</span> <span class="main">-</span> <span class="free">Φ_p</span> <span class="var">?b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_bochner_integral_discrete_difference<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="var"><span class="var"><span class="var">?b</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power_add <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> φ_zero integral_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_bochner_integral_iff l2_φ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_eq"><span class="command">lemma</span></span> l2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">=</span> length <span class="free">b</span> <span class="main">⟹</span> l2 <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">d</span><span class="main">&lt;</span>length <span class="free">a</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="free">a</span><span class="main">!</span><span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">!</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> l2_def l2_φ_def Φ_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> product_sigma_finite.product_integral_prod<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"product_sigma_finite <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> lborel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> integrable_φ2<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-l2_when_disjoint"><span class="command">lemma</span></span> l2_when_disjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">==</span> <span class="free">l'</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">d</span> <span class="main">&lt;</span> <span class="free">i'</span> <span class="main">∨</span> <span class="free">i'</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="free">d</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?right</span> <span class="main">∨</span> <span class="var">?left</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sup</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">i</span><span class="main">.</span> <span class="main">{</span>real_of_int <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;..&lt;</span> real_of_int <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="bound">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">l</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span> <span class="main">=</span> real_of_int <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span><span class="main">::</span>int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">d</span><span class="main">::</span>int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?right</span> <span class="main">∨</span> <span class="var">?left</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="free">l'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> empty_support<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sup</span> <span class="free">l</span> <span class="free">i</span> <span class="main">∩</span> <span class="var">?sup</span> <span class="free">l'</span> <span class="free">i'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def max_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> l' power_add * of_int_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_int_diff of_int_add of_int_mult of_int_power<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">*</span> φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ_zero_iff mult_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_φ_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mult_eq_0_iff vector_space_over_itself.scale_eq_0_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_commutative"><span class="command">lemma</span></span> l2_commutative<span class="main">:</span> <span class="quoted"><span class="quoted">"l2_φ <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> l2_φ <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l2_φ_def mult.commute<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-l2_when_same"><span class="command">lemma</span></span> l2_when_same<span class="main">:</span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> l2_φI_DERIV<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?in</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ip</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?φ</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?φ</span> <span class="bound">x</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in</span> <span class="main">/</span> <span class="var">?l</span> <span class="main">..</span> real_of_int <span class="free">i</span> <span class="main">/</span> <span class="var">?l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> φ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?l</span> <span class="main">*</span> <span class="skolem">x</span>  <span class="main">-</span> <span class="var">?in</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_left_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DERIV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?l</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?in</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">*</span> <span class="var">?in</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">:&gt;</span> <span class="var">?φ2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span> φ_eq<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="free">i</span> <span class="main">/</span> <span class="var">?l</span> <span class="main">..</span> <span class="var">?ip</span> <span class="main">/</span> <span class="var">?l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> φ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?ip</span> <span class="main">-</span> <span class="var">?l</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_right_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DERIV</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?l</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?ip</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">*</span> <span class="var">?ip</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">:&gt;</span> <span class="var">?φ2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span> φ_eq<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_eq_if<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span> power_eq_if<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Triangular_Function-l2_when_left_child"><span class="command">lemma</span></span> l2_when_left_child<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i'_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i'_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> l2_φI_DERIV<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?in'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ip'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">i'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?φ2</span> <span class="free">x</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?φ'</span> <span class="free">x</span> <span class="main">*</span> <span class="var">?φ</span> <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ_n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ_n</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?l'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?in'</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?in'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?l'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ_p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ_p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?ip'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?l'</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?l'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">*</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?ip'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>

  <span class="keyword1"><span class="command">have</span></span> level_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="free">l'</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">l</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> power_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>real"</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?in'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i'_bot int_less_real_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">/</span> <span class="var">?l</span> <span class="main">≤</span> <span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> level_diff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">/</span> <span class="var">?l</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ip'</span> <span class="main">≤</span> real_of_int <span class="free">i</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i'_top int_less_real_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> ip'_le_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">≤</span> real_of_int <span class="free">i</span> <span class="main">/</span> <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> level_diff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> real_of_int <span class="free">i</span> <span class="main">/</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?l</span> <span class="main">*</span> <span class="skolem">x</span>  <span class="main">-</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_left_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> φ_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> φ'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?l'</span> <span class="main">*</span> <span class="skolem">x</span>  <span class="main">-</span> <span class="var">?in'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_left_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DERIV</span> <span class="skolem">Φ_n</span> <span class="skolem">x</span> <span class="main">:&gt;</span> <span class="var">?φ2</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_eq<span class="main">[</span><span class="operator">OF</span> x'<span class="main">]</span> φ'_eq Φ_n_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> φ'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?ip'</span> <span class="main">-</span> <span class="var">?l'</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_right_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DERIV</span> <span class="skolem">Φ_p</span> <span class="skolem">x</span> <span class="main">:&gt;</span> <span class="var">?φ2</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_eq<span class="main">[</span><span class="operator">OF</span> x'<span class="main">]</span> φ'_eq Φ_p_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_eq_if<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span> power_eq_if<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> power_diff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>real"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l'</span>›</span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>

<span class="keyword1" id="Triangular_Function-l2_when_right_child"><span class="command">lemma</span></span> l2_when_right_child<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i'_bot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i'_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">i'</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">+</span> real_of_int <span class="free">i</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> l2_φI_DERIV<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?in'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ip'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">i'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"φ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?φ'</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?φ</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ_n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ_n</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?in'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?l'</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?l'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">*</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?in'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ_p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ_p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="var">?l'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?ip'</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="var">?ip'</span> <span class="main">*</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?i</span> <span class="main">*</span> <span class="var">?l'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>

  <span class="keyword1"><span class="command">have</span></span> level_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="free">l'</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="free">l</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> power_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>real"</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">l'</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?in'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i'_bot int_less_real_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">/</span> <span class="var">?l</span> <span class="main">≤</span> <span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> level_diff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">i</span> <span class="main">/</span> <span class="var">?l</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ip'</span> <span class="main">≤</span> <span class="var">?i</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free">l'</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i'_top int_less_real_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> ip'_le_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">≤</span> <span class="var">?i</span> <span class="main">/</span> <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> level_diff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="var">?i</span> <span class="main">/</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?i</span> <span class="main">-</span> <span class="var">?l</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_right_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> φ_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> φ'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?l'</span> <span class="main">*</span> <span class="skolem">x</span>  <span class="main">-</span> <span class="var">?in'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_left_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DERIV</span> <span class="skolem">Φ_n</span> <span class="skolem">x</span> <span class="main">:&gt;</span> <span class="var">?φ2</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_n_def φ_eq<span class="main">[</span><span class="operator">OF</span> x'<span class="main">]</span> φ'_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real_of_int <span class="free">i'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> φ'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?φ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?ip'</span> <span class="main">-</span> <span class="var">?l'</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ_right_support' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?in'</span> <span class="main">/</span> <span class="var">?l'</span> <span class="main">..</span> <span class="var">?ip'</span> <span class="main">/</span> <span class="var">?l'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DERIV</span> <span class="skolem">Φ_p</span> <span class="skolem">x</span> <span class="main">:&gt;</span> <span class="var">?φ2</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_eq<span class="main">[</span><span class="operator">OF</span> x'<span class="main">]</span> φ'_eq Φ_p_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power_eq_if<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span> power_eq_if<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> power_diff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">::</span>real"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">&lt;</span> <span class="free">l'</span>›</span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>

<span class="keyword1" id="Triangular_Function-level_shift"><span class="command">lemma</span></span> level_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lc</span> <span class="main">&gt;</span> <span class="free">l</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">lc</span> <span class="main">-</span> Suc <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">lc</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_diff<span class="main">)</span>

<span class="keyword1" id="Triangular_Function-l2_child"><span class="command">lemma</span></span> l2_child<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">b</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="var">?child</span> <span class="free">ds</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> real_of_int <span class="main">(</span>sgn <span class="free">dir</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real_of_int <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">b</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="main">(</span>ix <span class="free">b</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
                                 <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="var">?child</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid
    <span class="keyword1"><span class="command">using</span></span> grid_single_level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid
    <span class="keyword1"><span class="command">using</span></span> child_lv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i_c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ix <span class="var">?child</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?l_c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lv <span class="var">?child</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i_p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ix <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?l_p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i_b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ix <span class="free">b</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?l_b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lv <span class="free">b</span> <span class="free">d</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>Suc <span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>Suc <span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span> <span class="main">=</span> Suc <span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lv <span class="var">?child</span> <span class="free">d</span> <span class="main">≤</span> lv <span class="free">p</span> <span class="free">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="free">p</span> <span class="free">d</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> child_def lv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> level<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_grid
  <span class="keyword1"><span class="command">have</span></span> range_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i_p</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?i_c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       range_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i_p</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?i_c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> grid_estimate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> left
    <span class="keyword1"><span class="command">with</span></span> child_ix_left<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?i_b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?i_c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?i_b</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?i_c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i_p</span> <span class="main">&gt;</span> <span class="main">(</span><span class="var">?i_b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?i_p</span> <span class="main">&lt;</span> <span class="var">?i_b</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> range_left <span class="keyword2"><span class="keyword">and</span></span> range_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l_b</span> <span class="main">&lt;</span> <span class="var">?l_p</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="var">?l_p</span><span class="main">,</span> <span class="var">?i_p</span><span class="main">)</span> <span class="main">(</span><span class="var">?l_b</span><span class="main">,</span> <span class="var">?i_b</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real_of_int <span class="var">?i_p</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="var">?i_b</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> l2_when_left_child<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> left <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ix_def lv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> right
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i_c</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="var">?i_b</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_ix_right <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i_b</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?i_c</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?i_b</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?i_c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i_p</span> <span class="main">&gt;</span> <span class="var">?i_b</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="var">?i_p</span> <span class="main">&lt;</span> <span class="main">(</span><span class="var">?i_b</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> range_left <span class="keyword2"><span class="keyword">and</span></span> range_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l_b</span> <span class="main">&lt;</span> <span class="var">?l_p</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="var">?l_p</span><span class="main">,</span> <span class="var">?i_p</span><span class="main">)</span> <span class="main">(</span><span class="var">?l_b</span><span class="main">,</span> <span class="var">?i_b</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">1</span> <span class="main">-</span> real_of_int <span class="var">?i_p</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">-</span> <span class="var">?l_b</span><span class="main">)</span> <span class="main">+</span> real_of_int <span class="var">?i_b</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="var">?l_p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> l2_when_right_child<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> right <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ix_def lv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_same"><span class="command">lemma</span></span> l2_same<span class="main">:</span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">p</span><span class="main">!</span><span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">!</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">/</span><span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">p</span><span class="main">!</span><span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">!</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> l2_φ <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lv_def ix_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l2_when_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_disjoint"><span class="command">lemma</span></span> l2_disjoint<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∉</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p'</span> <span class="free">d</span> <span class="main">≥</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"ix <span class="free">p'</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">∨</span> ix <span class="free">p'</span> <span class="free">d</span> <span class="main">&lt;</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p'</span> <span class="free">d</span> <span class="main">≤</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ix <span class="free">p'</span> <span class="free">d</span> <span class="main">≥</span> <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> grid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">p'</span> <span class="free">d</span> <span class="main">≥</span> lv <span class="free">p</span> <span class="free">d</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_part<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p'</span> <span class="main">∉</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> l2_φ <span class="main">(</span>lv <span class="free">p'</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">p'</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ix_def lv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹lv <span class="free">p'</span> <span class="free">d</span> <span class="main">≥</span> lv <span class="free">p</span> <span class="free">d</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> l2_when_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_down2"><span class="command">lemma</span></span> l2_down2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pc</span> <span class="free">pd</span> <span class="free">p</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">pd</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pc_in_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">pd</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pd_is_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pd</span> <span class="main">=</span> child <span class="free">p</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">pd</span> <span class="main">=</span> <span class="var">?pd</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">pc</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">pd</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span> l2_φ <span class="main">(</span><span class="free">pc</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pd_is_child <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">pd</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">∈</span> grid <span class="var">?pd</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pd_is_child <span class="keyword2"><span class="keyword">and</span></span> grid_child <span class="keyword2"><span class="keyword">and</span></span> pc_in_grid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="free">pc</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_child_level <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">pd</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> pd_is_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>sgn <span class="free">dir</span><span class="main">)</span> <span class="main">*</span> real_of_int <span class="main">(</span>sgn <span class="free">dir</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">pd</span>›</span></span> pc_in_grid<span class="main">]</span>
              l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">pc</span> <span class="main">∈</span> grid <span class="var">?pd</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> child_lv <span class="keyword2"><span class="keyword">and</span></span> child_ix <span class="keyword2"><span class="keyword">and</span></span> pd_is_child <span class="keyword2"><span class="keyword">and</span></span> level_shift
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> diff_divide_distrib add_divide_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Triangular_Function-l2_zigzag"><span class="command">lemma</span></span> l2_zigzag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> child <span class="free">p_p</span> <span class="free">dir</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p'_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">p</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ps_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="free">p</span> <span class="main">(</span>inv <span class="free">dir</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> child <span class="free">ps</span> <span class="free">dir</span> <span class="free">d</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c_p</span> <span class="main">=</span> <span class="var">?c_ps</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p_p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">+</span> l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="var">?c_p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="var">?c_ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ps_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">=</span> length <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ps_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p_p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_child <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> ps_intro <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="free">p</span><span class="main">[</span><span class="free">d</span> <span class="main">:=</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span><span class="main">,</span> ix <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> sgn <span class="free">dir</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> child_neighbour<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">ps</span> <span class="free">d</span> <span class="main">=</span> lv <span class="free">p</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>ix <span class="free">ps</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> real_of_int <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="main">(</span>sgn <span class="free">dir</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lv_def <span class="keyword2"><span class="keyword">and</span></span> ix_def <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">p</span> <span class="main">=</span> length <span class="free">ps</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">ps</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p'_grid ps_intro <span class="quoted"><span class="quoted">‹length <span class="free">p</span> <span class="main">=</span> length <span class="free">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p'_grid <span class="keyword2"><span class="keyword">and</span></span> grid_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> p_p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="free">p_p</span> <span class="free">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="free">p'</span> <span class="free">d</span> <span class="main">&gt;</span> lv <span class="free">p_p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_child_level <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p_p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>sgn <span class="free">dir</span><span class="main">)</span> <span class="main">*</span> real_of_int <span class="main">(</span>sgn <span class="free">dir</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span>›</span></span> p'_grid<span class="main">]</span> l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">ps</span>›</span></span> *<span class="main">]</span>
              l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p_p</span>›</span></span> p_p_grid<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> child_lv <span class="keyword2"><span class="keyword">and</span></span> child_ix <span class="keyword2"><span class="keyword">and</span></span> p_child level_shift
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_divide_distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span> diff_divide_distrib<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="UpDown_Scheme">
<div class="head">
<h1>Theory UpDown_Scheme</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ UpDown Scheme ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> UpDown_Scheme
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Grid.html">Grid</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">down'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">down'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">0</span>       <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>l</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>r</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">down'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>l</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>r</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">f<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>l</sub></span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>r</sub></span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">α</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>l</sub></span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>r</sub></span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">α</span> <span class="main">=</span> <span class="free">down'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> left <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>l</sub></span></span></span> <span class="bound">f<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">α</span><span class="main">;</span>
      <span class="bound">α</span> <span class="main">=</span> <span class="free">down'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> right <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="bound">f<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>r</sub></span></span></span> <span class="bound">α</span>
    <span class="keyword1">in</span> <span class="bound">α</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">down</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">down</span> <span class="main">=</span> lift <span class="main">(</span><span class="main">λ</span> <span class="bound">d</span> <span class="bound">l</span> <span class="bound">p</span><span class="main">.</span> down' <span class="bound">d</span> <span class="bound">l</span> <span class="bound">p</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">up'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> vector <span class="main">⇒</span> <span class="main">(</span>real <span class="main">*</span> real<span class="main">)</span> <span class="main">*</span> vector"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">up'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>       <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">up'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">f<span class="hidden">⇩</span><sub>l</sub></span><span class="main">,</span> <span class="bound">f<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>l</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">=</span> <span class="free">up'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> left <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">f<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>r</sub></span><span class="main">,</span> <span class="bound">f<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span> <span class="main">=</span> <span class="free">up'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> right <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="bound">α</span><span class="main">;</span>
      <span class="bound">result</span> <span class="main">=</span> <span class="main">(</span><span class="bound">f<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>l</sub></span> <span class="main">+</span> <span class="bound">f<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>r</sub></span> <span class="main">+</span> <span class="main">(</span><span class="bound">α</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">f<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">+</span> <span class="bound">result</span><span class="main">,</span> <span class="bound">f<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">+</span> <span class="bound">result</span><span class="main">)</span><span class="main">,</span> <span class="bound">α</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="bound">f<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>l</sub></span> <span class="main">+</span> <span class="bound">f<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">up</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">up</span> <span class="main">=</span> lift <span class="main">(</span><span class="main">λ</span> <span class="bound">d</span> <span class="bound">lm</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">.</span> snd <span class="main">(</span>up' <span class="bound">d</span> <span class="bound">lm</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">updown'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updown'</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">updown'</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span>
    <span class="main">(</span>sum_vector <span class="main">(</span><span class="free">updown'</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>up <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>down <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="free">updown'</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updown</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> vector <span class="main">⇒</span> vector"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updown</span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">=</span> updown' <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">lm</span></span></span> <span class="free"><span class="bound"><span class="entity">dm</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Up">
<div class="head">
<h1>Theory Up</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Up Part ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Up
<span class="keyword2"><span class="keyword">imports</span></span> <a href="UpDown_Scheme.html">UpDown_Scheme</a> <a href="Triangular_Function.html">Triangular_Function</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Up-up'_inplace"><span class="command">lemma</span></span> up'_inplace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∉</span> grid <span class="free">p</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>up' <span class="free">d</span> <span class="free">l</span> <span class="free">p</span> <span class="free">α</span><span class="main">)</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">α</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p'_in
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">α</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ch</span> <span class="free">dir</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> <span class="free">dir</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?up</span> <span class="free">dir</span> <span class="skolem">α</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"up' <span class="free">d</span> <span class="skolem">l</span> <span class="main">(</span><span class="var">?ch</span> <span class="free">dir</span><span class="main">)</span> <span class="skolem">α</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?upl</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?up</span> left <span class="skolem">α</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> contrapos_nn<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p'</span> <span class="main">∉</span> grid <span class="skolem">p</span> <span class="free">ds</span>›</span></span> grid_child<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">∈</span> <span class="free">ds</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∉</span> grid <span class="main">(</span><span class="var">?ch</span> left<span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∉</span> grid <span class="main">(</span><span class="var">?ch</span> right<span class="main">)</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid.Start Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> left<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">α</span></span><span class="main">]</span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> right<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?upl</span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?up</span> left <span class="skolem">α</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?up</span> right <span class="var">?upl</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Up-up'_fl_fr"><span class="command">lemma</span></span> up'_fl_fr<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="free">p</span> <span class="main">;</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>child <span class="free">p_r</span> right <span class="free">d</span><span class="main">)</span> <span class="main">;</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>child <span class="free">p_l</span> left <span class="free">d</span><span class="main">)</span> <span class="main">⟧</span>
       <span class="main">⟹</span> fst <span class="main">(</span>up' <span class="free">d</span> <span class="free">lm</span> <span class="free">p</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="free">lm</span> <span class="main">+</span> level <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p_r</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">,</span>
               <span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="free">lm</span> <span class="main">+</span> level <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p_l</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">lm</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">p_l</span></span> <span class="quoted"><span class="free">p_r</span></span> <span class="quoted"><span class="free">α</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">lm</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> child_ex_neighbour
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pc_r</span></span> <span class="skolem"><span class="skolem">pc_l</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> pc_r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> right <span class="free">d</span> <span class="main">=</span> child <span class="skolem">pc_r</span> <span class="main">(</span>inv right<span class="main">)</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pc_l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="free">d</span> <span class="main">=</span> child <span class="skolem">pc_l</span> <span class="main">(</span>inv left<span class="main">)</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="skolem">dir</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">dir</span> <span class="keyword1">of</span> right <span class="main">⇒</span> <span class="skolem">pc_r</span> <span class="main">|</span> left <span class="main">⇒</span> <span class="skolem">pc_l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> child <span class="main">(</span><span class="skolem">pc</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span> <span class="skolem">dir</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pc_def pc_r_def pc_l_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> pc_child <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> <span class="skolem">dir</span> <span class="free">d</span> <span class="main">=</span> child <span class="main">(</span><span class="skolem">pc</span> <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pc_def pc_r_def pc_l_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> pc_child_inv <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> length <span class="main">(</span>child <span class="skolem">p</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>child <span class="main">(</span><span class="skolem">pc</span> <span class="bound">dir</span><span class="main">)</span> <span class="main">(</span>inv <span class="bound">dir</span><span class="main">)</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> length <span class="skolem">p</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">pc</span> <span class="bound">dir</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">pc</span> <span class="bound">dir</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">lm</span> <span class="main">+</span> level <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">α</span> <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">p''</span><span class="main">.</span> <span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="bound">s</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span>Suc <span class="skolem">lm</span> <span class="main">+</span> level <span class="skolem">p</span><span class="main">)</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">p'</span> <span class="bound">p''</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">dir</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span>child <span class="bound">s</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="var">?l</span> <span class="main">(</span>child <span class="bound">s</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">p'</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">dir</span><span class="main">.</span> child <span class="skolem">p</span> <span class="bound">dir</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">dir</span><span class="main">.</span> <span class="var">?sum</span> <span class="skolem">p</span> <span class="bound">dir</span> <span class="main">(</span><span class="skolem">pc</span> <span class="bound">dir</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fm</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">dir</span><span class="main">.</span> <span class="var">?sum</span> <span class="skolem">p</span> <span class="bound">dir</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?result</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?fm</span> left <span class="main">+</span> <span class="var">?fm</span> right <span class="main">+</span> <span class="main">(</span><span class="skolem">α</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?up</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">lm</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">.</span> up' <span class="free">d</span> <span class="bound">lm</span> <span class="bound">p</span> <span class="bound">α</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">βl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">βl</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?up</span> <span class="skolem">lm</span> <span class="main">(</span><span class="var">?ch</span> left<span class="main">)</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">βr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">βr</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?up</span> <span class="skolem">lm</span> <span class="main">(</span><span class="var">?ch</span> right<span class="main">)</span> <span class="skolem">βl</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p_d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p_d</span> <span class="skolem">dir</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">dir</span> <span class="keyword1">of</span> right <span class="main">⇒</span> <span class="skolem">p_r</span> <span class="main">|</span> left <span class="main">⇒</span> <span class="skolem">p_l</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span>
  <span class="keyword1"><span class="command">have</span></span> p_d_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> child <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">dir</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">dir</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems p_d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">dir</span><span class="main">.</span> length <span class="skolem">p</span> <span class="main">=</span> length <span class="main">(</span>child <span class="main">(</span><span class="skolem">p_d</span> <span class="bound">dir</span><span class="main">)</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">dir</span><span class="main">.</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">p_d</span> <span class="bound">dir</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dir</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span><span class="var">?ch</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="var">?l</span> <span class="main">(</span><span class="var">?ch</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">p'</span> <span class="main">(</span><span class="skolem">pc</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?C</span> <span class="skolem">p'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span> <span class="var">?C</span> <span class="skolem">p'</span> <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l2_zigzag<span class="main">[</span><span class="operator">OF</span> _ p_d_child<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main"><span class="main">]</span></span> _ pc_child<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> inv_dir_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pc</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?sum</span> <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>
      <span class="main">=</span> <span class="var">?sum</span> <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum_divide_distrib<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="skolem">p</span> <span class="skolem">dir</span> <span class="skolem">p</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span> <span class="var">?sum</span> <span class="skolem">p</span> <span class="skolem">dir</span> <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l2_down2<span class="main">[</span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> child <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">dir</span> <span class="free">d</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_divide_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">α</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">dir</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span> p_d_child<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">]</span>
      <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span>›</span></span> child_lv child_ix grid.Start<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_divide_distrib <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span> <span class="main">=</span>
      <span class="var">?sum</span> <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pc</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      <span class="main">(</span><span class="var">?sum</span> <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="var">?sum</span> <span class="skolem">p</span> <span class="skolem">dir</span> <span class="skolem">p</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">α</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lgrid_sum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> child_level <span class="keyword2"><span class="keyword">and</span></span> inv_dir_sum
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="skolem">p</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pc</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="var">?result</span> <span class="main">=</span> <span class="var">?sum'</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">p_d</span> <span class="skolem">dir</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">left</span><span class="main">]</span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted">right</span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> up'_inplace<span class="main">[</span><span class="operator">OF</span> grid_not_child<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="skolem">lm</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span><span class="var">?ch</span> right<span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="skolem">lm</span> <span class="main">+</span> level <span class="main">(</span><span class="var">?ch</span> right<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> grid_disjunct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> up'_inplace<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p'</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ch</span> left"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="skolem">lm</span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main">]</span> βl_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">βl</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">α</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?up</span> <span class="main">(</span>Suc <span class="skolem">lm</span><span class="main">)</span> <span class="skolem">p</span> <span class="skolem">α</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?f</span> left <span class="main">+</span> <span class="var">?result</span><span class="main">,</span> <span class="var">?f</span> right <span class="main">+</span> <span class="var">?result</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> βl_def pc_child_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted">left</span><span class="main">]</span> pc_child_inv<span class="main">[</span><span class="operator">of</span> <span class="quoted">right</span><span class="main">]</span>
      Suc.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?ch</span> left"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> left"</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main">]</span> eq<span class="main">[</span><span class="operator">of</span> <span class="quoted">left</span> <span class="quoted"><span class="skolem">α</span></span><span class="main">]</span>
      Suc.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?ch</span> right"</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> right"</span></span> <span class="quoted"><span class="skolem">βl</span></span><span class="main">]</span> eq<span class="main">[</span><span class="operator">of</span> <span class="quoted">right</span> <span class="quoted"><span class="skolem">βl</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?up</span> <span class="skolem">lm</span> <span class="main">(</span><span class="var">?ch</span> left<span class="main">)</span> <span class="skolem">α</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?up</span> <span class="skolem">lm</span> <span class="main">(</span><span class="var">?ch</span> right<span class="main">)</span> <span class="skolem">βl</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_d_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Up-up'_β"><span class="command">lemma</span></span> up'_β<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span> <span class="main">;</span> <span class="free">l</span> <span class="main">+</span> level <span class="free">b</span> <span class="main">=</span> <span class="free">lm</span> <span class="main">;</span> <span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">⟧</span>
   <span class="main">⟹</span>
   <span class="main">(</span>snd <span class="main">(</span>up' <span class="free">d</span> <span class="free">l</span> <span class="free">b</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>
      <span class="keyword1">then</span> <span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">(</span>lgrid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="free">α</span> <span class="bound">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="free">α</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">_</span> <span class="main">;</span> <span class="main">_</span> <span class="main">;</span> <span class="main">_</span> <span class="main">;</span> <span class="main">_</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="var">?goal</span> <span class="free">l</span> <span class="free">b</span> <span class="free">p</span> <span class="free">α</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">α</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> left <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> right <span class="free">d</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p_l</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> child <span class="skolem">p_l</span> left <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_ex_neighbour<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dir<span class="main"><span class="main">=</span></span><span class="quoted">right</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p_r</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> child <span class="skolem">p_r</span> right <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_ex_neighbour<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> dir<span class="main"><span class="main">=</span></span><span class="quoted">left</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"up' <span class="free">d</span> <span class="skolem">l</span> <span class="var">?l</span> <span class="skolem">α</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ur</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"up' <span class="free">d</span> <span class="skolem">l</span> <span class="var">?r</span> <span class="main">(</span>snd <span class="var">?ul</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="free">p'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="free">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="free">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">(</span>lgrid <span class="free">s</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">)</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">p'</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">b</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def start_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∉</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?ul</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">α</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> up'_inplace <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?goal</span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="skolem">b</span> <span class="skolem">p</span> <span class="skolem">α</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True

    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="free">p'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="free">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="free">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">(</span>lgrid <span class="free">s</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">)</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">p'</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> up'_fl_fr<span class="main">[</span><span class="operator">OF</span> this p_r_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> fml<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fst <span class="var">?ul</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> level <span class="var">?l</span><span class="main">)</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> up'_fl_fr<span class="main">[</span><span class="operator">OF</span> this _ p_l_def<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"snd <span class="var">?ul</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> fmr<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="var">?ur</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> level <span class="var">?r</span><span class="main">)</span><span class="main">.</span>
                                <span class="main">(</span><span class="main">(</span>snd <span class="var">?ul</span><span class="main">)</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">b</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="skolem">b</span> <span class="main">}</span> <span class="main">⊆</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sum_diff<span class="main">[</span><span class="operator">OF</span> lgrid_finite this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">(</span>lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?s</span> <span class="skolem">b</span> <span class="main">-</span> <span class="var">?C</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?s</span> <span class="var">?l</span> <span class="main">+</span> <span class="var">?s</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lgrid_sum <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">b</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">(</span>fst <span class="var">?ul</span><span class="main">)</span> <span class="main">+</span> fst <span class="main">(</span>fst <span class="var">?ur</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fml <span class="keyword2"><span class="keyword">and</span></span> fmr
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_level<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> True lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> up'.simps Let_def <span class="keyword2"><span class="keyword">and</span></span> fun_upd_def lgrid_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">b</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ur</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?l</span> <span class="skolem">p</span> <span class="skolem">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?r</span> <span class="skolem">p</span> <span class="main">(</span>snd <span class="var">?ul</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> grid_partition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> grid <span class="main">(</span>child <span class="skolem">b</span> right <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?l</span> <span class="skolem">p</span> <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?r</span> <span class="skolem">p</span> <span class="main">(</span>snd <span class="var">?ul</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def grid_partition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ur</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> right <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> grid <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="skolem">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> this *<span class="main">]</span> eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="var">?ul</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">α</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?l</span> <span class="skolem">p</span> <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?r</span> <span class="skolem">p</span> <span class="main">(</span>snd <span class="var">?ul</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span> *
          <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ur</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword2"><span class="keyword">and</span></span> grid_partition<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?l</span> <span class="skolem">p</span> <span class="skolem">α</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?goal</span> <span class="skolem">l</span> <span class="var">?r</span> <span class="skolem">p</span> <span class="main">(</span>snd <span class="var">?ul</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?ur</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lgrid_empty'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> lm<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">lm</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> up'.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Up-up"><span class="command">lemma</span></span> up<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>up <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">α</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="main">(</span>lgrid <span class="free">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="free">α</span> <span class="bound">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span> <span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p'</span> <span class="main">∈</span> grid <span class="bound">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p'</span><span class="main">!</span><span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span><span class="main">!</span><span class="free">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">d</span> <span class="bound">lm</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">.</span> snd <span class="main">(</span>up' <span class="bound">d</span> <span class="bound">lm</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> _ this subset_refl subset_refl<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span> <span class="main">∩</span> <span class="main">(</span>grid <span class="skolem">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> lgrid <span class="skolem">p</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> lgrid_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">b</span> <span class="skolem">p</span> <span class="skolem">α</span>
    <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> lgrid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sparsegrid'_start <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> sparsegridE<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>

    <span class="keyword1"><span class="command">note</span></span> up' <span class="main">=</span> up'_β<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> l <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="free">d</span> <span class="skolem">l</span> <span class="skolem">b</span> <span class="skolem">α</span> <span class="skolem">p</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span><span class="main">∈</span>lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="var">?S</span> <span class="main">(</span><span class="skolem">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">p'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">α</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> baseE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> lgrid_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> up' if_P<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> if_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_left lgrid_finite<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> baseI<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> up' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> lift<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> F <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> lift_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lift <span class="var">?F</span> <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">α</span> <span class="free">p</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span><span class="main">∈</span>lgrid <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="var">?S</span> <span class="main">(</span><span class="free">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="free">p</span> <span class="bound">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> lgrid_eq<span class="main">[</span><span class="operator">OF</span> baseE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> sparsegrid_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> up_def lift_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right lgrid_finite<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Down">
<div class="head">
<h1>Theory Down</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Down part ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Down
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Triangular_Function.html">Triangular_Function</a> <a href="UpDown_Scheme.html">UpDown_Scheme</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Down-sparsegrid'_parents"><span class="command">lemma</span></span> sparsegrid'_parents<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms parents_def sparsegrid'I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Down-down'_β"><span class="command">lemma</span></span> down'_β<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="free">b</span> <span class="main">;</span> <span class="free">l</span> <span class="main">+</span> level <span class="free">b</span> <span class="main">=</span> <span class="free">lm</span> <span class="main">;</span> <span class="free">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span> <span class="main">⟧</span> <span class="main">⟹</span>
  down' <span class="free">d</span> <span class="free">l</span> <span class="free">b</span> <span class="free">fl</span> <span class="free">fr</span> <span class="free">α</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">∈</span> lgrid <span class="free">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>
  <span class="keyword1">then</span>
    <span class="main">(</span><span class="free">fl</span> <span class="main">+</span> <span class="main">(</span><span class="free">fr</span> <span class="main">-</span> <span class="free">fl</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>real_of_int <span class="main">(</span>ix <span class="free">p</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">-</span> lv <span class="free">b</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> real_of_int <span class="main">(</span>ix <span class="free">b</span> <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="free">p</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="free">b</span> <span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="free">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">α</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">fl</span></span> <span class="quoted"><span class="free">fr</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> left <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> right <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?result</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">fl</span> <span class="main">+</span> <span class="skolem">fr</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">α</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">b</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fm</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fl</span> <span class="main">+</span> <span class="skolem">fr</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">α</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?down_l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"down' <span class="free">d</span> <span class="skolem">l</span> <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="skolem">fl</span> <span class="var">?fm</span> <span class="main">(</span><span class="skolem">α</span><span class="main">(</span><span class="skolem">b</span> <span class="main">:=</span> <span class="var">?result</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">b</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def start_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">dir</span><span class="main">.</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">dir</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">+</span> level <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> child_level <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">dir</span><span class="main">.</span> <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> hyps <span class="main">=</span> Suc.hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> <span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">!!</span><span class="bound">dir</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">+</span> level <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">lm</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">!!</span><span class="bound">dir</span><span class="main">.</span> <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def
      <span class="keyword1"><span class="command">unfolding</span></span> grid_partition<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> down'.simps Let_def fun_upd_def hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lv <span class="skolem">b</span> <span class="free">d</span>"</span></span>   <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ib</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>ix <span class="skolem">b</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lp</span></span></span>   <span class="main">=</span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="free">d</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ip</span></span></span>   <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>ix <span class="skolem">p</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">dir</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span><span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dir</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> <span class="skolem">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>child <span class="skolem">b</span> <span class="skolem">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">p</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> child_lv<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> grid_single_level<span class="main">[</span><span class="operator">OF</span> p_grid <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="main">(</span>child <span class="skolem">b</span> <span class="skolem">dir</span> <span class="free">d</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ch</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> <span class="skolem">dir</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ich</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"child <span class="skolem">b</span> <span class="main">(</span>inv <span class="skolem">dir</span><span class="main">)</span> <span class="free">d</span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">dir</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> right
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?ch</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fl</span> <span class="skolem">fr</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="main">(</span>child <span class="skolem">b</span> right <span class="free">d</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> right <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∉</span> lgrid <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def
            <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> grid_not_child <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">from</span></span> hyps<span class="main">[</span><span class="operator">OF</span> sparsegrid'_parents<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹child <span class="skolem">b</span> right <span class="free">d</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span>
                       p'<span class="main"><span class="main">]</span></span><span class="main">]</span> this
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"down' <span class="free">d</span> <span class="skolem">l</span> <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="skolem">fl</span> <span class="skolem">fr</span> <span class="main">(</span><span class="skolem">α</span><span class="main">(</span><span class="skolem">b</span> <span class="main">:=</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">α</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span>  <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> down'.simps Let_def hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span>
            parent_sum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span>
            l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> child_ix child_lv <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> level_shift<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lv <span class="skolem">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">p</span> <span class="free">d</span>›</span></span><span class="main">]</span>
                sgn.simps <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> diff_divide_distrib add_divide_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> left
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?ch</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> grid_disjunct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> p'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> left <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_not_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> down'.simps Let_def hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span>
                    parent_sum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span><span class="main">]</span>
                    l2_child<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">]</span> sgn.simps
                    if_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span><span class="main">]</span> if_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="var">?l</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span><span class="main">]</span>
                    if_not_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="var">?r</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> child_ix child_lv <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> level_shift<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹lv <span class="skolem">b</span> <span class="free">d</span> <span class="main">&lt;</span> lv <span class="skolem">p</span> <span class="free">d</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> diff_divide_distrib add_divide_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> not_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_onedim_split<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">d</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> grid_empty_ds<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> not_child <span class="keyword1"><span class="command">have</span></span> lnot_child<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">dir</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>child <span class="skolem">b</span> <span class="bound">dir</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">fl</span> <span class="main">+</span> <span class="skolem">fr</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">α</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> lv <span class="skolem">b</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">fl</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">fr</span> <span class="main">-</span> <span class="skolem">fl</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="skolem">b</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">α</span> <span class="skolem">b</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">b</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l2_same diff_divide_distrib add_divide_distrib times_divide_eq_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> down'.simps Let_def fun_upd_def hyps<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span> if_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>›</span></span><span class="main">]</span> if_not_P<span class="main">[</span><span class="operator">OF</span> lnot_child<span class="main">]</span> if_P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> parents_single <span class="keyword1"><span class="command">unfolding</span></span> result <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> grid_level<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">lm</span> <span class="main">≤</span> level <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> down'.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Down-down"><span class="command">lemma</span></span> down<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>down <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">α</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="free">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="free">d</span> <span class="free">l</span> <span class="free">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"down' <span class="free">d</span> <span class="free">l</span> <span class="free">p</span> <span class="main">0</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">x</span> <span class="free">p</span> <span class="free">p'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">p'</span> <span class="main">∈</span> parents <span class="free">d</span> <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">α</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> le_less_trans<span class="main">[</span><span class="operator">OF</span> grid_level sparsegridE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"parents <span class="free">d</span> <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">⊆</span>  lgrid <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p'</span><span class="main">∈</span>lgrid <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="var">?S</span> <span class="main">(</span><span class="skolem">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">p'</span><span class="main">∈</span>parents <span class="free">d</span> <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lgrid_finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sum_eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">α</span>
    <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> lgrid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> b_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sparsegrid'_start sparsegrid_subset <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="free">d</span> <span class="skolem">l</span> <span class="skolem">b</span> <span class="skolem">α</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="main">∑</span><span class="bound">p'</span><span class="main">∈</span>lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="var">?S</span> <span class="main">(</span><span class="skolem">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="skolem">p</span> <span class="bound">p'</span> <span class="keyword1">else</span> <span class="skolem">α</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> baseE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p_spg<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> if_P<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> True sum_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> down'_β<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> b_spg p_spg<span class="main">,</span>
          <span class="operator">unfolded</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> lgrid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">b</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> b this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> base <span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> baseI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> if_not_P<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> down'_β<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> length <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">+</span> level <span class="skolem">b</span> <span class="main">=</span> <span class="free">lm</span>›</span></span> b_spg p_spg<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> lift<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> F <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> down_def
    <span class="keyword1"><span class="command">unfolding</span></span> sum_eq<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Up_Down">
<div class="head">
<h1>Theory Up_Down</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ UpDown  ›</span></span>

<span class="comment1">(* Definition of sparse grids, hierarchical bases and the up-down algorithm.
 *
 * Based on "updown_L2-Skalarprodukt.mws" from Dirk Pflüger &lt;pflueged@in.tum.de&gt;
 *
 * Author: Johannes Hölzl &lt;hoelzl@in.tum.de&gt;
 *)</span>
<span class="keyword1"><span class="command">theory</span></span> Up_Down
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Up.html">Up</a> <a href="Down.html">Down</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Up_Down-updown'"><span class="command">lemma</span></span> updown'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">dm</span><span class="main">;</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">α</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">d</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="free">α</span> <span class="bound">p'</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">d'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">d</span><span class="main">}</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">_</span> <span class="main">;</span> <span class="main">_</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="free">d</span> <span class="free">p</span><span class="main">.</span> <span class="free">α</span> <span class="bound">p'</span> <span class="main">*</span> <span class="var">?prod</span> <span class="free">d</span> <span class="bound">p'</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subgrid</span> <span class="main">0</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_empty <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword2"><span class="keyword">and</span></span> sparsegrid_def sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> updown'.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?leafs</span> <span class="skolem">p</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lgrid <span class="skolem">p</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?parents</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"parents <span class="skolem">d</span> <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> p_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_spg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def <span class="keyword2"><span class="keyword">and</span></span> sparsegrid'_def <span class="keyword2"><span class="keyword">and</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> p'_in_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> baseE<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">..&lt;</span></span><span class="skolem"><span class="skolem">d</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">∈</span> grid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_bgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?b</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="var">?b</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_out<span class="main">[</span><span class="operator">OF</span> _ _ p_spg'<span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="main">(</span>up <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">(</span>up <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span><span class="main">)</span> <span class="bound">p'</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="skolem">d</span> <span class="bound">p'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">using</span></span> base_length<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"up <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span> <span class="skolem">p'</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span>›</span></span> up <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> p'_in_spg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="bound">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_distrib_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p''</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong refl<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> d_lt_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d'_not_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d'</span> <span class="main">=</span> <span class="skolem">p''</span> <span class="main">!</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="skolem">p'</span>›</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> d_lt_p d'_not_d<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="skolem">p'</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">=</span> l2_φ <span class="main">(</span><span class="skolem">p''</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?b</span>›</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ds<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="var">?b</span> <span class="main">!</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span> <span class="main">=</span>
        l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">d</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prod.insert
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">d</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">*</span> prod <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="skolem">p''</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">α</span> <span class="skolem">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>up <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">p'</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">∈</span> Sigma <span class="main">(</span><span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p'</span><span class="main">.</span> <span class="main">(</span><span class="var">?leafs</span> <span class="bound">p'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">α</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.Sigma<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lgrid_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p''</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="bound">p'''</span><span class="main">)</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> grid_grid_inj_on<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ivl_disj_int<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>15<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span></span> m<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span></span> u<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?b</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">.</span> snd <span class="main">`</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_UN<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> up_part<span class="main">:</span> <span class="quoted"><span class="quoted">"updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="main">(</span>up <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"down <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> down <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="var">?parents</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> p_lgrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="var">?b'</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">(</span>level <span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parents_subset_lgrid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p'_spg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p'</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> p_lgrid <span class="keyword1"><span class="command">have</span></span> p'_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> grid <span class="var">?b'</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span>  <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="bound">p''</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>›</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="bound">p''</span> <span class="skolem">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_distrib_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p''</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p'</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p''</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_base_out<span class="main">[</span><span class="operator">OF</span> this p_spg' p'_grid<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="skolem">p''</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">=</span> l2_φ <span class="main">(</span><span class="skolem">p''</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">!</span><span class="skolem">d'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> base_length p'_spg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_base_out<span class="main">[</span><span class="operator">OF</span> this p'_spg'<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p'</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> lgrid_def<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> l2_commutative <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p''</span> <span class="skolem">p</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">d</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> prod.insert
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">*</span> prod <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">=</span>
          prod <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">d</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">=</span>
          prod <span class="main">(</span><span class="main">λ</span> <span class="bound">d'</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p''</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="skolem">d</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="skolem">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="skolem">d</span> <span class="skolem">p''</span> <span class="skolem">p'</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">α</span> <span class="skolem">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">p''</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">*</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p'</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Sigma <span class="var">?parents</span> <span class="main">(</span><span class="var">?subgrid</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.Sigma<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parents_finite lgrid_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p''</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="bound">p'''</span><span class="main">)</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p'</span><span class="main">∈</span>parents <span class="skolem">d</span> <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">p''</span><span class="main">∈</span>lgrid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> x_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> parents_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> x_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p'</span><span class="main">∈</span>parents <span class="skolem">d</span> <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">p''</span><span class="main">∈</span>lgrid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="free">lm</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> y_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">y</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> parents_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> y_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_length<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span><span class="main">]</span> grid_length<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> fst <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that l_eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> fst <span class="skolem">y</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span><span class="main">]</span>
            grid_invariant<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span>›</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="main">(</span>fst <span class="skolem">y</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span><span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> grid_base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> _ y_spg y_snd<span class="main">]</span> grid_base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> _ x_spg x_snd<span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_eqI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="skolem">x</span> <span class="main">=</span> snd <span class="skolem">y</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">.</span> snd <span class="main">`</span> <span class="main">{</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="main">(</span><span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_UN<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> down_part<span class="main">:</span> <span class="quoted"><span class="quoted">"down <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="skolem">d</span> <span class="skolem">α</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"updown' <span class="free">dm</span> <span class="free">lm</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">α</span> <span class="skolem">p</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_vector_def updown'.simps down_part <span class="keyword2"><span class="keyword">and</span></span> up_part <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p''</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p''</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p''</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lgrid_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lgrid_finite parents_finite<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">rule</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjoint_iff_not_equal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">.</span> <span class="var">?leafs</span> <span class="bound">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">px</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">px</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> grid_base_out<span class="main">[</span><span class="operator">OF</span> _ _ p_spg' this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> base_length<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> grid_level_d
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">px</span> <span class="skolem">d</span> <span class="main">&lt;</span> lv <span class="skolem">x</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">&lt;</span> lv <span class="skolem">x</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span><span class="main">.</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">py</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">py</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">py</span> <span class="main">∈</span> <span class="var">?parents</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">py</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">py</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> py_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">py</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">!</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">py</span> <span class="main">!</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_base_out<span class="main">[</span><span class="operator">OF</span> _ _ py_spg y_grid<span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="skolem">y</span> <span class="skolem">d</span> <span class="main">≤</span> lv <span class="skolem">p</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_single_level<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> grid <span class="skolem">py</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">d</span> <span class="main">≤</span> <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> sparsegrid'_length<span class="main">[</span><span class="operator">OF</span> py_spg<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="skolem">p</span><span class="main">.</span> <span class="skolem">α</span> <span class="bound">p'</span> <span class="main">*</span> <span class="var">?prod</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span> <span class="bound">p'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?in</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?out</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lgrid_finite<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?in</span> <span class="main">⊆</span> <span class="var">?out</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?children</span> <span class="main">∪</span> <span class="var">?siblings</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?in</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?out</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?children</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?siblings</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?in</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">px</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> parents <span class="skolem">d</span> <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lgrid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">px</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">px</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def parents_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> grid_base_union<span class="main">[</span><span class="operator">OF</span> p_spg' this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> d_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">px</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lgrid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">px</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_base_dim_add<span class="main">[</span><span class="operator">OF</span> _ p_spg' this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹level <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> d_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?out</span> <span class="main">-</span> <span class="var">?in</span><span class="main">.</span> <span class="var">?F</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?out</span> <span class="main">-</span> <span class="var">?in</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?out</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> up_ps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∉</span> lgrid <span class="bound">p'</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="free">lm</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p'</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> down_ps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="bound">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> up_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∉</span> grid <span class="bound">p'</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        down_ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="var">?parents</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> up_ps' down_ps' <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> ds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="main">-</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="main">-</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_ngrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_split<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">px</span></span> <span class="keyword2"><span class="keyword">where</span></span> px_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_level<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹level <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">lm</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"level <span class="skolem">px</span> <span class="main">&lt;</span> <span class="free">lm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">px</span> <span class="main">∈</span> <span class="var">?subgrid</span> <span class="skolem">d</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> px_grid <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">px</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> up_ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">px</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">px</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> px_grid <span class="keyword2"><span class="keyword">and</span></span> x_ngrid <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> grid <span class="skolem">px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?parents</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> parents_def <span class="keyword1"><span class="command">using</span></span> baseE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> down_ps<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> x_ngrid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> x_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> x_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">x</span> <span class="main">=</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?bp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?bx1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?bp1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?px</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">[</span><span class="skolem">d</span> <span class="main">:=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">]</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> x_nochild_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bx</span> <span class="main">∉</span> grid <span class="var">?bp</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_transitive<span class="main">[</span><span class="operator">OF</span> baseE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_spg<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> x_ngrid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bx</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bx1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bp1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_length<span class="main">[</span><span class="operator">OF</span> x_spg<span class="main">]</span> base_length<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> p_nochild_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bp</span> <span class="main">∉</span> grid <span class="var">?bx</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?assm</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> d_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?assm</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> b_in_bx<span class="main">:</span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?bx</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> grid_replace_dim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bx</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="skolem">p</span>›</span></span> grid.Start<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> b_in_bx<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> grid <span class="var">?px</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>›</span></span> x_spg<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>›</span></span> p_spg'<span class="main">]</span> list_update_id <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> grid_replace_dim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bx1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> length <span class="var">?bp1</span>›</span></span> baseE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> p_spg'<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> baseE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_spg<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?px</span> <span class="main">∈</span> grid <span class="var">?bp1</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span> x_spg<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span> p_spg'<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> list_update_id <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="var">?px</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> down_ps<span class="main">[</span><span class="operator">unfolded</span> parents_def<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?px</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="var">?px</span> <span class="main">=</span> <span class="var">?bx</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?px</span> <span class="main">∈</span> grid <span class="var">?bp1</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> px_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?px</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> base_length<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> base_length<span class="main">[</span><span class="operator">OF</span> x_spg<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="var">?px</span><span class="main">)</span> <span class="main">=</span> length <span class="var">?bx</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="var">?px</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?bx</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="var">?px</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?bx</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that l_eq <span class="keyword2"><span class="keyword">and</span></span> base_length<span class="main">[</span><span class="operator">OF</span> px_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="var">?px</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?bx</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> base_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> px_spg x_spg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?px</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_length<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">from</span></span> grid_invariant<span class="main">[</span><span class="operator">OF</span> i_le this x_eq<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> this p_spg'<span class="main">]</span>
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> list_update_id <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">p</span> <span class="main">=</span> <span class="free">dm</span>›</span></span> nth_list_update_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>›</span></span> px_spg<span class="main">]</span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>›</span></span> x_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> grid <span class="var">?bx</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> baseE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x_spg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> x_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bx</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_shift_base<span class="main">[</span><span class="operator">OF</span> _ p_spg' x_eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ds_eq<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> p_grid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bp</span> <span class="main">∈</span> grid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> grid_shift_base<span class="main">[</span><span class="operator">OF</span> _ p_spg' baseE<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> p_spg'<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ds<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">d</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="var">?bp</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="var">?bx</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lv <span class="var">?bx</span> <span class="skolem">d</span> <span class="main">≤</span> lv <span class="var">?bp</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">from</span></span> l2_disjoint<span class="main">[</span><span class="operator">OF</span> _ x_grid p_grid p_nochild_x this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> base_length<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lv <span class="var">?bx</span> <span class="skolem">d</span> <span class="main">≥</span> lv <span class="var">?bp</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> l2_disjoint<span class="main">[</span><span class="operator">OF</span> _ p_grid x_grid x_nochild_p this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> base_length<span class="main">[</span><span class="operator">OF</span> p_spg'<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l2_commutative<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base_out<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span><span class="main">]</span> p_spg' x_spg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">d</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">d</span><span class="main">}</span><span class="main">.</span> l2_φ <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> prod_zero<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l2_commutative<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> updown<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_spg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"updown <span class="free">dm</span> <span class="free">lm</span> <span class="free">α</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">p'</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">.</span> <span class="free">α</span> <span class="bound">p'</span> <span class="main">*</span> l2 <span class="bound">p'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_spg <span class="keyword1"><span class="command">unfolding</span></span> sparsegrid_def sparsegrid'_def lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="free">lm</span> <span class="main">⟹</span> length <span class="bound">p'</span> <span class="main">=</span> <span class="free">dm</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> lgrid <span class="main">(</span>base <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> base_grid<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> sparsegrid' <span class="free">dm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lgrid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p'</span> <span class="main">=</span> <span class="free">dm</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> updown_def sparsegrid_def base_start_eq<span class="main">[</span><span class="operator">OF</span> p_spg<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> updown'<span class="main">[</span><span class="operator">OF</span> _ p_spg<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> d<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">dm</span></span><span class="main">]</span> p_spg<span class="main">[</span><span class="operator">unfolded</span> sparsegrid_def lgrid_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atLeast0LessThan p_spg<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sparsegrid_length<span class="main"><span class="main">]</span></span> l2_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>α</sub></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span>sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">.</span> <span class="free">α</span> <span class="bound">p</span> <span class="main">*</span> Φ <span class="bound">p</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"updown <span class="free">dm</span> <span class="free">lm</span> <span class="free">α</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">.</span> <span class="free">f<span class="hidden">⇩</span><sub>α</sub></span> <span class="bound">x</span> <span class="main">*</span> Φ <span class="free">p</span> <span class="bound">x</span> <span class="main">∂</span><span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">d</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free">dm</span><span class="main">}</span><span class="main">.</span> lborel<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> updown<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> l2_def f<span class="hidden">⇩</span><sub>α</sub>_def sum_distrib_right
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> has_bochner_integral_integral_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> has_bochner_integral_sum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> has_bochner_integral_mult_right<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sparsegrid_length<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> has_bochner_integral_integrable<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> p
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sparsegrid_length Φ_def prod.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> product_sigma_finite.product_integrable_prod<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"product_sigma_finite <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> lborel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> integrable_φ2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Imperative">
<div class="head">
<h1>Theory Imperative</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹ Imperative Version ›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Imperative
<span class="keyword2"><span class="keyword">imports</span></span> <a href="UpDown_Scheme.html">UpDown_Scheme</a> <a href="../Separation_Logic_Imperative_HOL/Sep_Main.html">Separation_Logic_Imperative_HOL.Sep_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> pointmap <span class="main">=</span> <span class="quoted"><span class="quoted">"grid_point <span class="main">⇒</span> nat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> impgrid <span class="main">=</span> <span class="quoted"><span class="quoted">"rat array"</span></span>

<span class="keyword1"><span class="command">instance</span></span> rat <span class="main">::</span> <span class="quoted">heap</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rat_pair</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rat_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>of_rat <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> of_rat <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> rat_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span>
   <span class="entity">zipWithA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>heap <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>heap<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> array <span class="main">⇒</span> <span class="tfree">'b</span> array <span class="main">⇒</span> <span class="tfree">'a</span> array Heap"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zipWithA</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">n</span> <span class="main">←</span> Array.len <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
     Heap_Monad.fold_map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">x</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">n</span> <span class="main">;</span>
       <span class="bound">y</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">n</span> <span class="main">;</span>
       Array.upd <span class="bound">n</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
     <span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">n</span><span class="main">]</span><span class="main">;</span>
     return <span class="free"><span class="bound"><span class="entity">a</span></span></span>
   <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> zipWithA <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ys</span> <span class="main">&gt;</span> zipWithA <span class="free">f</span> <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> map <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ys</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="bound">r</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?part_res</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span>case_prod <span class="free">f</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>take <span class="bound">n</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> drop <span class="bound">n</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">xs</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ys</span> <span class="main">&gt;</span> Heap_Monad.fold_map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">x</span> <span class="main">←</span> Array.nth <span class="free">a</span> <span class="bound">n</span> <span class="main">;</span>
         <span class="bound">y</span> <span class="main">←</span> Array.nth <span class="free">b</span> <span class="bound">n</span> <span class="main">;</span>
         Array.upd <span class="bound">n</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">a</span>
       <span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span> <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="var">?part_res</span> <span class="skolem">n</span> <span class="skolem">xs</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ys</span> <span class="main">&gt;</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Suc.hyps <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?part_res</span> <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">[</span><span class="skolem">n</span> <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span><span class="var">?part_res</span> <span class="skolem">n</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>  <span class="var">?part_res</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append take_Suc_conv_app_nth upd_conv_take_nth_drop<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_map_append *<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zipWithA_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">copy_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>heap array <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>heap array<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">copy_array</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> Array.freeze <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⤜</span> Array.of_list"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> copy_array <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">&gt;</span> copy_array <span class="free">a</span> <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="bound">r</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> copy_array_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat array <span class="main">⇒</span> rat array <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_array</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> zipWithA <span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⪢</span> return <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sum_array <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">xs</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ys</span> <span class="main">&gt;</span> sum_array <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">ys</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_array_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">locale</span></span> linearization <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dm</span> <span class="free">lm</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">pm</span> <span class="main">::</span> <span class="quoted">pointmap</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pm<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">pm</span> <span class="main">(</span>sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">)</span> <span class="main">{..&lt;</span> card <span class="main">(</span>sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Imperative-linearizationD"><span class="command">lemma</span></span> linearizationD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="free">pm</span> <span class="free">p</span> <span class="main">&lt;</span> card <span class="main">(</span>sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gridI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"impgrid <span class="main">⇒</span> <span class="main">(</span>grid_point <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> assn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gridI</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">∃<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">xs</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">p</span> <span class="main">=</span> of_rat <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="free">pm</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> card <span class="main">(</span>sparsegrid <span class="free">dm</span> <span class="free">lm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Imperative-gridI_nth_rule"><span class="command">lemma</span></span> gridI_nth_rule <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> Array.nth <span class="free">a</span> <span class="main">(</span><span class="free">pm</span> <span class="free">g</span><span class="main">)</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">*</span> <span class="main">↑</span> <span class="main">(</span>of_rat <span class="bound">r</span> <span class="main">=</span> <span class="free">v</span> <span class="free">g</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def gridI_def<span class="main">)</span>

<span class="keyword1" id="Imperative-gridI_upd_rule"><span class="command">lemma</span></span> gridI_upd_rule <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> Array.upd <span class="main">(</span><span class="free">pm</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>fun_upd <span class="free">v</span> <span class="free">g</span> <span class="main">(</span>of_rat <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span><span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gridI_def <span class="keyword1"><span class="command">using</span></span> pm
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def inj_onD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_list_update_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nth_list_update_neq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">upI'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> impgrid <span class="main">⇒</span> <span class="main">(</span>rat <span class="main">*</span> rat<span class="main">)</span> Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>       <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">upI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
       <span class="main">(</span><span class="bound">fl</span><span class="main">,</span> <span class="bound">fml</span><span class="main">)</span> <span class="main">←</span> <span class="free">upI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> left <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
       <span class="main">(</span><span class="bound">fmr</span><span class="main">,</span> <span class="bound">fr</span><span class="main">)</span> <span class="main">←</span> <span class="free">upI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> right <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
       <span class="bound">val</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">pm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">;</span>
       Array.upd <span class="main">(</span><span class="free">pm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">fml</span> <span class="main">+</span> <span class="bound">fmr</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
       <span class="keyword1">let</span> <span class="bound">result</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="bound">fml</span> <span class="main">+</span> <span class="bound">fmr</span> <span class="main">+</span> <span class="bound">val</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">;</span>
       return <span class="main">(</span><span class="bound">fl</span> <span class="main">+</span> <span class="bound">result</span><span class="main">,</span> <span class="bound">fr</span> <span class="main">+</span> <span class="bound">result</span><span class="main">)</span>
     <span class="main">}</span>"</span></span>

<span class="keyword1" id="Imperative-upI'"><span class="command">lemma</span></span> upI' <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">+</span> <span class="free">l</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> upI' <span class="free">d</span> <span class="free">l</span> <span class="free">p</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">=</span> up' <span class="free">d</span> <span class="free">l</span> <span class="free">p</span> <span class="free">v</span> <span class="keyword1">in</span> gridI <span class="free">a</span> <span class="bound">v'</span> <span class="main">*</span> <span class="main">↑</span><span class="main">(</span>rat_pair <span class="bound">r</span> <span class="main">=</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> l
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> rat_pair.simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="skolem">p</span> left <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="skolem">p</span> right <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparsegrid_length<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="free">d</span> <span class="main">∉</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> right <span class="free">d</span> <span class="main">∉</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparsegrid_def lgrid_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_add of_rat_divide of_rat_power of_rat_mult rat_pair_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">downI'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> impgrid <span class="main">⇒</span> rat <span class="main">⇒</span> rat <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">downI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>       <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="free"><span class="bound"><span class="entity">fr</span></span></span> <span class="main">=</span> return <span class="main">()</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">downI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="free"><span class="bound"><span class="entity">fr</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">val</span> <span class="main">←</span> Array.nth <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">pm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">;</span>
      <span class="keyword1">let</span> <span class="bound">fm</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">fr</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="bound">val</span><span class="main">)</span> <span class="main">;</span>
      Array.upd <span class="main">(</span><span class="free">pm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">fr</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">*</span> <span class="bound">val</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>lv <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
      <span class="free">downI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> left <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">fl</span></span></span> <span class="bound">fm</span> <span class="main">;</span>
      <span class="free">downI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>child <span class="free"><span class="bound"><span class="entity">p</span></span></span> right <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">fm</span> <span class="free"><span class="bound"><span class="entity">fr</span></span></span>
    <span class="main">}</span>"</span></span>

<span class="keyword1" id="Imperative-downI'"><span class="command">lemma</span></span> downI' <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="free">p</span> <span class="main">+</span> <span class="free">l</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> downI' <span class="free">d</span> <span class="free">l</span> <span class="free">p</span> <span class="free">a</span> <span class="free">fl</span> <span class="free">fr</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>down' <span class="free">d</span> <span class="free">l</span> <span class="free">p</span> <span class="main">(</span>of_rat <span class="free">fl</span><span class="main">)</span> <span class="main">(</span>of_rat <span class="free">fr</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> l
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">fl</span></span> <span class="quoted"><span class="free">fr</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> rat_pair.simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="skolem">p</span> left <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="quoted"><span class="quoted">"level <span class="main">(</span>child <span class="skolem">p</span> right <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">lm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparsegrid_length<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> left <span class="free">d</span> <span class="main">∉</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"child <span class="skolem">p</span> right <span class="free">d</span> <span class="main">∉</span> sparsegrid <span class="free">dm</span> <span class="free">lm</span> <span class="main">⟹</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparsegrid_def lgrid_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_add of_rat_divide of_rat_power of_rat_mult rat_pair_def Let_def fun_upd_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">liftI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat <span class="main">⇒</span> grid_point <span class="main">⇒</span> impgrid <span class="main">⇒</span> unit Heap<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> impgrid <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">liftI</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> 
    foldr <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">⪢</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>gridgen <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span> <span class="main">0</span> <span class="main">..&lt;</span> <span class="free">dm</span> <span class="main">}</span> <span class="main">-</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">}</span><span class="main">)</span> <span class="free">lm</span><span class="main">)</span> <span class="main">(</span>return <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> liftI <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> lgrid <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span><span class="main">)</span> <span class="free">lm</span> <span class="main">⟹</span>
    <span class="main">&lt;</span> gridI <span class="free">a</span> <span class="bound">v</span> <span class="main">&gt;</span> <span class="free">f</span> <span class="free">d</span> <span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span><span class="free">f'</span> <span class="free">d</span> <span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> liftI <span class="free">f</span> <span class="free">d</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>Grid.lift <span class="free">f'</span> <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gridI <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">⊆</span> set <span class="main">(</span>gridgen <span class="main">(</span>start <span class="free">dm</span><span class="main">)</span> <span class="var">?ds</span> <span class="free">lm</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ps</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> <span class="var">?g</span> <span class="free">v</span> <span class="main">&gt;</span>
        foldr <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">::</span> unit Heap<span class="main">)</span> <span class="main">⪢</span> <span class="free">f</span> <span class="free">d</span> <span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">ps</span> <span class="main">(</span>return <span class="main">()</span><span class="main">)</span>
      <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="var">?g</span> <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">α</span><span class="main">.</span> <span class="free">f'</span> <span class="free">d</span> <span class="main">(</span><span class="free">lm</span> <span class="main">-</span> level <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">α</span><span class="main">)</span> <span class="skolem">ps</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gridgen_lgrid_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> subset_refl gridgen_distinct<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftI_def Grid.lift_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upI</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">upI</span> <span class="main">=</span> liftI <span class="main">(</span><span class="main">λ</span><span class="bound">d</span> <span class="bound">l</span> <span class="bound">p</span> <span class="bound">a</span><span class="main">.</span> upI' <span class="bound">d</span> <span class="bound">l</span> <span class="bound">p</span> <span class="bound">a</span> <span class="main">⪢</span> return <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> upI <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> upI <span class="free">d</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>up <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> up_def upI_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lgrid_def sparsegrid_def lgrid_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> grid_union_dims<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">downI</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">downI</span> <span class="main">=</span> liftI <span class="main">(</span><span class="main">λ</span><span class="bound">d</span> <span class="bound">l</span> <span class="bound">p</span> <span class="bound">a</span><span class="main">.</span> downI' <span class="bound">d</span> <span class="bound">l</span> <span class="bound">p</span> <span class="bound">a</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> downI <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">dm</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> downI <span class="free">d</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>down <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">v</span><span class="main">)</span> <span class="main">&gt;</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> down_def downI_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lgrid_def sparsegrid_def lgrid_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> grid_union_dims<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">d</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">dm</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> copy_array_gridI <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> copy_array <span class="free">a</span> <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">*</span> gridI <span class="bound">r</span> <span class="free">v</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gridI_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">theorem</span></span> sum_array_gridI <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">*</span> gridI <span class="free">b</span> <span class="free">w</span> <span class="main">&gt;</span> sum_array <span class="free">a</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>sum_vector <span class="free">v</span> <span class="free">w</span><span class="main">)</span> <span class="main">*</span> gridI <span class="free">b</span> <span class="free">w</span> <span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gridI_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">sep_auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_vector_def nth_map linearizationD of_rat_add<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">updownI'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> impgrid <span class="main">⇒</span> unit Heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updownI'</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> return <span class="main">()</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">updownI'</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">b</span> <span class="main">←</span> copy_array <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
      upI <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
      <span class="free">updownI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;</span>
      <span class="free">updownI'</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="bound">b</span> <span class="main">;</span>
      downI <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="bound">b</span> <span class="main">;</span>
      sum_array <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">b</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> updownI' <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="free">dm</span> <span class="main">⟹</span> <span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> updownI' <span class="free">d</span> <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>updown' <span class="free">dm</span> <span class="free">lm</span> <span class="free">d</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Suc.hyps <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">sep_auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updownI</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">updownI</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> updownI' <span class="free">dm</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> updownI <span class="main">[</span><span class="operator">sep_heap_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span> gridI <span class="free">a</span> <span class="free">v</span> <span class="main">&gt;</span> updownI <span class="free">a</span> <span class="main">&lt;</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> gridI <span class="free">a</span> <span class="main">(</span>updown <span class="free">dm</span> <span class="free">lm</span> <span class="free">v</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> updown_def updownI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sep_auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>