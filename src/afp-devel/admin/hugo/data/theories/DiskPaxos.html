<div id="DiskPaxos_Model">
<div class="head">
<h1>Theory DiskPaxos_Model</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Disk Paxos Algorithm Specification"</span></span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Model <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is the specification of the Disk Synod algorithm.›</span></span>

<span class="keyword1"><span class="command">typedecl</span></span> InputsOrNi
<span class="keyword1"><span class="command">typedecl</span></span> Disk
<span class="keyword1"><span class="command">typedecl</span></span> Proc

<span class="keyword1"><span class="command">axiomatization</span></span>
  <span class="free">Inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"InputsOrNi set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">NotAnInput</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"InputsOrNi"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">Ballot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="free">IsMajority</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Disk set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  NotAnInput<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NotAnInput</span> <span class="main">∉</span> <span class="free">Inputs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  InputsOrNi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> InputsOrNi set<span class="main">)</span> <span class="main">=</span> <span class="free">Inputs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">NotAnInput</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  Ballot_nzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">Ballot</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  Ballot_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">Ballot</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Ballot</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  Disk_isMajority<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">IsMajority</span><span class="main">(</span>UNIV<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  majorities_intersect<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="free">IsMajority</span><span class="main">(</span><span class="bound">S</span><span class="main">)</span> <span class="main">∧</span> <span class="free">IsMajority</span><span class="main">(</span><span class="bound">T</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="DiskPaxos_Model-ballots_not_zero"><span class="command">lemma</span></span> ballots_not_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Ballot <span class="free">p</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Ballot_nzero
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> Ballot <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> b contr 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Model-majority_nonempty"><span class="command">lemma</span></span> majority_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> majorities_intersect
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">∧</span> IsMajority<span class="main">(</span><span class="main">{}</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">{}</span> <span class="main">∩</span> <span class="main">{}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"IsMajority <span class="main">{}</span> <span class="main">⟹</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AllBallots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">AllBallots</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span>
  DiskBlock <span class="main">=</span> 
    mbal<span class="main">::</span> <span class="quoted">nat</span>
    bal <span class="main">::</span> <span class="quoted">nat</span>
    inp <span class="main">::</span> <span class="quoted">InputsOrNi</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InitDB</span> <span class="main">::</span> <span class="quoted">DiskBlock</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">InitDB</span> <span class="main">=</span> <span class="main">⦇</span> mbal <span class="main">=</span> <span class="main">0</span><span class="main">,</span> bal <span class="main">=</span> <span class="main">0</span><span class="main">,</span> inp <span class="main">=</span> NotAnInput <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span>
  BlockProc <span class="main">=</span>
    block <span class="main">::</span> <span class="quoted">DiskBlock</span>
    proc  <span class="main">::</span> <span class="quoted">Proc</span>
 
<span class="keyword1"><span class="command">record</span></span> 
  state <span class="main">=</span>
    inpt <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> InputsOrNi"</span></span>
    outpt <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> InputsOrNi"</span></span>
    disk <span class="main">::</span> <span class="quoted"><span class="quoted">"Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock"</span></span>
    dblock <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> DiskBlock"</span></span>
    phase <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> nat"</span></span>
    disksWritten <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> Disk set"</span></span>
    blocksRead <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> BlockProc set"</span></span>
  <span class="comment1">(* History Variables *)</span> 
    allInput  <span class="main">::</span> <span class="quoted"><span class="quoted">"InputsOrNi set"</span></span>
    chosen    <span class="main">::</span> <span class="quoted"><span class="quoted">"InputsOrNi"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hasRead</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hasRead</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">.</span> proc <span class="bound">br</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">allRdBlks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> BlockProc set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">allRdBlks</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">d</span><span class="main">.</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">allBlocksRead</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">allBlocksRead</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> block <span class="main">`</span> <span class="main">(</span>allRdBlks <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
      <span class="main">(</span>range <span class="main">(</span>inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⊆</span> Inputs
     <span class="main">&amp;</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> NotAnInput<span class="main">)</span>
     <span class="main">&amp;</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">d</span> <span class="bound">p</span><span class="main">.</span> InitDB<span class="main">)</span>
     <span class="main">&amp;</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">&amp;</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> InitDB<span class="main">)</span>
     <span class="main">&amp;</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span>
     <span class="main">&amp;</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">InitializePhase</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">InitializePhase</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span>disksWritten <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">{}</span><span class="main">)</span>
   <span class="main">&amp;</span> blocksRead <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">StartBallot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">StartBallot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>
   <span class="main">&amp;</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">&amp;</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> Ballot <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> 
         mbal <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">b</span>
       <span class="main">&amp;</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">⦇</span> mbal <span class="main">:=</span> <span class="bound">b</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>
   <span class="main">&amp;</span> InitializePhase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">&amp;</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Phase1or2Write</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Phase1or2Write</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span>
    <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">}</span>
   <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span> <span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> 
   <span class="main">∧</span> disksWritten <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> <span class="main">(</span>disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">}</span><span class="main">)</span>
   <span class="main">∧</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">∧</span> blocksRead <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">=</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Phase1or2ReadThen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Phase1or2ReadThen</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">&amp;</span> mbal<span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
   <span class="main">&amp;</span> blocksRead <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span>
                       <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">⦇</span> block <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span>
                                               proc <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⦈</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
   <span class="main">&amp;</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">&amp;</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">&amp;</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> disksWritten <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Phase1or2ReadElse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Phase1or2ReadElse</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">∧</span> StartBallot <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Phase1or2Read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Phase1or2Read</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
     <span class="main">(</span>Phase1or2ReadThen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
    <span class="main">∨</span> Phase1or2ReadElse <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blocksSeen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">blocksSeen</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> allBlocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonInitBlks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span><span class="quoted"><span class="quoted">"<span class="free">nonInitBlks</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">bs</span> <span class="main">.</span> <span class="bound">bs</span> <span class="main">∈</span> blocksSeen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> inp <span class="bound">bs</span> <span class="main">∈</span> Inputs<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maxBlk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maxBlk</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> nonInitBlks <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> nonInitBlks <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> bal <span class="bound">c</span> <span class="main">≤</span> bal <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EndPhase1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EndPhase1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span>IsMajority <span class="main">{</span><span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
                     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">.</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">1</span>
   <span class="main">∧</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> 
           <span class="main">⦇</span> bal <span class="main">:=</span> mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">,</span>
             inp <span class="main">:=</span> 
              <span class="main">(</span><span class="keyword1">if</span> nonInitBlks <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{}</span>
               <span class="keyword1">then</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
               <span class="keyword1">else</span> inp <span class="main">(</span>maxBlk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
           <span class="main">⦈</span> <span class="main">)</span>
   <span class="main">∧</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">∧</span> InitializePhase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">∧</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EndPhase2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EndPhase2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span>IsMajority <span class="main">{</span><span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
                     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">.</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="numeral">2</span>
   <span class="main">∧</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> inp <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">∧</span> InitializePhase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">∧</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EndPhase1or2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">EndPhase1or2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>EndPhase1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∨</span> EndPhase2 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Fail</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ip</span> <span class="main">∈</span> Inputs<span class="main">.</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="bound">ip</span><span class="main">)</span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">0</span><span class="main">)</span>
   <span class="main">∧</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">=</span> <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> InitDB<span class="main">)</span>
   <span class="main">∧</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> NotAnInput<span class="main">)</span>
   <span class="main">∧</span> InitializePhase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Phase0Read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Phase0Read</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span>
    <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span>
   <span class="main">∧</span> blocksRead <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">:=</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">⦇</span> block <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> proc <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⦈</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">∧</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> disksWritten <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">EndPhase0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">EndPhase0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span>
   <span class="main">∧</span> IsMajority <span class="main">(</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> Ballot <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span>   
       <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> allBlocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> mbal <span class="bound">r</span> <span class="main">&lt;</span> <span class="bound">b</span><span class="main">)</span>
     <span class="main">∧</span> dblock <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> 
                    <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r</span><span class="main">.</span>   <span class="bound">r</span> <span class="main">∈</span> allBlocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> 
                            <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> allBlocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> bal <span class="bound">s</span> <span class="main">≤</span>  bal <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⦇</span> mbal <span class="main">:=</span> <span class="bound">b</span> <span class="main">⦈</span> <span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> InitializePhase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">∧</span> inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Next</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span>
                  StartBallot <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span>
                <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d</span><span class="main">.</span>   Phase0Read <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span> <span class="bound">d</span>
                       <span class="main">∨</span> Phase1or2Write <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span> <span class="bound">d</span>
                       <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">≠</span> <span class="bound">p</span> <span class="main">∧</span> Phase1or2Read <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
                <span class="main">∨</span> EndPhase1or2 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span>
                <span class="main">∨</span> Fail <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span>
                <span class="main">∨</span> EndPhase0 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the following, for each action or state {\em name} we name
  {\em Hname} the corresponding action that includes 
  the history part of the HNext action or state predicate that includes 
  history variables.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInit</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    <span class="main">(</span>Init <span class="free"><span class="bound"><span class="entity">s</span></span></span>
   <span class="main">&amp;</span> chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> NotAnInput
   <span class="main">&amp;</span> allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> range <span class="main">(</span>inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹HNextPart is the part of the Next action 
        that is concerned with history variables.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HNextPart</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">=&gt;</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HNextPart</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span>
    <span class="main">(</span>chosen <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> 
       <span class="main">(</span><span class="keyword1">if</span> chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> NotAnInput <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span> <span class="main">=</span> NotAnInput <span class="main">)</span>
            <span class="keyword1">then</span> chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span>
            <span class="keyword1">else</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> outpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput<span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> allInput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">(</span>range <span class="main">(</span>inpt <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HNext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HNext</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span>
     <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>
   <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We add HNextPart to every action (rather than proving that Next 
  maintains the HInv invariant) to make proofs easier. 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HPhase1or2ReadThen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HPhase1or2ReadThen</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>Phase1or2ReadThen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HEndPhase1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HEndPhase1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>EndPhase1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HStartBallot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HStartBallot</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>StartBallot <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HPhase1or2Write</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HPhase1or2Write</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span>Phase1or2Write <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HPhase1or2ReadElse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HPhase1or2ReadElse</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>Phase1or2ReadElse <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HEndPhase2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HEndPhase2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>EndPhase2 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HFail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HFail</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>Fail <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>  <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HPhase0Read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HPhase0Read</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span>Phase0Read <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">HEndPhase0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HEndPhase0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>EndPhase0 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> HNextPart <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since these definitions are the conjunction of two other definitions 
  declaring them as simplification rules should be harmless.
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> HPhase1or2ReadThen_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HPhase1or2ReadElse_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HEndPhase1_def  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HStartBallot_def  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HPhase1or2Write_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HEndPhase2_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HFail_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HPhase0Read_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> HEndPhase0_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DiskPaxos_Inv1">
<div class="head">
<h1>Theory DiskPaxos_Inv1</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Proof of Disk Paxos' Invariant"</span></span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Inv1 <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Model.html">DiskPaxos_Model</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 1›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is just a type Invariant.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Inv1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
     inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∈</span> Inputs
   <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">≤</span> <span class="numeral">3</span>
   <span class="main">∧</span> finite <span class="main">(</span>allRdBlks <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span>Inv1 <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">∧</span> allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⊆</span> Inputs<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> HInv1_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We added the assertion that the set $allRdBlks p$ is finite
  for every process $p$; one may therefore choose a block with a
  maximum ballot number in action $EndPhase1$.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  With the following the lemma, it will be enough to prove 
  Inv1 s' for every action, without taking the history variables in account.
›</span></span>

<span class="keyword1" id="DiskPaxos_Inv1-HNextPart_Inv1"><span class="command">lemma</span></span> HNextPart_Inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HInv1 <span class="free">s</span><span class="main">;</span> HNextPart <span class="free">s</span> <span class="free">s'</span><span class="main">;</span> Inv1 <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv1 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def Inv1_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_HInv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟶</span> HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Inv1_def Init_def allRdBlks_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv1-allRdBlks_finite"><span class="command">lemma</span></span> allRdBlks_finite<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">p</span> <span class="main">⊆</span> insert <span class="free">bk</span> <span class="main">(</span>allRdBlks <span class="free">s</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> finite <span class="main">(</span>allRdBlks <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span>
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> finite <span class="main">(</span>allRdBlks <span class="free">s</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>allRdBlks <span class="free">s</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> asm 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>allRdBlks <span class="free">s'</span> <span class="skolem">pp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹we focus on the last conjunct of Inv1›</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">p</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">⦇</span>block <span class="main">=</span> disk <span class="free">s</span> <span class="free">d</span> <span class="free">q</span><span class="main">,</span> proc <span class="main">=</span> <span class="free">q</span><span class="main">⦈</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def allRdBlks_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> finite <span class="main">(</span>allRdBlks <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> allRdBlks_finite<span class="main">)</span>
  <span class="comment1">― ‹the others conjuncts are trivial›</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def Phase1or2ReadThen_def HNextPart_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">from</span></span> inv1 act 
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Inv1_def EndPhase1_def InitializePhase_def allRdBlks_def<span class="main">)</span>
     <span class="keyword1"><span class="command">with</span></span> inv1 act 
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">from</span></span> inv1 act 
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def StartBallot_def InitializePhase_def allRdBlks_def<span class="main">)</span>
     <span class="keyword1"><span class="command">with</span></span> inv1 act 
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> inv1 act 
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def Phase1or2Write_def allRdBlks_def<span class="main">)</span>
 <span class="keyword1"><span class="command">with</span></span> inv1 act 
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HStartBallot_HInv1<span class="main">[</span><span class="operator">OF</span> inv1<span class="main">]</span> act
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv1 act 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def EndPhase2_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 act 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv1 act 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def Fail_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 act <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="comment1">― ‹we focus on the last conjunct of Inv1›</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">pp</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">pp</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">pp</span> <span class="main">∪</span> <span class="main">{</span><span class="main">⦇</span>block <span class="main">=</span> disk <span class="free">s</span> <span class="free">d</span> <span class="free">p</span><span class="main">,</span> proc <span class="main">=</span> <span class="free">p</span><span class="main">⦈</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def allRdBlks_def
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> finite <span class="main">(</span>allRdBlks <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> allRdBlks_finite<span class="main">)</span>
  <span class="comment1">― ‹the others conjuncts are trivial›</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv1 act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def EndPhase0_def allRdBlks_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HNextPart_Inv1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> HInv1_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$HInv1$ is an invariant of $HNext$›</span></span>
 
<span class="keyword1" id="DiskPaxos_Inv1-I2a"><span class="command">lemma</span></span> I2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span>
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv1<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv1<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv1<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv1
                HPhase1or2ReadElse_HInv1<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv1
                HEndPhase2_HInv1<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv1<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv1<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DiskPaxos_Inv2">
<div class="head">
<h1>Theory DiskPaxos_Inv2</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Inv2 <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Inv1.html">DiskPaxos_Inv1</a> <span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 2›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The second invariant is split into three main conjuncts called
  $Inv2a$, $Inv2b$, and $Inv2c$. The main difficulty is in proving 
  the preservation of the first conjunct.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rdBy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> BlockProc set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rdBy</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">br</span> <span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∧</span> proc <span class="bound">br</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blocksOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blocksOf</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
      <span class="main">{</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>
   <span class="main">∪</span> <span class="main">{</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">|</span> <span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> UNIV<span class="main">}</span>
   <span class="main">∪</span> <span class="main">{</span>block <span class="bound">br</span> <span class="main">|</span> <span class="bound">br</span> <span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">q</span> <span class="bound">d</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">allBlocks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> DiskBlock set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">allBlocks</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> blocksOf <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2a_innermost</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> DiskBlock <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Inv2a_innermost</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">=</span>
    <span class="main">(</span>mbal <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">∈</span> <span class="main">(</span>Ballot <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>
   <span class="main">∧</span> bal <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">∈</span> <span class="main">(</span>Ballot <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>
   <span class="main">∧</span> <span class="main">(</span>bal <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>inp <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">=</span> NotAnInput<span class="main">)</span>
   <span class="main">∧</span> bal <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">≤</span> mbal <span class="free"><span class="bound"><span class="entity">bk</span></span></span>
   <span class="main">∧</span> inp <span class="free"><span class="bound"><span class="entity">bk</span></span></span> <span class="main">∈</span> <span class="main">(</span>allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2a_inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inv2a_inner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">bk</span> <span class="main">∈</span> blocksOf <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> Inv2a_innermost  <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">bk</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inv2a</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> Inv2a_inner <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2b_inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Inv2b_inner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟶</span>
        <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⟶</span>
        <span class="main">(</span>  <span class="main">(</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∈</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">¬</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inv2b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> Inv2b_inner <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2c_inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Inv2c_inner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span>
       <span class="main">(</span>  dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> InitDB
        <span class="main">∧</span> disksWritten <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{}</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span><span class="main">.</span>
              proc <span class="bound">br</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> block <span class="bound">br</span> <span class="main">=</span> disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span>
        <span class="main">(</span>  mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free"><span class="bound"><span class="entity">p</span></span></span>
         <span class="main">∧</span> bal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">d</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span><span class="main">.</span>
               mbal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">⟶</span> bal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">else</span> NotAnInput<span class="main">)</span>
   <span class="main">∧</span> chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>   inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span>
          <span class="main">∧</span> <span class="main">(</span>chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> NotAnInput <span class="main">⟶</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inv2c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inv2c</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> Inv2c_inner <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>Inv2a <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> Inv2b <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> Inv2c <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 2 a›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_Inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟶</span> Inv2a <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def Inv2a_def Inv2a_inner_def 
                   Inv2a_innermost_def rdBy_def blocksOf_def 
                   InitDB_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  For every action we define a action-$blocksOf$ lemma. We have two cases: either 
the new $blocksOf$ is included in the old $blocksOf$, or the new $blocksOf$ is included 
in the old $blocksOf$ union the new $dblock$. In the former case the assumption $inv$ will 
imply the thesis. In the latter, we just have to prove the innermost predicate for 
the particular case of the new $dblock$. 
This particular case is proved in lemma action-$Inv2a$-$dblock$.  
›</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HPhase1or2ReadThen_blocksOf"><span class="command">lemma</span></span> HPhase1or2ReadThen_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">r</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">pp</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> inv HPhase1or2ReadThen_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-InitializePhase_rdBy"><span class="command">lemma</span></span> InitializePhase_rdBy<span class="main">:</span>
  <span class="quoted"><span class="quoted">"InitializePhase <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> rdBy <span class="free">s'</span> <span class="free">pp</span> <span class="free">qq</span> <span class="free">dd</span> <span class="main">⊆</span> rdBy <span class="free">s</span> <span class="free">pp</span> <span class="free">qq</span> <span class="free">dd</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitializePhase_def rdBy_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv2-HStartBallot_blocksOf"><span class="command">lemma</span></span> HStartBallot_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def blocksOf_def
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> InitializePhase_rdBy<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv2-HStartBallot_Inv2a_dblock"><span class="command">lemma</span></span> HStartBallot_Inv2a_dblock<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> mbal'<span class="main">:</span> <span class="quoted"><span class="quoted">"mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act 
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> inp'<span class="main">:</span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bal' inv2a
  <span class="keyword1"><span class="command">have</span></span> bal_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"allInput <span class="free">s</span> <span class="main">⊆</span> allInput <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> mbal' bal' inp' bal_mbal act inv2a 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HStartBallot_Inv2a_dblock_q"><span class="command">lemma</span></span> HStartBallot_Inv2a_dblock_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv2a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2a_dblock<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> act inv2a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HNextPart_def 
      InitializePhase_def Inv2a_innermost_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> oldBlks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span> <span class="main">⟶</span> Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bk HStartBallot_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> inv_q_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def Inv2a_innermost_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act inv bk_dblock
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2a_dblock_q<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk_in_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> oldBlks
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">with</span></span> act 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HNextPart_def 
                        InitializePhase_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HPhase1or2Write_blocksOf"><span class="command">lemma</span></span> HPhase1or2Write_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">r</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv bk HPhase1or2Write_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> inp_q_bk<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span>     <span class="quoted"><span class="quoted">"HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2a<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase2_blocksOf"><span class="command">lemma</span></span> HEndPhase2_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def blocksOf_def 
               <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> InitializePhase_rdBy<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv bk HEndPhase2_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> inp_q_bk<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HFail_blocksOf"><span class="command">lemma</span></span> HFail_blocksOf<span class="main">:</span>
   <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>  <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def blocksOf_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> InitializePhase_rdBy<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv2-HFail_Inv2a_dblock_q"><span class="command">lemma</span></span> HFail_Inv2a_dblock_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> InitDB"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> True 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitDB_def Inv2a_innermost_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HNextPart_def 
      InitializePhase_def Inv2a_innermost_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_Inv2a<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HFail_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> dblock_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> inv_q_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def Inv2a_innermost_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act bk_dblock
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HFail_Inv2a_dblock_q<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk_in_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HNextPart_def 
        InitializePhase_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HPhase0Read_blocksOf"><span class="command">lemma</span></span> HPhase0Read_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def InitializePhase_def 
                       blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv bk HPhase0Read_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> inp_q_bk<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_blocksOf"><span class="command">lemma</span></span> HEndPhase0_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">" HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def blocksOf_def 
                  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> InitializePhase_rdBy<span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_blocksRead"><span class="command">lemma</span></span> HEndPhase0_blocksRead<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> majority_nonempty<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$EndPhase0$ has the additional difficulty of having a choose expression. We
prove that there exists an $x$ such that the predicate of the choose expression holds,
and then apply $someI$: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> someI<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_some"><span class="command">lemma</span></span> HEndPhase0_some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span>  <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    inv1<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span>    <span class="bound">b</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span> 
                   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">t</span> <span class="main">≤</span> bal <span class="bound">b</span><span class="main">)</span>
          <span class="main">)</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> 
             bal <span class="bound">t</span> <span class="main">≤</span> bal <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span>    <span class="bound">b</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span> 
                                  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">t</span> <span class="main">≤</span> bal <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bal <span class="main">`</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def allBlocksRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase0_blocksRead<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?S</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> Max <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mblk</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"   <span class="skolem">mblk</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span> 
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">t</span> <span class="main">≤</span> bal <span class="skolem">mblk</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">mblk</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_dblock_allBlocksRead"><span class="command">lemma</span></span> HEndPhase0_dblock_allBlocksRead<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span>  <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    inv1<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⦇</span>mbal<span class="main">:=</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">`</span> allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> act HEndPhase0_some<span class="main">[</span><span class="operator">OF</span> act inv1<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv2-HNextPart_allInput_or_NotAnInput"><span class="command">lemma</span></span> HNextPart_allInput_or_NotAnInput<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HNextPart <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">from</span></span> act
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"allInput <span class="free">s'</span> <span class="main">=</span> allInput <span class="free">s</span> <span class="main">∪</span> <span class="main">(</span>range <span class="main">(</span>inpt <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def<span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword1"><span class="command">from</span></span> inv2a
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_Inv2a_allBlocksRead"><span class="command">lemma</span></span> HEndPhase0_Inv2a_allBlocksRead<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⦇</span>mbal<span class="main">:=</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">`</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> 
          Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> mbal'<span class="main">:</span> <span class="quoted"><span class="quoted">"mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2c act
  <span class="keyword1"><span class="command">have</span></span> allproc_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> proc <span class="bound">br</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> allBlocks_inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_inner_def allBlocksRead_def 
                       allRdBlks_def blocksOf_def rdBy_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">bk</span>
    <span class="keyword3"><span class="command">assume</span></span> bk_in_blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv2a_bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>     <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span> 
                           <span class="main">∪</span> <span class="main">{</span>block <span class="bound">br</span> <span class="main">|</span><span class="bound">br</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">)</span> 
                         <span class="main">∧</span> proc <span class="bound">br</span> <span class="main">=</span> <span class="free">p</span><span class="main">}</span><span class="main">.</span> Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> allproc_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proc <span class="skolem">bk</span> <span class="main">=</span> <span class="free">p</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bk_in_blocksRead inv2a_bk
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>block <span class="skolem">bk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> mbal'_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> mbal <span class="bound">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span>  mbal' allBlocks_inv2a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> t_blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> allBlocks_inv2a
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">t</span> <span class="main">≤</span> mbal <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> t_blocksRead mbal'_gt 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mbal <span class="skolem">t</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">t</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_Inv2a_dblock"><span class="command">lemma</span></span> HEndPhase0_Inv2a_dblock<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act inv2a inv2c
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⦇</span>mbal<span class="main">:=</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">`</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> 
                  Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv2a_allBlocksRead<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⦇</span>mbal<span class="main">:=</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span> <span class="main">`</span> allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_dblock_allBlocksRead<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword1"><span class="command">have</span></span> inv2_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_allInput_or_NotAnInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2_dblock
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase0_Inv2a_dblock_q"><span class="command">lemma</span></span> HEndPhase0_Inv2a_dblock_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv2a inv2c inv1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv2a_dblock<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> inv_q_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_inner_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HNextPart_def 
      InitializePhase_def Inv2a_innermost_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dblock_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv 
    <span class="keyword1"><span class="command">have</span></span> inv_q<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act inv1 inv2c inv_q
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>HEndPhase0_Inv2a_dblock_q<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk_in_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HNextPart_def
          InitializePhase_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase1_blocksOf"><span class="command">lemma</span></span> HEndPhase1_blocksOf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def blocksOf_def
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> InitializePhase_rdBy<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv2-maxBlk_in_nonInitBlks"><span class="command">lemma</span></span> maxBlk_in_nonInitBlks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"   maxBlk <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span> 
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">c</span> <span class="main">≤</span> bal <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nibals_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bal <span class="main">`</span> <span class="main">(</span>nonInitBlks <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> inv1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>allRdBlks <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>blocksSeen <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksSeen_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nonInitBlks <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonInitBlks_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">`</span> nonInitBlks <span class="free">s</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nibals_finite
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?S</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bb</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">bb</span> <span class="main">≤</span> Max <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">mb</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bb</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">bb</span> <span class="main">≤</span> <span class="bound">mb</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mblk</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"   <span class="skolem">mblk</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span> 
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">c</span> <span class="main">≤</span> bal <span class="skolem">mblk</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">mblk</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">b</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBlk_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-blocksOf_nonInitBlks"><span class="command">lemma</span></span> blocksOf_nonInitBlks<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">bk</span><span class="main">.</span> <span class="bound">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">bk</span><span class="main">)</span> 
       <span class="main">⟹</span> <span class="free">bk</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">bk</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def nonInitBlks_def 
                    blocksSeen_def allBlocksRead_def rdBy_def<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">blast</span><span class="main">)</span> 

<span class="keyword1" id="DiskPaxos_Inv2-maxBlk_allInput"><span class="command">lemma</span></span> maxBlk_allInput<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mblk<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBlk <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">bk</span><span class="main">.</span> <span class="bound">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="bound">p</span> 
                       <span class="main">⟶</span> inp <span class="bound">bk</span> <span class="main">∈</span> <span class="main">(</span>allInput <span class="free">s</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mblk NotAnInput
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonInitBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mblk blocksOf_nonInitBlks<span class="main">[</span><span class="operator">OF</span> blocks<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase1_dblock_allInput"><span class="command">lemma</span></span> HEndPhase1_dblock_allInput<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> inp'<span class="main">:</span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> inpt<span class="main">:</span> <span class="quoted"><span class="quoted">"inpt <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> allInput <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonInitBlks <span class="free">s</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> inp <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ni<span class="main">:</span> <span class="quoted"><span class="quoted">"nonInitBlks <span class="free">s</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBlk <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def maxBlk_in_nonInitBlks<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> inv2
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> maxBlk_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> act inpt
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase1_Inv2a_dblock"><span class="command">lemma</span></span> HEndPhase1_Inv2a_dblock<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv1 act <span class="keyword1"><span class="command">have</span></span> inv1'<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2
  <span class="keyword1"><span class="command">have</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv2c 
  <span class="keyword1"><span class="command">have</span></span> mbal'<span class="main">:</span> <span class="quoted"><span class="quoted">"mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act 
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act inv1 inv2
  <span class="keyword1"><span class="command">have</span></span> inp'<span class="main">:</span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_dblock_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> inv1' NotAnInput
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> act inv2a
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def EndPhase1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HEndPhase1_Inv2a_dblock_q"><span class="command">lemma</span></span> HEndPhase1_Inv2a_dblock_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv inv2c inv1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv2a_dblock<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> inv_q_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">q</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HNextPart_def 
      InitializePhase_def Inv2a_innermost_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_Inv2a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk_in_bks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase1_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dblock_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act inv1 inv2c inv
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv2a_dblock_q<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk_in_blocks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">bk</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HNextPart_def
          InitializePhase_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 2 b›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
Invariant 2b is proved automatically, given that 
we expand the definitions involved.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_Inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟶</span> Inv2b <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def Inv2b_def 
                   Inv2b_inner_def InitDB_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span> <span class="main">⟧</span>
   <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def Inv2b_def
                   Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span>
   <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>StartBallot_def InitializePhase_def
                   Inv2b_def Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟧</span>
   <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def Inv2b_def
                    Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span> <span class="main">⟧</span>
   <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def StartBallot_def hasRead_def
                   InitializePhase_def Inv2b_def Inv2b_inner_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def 
                   Inv2b_def Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span>
   <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def
                   Inv2b_def Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def 
                   Inv2b_def Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def Inv2b_def 
                   Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_Inv2b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Inv2b <span class="free">s</span><span class="main">;</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span> Inv2b <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
                   Inv2b_def Inv2b_inner_def hasRead_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 2 c›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_Inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟶</span> Inv2c <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def Inv2c_def Inv2c_inner_def<span class="main">)</span>


<span class="keyword1" id="DiskPaxos_Inv2-HNextPart_Inv2c_chosen"><span class="command">lemma</span></span> HNextPart_Inv2c_chosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  hnp<span class="main">:</span> <span class="quoted"><span class="quoted">"HNextPart <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                      <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                      <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inp_dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hnp outpt' inp_dblk inv2c
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def Inv2c_def Inv2c_inner_def
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HNextPart_chosen"><span class="command">lemma</span></span> HNextPart_chosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hnp<span class="main">:</span> <span class="quoted"><span class="quoted">"HNextPart <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> hnp
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">pa</span>
  <span class="keyword3"><span class="command">assume</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span> <span class="main">≠</span> NotAnInput"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    o2<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput<span class="main">)</span> <span class="main">=</span> NotAnInput"</span></span>
  <span class="keyword1"><span class="command">from</span></span> o1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput<span class="main">)</span> <span class="main">≠</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> o2
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">pa</span> <span class="main">=</span> NotAnInput"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv2-HNextPart_allInput"><span class="command">lemma</span></span> HNextPart_allInput<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HNextPart <span class="free">s</span> <span class="free">s'</span><span class="main">;</span> Inv2c <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def Inv2c_def Inv2c_inner_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span>   inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> 
            <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt' chosen' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> mbal'<span class="main">:</span> <span class="quoted"><span class="quoted">"mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv phase
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv phase phase'
  <span class="keyword1"><span class="command">have</span></span> blks'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> 
                     mbal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span>   inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> 
                    <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput 
                              <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> phase' mbal' bal' outpt' chosen' act inv blks'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def 
                    Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput 
                     <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt' chosen' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_Inv2c<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="main">⟦</span> Inv2c <span class="free">s</span><span class="main">;</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span><span class="main">;</span> Inv2a <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> Inv2c <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2c<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2a act inv1
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> mbal'<span class="main">:</span> <span class="quoted"><span class="quoted">"mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> blks'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> 
                        mbal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span>    inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> 
                    <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput 
                            <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mbal' bal' blks' outpt' chosen' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase2_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span>    inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> 
                    <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput
                            <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt' chosen' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HFail_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput 
                     <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt' chosen' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase0Read_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span>   inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> 
                    <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput 
                             <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt' chosen' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_Inv2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2a act inv1
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> mbal'<span class="main">:</span> <span class="quoted"><span class="quoted">"mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> blks'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> 
                         mbal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> phase <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> <span class="numeral">3</span> 
                                     <span class="keyword1">then</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> 
                                     <span class="keyword1">else</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a'
  <span class="keyword1"><span class="command">have</span></span> dblk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                      Inv2a_innermost_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv outpt'
  <span class="keyword1"><span class="command">have</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∪</span> <span class="main">{</span>NotAnInput<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_Inv2c_chosen<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv
  <span class="keyword1"><span class="command">have</span></span> allinp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> inpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s'</span> <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s'</span> <span class="main">=</span> NotAnInput 
                     <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HNextPart_chosen HNextPart_allInput <span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mbal' bal' blks' outpt' chosen' act inv 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
                      Inv2c_def Inv2c_inner_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_HInv2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟹</span> HInv2 <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> HInit_Inv2a HInit_Inv2b HInit_Inv2c
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$HInv1 \wedge HInv2$ is an invariant of $HNext$.›</span></span> 

<span class="keyword1" id="DiskPaxos_Inv2-I2b"><span class="command">lemma</span></span> I2b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv2 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2a<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_Inv2a<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_Inv2a
                     HPhase1or2ReadElse_Inv2a<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_Inv2a<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def Inv2c_def
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv2a
                     HEndPhase2_Inv2a<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_Inv2a<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv2a<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2b<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_Inv2b<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_Inv2b<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_Inv2b
                   HPhase1or2ReadElse_Inv2b<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv2b HEndPhase2_Inv2b<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  HFail_Inv2b HEndPhase0_Inv2b<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv2c<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_Inv2c<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_Inv2c<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_Inv2c
                   HPhase1or2ReadElse_Inv2c<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv2c
                   HEndPhase2_Inv2c<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_Inv2c<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv2c<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DiskPaxos_Inv3">
<div class="head">
<h1>Theory DiskPaxos_Inv3</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Inv3 <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Inv2.html">DiskPaxos_Inv2</a>  <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 3›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This invariant says that if two processes have read each other's block 
  from disk $d$ during their current phases, then at least one of them 
  has read the other's current block.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv3_L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv3_L</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span>  <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>
                     <span class="main">∧</span> phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>      
                     <span class="main">∧</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>
                     <span class="main">∧</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv3_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv3_R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="main">⦇</span>block<span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> proc<span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">⦈</span> <span class="main">∈</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>
                     <span class="main">∨</span> <span class="main">⦇</span>block<span class="main">=</span> dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> proc<span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⦈</span> <span class="main">∈</span> blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv3_inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> Proc <span class="main">⇒</span> Disk <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv3_inner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span>HInv3_L <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟶</span> HInv3_R <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> HInv3_inner <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Proofs of Invariant 3›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_HInv3<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟹</span> HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def HInv3_def 
               HInv3_inner_def HInv3_L_def HInv3_R_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-InitPhase_HInv3_p"><span class="command">lemma</span></span> InitPhase_HInv3_p<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> InitializePhase <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitializePhase_def HInv3_inner_def 
                    hasRead_def HInv3_L_def HInv3_R_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-InitPhase_HInv3_q"><span class="command">lemma</span></span> InitPhase_HInv3_q<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> InitializePhase <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitializePhase_def HInv3_inner_def 
                    hasRead_def HInv3_L_def HInv3_R_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-HInv3_L_sym"><span class="command">lemma</span></span> HInv3_L_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_L <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟹</span> HInv3_L <span class="free">s</span> <span class="free">q</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_L_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-HInv3_R_sym"><span class="command">lemma</span></span> HInv3_R_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟹</span> HInv3_R <span class="free">s</span> <span class="free">q</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_R_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Phase1or2ReadThen_HInv3_pq"><span class="command">lemma</span></span> Phase1or2ReadThen_HInv3_pq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span>  <span class="quoted"><span class="quoted">"Phase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  inv_L'<span class="main">:</span>  <span class="quoted"><span class="quoted">"HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>      pq<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2b<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv_L' act pq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="free">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv3_L_def 
            hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2b
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="free">d</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def Inv2b_inner_def 
             hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv3_def 
                       HInv3_inner_def HInv3_R_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv3-Phase1or2ReadThen_HInv3_hasRead"><span class="command">lemma</span></span> Phase1or2ReadThen_HInv3_hasRead<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">pp</span> <span class="free">dd</span> <span class="free">qq</span><span class="main">;</span> 
     Phase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span><span class="main">;</span> 
     <span class="free">pp</span><span class="main">≠</span><span class="free">p</span> <span class="main">∨</span> <span class="free">qq</span><span class="main">≠</span><span class="free">q</span> <span class="main">∨</span> <span class="free">dd</span><span class="main">≠</span><span class="free">d</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">pp</span> <span class="free">dd</span> <span class="free">qq</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def Phase1or2ReadThen_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span>  <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span>  <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>      pq<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2b<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"HInv3 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def HInv3_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>
  <span class="keyword3"><span class="command">assume</span></span> h3l'<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_L <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"HInv3_L <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def HInv3_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act h3l'
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_R_def HInv3_L_def 
                          Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">assume</span></span> nh3l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> HInv3_L <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" HInv3_R <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">pp</span><span class="main">=</span><span class="free">p</span> <span class="main">∧</span> <span class="skolem">qq</span><span class="main">=</span><span class="free">q</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">pp</span><span class="main">=</span><span class="free">q</span> <span class="main">∧</span> <span class="skolem">qq</span><span class="main">=</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">dd</span><span class="main">=</span><span class="free">d</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> act pq inv2b h3l' HInv3_L_sym<span class="main">[</span><span class="operator">OF</span> h3l'<span class="main">]</span>  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_HInv3_pq HInv3_R_sym<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> nh3l h3l' act
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>hasRead <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">dd</span> <span class="skolem">qq</span> <span class="main">∨</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="skolem">qq</span> <span class="skolem">dd</span> <span class="skolem">pp</span><span class="main">)</span> 
            <span class="main">∧</span> hasRead <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">dd</span> <span class="skolem">qq</span> <span class="main">∧</span> hasRead <span class="free">s'</span> <span class="skolem">qq</span> <span class="skolem">dd</span> <span class="skolem">pp</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_L_def Phase1or2ReadThen_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> act False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_HInv3_hasRead<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv3-StartBallot_HInv3_p"><span class="command">lemma</span></span> StartBallot_HInv3_p<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> 
          <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-StartBallot_HInv3_q"><span class="command">lemma</span></span> StartBallot_HInv3_q<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span>
           <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-StartBallot_HInv3_nL"><span class="command">lemma</span></span> StartBallot_HInv3_nL<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> <span class="main">¬</span>HInv3_L <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span> 
           <span class="main">⟹</span> <span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def 
                      HInv3_L_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-StartBallot_HInv3_R"><span class="command">lemma</span></span> StartBallot_HInv3_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_R <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
              <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def 
                    HInv3_R_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-StartBallot_HInv3_t"><span class="command">lemma</span></span> StartBallot_HInv3_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> StartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                <span class="main">⟹</span> HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> StartBallot_HInv3_nL StartBallot_HInv3_R<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-StartBallot_HInv3"><span class="command">lemma</span></span> StartBallot_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"StartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="free">p</span> <span class="main">∨</span> <span class="free">t</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> StartBallot_HInv3_p StartBallot_HInv3_q<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> StartBallot_HInv3_t<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> StartBallot_HInv3<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span><span class="main">;</span> HInv3 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def HInv3_def 
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> StartBallot_HInv3<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" HInv3_inner <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"HInv3_L <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def HInv3_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def HInv3_R_def 
                      Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_L_def hasRead_def Phase1or2Write_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase1_HInv3_p"><span class="command">lemma</span></span> EndPhase1_HInv3_p<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase1_HInv3_q"><span class="command">lemma</span></span> EndPhase1_HInv3_q<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase1_HInv3_nL"><span class="command">lemma</span></span> EndPhase1_HInv3_nL<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> <span class="main">¬</span>HInv3_L <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                    <span class="main">⟹</span> <span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def 
                    HInv3_L_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase1_HInv3_R"><span class="command">lemma</span></span> EndPhase1_HInv3_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_R <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                      <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def
                    HInv3_R_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase1_HInv3_t"><span class="command">lemma</span></span> EndPhase1_HInv3_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                <span class="main">⟹</span> HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase1_HInv3_nL 
                   EndPhase1_HInv3_R<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase1_HInv3"><span class="command">lemma</span></span> EndPhase1_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"EndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="free">p</span> <span class="main">∨</span> <span class="free">t</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase1_HInv3_p EndPhase1_HInv3_q<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase1_HInv3_t<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase1_HInv3<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase2_HInv3_p"><span class="command">lemma</span></span> EndPhase2_HInv3_p<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase2_HInv3_q"><span class="command">lemma</span></span> EndPhase2_HInv3_q<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase2_HInv3_nL"><span class="command">lemma</span></span> EndPhase2_HInv3_nL<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> <span class="main">¬</span>HInv3_L <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                     <span class="main">⟹</span> <span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def
                    HInv3_L_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase2_HInv3_R"><span class="command">lemma</span></span> EndPhase2_HInv3_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_R <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                     <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def
                    HInv3_R_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase2_HInv3_t"><span class="command">lemma</span></span> EndPhase2_HInv3_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                    <span class="main">⟹</span> HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase2_HInv3_nL EndPhase2_HInv3_R<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase2_HInv3"><span class="command">lemma</span></span> EndPhase2_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="free">p</span> <span class="main">∨</span> <span class="free">t</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase2_HInv3_p EndPhase2_HInv3_q<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase2_HInv3_t<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase2_HInv3<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Fail_HInv3_p"><span class="command">lemma</span></span> Fail_HInv3_p<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Fail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Fail_HInv3_q"><span class="command">lemma</span></span> Fail_HInv3_q<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Fail <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Fail_HInv3_nL"><span class="command">lemma</span></span> Fail_HInv3_nL<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Fail <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> <span class="main">¬</span>HInv3_L <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span> 
             <span class="main">⟹</span> <span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def
                    HInv3_L_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Fail_HInv3_R"><span class="command">lemma</span></span> Fail_HInv3_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Fail <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_R <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
             <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def
                    HInv3_R_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Fail_HInv3_t"><span class="command">lemma</span></span> Fail_HInv3_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Fail <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
              <span class="main">⟹</span> HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fail_HInv3_nL Fail_HInv3_R<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-Fail_HInv3"><span class="command">lemma</span></span> Fail_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"Fail <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="free">p</span> <span class="main">∨</span> <span class="free">t</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fail_HInv3_p Fail_HInv3_q<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fail_HInv3_t<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Fail_HInv3<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" HInv3_inner <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"HInv3_L <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def HInv3_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def HInv3_R_def Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="skolem">pp</span> <span class="skolem">qq</span> <span class="skolem">dd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_L_def hasRead_def Phase0Read_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase0_HInv3_p"><span class="command">lemma</span></span> EndPhase0_HInv3_p<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span> 
              <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase0_HInv3_q"><span class="command">lemma</span></span> EndPhase0_HInv3_q<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span><span class="main">;</span> HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span> <span class="main">⟧</span>
              <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> InitPhase_HInv3_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase0_HInv3_nL"><span class="command">lemma</span></span> EndPhase0_HInv3_nL<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> <span class="main">¬</span>HInv3_L <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
               <span class="main">⟹</span> <span class="main">¬</span>HInv3_L <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
                    HInv3_L_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase0_HInv3_R"><span class="command">lemma</span></span> EndPhase0_HInv3_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_R <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                <span class="main">⟹</span> HInv3_R <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
                    HInv3_R_def hasRead_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase0_HInv3_t"><span class="command">lemma</span></span> EndPhase0_HInv3_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span><span class="main">;</span> HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span><span class="free">p</span><span class="main">;</span> <span class="free">t</span><span class="main">≠</span> <span class="free">q</span> <span class="main">⟧</span>
                 <span class="main">⟹</span> HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase0_HInv3_nL EndPhase0_HInv3_R<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv3-EndPhase0_HInv3"><span class="command">lemma</span></span> EndPhase0_HInv3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>        <span class="quoted"><span class="quoted">"HInv3_inner <span class="free">s'</span> <span class="free">p</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">=</span><span class="free">p</span> <span class="main">∨</span> <span class="free">t</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def 
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase0_HInv3_p EndPhase0_HInv3_q<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_inner_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase0_HInv3_t<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv3 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv3 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase0_HInv3<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$HInv1 \wedge HInv2 \wedge HInv3$ is an invariant of $HNext$.›</span></span>

<span class="keyword1" id="DiskPaxos_Inv3-I2c"><span class="command">lemma</span></span> I2c<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s</span> <span class="main">∧</span> HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv3<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv3<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv3<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def HInv2_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv3
                 HPhase1or2ReadElse_HInv3<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv3
                 HEndPhase2_HInv3<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv3<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv3<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DiskPaxos_Inv4">
<div class="head">
<h1>Theory DiskPaxos_Inv4</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Inv4 <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Inv2.html">DiskPaxos_Inv2</a>  <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 4›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This invariant expresses relations among $mbal$ and $bal$ values of a 
  processor and of its disk blocks. 
  $HInv4a$ asserts that, when $p$ is not recovering from a failure, its 
  $mbal$ value is at least as large as the $bal$ field of any of its blocks,
  and at least as large as the $mbal$ field of its block on some disk in
  any majority set. 
  $HInv4b$ conjunct asserts that, in phase 1, its $mbal$ value is actually 
  greater than the $bal$ field of any of its blocks. 
  $HInv4c$ asserts that, in phase 2, its $bal$ value is the $mbal$ field 
  of all its blocks on some majority set of disks. 
  $HInv4d$ asserts that the $bal$ field of any of its blocks is at most as 
  large as the $mbal$ field of all its disk blocks on some majority set of disks.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">MajoritySet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Disk set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MajoritySet</span> <span class="main">=</span> <span class="main">{</span><span class="bound">D</span><span class="main">.</span> IsMajority<span class="main">(</span><span class="bound">D</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv4a1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">bk</span> <span class="main">∈</span> blocksOf <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> bal <span class="bound">bk</span>  <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4a2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv4a2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">D</span> <span class="main">∈</span> MajoritySet<span class="main">.</span><span class="main">(</span><span class="main">∃</span><span class="bound">d</span> <span class="main">∈</span> <span class="bound">D</span><span class="main">.</span>  mbal<span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
                                           <span class="main">∧</span> bal<span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv4a</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> HInv4a1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> HInv4a2 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv4b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">bk</span> <span class="main">∈</span> blocksOf <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv4c</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv4d</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">bk</span> <span class="main">∈</span> blocksOf <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv4</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> HInv4a <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∧</span> HInv4b <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∧</span> HInv4c <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∧</span> HInv4d <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The initial state implies Invariant 4.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_HInv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟹</span> HInv4 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Disk_isMajority
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def HInv4_def HInv4a_def HInv4a1_def 
                    HInv4a2_def HInv4b_def HInv4c_def HInv4d_def 
                    MajoritySet_def blocksOf_def InitDB_def rdBy_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To prove that the actions preserve $HInv4$,
        we do it for one conjunct at a time.

  For each action $action s s' q$ and conjunct $x\in{a,b,c,d}$ of $HInv4x s' p$, 
  we prove two lemmas. 
The first lemma $action$-$HInv4x$-$p$ proves the case of $p=q$, while 
lemma $action$-$HInv4x$-$q$ proves the other case.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 4a›</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4a1"><span class="command">lemma</span></span> HStartBallot_HInv4a1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a1_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HStartBallot_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv2a
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def Inv2a_inner_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv act
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HInv4a1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4a2"><span class="command">lemma</span></span> HStartBallot_HInv4a2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a2 <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a2 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a2_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span>
  <span class="keyword3"><span class="command">assume</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> MajoritySet"</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv Dmaj
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>   mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> 
              <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"  <span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span> 
           <span class="main">∧</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> 
           <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"  <span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span> 
        <span class="main">∧</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
        <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Dmaj
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>   mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
              <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4a_p"><span class="command">lemma</span></span> HStartBallot_HInv4a_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> act inv inv2a
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> phase <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv inv2a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HStartBallot_def <span class="quasi_keyword">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def phase
               <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4a1 HStartBallot_HInv4a2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4a_q"><span class="command">lemma</span></span> HStartBallot_HInv4a_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def 
                      blocksOf_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv pnq
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HInv4a_def 
                      HInv4a1_def HInv4a2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv4a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4a_p<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4a_q<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-Phase1or2Write_HInv4a1"><span class="command">lemma</span></span> Phase1or2Write_HInv4a1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Phase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4a1 <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a1 <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def HInv4a1_def 
                    blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-Phase1or2Write_HInv4a2"><span class="command">lemma</span></span> Phase1or2Write_HInv4a2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Phase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4a2 <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a2 <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def HInv4a2_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv4a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="main">=</span> phase <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> phase' act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> phase' act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def 
                <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Phase1or2Write_HInv4a1 Phase1or2Write_HInv4a2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4a1_p"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4a1_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>     inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HInv4a1_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HPhase1or2ReadThen_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a1_def Phase1or2ReadThen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4a2"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4a2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv4a2 <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a2 <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv4a2_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4a_p"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4a_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act inv2b
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def Inv2b_def Inv2b_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4a1_p HPhase1or2ReadThen_HInv4a2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4a_q"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4a_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def InitializePhase_def 
                      blocksOf_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv pnq
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv4a_def 
                      HInv4a1_def HInv4a2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv4a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">q</span><span class="main">;</span> Inv2b <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4a_p HPhase1or2ReadThen_HInv4a_q<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv4a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv inv2a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4a <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4a1"><span class="command">lemma</span></span> HEndPhase1_HInv4a1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a1_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> bk HEndPhase1_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">with</span></span> act inv
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def HInv4a1_def EndPhase1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4a2"><span class="command">lemma</span></span> HEndPhase1_HInv4a2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a2 <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a2 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a2_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span>
  <span class="keyword3"><span class="command">assume</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> MajoritySet"</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv Dmaj
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>   mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> 
              <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> d_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"  <span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span> 
                   <span class="main">∧</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> 
                   <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act d_cond
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"  <span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span> 
        <span class="main">∧</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
        <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Dmaj
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>   mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
              <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4a_p"><span class="command">lemma</span></span> HEndPhase1_HInv4a_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> phase <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv inv2a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HEndPhase1_def <span class="quasi_keyword">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def 
               <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4a1 HEndPhase1_HInv4a2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4a_q"><span class="command">lemma</span></span> HEndPhase1_HInv4a_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∧</span> disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span> <span class="main">⊆</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv pnq
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HInv4a_def HInv4a1_def HInv4a2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv4a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">q</span><span class="main">;</span>  Inv2a <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4a_p HEndPhase1_HInv4a_q<span class="main">)</span>
 
<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv4a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HInv4a_def HInv4a1_def 
                    HInv4a2_def InitializePhase_def 
                    blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv4a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def HInv4a_def HInv4a1_def 
                    HInv4a2_def InitializePhase_def 
                    blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv4a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HInv4a_def HInv4a1_def HInv4a2_def 
                    InitializePhase_def blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-allSet"><span class="command">lemma</span></span> allSet<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> aPQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">P</span> <span class="bound">a</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  rb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rb</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">rb</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> aPQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">P</span> <span class="free">d</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> rb
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-EndPhase0_44"><span class="command">lemma</span></span> EndPhase0_44<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"EndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4d<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">∃</span><span class="bound">rb</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> bal <span class="free">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>block <span class="bound">rb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bk inv4d
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D1</span> <span class="main">∈</span> MajoritySet<span class="main">.</span><span class="main">∀</span><span class="bound">d</span> <span class="main">∈</span> <span class="bound">D1</span><span class="main">.</span> bal <span class="free">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>  <span class="comment1">― ‹4.2›</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> majorities_intersect
  <span class="keyword1"><span class="command">have</span></span> p43<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="free">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">rb</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> block <span class="bound">rb</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span>"</span></span> <span class="comment1">― ‹5.1›</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span>  
              <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">rb</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> block <span class="bound">rb</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹5.2›</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="var">?H</span> <span class="bound">d</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="bound">d</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> p53<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def EndPhase0_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> p43 p53
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span> MajoritySet<span class="main">.</span>   <span class="main">(</span><span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="free">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> 
                           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4a1_p"><span class="command">lemma</span></span> HEndPhase0_HInv4a1_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv4d<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a1_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv2a'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s'</span> <span class="free">p</span> <span class="skolem">bk</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bk <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> act
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> mbal <span class="bound">r</span> <span class="main">&lt;</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act inv4d inv2c bk
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">∃</span><span class="bound">rb</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>block <span class="bound">rb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> EndPhase0_44<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> f1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def allBlocksRead_def
                        allRdBlks_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> allSet<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-hasRead_allBlks"><span class="command">lemma</span></span> hasRead_allBlks<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span> <span class="var">?D</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> br_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"blocksRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2c phase
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span><span class="main">.</span> block <span class="bound">br</span> <span class="main">=</span> disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> br_ne
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span> <span class="main">∈</span> block <span class="main">`</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_41"><span class="command">lemma</span></span> HEndPhase0_41<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    inv1<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>   mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                               <span class="main">∧</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act HEndPhase0_some<span class="main">[</span><span class="operator">OF</span> act inv1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p51<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">br</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span>   mbal <span class="bound">br</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                                    <span class="main">∧</span> bal <span class="bound">br</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>     
    <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> inv2c phase
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> hasRead_allBlks<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p51
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span><span class="main">.</span>   mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                                  <span class="main">∧</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="DiskPaxos_Inv4-Majority_exQ"><span class="command">lemma</span></span> Majority_exQ<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> <span class="free">P</span> <span class="bound">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> <span class="free">P</span> <span class="bound">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> asm1
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D1</span> <span class="skolem">D2</span>
  <span class="keyword3"><span class="command">assume</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D2<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D2</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> Px<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">D1</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> D1 D2 majorities_intersect
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D1</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span><span class="skolem">D2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Px
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">D2</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4a2_p"><span class="command">lemma</span></span> HEndPhase0_HInv4a2_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>    inv1<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a2 <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act inv1 inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>   mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                              <span class="main">∧</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_41<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Majority_exQ<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>   mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                               <span class="main">∧</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>disk <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ssubst<span class="main">[</span><span class="operator">OF</span> disk'<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>  mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                              <span class="main">∧</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4a_p"><span class="command">lemma</span></span> HEndPhase0_HInv4a_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv2<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv4d<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2
  <span class="keyword1"><span class="command">have</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv1 inv2a act
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv2a<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv inv2c inv4d inv2a' inv1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span>  <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HEndPhase0_def
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4a1_p HEndPhase0_HInv4a2_p<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4a_q"><span class="command">lemma</span></span> HEndPhase0_HInv4a_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∧</span> disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span> <span class="main">⊆</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act inv pnq
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HInv4a_def HInv4a1_def HInv4a2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv4a<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">q</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">p</span><span class="main">;</span>
     Inv2a <span class="free">s</span><span class="main">;</span>  Inv1 <span class="free">s</span><span class="main">;</span>   Inv2a <span class="free">s</span><span class="main">;</span> Inv2c <span class="free">s</span><span class="main">⟧</span> 
  <span class="main">⟹</span> HInv4a <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4a_p HEndPhase0_HInv4a_q<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 4b›</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-blocksRead_allBlocksRead"><span class="command">lemma</span></span> blocksRead_allBlocksRead<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">rb</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟹</span> block <span class="free">rb</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_dblock_mbal"><span class="command">lemma</span></span> HEndPhase0_dblock_mbal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span> <span class="main">⟧</span> 
     <span class="main">⟹</span> <span class="main">∀</span><span class="bound">br</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> mbal <span class="bound">br</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>


<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4b_p_dblock"><span class="command">lemma</span></span> HEndPhase0_HInv4b_p_dblock<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span><span class="main">∀</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> proc <span class="bound">br</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> block <span class="bound">br</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> allBlks_in_blocksOf<span class="main">:</span> <span class="quoted"><span class="quoted">"allBlocksRead <span class="free">s</span> <span class="free">p</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act HEndPhase0_some<span class="main">[</span><span class="operator">OF</span> act inv1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p53<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>bal <span class="bound">br</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s</span> <span class="bound">p</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal <span class="bound">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> allBlks_in_blocksOf
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal <span class="bound">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> p53
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">≤</span> mbal <span class="bound">br</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_dblock_mbal<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4b_p_blocksOf"><span class="command">lemma</span></span> HEndPhase0_HInv4b_p_blocksOf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4d<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bal <span class="free">bk</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv4d  majorities_intersect bk
  <span class="keyword1"><span class="command">have</span></span> p43<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="free">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def MajoritySet_def Majority_exQ<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="free">bk</span> <span class="main">≤</span> mbal <span class="bound">br</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> act
    <span class="keyword1"><span class="command">have</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="var">?D</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
    <span class="keyword1"><span class="command">have</span></span> br_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="var">?D</span><span class="main">.</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> phase inv2c
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="var">?D</span><span class="main">.</span><span class="main">∀</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span> block <span class="bound">br</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> br_ne
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="var">?D</span><span class="main">.</span> <span class="main">∃</span><span class="bound">br</span><span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> <span class="bound">br</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> blocksRead_allBlocksRead<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p43 maj
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_dblock_mbal<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4b_p"><span class="command">lemma</span></span> HEndPhase0_HInv4b_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4d<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span>  <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act        
  <span class="keyword1"><span class="command">have</span></span>  phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>    
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span><span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">bk</span><span class="main">∈</span>blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">&lt;</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span><span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act inv1 inv2a inv2c
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HEndPhase0_def 
                  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4b_p_dblock <span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act inv2c inv4d
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4b_p_blocksOf<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4b_q"><span class="command">lemma</span></span> HEndPhase0_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span>phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv phase' dblock'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv4b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4d<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_HInv4b_p<span class="main">[</span><span class="operator">OF</span> act inv4d inv1 inv2a inv2c<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> HEndPhase0_HInv4b_q<span class="main">[</span><span class="operator">OF</span> act False inv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4b_p"><span class="command">lemma</span></span> HStartBallot_HInv4b_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4b<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> p42<span class="main">:</span> <span class="quoted"><span class="quoted">"  mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">&lt;</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>
        <span class="main">∧</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HStartBallot_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> bk
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span> <span class="main">∪</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">&lt;</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv2a
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p42 bk
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> phase inv4a
    <span class="keyword1"><span class="command">have</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a1 <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p42 bk
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4b_q"><span class="command">lemma</span></span> HStartBallot_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span>phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv phase' dblock'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv4b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4b<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> act inv2a inv4b inv4a
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">p</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def blocksOf_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> act True inv4b inv4a
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4b_p<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> act inv4b
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4b_q<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv4b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4b <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def HInv4b_def 
                    blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4b_p"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4b_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase1or2ReadThen_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> inv act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def Phase1or2ReadThen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4b_q"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms HPhase1or2ReadThen_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv4b_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv4b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span><span class="main">;</span> HInv4b <span class="free">s</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4b_p 
                 HPhase1or2ReadThen_HInv4b_q<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv4b<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span><span class="main">;</span> HInv4b <span class="free">s</span> <span class="free">r</span><span class="main">;</span>
     Inv2a <span class="free">s</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">p</span> <span class="main">⟧</span>
  <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> HStartBallot_HInv4b
 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4b_p"><span class="command">lemma</span></span> HEndPhase1_HInv4b_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HInv4b_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4b_q"><span class="command">lemma</span></span> HEndPhase1_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span>phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv phase' dblock'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv4b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> HEndPhase1_HInv4b_p<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> HEndPhase1_HInv4b_q<span class="main">[</span><span class="operator">OF</span> act False inv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase2_HInv4b_p"><span class="command">lemma</span></span> HEndPhase2_HInv4b_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HInv4b_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase2_HInv4b_q"><span class="command">lemma</span></span> HEndPhase2_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span>phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv phase' dblock'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv4b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> HEndPhase2_HInv4b_p<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> HEndPhase2_HInv4b_q<span class="main">[</span><span class="operator">OF</span> act False inv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HFail_HInv4b_p"><span class="command">lemma</span></span> HFail_HInv4b_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HInv4b_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HFail_HInv4b_q"><span class="command">lemma</span></span> HFail_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span>phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv phase' dblock'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv4b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> HFail_HInv4b_p<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> HFail_HInv4b_q<span class="main">[</span><span class="operator">OF</span> act False inv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase0Read_HInv4b_p"><span class="command">lemma</span></span> HPhase0Read_HInv4b_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟹</span> HInv4b <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def HInv4b_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase0Read_HInv4b_q"><span class="command">lemma</span></span> HPhase0Read_HInv4b_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span>phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase0Read_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> inv phase' dblock'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4b_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv4b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> HPhase0Read_HInv4b_p<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> HPhase0Read_HInv4b_q<span class="main">[</span><span class="operator">OF</span> act False inv<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 4c›</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4c_p"><span class="command">lemma</span></span>  HStartBallot_HInv4c_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HInv4c_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4c_q"><span class="command">lemma</span></span>  HStartBallot_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4c_p HStartBallot_HInv4c_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2Write_HInv4c_p"><span class="command">lemma</span></span>  HPhase1or2Write_HInv4c_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">p</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def phase' MajoritySet_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> act phase'
    <span class="keyword1"><span class="command">have</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> phase' inv2c act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="free">d</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def Inv2c_def Inv2c_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bal
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="free">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> inv phase act
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span>    IsMajority <span class="bound">D</span> 
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def Phase1or2Write_def MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def Phase1or2Write_def<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2Write_HInv4c_q"><span class="command">lemma</span></span>  HPhase1or2Write_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">q</span>  <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">;</span> Inv2c <span class="free">s</span> <span class="main">⟧</span>
             <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv4c_p
                 HPhase1or2Write_HInv4c_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4c_p"><span class="command">lemma</span></span>  HPhase1or2ReadThen_HInv4c_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv4c_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4c_q"><span class="command">lemma</span></span>  HPhase1or2ReadThen_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span>
          <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4c_p
                 HPhase1or2ReadThen_HInv4c_q<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> HStartBallot_HInv4c
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4c_p"><span class="command">lemma</span></span>  HEndPhase1_HInv4c_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"   IsMajority <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span> 
             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="main">(</span>UNIV<span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span>  <span class="quoted"><span class="quoted">"IsMajority <span class="var">?M</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2b
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="var">?M</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def Inv2b_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act maj
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def EndPhase1_def MajoritySet_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4c_q"><span class="command">lemma</span></span>  HEndPhase1_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">;</span> Inv2b <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4c_p HEndPhase1_HInv4c_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase2_HInv4c_p"><span class="command">lemma</span></span>  HEndPhase2_HInv4c_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HInv4c_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase2_HInv4c_q"><span class="command">lemma</span></span>  HEndPhase2_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase2_HInv4c_p HEndPhase2_HInv4c_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HFail_HInv4c_p"><span class="command">lemma</span></span>  HFail_HInv4c_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HInv4c_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HFail_HInv4c_q"><span class="command">lemma</span></span>  HFail_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HFail_HInv4c_p HFail_HInv4c_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase0Read_HInv4c_p"><span class="command">lemma</span></span>  HPhase0Read_HInv4c_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def HInv4c_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase0Read_HInv4c_q"><span class="command">lemma</span></span>  HPhase0Read_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv4c_p HPhase0Read_HInv4c_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4c_p"><span class="command">lemma</span></span>  HEndPhase0_HInv4c_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HInv4c_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4c_q"><span class="command">lemma</span></span>  HEndPhase0_HInv4c_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s'</span> <span class="free">q</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv4c<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4c <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4c_p HEndPhase0_HInv4c_q<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of Invariant 4d›</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4d_p"><span class="command">lemma</span></span>  HStartBallot_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HStartBallot_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> bal' inv
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HStartBallot_HInv4d_q"><span class="command">lemma</span></span> HStartBallot_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span> 
           <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4d_p HStartBallot_HInv4d_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2Write_HInv4d_p"><span class="command">lemma</span></span>  HPhase1or2Write_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> ddisk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">dd</span><span class="main">.</span> disk <span class="free">s'</span> <span class="bound">dd</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">d</span> <span class="main">=</span> <span class="bound">dd</span> 
                                       <span class="keyword1">then</span> dblock <span class="free">s</span> <span class="free">p</span> 
                                       <span class="keyword1">else</span> disk <span class="free">s</span> <span class="bound">dd</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv subsetD<span class="main">[</span><span class="operator">OF</span> HPhase1or2Write_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">dd</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">dd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> phase inv4a subsetD<span class="main">[</span><span class="operator">OF</span> HPhase1or2Write_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> ddisk
  <span class="keyword1"><span class="command">have</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="free">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a_def HInv4a1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ddisk asm3
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">dd</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">dd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2Write_HInv4d_q"><span class="command">lemma</span></span> HPhase1or2Write_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">q</span> <span class="main">=</span>disk <span class="free">s</span>  <span class="bound">d</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def 
                      InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def allRdBlks_def
                      blocksOf_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span> 
            <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv4d_p HPhase1or2Write_HInv4d_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4d_p"><span class="command">lemma</span></span>  HPhase1or2ReadThen_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HPhase1or2ReadThen_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase1or2ReadThen_HInv4d_q"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def allRdBlks_def
                      blocksOf_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span> 
             <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4d_p
                 HPhase1or2ReadThen_HInv4d_q<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> HStartBallot_HInv4d
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4d_p"><span class="command">lemma</span></span>  HEndPhase1_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4c<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase1_HInv4c<span class="main">[</span><span class="operator">OF</span> act inv4c inv2b<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> 
               <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HInv4c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase1_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv disk'
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> p31
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase1_HInv4d_q"><span class="command">lemma</span></span> HEndPhase1_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def
                      allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span> 
           <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">;</span> Inv2b <span class="free">s</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">⟧</span>
         <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4d_p HEndPhase1_HInv4d_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase2_HInv4d_p"><span class="command">lemma</span></span>  HEndPhase2_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase2_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase2_HInv4d_q"><span class="command">lemma</span></span> HEndPhase2_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def
                      allRdBlks_def blocksOf_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span>
           <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase2_HInv4d_p HEndPhase2_HInv4d_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HFail_HInv4d_p"><span class="command">lemma</span></span>  HFail_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HFail_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv disk'
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitDB_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Disk_isMajority
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HFail_HInv4d_q"><span class="command">lemma</span></span> HFail_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> blocksRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> allRdBlks <span class="free">s'</span> <span class="bound">q</span> <span class="main">⊆</span> allRdBlks <span class="free">s</span> <span class="bound">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk' dblock'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def blocksOf_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span>
          <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HFail_HInv4d_p HFail_HInv4d_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase0Read_HInv4d_p"><span class="command">lemma</span></span>  HPhase0Read_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> bal'<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HPhase0Read_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HPhase0Read_HInv4d_q"><span class="command">lemma</span></span> HPhase0Read_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span>disk <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def allRdBlks_def
                      blocksOf_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span>
           <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> disk'
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv4d_p HPhase0Read_HInv4d_q<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_blocksOf2"><span class="command">lemma</span></span> HEndPhase0_blocksOf2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocksRead <span class="free">s</span> <span class="free">p</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span><span class="main">∀</span><span class="bound">br</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span><span class="main">.</span>   proc <span class="bound">br</span> <span class="main">=</span><span class="free">p</span> 
                                    <span class="main">∧</span> block <span class="bound">br</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def
                      blocksOf_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4d_p"><span class="command">lemma</span></span>  HEndPhase0_HInv4d_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase0_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv2c 
    <span class="keyword1"><span class="command">have</span></span> inv2c_inner<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bk  HEndPhase0_some<span class="main">[</span><span class="operator">OF</span> act inv1<span class="main">]</span> 
         HEndPhase0_blocksOf2<span class="main">[</span><span class="operator">OF</span> act inv2c_inner<span class="main">]</span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">∈</span> bal <span class="main">`</span><span class="main">(</span>blocksOf <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> inv
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv4-HEndPhase0_HInv4d_q"><span class="command">lemma</span></span> HEndPhase0_HInv4d_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span>  <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
 <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∧</span> disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span> <span class="main">⊆</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def rdBy_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">p</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>blocksOf <span class="free">s'</span> <span class="free">q</span><span class="main">.</span>
           <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="bound">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HInv4d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv4d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv4d <span class="free">s</span> <span class="free">q</span><span class="main">;</span> 
     Inv2c <span class="free">s</span><span class="main">;</span> Inv1 <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> HInv4d <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4d_p HEndPhase0_HInv4d_q<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Since we have already proved $HInv2$ is an invariant of $HNext$,
$HInv1 \wedge HInv2 \wedge HInv4$ is also an invariant of $HNext$. 
›</span></span>
  
<span class="keyword1" id="DiskPaxos_Inv4-I2d"><span class="command">lemma</span></span> I2d<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s'</span> <span class="main">∧</span> HInv4 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv4 <span class="free">s'</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def<span class="main">)</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4a<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv4a<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv4a<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4a
                    HPhase1or2ReadElse_HInv4a<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4a
                    HEndPhase2_HInv4a<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv4a<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4a <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def<span class="main">)</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def 
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4b<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv4b<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv4b<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4b
                    HPhase1or2ReadElse_HInv4b<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4b
                    HEndPhase2_HInv4b<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv4b<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4b <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def Inv2c_def<span class="main">)</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def 
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4c<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv4c<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv4c<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4c
                    HPhase1or2ReadElse_HInv4c<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4c
                    HEndPhase2_HInv4c<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv4c<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4c <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def<span class="main">)</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"HInv4d <span class="free">s'</span> <span class="skolem">p</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> assms
     <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def 
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv4d<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv4d<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv4d<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv4d
                    HPhase1or2ReadElse_HInv4d<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv4d
                    HEndPhase2_HInv4d<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv4d<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv4d <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



</pre>
</div><div id="DiskPaxos_Inv5">
<div class="head">
<h1>Theory DiskPaxos_Inv5</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Inv5 <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Inv3.html">DiskPaxos_Inv3</a> <a href="DiskPaxos_Inv4.html">DiskPaxos_Inv4</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 5›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This invariant asserts that, if a processor $p$ is in phase 2, 
  then either its $bal$ and $inp$ values satisfy $maxBalInp$, or
  else $p$ must eventually abort its current ballot. Processor $p$ 
  will eventually abort its ballot if there is some processor $q$
  and majority set $D$ such that $p$ has not read $q$'s block on 
  any disk $D$, and all of those blocks have $mbal$ values greater
  than $bal(dblock s p)$.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">maxBalInp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> nat <span class="main">⇒</span> InputsOrNi <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">maxBalInp</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">bk</span><span class="main">∈</span>allBlocks <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≤</span> bal <span class="bound">bk</span> <span class="main">⟶</span> inp <span class="bound">bk</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv5_inner_R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv5_inner_R</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>
          <span class="main">(</span>maxBalInp <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>  bal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                      <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv5_inner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv5_inner</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟶</span> HInv5_inner_R <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HInv5</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> HInv5_inner <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of Invariant 5›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The initial state implies Invariant 5.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_HInv5<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟹</span> HInv5 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Disk_isMajority
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def HInv5_def HInv5_inner_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will use the notation used in the proofs of invariant 4, and prove
the lemma $action$-$HInv5$-$p$ and $action$-$HInv5$-$q$ for each action, for
the cases $p=q$ and $p\not = q$ respectively.

  Also, for each action we will define an $action$-$allBlocks$ lemma in the 
same way that we defined -$blocksOf$ lemmas in the proofs of $HInv2$. Now we prove 
that for each action the new $allBlocks$ are included in the old $allBlocks$ or, in
some cases, included in the old $allBlocks$ union the new $dblock$. 
›</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HStartBallot_HInv5_p"><span class="command">lemma</span></span> HStartBallot_HInv5_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HInv5_inner_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HStartBallot_blocksOf_q"><span class="command">lemma</span></span>  HStartBallot_blocksOf_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HStartBallot_allBlocks"><span class="command">lemma</span></span> HStartBallot_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HStartBallot_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">pa</span>
  <span class="keyword3"><span class="command">assume</span></span> x_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         x_nblks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="bound">xa</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>dblock <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">pa</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> x_nblks
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True subsetD<span class="main">[</span><span class="operator">OF</span> HStartBallot_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> x_nblks subsetD<span class="main">[</span><span class="operator">OF</span> HStartBallot_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act False<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1" id="DiskPaxos_Inv5-HStartBallot_HInv5_q1"><span class="command">lemma</span></span> HStartBallot_HInv5_q1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HStartBallot_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv5_1 dblock' bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bal act bk dblock' inv5_1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HStartBallot_HInv5_q2"><span class="command">lemma</span></span> HStartBallot_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span>  disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv5_2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HStartBallot_HInv5_q"><span class="command">lemma</span></span> HStartBallot_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> HStartBallot_HInv5_q1<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span> HStartBallot_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def StartBallot_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv5_q HStartBallot_HInv5_p<span class="main">)</span>


<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2Write_HInv5_1"><span class="command">lemma</span></span> HPhase1or2Write_HInv5_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> HPhase1or2Write_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def maxBalInp_def allBlocks_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2Write_HInv5_p2"><span class="command">lemma</span></span> HPhase1or2Write_HInv5_p2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4c<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv5_2
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">q</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> inv4c phase 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D1</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D1</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def MajoritySet_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i1 majorities_intersect
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∩</span><span class="skolem">D1</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dd</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">dd</span><span class="main">∈</span><span class="skolem">D</span><span class="main">∩</span><span class="skolem">D1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> i1 i2 r1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
      <span class="comment1">― ‹$dblock$ and $hasRead$ do not change›</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="main">=</span> dblock <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span> <span class="main">=</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
      <span class="comment1">― ‹In all disks $q$ blocks don't change›</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> disk <span class="free">s'</span> <span class="bound">d</span> <span class="skolem">q</span> <span class="main">=</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> i2 i1 i3 majority_nonempty
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> i1 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2Write_HInv5_p"><span class="command">lemma</span></span> HPhase1or2Write_HInv5_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HPhase1or2Write_HInv5_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HPhase1or2Write_HInv5_p2<span class="main">[</span><span class="operator">OF</span> act inv4 phase<span class="main">]</span> inv i2 phase
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2Write_allBlocks"><span class="command">lemma</span></span> HPhase1or2Write_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HPhase1or2Write_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>
   
<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2Write_HInv5_q2"><span class="command">lemma</span></span> HPhase1or2Write_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv5_2
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">qq</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
      <span class="comment1">― ‹$dblock$ and $hasRead$ do not change›</span>
  <span class="keyword1"><span class="command">have</span></span>  dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="main">=</span> dblock <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span> <span class="main">=</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> inv4a act i1
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def HInv4a_def 
                          HInv4a2_def Phase1or2Write_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True i2
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> hasread dblock' True i1 i2 i3 act
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> act i2 i3
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> i1 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2Write_HInv5_q"><span class="command">lemma</span></span> HPhase1or2Write_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">qa</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qa</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qa</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HPhase1or2Write_HInv5_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HPhase1or2Write_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq inv4a<span class="main">]</span> inv i2 phase
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span><span class="main">;</span> 
     HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv5_q HPhase1or2Write_HInv5_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2ReadThen_HInv5_1"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv5_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> HPhase1or2ReadThen_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def maxBalInp_def allBlocks_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2ReadThen_HInv5_p2"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv5_p2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4c<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv5_2
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">q</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv2c phase
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mbal <span class="main">(</span>disk <span class="free">s</span> <span class="free">d</span> <span class="free">r</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> i2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">∈</span><span class="skolem">D</span> <span class="main">⟶</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="free">d</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pnr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">∈</span><span class="skolem">D</span> <span class="main">⟶</span> <span class="skolem">q</span><span class="main">≠</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> inv4c phase 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D1</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D1</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4c_def MajoritySet_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> i1 majorities_intersect
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∩</span><span class="skolem">D1</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dd</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">dd</span><span class="main">∈</span><span class="skolem">D</span><span class="main">∩</span><span class="skolem">D1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> i1 i2 r1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> pnr act
  <span class="keyword1"><span class="command">have</span></span> hasRead'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span> <span class="main">=</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def hasRead_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
      <span class="comment1">― ‹$dblock$ and $disk$ do not change›</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="main">=</span> dblock <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> i2 hasRead' i3
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> i1 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2ReadThen_HInv5_p"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv5_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4c <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HPhase1or2ReadThen_HInv5_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> inv2c
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HPhase1or2ReadThen_HInv5_p2<span class="main">[</span><span class="operator">OF</span> act inv4 this phase<span class="main">]</span> inv i2 phase
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2ReadThen_allBlocks"><span class="command">lemma</span></span> HPhase1or2ReadThen_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HPhase1or2ReadThen_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>
   
<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2ReadThen_HInv5_q2"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv5_2
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">qq</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
      <span class="comment1">― ‹$dblock$ and $hasRead$ do not change›</span>
  <span class="keyword1"><span class="command">have</span></span>  dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="main">=</span> dblock <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> hasread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span> <span class="main">=</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> i2 i3
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="skolem">qq</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> i1 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="DiskPaxos_Inv5-HPhase1or2ReadThen_HInv5_q"><span class="command">lemma</span></span> HPhase1or2ReadThen_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4a<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">qa</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qa</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qa</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HPhase1or2ReadThen_HInv5_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HPhase1or2ReadThen_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq inv4a<span class="main">]</span> inv i2 phase
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span><span class="main">;</span> 
     Inv2c <span class="free">s</span><span class="main">;</span> HInv4c <span class="free">s</span> <span class="free">p</span><span class="main">;</span> HInv4a <span class="free">s</span> <span class="free">p</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv5_q HPhase1or2ReadThen_HInv5_p<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span>
     <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HStartBallot_HInv5
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase2_HInv5_p"><span class="command">lemma</span></span> HEndPhase2_HInv5_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>  <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HInv5_inner_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase2_allBlocks"><span class="command">lemma</span></span> HEndPhase2_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HEndPhase2_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>
   
<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase2_HInv5_q1"><span class="command">lemma</span></span> HEndPhase2_HInv5_q1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase2_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> inv5_1 dblock' bal
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase2_HInv5_q2"><span class="command">lemma</span></span> HEndPhase2_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span>  disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv5_2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase2_HInv5_q"><span class="command">lemma</span></span> HEndPhase2_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> HEndPhase2_HInv5_q1<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span> HEndPhase2_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def EndPhase2_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase2_HInv5_q HEndPhase2_HInv5_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase1_HInv5_p"><span class="command">lemma</span></span> HEndPhase1_HInv5_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="bound">bk</span> <span class="main">∧</span> <span class="bound">bk</span> <span class="main">≠</span> dblock <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> asm4
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bk</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span>allBlocks <span class="free">s'</span> <span class="main">∧</span>  bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span> <span class="main">∧</span> <span class="skolem">bk</span> <span class="main">≠</span> dblock <span class="free">s'</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> act
    <span class="keyword1"><span class="command">have</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="skolem">q</span> <span class="main">⟹</span> dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">q</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> p32 p31 HEndPhase1_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> dblock<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase1_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span> p32<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> p31
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bk</span></span> <span class="keyword2"><span class="keyword">where</span></span> p22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span> <span class="main">∧</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span> <span class="main">∧</span> <span class="skolem">bk</span> <span class="main">≠</span> dblock <span class="free">s'</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> p22
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> act p22
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv4
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv4b <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bk
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def HInv4b_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bk
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> p23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">bk</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> p23 inv4 
    <span class="keyword1"><span class="command">have</span></span> i4d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="skolem">bk</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def HInv4d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> i4d p22
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p24<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> p25<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> inv2c
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword1"><span class="command">have</span></span> bal_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def EndPhase1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> inv2a'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                        Inv2a_innermost_def blocksOf_def<span class="main">)</span>  
    <span class="keyword1"><span class="command">with</span></span> bal_pos <span class="keyword1"><span class="command">have</span></span> bal_in_p<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> inv2a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="skolem">q</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_inner_def Inv2a_innermost_def 
                        blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p24 bal_pos
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span>  Ballot_disj p23 bal_in_p
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span><span class="main">≠</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> p23 p24
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> p23 act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Dmaj
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="DiskPaxos_Inv5-union_inclusion"><span class="command">lemma</span></span> union_inclusion<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">A'</span><span class="main">;</span> <span class="free">B</span><span class="main">⊆</span> <span class="free">B'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">∪</span><span class="free">B</span> <span class="main">⊆</span> <span class="free">A'</span><span class="main">∪</span><span class="free">B'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase1_blocksOf_q"><span class="command">lemma</span></span>  HEndPhase1_blocksOf_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blks<span class="main">:</span> <span class="quoted"><span class="quoted">"blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> disk
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">q</span> <span class="main">|</span> <span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span> <span class="main">|</span> <span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> UNIV<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="main">⊆</span> <span class="var">?D</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pnq act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def rdBy_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>block <span class="bound">br</span> <span class="main">|</span> <span class="bound">br</span><span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>block <span class="bound">br</span> <span class="main">|</span> <span class="bound">br</span><span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R'</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> union_inclusion<span class="main">[</span><span class="operator">OF</span> dblock union_inclusion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disk' this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase1_allBlocks"><span class="command">lemma</span></span> HEndPhase1_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HEndPhase1_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase1_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">pa</span>
  <span class="keyword3"><span class="command">assume</span></span> x_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         x_nblks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="bound">xa</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>dblock <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">pa</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> x_nblks
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase1_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> x_nblks subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase1_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act False<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase1_HInv5_q"><span class="command">lemma</span></span> HEndPhase1_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a_q<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> phase <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase_p<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> phase'
  <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> phase inv2c
  <span class="keyword1"><span class="command">have</span></span> bal_dblk_q<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> p21<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> True asm4 dblock HEndPhase1_allBlocks<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"  bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> 
                 <span class="main">∧</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> inv2a
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> Ballot <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                          Inv2a_innermost_def blocksOf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> Ballot_disj Ballot_nzero pnq
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ballot <span class="free">q</span> <span class="main">∩</span> <span class="main">(</span>Ballot <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bal_dblk_q
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> p32
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span>  act
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span>disksWritten <span class="free">s</span> <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def MajoritySet_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> act1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span>disksWritten <span class="free">s</span> <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> inv2b
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> Inv2b_inner <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> act1 pnq phase_p bal
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">q</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def Inv2b_inner_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p21 Dmaj
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Dmaj
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> p22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> p23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span><span class="main">⦇</span>block<span class="main">=</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">,</span> proc<span class="main">=</span><span class="free">q</span><span class="main">⦈</span> <span class="main">∉</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span> <span class="main">⟶</span> inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">assume</span></span> dblock_q<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∈</span> allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> inv2a_q
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">=</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def 
                            blocksOf_def Inv2a_innermost_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bal_dblk_q Ballot_nzero dblock_q InputsOrNi
        <span class="keyword1"><span class="command">have</span></span> dblock_q_nib<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonInitBlks_def blocksSeen_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> act
        <span class="keyword1"><span class="command">have</span></span> dblock_max<span class="main">:</span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>inp<span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> maxBlk_in_nonInitBlks<span class="main">[</span><span class="operator">OF</span> dblock_q_nib inv1<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> max_in_nib<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBlk <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nonInitBlks <span class="free">s</span> <span class="free">p</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def nonInitBlks_def 
                            blocksSeen_def blocksOf_def rdBy_def 
                            allBlocksRead_def allRdBlks_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> True subsetD<span class="main">[</span><span class="operator">OF</span> this max_in_nib<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟶</span> inp <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> maxBlk_in_nonInitBlks<span class="main">[</span><span class="operator">OF</span> dblock_q_nib inv1<span class="main">]</span> 
             dblock_q_nib dblock_max
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> p21
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∉</span> block <span class="main">`</span> allRdBlks <span class="free">s</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> dblock <span class="free">s</span> <span class="free">q</span> <span class="main">∉</span> block <span class="main">`</span> blocksRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allRdBlks_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> p24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> inv2c phase
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span><span class="main">.</span> mbal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">&lt;</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> p25<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span>  d_in_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="skolem">D</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> hasRead_qdp<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="free">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>block<span class="main">=</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">,</span> proc<span class="main">=</span><span class="free">p</span><span class="main">⦈</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">q</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"d_in_D"</span> p22 
        <span class="keyword1"><span class="command">have</span></span> hasRead_pdq<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> hasRead_qdp phase phase_p inv3
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv3_R <span class="free">s</span> <span class="free">q</span> <span class="free">p</span> <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def HInv3_inner_def HInv3_L_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> p23 d_in_D
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_R_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> p21 act
      <span class="keyword1"><span class="command">have</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p31 d_in_D hasRead_qdp p24 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> p22
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> inv phase
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_def HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">qq</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">qq</span><span class="main">)</span>
                                   <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span> <span class="main">=</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="skolem">qq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> disk dblock
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_HInv5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4 <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HEndPhase1_HInv5_p<span class="main">[</span><span class="operator">OF</span> act inv4 inv2a inv2a' inv2c<span class="main">]</span>
        HEndPhase1_HInv5_q<span class="main">[</span><span class="operator">OF</span> act inv inv1 inv2a' inv2a inv2b inv2c inv3<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_def HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HFail_HInv5_p"><span class="command">lemma</span></span> HFail_HInv5_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>  <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HInv5_inner_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HFail_blocksOf_q"><span class="command">lemma</span></span>  HFail_blocksOf_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def blocksOf_def rdBy_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HFail_allBlocks"><span class="command">lemma</span></span> HFail_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HFail_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HFail_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">pa</span>
  <span class="keyword3"><span class="command">assume</span></span> x_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         x_nblks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="bound">xa</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>dblock <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">pa</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> x_nblks
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True subsetD<span class="main">[</span><span class="operator">OF</span> HFail_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> x_nblks subsetD<span class="main">[</span><span class="operator">OF</span> HFail_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act False<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HFail_HInv5_q1"><span class="command">lemma</span></span> HFail_HInv5_q1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HFail_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv5_1 dblock' bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act <span class="keyword1"><span class="command">have</span></span> bk_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">=</span> InitDB"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bal
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">=</span><span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitDB_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> inv2a
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">=</span> NotAnInput"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_inner_def Inv2a_innermost_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bk_init
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> InitDB_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HFail_HInv5_q2"><span class="command">lemma</span></span> HFail_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span>  disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv5_2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HFail_HInv5_q"><span class="command">lemma</span></span> HFail_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nR2<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span>
        <span class="main">∀</span><span class="bound">qa</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qa</span><span class="main">)</span> <span class="main">⟶</span>
                   hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qa</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HFail_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="var">?P</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="var">?P</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nR2
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> inv2a
  <span class="keyword1"><span class="command">have</span></span> inv2a'<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_inner <span class="free">s'</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq phase'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv HFail_HInv5_q1<span class="main">[</span><span class="operator">OF</span> act pnq inv2a'<span class="main">]</span> P
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span><span class="main">;</span> Inv2a <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HFail_HInv5_q HFail_HInv5_p<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase0Read_HInv5_p"><span class="command">lemma</span></span> HPhase0Read_HInv5_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def HInv5_inner_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase0Read_allBlocks"><span class="command">lemma</span></span> HPhase0Read_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HPhase0Read_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase0Read_HInv5_1"><span class="command">lemma</span></span> HPhase0Read_HInv5_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> HPhase0Read_blocksOf<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def maxBalInp_def allBlocks_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase0Read_HInv5_q2"><span class="command">lemma</span></span> HPhase0Read_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span>  disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv5_2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HPhase0Read_HInv5_q"><span class="command">lemma</span></span> HPhase0Read_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">qa</span><span class="main">.</span> <span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qa</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qa</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act <span class="keyword1"><span class="command">have</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">q</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> HPhase0Read_HInv5_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HPhase0Read_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span> inv i2 phase
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv5_q HPhase0Read_HInv5_p<span class="main">)</span>


<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase0_HInv5_p"><span class="command">lemma</span></span> HEndPhase0_HInv5_p<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>  <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HInv5_inner_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase0_blocksOf_q"><span class="command">lemma</span></span>  HEndPhase0_blocksOf_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blocksOf <span class="free">s'</span> <span class="free">q</span> <span class="main">⊆</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blks<span class="main">:</span> <span class="quoted"><span class="quoted">"blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> disk
  <span class="keyword1"><span class="command">have</span></span> disk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">q</span> <span class="main">|</span> <span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">q</span> <span class="main">|</span> <span class="bound">d</span> <span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> UNIV<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D'</span> <span class="main">⊆</span> <span class="var">?D</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pnq act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
                rdBy_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>block <span class="bound">br</span> <span class="main">|</span> <span class="bound">br</span><span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s'</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> 
         <span class="main">{</span>block <span class="bound">br</span> <span class="main">|</span> <span class="bound">br</span><span class="main">.</span> <span class="bound">br</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="free">q</span> <span class="bound">qq</span> <span class="bound">d</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R'</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> union_inclusion<span class="main">[</span><span class="operator">OF</span> dblock union_inclusion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disk' this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase0_allBlocks"><span class="command">lemma</span></span> HEndPhase0_allBlocks<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"allBlocks <span class="free">s'</span> <span class="main">⊆</span> allBlocks <span class="free">s</span> <span class="main">∪</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> HEndPhase0_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">pa</span>
  <span class="keyword3"><span class="command">assume</span></span> x_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> blocksOf <span class="free">s'</span> <span class="skolem">pa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         x_nblks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="bound">xa</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span>dblock <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">pa</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> x_nblks
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> blocksOf <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase0_blocksOf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> x_nblks subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase0_blocksOf_q<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act False<span class="main"><span class="main">]</span></span> x_pa<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase0_HInv5_q1"><span class="command">lemma</span></span> HEndPhase0_HInv5_q1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_1<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span> dblock'<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase0_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv5_1 dblock' bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> HEndPhase0_some<span class="main">[</span><span class="operator">OF</span> act inv1<span class="main">]</span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ba</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span><span class="main">.</span> bal <span class="bound">ba</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> inp <span class="bound">ba</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ba</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> ba_blksread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ba</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">p</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> ba_balinp<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="skolem">ba</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> inp <span class="skolem">ba</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"allBlocksRead <span class="free">s</span> <span class="free">p</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def 
                      allBlocks_def blocksOf_def rdBy_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this ba_blksread<span class="main">]</span> ba_balinp bal bk dblock' inv5_1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase0_HInv5_q2"><span class="command">lemma</span></span> HEndPhase0_HInv5_q2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">qq</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>
                                     <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">qq</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> act pnq
  <span class="keyword1"><span class="command">have</span></span>  disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span> <span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> blocksRead<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> blocksRead <span class="free">s'</span> <span class="free">q</span> <span class="bound">d</span> <span class="main">=</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> inv5_2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-HEndPhase0_HInv5_q"><span class="command">lemma</span></span> HEndPhase0_HInv5_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span>
    HEndPhase0_HInv5_q1<span class="main">[</span><span class="operator">OF</span> act pnq inv1<span class="main">]</span> 
    HEndPhase0_HInv5_q2<span class="main">[</span><span class="operator">OF</span> act pnq<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_def HInv5_inner_R_def EndPhase0_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_HInv5<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span><span class="main">;</span> HInv5_inner <span class="free">s</span> <span class="free">q</span><span class="main">;</span> Inv1 <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> HInv5_inner <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv5_q HEndPhase0_HInv5_p<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  $HInv1 \wedge HInv2 \wedge HInv3 \wedge HInv4 \wedge HInv5$ is an invariant of $HNext$.

›</span></span>

<span class="keyword1" id="DiskPaxos_Inv5-I2e"><span class="command">lemma</span></span> I2e<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s'</span> <span class="main">∧</span> HInv3 <span class="free">s</span> <span class="main">∧</span> HInv4 <span class="free">s</span> <span class="main">∧</span> HInv5 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv5 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_def HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_HInv5<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_HInv5<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_HInv5<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_HInv5
                    HPhase1or2ReadElse_HInv5<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def HInv1_def HInv4_def HInv5_def
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_HInv5
                    HEndPhase2_HInv5<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_HInv5<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_HInv5 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv1_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>



</pre>
</div><div id="DiskPaxos_Chosen">
<div class="head">
<h1>Theory DiskPaxos_Chosen</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Chosen <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Inv5.html">DiskPaxos_Inv5</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma I2f›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To prove the final conjunct we will use the predicate $valueChosen(v)$.
  This predicate is true if $v$ is the only possible value that can be 
  chosen as output. It also asserts that, for every disk $d$ in $D$, if $q$
  has already read $disk s d p$, then it has read a block with $bal$ field 
  at least $b$.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valueChosen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> InputsOrNi <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valueChosen</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span><span class="main">.</span> 
         maxBalInp <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>  <span class="bound">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">d</span> <span class="bound">p</span><span class="main">)</span>
                                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                                          <span class="main">∧</span> <span class="bound">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span><span class="main">)</span>
                                          <span class="main">∧</span> hasRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span> <span class="bound">d</span> <span class="bound">p</span>
                                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span>
                             <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase1_valueChosen_inp"><span class="command">lemma</span></span> HEndPhase1_valueChosen_inp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bk_blocksOf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bk</span><span class="main">∈</span>blocksOf <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bk</span><span class="main">∈</span> blocksSeen <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="free">bk</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> bk_blocksOf inv2a
  <span class="keyword1"><span class="command">have</span></span> inv2a_bk<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="free">r</span> <span class="free">bk</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_def Inv2a_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ballot_nzero asm1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> b_bal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span> bal <span class="free">bk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> inv2a_bk
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="free">bk</span> <span class="main">≠</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bk InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> bk_noninit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bk</span> <span class="main">∈</span> nonInitBlks <span class="free">s</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonInitBlks_def blocksSeen_def 
                      allBlocksRead_def allRdBlks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> maxBlk_in_nonInitBlks<span class="main">[</span><span class="operator">OF</span> this inv1<span class="main">]</span> b_bal
  <span class="keyword1"><span class="command">have</span></span> maxBlk_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> maxBlk_in_nonInitBlks<span class="main">[</span><span class="operator">OF</span> bk_noninit inv1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">d</span><span class="main">.</span> maxBlk <span class="free">s</span> <span class="free">q</span> <span class="main">∈</span> blocksSeen <span class="free">s</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonInitBlks_def blocksSeen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> maxBlk <span class="free">s</span> <span class="free">q</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def blocksSeen_def 
      allBlocksRead_def allRdBlks_def rdBy_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> maxBlk_b asm3
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>maxBlk <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def allBlocks_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bk_noninit act
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase1_maxBalInp"><span class="command">lemma</span></span> HEndPhase1_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>  <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> act
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">q</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">r</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"IsMajority<span class="main">(</span><span class="var">?M</span><span class="main">)</span>"</span></span><span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>  
      <span class="keyword1"><span class="command">with</span></span> majorities_intersect asm2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∩</span> <span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">q</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> pnq
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> asm4 asm3 act True
    <span class="keyword1"><span class="command">have</span></span> p42<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> True act
    <span class="keyword1"><span class="command">have</span></span> thesis_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> p42
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">br</span>
      <span class="keyword3"><span class="command">assume</span></span> br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">br</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="free">q</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>block <span class="skolem">br</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> br_rdBy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">br</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> rdBy <span class="free">s</span> <span class="main">(</span>proc <span class="skolem">br</span><span class="main">)</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  rdBy_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> br_blksof<span class="main">:</span> <span class="quoted"><span class="quoted">"block <span class="skolem">br</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="main">(</span>proc <span class="skolem">br</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> br <span class="keyword1"><span class="command">have</span></span> br_bseen<span class="main">:</span> <span class="quoted"><span class="quoted">"block <span class="skolem">br</span><span class="main">∈</span> blocksSeen <span class="free">s</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksSeen_def allBlocksRead_def allRdBlks_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> HEndPhase1_valueChosen_inp<span class="main">[</span><span class="operator">OF</span> act inv2a asm1 br_blksof br_bseen b_bal asm3 inv1<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> asm3 HEndPhase1_allBlocks<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> asm4
    <span class="keyword1"><span class="command">have</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> p42<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> act
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IsMajority <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span>disksWritten <span class="free">s</span> <span class="free">q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">q</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">q</span> <span class="bound">d</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"IsMajority <span class="var">?S</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> majorities_intersect asm2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∩</span> <span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span>disksWritten <span class="free">s</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> inv2b False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def Inv2b_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> p42 p41 False
      <span class="keyword1"><span class="command">have</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> db_blksof<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> blocksOf <span class="free">s</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksOf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> db_bseen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> blocksSeen <span class="free">s</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blocksSeen_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> HEndPhase1_valueChosen_inp<span class="main">[</span><span class="operator">OF</span> act inv2a asm1 db_blksof db_bseen b_bal asm3 inv1<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> asm3 HEndPhase1_allBlocks<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="free">q</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def blocksOf_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase1_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> asm3 b_bal 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span>  <span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> act False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">¬</span> <span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bk b_bal
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase1_valueChosen2"><span class="command">lemma</span></span> HEndPhase1_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dblk_mbal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">assume</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def 
      hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> act hasRead
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def InitializePhase_def hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase1_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm1 asm2 asm3 asm4 inv1 inv2a inv2b<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase1_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HStartBallot_maxBalInp"><span class="command">lemma</span></span> HStartBallot_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HStartBallot_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> asm3 b_bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span><span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> asm3
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def allBlocks_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> act bk b_bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HStartBallot_valueChosen2"><span class="command">lemma</span></span> HStartBallot_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act hasRead
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def
                 hasRead_def <span class="quasi_keyword">split</span> <span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dblk_mbal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> act hasRead
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def 
      hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> act hasRead
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def InitializePhase_def
                      hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HStartBallot_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HStartBallot_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HPhase1or2Write_maxBalInp"><span class="command">lemma</span></span> HPhase1or2Write_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HPhase1or2Write_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> asm3 b_bal
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HPhase1or2Write_valueChosen2"><span class="command">lemma</span></span> HPhase1or2Write_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">pp</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">pp</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d1</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d1</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span><span class="main">=</span><span class="free">d</span><span class="main">∧</span><span class="free">pp</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> inv4 act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HInv4a2 <span class="free">s</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def HInv4a_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> asm2 majorities_intersect
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">dd</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">dd</span> <span class="free">p</span><span class="main">)</span><span class="main">≤</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4a2_def MajoritySet_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dd</span></span> <span class="keyword2"><span class="keyword">where</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dd</span><span class="main">∈</span><span class="free">D</span> <span class="main">∧</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="free">p</span><span class="main">)</span><span class="main">≤</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> asm4 p41
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> p41
    <span class="keyword1"><span class="command">have</span></span> p42<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> act True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> disk <span class="free">s'</span> <span class="free">d</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p42 True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> act asm4 d
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act hasRead
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def InitializePhase_def
                      hasRead_def <span class="quasi_keyword">split</span> <span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dblk_mbal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> act hasRead
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def InitializePhase_def 
      hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> act hasRead
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def InitializePhase_def
                      hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase1or2Write_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HPhase1or2Write_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm2 asm4 inv4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DiskPaxos_Chosen-HPhase1or2ReadThen_maxBalInp"><span class="command">lemma</span></span> HPhase1or2ReadThen_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HPhase1or2ReadThen_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> asm3 b_bal
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HPhase1or2ReadThen_valueChosen2"><span class="command">lemma</span></span> HPhase1or2ReadThen_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span> <span class="free">pp</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dd</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dd</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">dd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">dd</span> <span class="skolem">qq</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dd</span><span class="main">∈</span><span class="free">D</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">qq</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">qq</span> <span class="skolem">dd</span> <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">qq</span> <span class="skolem">dd</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">=</span><span class="skolem">dd</span> <span class="main">∧</span> <span class="skolem">qq</span><span class="main">=</span><span class="free">q</span> <span class="main">∧</span> <span class="free">pp</span><span class="main">=</span><span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> d asm4
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">dd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> act True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> phase' act
    <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">qq</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">qq</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">qq</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dblk_mbal
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">qq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">from</span></span> act hasRead False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">qq</span> <span class="skolem">dd</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def 
  hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">qq</span> <span class="skolem">dd</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> act hasRead
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">qq</span> <span class="skolem">dd</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase1or2ReadThen_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HPhase1or2ReadThen_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_valueChosen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">r</span><span class="main">;</span> valueChosen <span class="free">s</span> <span class="free">v</span><span class="main">;</span> <span class="free">v</span><span class="main">∈</span> Inputs  <span class="main">⟧</span>
     <span class="main">⟹</span> valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HStartBallot_valueChosen
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase2_maxBalInp"><span class="command">lemma</span></span> HEndPhase2_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase2_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> asm3 b_bal
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase2_valueChosen2"><span class="command">lemma</span></span> HEndPhase2_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act hasRead
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def
                      hasRead_def <span class="quasi_keyword">split</span> <span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dblk_mbal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> act hasRead
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def 
      hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> act hasRead
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def InitializePhase_def
                      hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase2_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase2_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HFail_maxBalInp"><span class="command">lemma</span></span> HFail_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HFail_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> asm3 b_bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span><span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="skolem">bk</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitDB_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Ballot_nzero asm1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> b_bal
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HFail_valueChosen2"><span class="command">lemma</span></span> HFail_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act hasRead
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def
                  hasRead_def <span class="quasi_keyword">split</span> <span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dblk_mbal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> act hasRead
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def 
      hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> act hasRead
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def InitializePhase_def hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HFail_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm1 asm3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HFail_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HPhase0Read_maxBalInp"><span class="command">lemma</span></span> HPhase0Read_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HPhase0Read_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span> asm3 b_bal
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HPhase0Read_valueChosen2"><span class="command">lemma</span></span> HPhase0Read_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">qq</span> <span class="free">dd</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act
  <span class="keyword1"><span class="command">have</span></span> qqnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">qq</span><span class="main">≠</span><span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> phase' act hasRead
    <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def hasRead_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dblk_mbal
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">from</span></span> act hasRead qqnq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def hasRead_def
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> act hasRead
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def InitializePhase_def
                        hasRead_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase0Read_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm3<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HPhase0Read_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase0_maxBalInp"><span class="command">lemma</span></span> HEndPhase0_maxBalInp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bk</span>
  <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span> <span class="main">∈</span> allBlocks <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> HEndPhase0_allBlocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act<span class="main"><span class="main">]</span></span> bk<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> asm3 b_bal
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span><span class="main">{</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> HEndPhase0_some<span class="main">[</span><span class="operator">OF</span> act inv1<span class="main">]</span> act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ba</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">q</span><span class="main">.</span> bal <span class="bound">ba</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> inp <span class="bound">ba</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ba</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> ba_blksread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ba</span><span class="main">∈</span>allBlocksRead <span class="free">s</span> <span class="free">q</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> ba_balinp<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="skolem">ba</span> <span class="main">=</span> bal <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> inp <span class="skolem">ba</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"allBlocksRead <span class="free">s</span> <span class="free">q</span> <span class="main">⊆</span> allBlocks <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocksRead_def allRdBlks_def
                        allBlocks_def blocksOf_def rdBy_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> subsetD<span class="main">[</span><span class="operator">OF</span> this ba_blksread<span class="main">]</span> ba_balinp bk b_bal asm3
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Chosen-HEndPhase0_valueChosen2"><span class="command">lemma</span></span> HEndPhase0_valueChosen2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span>   <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> act asm4
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dblk_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase' act hasRead
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"dblock <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def
                       hasRead_def <span class="quasi_keyword">split</span> <span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dblk_mbal
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> act hasRead
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def 
      hasRead_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p31 asm4 d
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> act hasRead
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> <span class="free">b</span><span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def InitializePhase_def
                      hasRead_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_valueChosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vc<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v_input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Inputs"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vc
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        asm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm3<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>  <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>
                   <span class="main">∧</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span><span class="main">(</span>   phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span>
                          <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span>
                          <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span>
                         <span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase0_maxBalInp<span class="main">[</span><span class="operator">OF</span> act asm3 inv1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> HEndPhase0_valueChosen2<span class="main">[</span><span class="operator">OF</span> act asm4<span class="main">]</span> asm1 asm2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="DiskPaxos_Inv6">
<div class="head">
<h1>Theory DiskPaxos_Inv6</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Inv6 <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Chosen.html">DiskPaxos_Chosen</a>  <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant 6›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
The final conjunct of $HInv$ asserts that, once an output has been chosen, 
$valueChosen(chosen)$ holds, and each processor's output equals either $chosen$ or
$NotAnInput$.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv6</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> NotAnInput<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HInit_HInv6<span class="main">:</span> <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟹</span> HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def Init_def InitDB_def HInv6_def<span class="main">)</span>

<span class="keyword1" id="DiskPaxos_Inv6-HEndPhase2_Inv6_1"><span class="command">lemma</span></span> HEndPhase2_Inv6_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> chosen'<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span><span class="main">=</span>NotAnInput"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv5 act
  <span class="keyword1"><span class="command">have</span></span> inv5R<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner_R <span class="free">s</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ep2_maj<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="main">{</span><span class="bound">d</span> <span class="main">.</span>    <span class="bound">d</span> <span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span>
                                  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HInv5_inner_def<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">D</span> <span class="main">∈</span> MajoritySet<span class="main">.</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span>
      <span class="keyword1"><span class="command">from</span></span> ep2_maj Dmaj majorities_intersect
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> dinD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> ddisk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> dhasR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span> <span class="bound">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> inv2b
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2b_inner <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ddisk
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_inner_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> inv2c phase
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> dhasR dinD
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv5R
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv5_inner_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p33<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> act 
    <span class="keyword1"><span class="command">have</span></span> outpt'<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">:=</span> inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> outpt'_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="free">p</span><span class="main">≠</span><span class="bound">q</span> <span class="main">⟶</span> outpt <span class="free">s'</span> <span class="bound">q</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> pnq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> outpt' pnq
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">q</span><span class="main">=</span> outpt <span class="free">s</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True inv2c
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">q</span><span class="main">=</span> NotAnInput"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> True act chosen'
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pa</span>
      <span class="keyword3"><span class="command">assume</span></span> outpt'_pa<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">pa</span> <span class="main">≠</span> NotAnInput"</span></span>
      <span class="keyword1"><span class="command">from</span></span> outpt'_q
      <span class="keyword1"><span class="command">have</span></span> someeq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pa</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">pa</span> <span class="main">≠</span> NotAnInput <span class="main">⟹</span> <span class="bound">pa</span><span class="main">=</span><span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> outpt'_pa
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="free">p</span> <span class="main">≠</span> NotAnInput"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> some_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput"</span></span><span class="main">,</span> <span class="operator">OF</span> this someeq2<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput<span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> outpt'
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput<span class="main">)</span> <span class="main">=</span> inp <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> act
    <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p32
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> HEndPhase2_allBlocks<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ep2_maj inv2b majorities_intersect
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>   disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span>
                              <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def Inv2b_inner_def MajoritySet_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>MajoritySet"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> p34<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span>   disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> p35<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="main">(</span> phase <span class="free">s</span> <span class="bound">q</span><span class="main">=</span><span class="main">1</span> <span class="main">∧</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span><span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> 
                        <span class="main">⟶</span> <span class="main">⦇</span>block<span class="main">=</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">,</span> proc<span class="main">=</span><span class="free">p</span><span class="main">⦈</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> dD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> phase_q<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">q</span><span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> bal_mbal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">≤</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> phase inv2c
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv2c phase
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span><span class="main">.</span> mbal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>block<span class="main">=</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">,</span> proc<span class="main">=</span><span class="skolem">q</span><span class="main">⦈</span><span class="main">∉</span>blocksRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bal_mbal
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> phase phase_q
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> p34 dD
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s</span> <span class="free">p</span> <span class="skolem">d</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> phase phase_q hasRead inv3 p41
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>block <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span><span class="main">,</span> proc <span class="main">=</span> <span class="free">p</span><span class="main">⦈</span> <span class="main">∈</span> blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv3_def HInv3_inner_def 
                        HInv3_L_def HInv3_R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> p36<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> phase <span class="free">s'</span> <span class="bound">q</span><span class="main">=</span><span class="main">1</span> <span class="main">∧</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s'</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">=</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> dD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> phase_q<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
           <span class="keyword2"><span class="keyword">and</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span> hasRead<span class="main">:</span> <span class="quoted"><span class="quoted">"hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> phase_q act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">q</span><span class="main">=</span>phase <span class="free">s</span> <span class="skolem">q</span> <span class="main">∧</span> dblock <span class="free">s'</span> <span class="skolem">q</span><span class="main">=</span>dblock <span class="free">s</span> <span class="skolem">q</span> <span class="main">∧</span> hasRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">=</span>hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span> <span class="free">p</span> <span class="main">∧</span> blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">=</span>blocksRead <span class="free">s</span> <span class="skolem">q</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def hasRead_def InitializePhase_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p35 phase_q bal hasRead dD
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>block<span class="main">=</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">,</span> proc<span class="main">=</span><span class="free">p</span><span class="main">⦈</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="skolem">q</span> <span class="skolem">d</span><span class="main">.</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span> <span class="main">=</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> p36_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> phase <span class="free">s'</span> <span class="bound">q</span><span class="main">=</span><span class="main">1</span> <span class="main">∧</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal<span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s'</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span>
                         <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> act 
  <span class="keyword1"><span class="command">have</span></span> bal_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s'</span> <span class="free">p</span><span class="main">)</span><span class="main">=</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disk<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s'</span><span class="main">=</span> disk <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bal_dblock p33
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> disk p34
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s'</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span>
                   <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s'</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span>
                         <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> phase <span class="free">s'</span> <span class="bound">q</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∧</span>
                              bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s'</span> <span class="bound">q</span> <span class="bound">d</span> <span class="free">p</span> <span class="main">⟶</span>
                              <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s'</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> bal <span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p36_2 Dmaj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> phase inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">∈</span> Ballot <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> act
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> chosen <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> False inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase2_valueChosen<span class="main">[</span><span class="operator">OF</span> act this<span class="main">]</span> p31 False InputsOrNi
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-valueChosen_equal_case"><span class="command">lemma</span></span> valueChosen_equal_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> max_v<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">b</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> MajoritySet"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> max_w<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="free">ba</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Damaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Da</span> <span class="main">∈</span> MajoritySet"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="free">Da</span><span class="main">.</span> <span class="free">ba</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="free">pa</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> b_ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≤</span><span class="free">ba</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">=</span><span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">pa</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def blocksOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> majorities_intersect Dmaj Damaj
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="free">D</span><span class="main">∩</span><span class="free">Da</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="free">pa</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> dinmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="free">D</span><span class="main">∩</span><span class="free">Da</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dab<span class="main">:</span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">pa</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> asm_w 
  <span class="keyword1"><span class="command">have</span></span> ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ba</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">pa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> b_ba 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">pa</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> max_v dab
  <span class="keyword1"><span class="command">have</span></span> v_value<span class="main">:</span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">pa</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ba max_w dab
  <span class="keyword1"><span class="command">have</span></span> w_value<span class="main">:</span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">pa</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v_value
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-valueChosen_equal"><span class="command">lemma</span></span> valueChosen_equal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">=</span><span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">aa</span> <span class="skolem">ba</span> <span class="skolem">p</span> <span class="skolem">D</span> <span class="skolem">pa</span> <span class="skolem">Da</span>
  <span class="keyword3"><span class="command">assume</span></span> max_v<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∧</span>
                   <span class="skolem">b</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">p</span> <span class="main">⟶</span>
                   <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal <span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> max_w<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="skolem">ba</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Damaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Da</span> <span class="main">∈</span> MajoritySet"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> asm_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">Da</span><span class="main">.</span> <span class="skolem">ba</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">pa</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> phase <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∧</span>
                   <span class="skolem">ba</span> <span class="main">≤</span> mbal <span class="main">(</span>dblock <span class="free">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> hasRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span> <span class="skolem">pa</span> <span class="main">⟶</span>
                   <span class="main">(</span><span class="main">∃</span><span class="bound">br</span><span class="main">∈</span>blocksRead <span class="free">s</span> <span class="bound">q</span> <span class="bound">d</span><span class="main">.</span> <span class="skolem">ba</span> <span class="main">≤</span> bal <span class="main">(</span>block <span class="bound">br</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> asm_v
  <span class="keyword1"><span class="command">have</span></span> asm_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> asm_w
  <span class="keyword1"><span class="command">have</span></span> asm_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">Da</span><span class="main">.</span> <span class="skolem">ba</span> <span class="main">≤</span> bal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">pa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">=</span><span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≤</span><span class="skolem">ba</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> valueChosen_equal_case<span class="main">[</span><span class="operator">OF</span> max_v Dmaj asm_v max_w Damaj asm_w True<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> valueChosen_equal_case<span class="main">[</span><span class="operator">OF</span> max_w Damaj asm_w max_v Dmaj asm_v<span class="main">]</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-HEndPhase2_Inv6_2"><span class="command">lemma</span></span> HEndPhase2_Inv6_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="free">r</span> <span class="main">≠</span> NotAnInput"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="free">r</span> <span class="main">=</span> chosen <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span><span class="main">=</span>NotAnInput"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> outpt <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> True act asm
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HNextPart_def 
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False act
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span><span class="main">≠</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase2_Inv6_1<span class="main">[</span><span class="operator">OF</span> act inv inv2b inv2c inv3 inv5 this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span><span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> False InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">∈</span> Inputs"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> valueChosen_equal<span class="main">[</span><span class="operator">OF</span> HEndPhase2_valueChosen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> act p31 this<span class="main"><span class="main">]</span></span> p32<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p33<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">=</span> chosen <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> maj<span class="main">:</span> <span class="quoted"><span class="quoted">"IsMajority <span class="main">{</span><span class="bound">d</span> <span class="main">.</span>    <span class="bound">d</span> <span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span>
                             <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"IsMajority <span class="var">?D</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> phase<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="free">r</span> <span class="main">=</span> NotAnInput"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> asm act
    <span class="keyword1"><span class="command">have</span></span> p41<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">=</span><span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> maj 
    <span class="keyword1"><span class="command">have</span></span> p42<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>UNIV<span class="main">-</span><span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> p43<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>    bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span>
                                             <span class="main">∧</span> <span class="main">¬</span>hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>     
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> Dmaj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> MajoritySet"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">q</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">=</span><span class="skolem">q</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> maj majorities_intersect Dmaj
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?D</span><span class="main">∩</span><span class="skolem">D</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="var">?D</span><span class="main">∩</span><span class="skolem">D</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span> disksWritten <span class="free">s</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="var">?D</span><span class="main">∩</span><span class="skolem">D</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> dD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> d inv2b
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span> <span class="main">=</span> dblock <span class="free">s</span> <span class="free">p</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2b_def Inv2b_inner_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> inv2c phase
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> mbal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="free">p</span><span class="main">)</span> "</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def Inv2c_inner_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> dD pq
          <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> bal <span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">&lt;</span> mbal <span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⟶</span> hasRead <span class="free">s</span> <span class="skolem">q</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> p42
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span> <span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span> hasRead <span class="free">s</span> <span class="free">p</span> <span class="bound">d</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> majorities_intersect Dmaj
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> inv5 act
    <span class="keyword1"><span class="command">have</span></span> p44<span class="main">:</span> <span class="quoted"><span class="quoted">"maxBalInp <span class="free">s</span> <span class="main">(</span>bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HInv5_inner_def 
                        HInv5_inner_R_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">∈</span><span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>maxBalInp <span class="free">s</span> <span class="bound">b</span> <span class="main">(</span>chosen <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">b</span><span class="main">≤</span> bal <span class="bound">bk</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> disk_allblks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span> <span class="bound">p</span><span class="main">.</span> disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">p</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def blocksOf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> p31
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span><span class="main">.</span> maxBalInp <span class="free">s</span> <span class="bound">b</span> <span class="main">(</span>chosen <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> 
      <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span>MajoritySet<span class="main">.</span><span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="bound">D</span><span class="main">.</span>  <span class="bound">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="bound">d</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valueChosen_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> majority_nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">d</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"IsMajority <span class="skolem">D</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">∈</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span>  
               maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="main">(</span>chosen <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">d</span><span class="main">∈</span><span class="skolem">D</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>disk <span class="free">s</span> <span class="skolem">d</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MajoritySet_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> disk_allblks
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bk</span></span> <span class="skolem"><span class="skolem">b</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> p45_bk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bk</span><span class="main">∈</span>allBlocks <span class="free">s</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">≤</span> bal <span class="skolem">bk</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> p45_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span><span class="main">(</span><span class="keyword1">UN</span> <span class="bound">p</span><span class="main">.</span> Ballot <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>maxBalInp <span class="free">s</span> <span class="skolem">b</span> <span class="main">(</span>chosen <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> p46<span class="main">:</span> <span class="quoted"><span class="quoted">"inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> chosen <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> bal<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dblock <span class="free">s</span> <span class="free">p</span> <span class="main">∈</span> allBlocks <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> allBlocks_def blocksOf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p45_b True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> p44 p45_bk False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inp <span class="skolem">bk</span> <span class="main">=</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p45_b p45_bk
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maxBalInp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> p41 p33 act
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> inv2c
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False asm inv2c act
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="free">r</span> <span class="main">=</span> outpt <span class="free">s</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def EndPhase2_def 
                 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> inv p33 False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase2_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv3 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv5<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv5_inner <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput"</span></span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase2_Inv6_1<span class="main">[</span><span class="operator">OF</span> act inv inv2b inv2c inv3 inv5 this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span><span class="main">≠</span> NotAnInput"</span></span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase2_Inv6_2<span class="main">[</span><span class="operator">OF</span> act inv inv2b inv2c inv3 inv5 this<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span> <span class="main">=</span> chosen <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-outpt_chosen"><span class="command">lemma</span></span> outpt_chosen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nextp<span class="main">:</span> <span class="quoted"><span class="quoted">"HNextPart <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> chosen <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">=</span> NotAnInput <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def Inv2c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt nextp
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-outpt_Inv6"><span class="command">lemma</span></span> outpt_Inv6<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span><span class="main">;</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>chosen <span class="free">s</span><span class="main">,</span> NotAnInput<span class="main">}</span><span class="main">;</span>
     Inv2c <span class="free">s</span><span class="main">;</span> HNextPart <span class="free">s</span> <span class="free">s'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>chosen <span class="free">s'</span><span class="main">,</span> NotAnInput<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> outpt_chosen
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> HStartBallot_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HStartBallot <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HStartBallot_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StartBallot_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_Inv6<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2Write_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2Write <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv4a <span class="free">s</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase1or2Write_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> inv4 this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Write_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_Inv6<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadThen_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadThen <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase1or2ReadThen_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadThen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_Inv6<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase1or2ReadElse_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase1or2ReadElse <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> HStartBallot_Inv6
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2ReadElse_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase1_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase1 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2a<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2b <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase1_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> inv1 inv2a inv2b this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_Inv6<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-outpt_chosen_2"><span class="command">lemma</span></span> outpt_chosen_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">:=</span> NotAnInput<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nextp<span class="main">:</span> <span class="quoted"><span class="quoted">"HNextPart <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">=</span> chosen <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> inv2c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">=</span> NotAnInput <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def Inv2c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> outpt nextp
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNextPart_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-outpt_HInv6_2"><span class="command">lemma</span></span> outpt_HInv6_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">:=</span> NotAnInput<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>chosen <span class="free">s</span><span class="main">,</span> NotAnInput<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nextp<span class="main">:</span> <span class="quoted"><span class="quoted">"HNextPart <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>chosen <span class="free">s'</span><span class="main">,</span> NotAnInput<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen_2<span class="main">[</span><span class="operator">OF</span> outpt inv2c nextp<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">=</span> chosen <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> inv outpt
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HFail_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HFail <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen_2 act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HFail_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">:=</span>NotAnInput<span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_HInv6_2<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HPhase0Read_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HPhase0Read <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HPhase0Read_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase0Read_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_Inv6<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> HEndPhase0_Inv6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act<span class="main">:</span> <span class="quoted"><span class="quoted">"HEndPhase0 <span class="free">s</span> <span class="free">s'</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv1 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_chosen act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> HEndPhase0_valueChosen<span class="main">[</span><span class="operator">OF</span> act<span class="main">]</span> inv1 this InputsOrNi
  <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">≠</span> NotAnInput <span class="main">⟶</span> valueChosen <span class="free">s'</span> <span class="main">(</span>chosen <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> act
  <span class="keyword1"><span class="command">have</span></span> outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="main">=</span> outpt <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> outpt_Inv6<span class="main">[</span><span class="operator">OF</span> outpt<span class="main">]</span> act inv2c inv
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> chosen <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  $HInv1 \wedge HInv2 \wedge HInv2' \wedge HInv3 \wedge HInv4 \wedge HInv5 \wedge HInv6$ 
  is an invariant of $HNext$.
›</span></span>

<span class="keyword1" id="DiskPaxos_Inv6-I2f"><span class="command">lemma</span></span> I2f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv1 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s</span> <span class="main">∧</span> HInv2 <span class="free">s'</span> <span class="main">∧</span> HInv3 <span class="free">s</span> <span class="main">∧</span> HInv4 <span class="free">s</span> <span class="main">∧</span> HInv5 <span class="free">s</span> <span class="main">∧</span> HInv6 <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def Next_def<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv2_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HStartBallot_Inv6<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase0Read_Inv6<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv4_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2Write_Inv6<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Phase1or2Read_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HPhase1or2ReadThen_Inv6
                 HPhase1or2ReadElse_Inv6<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase1or2_def HInv1_def HInv5_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase1_Inv6
                 HEndPhase2_Inv6<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HFail_Inv6<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> HEndPhase0_Inv6<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="DiskPaxos_Invariant">
<div class="head">
<h1>Theory DiskPaxos_Invariant</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos_Invariant <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Inv6.html">DiskPaxos_Inv6</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Complete Invariant›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HInv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HInv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>  <span class="main">(</span>HInv1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> 
            <span class="main">∧</span> HInv2 <span class="free"><span class="bound"><span class="entity">s</span></span></span>
            <span class="main">∧</span> HInv3 <span class="free"><span class="bound"><span class="entity">s</span></span></span>
            <span class="main">∧</span> HInv4 <span class="free"><span class="bound"><span class="entity">s</span></span></span>
            <span class="main">∧</span> HInv5 <span class="free"><span class="bound"><span class="entity">s</span></span></span>
            <span class="main">∧</span> HInv6 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> I1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"HInit <span class="free">s</span> <span class="main">⟹</span> HInv <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HInit_HInv1 HInit_HInv2 HInit_HInv3 
        HInit_HInv4 HInit_HInv5 HInit_HInv6
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> I2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span>  <span class="quoted"><span class="quoted">"HInv <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HInv <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv I2a<span class="main">[</span><span class="operator">OF</span> nxt<span class="main">]</span> I2b<span class="main">[</span><span class="operator">OF</span> nxt<span class="main">]</span> I2c<span class="main">[</span><span class="operator">OF</span> nxt<span class="main">]</span> 
            I2d<span class="main">[</span><span class="operator">OF</span> nxt<span class="main">]</span> I2e<span class="main">[</span><span class="operator">OF</span> nxt<span class="main">]</span> I2f<span class="main">[</span><span class="operator">OF</span> nxt<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DiskPaxos">
<div class="head">
<h1>Theory DiskPaxos</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Proving the Correctness of Disk Paxos

    Author:      Mauro J. Jaskelioff, Stephan Merz, 2005
    Maintainer:  Mauro J. Jaskelioff &lt;mauro at fceia.unr.edu.ar&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DiskPaxos <span class="keyword2"><span class="keyword">imports</span></span> <a href="DiskPaxos_Invariant.html">DiskPaxos_Invariant</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inner Module›</span></span>

<span class="keyword1"><span class="command">record</span></span>
Istate <span class="main">=</span>
  iinput <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> InputsOrNi"</span></span>
  ioutput <span class="main">::</span> <span class="quoted"><span class="quoted">"Proc <span class="main">⇒</span> InputsOrNi"</span></span>
  ichosen <span class="main">::</span> <span class="quoted">InputsOrNi</span>
  iallInput <span class="main">::</span> <span class="quoted"><span class="quoted">"InputsOrNi set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IInit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Istate <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IInit</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>  <span class="main">(</span>range <span class="main">(</span>iinput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⊆</span> Inputs
             <span class="main">∧</span> ioutput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> NotAnInput<span class="main">)</span>
             <span class="main">∧</span> ichosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> NotAnInput
             <span class="main">∧</span> iallInput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> range <span class="main">(</span>iinput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IChoose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Istate <span class="main">⇒</span> Istate <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IChoose</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>ioutput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> NotAnInput
                   <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>ichosen <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> NotAnInput<span class="main">)</span>
                        <span class="keyword1">then</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ip</span> <span class="main">∈</span> iallInput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span>  ichosen <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="bound">ip</span>
                                            <span class="main">∧</span> ioutput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>ioutput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:=</span> <span class="bound">ip</span><span class="main">)</span><span class="main">)</span>
                        <span class="keyword1">else</span> <span class="main">(</span>  ioutput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>ioutput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> ichosen <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
                               <span class="main">∧</span> ichosen <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> ichosen <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>
                    <span class="main">∧</span> iinput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> iinput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> iallInput <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">=</span> iallInput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">IFail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Istate <span class="main">⇒</span> Istate <span class="main">⇒</span> Proc <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">IFail</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span>   <span class="main">(</span>ioutput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>ioutput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> NotAnInput<span class="main">)</span>
                  <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ip</span> <span class="main">∈</span> Inputs<span class="main">.</span>  iinput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span>iinput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">:=</span> <span class="bound">ip</span><span class="main">)</span>
                                   <span class="main">∧</span> iallInput <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> iallInput <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="bound">ip</span><span class="main">}</span><span class="main">)</span>
                  <span class="main">∧</span> ichosen <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> ichosen <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">INext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Istate <span class="main">⇒</span> Istate <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">INext</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> IChoose <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span> <span class="main">∨</span> IFail <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">s2is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> Istate"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s2is</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⦇</span>iinput <span class="main">=</span> inpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> 
             ioutput <span class="main">=</span> outpt <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> 
             ichosen<span class="main">=</span>chosen <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>
             iallInput <span class="main">=</span> allInput <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> R1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> HInit <span class="free">s</span><span class="main">;</span> <span class="free">is</span> <span class="main">=</span> s2is <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> IInit <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInit_def IInit_def s2is_def Init_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> R2b<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv'<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"HNext <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> srel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">=</span>s2is <span class="free">s</span> <span class="main">∧</span> <span class="free">is'</span><span class="main">=</span>s2is <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> IFail <span class="free">is</span> <span class="free">is'</span> <span class="bound">p</span> <span class="main">∨</span> IChoose <span class="free">is</span> <span class="free">is'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∨</span> <span class="free">is</span> <span class="main">=</span> <span class="free">is'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> chg_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">≠</span><span class="free">is'</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> srel
  <span class="keyword1"><span class="command">have</span></span> s_change<span class="main">:</span> <span class="quoted"><span class="quoted">"   inpt <span class="free">s</span> <span class="main">≠</span> inpt <span class="free">s'</span> <span class="main">∨</span> outpt <span class="free">s</span> <span class="main">≠</span> outpt <span class="free">s'</span> 
                  <span class="main">∨</span> chosen <span class="free">s</span> <span class="main">≠</span> chosen <span class="free">s'</span> <span class="main">∨</span> allInput <span class="free">s</span> <span class="main">≠</span> allInput <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s2is_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> inv2c5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span>   inpt <span class="free">s</span> <span class="bound">p</span> <span class="main">∈</span> allInput <span class="free">s</span> 
                    <span class="main">∧</span> <span class="main">(</span>chosen <span class="free">s</span> <span class="main">=</span> NotAnInput <span class="main">⟶</span> outpt <span class="free">s</span> <span class="bound">p</span> <span class="main">=</span> NotAnInput<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def HInv2_def Inv2c_def Inv2c_inner_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> nxt s_change inv2c5
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inpt <span class="free">s'</span> <span class="main">≠</span> inpt <span class="free">s</span> <span class="main">∨</span> outpt <span class="free">s'</span> <span class="main">≠</span> outpt <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def Next_def HNextPart_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nxt
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> Fail <span class="free">s</span> <span class="free">s'</span> <span class="bound">p</span> <span class="main">∨</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def Next_def 
      StartBallot_def Phase0Read_def Phase1or2Write_def 
      Phase1or2Read_def Phase1or2ReadThen_def Phase1or2ReadElse_def 
      EndPhase1or2_def EndPhase1_def EndPhase0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> fail_or_endphase2<span class="main">:</span> <span class="quoted"><span class="quoted">"Fail <span class="free">s</span> <span class="free">s'</span> <span class="skolem">p</span> <span class="main">∨</span> EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> inv
  <span class="keyword1"><span class="command">have</span></span> inv2c<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2c_inner <span class="free">s</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def HInv2_def Inv2c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fail_or_endphase2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IFail <span class="free">is</span> <span class="free">is'</span> <span class="skolem">p</span> <span class="main">∨</span> IChoose <span class="free">is</span> <span class="free">is'</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fail<span class="main">:</span> <span class="quoted"><span class="quoted">"Fail <span class="free">s</span> <span class="free">s'</span> <span class="skolem">p</span> "</span></span>
    <span class="keyword1"><span class="command">hence</span></span> phase'<span class="main">:</span> <span class="quoted"><span class="quoted">"phase <span class="free">s'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>  outpt<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> NotAnInput<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IFail <span class="free">is</span> <span class="free">is'</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> fail srel
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ioutput <span class="free">is'</span> <span class="main">=</span> <span class="main">(</span>ioutput <span class="free">is</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> NotAnInput<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def s2is_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> nxt 
      <span class="keyword1"><span class="command">have</span></span> all_nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"allInput <span class="free">s'</span><span class="main">=</span> allInput <span class="free">s</span> <span class="main">∪</span> <span class="main">(</span>range <span class="main">(</span>inpt <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def HNextPart_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> fail srel
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ip</span> <span class="main">∈</span> Inputs<span class="main">.</span>  iinput <span class="free">is'</span> <span class="main">=</span> <span class="main">(</span>iinput <span class="free">is</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> <span class="bound">ip</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fail_def s2is_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ip</span></span> <span class="keyword2"><span class="keyword">where</span></span> ip_Input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ip</span><span class="main">∈</span>Inputs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iinput <span class="free">is'</span> <span class="main">=</span> <span class="main">(</span>iinput <span class="free">is</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> <span class="skolem">ip</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> inv2c5 srel all_nxt
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"  iinput <span class="free">is'</span> <span class="main">=</span> <span class="main">(</span>iinput <span class="free">is</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> <span class="skolem">ip</span><span class="main">)</span>
        <span class="main">∧</span> iallInput <span class="free">is'</span> <span class="main">=</span> iallInput <span class="free">is</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">ip</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s2is_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> outpt srel nxt inv2c
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ichosen <span class="free">is'</span> <span class="main">=</span> ichosen <span class="free">is</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def HNextPart_def s2is_def Inv2c_inner_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ip_Input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IFail_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> endphase2<span class="main">:</span> <span class="quoted"><span class="quoted">"EndPhase2 <span class="free">s</span> <span class="free">s'</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> endphase2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"phase <span class="free">s</span> <span class="skolem">p</span> <span class="main">=</span><span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> inv2c Ballot_nzero
    <span class="keyword1"><span class="command">have</span></span> bal_dblk_nzero<span class="main">:</span> <span class="quoted"><span class="quoted">"bal<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">p</span><span class="main">)</span><span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2c_inner_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> inv2a_dblock<span class="main">:</span> <span class="quoted"><span class="quoted">"Inv2a_innermost <span class="free">s</span> <span class="skolem">p</span> <span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def HInv2_def Inv2a_def Inv2a_inner_def blocksOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> p22<span class="main">:</span> <span class="quoted"><span class="quoted">"inp <span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> allInput <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inv2a_innermost_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> inv
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"allInput <span class="free">s</span> <span class="main">⊆</span> Inputs"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def HInv1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p22 NotAnInput endphase2
    <span class="keyword1"><span class="command">have</span></span> outpt_nni<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span> <span class="main">≠</span> NotAnInput"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s</span> <span class="main">=</span> NotAnInput"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> inv2c5
      <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> outpt <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> NotAnInput"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> endphase2
      <span class="keyword1"><span class="command">have</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> UNIV <span class="main">-</span><span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">q</span> <span class="main">=</span> NotAnInput"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> some_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">x</span> <span class="main">≠</span> NotAnInput <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p32 True nxt some_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> outpt <span class="free">s'</span> <span class="bound">p</span> <span class="main">≠</span> NotAnInput"</span></span><span class="main">,</span> <span class="operator">OF</span> outpt_nni some_eq<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> p33<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> outpt <span class="free">s'</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def HNextPart_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> endphase2
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span><span class="main">:=</span>inp<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True p22 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">(</span>chosen <span class="free">s</span> <span class="main">=</span> NotAnInput<span class="main">)</span>
                        <span class="keyword1">then</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ip</span> <span class="main">∈</span> allInput <span class="free">s</span><span class="main">.</span>  chosen <span class="free">s'</span> <span class="main">=</span> <span class="bound">ip</span>
                                            <span class="main">∧</span> outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="bound">ip</span><span class="main">)</span><span class="main">)</span>
                        <span class="keyword1">else</span> <span class="main">(</span>  outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> chosen <span class="free">s</span><span class="main">)</span>
                               <span class="main">∧</span> chosen <span class="free">s'</span> <span class="main">=</span> chosen <span class="free">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> endphase2 inv2c5 nxt
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inpt <span class="free">s'</span> <span class="main">=</span> inpt <span class="free">s</span> <span class="main">∧</span> allInput <span class="free">s'</span><span class="main">=</span> allInput <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HNext_def HNextPart_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> srel p31
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IChoose_def s2is_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nxt
      <span class="keyword1"><span class="command">have</span></span> p31<span class="main">:</span> <span class="quoted"><span class="quoted">"chosen <span class="free">s'</span> <span class="main">=</span> chosen <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HNext_def HNextPart_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> inv'
      <span class="keyword1"><span class="command">have</span></span> inv6<span class="main">:</span> <span class="quoted"><span class="quoted">"HInv6 <span class="free">s'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> p32<span class="main">:</span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span> <span class="main">=</span> chosen <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> endphase2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span>  <span class="main">=</span> inp<span class="main">(</span>dblock <span class="free">s</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> inv6 p31
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span>chosen <span class="free">s</span><span class="main">,</span> NotAnInput<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HInv6_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> outpt_nni
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> srel False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IChoose <span class="free">is</span> <span class="free">is'</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IChoose_def s2is_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> endphase2 inv2c
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s</span> <span class="skolem">p</span> <span class="main">=</span> NotAnInput"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def Inv2c_inner_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> endphase2 p31 p32 False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span><span class="main">:=</span> chosen <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> chosen <span class="free">s'</span> <span class="main">=</span> chosen <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> endphase2 nxt inv2c5
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inpt <span class="free">s'</span> <span class="main">=</span> inpt <span class="free">s</span> <span class="main">∧</span> allInput <span class="free">s'</span><span class="main">=</span> allInput <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> EndPhase2_def HNext_def HNextPart_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"  outpt <span class="free">s</span> <span class="skolem">p</span> <span class="main">=</span> NotAnInput 
              <span class="main">∧</span> outpt <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>outpt <span class="free">s</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> chosen <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> chosen <span class="free">s'</span> <span class="main">=</span> chosen <span class="free">s</span> 
              <span class="main">∧</span> inpt <span class="free">s'</span> <span class="main">=</span> inpt <span class="free">s</span> <span class="main">∧</span> allInput <span class="free">s'</span> <span class="main">=</span> allInput <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> IFail <span class="free">is</span> <span class="free">is'</span> <span class="bound">p</span> <span class="main">∨</span> IChoose <span class="free">is</span> <span class="free">is'</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>