<div id="Basis">
<div class="head">
<h1>Theory Basis</h1>
</div>
<pre class="source"><span class="comment1">(*  Author:     Stefan Berghofer, TU Muenchen, 2005
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Basis
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹General Utilities›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This section introduces some general utilities that will be useful later on in
the formalization of System \fsub{}.

The following rewrite rules are useful for simplifying mutual induction rules.
›</span></span>

<span class="keyword1" id="Basis-True_simps"><span class="command">lemma</span></span> True_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>True <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">PROP</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">⟹</span> True<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">PROP</span> Trueprop True"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">PROP</span> Trueprop True"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Unfortunately, the standard introduction and elimination rules for bounded
universal and existential quantifier do not work properly for sets of pairs.
›</span></span>

<span class="keyword1" id="Basis-ballpI"><span class="command">lemma</span></span> ballpI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Basis-bpspec"><span class="command">lemma</span></span> bpspec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Basis-ballpE"><span class="command">lemma</span></span> ballpE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Basis-bexpI"><span class="command">lemma</span></span> bexpI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Basis-bexpE"><span class="command">lemma</span></span> bexpE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Basis-ball_eq_sym"><span class="command">lemma</span></span> ball_eq_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Basis-wf_measure_size"><span class="command">lemma</span></span> wf_measure_size<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measure size<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">notation</span></span>
  Some <span class="main">(</span><span class="quoted">"<span class="keyword1">⌊</span>_<span class="keyword1">⌋</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span>
  None <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span>
  length <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span>_<span class="keyword1">∥</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span>
  Cons <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∷</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>66<span class="main">,</span> 65<span class="main">]</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following variant of the standard <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nth›</span></span></span></span> function returns
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊥›</span></span></span></span> if the index is out of range.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">nth_el</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span> <span class="main">[</span>90<span class="main">,</span> 0<span class="main">]</span> 91<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⌋</span> <span class="main">|</span> Suc <span class="bound">j</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">⟨</span></span><span class="bound">j</span><span class="main"><span class="free">⟩</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="free">xs</span><span class="main">∥</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">xs</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">xs</span><span class="main">∥</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">ys</span><span class="main">⟨</span><span class="free">i</span> <span class="main">-</span> <span class="main">∥</span><span class="free">xs</span><span class="main">∥</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Association lists›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">assoc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">⟨</span>_<span class="keyword1">⟩<span class="hidden">⇩</span><sub>?</sub></span>"</span> <span class="main">[</span>90<span class="main">,</span> 0<span class="main">]</span> 91<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⟩<span class="hidden">⇩</span><sub>?</sub></span></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⟩<span class="hidden">⇩</span><sub>?</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="main">⌊</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⌋</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⟩<span class="hidden">⇩</span><sub>?</sub></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">unique</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unique</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">unique</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">⟨</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">∧</span> <span class="free">unique</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Basis-assoc_set"><span class="command">lemma</span></span> assoc_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1" id="Basis-map_assoc_None"><span class="command">lemma</span></span> map_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ps</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span><span class="main">⟨</span><span class="free">x</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">no_syntax</span></span>
  <span class="quoted">"_Map"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"maplets <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(1</span><span class="keyword1">[</span>_<span class="keyword1">]</span><span class="keyword3">)</span>"</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="POPLmark">
<div class="head">
<h1>Theory POPLmark</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      POPLmark/POPLmark.thy
    Author:     Stefan Berghofer, TU Muenchen, 2005
*)</span>

<span class="keyword1"><span class="command">theory</span></span> POPLmark
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Basis.html">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Formalization of the basic calculus›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:basic-calculus}
In this section, we describe the formalization of the basic calculus
without records. As a main result, we prove {\it type safety}, presented
as two separate theorems, namely {\it preservation} and {\it progress}.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types and Terms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The types of System \fsub{} are represented by the following datatype:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span>
    TVar <span class="quoted">nat</span>
  <span class="main">|</span> Top
  <span class="main">|</span> Fun <span class="quoted">type</span> <span class="quoted">type</span>    <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>
  <span class="main">|</span> TyAll <span class="quoted">type</span> <span class="quoted">type</span>  <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∀&lt;:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The subtyping and typing judgements depend on a {\it context} (or environment) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
containing bindings for term and type variables. A context is a list of bindings,
where the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>th element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">⟩</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> corresponds to the variable
with index <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> binding <span class="main">=</span> VarB <span class="quoted">type</span> <span class="main">|</span> TVarB <span class="quoted">type</span>
<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"binding list"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In contrast to the usual presentation of type systems often found in textbooks, new
elements are added to the left of a context using the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Cons›</span></span></span></span> operator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∷›</span></span></span></span> for lists.
We write <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">is_TVarB</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the predicate that returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when applied to
a type variable binding, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">type_ofB</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> extracts the type contained in a binding,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">mapB</span></span> <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> applies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the type contained in a binding.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_TVarB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"binding <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_TVarB</span> <span class="main">(</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_TVarB</span> <span class="main">(</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">type_ofB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"binding <span class="main">⇒</span> type"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">type_ofB</span> <span class="main">(</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">type_ofB</span> <span class="main">(</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mapB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>type <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> binding <span class="main">⇒</span> binding"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapB</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> VarB <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mapB</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> TVarB <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following datatype represents the terms of System \fsub{}:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> trm <span class="main">=</span>
    Var <span class="quoted">nat</span>
  <span class="main">|</span> Abs <span class="quoted">type</span> <span class="quoted">trm</span>   <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">λ:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="main">|</span> TAbs <span class="quoted">type</span> <span class="quoted">trm</span>  <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">λ&lt;:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="main">|</span> App <span class="quoted">trm</span> <span class="quoted">trm</span>    <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∙</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>
  <span class="main">|</span> TApp <span class="quoted">trm</span> <span class="quoted">type</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting and Substitution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
One of the central operations of $\lambda$-calculus is {\it substitution}.
In order to avoid that free variables in a term or type get ``captured''
when substituting it for a variable occurring in the scope of a binder,
we have to increment the indices of its free variables during substitution.
This is done by the lifting functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>↑<span class="hidden">⇩</span><sub>τ</sub> n k›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>↑ n k›</span></span></span></span>
for types and terms, respectively, which increment the indices of all free
variables with indices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≥ k›</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The lifting functions on
types and terms are defined by
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> TVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Top <span class="main">=</span> Top"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> trm <span class="main">⇒</span> trm"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∙</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
It is useful to also define an ``unlifting'' function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>↓<span class="hidden">⇩</span><sub>τ</sub> n k›</span></span></span></span> for
decrementing all free variables with indices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≥ k›</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Moreover, we need several substitution functions, denoted by
\mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T[k ↦<span class="hidden">⇩</span><sub>τ</sub> S]<span class="hidden">⇩</span><sub>τ</sub>›</span></span></span></span>}, \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t[k ↦<span class="hidden">⇩</span><sub>τ</sub> S]›</span></span></span></span>}, and \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t[k ↦ s]›</span></span></span></span>},
which substitute type variables in types, type variables in terms,
and term variables in terms, respectively. They are defined as follows:
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substTT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> TVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">else</span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"Top<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> Top"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> trm <span class="main">⇒</span> trm"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦</span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">↑</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> trm"</span></span>    <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Lifting and substitution extends to typing contexts as follows:
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> env <span class="main">⇒</span> env"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> mapB <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> env"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">=</span> mapB <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>e</sub></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> env <span class="main">⇒</span> env"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Note that in a context of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">B</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, all variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with
indices smaller than the length of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> refer to entries in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and therefore
must not be affected by substitution and lifting. This is the reason why an
additional offset <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∥</span></span><span class="free"><span class="free">Γ</span></span><span class="main"><span class="main">∥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> needs to be added to the index <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
in the second clauses of the above functions. Some standard properties of lifting
and substitution, which can be proved by structural induction on terms and types,
are proved below. Properties of this kind are
quite standard for encodings using de Bruijn indices and can also be found in
papers by Barras and Werner \cite{Barras-Werner-JAR} and Nipkow \cite{Nipkow-JAR01}.
›</span></span>

<span class="keyword1" id="POPLmark-liftE_length"><span class="command">lemma</span></span> liftE_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-substE_length"><span class="command">lemma</span></span> substE_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">Γ</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-liftE_nth"><span class="command">lemma</span></span> liftE_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> map_option <span class="main">(</span>mapB <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-substE_nth"><span class="command">lemma</span></span> substE_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> map_option <span class="main">(</span>mapB <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span><span class="main">[</span><span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-liftT_liftT"><span class="command">lemma</span></span> liftT_liftT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-liftT_liftT'"><span class="command">lemma</span></span> liftT_liftT' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">j</span> <span class="main">-</span> <span class="improper">m</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">j</span> <span class="main">-</span> <span class="improper">m</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-lift_size"><span class="command">lemma</span></span> lift_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> size <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-liftT0"><span class="command">lemma</span></span> liftT0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-lift0"><span class="command">lemma</span></span> lift0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">↑</span> <span class="main">0</span> <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> substT_liftT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">k</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> liftT_substT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> liftT_substT' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
  <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">k'</span><span class="main">)</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-liftT_substT_Top"><span class="command">lemma</span></span> liftT_substT_Top <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k'</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-liftT_substT_strange"><span class="command">lemma</span></span> liftT_substT_strange<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">[</span><span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">0</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> prop"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-lift_lift"><span class="command">lemma</span></span> lift_lift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">↑</span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="main">↑</span> <span class="free">n</span> <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">↑</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-substT_substT"><span class="command">lemma</span></span> substT_substT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">T</span><span class="main">[</span>Suc <span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="main">[</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="free">T</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">V</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> prop"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formedness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:wf}
The subtyping and typing judgements to be defined in \secref{sec:subtyping}
and \secref{sec:typing} may only operate on types and contexts that
are well-formed. Intuitively, a type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed with respect to a
context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, if all variables occurring in it are defined in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
More precisely, if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains a type variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"TVar <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then
the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>th element of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must exist and have the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="free"><span class="free">U</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">well_formed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  wf_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> wf_Top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> Top"</span></span>
<span class="main">|</span> wf_arrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>
<span class="main">|</span> wf_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed, if all types occurring in it only refer to type variables
declared ``further to the right'':
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">well_formedE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span> <span class="main">[</span>50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">well_formedB</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> binding <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> type_ofB <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> wf_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span>"</span></span>
<span class="main">|</span> wf_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The judgement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub> B›</span></span></span></span>, which denotes well-formedness of the binding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
with respect to context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is just an abbreviation for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub> type_ofB B›</span></span></span></span>.
We now present a number of properties of the well-formedness judgements that will be used
in the proofs in the following sections.
›</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> well_formed_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> TVar <span class="free">i</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> Top"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">→</span> <span class="free">U</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">T</span><span class="main">.</span> <span class="free">U</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> well_formedE_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>

<span class="keyword1" id="POPLmark-wf_TVarB"><span class="command">lemma</span></span> wf_TVarB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> TVarB <span class="free">T</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-wf_VarB"><span class="command">lemma</span></span> wf_VarB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> VarB <span class="free">T</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmark-map_is_TVarb"><span class="command">lemma</span></span> map_is_TVarb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map is_TVarB <span class="free">Γ'</span> <span class="main">=</span> map is_TVarB <span class="free">Γ</span> <span class="main">⟹</span>
    <span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="free">T</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="free">Γ'</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="bound">T</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A type that is well-formed in a context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also well-formed in another context
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that contains type variable bindings at the same positions as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
›</span></span>

<span class="keyword1" id="POPLmark-wf_equallength"><span class="command">lemma</span></span> wf_equallength<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map is_TVarB <span class="free">Γ'</span> <span class="main">=</span> map is_TVarB <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_formed.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_is_TVarb<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A well-formed context of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">B</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> remains well-formed if we replace
the binding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by another well-formed binding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
›</span></span>

<span class="keyword1" id="POPLmark-wfE_replace"><span class="command">lemma</span></span> wfE_replace<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B'</span> <span class="main">⟹</span> is_TVarB <span class="free">B'</span> <span class="main">=</span> is_TVarB <span class="free">B</span> <span class="main">⟹</span>
    <span class="free">Δ</span> <span class="main">@</span> <span class="free">B'</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_equallength<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_equallength<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following weakening lemmas can easily be proved by structural induction on
types and contexts:
›</span></span>

<span class="keyword1" id="POPLmark-wf_weaken"><span class="command">lemma</span></span> wf_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-wf_weaken'"><span class="command">lemma</span></span> wf_weaken'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-wfE_weaken"><span class="command">lemma</span></span> wfE_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Intuitively, lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>wf_weaken›</span></span></span></span> states that a type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which is well-formed
in a context is still well-formed in a larger context, whereas lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>wfE_weaken›</span></span></span></span>
states that a well-formed context remains well-formed when extended with a
well-formed binding. Owing to the encoding of variables using de Bruijn
indices, the statements of the above lemmas involve additional lifting functions.
The typing judgement, which will be described in \secref{sec:typing}, involves
the lookup of variables in a context. It has already been pointed out earlier that each
entry in a context may only depend on types declared ``further to the right''. To ensure that
a type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stored at position <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in an environment <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is valid in the full
environment, as opposed to the smaller environment consisting only of the entries in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at positions greater than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we need to increment the indices of all
free type variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
›</span></span>

<span class="keyword1" id="POPLmark-wf_liftB"><span class="command">lemma</span></span> wf_liftB<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>VarB <span class="free">T</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VarB <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">nat</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> T<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="improper">nat</span><span class="main">)</span> <span class="main">0</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We also need lemmas stating that substitution of well-formed types preserves the well-formedness
of types and contexts:
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat Δ T nata<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">nat</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">nat</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nata</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> prop"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"TVarB <span class="improper">T1</span> <span class="main">∷</span> <span class="improper">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> wfE_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subtyping›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:subtyping}
We now come to the definition of the subtyping judgement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢ T &lt;: U›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">subtyping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> type <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">&lt;:</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  SA_Top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">&lt;:</span></span> Top"</span></span>
<span class="main">|</span> SA_refl_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">&lt;:</span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> SA_trans_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⌋</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> SA_arrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> SA_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> TVarB <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">&lt;:</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The rules <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_Top›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_refl_TVar›</span></span></span></span>, which appear at the leaves of
the derivation tree for a judgement <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="free"><span class="free">T</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">U</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, contain additional
side conditions ensuring the well-formedness of the contexts and types involved.
In order for the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_trans_TVar›</span></span></span></span> to be applicable, the context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
must be of the form \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">B</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has the length <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Since the indices of variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can only refer to variables defined in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, they have to be incremented by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to ensure that they point
to the right variables in the larger context <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="POPLmark-wf_subtype_env"><span class="command">lemma</span></span> wf_subtype_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="POPLmark-wf_subtype"><span class="command">lemma</span></span> wf_subtype<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">P</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_formed.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_equallength<span class="main">)</span>

<span class="keyword1" id="POPLmark-wf_subtypeE"><span class="command">lemma</span></span> wf_subtypeE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtype_env<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtype <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtype <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
By induction on the derivation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="free"><span class="free">T</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">U</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it can easily be shown
that all types and contexts occurring in a subtyping judgement must be well-formed:
›</span></span>

<span class="keyword1" id="POPLmark-wf_subtype_conj"><span class="command">lemma</span></span> wf_subtype_conj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">∧</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span> <span class="operator">iprover</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
By induction on types, we can prove that the subtyping relation is reflexive:
›</span></span>

<span class="keyword1" id="POPLmark-subtype_refl"><span class="command">lemma</span></span> subtype_refl<span class="main">:</span> <span class="comment1">― ‹A.1›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>
    subtyping.intros wf_Nil wf_TVarB <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> well_formed_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The weakening lemma for the subtyping relation is proved in two steps:
by induction on the derivation of the subtyping relation, we first prove
that inserting a single type into the context preserves subtyping:
›</span></span>

<span class="keyword1" id="POPLmark-subtype_weaken"><span class="command">lemma</span></span> subtype_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SA_Top
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_Top wfE_weaken wf_weaken<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> SA_refl_TVar
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_refl_TVar wfE_weaken <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_weaken<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_trans_TVar <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> SA_trans_TVar
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⟨</span><span class="skolem">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True SA_trans_TVar
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span>
      <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> TVar <span class="skolem">i</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_trans_TVar<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> False SA_trans_TVar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⟨</span>Suc <span class="skolem">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="skolem">U</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False SA_trans_TVar
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> TVar <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_trans_TVar<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> SA_arrow
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_arrow<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Δ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> SA_all<span class="main">(</span>4<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Δ</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_all<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
All cases are trivial, except for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_trans_TVar›</span></span></span></span> case, which
requires a case distinction on whether the index of the variable is smaller
than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∥</span></span><span class="free"><span class="free">Δ</span></span><span class="main"><span class="main">∥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The stronger result that appending a new context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to a context
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> preserves subtyping can be proved by induction on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
using the previous result in the induction step:
›</span></span>

<span class="keyword1" id="POPLmark-subtype_weaken'"><span class="command">lemma</span></span> subtype_weaken'<span class="main">:</span> <span class="comment1">― ‹A.2›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subtype_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
An unrestricted transitivity rule has the disadvantage that it can
be applied in any situation. In order to make the above definition of the
subtyping relation {\it syntax-directed}, the transitivity rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_trans_TVar›</span></span></span></span>
is restricted to the case where the type on the left-hand side of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>&lt;:›</span></span></span></span>
operator is a variable. However, the unrestricted transitivity rule
can be derived from this definition.
In order for the proof to go through, we have to simultaneously prove
another property called {\it narrowing}.
The two properties are proved by nested induction. The outer induction
is on the size of the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, whereas the two inner inductions for
proving transitivity and narrowing are on the derivation of the
subtyping judgements. The transitivity property is needed in the proof of
narrowing, which is by induction on the derivation of \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> TVarB <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">N</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}.
In the case corresponding to the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_trans_TVar›</span></span></span></span>, we must prove
\mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> TVarB <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> TVar <span class="free"><span class="free">i</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>}. The only interesting case
is the one where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">∥</span></span><span class="free"><span class="free">Δ</span></span><span class="main"><span class="main">∥</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. By induction hypothesis, we know that
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> TVarB <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="keyword1"><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">0</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> TVarB <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌊</span></span>TVarB <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
By assumption, we have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and hence 
\mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> TVarB <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="keyword1"><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">0</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="keyword1"><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">0</span></span> <span class="free"><span class="free">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} by weakening.
Since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">0</span></span> <span class="free"><span class="free">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has the same size as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we can use
the transitivity property, which yields
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Δ</span></span> <span class="main"><span class="main">@</span></span> TVarB <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">∷</span></span> <span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="keyword1"><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">0</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">&lt;:</span></span> <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The claim then follows
easily by an application of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_trans_TVar›</span></span></span></span>.
›</span></span>

<span class="keyword1" id="POPLmark-subtype_trans"><span class="command">lemma</span></span> subtype_trans<span class="main">:</span> <span class="comment1">― ‹A.3›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">Q</span> <span class="main">&lt;:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">&lt;:</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span>
     <span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">P</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">&lt;:</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_measure_size
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct_rule<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">Q'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">Q'</span> <span class="main">&lt;:</span> <span class="skolem">T</span> <span class="main">⟹</span> size <span class="skolem">Q</span> <span class="main">=</span> size <span class="skolem">Q'</span> <span class="main">⟹</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> SA_Top
      <span class="keyword1"><span class="command">from</span></span> SA_Top<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_Top SA_Top<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_refl_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_trans_TVar
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_trans_TVar<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_arrow <span class="skolem">Γ</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> SA_arrow' <span class="main">=</span> SA_arrow
      <span class="keyword1"><span class="command">from</span></span> SA_arrow<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> SA_Top
        <span class="keyword1"><span class="command">with</span></span> SA_arrow <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_Top wf_arrow <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_arrow <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> SA_arrow SA_arrow' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_arrow <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main"><span class="main">]</span></span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_arrow <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">Γ</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> SA_all' <span class="main">=</span> SA_all
      <span class="keyword1"><span class="command">from</span></span> SA_all<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> SA_Top
        <span class="keyword1"><span class="command">with</span></span> SA_all <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
          subtyping.SA_Top wf_all <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_equallength <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> SA_all SA_all' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">&lt;:</span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SA_all SA_all' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_all SA_all' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_all<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_all <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> tr <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">M</span> <span class="main">&lt;:</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">Q</span> <span class="main">∷</span> <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="skolem">M</span></span> <span class="quoted"><span class="skolem">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Δ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> SA_Top
      <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_Top
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_equallength wfE_replace <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_refl_TVar
      <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_refl_TVar
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_equallength wfE_replace <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_trans_TVar <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> SA_trans_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_trans_TVar<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">note</span></span> False' <span class="main">=</span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> SA_trans_TVar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="skolem">Q</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">Q</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_weaken'<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> SA_trans_TVar True False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> tr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> True <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword2"><span class="keyword">and</span></span> SA_trans_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_trans_TVar<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> False' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">with</span></span> False False' SA_trans_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_trans_TVar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_arrow
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_arrow<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_all
        SA_all<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Δ</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the proof of the preservation theorem presented in \secref{sec:evaluation},
we will also need a substitution theorem, which is proved by
induction on the subtyping derivation:
›</span></span>

<span class="keyword1" id="POPLmark-substT_subtype"><span class="command">lemma</span></span> substT_subtype<span class="main">:</span> <span class="comment1">― ‹A.10›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">&lt;:</span> <span class="free">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> T<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subtype_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-subst_subtype"><span class="command">lemma</span></span> subst_subtype<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">V</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">V</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:typing}
We are now ready to give a definition of the typing judgement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢ t : T›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> trm <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>    <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  T_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>VarB <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> T_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"VarB <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> T_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> T_TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"TVarB <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> T_TApp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
<span class="main">|</span> T_Sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Note that in the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T_Var›</span></span></span></span>, the indices of the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> looked up in
the context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> need to be incremented in order for the type to be well-formed
with respect to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T_Abs›</span></span></span></span>, the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the
abstraction body <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may not contain the variable with index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>,
since it is a term variable. To compensate for the disappearance of the context
element <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"VarB <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the conclusion of thy typing rule, the indices of all
free type variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> have to be decremented by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>1›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_typeE1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> well_formedE_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_typeE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_liftB<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_typeE1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_typeE1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Like for the subtyping judgement, we can again prove that all types and contexts
involved in a typing judgement are well-formed:
›</span></span>
<span class="keyword1" id="POPLmark-wf_type_conj"><span class="command">lemma</span></span> wf_type_conj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">∧</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> wf_typeE1<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> wf_typeE2<span class="main">)</span> <span class="operator">iprover</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The narrowing theorem for the typing judgement states that replacing the type
of a variable in the context by a subtype preserves typability:
›</span></span>

<span class="keyword1" id="POPLmark-narrow_type"><span class="command">lemma</span></span> narrow_type<span class="main">:</span> <span class="comment1">― ‹A.7›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">P</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_replace<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split nat.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_TApp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmark-subtype_refl'"><span class="command">lemma</span></span> subtype_refl'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_typeE1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_typeE2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmark-Abs_type"><span class="command">lemma</span></span> Abs_type<span class="main">:</span> <span class="comment1">― ‹A.13(1)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span> <span class="main">→</span> <span class="free">U'</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> VarB <span class="free">S</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
      <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">U'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">U</span> <span class="main">→</span> <span class="skolem">U'</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> ty1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ty2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">U'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> ty1 <span class="quoted"><span class="quoted">‹VarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> ty2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">S'</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T</span> <span class="main">&lt;:</span> <span class="skolem">U</span> <span class="main">→</span> <span class="skolem">U'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">U</span> <span class="main">→</span> <span class="skolem">U'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmark-Abs_type'"><span class="command">lemma</span></span> Abs_type'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="free">U</span> <span class="main">→</span> <span class="free">U'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> VarB <span class="free">S</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
    <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H subtype_refl' <span class="main">[</span><span class="operator">OF</span> H<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_type<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>

<span class="keyword1" id="POPLmark-TAbs_type"><span class="command">lemma</span></span> TAbs_type<span class="main">:</span> <span class="comment1">― ‹A.13(2)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">U</span><span class="main">.</span> <span class="free">U'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
      TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ&lt;:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">U'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">U</span><span class="main">.</span> <span class="skolem">U'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> ty1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ty2<span class="main">:</span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">U</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">U'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">U</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> narrow_type <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ty1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ty2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">S'</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">U</span><span class="main">.</span> <span class="skolem">U'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">U</span><span class="main">.</span> <span class="skolem">U'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmark-TAbs_type'"><span class="command">lemma</span></span> TAbs_type'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">U</span><span class="main">.</span> <span class="free">U'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
    TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H subtype_refl' <span class="main">[</span><span class="operator">OF</span> H<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> TAbs_type<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>

<span class="keyword1" id="POPLmark-T_eq"><span class="command">lemma</span></span> T_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The weakening theorem states that inserting a binding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
does not affect typing:
›</span></span>

<span class="keyword1" id="POPLmark-type_weaken"><span class="command">lemma</span></span> type_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span> <span class="main">⟹</span>
    <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">↑</span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">t</span> <span class="main">:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> T_TApp <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subtype_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftT_substT_strange <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="improper">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subtype_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We can strengthen this result, so as to mean that concatenating a new context
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Γ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> preserves typing:
›</span></span>

<span class="keyword1" id="POPLmark-type_weaken'"><span class="command">lemma</span></span> type_weaken'<span class="main">:</span> <span class="comment1">― ‹A.5(6)›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">↑</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">t</span> <span class="main">:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> type_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This property is proved by structural induction on the context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
using the previous result in the induction step. In the proof of the preservation
theorem, we will need two substitution theorems for term and type variables,
both of which are proved by induction on the typing derivation.
Since term and type variables are stored in the same context, we again have to
decrement the free type variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>1›</span></span></span></span>
in the substitution rule for term variables in order to compensate for the
disappearance of the variable.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> subst_type<span class="main">:</span> <span class="comment1">― ‹A.8›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⟹</span>
    <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">↦</span> <span class="free">u</span><span class="main">]</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> type_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TApp <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_subtype <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">S</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_subtype <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> substT_type<span class="main">:</span> <span class="comment1">― ‹A.11›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span>
    <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="main">]</span> <span class="main">:</span> <span class="free">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TApp <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substT_subtype<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">S</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substT_subtype<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:evaluation}
For the formalization of the evaluation strategy, it is useful to first define
a set of {\it canonical values} that are not evaluated any further. The canonical
values of call-by-value \fsub{} are exactly the abstractions over term and type variables:
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="quoted">"<span class="entity">value</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">value</span>"</span></span>
<span class="main">|</span> TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">value</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The notion of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is now used in the defintion of the evaluation
relation \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t ⟼ t'›</span></span></span></span>}. There are several ways for defining this evaluation
relation: Aydemir et al.\ \cite{PoplMark} advocate the use of {\it evaluation
contexts} that allow to separate the description of the ``immediate'' reduction rules,
i.e.\ $\beta$-reduction, from the description of the context in which these reductions
may occur in. The rationale behind this approach is to keep the formalization more modular.
We will take a closer look at this style of presentation in section
\secref{sec:evaluation-ctxt}. For the rest of this section, we will use a different
approach: both the ``immediate'' reductions and the reduction context are described
within the same inductive definition, where the context is described by additional
congruence rules.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> trm <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⟼</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  E_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_App1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> E_App2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> E_TApp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here, the rules <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Abs›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_TAbs›</span></span></span></span> describe the ``immediate'' reductions,
whereas <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_App1›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_App2›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_TApp›</span></span></span></span> are additional congruence
rules describing reductions in a context. The most important theorems of this section
are the {\it preservation} theorem, stating that the reduction of a well-typed term
does not change its type, and the {\it progress} theorem, stating that reduction of
a well-typed term does not ``get stuck'' -- in other words, every well-typed, closed
term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is either a value, or there is a term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to which <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
can be reduced. The preservation theorem
is proved by induction on the derivation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">:</span></span> <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, followed by a case
distinction on the last rule used in the derivation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">⟼</span></span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> preservation<span class="main">:</span> <span class="comment1">― ‹A.20›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">:</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">Γ</span> <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Var <span class="skolem">i</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_App <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"VarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_type' <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">S'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_App1 <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing.T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_App1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_App2 <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_App<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing.T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_App2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_TApp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> TAbs_type'<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_TApp<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substT_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_TAbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_TApp <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_TApp<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing.T_TApp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_TApp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">:</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing.T_Sub<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The progress theorem is also proved by induction on the derivation of
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">⊢</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">:</span></span> <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In the induction steps, we need the following two lemmas
about {\it canonical forms}
stating that closed values of types <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">→</span></span> <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀&lt;:</span></span><span class="free"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
must be abstractions over term and type variables, respectively.
›</span></span>

<span class="keyword1" id="POPLmark-Fun_canonical"><span class="command">lemma</span></span> Fun_canonical<span class="main">:</span> <span class="comment1">― ‹A.14(1)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span> <span class="bound">S</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="bound">S</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Abs
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_Sub<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub S<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="POPLmark-TyAll_canonical"><span class="command">lemma</span></span> TyAll_canonical<span class="main">:</span> <span class="comment1">― ‹A.14(3)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span> <span class="bound">S</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="bound">S</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀&lt;:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_TAbs
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_Sub<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub S<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Var
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Abs
  <span class="keyword1"><span class="command">from</span></span> value.Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="hidden">⇩</span><sub>1</sub>_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_App <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fun_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> T_App <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value"</span></span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t</span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub>_val <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_TAbs
  <span class="keyword1"><span class="command">from</span></span> value.TAbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_TApp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> TyAll_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="POPLmarkRecord">
<div class="head">
<h1>Theory POPLmarkRecord</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      POPLmark/POPLmarkRecord.thy
    Author:     Stefan Berghofer, TU Muenchen, 2005
*)</span>

<span class="keyword1"><span class="command">theory</span></span> POPLmarkRecord
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Basis.html">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extending the calculus with records›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:record-calculus}
We now describe how the calculus introduced in the previous section can
be extended with records. An important point to note is that many of the
definitions and proofs developed for the simple calculus can be reused.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Types and Terms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In order to represent records, we also need a type of {\it field names}.
For this purpose, we simply use the type of {\it strings}. We extend the
datatype of types of System \fsub{} by a new constructor <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>RcdT›</span></span></span></span>
representing record types.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">string</span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span>
    TVar <span class="quoted">nat</span>
  <span class="main">|</span> Top
  <span class="main">|</span> Fun <span class="quoted">type</span> <span class="quoted">type</span>    <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>
  <span class="main">|</span> TyAll <span class="quoted">type</span> <span class="quoted">type</span>  <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∀&lt;:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="main">|</span> RcdT <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> type<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> fldT <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> type"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> rcdT <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> type<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> binding <span class="main">=</span> VarB <span class="quoted">type</span> <span class="main">|</span> TVarB <span class="quoted">type</span>

<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"binding list"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">is_TVarB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"binding <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_TVarB</span> <span class="main">(</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_TVarB</span> <span class="main">(</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">type_ofB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"binding <span class="main">⇒</span> type"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">type_ofB</span> <span class="main">(</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">type_ofB</span> <span class="main">(</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mapB</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>type <span class="main">⇒</span> type<span class="main">)</span> <span class="main">⇒</span> binding <span class="main">⇒</span> binding"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapB</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> VarB <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mapB</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> TVarB <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
A record type is essentially an association list, mapping names of record fields
to their types.
The types of bindings and environments remain unchanged. The datatype <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>trm›</span></span></span></span>
of terms is extended with three new constructors <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Rcd›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Proj›</span></span></span></span>,
and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LET›</span></span></span></span>, denoting construction of a new record, selection of
a specific field of a record (projection), and matching of a record against
a pattern, respectively. A pattern, represented by datatype <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pat›</span></span></span></span>,
can be either a variable matching any value of a given type, or a nested
record pattern. Due to the encoding of variables using de Bruijn indices,
a variable pattern only consists of a type.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pat <span class="main">=</span> PVar <span class="quoted">type</span> <span class="main">|</span> PRcd <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> pat<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> trm <span class="main">=</span>
    Var <span class="quoted">nat</span>
  <span class="main">|</span> Abs <span class="quoted">type</span> <span class="quoted">trm</span>   <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">λ:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="main">|</span> TAbs <span class="quoted">type</span> <span class="quoted">trm</span>  <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(3</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">λ&lt;:</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="main">|</span> App <span class="quoted">trm</span> <span class="quoted">trm</span>    <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∙</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>
  <span class="main">|</span> TApp <span class="quoted">trm</span> <span class="quoted">type</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 200<span class="main">)</span>
  <span class="main">|</span> Rcd <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> trm<span class="main">)</span> list"</span></span>
  <span class="main">|</span> Proj <span class="quoted">trm</span> <span class="quoted">name</span>  <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">..</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>90<span class="main">,</span> 91<span class="main">]</span> 90<span class="main">)</span>
  <span class="main">|</span> LET <span class="quoted">pat</span> <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">LET</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">=</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 10<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> fld <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> trm"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> rcd <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> trm<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> fpat <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> pat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> rpat <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> pat<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In order to motivate the typing and evaluation rules for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LET›</span></span></span></span>, it is
important to note that an expression of the form
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> [display] <span class="raw_text"><span class="raw_text">"LET PRcd [(l<span class="hidden">⇩</span><sub>1</sub>, PVar T<span class="hidden">⇩</span><sub>1</sub>), …, (l<span class="hidden">⇩</span><sub>n</sub>, PVar T<span class="hidden">⇩</span><sub>n</sub>)] = Rcd [(l<span class="hidden">⇩</span><sub>1</sub>, v<span class="hidden">⇩</span><sub>1</sub>), …, (l<span class="hidden">⇩</span><sub>n</sub>, v<span class="hidden">⇩</span><sub>n</sub>)] IN t"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
can be treated like a nested abstraction <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(λ:T<span class="hidden">⇩</span><sub>1</sub>. … λ:T<span class="hidden">⇩</span><sub>n</sub>. t) ∙ v<span class="hidden">⇩</span><sub>1</sub> ∙ … ∙ v<span class="hidden">⇩</span><sub>n</sub>›</span></span></span></span>
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting and Substitution›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">psize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span>_<span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">rsize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rpat <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span>_<span class="keyword1">∥<span class="hidden">⇩</span><sub>r</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fsize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fpat <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span>_<span class="keyword1">∥<span class="hidden">⇩</span><sub>f</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∥</span></span>PVar <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∥</span></span>PRcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> <span class="main"><span class="free">∥</span></span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>r</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∥</span></span><span class="main">[]</span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∥</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="main">=</span> <span class="main"><span class="free">∥</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">+</span> <span class="main"><span class="free">∥</span></span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>r</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∥</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">=</span> <span class="main"><span class="free">∥</span></span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="keyword1"><span class="free">∥<span class="hidden">⇩</span><sub>p</sub></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">liftrT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> rcdT <span class="main">⇒</span> rcdT"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">liftfT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> fldT <span class="main">⇒</span> fldT"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> TVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Top <span class="main">=</span> Top"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>RcdT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> RcdT <span class="main">(</span><span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> pat <span class="main">⇒</span> pat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">liftrp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> rpat <span class="main">⇒</span> rpat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">liftfp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> fpat <span class="main">⇒</span> fpat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> PVar <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>PRcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> PRcd <span class="main">(</span><span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> trm <span class="main">⇒</span> trm"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">liftr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> rcd <span class="main">⇒</span> rcd"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">liftf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> fld <span class="main">⇒</span> fld"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∙</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> Rcd <span class="main">(</span><span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">IN</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main"><span class="free">↑</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substTT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substrTT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rcdT <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> rcdT"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substfTT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fldT <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> fldT"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> TVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">else</span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"Top<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> Top"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RcdT <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> RcdT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>τ</sub></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substpT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> pat"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>p</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substrpT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rpat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> rpat"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substfpT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fpat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> fpat"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> PVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PRcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> PRcd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>p</sub></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> pat <span class="main">⇒</span> pat"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>p</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>p</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In addition to the lifting and substitution functions already needed for the
basic calculus, we also have to define lifting and substitution functions
for patterns, which we denote by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">k</span></span> <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T</span></span><span class="main"><span class="main">[</span></span><span class="free"><span class="free">k</span></span> <span class="keyword1"><span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="free">S</span></span><span class="keyword1"><span class="keyword1">]<span class="hidden">⇩</span><sub>p</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
respectively. The extension of the existing lifting and substitution
functions to records is fairly standard.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> trm <span class="main">⇒</span> trm"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦</span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rcd <span class="main">⇒</span> nat <span class="main">⇒</span> trm <span class="main">⇒</span> rcd"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦</span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fld <span class="main">⇒</span> nat <span class="main">⇒</span> trm <span class="main">⇒</span> fld"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦</span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">↑</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Rcd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Note that the substitution function on terms is defined simultaneously
with a substitution function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">fs</span></span><span class="main"><span class="main">[</span></span><span class="free"><span class="free">k</span></span> <span class="main"><span class="main">↦</span></span> <span class="free"><span class="free">s</span></span><span class="keyword1"><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on records (i.e.\ lists
of fields), and a substitution function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span><span class="main"><span class="main">[</span></span><span class="free"><span class="free">k</span></span> <span class="main"><span class="main">↦</span></span> <span class="free"><span class="free">s</span></span><span class="keyword1"><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on fields.
To avoid conflicts with locally bound variables, we have to add an offset
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∥</span></span><span class="free"><span class="free">p</span></span><span class="keyword1"><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when performing substitution in the body of
the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LET›</span></span></span></span> binder, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∥</span></span><span class="free"><span class="free">p</span></span><span class="keyword1"><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the number of variables
in the pattern <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> trm"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substrT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rcd <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> rcd"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">substfT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fld <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> fld"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> Var <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">+</span><span class="main">1</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Rcd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>r</sub></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">liftE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> env <span class="main">⇒</span> env"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> mapB <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="keyword1"><span class="free">↑<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> env"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> _<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">=</span> mapB <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>e</sub></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For the formalization of the reduction
rules for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LET›</span></span></span></span>, we need a function \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t[k ↦<span class="hidden">⇩</span><sub>s</sub> us]›</span></span></span></span>}
for simultaneously substituting terms <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">us</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for variables with
consecutive indices:
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> nat <span class="main">⇒</span> trm list <span class="main">⇒</span> trm"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>300<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 300<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="main">[]</span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">∥</span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main"><span class="free">]</span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> env <span class="main">⇒</span> env"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decrT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> rcdT <span class="main">⇒</span> rcdT"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main">=</span> <span class="keyword1"><span class="free">↓<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fTs</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The lemmas about substitution and lifting are very similar to those needed
for the simple calculus without records, with the difference that most
of them have to be proved simultaneously with a suitable property for
records.
›</span></span>

<span class="keyword1" id="POPLmarkRecord-liftE_length"><span class="command">lemma</span></span> liftE_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-substE_length"><span class="command">lemma</span></span> substE_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="free">Γ</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftE_nth"><span class="command">lemma</span></span> liftE_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> map_option <span class="main">(</span>mapB <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-substE_nth"><span class="command">lemma</span></span> substE_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> map_option <span class="main">(</span>mapB <span class="main">(</span><span class="main">λ</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span><span class="main">[</span><span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-liftT_liftT"><span class="command">lemma</span></span> liftT_liftT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">rT</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">rT</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">fT</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="free">fT</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftT_liftT'"><span class="command">lemma</span></span> liftT_liftT' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">rT</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">rT</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">fT</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">fT</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">j</span> <span class="main">-</span> <span class="improper">m</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">j</span> <span class="main">-</span> <span class="improper">m</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-lift_size"><span class="command">lemma</span></span> lift_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> size <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"size_list <span class="main">(</span>size_prod <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> size<span class="main">)</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">rT</span><span class="main">)</span> <span class="main">=</span> size_list <span class="main">(</span>size_prod <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> size<span class="main">)</span> <span class="free">rT</span>"</span></span>
  <span class="quoted"><span class="quoted">"size_prod <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> size <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fT</span><span class="main">)</span> <span class="main">=</span> size_prod <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> size <span class="free">fT</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftT0"><span class="command">lemma</span></span> liftT0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">rT</span> <span class="main">=</span> <span class="free">rT</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">fT</span> <span class="main">=</span> <span class="free">fT</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftp0"><span class="command">lemma</span></span> liftp0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftp.induct liftrp.induct liftfp.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-lift0"><span class="command">lemma</span></span> lift0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">↑</span> <span class="main">0</span> <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">0</span> <span class="free">i</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lift.induct liftr.induct liftf.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> substT_liftT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">k</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">rT</span><span class="main">)</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">k</span> <span class="free">rT</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fT</span><span class="main">)</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">k</span> <span class="free">fT</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> liftT_substT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">rT</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">rT</span><span class="main">[</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">fT</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fT</span><span class="main">[</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> liftT_substT' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">k'</span><span class="main">)</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">rT</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">rT</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">k'</span><span class="main">)</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span>
     <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">fT</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">fT</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">k'</span><span class="main">)</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-liftT_substT_Top"><span class="command">lemma</span></span> liftT_substT_Top <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k'</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k'</span> <span class="main">(</span><span class="free">rT</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="free">rT</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k'</span> <span class="main">(</span><span class="free">fT</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k'</span><span class="main">)</span> <span class="free">fT</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> liftE_substE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">k'</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">[</span><span class="free">k'</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-liftT_decT"><span class="command">lemma</span></span> liftT_decT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">k'</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftT_substT_strange"><span class="command">lemma</span></span> liftT_substT_strange<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">[</span><span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">0</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">rT</span><span class="main">[</span><span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">rT</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">0</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fT</span><span class="main">[</span><span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">fT</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">0</span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> prop"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">k</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-liftp_liftp"><span class="command">lemma</span></span> liftp_liftp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">rp</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">rp</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fp</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">fp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rp</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fp</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftp.induct liftrp.induct liftfp.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftp_psize"><span class="command">lemma</span></span> liftp_psize<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">p</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> <span class="main">∥</span><span class="free">p</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">∥</span><span class="free">fs</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>r</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">f</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">=</span> <span class="main">∥</span><span class="free">f</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftp.induct liftrp.induct liftfp.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-lift_lift"><span class="command">lemma</span></span> lift_lift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">↑</span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="main">↑</span> <span class="free">n</span> <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">↑</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">fs</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">f</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span>
   <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lift.induct liftr.induct liftf.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftE_liftE"><span class="command">lemma</span></span> liftE_liftE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n'</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-liftE_liftE'"><span class="command">lemma</span></span> liftE_liftE' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">m</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-substT_substT"><span class="command">lemma</span></span> substT_substT<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
     <span class="free">T</span><span class="main">[</span>Suc <span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="main">[</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="free">T</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
     <span class="free">rT</span><span class="main">[</span>Suc <span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="main">[</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="free">rT</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
     <span class="free">fT</span><span class="main">[</span>Suc <span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="main">[</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="free">fT</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">[</span><span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">V</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> prop"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="improper">j</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-substT_decT"><span class="command">lemma</span></span> substT_decT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">i</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span><span class="main">[</span><span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">i</span> <span class="free">k</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-substT_decT'"><span class="command">lemma</span></span> substT_decT' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">T</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">k</span> <span class="free">j</span> <span class="main">(</span><span class="free">T</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Top</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-substE_substE"><span class="command">lemma</span></span> substE_substE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">Γ</span><span class="main">[</span>Suc <span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="main">[</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">=</span> <span class="free">Γ</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">[</span><span class="free">j</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">V</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-substT_decE"><span class="command">lemma</span></span> substT_decE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">Γ</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">k</span> <span class="free">j</span> <span class="main">(</span><span class="free">Γ</span><span class="main">[</span><span class="free">i</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substE_substE <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">Top</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-liftE_app"><span class="command">lemma</span></span> liftE_app <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">@</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-substE_app"><span class="command">lemma</span></span> substE_app <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">=</span> <span class="free">Γ</span><span class="main">[</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Δ</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-substs_app"><span class="command">lemma</span></span> substs_app <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ts</span> <span class="main">@</span> <span class="free">us</span><span class="main">]</span> <span class="main">=</span> <span class="free">t</span><span class="main">[</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">us</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ts</span><span class="main">]</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">us</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> decE_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> decE_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> mapB <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span><span class="main">)</span><span class="main">)</span> <span class="free">B</span> <span class="main">∷</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">B</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">B</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> decE_app <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">@</span> <span class="free">Δ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">@</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> decT_liftT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">m</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">+</span> <span class="improper">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="improper">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> decE_liftE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟹</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">m</span> <span class="free">k'</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> liftE0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span> <span class="free">k</span> <span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-decT_decT"><span class="command">lemma</span></span> decT_decT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-decE_decE"><span class="command">lemma</span></span> decE_decE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n'</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">n'</span><span class="main">)</span> <span class="free">k</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-decE_length"><span class="command">lemma</span></span> decE_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Γ</span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Γ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-liftrT_assoc_None"><span class="command">lemma</span></span> liftrT_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-liftrT_assoc_Some"><span class="command">lemma</span></span> liftrT_assoc_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free">T</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-liftrp_assoc_None"><span class="command">lemma</span></span> liftrp_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fps</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fps</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-liftr_assoc_None"><span class="command">lemma</span></span> liftr_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-unique_liftrT"><span class="command">lemma</span></span> unique_liftrT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unique <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> unique <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substrTT_assoc_None"><span class="command">lemma</span></span> substrTT_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substrTT_assoc_Some"><span class="command">lemma</span></span> substrTT_assoc_Some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">fs</span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free">T</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">⟨</span><span class="free">a</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substrT_assoc_None"><span class="command">lemma</span></span> substrT_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substrp_assoc_None"><span class="command">lemma</span></span> substrp_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fps</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fps</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substr_assoc_None"><span class="command">lemma</span></span> substr_assoc_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="main">↦</span> <span class="free">u</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-unique_substrT"><span class="command">lemma</span></span> unique_substrT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unique <span class="main">(</span><span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">=</span> unique <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-liftrT_set"><span class="command">lemma</span></span> liftrT_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-liftrT_setD"><span class="command">lemma</span></span> liftrT_setD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">T'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="bound">T'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substrT_set"><span class="command">lemma</span></span> substrT_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-substrT_setD"><span class="command">lemma</span></span> substrT_setD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">fs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T'</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">T'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="bound">T'</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formedness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The definition of well-formedness is extended with a rule stating that a
record type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free"><span class="free">fs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed, if for all fields <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">T</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
contained in the list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed, and
all labels <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are {\it unique}.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">well_formed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  wf_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> wf_Top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> Top"</span></span>
<span class="main">|</span> wf_arrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>
<span class="main">|</span> wf_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> TVarB <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> wf_RcdT<span class="main">:</span> <span class="quoted"><span class="quoted">"unique <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="bound">T</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> RcdT <span class="free"><span class="bound"><span class="entity">fs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">well_formedE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span> <span class="main">[</span>50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">well_formedB</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> binding <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> type_ofB <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> wf_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span>"</span></span>
<span class="main">|</span> wf_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> well_formed_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> TVar <span class="free">i</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> Top"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">→</span> <span class="free">U</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">T</span><span class="main">.</span> <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">(</span>RcdT <span class="free">fTs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> well_formedE_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>

<span class="keyword1" id="POPLmarkRecord-wf_TVarB"><span class="command">lemma</span></span> wf_TVarB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> TVarB <span class="free">T</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-wf_VarB"><span class="command">lemma</span></span> wf_VarB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> VarB <span class="free">T</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-map_is_TVarb"><span class="command">lemma</span></span> map_is_TVarb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map is_TVarB <span class="free">Γ'</span> <span class="main">=</span> map is_TVarB <span class="free">Γ</span> <span class="main">⟹</span>
    <span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="free">T</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> <span class="free">Γ'</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="bound">T</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-wf_equallength"><span class="command">lemma</span></span> wf_equallength<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map is_TVarB <span class="free">Γ'</span> <span class="main">=</span> map is_TVarB <span class="free">Γ</span> <span class="main">⟹</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_formed.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_is_TVarb<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_formed.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-wfE_replace"><span class="command">lemma</span></span> wfE_replace<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B'</span> <span class="main">⟹</span> is_TVarB <span class="free">B'</span> <span class="main">=</span> is_TVarB <span class="free">B</span> <span class="main">⟹</span>
     <span class="free">Δ</span> <span class="main">@</span> <span class="free">B'</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_equallength<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_equallength<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-wf_weaken"><span class="command">lemma</span></span> wf_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="comment1">― ‹records›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_RcdT<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> liftrT_setD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">T</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-wf_weaken'"><span class="command">lemma</span></span> wf_weaken'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-wfE_weaken"><span class="command">lemma</span></span> wfE_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span> <span class="main">⟹</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-wf_liftB"><span class="command">lemma</span></span> wf_liftB<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">⟨</span><span class="free">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>VarB <span class="free">T</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VarB <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">nat</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule_tac</span> T<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="improper">nat</span><span class="main">)</span> <span class="main">0</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">rT</span><span class="main">::</span>rcdT<span class="main">)</span><span class="main">.</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span>
     <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rT</span><span class="main">.</span> <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> snd <span class="main">(</span><span class="free">fT</span><span class="main">::</span>fldT<span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span>
     <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> snd <span class="free">fT</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">rT</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat Δ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">nat</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nata<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">nat</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nata</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> type1 type2 Δ<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> prop"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"TVarB <span class="improper">type1</span> <span class="main">∷</span> <span class="improper">Δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_RcdT<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> substrT_setD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">S</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> wfE_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subtyping›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The definition of the subtyping judgement is extended with a rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_Rcd›</span></span></span></span> stating
that a record type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free"><span class="free">fs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a subtype of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free"><span class="free">fs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, if
for all fields \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">T</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} contained in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, there exists a
corresponding field <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">S</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a subtype of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
If the list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is empty, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>SA_Rcd›</span></span></span></span> can appear as a leaf in
the derivation tree of the subtyping judgement. Therefore, the introduction
rule needs an additional premise <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="keyword1"><span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to make sure that only
subtyping judgements with well-formed contexts are derivable. Moreover,
since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can contain additional fields not present in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
we also have to require that the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free"><span class="free">fs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed.
In order to ensure that the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free"><span class="free">fs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed, too,
we only have to require that labels in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are unique, since,
by induction on the subtyping derivation, all types contained in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
are already well-formed.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">subtyping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> type <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">&lt;:</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  SA_Top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">&lt;:</span></span> Top"</span></span>
<span class="main">|</span> SA_refl_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">&lt;:</span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> SA_trans_TVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⌋</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> TVar <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> SA_arrow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> SA_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> TVarB <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">&lt;:</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> SA_Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> RcdT <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">⟹</span> unique <span class="free"><span class="bound"><span class="entity">fs'</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">fs'</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="bound">S</span> <span class="main"><span class="free">&lt;:</span></span> <span class="bound">T</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> RcdT <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">&lt;:</span></span> RcdT <span class="free"><span class="bound"><span class="entity">fs'</span></span></span>"</span></span>

<span class="keyword1" id="POPLmarkRecord-wf_subtype_env"><span class="command">lemma</span></span> wf_subtype_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="POPLmarkRecord-wf_subtype"><span class="command">lemma</span></span> wf_subtype<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">P</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> well_formed.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_equallength<span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-wf_subtypeE"><span class="command">lemma</span></span> wf_subtypeE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtype_env<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> H<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtype <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtype <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-subtype_refl"><span class="command">lemma</span></span> subtype_refl<span class="main">:</span> <span class="comment1">― ‹A.1›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">::</span>name<span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fTs</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">T</span> <span class="main">⟶</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">T</span> <span class="main">&lt;:</span> <span class="bound">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> snd <span class="main">(</span><span class="free">fT</span><span class="main">::</span>fldT<span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> snd <span class="free">fT</span> <span class="main">&lt;:</span> snd <span class="free">fT</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fTs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fT</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ</span></span>
    <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> liftT.induct liftrT.induct liftfT.induct<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.intros wf_Nil wf_TVarB bexpI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ballpI
       <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> well_formed_cases ballpE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexpE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="POPLmarkRecord-subtype_weaken"><span class="command">lemma</span></span> subtype_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SA_Top
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_Top wfE_weaken wf_weaken<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> SA_refl_TVar
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_refl_TVar wfE_weaken <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_weaken<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_trans_TVar <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> SA_trans_TVar
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⟨</span><span class="skolem">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True SA_trans_TVar
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span>
      <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> TVar <span class="skolem">i</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_trans_TVar<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">with</span></span> False SA_trans_TVar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span><span class="main">)</span><span class="main">⟨</span>Suc <span class="skolem">i</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>TVarB <span class="skolem">U</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False SA_trans_TVar
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> TVar <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_trans_TVar<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> SA_arrow
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_arrow<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> SA_all<span class="main">(</span>4<span class="main">)</span> <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Δ</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_all<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_Rcd <span class="skolem">fs</span> <span class="skolem">fs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> wfE_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> RcdT <span class="skolem">fs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">(</span>RcdT <span class="skolem">fs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> RcdT <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SA_Rcd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unique <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs'</span><span class="main">)</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">S</span> <span class="main">&lt;:</span> <span class="bound">T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">T</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">T'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> liftrT_setD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> SA_Rcd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      lS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">(</span><span class="skolem">T</span><span class="main">[</span><span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">T'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> lS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> liftrT_set<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> T
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> RcdT <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs</span><span class="main">)</span> <span class="main">&lt;:</span> RcdT <span class="main">(</span><span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="skolem">fs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_Rcd<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-subtype_weaken'"><span class="command">lemma</span></span> subtype_weaken'<span class="main">:</span> <span class="comment1">― ‹A.2›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subtype_weaken <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-fieldT_size"><span class="command">lemma</span></span> fieldT_size <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span> <span class="main">⟹</span> size <span class="free">T</span> <span class="main">&lt;</span> Suc <span class="main">(</span>size_list <span class="main">(</span>size_prod <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> size<span class="main">)</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="POPLmarkRecord-subtype_trans"><span class="command">lemma</span></span> subtype_trans<span class="main">:</span> <span class="comment1">― ‹A.3›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">Q</span> <span class="main">&lt;:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">&lt;:</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span>
     <span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">P</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">&lt;:</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_measure_size
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct_rule<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">Q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">Q'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">Q'</span> <span class="main">&lt;:</span> <span class="skolem">T</span> <span class="main">⟹</span> size <span class="skolem">Q</span> <span class="main">=</span> size <span class="skolem">Q'</span> <span class="main">⟹</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> SA_Top
      <span class="keyword1"><span class="command">from</span></span> SA_Top<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_Top SA_Top<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_refl_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_trans_TVar
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_trans_TVar<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_arrow <span class="skolem">Γ</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> SA_arrow' <span class="main">=</span> SA_arrow
      <span class="keyword1"><span class="command">from</span></span> SA_arrow<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> SA_Top
        <span class="keyword1"><span class="command">with</span></span> SA_arrow <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_Top wf_arrow <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_arrow <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> SA_arrow SA_arrow' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_arrow <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main"><span class="main">]</span></span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_arrow <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">Γ</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> SA_all' <span class="main">=</span> SA_all
      <span class="keyword1"><span class="command">from</span></span> SA_all<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> SA_Top
        <span class="keyword1"><span class="command">with</span></span> SA_all <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
          subtyping.SA_Top wf_all <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_equallength <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> SA_all SA_all' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">&lt;:</span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SA_all SA_all' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_all SA_all' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_all<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_all <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_Rcd <span class="skolem">Γ</span> <span class="skolem">fs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> SA_Rcd' <span class="main">=</span> SA_Rcd
      <span class="keyword1"><span class="command">from</span></span> SA_Rcd<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> SA_Top
        <span class="keyword1"><span class="command">with</span></span> SA_Rcd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_Top<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_Rcd <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>›</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> RcdT <span class="skolem">fs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹unique <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub>'</span>›</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="bound">S</span> <span class="main">&lt;:</span> <span class="bound">T</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="skolem">T</span>
          <span class="keyword3"><span class="command">assume</span></span> lT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> SA_Rcd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            fs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">U</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> UT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">with</span></span> SA_Rcd SA_Rcd' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            fs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> SU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> SA_Rcd SA_Rcd' fs2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">U</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> measure size"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> SU UT <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> fs1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="bound">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> RcdT <span class="skolem">fs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;:</span> RcdT <span class="skolem">fs<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_Rcd<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> SA_Rcd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> tr <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> refl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tr<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">M</span> <span class="main">&lt;:</span> <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">Q</span> <span class="main">∷</span> <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="skolem">M</span></span> <span class="quoted"><span class="skolem">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Δ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> SA_Top
      <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_Top
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_equallength wfE_replace <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_refl_TVar
      <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_refl_TVar
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_equallength wfE_replace <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_trans_TVar <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> SA_trans_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_trans_TVar<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">note</span></span> False' <span class="main">=</span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">from</span></span> SA_trans_TVar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wfE_replace <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_subtypeE<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="skolem">Q</span>›</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ</span> <span class="main">@</span> <span class="main">[</span>TVarB <span class="skolem">P</span><span class="main">]</span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">Q</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_weaken'<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> SA_trans_TVar True False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="skolem">T</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> tr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> True <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword2"><span class="keyword">and</span></span> SA_trans_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_trans_TVar<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> False' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">with</span></span> False False' SA_trans_TVar <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_trans_TVar<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> SA_arrow
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subtyping.SA_arrow<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_all <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subtyping.SA_all
        SA_all<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Δ</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SA_Rcd <span class="skolem">fs</span> <span class="skolem">fs'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">&lt;:</span> <span class="skolem">Q</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subtypeE<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> SA_Rcd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> wfE_replace<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SA_Rcd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">Q</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> RcdT <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> RcdT <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_equallength<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹unique <span class="skolem">fs'</span>›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> SA_Rcd
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs</span> <span class="main">∧</span> <span class="skolem">Δ</span> <span class="main">@</span> TVarB <span class="skolem">P</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="bound">S</span> <span class="main">&lt;:</span> <span class="bound">T</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.SA_Rcd<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-substT_subtype"><span class="command">lemma</span></span> substT_subtype<span class="main">:</span> <span class="comment1">― ‹A.10›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span>
    <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">S</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">&lt;:</span> <span class="free">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> T<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> wf_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">Γ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> subtype_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> substrT_setD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> substrT_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-subst_subtype"><span class="command">lemma</span></span> subst_subtype<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">V</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">V</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_refl_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_trans_TVar<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> substrT_setD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> substrT_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the formalization of the type checking rule for the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LET›</span></span></span></span> binder,
we use an additional judgement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊢ p : T ⇒ Δ›</span></span></span></span> for checking whether a
given pattern <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is compatible with the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of an object that
is to be matched against this pattern. The judgement will be defined simultaneously
with a judgement \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊢ ps [:] Ts ⇒ Δ›</span></span></span></span>} for type checking field patterns.
Apart from checking the type, the judgement also returns a list of bindings <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which can be thought of as a ``flattened'' list of types of the variables occurring
in the pattern. Since typing environments are extended ``to the left'', the bindings
in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Δ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> appear in reverse order.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ptyping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> type <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _ <span class="keyword1">⇒</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">ptypings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rpat <span class="main">⇒</span> rcdT <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">[:]</span> _ <span class="keyword1">⇒</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  P_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> PVar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">[</span>VarB <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> P_Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">[:]</span></span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> PRcd <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">:</span></span> RcdT <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span>"</span></span>
<span class="main">|</span> P_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="main">[]</span> <span class="main"><span class="free">[:]</span></span> <span class="main">[]</span> <span class="main"><span class="free">⇒</span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> P_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">Δ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">[:]</span></span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">Δ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span>
    <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span><span class="main">)</span> <span class="main"><span class="free">[:]</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">Δ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">∥</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">Δ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Δ<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The definition of the typing judgement for terms is extended with the rules <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T_Let›</span></span></span></span>,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T_Rcd</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">T_Proj</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for pattern matching, record construction and
field selection, respectively. The above typing judgement for patterns is used in
the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T_Let›</span></span></span></span>. The typing judgement for terms is defined simultaneously
with a typing judgement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢ fs [:] fTs›</span></span></span></span> for record fields.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> trm <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">typings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> rcd <span class="main">⇒</span> rcdT <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">[:]</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  T_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⌊</span>VarB <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Var <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> T_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"VarB <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> T_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> T_TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"TVarB <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> T_TApp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
<span class="main">|</span> T_Sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> T_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">∥</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
<span class="main">|</span> T_Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[:]</span></span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">:</span></span> RcdT <span class="free"><span class="bound"><span class="entity">fTs</span></span></span>"</span></span>
<span class="main">|</span> T_Proj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> RcdT <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> T_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">[]</span> <span class="main"><span class="free">[:]</span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> T_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[:]</span></span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[:]</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fTs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_typeE1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> well_formedE_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wf_typeE2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fTs</span><span class="main">.</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">T</span><span class="main">)</span> <span class="main">∧</span>
     unique <span class="free">fTs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fTs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_liftB<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_typeE1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_arrow<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> wf_typeE1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_subst <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="comment1">― ‹records›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_dec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_RcdT<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ptyping_induct <span class="main">=</span> ptyping_ptypings.inducts<span class="main">(</span>1<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span>
   <span class="operator">case_names</span> P_Var P_Rcd<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> ptypings_induct <span class="main">=</span> ptyping_ptypings.inducts<span class="main">(</span>2<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span>
   <span class="operator">case_names</span> P_Nil P_Cons<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> typing_induct <span class="main">=</span> typing_typings.inducts<span class="main">(</span>1<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span>
   <span class="operator">case_names</span> T_Var T_Abs T_App T_TAbs T_TApp T_Sub T_Let T_Rcd T_Proj<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> typings_induct <span class="main">=</span> typing_typings.inducts<span class="main">(</span>2<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span>
   <span class="operator">case_names</span> T_Nil T_Cons<span class="main">]</span>

<span class="keyword1" id="POPLmarkRecord-narrow_type"><span class="command">lemma</span></span> narrow_type<span class="main">:</span> <span class="comment1">― ‹A.7›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span>
     <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">P</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">ts</span> <span class="main">[:]</span> <span class="free">Ts</span> <span class="main">⟹</span>
     <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">P</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">ts</span> <span class="main">[:]</span> <span class="free">Ts</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">Ts</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_replace<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split nat.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_TApp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="comment1">― ‹records›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Let<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Proj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_replace<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-typings_setD"><span class="command">lemma</span></span> typings_setD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fTs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">t</span><span class="main">⌋</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typings_induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="POPLmarkRecord-subtype_refl'"><span class="command">lemma</span></span> subtype_refl'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_typeE1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_typeE2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-Abs_type"><span class="command">lemma</span></span> Abs_type<span class="main">:</span> <span class="comment1">― ‹A.13(1)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="free">U</span> <span class="main">→</span> <span class="free">U'</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> VarB <span class="free">S</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
      <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">U'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">U</span> <span class="main">→</span> <span class="skolem">U'</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> ty1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ty2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">U'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> ty1 <span class="quoted"><span class="quoted">‹VarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> ty2
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">S'</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T</span> <span class="main">&lt;:</span> <span class="skolem">U</span> <span class="main">→</span> <span class="skolem">U'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">U</span> <span class="main">→</span> <span class="skolem">U'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-Abs_type'"><span class="command">lemma</span></span> Abs_type'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="free">U</span> <span class="main">→</span> <span class="free">U'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> VarB <span class="free">S</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
    <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H subtype_refl' <span class="main">[</span><span class="operator">OF</span> H<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_type<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-TAbs_type"><span class="command">lemma</span></span> TAbs_type<span class="main">:</span> <span class="comment1">― ‹A.13(2)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">U</span><span class="main">.</span> <span class="free">U'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
      TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ&lt;:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">U'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">U</span><span class="main">.</span> <span class="skolem">U'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> ty1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">U</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ty2<span class="main">:</span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">U</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">U'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">U</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> narrow_type <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ty1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ty2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">S'</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">U</span><span class="main">.</span> <span class="skolem">U'</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">U</span><span class="main">.</span> <span class="skolem">U'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-TAbs_type'"><span class="command">lemma</span></span> TAbs_type'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free">S</span><span class="main">.</span> <span class="free">s</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">U</span><span class="main">.</span> <span class="free">U'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S'</span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">U</span> <span class="main">&lt;:</span> <span class="free">S</span> <span class="main">⟹</span> TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">s</span> <span class="main">:</span> <span class="bound">S'</span> <span class="main">⟹</span>
    TVarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">S'</span> <span class="main">&lt;:</span> <span class="free">U'</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H subtype_refl' <span class="main">[</span><span class="operator">OF</span> H<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> TAbs_type<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the proof of the preservation theorem, the following elimination rule
for typing judgements on record types will be useful:
›</span></span>

<span class="keyword1" id="POPLmarkRecord-Rcd_type1"><span class="command">lemma</span></span> Rcd_type1<span class="main">:</span> <span class="comment1">― ‹A.13(3)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Rcd <span class="free">fs</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> RcdT <span class="free">fTs</span> <span class="main">⟹</span>
     <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">fTs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> meta_mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subtyping.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> typings_setD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-Rcd_type1'"><span class="command">lemma</span></span> Rcd_type1'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Rcd <span class="free">fs</span> <span class="main">:</span> RcdT <span class="free">fTs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H refl subtype_refl' <span class="main">[</span><span class="operator">OF</span> H<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Intuitively, this means that for a record <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Rcd <span class="free"><span class="free">fs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free"><span class="free">fTs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
each field with name <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> associated with a type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">fTs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
must correspond to a field in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with value <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has
type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Thanks to the subsumption rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T_Sub›</span></span></span></span>, the typing judgement
for terms is not sensitive to the order of record fields. For example,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [display] <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> Rcd <span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">:</span></span> RcdT <span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
provided that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ ⊢ t<span class="hidden">⇩</span><sub>i</sub> : T<span class="hidden">⇩</span><sub>i</sub>›</span></span></span></span>. Note however that this does not imply
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [display] <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ</span></span> <span class="main"><span class="main">⊢</span></span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">[:]</span></span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
In order for this statement to hold, we need to remove the field <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l<span class="hidden">⇩</span><sub>3</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and exchange the order of the fields <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This gives rise
to the following variant of the above elimination rule:
›</span></span>

<span class="keyword1" id="POPLmarkRecord-Rcd_type2"><span class="command">lemma</span></span> Rcd_type2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Rcd <span class="free">fs</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">T</span> <span class="main">&lt;:</span> RcdT <span class="free">fTs</span> <span class="main">⟹</span>
     <span class="free">Γ</span> <span class="main">⊢</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fTs</span> <span class="main">[:]</span> <span class="free">fTs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Rcd_type1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fTs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">b</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> list<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> RcdT <span class="main">(</span><span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span> <span class="main">∷</span> <span class="improper">list</span><span class="main">)</span> <span class="main">&lt;:</span> RcdT <span class="improper">list</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> meta_mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subtype_trans<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SA_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballpI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> subtype_refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">l</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">Ta</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formed_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-Rcd_type2'"><span class="command">lemma</span></span> Rcd_type2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Rcd <span class="free">fs</span> <span class="main">:</span> RcdT <span class="free">fTs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fTs</span> <span class="main">[:]</span> <span class="free">fTs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H subtype_refl' <span class="main">[</span><span class="operator">OF</span> H<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type2<span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-T_eq"><span class="command">lemma</span></span> T_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">=</span> <span class="free">T'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="POPLmarkRecord-ptyping_length"><span class="command">lemma</span></span> ptyping_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">∥</span><span class="free">p</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">∥</span><span class="free">fps</span><span class="keyword1">∥<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">=</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> ptyping ptypings<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-lift_ptyping"><span class="command">lemma</span></span> lift_ptyping<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">p</span> <span class="main">:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">T</span> <span class="main">⇒</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Δ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> ptyping ptypings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> P_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="improper">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> fps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="free">n</span> <span class="free">k</span> <span class="improper">fps</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> P_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-type_weaken"><span class="command">lemma</span></span> type_weaken<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span> <span class="main">⟹</span>
     <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">↑</span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">t</span> <span class="main">:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>B</sub></span> <span class="free">B</span> <span class="main">⟹</span>
     <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">fTs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">fTs</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> Suc <span class="main">(</span><span class="improper">i</span> <span class="main">-</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> T_TApp <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subtype_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> liftT_substT_strange <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="improper">S</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subtype_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="comment1">― ‹records›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="improper">Δ'</span> <span class="main">@</span> <span class="free">B</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Let<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> lift_ptyping<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> fTs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="improper">fTs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Proj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> liftrT_assoc_Some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_weaken<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-type_weaken'"><span class="command">lemma</span></span> type_weaken'<span class="main">:</span> <span class="comment1">― ‹A.5(6)›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>w</sub><span class="hidden">⇩</span><sub>f</sub></span> <span class="main">⟹</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="main">↑</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">t</span> <span class="main">:</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Δ</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> well_formedE_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> type_weaken<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The substitution lemmas are now proved by mutual induction on the derivations of
the typing derivations for terms and lists of fields.
›</span></span>

<span class="keyword1" id="POPLmarkRecord-subst_ptyping"><span class="command">lemma</span></span> subst_ptyping<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">p</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">:</span> <span class="free">T</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">⇒</span> <span class="free">Δ</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span> <span class="main">[:]</span> <span class="free">fTs</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">⇒</span> <span class="free">Δ</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> ptyping ptypings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> P_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> P_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> p<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">p</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>p</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> fps<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">fps</span><span class="main">[</span><span class="free">k</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">U</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>p</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> P_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> subst_type<span class="main">:</span> <span class="comment1">― ‹A.8›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⟹</span>
     <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">↦</span> <span class="free">u</span><span class="main">]</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span> <span class="main">:</span> <span class="free">U</span> <span class="main">⟹</span>
     <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">1</span> <span class="main">0</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">↦</span> <span class="free">u</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[:]</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">1</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="free">fTs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> VarB <span class="free">U</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">fTs</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Δ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> type_weaken'<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TApp <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_subtype <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">S</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_subtype <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="comment1">― ‹records›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Let<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst_ptyping<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> fTs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">fTs</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Proj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> substrTT_assoc_Some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wf_Top<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> substT_type<span class="main">:</span> <span class="comment1">― ‹A.11›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span>
     <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="main">]</span> <span class="main">:</span> <span class="free">T</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">&lt;:</span> <span class="free">Q</span> <span class="main">⟹</span>
     <span class="free">Δ</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">[:]</span> <span class="free">fTs</span><span class="main">[</span><span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">@</span> TVarB <span class="free">Q</span> <span class="main">∷</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">fTs</span></span>
    <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI conjI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">≤</span> <span class="improper">i</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> nat<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">-</span> Suc <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">=</span> <span class="improper">nat</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="main">&lt;</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Abs <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_App<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TAbs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_TApp <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> T_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substT_subtype<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> substT_substT <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">S</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substT_subtype<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="comment1">― ‹records›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> Γ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">Δ'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Let<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> subst_ptyping<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> fTs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">fTs</span><span class="main">[</span><span class="main">∥</span><span class="improper">Δ</span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">P</span><span class="keyword1">]<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> T_Proj<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> substrTT_assoc_Some<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wfE_subst<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wf_subtypeE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:evaluation-rcd}
The definition of canonical values is extended with a clause saying that
a record <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Rcd <span class="free"><span class="free">fs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a canonical value if all fields contain
canonical values:
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="quoted">"<span class="entity">value</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">value</span>"</span></span>
<span class="main">|</span> TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">value</span>"</span></span>
<span class="main">|</span> Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">value</span> <span class="main">⟹</span> Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">∈</span> <span class="free">value</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In order to formalize the evaluation rule for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>LET›</span></span></span></span>, we introduce another
relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊢ p ⊳ t ⇒ ts›</span></span></span></span> expressing that a pattern <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> matches a
term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The relation also yields a list of terms <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ts</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> corresponding
to the variables in the pattern. The relation is defined simultaneously with another
relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊢ fps [⊳] fs ⇒ ts›</span></span></span></span> for matching a list of field patterns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fps</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
against a list of fields <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">fs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> trm <span class="main">⇒</span> trm list <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">⊳</span> _ <span class="keyword1">⇒</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">matchs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rpat <span class="main">⇒</span> rcd <span class="main">⇒</span> trm list <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _ <span class="keyword1">[⊳]</span> _ <span class="keyword1">⇒</span> _"</span> <span class="main">[</span>50<span class="main">,</span> 50<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  M_PVar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> PVar <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⊳</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> M_Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">[⊳]</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> PRcd <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">⊳</span></span> Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> M_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="main">[]</span> <span class="main"><span class="free">[⊳]</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> M_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">⊳</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">[⊳]</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span>
    <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fps</span></span></span> <span class="main"><span class="free">[⊳]</span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The rules of the evaluation relation for the calculus with records are as follows:
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> trm <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⟼</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">evals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rcd <span class="main">⇒</span> rcd <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">[⟼]</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  E_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_App1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> E_App2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> E_TApp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>
<span class="main">|</span> E_LetV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⊳</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_ProjRcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> E_Proj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> E_Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[⟼]</span></span> <span class="free"><span class="bound"><span class="entity">fs'</span></span></span> <span class="main">⟹</span> Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">⟼</span></span> Rcd <span class="free"><span class="bound"><span class="entity">fs'</span></span></span>"</span></span>
<span class="main">|</span> E_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟼</span></span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> E_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟼</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[⟼]</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span>"</span></span>
<span class="main">|</span> E_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[⟼]</span></span> <span class="free"><span class="bound"><span class="entity">fs'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main"><span class="free">[⟼]</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">⟼</span></span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is defined simultaneously with
a relation \mbox{<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">fs</span></span> <span class="main"><span class="main">[⟼]</span></span> <span class="free"><span class="free">fs'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} for evaluating record fields.
The ``immediate'' reductions, namely pattern matching and projection,
are described by the rules <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_LetV›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_ProjRcd›</span></span></span></span>, respectively,
whereas <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Proj›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Rcd›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Let›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_hd›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_tl›</span></span></span></span> are congruence rules.
›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> matchs_induct <span class="main">=</span> match_matchs.inducts<span class="main">(</span>2<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span>
   <span class="operator">case_names</span> M_Nil M_Cons<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> evals_induct <span class="main">=</span> eval_evals.inducts<span class="main">(</span>2<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span>
   <span class="operator">case_names</span> E_hd E_tl<span class="main">]</span>

<span class="keyword1" id="POPLmarkRecord-matchs_mono"><span class="command">lemma</span></span> matchs_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fps</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∷</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-matchs_eq"><span class="command">lemma</span></span> matchs_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fps</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="free">fs'</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs'</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="POPLmarkRecord-reorder_eq"><span class="command">lemma</span></span> reorder_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fps</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fTs</span><span class="main">)</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ptypings_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="POPLmarkRecord-matchs_reorder"><span class="command">lemma</span></span> matchs_reorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">⟹</span>
    <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ reorder_eq<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="POPLmarkRecord-matchs_reorder'"><span class="command">lemma</span></span> matchs_reorder'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">⟹</span>
     <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ reorder_eq <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> ball_eq_sym<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> matchs_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∷</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fps</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fps</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∷</span> <span class="free">fs</span>"</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> M_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> match_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">p</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">∥</span><span class="free">ts</span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">ft</span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">∥</span><span class="free">ts</span><span class="main">∥</span> <span class="main">=</span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fTs</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> match matchs<span class="main">)</span>
    <span class="main">(</span><span class="operator">erule</span> ptyping.cases ptypings.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the proof of the preservation theorem
for the calculus with records, we need the following lemma relating
the matching and typing judgements for patterns,
which means that well-typed matching preserves typing. Although this property
will only be used for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> later, the statement must be proved in
a more general form in order for the induction to go through.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> match_type<span class="main">:</span> <span class="comment1">― ‹A.17›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">:</span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span>
     <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">p</span> <span class="main">⊳</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span>
       <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">∥</span><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ts</span><span class="main">]</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">∥</span><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span>
     <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">Δ</span> <span class="main">@</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span>
       <span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">∥</span><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ts</span><span class="main">]</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="free">Δ</span><span class="main">∥</span> <span class="main">∥</span><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> ptyping ptypings<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Var <span class="skolem">T</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P_Var <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">@</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">∥</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">∥</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> subst_type <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> P_Var<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Rcd <span class="skolem">fps</span> <span class="skolem">fTs</span> <span class="skolem">Δ</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P_Rcd<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    t<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Rcd <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="skolem">fs</span> <span class="main">⇒</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> P_Rcd <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> Rcd <span class="skolem">fs</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fTs</span> <span class="main">[:]</span> <span class="skolem">fTs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type2'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> P_Rcd<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type1'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> P_Rcd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fTs</span> <span class="main">⇒</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_reorder<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P_Rcd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Nil <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">fs</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P_Nil<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> P_Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Cons <span class="skolem">p</span> <span class="skolem">T</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">fps</span> <span class="skolem">fTs</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">fs</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P_Cons<span class="main">(</span>8<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">ts<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">ts<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">t</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t</span> <span class="main">⇒</span> <span class="skolem">ts<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="skolem">fs</span> <span class="main">⇒</span> <span class="skolem">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> P_Cons<span class="main">(</span>6<span class="main">)</span> t fps <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    fps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs'</span> <span class="main">⇒</span> <span class="skolem">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="skolem">fs'</span> <span class="main">[:]</span> <span class="skolem">fTs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs'</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> P_Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> tT <span class="keyword1"><span class="command">have</span></span> ts<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span>
    <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">∥</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">∥</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="keyword1">↑<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fps' P_Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="skolem">fs'</span> <span class="main">⇒</span> <span class="skolem">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fs' ts<span class="hidden">⇩</span><sub>1</sub> <span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">0</span> <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">∥</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">+</span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span><span class="main">[</span><span class="main">∥</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">ts<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span>
    <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="main">∥</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">(</span><span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">(</span><span class="main">∥</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∥</span> <span class="main">+</span> <span class="main">∥</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∥</span><span class="main">)</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P_Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decE_decE <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
    match_length<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">OF</span> fps P_Cons<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> ts<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-evals_labels"><span class="command">lemma</span></span> evals_labels <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fs</span> <span class="main">[⟼]</span> <span class="free">fs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs'</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evals_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> preservation<span class="main">:</span> <span class="comment1">― ‹A.20›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="free">fs</span> <span class="main">[⟼]</span> <span class="free">fs'</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs'</span> <span class="main">[:]</span> <span class="free">fTs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fs'</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">Γ</span> <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Var <span class="skolem">i</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_App <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"VarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_type' <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">S'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_App1 <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_App1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_App2 <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_App<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_App<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_App2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_TApp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> TAbs_type'<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_TApp<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substT_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_TAbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_TApp <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_TApp<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_TApp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_TApp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">:</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_Sub<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LET</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">IN</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_LetV <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> T_Let <span class="main">(</span>3<span class="main">,</span>1<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="skolem">ts</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">ts</span><span class="main">]</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_LetV <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_Let <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Let<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">t''</span> <span class="keyword1">IN</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="keyword1">↓<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">∥</span><span class="skolem">Δ</span><span class="main">∥</span> <span class="main">0</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_Let<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_Let<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_Let <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Rcd <span class="skolem">Γ</span> <span class="skolem">fs</span> <span class="skolem">fTs</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Rcd <span class="skolem">fs</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Rcd <span class="skolem">fs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">[⟼]</span> <span class="skolem">fs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">fs'</span> <span class="main">[:]</span> <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Rcd <span class="skolem">fs'</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">..</span><span class="skolem">l</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_ProjRcd <span class="skolem">fs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Rcd <span class="skolem">fs</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type1'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_ProjRcd T_Proj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_Proj <span class="skolem">t''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">⟼</span> <span class="skolem">t''</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Proj<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t''</span><span class="main">..</span><span class="skolem">l</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_Proj<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_Proj<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_Proj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Nil <span class="skolem">Γ</span> <span class="skolem">fs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">[⟼]</span> <span class="skolem">fs'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Cons <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">fs</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">fs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs</span> <span class="main">[⟼]</span> <span class="skolem">fs'</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_hd <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">⟼</span> <span class="skolem">t'</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs</span> <span class="main">[:]</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_Cons<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_hd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_tl <span class="skolem">fs''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> fs <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">fs</span> <span class="main">[⟼]</span> <span class="skolem">fs''</span>›</span></span>
    <span class="keyword1"><span class="command">note</span></span> T_Cons<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">fs''</span> <span class="main">[:]</span> <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fs T_Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs''</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs''</span> <span class="main">[:]</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fTs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> typing_typings.T_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E_tl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="POPLmarkRecord-Fun_canonical"><span class="command">lemma</span></span> Fun_canonical<span class="main">:</span> <span class="comment1">― ‹A.14(1)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span> <span class="bound">S</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="bound">S</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="free">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Abs
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_Sub<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub S<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LET</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">IN</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">..</span><span class="skolem">l</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="POPLmarkRecord-TyAll_canonical"><span class="command">lemma</span></span> TyAll_canonical<span class="main">:</span> <span class="comment1">― ‹A.14(3)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span> <span class="bound">S</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="bound">S</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀&lt;:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_TAbs
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_Sub<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub S<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LET</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">IN</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">..</span><span class="skolem">l</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Like in the case of the simple calculus,
we also need a canonical values theorem for record types:
›</span></span>

<span class="keyword1" id="POPLmarkRecord-RcdT_canonical"><span class="command">lemma</span></span> RcdT_canonical<span class="main">:</span> <span class="comment1">― ‹A.14(2)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> RcdT <span class="free">fTs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> value <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">fs</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> Rcd <span class="bound">fs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ty
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"RcdT <span class="free">fTs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fTs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">S</span> <span class="main">&lt;:</span> RcdT <span class="skolem">fTs</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fTs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> RcdT <span class="skolem">fTs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_Sub<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub S<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LET</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">IN</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Rcd <span class="skolem">fs</span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Rcd <span class="skolem">fs</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_Rcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">fTs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">..</span><span class="skolem">l</span> <span class="main">∈</span> value›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">theorem</span></span> reorder_prop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="free">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">⟹</span>
     <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="free">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">fTs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bpspec<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Another central property needed in the proof of the progress theorem is
that well-typed matching is defined.
This means that if the pattern <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is compatible with the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of
the closed term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that it has to match, then it is always possible to extract a
list of terms <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ts</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> corresponding to the variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
Interestingly, this important property is missing in the description of the
{\sc PoplMark} Challenge \cite{PoplMark}.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ptyping_match<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> value <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="main">⊢</span> <span class="free">p</span> <span class="main">⊳</span> <span class="free">t</span> <span class="main">⇒</span> <span class="bound">ts</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">fps</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⇒</span> <span class="free">Δ</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="main">⊢</span> <span class="free">fps</span> <span class="main">[⊳]</span> <span class="free">fs</span> <span class="main">⇒</span> <span class="bound">us</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> ptyping ptypings<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Var <span class="skolem">T</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> M_PVar<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Rcd <span class="skolem">fps</span> <span class="skolem">fTs</span> <span class="skolem">Δ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Rcd <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RcdT_canonical<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P_Rcd <span class="keyword1"><span class="command">have</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> Rcd <span class="skolem">fs</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fTs</span> <span class="main">[:]</span> <span class="skolem">fTs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type2'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Rcd_type1' <span class="main">[</span><span class="operator">OF</span> fs'<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fTs</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reorder_prop<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fTs</span> <span class="main">⇒</span> <span class="bound">us</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> the <span class="main">(</span><span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">fTs</span> <span class="main">⇒</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> P_Rcd<span class="main">(</span>1<span class="main">)</span> assoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="skolem">fs</span> <span class="main">⇒</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_reorder'<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> PRcd <span class="skolem">fps</span> <span class="main">⊳</span> Rcd <span class="skolem">fs</span> <span class="main">⇒</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M_Rcd<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Nil <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> M_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>P_Cons <span class="skolem">p</span> <span class="skolem">T</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">fps</span> <span class="skolem">fTs</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">l</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">fs</span> <span class="main">[:]</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fTs</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">fs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="skolem">fs'</span> <span class="main">[:]</span> <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs'</span><span class="main">)</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">t</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fs P_Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> value"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t</span> <span class="main">⇒</span> <span class="bound">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t</span> <span class="main">⇒</span> <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> P_Cons fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fs'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> fs' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span><span class="main">.</span> <span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="skolem">fs'</span> <span class="main">⇒</span> <span class="bound">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> P_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="skolem">fs'</span> <span class="main">⇒</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs'</span> <span class="main">⇒</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P_Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fps</span> <span class="main">[⊳]</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∷</span> <span class="skolem">fs'</span> <span class="main">⇒</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> M_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span> <span class="comment1">― ‹A.16›</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">fs'</span><span class="main">.</span> <span class="free">fs</span> <span class="main">[⟼]</span> <span class="bound">fs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">fTs</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Var
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Abs
  <span class="keyword1"><span class="command">from</span></span> value.Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="hidden">⇩</span><sub>1</sub>_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_App <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fun_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> T_App <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value"</span></span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t</span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> eval_evals.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub>_val <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_evals.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_evals.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_TAbs
  <span class="keyword1"><span class="command">from</span></span> value.TAbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_TApp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> TyAll_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> eval_evals.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟼</span> <span class="skolem">t'</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_evals.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">iprover</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_Let <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="bound">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ptyping_match<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Rcd <span class="skolem">fs</span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> value.intros eval_evals.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">⟼</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Rcd <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RcdT_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> Rcd <span class="skolem">fs</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type1'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">u</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> value"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> u t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">⟼</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Cons <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">fs</span> <span class="skolem">fTs</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="POPLmarkRecordCtxt">
<div class="head">
<h1>Theory POPLmarkRecordCtxt</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      POPLmark/POPLmarkRecordCtxt.thy
    Author:     Stefan Berghofer, TU Muenchen, 2005
*)</span>

<span class="keyword1"><span class="command">theory</span></span> POPLmarkRecordCtxt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="POPLmarkRecord.html">POPLmarkRecord</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Evaluation contexts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:evaluation-ctxt}
In this section, we present a different way of formalizing the evaluation relation.
Rather than using additional congruence rules, we first formalize a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ctxt›</span></span></span></span>
of evaluation contexts, describing the locations in a term where reductions
can occur. We have chosen a higher-order formalization of evaluation contexts as
functions from terms to terms. We define simultaneously a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rctxt›</span></span></span></span>
of evaluation contexts for records represented as functions from terms to lists
of fields.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">ctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>trm <span class="main">⇒</span> trm<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">rctxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>trm <span class="main">⇒</span> rcd<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  C_Hole<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_App1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_App2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_TApp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Proj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">rctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> Rcd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ctxt</span>"</span></span>
<span class="main">|</span> C_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">ctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">rctxt</span>"</span></span>
<span class="main">|</span> C_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> <span class="free">rctxt</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∷</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">rctxt</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rctxt_induct <span class="main">=</span> ctxt_rctxt.inducts<span class="main">(</span>2<span class="main">)</span>
  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True"</span></span><span class="main">,</span> <span class="operator">simplified</span> True_simps<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> C_hd C_tl<span class="main">]</span>

<span class="keyword1" id="POPLmarkRecordCtxt-rctxt_labels"><span class="command">lemma</span></span> rctxt_labels<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> rctxt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="free">t</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟹</span> <span class="free">E</span> <span class="free">t'</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rctxt_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The evaluation relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t ⟼<span class="hidden">⇩</span><sub>c</sub> t'›</span></span></span></span> is now characterized by the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Ctxt›</span></span></span></span>,
which allows reductions in arbitrary contexts, as well as the rules <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Abs›</span></span></span></span>,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_TAbs›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_LetV›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_ProjRcd›</span></span></span></span> describing the ``immediate''
reductions, which have already been presented in \secref{sec:evaluation} and
\secref{sec:evaluation-rcd}.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> trm <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  E_Ctxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∈</span> ctxt <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>
<span class="main">|</span> E_Abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">(</span><span class="main">λ:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1"><span class="free">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_TAbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1"><span class="free">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free"><span class="bound"><span class="entity">T<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_LetV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⊳</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> E_ProjRcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> Rcd <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1"><span class="free">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the proof of the preservation theorem, the case corresponding to the rule <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E_Ctxt›</span></span></span></span>
requires a lemma stating that replacing
a term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a well-typed term of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">E</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
a context, by a term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the same type does not change the type of the
resulting term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">E</span></span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The proof is by mutual induction on the typing derivations for terms and records.
›</span></span>

<span class="keyword1" id="POPLmarkRecordCtxt-context_typing"><span class="command">lemma</span></span> context_typing<span class="main">:</span> <span class="comment1">― ‹A.18›</span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">u</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">E</span> <span class="main">∈</span> ctxt <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">E</span> <span class="free">t</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">T<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="bound">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">:</span> <span class="bound">T<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">E</span> <span class="free">t'</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span> <span class="free">E<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∈</span> rctxt <span class="main">⟹</span> <span class="free">fs</span> <span class="main">=</span> <span class="free">E<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">t</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">T<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="bound">T<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">:</span> <span class="bound">T<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">E<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">t'</span> <span class="main">[:]</span> <span class="free">fTs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">E<span class="hidden">⇩</span><sub>r</sub></span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Var <span class="skolem">Γ</span> <span class="skolem">i</span> <span class="skolem">U</span> <span class="skolem">T</span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_Var <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> T_Var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Abs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_Abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> T_Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_App
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_TAbs <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> T_TAbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_TApp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">E</span> <span class="skolem">ta</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_Let
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Rcd <span class="skolem">Γ</span> <span class="skolem">fs</span> <span class="skolem">fTs</span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_Rcd
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T</span> <span class="skolem">E</span> <span class="skolem">ta</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> ctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_Proj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Nil <span class="skolem">Γ</span> <span class="skolem">E</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> rctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Cons <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">fs</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">E</span> <span class="skolem">ta</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">E</span> <span class="main">∈</span> rctxt›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros rctxt_labels<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The fact that immediate reduction preserves the types of terms is
proved in several parts. The proof of each statement is by induction
on the typing derivation.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Abs_preservation<span class="main">:</span> <span class="comment1">― ‹A.19(1)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∙</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">Γ</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"VarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_type' <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="skolem">S'</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> Top<span class="keyword1">]<span class="hidden">⇩</span><sub>τ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> S' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Sub
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> TAbs_preservation<span class="main">:</span> <span class="comment1">― ‹A.19(2)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ&lt;:</span><span class="free">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="free">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">T<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">Γ</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">∀&lt;:</span><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">S'</span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> TAbs_type'<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"TVarB <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∷</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> substT_type <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Δ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[]</span></span></span></span></span></span>"</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Sub
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Let_preservation<span class="main">:</span> <span class="comment1">― ‹A.19(3)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="keyword1">LET</span> <span class="free">p</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">IN</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">p</span> <span class="main">⊳</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ts</span><span class="main">]</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LET</span> <span class="free">p</span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">IN</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">p</span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="skolem">Δ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Δ</span> <span class="main">@</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="skolem">ts</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_type<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Sub
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Proj_preservation<span class="main">:</span> <span class="comment1">― ‹A.19(4)›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Rcd <span class="free">fs</span><span class="main">..</span><span class="free">l</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">fs</span><span class="main">⟨</span><span class="free">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="free">v</span><span class="main">⌋</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">v</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Rcd <span class="free">fs</span><span class="main">..</span><span class="free">l</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">Γ</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T</span> <span class="skolem">fs</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> Rcd <span class="skolem">fs</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="skolem">Γ</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type1'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Sub
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> typing_typings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> preservation<span class="main">:</span> <span class="comment1">― ‹A.20›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">:</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_Ctxt <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">E</span> <span class="skolem">Γ</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> E_Ctxt<span class="main">(</span>4<span class="main">,</span>3<span class="main">)</span> refl E_Ctxt<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> context_typing<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_Abs <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> E_Abs<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_preservation<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_TAbs <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> TAbs_preservation<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_LetV <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">ts</span> <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> E_LetV<span class="main">(</span>3<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Let_preservation<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>E_ProjRcd <span class="skolem">fs</span> <span class="skolem">l</span> <span class="skolem">v</span> <span class="skolem">Γ</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> E_ProjRcd<span class="main">(</span>3<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Proj_preservation<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
For the proof of the progress theorem, we need a lemma stating that each well-typed,
closed term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is either a canonical value, or can be decomposed into an
evaluation context <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">E</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a redex.
The proof of this result, which is called the {\it decomposition lemma}, is again
by induction on the typing derivation.
A similar property is also needed for records.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> context_decomp<span class="main">:</span> <span class="comment1">― ‹A.15›</span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span> <span class="main">⟹</span> 
     <span class="free">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">fs</span> <span class="main">[:]</span> <span class="free">fTs</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> rctxt <span class="main">∧</span> <span class="free">fs</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">T</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>env"</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">fTs</span></span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> typing typings<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> T_Var
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Abs
  <span class="keyword1"><span class="command">from</span></span> value.Abs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="hidden">⇩</span><sub>1</sub>_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_App <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ:</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Fun_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> value"</span></span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">t</span><span class="main">[</span><span class="main">0</span> <span class="main">↦</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> C_Hole<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub>_val <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_TAbs
  <span class="keyword1"><span class="command">from</span></span> value.TAbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_TApp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_TApp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ&lt;:</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> TyAll_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">t</span><span class="main">[</span><span class="main">0</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>τ</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> eval.intros<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> C_Hole<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Sub <span class="skolem">t</span> <span class="skolem">S</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> T_Sub<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Let <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p</span> <span class="skolem">Δ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_Let <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="main">⊢</span> <span class="skolem">p</span> <span class="main">⊳</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="bound">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ptyping_match<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> t<span class="hidden">⇩</span><sub>1</sub> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval.intros C_Hole<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Rcd <span class="skolem">fs</span> <span class="skolem">fTs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> value.intros eval.intros ctxt_rctxt.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Proj <span class="skolem">t</span> <span class="skolem">fTs</span> <span class="skolem">l</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> value"</span></span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Rcd <span class="skolem">fs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> value"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RcdT_canonical<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> Rcd <span class="skolem">fs</span> <span class="main">:</span> RcdT <span class="skolem">fTs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">U</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">fTs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">fs</span><span class="main">⟨</span><span class="bound">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="bound">u</span><span class="main">⌋</span> <span class="main">∧</span> <span class="main">[]</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">:</span> <span class="bound">U</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Rcd_type1'<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T_Proj <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span><span class="main">⟨</span><span class="skolem">l</span><span class="main">⟩<span class="hidden">⇩</span><sub>?</sub></span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">u</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> value"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assoc_set<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> u t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval.intros C_Hole<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="skolem">t</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> T_Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>T_Cons <span class="skolem">t</span> <span class="skolem">T</span> <span class="skolem">fs</span> <span class="skolem">fTs</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span> <span class="comment1">― ‹A.16›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">:</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> value <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> ctxt <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> context_decomp<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Finally, we prove that the two definitions of the evaluation relation
are equivalent. The proof that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="keyword1"><span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">⟼</span></span> <span class="free"><span class="free">t'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
requires a lemma stating that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟼›</span></span></span></span> is compatible with evaluation contexts.
›</span></span>

<span class="keyword1" id="POPLmarkRecordCtxt-ctxt_imp_eval"><span class="command">lemma</span></span> ctxt_imp_eval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∈</span> ctxt <span class="main">⟹</span> <span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">E</span> <span class="free">t</span> <span class="main">⟼</span> <span class="free">E</span> <span class="free">t'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">E<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">∈</span> rctxt <span class="main">⟹</span> <span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">E<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">t</span> <span class="main">[⟼]</span> <span class="free">E<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.inducts<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros<span class="main">)</span>

<span class="keyword1" id="POPLmarkRecordCtxt-eval_evalc_eq"><span class="command">lemma</span></span> eval_evalc_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="skolem">ts'</span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">[⟼]</span> <span class="skolem">ts'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">E</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">E</span> <span class="main">∈</span> rctxt <span class="main">∧</span> <span class="skolem">ts</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t</span> <span class="main">∧</span> <span class="skolem">ts'</span> <span class="main">=</span> <span class="bound">E</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_evals.inducts<span class="main">)</span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ctxt_rctxt.intros eval.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> r<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">⟼<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">t'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">⟼</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eval_evals.intros ctxt_imp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Execute">
<div class="head">
<h1>Theory Execute</h1>
</div>
<pre class="source"><span class="comment1">(*  Author:     Stefan Berghofer, TU Muenchen, 2005; Lukas Bulwahn, TU Muenchen, 2009
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Execute
<span class="keyword2"><span class="keyword">imports</span></span> <a href="POPLmarkRecord.html">POPLmarkRecord</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executing the specification›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{sec:exec}
An important criterion that a solution to the {\sc PoplMark} Challenge should
fulfill is the possibility to {\it animate} the specification. For example,
it should be possible to apply the reduction relation for the calculus to
example terms. Since the reduction relations are defined inductively, they can
be interpreted as a logic program in the style of {\sc Prolog}.
The definition of the single-step evaluation relation presented in \secref{sec:evaluation}
and \secref{sec:evaluation-rcd} is directly executable.

In order to compute the normal form of a term using the one-step evaluation
relation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟼›</span></span></span></span>, we introduce the inductive predicate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t ⇓ u›</span></span></span></span>,
denoting that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> is a normal form of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trm <span class="main">⇒</span> trm <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⇓</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> value <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟼</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normal_forms</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normal_forms</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">u</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⇓</span> <span class="bound">u</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span> Rcd_Nil<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valuep <span class="main">(</span>Rcd <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valuep.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span> Rcd_Cons<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valuep <span class="free">t</span> <span class="main">⟹</span> valuep <span class="main">(</span>Rcd <span class="free">fs</span><span class="main">)</span> <span class="main">⟹</span> valuep <span class="main">(</span>Rcd <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valuep.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valuep.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> valuep.intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">code_pred_intro</span> Abs'<span class="main">]</span> valuep.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">code_pred_intro</span> TAbs'<span class="main">]</span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">=&gt;</span> bool<span class="main">)</span> <span class="quoted"><span class="quoted">valuep</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">case</span></span> valuep
  <span class="keyword1"><span class="command">from</span></span> valuep.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valuep.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rcd <span class="skolem">fs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this valuep.Rcd_Nil valuep.Rcd_Cons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valuep.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Abs
    <span class="keyword1"><span class="command">with</span></span> valuep.Abs' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> TAbs
    <span class="keyword1"><span class="command">with</span></span> valuep.TAbs' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> valuep.equation

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> bool<span class="main">,</span> i <span class="main">=&gt;</span> o <span class="main">=&gt;</span> bool as normalize<span class="main">)</span> <span class="quoted"><span class="quoted">norm</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">thm</span></span> norm.equation

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"normal_forms <span class="main">=</span> set_of_pred <span class="keyword1">o</span> normalize"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_of_pred_def o_def normal_forms_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> set_eqI normalizeI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> normalizeE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> value <span class="main">⟷</span> valuep <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">natT</span> <span class="main">::</span> <span class="quoted">type</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">natT</span> <span class="main">≡</span> <span class="main">∀&lt;:</span>Top<span class="main">.</span> <span class="main">(</span><span class="main">∀&lt;:</span>TVar <span class="main">0</span><span class="main">.</span> <span class="main">(</span><span class="main">∀&lt;:</span>TVar <span class="main">1</span><span class="main">.</span> <span class="main">(</span>TVar <span class="numeral">2</span> <span class="main">→</span> TVar <span class="main">1</span><span class="main">)</span> <span class="main">→</span> TVar <span class="main">0</span> <span class="main">→</span> TVar <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">fact2</span> <span class="main">::</span> <span class="quoted">trm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fact2</span> <span class="main">≡</span>
   <span class="keyword1">LET</span> PVar natT <span class="main">=</span>
     <span class="main">(</span><span class="main">λ&lt;:</span>Top<span class="main">.</span> <span class="main">λ&lt;:</span>TVar <span class="main">0</span><span class="main">.</span> <span class="main">λ&lt;:</span>TVar <span class="main">1</span><span class="main">.</span> <span class="main">λ:</span>TVar <span class="numeral">2</span> <span class="main">→</span> TVar <span class="main">1</span><span class="main">.</span> <span class="main">λ:</span> TVar <span class="main">1</span><span class="main">.</span> Var <span class="main">1</span> <span class="main">∙</span> Var <span class="main">0</span><span class="main">)</span>
   <span class="keyword1">IN</span>
   <span class="keyword1">LET</span> PRcd
     <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''pluspp''</span><span class="main">,</span> PVar <span class="main">(</span>natT <span class="main">→</span> natT <span class="main">→</span> natT<span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''multpp''</span><span class="main">,</span> PVar <span class="main">(</span>natT <span class="main">→</span> natT <span class="main">→</span> natT<span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> Rcd
     <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''multpp''</span><span class="main">,</span> <span class="main">λ:</span>natT<span class="main">.</span> <span class="main">λ:</span>natT<span class="main">.</span> <span class="main">λ&lt;:</span>Top<span class="main">.</span> <span class="main">λ&lt;:</span>TVar <span class="main">0</span><span class="main">.</span> <span class="main">λ&lt;:</span>TVar <span class="main">1</span><span class="main">.</span> <span class="main">λ:</span>TVar <span class="numeral">2</span> <span class="main">→</span> TVar <span class="main">1</span><span class="main">.</span>
        Var <span class="numeral">5</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">3</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">2</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="main">1</span> <span class="main">∙</span> <span class="main">(</span>Var <span class="numeral">4</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">3</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">2</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="main">1</span><span class="main">)</span> <span class="main">∙</span> Var <span class="main">0</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''pluspp''</span><span class="main">,</span> <span class="main">λ:</span>natT<span class="main">.</span> <span class="main">λ:</span>natT<span class="main">.</span> <span class="main">λ&lt;:</span>Top<span class="main">.</span> <span class="main">λ&lt;:</span>TVar <span class="main">0</span><span class="main">.</span> <span class="main">λ&lt;:</span>TVar <span class="main">1</span><span class="main">.</span> <span class="main">λ:</span>TVar <span class="numeral">2</span> <span class="main">→</span> TVar <span class="main">1</span><span class="main">.</span> <span class="main">λ:</span>TVar <span class="main">1</span><span class="main">.</span>
        Var <span class="numeral">6</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">4</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">3</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">3</span> <span class="main">∙</span> Var <span class="main">1</span> <span class="main">∙</span>
          <span class="main">(</span>Var <span class="numeral">5</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">4</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">3</span> <span class="keyword1">∙<span class="hidden">⇩</span><sub>τ</sub></span> TVar <span class="numeral">2</span> <span class="main">∙</span> Var <span class="main">1</span> <span class="main">∙</span> Var <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
   <span class="keyword1">IN</span>
     Var <span class="main">0</span> <span class="main">∙</span> <span class="main">(</span>Var <span class="main">1</span> <span class="main">∙</span> Var <span class="numeral">2</span> <span class="main">∙</span> Var <span class="numeral">2</span><span class="main">)</span> <span class="main">∙</span> Var <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"normal_forms fact2"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Unfortunately, the definition based
on evaluation contexts from \secref{sec:evaluation-ctxt} is not directly executable.
The reason is that from the definition of evaluation contexts, the code generator
cannot immediately read off an algorithm that, given a term <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>, computes a context
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> and a term <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> such that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t = E t<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span>. In order to do this, one
would have to extract the algorithm contained in the proof of the {\it decomposition lemma}
from \secref{sec:evaluation-ctxt}.
›</span></span>

<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">u</span><span class="main">.</span> norm fact2 <span class="bound">u</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>