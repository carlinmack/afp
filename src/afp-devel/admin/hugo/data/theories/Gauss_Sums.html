<div id="Gauss_Sums_Auxiliary">
<div class="head">
<h1>Theory Gauss_Sums_Auxiliary</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Gauss_Sums_Auxiliary.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Gauss_Sums_Auxiliary
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Dirichlet_L/Dirichlet_Characters.html">Dirichlet_L.Dirichlet_Characters</a>
  <a href="../Dirichlet_Series/Moebius_Mu.html">Dirichlet_Series.Moebius_Mu</a>
  <a href="../Dirichlet_Series/More_Totient.html">Dirichlet_Series.More_Totient</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Various facts›</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-sum_div_reduce"><span class="command">lemma</span></span> sum_div_reduce<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">n</span></span> <span class="main">|</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="free">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">c</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">c</span><span class="main">*</span><span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span> 
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="free"><span class="free"><span class="free">d</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">div</span></span></span> <span class="free"><span class="free"><span class="free">d</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> div_le_mono›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-prod_div_sub"><span class="command">lemma</span></span> prod_div_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"card <span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">B'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> card_eq_SucD<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> insert_is_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B'card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">B'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> prod <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="skolem">B'</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decomp<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> Diff_insert<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>prod <span class="free">f</span> <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="skolem">B'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> prod_diff1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">-</span><span class="skolem">B'</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> Suc decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>prod <span class="free">f</span> <span class="free">A</span> <span class="keyword1">div</span> prod <span class="free">f</span> <span class="skolem">B'</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B'</span></span><span class="main">]</span> Suc<span class="main">(</span>3<span class="main">)</span> B'card decomp
            Suc.prems<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod <span class="free">f</span> <span class="free">A</span> <span class="keyword1">div</span> <span class="main">(</span>prod <span class="free">f</span> <span class="skolem">B'</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod <span class="free">f</span> <span class="free">A</span> <span class="keyword1">div</span> prod <span class="free">f</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> decomp Suc.prems<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Gauss_Sums_Auxiliary-linear_gcd"><span class="command">lemma</span></span> linear_gcd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">b</span> <span class="free">d</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gcd <span class="free">a</span> <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gcd <span class="free">b</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q1</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q1</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q2</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q2</span> <span class="main">=</span> <span class="free">c</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q3</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q3</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q4</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q4</span> <span class="main">=</span> <span class="free">d</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">q1</span> <span class="skolem">q2</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">q3</span> <span class="skolem">q4</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> q1_def q2_def q3_def q4_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">a</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span><span class="main">)</span> <span class="free">c</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">a</span> <span class="free">c</span>›</span></span> coprime_mult_left_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">a</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
            dvd_mult_div_cancel<span class="main">[</span><span class="operator">OF</span> gcd_dvd1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">a</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_mult_right_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">b</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span>"</span></span><span class="main">]</span>
          dvd_div_mult_self<span class="main">[</span><span class="operator">OF</span> gcd_dvd2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">b</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">d</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">b</span> <span class="free">d</span>›</span></span> coprime_mult_left_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">b</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span>
            dvd_mult_div_cancel<span class="main">[</span><span class="operator">OF</span> gcd_dvd1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">b</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_mult_right_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">div</span> gcd <span class="free">b</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">a</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">d</span>"</span></span><span class="main">]</span>
          dvd_div_mult_self<span class="main">[</span><span class="operator">OF</span> gcd_dvd2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">q1</span> <span class="skolem">q4</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">q3</span> <span class="skolem">q2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q1_def q2_def q3_def q4_def 
    <span class="keyword1"><span class="command">using</span></span> assms div_gcd_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">q1</span><span class="main">*</span><span class="skolem">q3</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q2</span><span class="main">*</span><span class="skolem">q4</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gcd <span class="free">a</span> <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gcd <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="main">*</span> gcd <span class="main">(</span><span class="skolem">q1</span><span class="main">*</span><span class="skolem">q3</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q2</span><span class="main">*</span><span class="skolem">q4</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q1_def q2_def q3_def q4_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gcd_mult_distrib_nat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"gcd <span class="free"><span class="free"><span class="free">a</span></span></span> <span class="free"><span class="free"><span class="free">d</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> gcd <span class="free"><span class="free"><span class="free">b</span></span></span> <span class="free"><span class="free"><span class="free">c</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.left_commute semiring_normalization_rules<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gcd <span class="free">a</span> <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gcd <span class="free">b</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Gauss_Sums_Auxiliary-reindex_product_bij"><span class="command">lemma</span></span> reindex_product_bij<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">m</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">d1</span><span class="main">,</span><span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">a</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gcd <span class="free">k</span> <span class="free">b</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">d1</span><span class="main">,</span><span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">S</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d1</span> <span class="skolem">d2</span> <span class="skolem">d1'</span> <span class="skolem">d2'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d1</span><span class="main">,</span><span class="skolem">d2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d1'</span><span class="main">,</span><span class="skolem">d2'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span>"</span></span> 
              <span class="quoted"><span class="quoted">"<span class="skolem">d1'</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d2'</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">d1</span><span class="main">,</span><span class="skolem">d2</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">d1'</span><span class="main">,</span><span class="skolem">d2'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="main">*</span> <span class="skolem">d2</span> <span class="main">=</span> <span class="skolem">d1'</span> <span class="main">*</span> <span class="skolem">d2'</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> eq dvd <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="main">=</span> <span class="skolem">d1'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">meson</span> assms coprime_crossproduct_nat coprime_divisors<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> eq dvd <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d2</span> <span class="main">=</span> <span class="skolem">d2'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eq1 eq2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d1</span> <span class="main">=</span> <span class="skolem">d1'</span> <span class="main">∧</span> <span class="skolem">d2</span> <span class="main">=</span> <span class="skolem">d2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span> 
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">d1</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span> <span class="free">S</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> S_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">T</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">a</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>gcd <span class="free">k</span> <span class="free">b</span><span class="main">)</span>
       <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d1</span> <span class="bound">d2</span><span class="main">.</span> <span class="skolem">d</span> <span class="main">=</span> <span class="bound">d1</span><span class="main">*</span><span class="bound">d2</span> <span class="main">∧</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> division_decomp mult_dvd_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def S_def T_def image_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-p_div_set"><span class="command">lemma</span></span> p_div_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="free">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span> <span class="main">=</span> 
         <span class="main">(</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="free">N</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> 
      <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈#</span> prime_factorization <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> in_prime_factors_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> as
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">*</span><span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">*</span><span class="free">N</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> in_prime_factors_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> as <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> prime_factors <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">-</span> prime_factors <span class="free">N</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span>
               <span class="main">⊆</span> prime_factors <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">-</span> prime_factors <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> 
      <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">-</span> prime_factors <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">N</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> prime_factors <span class="free">N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> DiffD1 DiffD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff<span class="main">)</span>        
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈#</span> prime_factorization <span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_prime_factors_iff as <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">N</span>›</span></span> prime_dvd_multD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span><span class="main">*</span><span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_prime_factors_iff <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">-</span> prime_factors <span class="free">N</span>
               <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> prime_factorization <span class="free">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-coprime_iff_prime_factors_disjoint"><span class="command">lemma</span></span> coprime_iff_prime_factors_disjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> prime_factors <span class="free">x</span> <span class="main">∩</span> prime_factors <span class="free">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_dvd<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="free">x</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_common_divisor <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> that assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">x</span> <span class="main">∩</span> prime_factors <span class="free">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">x</span> <span class="main">∩</span> prime_factors <span class="free">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> coprimeI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_unit <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> d assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_divisor_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> d <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="free">x</span> <span class="main">∩</span> prime_factors <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_dvd<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> disjoint <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-coprime_cong_prime_factors"><span class="command">lemma</span></span> coprime_cong_prime_factors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_semiring_gcd"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">x</span> <span class="main">=</span> prime_factors <span class="free">x'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">y</span> <span class="main">=</span> prime_factors <span class="free">y'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"coprime <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> coprime <span class="free">x'</span> <span class="free">y'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_iff_prime_factors_disjoint<span class="main">)</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-moebius_prod_not_coprime"><span class="command">lemma</span></span> moebius_prod_not_coprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="free">N</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"moebius_mu <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_form<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">dvd</span> <span class="free">N</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="keyword1">dvd</span> <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> is_unit <span class="skolem">l</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> coprime_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">*</span> <span class="skolem">l</span> <span class="keyword1">dvd</span> <span class="free">N</span> <span class="main">*</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mult_dvd_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">*</span><span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power2_eq_square<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> squarefree <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="free">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> squarefree_def coprime_def <span class="keyword1"><span class="command">using</span></span> l_form <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"moebius_mu <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> moebius_mu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Theorem 2.18›</span></span>

<span class="comment1">(* TODO Place in corresponding theory *)</span>
<span class="keyword1" id="Gauss_Sums_Auxiliary-sum_divisors_moebius_mu_times_multiplicative"><span class="command">lemma</span></span> sum_divisors_moebius_mu_times_multiplicative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> dirichlet_prod <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> moebius_mu <span class="bound">n</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> multiplicative_function <span class="quoted"><span class="free">f</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> multiplicative_function <span class="quoted"><span class="skolem">g'</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicative_dirichlet_prod multiplicative_function_mult
              moebius_mu.multiplicative_function_axioms assms<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> g'_primepow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> moebius_mu <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g'_def dirichlet_prod_prime_power<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> moebius_mu <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> moebius_mu_power'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> moebius_mu.prime<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">g</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def g'_def dirichlet_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="skolem">g'</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_prime_factors<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g'_primepow prime_factors_multiplicity<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-multiplicative_ind_coprime"><span class="command">lemma</span></span> multiplicative_ind_coprime <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="main">(</span>ind <span class="main">(</span>coprime <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicative_function_ind<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-sum_divisors_moebius_mu_times_multiplicative_revisited"><span class="command">lemma</span></span> sum_divisors_moebius_mu_times_multiplicative_revisited<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span>ind <span class="main">(</span>coprime <span class="free">N</span><span class="main">)</span> <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> ind <span class="main">(</span>coprime <span class="free">N</span><span class="main">)</span> <span class="bound">p</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_divisors_moebius_mu_times_multiplicative<span class="main">)</span>
                   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiplicative_function_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.mono_neutral_cong_right<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def prime_factors_dvd coprime_commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_imp_coprime<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Neutral element of the Dirichlet product›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dirichlet_prod_neutral</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-dirichlet_prod_neutral_intro"><span class="command">lemma</span></span> dirichlet_prod_neutral_intro<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="free">n</span> <span class="main">*</span> dirichlet_prod_neutral <span class="main">(</span>gcd <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span>dirichlet_prod_neutral <span class="main">(</span>gcd <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> zeros<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> dirichlet_prod_neutral <span class="main">(</span>gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dirichlet_prod_neutral_def<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">k</span> <span class="free">n</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main"><span class="keyword3">,</span></span><span class="operator">presburger</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?g</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dirichlet_prod_neutral_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?g</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeros<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-dirichlet_prod_neutral_right_neutral"><span class="command">lemma</span></span> dirichlet_prod_neutral_right_neutral<span class="main">:</span>
 <span class="quoted"><span class="quoted">"dirichlet_prod <span class="free">f</span> dirichlet_prod_neutral <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="free">n</span> "</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">⟷</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> div_self that dvd_mult_div_cancel <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="skolem">d</span><span class="main">)</span><span class="main">*</span>dirichlet_prod_neutral<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">d</span> <span class="keyword1">then</span> <span class="free">f</span><span class="main">(</span><span class="skolem">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dirichlet_prod_neutral_def eq<span class="main">)</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> summand <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dirichlet_prod <span class="free">f</span> dirichlet_prod_neutral <span class="free">n</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span>dirichlet_prod_neutral<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dirichlet_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">d</span> <span class="keyword1">then</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> summand <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="main">=</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">d</span> <span class="keyword1">then</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">n</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-dirichlet_prod_neutral_left_neutral"><span class="command">lemma</span></span> dirichlet_prod_neutral_left_neutral<span class="main">:</span>
 <span class="quoted"><span class="quoted">"dirichlet_prod dirichlet_prod_neutral <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="free">n</span> "</span></span> 
 <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span>
  <span class="keyword1"><span class="command">using</span></span> dirichlet_prod_neutral_right_neutral<span class="main">[</span><span class="operator">OF</span> that<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> 
        dirichlet_prod_commutes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">dirichlet_prod_neutral</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

<span class="keyword1"><span class="command">corollary</span></span> I_right_neutral_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dirichlet_prod <span class="free">f</span> dirichlet_prod_neutral <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms dirichlet_prod_neutral_right_neutral <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiplicative functions›</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-mult_id"><span class="command">lemma</span></span> mult_id<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicative_function id"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicative_function_def<span class="main">)</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-mult_moebius"><span class="command">lemma</span></span> mult_moebius<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicative_function moebius_mu"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Moebius_Mu.moebius_mu.multiplicative_function_axioms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-mult_of_nat"><span class="command">lemma</span></span> mult_of_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicative_function of_nat"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> multiplicative_function_def of_nat_0 of_nat_1 of_nat_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-mult_of_nat_c"><span class="command">lemma</span></span> mult_of_nat_c<span class="main">:</span> <span class="quoted"><span class="quoted">"completely_multiplicative_function of_nat"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> completely_multiplicative_function_def<span class="main">)</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-completely_multiplicative_nonzero"><span class="command">lemma</span></span> completely_multiplicative_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="free">f</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> completely_multiplicative_function_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"prime <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> prime_factor_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 
      <span class="keyword1"><span class="command">using</span></span> 2 prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 3 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> completely_multiplicative_function.mult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-multipl_div"><span class="command">lemma</span></span> multipl_div<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">k</span> <span class="free">d1</span> <span class="free">d2</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d2</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">d1</span><span class="main">*</span><span class="free">d2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="free">d1</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> multiplicative_function_def
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> multiplicative_function.mult_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-multipl_div_mono"><span class="command">lemma</span></span> multipl_div_mono<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">k</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="free">f</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> completely_multiplicative_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> div<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">d</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> div <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> div <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> completely_multiplicative_function.mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> div <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums_Auxiliary-comp_to_mult"><span class="command">lemma</span></span> comp_to_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="free">f</span> <span class="main">⟹</span>
       multiplicative_function <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> completely_multiplicative_function_def
            multiplicative_function_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Periodic_Arithmetic">
<div class="head">
<h1>Theory Periodic_Arithmetic</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Periodic_Arithmetic.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM

  Periodic arithmetic functions
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Periodic arithmetic functions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Periodic_Arithmetic
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Cong.html">HOL-Number_Theory.Cong</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">periodic_arithmetic</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>

<span class="keyword1" id="Periodic_Arithmetic-const_periodic_arithmetic"><span class="command">lemma</span></span> const_periodic_arithmetic<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">y</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Periodic_Arithmetic-add_periodic_arithmetic"><span class="command">lemma</span></span> add_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Periodic_Arithmetic-mult_periodic_arithmetic"><span class="command">lemma</span></span> mult_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Periodic_Arithmetic-scalar_mult_periodic_arithmetic"><span class="command">lemma</span></span> scalar_mult_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> const_periodic_arithmetic<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Periodic_Arithmetic-fin_sum_periodic_arithmetic_set"><span class="command">lemma</span></span> fin_sum_periodic_arithmetic_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> periodic_arithmetic <span class="main">(</span><span class="free">h</span> <span class="bound">i</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">h</span> <span class="bound">i</span> <span class="bound">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> periodic_arithmetic_def<span class="main">)</span>

<span class="keyword1" id="Periodic_Arithmetic-mult_period"><span class="command">lemma</span></span> mult_period<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span> <span class="main">*</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span> <span class="main">+</span>  <span class="free">k</span> <span class="main">*</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main">]</span> assms
       <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span> <span class="main">*</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">k</span> <span class="main">*</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>   
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodic_Arithmetic-unique_periodic_arithmetic_extension"><span class="command">lemma</span></span> unique_periodic_arithmetic_extension<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">h</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">h</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">i</span> <span class="main">=</span> <span class="free">h</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">div</span> <span class="free">k</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> euclid_div<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span><span class="skolem">q</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">h</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> mult_period <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">q</span><span class="main">+</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="skolem">r</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodic_arithmetic <span class="free">g</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">q</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def 
      <span class="keyword1"><span class="command">using</span></span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span><span class="skolem">q</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">h</span><span class="main">(</span><span class="skolem">r</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> euclid_div assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">h</span><span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">q</span><span class="main">+</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹periodic_arithmetic <span class="free">h</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">q</span><span class="main">)</span>›</span></span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span><span class="skolem">q</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">h</span><span class="main">(</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> euclid_div <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">(</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span><span class="main">(</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> euclid_div <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
                  
<span class="keyword1" id="Periodic_Arithmetic-periodic_arithmetic_sum_periodic_arithmetic"><span class="command">lemma</span></span> periodic_arithmetic_sum_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">m</span><span class="main">+</span><span class="free">k</span><span class="main">..</span><span class="free">n</span><span class="main">+</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_def assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness
         <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">m</span></span></span><span class="main"><span class="main"><span class="main">..</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="free"><span class="free"><span class="free">k</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">+</span></span></span><span class="free"><span class="free"><span class="free">k</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">m</span></span></span><span class="main"><span class="main"><span class="main">+</span></span></span><span class="free"><span class="free"><span class="free">k</span></span></span><span class="main"><span class="main"><span class="main">..</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">+</span></span></span><span class="free"><span class="free"><span class="free">k</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="operator">auto</span>

<span class="keyword1" id="Periodic_Arithmetic-mod_periodic_arithmetic"><span class="command">lemma</span></span> mod_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">mod</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>   
     <span class="keyword1"><span class="command">using</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="skolem">q'</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">(</span><span class="free">m</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_period<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> periodic_arithmetic_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span><span class="skolem">q</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> add.commute<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="main">(</span><span class="free">m</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_period<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> periodic_arithmetic_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">*</span><span class="skolem">q'</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> add.commute<span class="main"><span class="keyword3">,</span></span><span class="operator">presburger</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodic_Arithmetic-cong_periodic_arithmetic"><span class="command">lemma</span></span> cong_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mod_periodic_arithmetic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1" id="Periodic_Arithmetic-cong_nat_imp_eq"><span class="command">lemma</span></span> cong_nat_imp_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_wlog<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>le <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_diff_iff_cong_0_nat cong_sym le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_sym<span class="main">)</span>

<span class="keyword1" id="Periodic_Arithmetic-inj_on_mod_nat"><span class="command">lemma</span></span> inj_on_mod_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">m</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> xy <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_nat_imp_eq<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> eq <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main">:</span> cong_def›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodic_Arithmetic-bij_betw_mod_nat_atLeastLessThan"><span class="command">lemma</span></span> bij_betw_mod_nat_atLeastLessThan<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> nat <span class="main">(</span><span class="main">(</span>int <span class="bound">i</span> <span class="main">-</span> int <span class="free">d</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">k</span><span class="main">)</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span><span class="main">+</span><span class="free">k</span><span class="main">}</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span> <span class="main">+</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_mod_nat<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span> <span class="main">+</span> <span class="free">k</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span> <span class="main">+</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_image<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span> <span class="main">+</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_subset_eq<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodic_Arithmetic-periodic_arithmetic_sum_periodic_arithmetic_shift"><span class="command">lemma</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">..</span><span class="free">d</span><span class="main">+</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span><span class="main">+</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">l</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij_betw_mod_nat_atLeastLessThan<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> 
                  lessThan_atLeast0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">..&lt;</span><span class="free">d</span><span class="main">+</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mod_periodic_arithmetic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> sum.cong
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mod_mod_trivial<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">d</span><span class="main">..</span><span class="free">d</span><span class="main">+</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodic_Arithmetic-self_bij_0_k"><span class="command">lemma</span></span> self_bij_0_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">*</span><span class="free">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">*</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">*</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r1</span> <span class="skolem">r2</span>
    <span class="keyword3"><span class="command">assume</span></span> in_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">r1</span><span class="main">*</span><span class="free">a</span> <span class="main">=</span> <span class="skolem">r2</span><span class="main">*</span><span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">r1</span><span class="main">*</span><span class="free">a</span><span class="main">*</span><span class="free">i</span> <span class="main">=</span> <span class="skolem">r2</span><span class="main">*</span><span class="free">a</span><span class="main">*</span><span class="free">i</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> cong_scalar_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">r2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> cong_mult_rcancel_nat as assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">r2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_k
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> cong_less_modulus_unique_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> "</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def
        <span class="keyword1"><span class="command">using</span></span> Suc_pred assms<span class="main">(</span>3<span class="main">)</span> lessThan_Suc_atMost <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
        <span class="keyword3"><span class="command">assume</span></span> ass<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc_diff_1 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>          
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">*</span><span class="free">i</span><span class="main">*</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">k</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_left_eq<span class="main">)</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">*</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">k</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
            <span class="keyword1"><span class="command">unfolding</span></span> cong_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mult.commute<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">subst</span> mod_mult_right_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ass assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">*</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Periodic_Arithmetic-periodic_arithmetic_homothecy"><span class="command">lemma</span></span> periodic_arithmetic_homothecy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">l</span><span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="free">a</span><span class="main">+</span><span class="free">k</span><span class="main">*</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="free">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mult_period<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> periodic_arithmetic_remove_homothecy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">l</span><span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">*</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> coprime_iff_invertible_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this self_bij_0_k assms
  <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">l</span><span class="main">*</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.reindex_bij_betw<span class="main">[</span><span class="operator">OF</span> bij<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">l</span><span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> mod_periodic_arithmetic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> mod_mod_trivial <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">l</span><span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">l</span><span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
          periodic_arithmetic_homothecy<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>     
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Complex_Roots_Of_Unity">
<div class="head">
<h1>Theory Complex_Roots_Of_Unity</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Complex_Roots_Of_Unity.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM

  Complex roots of unity (exp(2iπ/n)) and sums over them.
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Complex_Roots_Of_Unity
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Analysis.html">HOL-Analysis.Analysis</a>"</span>
  <a href="Periodic_Arithmetic.html">Periodic_Arithmetic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Complex roots of unity›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">unity_root</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> cis <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> of_nat <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_k_0"><span class="command">lemma</span></span> 
  unity_root_k_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  unity_root_0_n <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unity_root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_conv_exp"><span class="command">lemma</span></span> unity_root_conv_exp<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> exp <span class="main">(</span>of_real <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">n</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unity_root_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cis_conv_exp<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> mult.commute<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_mod"><span class="command">lemma</span></span> unity_root_mod<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> int <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">/</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> False<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">n</span> <span class="main">=</span> real_of_int <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real_of_int <span class="skolem">q</span> <span class="main">*</span> real <span class="free">k</span> <span class="main">+</span> real_of_int <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> of_int_add of_int_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="free">n</span> <span class="main">=</span> real_of_int <span class="skolem">q</span> <span class="main">*</span> real <span class="free">k</span> <span class="main">+</span> real_of_int <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">n</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">q</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">/</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">n</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="keyword1">𝗂</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">q</span><span class="main">*</span><span class="keyword1">𝗂</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="keyword1">𝗂</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r1</span> <span class="main">+</span> <span class="var">?r2</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="var">?l</span> <span class="main">=</span> exp <span class="var">?r2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_plus_2pin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_add mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> unity_root_def unity_root_conv_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_cong"><span class="command">lemma</span></span> unity_root_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span> <span class="main">=</span> <span class="free">n</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">m</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">mod</span> int <span class="free">k</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> int <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">mod</span> int <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> int <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_mod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_mod_nat"><span class="command">lemma</span></span> unity_root_mod_nat<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span>nat <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> int <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> int <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> int_nat_eq 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">mod</span> int <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> unity_root_mod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_eqD"><span class="command">lemma</span></span> unity_root_eqD<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">i</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="free">j</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">mod</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?arg1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">i</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?arg2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">j</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> eq unity_root_conv_exp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="var">?arg1</span> <span class="main">=</span> exp <span class="var">?arg2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this exp_eq 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?arg1</span> <span class="main">=</span> <span class="var">?arg2</span> <span class="main">+</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">*</span>pi<span class="main">)</span><span class="main">*</span><span class="keyword1">𝗂</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?arg1</span> <span class="main">-</span> <span class="var">?arg2</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?arg1</span> <span class="main">-</span> <span class="var">?arg2</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> e1 e2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">*</span><span class="free">k</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">j</span><span class="main">)</span><span class="main">*</span>pi<span class="main">*</span><span class="keyword1">𝗂</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">*</span><span class="free">k</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> complex_i_not_zero mult_cancel_right of_int_eq_iff of_real_eq_iff pi_neq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">*</span><span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">-</span><span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">Groebner_Basis.algebra</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_eq_1_iff"><span class="command">lemma</span></span> unity_root_eq_1_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">n</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_conv_exp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">n</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complex_root_unity_eq_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_pow"><span class="command">lemma</span></span> unity_root_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unity_root_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Complex.DeMoivre mult.commute <span class="dynamic"><span class="dynamic">algebra_split_simps</span></span><span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_add"><span class="command">lemma</span></span> unity_root_add<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="free">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_conv_exp add_divide_distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span> exp_add<span class="main">)</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_uminus"><span class="command">lemma</span></span> unity_root_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unity_root_conv_exp exp_cnj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-inverse_unity_root"><span class="command">lemma</span></span> inverse_unity_root<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> unity_root_conv_exp exp_cnj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> exp_minus<span class="main">)</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_diff"><span class="command">lemma</span></span> unity_root_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="free">m</span> <span class="main">*</span> cnj <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unity_root_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_uminus<span class="main">)</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_eq_1_iff_int"><span class="command">lemma</span></span> unity_root_eq_1_iff_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> int <span class="skolem">n'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> zero_le_imp_eq_int<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> unity_root_eq_1_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">]</span> of_nat_dvd_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> inverse <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inverse_unity_root <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_eq_1_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span>"</span></span><span class="main">,</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span> False 
          int_dvd_int_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span>"</span></span><span class="main">]</span> nat_0_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">-</span><span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_eq_1"><span class="command">lemma</span></span> unity_root_eq_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">⟹</span> unity_root <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unity_root_eq_1_iff_int<span class="main">)</span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_periodic_arithmetic"><span class="command">lemma</span></span> unity_periodic_arithmetic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span>unity_root <span class="free">k</span><span class="main">)</span> <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> zmod_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> unity_root_mod zmod_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_periodic_arithmetic_mult"><span class="command">lemma</span></span> unity_periodic_arithmetic_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> int <span class="skolem">n</span>"</span></span><span class="main">]</span> unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> int <span class="skolem">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">*</span> int <span class="free">k</span>"</span></span><span class="main">]</span> 
          mod_mult_self3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_periodic_arithmetic_mult_minus"><span class="command">lemma</span></span> unity_root_periodic_arithmetic_mult_minus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span>int <span class="bound">i</span><span class="main">*</span>int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="free">m</span><span class="main">+</span><span class="free">k</span><span class="main">*</span><span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs unity_root_diff unity_root_add unity_root_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cnj <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_period<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span>"</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> unity_periodic_arithmetic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_div"><span class="command">lemma</span></span> unity_div<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="free">a</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_pred assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>   
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_conv_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">*</span><span class="free">a</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_conv_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_div_num"><span class="command">lemma</span></span> unity_div_num<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">d</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms dvd_div_mult_self unity_div <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Geometric sums of roots of unity›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Apostol calls these `geometric sums', which is a bit too generic. We therefore decided
  to refer to them as `sums of roots of unity'.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unity_root_sum</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> unity_root <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">*</span> of_nat <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_sum_0_left"><span class="command">lemma</span></span> unity_root_sum_0_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      unity_root_sum_0_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> unity_root_sum <span class="free">k</span> <span class="main">0</span> <span class="main">=</span> <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> unity_root_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.1›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> unity_root_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">⟹</span> unity_root_sum <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">⟹</span> unity_root_sum <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd gr unity_root_eq_1_iff_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> exp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span><span class="main">^</span><span class="skolem">m</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">n</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="keyword1"><span class="command">using</span></span> unity_root_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> unity_root_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="var">?x</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd gr unity_root_eq_1_iff_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x</span><span class="main">^</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="var">?x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="var">?x</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> geometric_sum<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?x</span> <span class="main">≠</span> <span class="main">1</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="var">?x</span><span class="main">^</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">/</span><span class="main">(</span><span class="var">?x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_sum_def unity_root_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gr unity_root_eq_1_iff_int unity_root_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> unity_root_sum_periodic_arithmetic<span class="main">:</span> 
 <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span>unity_root_sum <span class="free">k</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root_sum <span class="free">k</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_sum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Complex_Roots_Of_Unity-unity_root_sum_nonzero_iff"><span class="command">lemma</span></span> unity_root_sum_nonzero_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="free">k</span><span class="main">&lt;..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> unity_root_sum assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> dvd_imp_le_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">r</span> <span class="main">=</span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> unity_root_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="free">k</span> <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Finite_Fourier_Series">
<div class="head">
<h1>Theory Finite_Fourier_Series</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Finite_Fourier_Series.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM

  Existence and uniqueness of finite Fourier series for periodic arithmetic functions
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite Fourier series›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Finite_Fourier_Series
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Polynomial_Interpolation/Lagrange_Interpolation.html">Polynomial_Interpolation.Lagrange_Interpolation</a>
  <a href="Complex_Roots_Of_Unity.html">Complex_Roots_Of_Unity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary facts›</span></span>

<span class="keyword1" id="Finite_Fourier_Series-lagrange_exists"><span class="command">lemma</span></span> lagrange_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">zs_ws</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">::</span> complex poly<span class="main">)</span> <span class="main">≡</span> lagrange_interpolation_poly <span class="free">zs_ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">zs_ws</span><span class="main">)</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">zs_ws</span> <span class="main">⟶</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> e <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">zs_ws</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degree_lagrange_interpolation_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> e d <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">zs_ws</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> 
    <span class="keyword1"><span class="command">using</span></span> that lagrange_interpolation_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">zs_ws</span> <span class="main">⟶</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Fourier_Series-lagrange_unique"><span class="command">lemma</span></span> lagrange_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">zs_ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="comment1">(* implicit in theorem *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">zs_ws</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p1</span> <span class="main">::</span> complex poly<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">zs_ws</span><span class="main">)</span><span class="main">-</span><span class="main">1</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">zs_ws</span> <span class="main">⟶</span> poly <span class="free">p1</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p2</span> <span class="main">::</span> complex poly<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">zs_ws</span><span class="main">)</span><span class="main">-</span><span class="main">1</span> <span class="main">∧</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">zs_ws</span> <span class="main">⟶</span> poly <span class="free">p2</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">=</span> <span class="free">p2</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="free">p1</span><span class="main">-</span><span class="free">p2</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">zs_ws</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this d <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p1</span><span class="main">-</span><span class="free">p2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≥</span> length <span class="free">zs_ws</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs_ws</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z_w</span> <span class="skolem">zs_ws</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span>  False poly_roots_finite
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">z_w</span> <span class="main">#</span> <span class="skolem">zs_ws</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">z_w</span> <span class="main">#</span> <span class="skolem">zs_ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> card_mono f <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">z_w</span> <span class="main">#</span> <span class="skolem">zs_ws</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">z_w</span> <span class="main">#</span> <span class="skolem">zs_ws</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
      <span class="keyword1"><span class="command">from</span></span> this i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">zs_ws</span><span class="main">)</span><span class="main">-</span><span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> degree_diff_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span> <span class="main">=</span> <span class="main">0</span>"</span></span>  
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">-</span> <span class="free">p2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p1</span><span class="main">-</span><span class="free">p2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> degree <span class="main">(</span><span class="free">p1</span><span class="main">-</span><span class="free">p2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> poly_roots_degree <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="free">p1</span><span class="main">-</span><span class="free">p2</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">zs_ws</span><span class="main">)</span><span class="main">-</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 o <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.2›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> lagrange<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">zs_ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">zs_ws</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃!</span> <span class="main">(</span><span class="bound">p</span> <span class="main">::</span> complex poly<span class="main">)</span><span class="main">.</span>
              degree <span class="bound">p</span> <span class="main">≤</span> length <span class="free">zs_ws</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">zs_ws</span> <span class="main">⟶</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lagrange_exists lagrange_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Finite_Fourier_Series-poly_altdef'"><span class="command">lemma</span></span> poly_altdef'<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> degree <span class="free">p</span>"</span></span>  
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">(</span><span class="free">z</span><span class="main">::</span>complex<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">z</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>degree <span class="free">p</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_altdef<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> coeff <span class="free">p</span> <span class="bound">i</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gr
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_altdef<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> le_degree not_less_eq_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition and uniqueness›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finite_fourier_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex list <span class="main">⇒</span> complex poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finite_fourier_poly</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">ws</span></span></span>
      <span class="keyword1">in</span>  poly_of_list <span class="main">[</span><span class="main">1</span> <span class="main">/</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">!</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="bound">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Finite_Fourier_Series-degree_poly_of_list_le"><span class="command">lemma</span></span> degree_poly_of_list_le<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>poly_of_list <span class="free">ws</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">ws</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> degree_le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_default_def<span class="main">)</span>

<span class="keyword1" id="Finite_Fourier_Series-degree_finite_fourier_poly"><span class="command">lemma</span></span> degree_finite_fourier_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">ws</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_fourier_poly_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?unrolled_list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"
       <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> complex_of_real <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                  <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span>length <span class="free">ws</span><span class="main">.</span>
                      <span class="free">ws</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">*</span>
                      unity_root <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">n</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ws</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>poly_of_list <span class="var">?unrolled_list</span><span class="main">)</span> <span class="main">≤</span> length <span class="var">?unrolled_list</span> <span class="main">-</span> <span class="main">1</span>"</span></span>   
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_poly_of_list_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">ws</span><span class="main">]</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="free">ws</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>poly_of_list <span class="var">?unrolled_list</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">ws</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Fourier_Series-coeff_finite_fourier_poly"><span class="command">lemma</span></span> coeff_finite_fourier_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≡</span> length <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> 
         <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms degree_finite_fourier_poly
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def nth_default_def finite_fourier_poly_def<span class="main">)</span>

<span class="keyword1" id="Finite_Fourier_Series-poly_finite_fourier_poly"><span class="command">lemma</span></span> poly_finite_fourier_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ws</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≡</span> length <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="main">(</span>nat <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> distr<span class="main">:</span> <span class="quoted"><span class="quoted">"
   <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span>length <span class="free">ws</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span>length <span class="free">ws</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="bound">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">using</span></span> sum_distrib_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="bound">j</span><span class="main">)</span>"</span></span> 
                            <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="skolem">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="skolem">j</span><span class="main">+</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_diff unity_root_uminus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="skolem">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">i</span><span class="main">*</span><span class="skolem">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              <span class="free">ws</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> prod <span class="main">=</span> this

 <span class="keyword1"><span class="command">have</span></span> zeros<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="main">(</span>unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">)</span>
     "</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
   <span class="keyword1"><span class="command">using</span></span> k_def that assms unity_root_sum_nonzero_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">-</span><span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sum_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span>nat <span class="free">m</span><span class="main">}</span><span class="main">.</span>  <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> coeff <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degree_finite_fourier_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ws</span></span><span class="main">]</span> k_def
          poly_altdef'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"finite_fourier_poly <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> coeff <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">i</span><span class="main">*</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coeff_finite_fourier_poly<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">ws</span></span><span class="main">]</span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">i</span><span class="main">*</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">i</span><span class="main">*</span><span class="bound">j</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distr k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span>  
    <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span>  
    <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vector_space_over_itself.scale_sum_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> unity_root_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span>nat <span class="free">m</span><span class="main">}</span><span class="main">.</span>  <span class="free">ws</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">*</span> unity_root_sum <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_eq <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="main">(</span>nat <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="main">(</span>nat <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.3›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> finite_fourier_poly_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≡</span> length <span class="free">ws</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degree <span class="free">p</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≤</span> <span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="free">ws</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> poly <span class="free">p</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> finite_fourier_poly <span class="free">ws</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="bound">m</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_conv_nth <span class="keyword1"><span class="command">using</span></span> unity_root_eqD<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs_ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"zip <span class="var">?z</span> <span class="free">ws</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> d1 k_def <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="var">?zs_ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zs_ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> l3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zs_ws</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> degree_finite_fourier_poly <span class="keyword1"><span class="command">have</span></span> degree<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> interp<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?zs_ws</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"
         <span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">∘</span> int<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">∧</span>
         <span class="skolem">y</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">∧</span> 
         <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_zip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>unity_root <span class="free">k</span><span class="main">)</span> <span class="main">(</span>map int <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
         <span class="skolem">x</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span>
         <span class="skolem">y</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">∧</span> 
         <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">∘</span> int"</span></span> <span class="main">]</span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_finite_fourier_poly k_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> interp_p<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?zs_ws</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"
         <span class="skolem">x</span> <span class="main">=</span> map <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">∘</span> int<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">∧</span>
         <span class="skolem">y</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">∧</span> 
         <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_zip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>unity_root <span class="free">k</span><span class="main">)</span> <span class="main">(</span>map int <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">∘</span> int"</span></span> <span class="main">]</span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> rw<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> rw<span class="main">(</span>3<span class="main">)</span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> lagrange_unique<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"finite_fourier_poly <span class="free">ws</span>"</span></span><span class="main">]</span> d2 l2
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"
    degree <span class="free">p</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?zs_ws</span> <span class="main">⟶</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
    degree <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?zs_ws</span> <span class="main">⟶</span> poly <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms degree interp interp_p l3
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span>finite_fourier_poly <span class="free">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following alternative formulation returns a coefficient
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finite_fourier_poly'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> complex<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> complex poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finite_fourier_poly'</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span>
     <span class="main">(</span>poly_of_list <span class="main">[</span><span class="main">1</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Finite_Fourier_Series-finite_fourier_poly'_conv_finite_fourier_poly"><span class="command">lemma</span></span> finite_fourier_poly'_conv_finite_fourier_poly<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span> <span class="main">=</span> finite_fourier_poly <span class="main">[</span><span class="free">ws</span> <span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_fourier_poly_def finite_fourier_poly'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Finite_Fourier_Series-coeff_finite_fourier_poly'"><span class="command">lemma</span></span> coeff_finite_fourier_poly'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> 
         <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">ws</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ws</span> <span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span>
        coeff <span class="main">(</span>finite_fourier_poly <span class="var">?ws</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_fourier_poly'_conv_finite_fourier_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>finite_fourier_poly <span class="var">?ws</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> 
    <span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span> <span class="free">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_finite_fourier_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">ws</span> <span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Fourier_Series-degree_finite_fourier_poly'"><span class="command">lemma</span></span> degree_finite_fourier_poly'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree_finite_fourier_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ws</span> <span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_fourier_poly'_conv_finite_fourier_poly<span class="main">)</span>

<span class="keyword1" id="Finite_Fourier_Series-poly_finite_fourier_poly'"><span class="command">lemma</span></span> poly_finite_fourier_poly'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">(</span>nat <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms poly_finite_fourier_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ws</span> <span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_fourier_poly'_conv_finite_fourier_poly poly_finite_fourier_poly<span class="main">)</span>

<span class="keyword1" id="Finite_Fourier_Series-finite_fourier_poly'_unique"><span class="command">lemma</span></span> finite_fourier_poly'_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">ws</span> <span class="bound">m</span> <span class="main">=</span> poly <span class="free">p</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ws</span> <span class="bound">n</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> finite_fourier_poly_unique <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> finite_fourier_poly <span class="var">?ws</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_fourier_poly'_conv_finite_fourier_poly <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> finite_fourier_poly' <span class="free">ws</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Finite_Fourier_Series-fourier_unity_root"><span class="command">lemma</span></span> fourier_unity_root<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span><span class="main">(</span><span class="free">f</span> <span class="bound">m</span><span class="main">)</span><span class="main">*</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">*</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> coeff <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="bound">n</span> <span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span><span class="main">^</span><span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poly_altdef'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"finite_fourier_poly' <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="free">m</span>"</span></span><span class="main">]</span>
          degree_finite_fourier_poly'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> coeff <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="bound">n</span> <span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> unity_root_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> coeff <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="bound">n</span> <span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span><span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span><span class="main">(</span><span class="free">f</span> <span class="bound">m</span><span class="main">)</span><span class="main">*</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> coeff_finite_fourier_poly'<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"poly <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span><span class="main">(</span><span class="free">f</span> <span class="bound">m</span><span class="main">)</span><span class="main">*</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">*</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expansion of an arithmetical function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.4›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> fourier_expansion_periodic_arithmetic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">from</span></span> unity_periodic_arithmetic mult_period
  <span class="keyword1"><span class="command">have</span></span> period<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> period <span class="main">=</span> this
 <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">l</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_uminus unity_root_diff ring_distribs unity_root_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">n</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> unity_root_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">…</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_uminus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> u_period <span class="main">=</span> this
  
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
   
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> u_period <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
      <span class="keyword3"><span class="command">assume</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">=</span> poly <span class="main">(</span>finite_fourier_poly' <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_finite_fourier_poly'<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fourier_unity_root assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> concentrated <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">int</span>
      <span class="keyword1"><span class="command">using</span></span> 1 unity_periodic_arithmetic mult_periodic_arithmetic
            unity_periodic_arithmetic_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">na</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">na</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> int <span class="bound">na</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">na</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">na</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="skolem">n</span> <span class="main">*</span> int <span class="bound">na</span><span class="main">)</span><span class="main">)</span>"</span></span>      
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> of_nat_mult of_nat_add<span class="main">)</span>
           <span class="main">(</span><span class="operator">insert</span> period<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> periodic_arithmetic_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>  
  
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>1-2<span class="main">)</span> concentrated 
       unique_periodic_arithmetic_extension<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">i</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="free">m</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>        
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> fourier_expansion_periodic_arithmetic_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span> <span class="main">*</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"poly_of_list <span class="main">[</span><span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">≤</span> <span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">≤</span> length <span class="main">[</span><span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> n <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span><span class="main">]</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> degree_poly_of_list_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> length_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="var">?p</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="free">g</span><span class="main">(</span><span class="skolem">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_default_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?p</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> coeff <span class="var">?p</span> <span class="bound">n</span><span class="main">*</span> <span class="skolem">z</span><span class="main">^</span><span class="bound">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> poly_altdef'<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> coeff <span class="var">?p</span> <span class="bound">n</span><span class="main">*</span> <span class="skolem">z</span><span class="main">^</span><span class="bound">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">*</span> <span class="skolem">z</span><span class="main">^</span><span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> <span class="skolem">z</span><span class="main">^</span><span class="bound">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?p</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">n</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> eval <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?p</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="skolem">i</span><span class="main">)</span><span class="main">^</span><span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?p</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">i</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> interpolation <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> 
    <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> d assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> poly <span class="var">?p</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> interpolation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">m</span> <span class="main">=</span> poly <span class="var">?p</span> <span class="main">(</span>unity_root <span class="free">k</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">from</span></span> this finite_fourier_poly'_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="main">_</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p_is_fourier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> finite_fourier_poly' <span class="free">f</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
    <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">k</span><span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> f_1<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="var">?p</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> p_is_fourier <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_finite_fourier_poly'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">(</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c b assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="var">?p</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="var">?p</span> <span class="skolem">n</span> <span class="main">=</span>  <span class="free">g</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c assms<span class="main">(</span>1<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>

 <span class="comment1">(* now show right hand side is periodic and use unique_periodic_extension *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span>int <span class="bound">i</span><span class="main">*</span>int <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
      <span class="keyword1"><span class="command">using</span></span> unity_root_periodic_arithmetic_mult_minus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">i</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> periodic_arithmetic_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">i</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> scalar_mult_periodic_arithmetic fin_sum_periodic_arithmetic_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> periodich <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">i</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> unique_periodic_arithmetic_extension<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">g</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> 
        assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> periodich
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">na</span><span class="main">.</span> <span class="bound">na</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">na</span> <span class="main">=</span> complex_of_real <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">na</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Ramanujan_Sums">
<div class="head">
<h1>Theory Ramanujan_Sums</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Ramanujan_Sums.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM

  Ramanujan sums and generalised Ramanujan sums
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Ramanujan sums›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Ramanujan_Sums
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Dirichlet_Series/Moebius_Mu.html">Dirichlet_Series.Moebius_Mu</a>
  <a href="Gauss_Sums_Auxiliary.html">Gauss_Sums_Auxiliary</a>
  <a href="Finite_Fourier_Series.html">Finite_Fourier_Series</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic sums›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ramanujan_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ramanujan_sum</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> unity_root <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> ramanujan_sum <span class="main">(</span><span class="quoted">"<span class="keyword1">c</span>"</span><span class="main">)</span>

<span class="keyword1" id="Ramanujan_Sums-ramanujan_sum_0_n"><span class="command">lemma</span></span> ramanujan_sum_0_n <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="main">0</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ramanujan_Sums-sum_coprime_conv_dirichlet_prod_moebius_mu"><span class="command">lemma</span></span> sum_coprime_conv_dirichlet_prod_moebius_mu<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="bound">n</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">n</span> <span class="main">=</span> dirichlet_prod moebius_mu <span class="free">F</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dirichlet_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">(</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span> <span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">*</span> dirichlet_prod_neutral <span class="main">(</span>gcd <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dirichlet_prod_neutral_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> moebius_mu <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dirichlet_prod_neutral <span class="main">(</span>gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> gcd <span class="skolem">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dirichlet_prod_neutral_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">k</span> <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_moebius_mu_divisors'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">k</span> <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dirichlet_prod_neutral <span class="main">(</span>gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> summand <span class="main">=</span> this
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> summand<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">k</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span>  moebius_mu <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="free">n</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span>  moebius_mu <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gcd.commute<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.swap_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
             <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span> <span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">*</span>moebius_mu <span class="bound">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">k</span>"</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">q</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"
      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">q</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">k</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">k</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">div</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main">:</span> div_le_mono›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> st False <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">F</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">q</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def real_of_nat_div that<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dirichlet_prod moebius_mu <span class="free">F</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dirichlet_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ramanujan_Sums-dirichlet_prod_neutral_sum"><span class="command">lemma</span></span> dirichlet_prod_neutral_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dirichlet_prod_neutral <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dirichlet_prod_neutral_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> add.left_neutral
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">0</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">0</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.atLeast_Suc_atMost sum.atLeast0_atMost_Suc_shift 1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum.atLeast0_atMost_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> False 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root_sum <span class="free">n</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> unity_root_sum_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dirichlet_prod_neutral <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span><span class="main">]</span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False dirichlet_prod_neutral_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"dirichlet_prod_neutral <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Ramanujan_Sums-moebius_coprime_sum"><span class="command">lemma</span></span> moebius_coprime_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"moebius_mu <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span> <span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">n</span><span class="main">.</span> unity_root <span class="bound">n</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> div_dvd_div <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" 
      <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">b</span> <span class="main">⟹</span>
      unity_root <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> 
      unity_root <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">using</span></span> unity_root_def real_of_nat_div <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
        dirichlet_prod moebius_mu <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span> <span class="bound">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_coprime_conv_dirichlet_prod_moebius_mu<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dirichlet_prod moebius_mu dirichlet_prod_neutral <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dirichlet_prod_neutral_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> moebius_mu <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dirichlet_prod_neutral_right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"moebius_mu <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">k</span></span> <span class="main">|</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">k</span> <span class="free">n</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ramanujan_sum_1_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> moebius_mu <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ramanujan_sum_def <span class="keyword1"><span class="command">using</span></span> moebius_coprime_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ramanujan_Sums-ramanujan_sum_dvd_eq_totient"><span class="command">lemma</span></span> ramanujan_sum_dvd_eq_totient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> totient <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ramanujan_sum_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="skolem">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unity_root_eq_1_iff_int<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> totient <span class="free">k</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> totient_def totatives_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">m</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
              of_nat <span class="main">(</span>card <span class="main">{</span><span class="bound"><span class="bound">ka</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">ka</span> <span class="free">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalised sums›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_ramanujan_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> complex<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> complex<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_ramanujan_sum</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">d</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="bound">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> gen_ramanujan_sum <span class="main">(</span><span class="quoted">"<span class="keyword1">s</span>"</span><span class="main">)</span>

<span class="keyword1" id="Ramanujan_Sums-gen_ramanujan_sum_k_1"><span class="command">lemma</span></span> gen_ramanujan_sum_k_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="main">1</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span> <span class="main">*</span> <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Ramanujan_Sums-gen_ramanujan_sum_1_n"><span class="command">lemma</span></span> gen_ramanujan_sum_1_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="main">1</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span> <span class="main">*</span> <span class="free">g</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Ramanujan_Sums-gen_ramanujan_sum_periodic"><span class="command">lemma</span></span> gen_ramanujan_sum_periodic<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.5›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gen_ramanujan_sum_fourier_expansion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span><span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="bound">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">a</span> <span class="free">k</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">d</span><span class="main">.</span> <span class="free">f</span> <span class="bound">d</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">l</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gen_ramanujan_sum_periodic mult_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="main">1</span></span>  <span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> 
          sum <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> zero_less_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="bound">n</span> <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_ramanujan_sum_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="bound">n</span> <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">n</span></span> <span class="main">|</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">n</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">n</span> <span class="free">k</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">n</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span> <span class="main">.</span> <span class="var">?h</span> <span class="bound">n</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gcd.commute<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">n</span></span> <span class="main">|</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">n</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum.swap_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">}</span>"</span></span>
                            <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
      <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">n</span> <span class="free">k</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">n</span> <span class="bound">d</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">n</span></span> <span class="main">|</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">n</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">n</span></span> <span class="main">|</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> int <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span><span class="bound">e</span><span class="main">*</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> sum_div_reduce div_greater_zero_iff dvd_div_gt0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="skolem">e</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real_of_int <span class="main">(</span><span class="main">-</span> int <span class="skolem">m</span> <span class="main">*</span> int <span class="main">(</span><span class="skolem">e</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="free">k</span> <span class="main">=</span>
              <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> real_of_int <span class="main">(</span><span class="main">-</span> int <span class="skolem">m</span> <span class="main">*</span> int <span class="skolem">e</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">k</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> unity_root_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dirichlet_prod <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="bound">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dirichlet_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dirichlet_prod <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="bound">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dirichlet_prod_commutes<span class="main">[</span><span class="operator">of</span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="bound">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="bound">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="bound">d</span><span class="main">::</span>nat<span class="main">)</span><span class="main">}</span><span class="main">.</span> unity_root <span class="bound">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">unfolding</span></span> dirichlet_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="bound">d</span><span class="main">::</span>nat<span class="main">)</span><span class="main">}</span><span class="main">.</span>
                      unity_root <span class="bound">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> div_div_eq_right<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">d</span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">m</span><span class="main">.</span> <span class="bound">d</span><span class="main">*</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> unity_root <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">d</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> unity_root <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> unity_root <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root_sum <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> unity_root_sum_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span><span class="main">.</span> unity_root <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root_sum <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">e</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="bound">d</span><span class="main">.</span> unity_root <span class="bound">d</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">m</span> <span class="main">*</span> int <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> unity_root_sum <span class="bound">d</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">m</span><span class="main">.</span> unity_root_sum <span class="bound">d</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span><span class="operator">standard</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> as <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="skolem">i</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≥</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unity_root_sum<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>   
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">m</span><span class="main">.</span> <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">m</span>"</span></span> 
        <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root_sum <span class="skolem">d</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> unity_root_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">d</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">-</span></span><span class="skolem"><span class="skolem">m</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> 1 2
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">m</span> <span class="free">k</span><span class="main">.</span> of_nat <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">m</span> <span class="free">k</span><span class="main">.</span> <span class="free">g</span> <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="bound">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="free">a</span> <span class="free">k</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">a</span> <span class="free">k</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> a_eq_g <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">from</span></span> fourier_expansion_periodic_arithmetic<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span>"</span></span> <span class="main">]</span> gen_ramanujan_sum_periodic assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="skolem">m</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">a</span> <span class="free">k</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="skolem">m</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_eq_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">≤</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="free">a</span> <span class="free">k</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="skolem">m</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="skolem">m</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">≤</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="free">a</span> <span class="free">k</span> <span class="bound">n</span> <span class="main">*</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">n</span> <span class="main">*</span> int <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.6›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> ramanujan_sum_dirichlet_form<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">.</span> <span class="bound">d</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> complex"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>  <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span>
   <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="bound">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="free">k</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> gcd <span class="skolem">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="free">k</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">m</span> <span class="free">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="bound">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">m</span> <span class="free">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> of_nat <span class="free">k</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
     <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">m</span> <span class="free">k</span>"</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"moebius_mu <span class="skolem">d</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="skolem">d</span> <span class="main">=</span> moebius_mu <span class="skolem">d</span> <span class="main">*</span> of_nat <span class="free">k</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"moebius_mu <span class="skolem">d</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="skolem">d</span> <span class="main">=</span> moebius_mu <span class="skolem">d</span> <span class="main">*</span> of_nat <span class="free">k</span>"</span></span>  
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> of_nat_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command">qed</span></span><span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this
     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>

   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="skolem">m</span> <span class="free">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left assms<span class="main">)</span> 
   <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">if</span> gcd <span class="skolem">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> sum_moebius_mu_divisors' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="free">k</span> <span class="skolem">m</span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> gcd <span class="skolem">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> coprime_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">qed</span></span><span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> a_expr <span class="main">=</span> this

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span>
                 unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> gen_ramanujan_sum_fourier_expansion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted">id</span> <span class="quoted">moebius_mu</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_nat <span class="main">(</span>id <span class="bound">x</span><span class="main">)</span><span class="main">)</span> moebius_mu <span class="free">k</span> <span class="free">n</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
      <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">k</span> <span class="main">*</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">m</span> <span class="free">k</span><span class="main">.</span>
         moebius_mu <span class="bound">d</span> <span class="main">*</span> of_nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="bound">d</span><span class="main">)</span> <span class="main">*</span>
      unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
      <span class="skolem">a</span> <span class="free">k</span> <span class="bound">m</span> <span class="main">*</span>
      unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">≤</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
      <span class="main">(</span><span class="keyword1">if</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span>
      unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_expr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span>
      <span class="main">(</span><span class="keyword1">if</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span>
      unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span>
                 unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> periodic_arithmetic_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="var">?f</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mult_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atMost_atLeast0<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">.</span>
                  <span class="main">(</span><span class="keyword1">if</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span>     
                  unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> gcd <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">.</span>
                  unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span>
                  unity_root <span class="free">k</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_iff_gcd_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">c</span> <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ramanujan_sum_conv_gen_ramanujan_sum<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">c</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="keyword1">s</span> id moebius_mu <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ramanujan_sum_dirichlet_form <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.7›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gen_ramanujan_sum_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="comment1">(* remove cond. on m,n *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">b</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">k</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">*</span> gcd <span class="free">k</span> <span class="free">b</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linear_gcd  gcd.commute mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span><span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">*</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span><span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
     <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">d1</span></span><span class="main">,</span><span class="bound"><span class="bound">d2</span></span><span class="main">)</span> <span class="main">|</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">∧</span>  <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span> 
          <span class="free">f</span><span class="main">(</span><span class="bound">d1</span><span class="main">*</span><span class="bound">d2</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span><span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">d1</span><span class="main">*</span><span class="bound">d2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">d1</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span>
   <span class="main">{</span><span class="main">(</span><span class="bound">d1</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">}</span>
   <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">*</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> reindex_product_bij <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">d1</span></span><span class="main">,</span> <span class="bound"><span class="bound">d2</span></span><span class="main">)</span> <span class="main">|</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span>
     <span class="free">f</span> <span class="main">(</span><span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="bound">d1</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span><span class="main">.</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">}</span><span class="main">.</span>
     <span class="free">f</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">d1</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span><span class="main">*</span>
       <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">d1</span><span class="main">,</span> <span class="bound">d2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">d1</span> <span class="main">*</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span> <span class="main">*</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">d</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">d1</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">d2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">d1</span></span></span><span class="main"><span class="main"><span class="main">*</span></span></span><span class="bound"><span class="bound"><span class="bound">d2</span></span></span>"</span></span></span></span> <span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>     
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d1</span></span> <span class="main">|</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d2</span></span> <span class="main">|</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span> 
                     <span class="free">f</span> <span class="main">(</span><span class="bound">d1</span><span class="main">*</span><span class="bound">d2</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">d1</span><span class="main">*</span><span class="bound">d2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.cartesian_product<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d1</span></span> <span class="main">|</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d2</span></span> <span class="main">|</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span> 
                      <span class="free">f</span> <span class="bound">d1</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">d1</span><span class="main">*</span><span class="bound">d2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>8<span class="main">)</span> multiplicative_function.mult_coprime
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d1</span></span> <span class="main">|</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d2</span></span> <span class="main">|</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span>
                      <span class="free">f</span> <span class="bound">d1</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">d2</span><span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="bound">d1</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">d1</span> <span class="skolem">d2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">d1</span> <span class="main">*</span> <span class="skolem">d2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="skolem">d1</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="skolem">d2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">,</span>9<span class="main">)</span> multipl_div
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> coprime_commute dvd_gcdD1 dvd_gcdD2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound">d1</span><span class="main">.</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="bound">d2</span><span class="main">.</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">}</span><span class="main">.</span>
                      <span class="free">f</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>   
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d1</span></span> <span class="main">|</span> <span class="bound">d1</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">d1</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="bound">d1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                      <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d2</span></span> <span class="main">|</span> <span class="bound">d2</span> <span class="keyword1">dvd</span> gcd <span class="free">k</span> <span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">d2</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_product<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> gen_ramanujan_sum_distrib_right<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="comment1">(* TODO: remove cond. on m,n *)</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">b</span> <span class="free">m</span>"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
         <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">g</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="main">1</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gen_ramanujan_sum_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="free">f</span> <span class="main">1</span> <span class="main">*</span> <span class="free">g</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gen_ramanujan_sum_1_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  assms<span class="main">(</span>5-6<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicative_function_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> gen_ramanujan_sum_distrib_left<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="comment1">(* TODO: remove cond. on m,n *)</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">k</span> <span class="free">m</span>"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
         <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">g</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="free">g</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gen_ramanujan_sum_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="free">f</span><span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span><span class="main">(</span><span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gen_ramanujan_sum_k_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span>  <span class="free">g</span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiplicative_function_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ramanujan_sum_distrib<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="comment1">(* TODO: remove cond. on m,n *)</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">b</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">k</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">c</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="keyword1">c</span> <span class="free">k</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">s</span> id moebius_mu <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ramanujan_sum_conv_gen_ramanujan_sum assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">s</span> id moebius_mu <span class="free">m</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">s</span> id moebius_mu <span class="free">k</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gen_ramanujan_sum_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted">id</span> <span class="quoted">moebius_mu</span><span class="main">]</span>
          assms mult_id mult_moebius mult_of_nat         
          coprime_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">c</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> <span class="keyword1">c</span> <span class="free">k</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ramanujan_sum_conv_gen_ramanujan_sum assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ramanujan_sum_distrib_right<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="comment1">(* remove cond. on m,n *)</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">b</span> <span class="free">m</span>"</span></span> 
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="free">m</span> <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">c</span> <span class="free">m</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ramanujan_sum_conv_gen_ramanujan_sum mult_id mult_moebius 
        mult_of_nat gen_ramanujan_sum_distrib_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> ramanujan_sum_distrib_left<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  <span class="comment1">(* remove cond. on m,n *)</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">k</span>"</span></span> 
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="keyword1">c</span> <span class="free">m</span> <span class="free">a</span> <span class="main">*</span> moebius_mu <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ramanujan_sum_conv_gen_ramanujan_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> gen_ramanujan_sum_distrib_left<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute mult_of_nat mult_moebius<span class="main">)</span>

<span class="keyword1" id="Ramanujan_Sums-dirichlet_prod_completely_multiplicative_left"><span class="command">lemma</span></span> dirichlet_prod_completely_multiplicative_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">k</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> dirichlet_prod <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="free">f</span>"</span></span> 
          <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">h</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="free">h</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">h</span> <span class="bound">p</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">h</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiplicative_function_divide
          comp_to_mult assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">k</span> <span class="main">=</span> dirichlet_prod <span class="free">g</span> <span class="free">f</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> F_def <span class="keyword1"><span class="command">using</span></span> dirichlet_prod_commutes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">d</span> <span class="main">*</span> <span class="free">f</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def dirichlet_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multipl_div_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">h</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_divisors_moebius_mu_times_multiplicative<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span>"</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> 1
          assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> F_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>prime_factors <span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.8›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gen_ramanujan_sum_dirichlet_expr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">k</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> dirichlet_prod <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> <span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="free">f</span>"</span></span> 
          <span class="quoted"><span class="quoted">"multiplicative_function <span class="free">h</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">f</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="free">h</span><span class="main">(</span><span class="bound">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≡</span> gcd <span class="free">n</span> <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">*</span><span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_def assms<span class="main">(</span>7<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> Ngr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">,</span>8<span class="main">)</span> 2 N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> f_k_not_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> completely_multiplicative_nonzero assms<span class="main">(</span>4<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f_N_not_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">N</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> completely_multiplicative_nonzero assms<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> Ngr0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_on_def <span class="quoted">"3"</span> dvd_div_eq_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> image_def 
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">}</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="free">f</span> <span class="free">g</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span>moebius_mu<span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">h</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_ramanujan_sum_def g_def a_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu<span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">h</span><span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu<span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="bound">d</span><span class="main">)</span><span class="main">*</span><span class="free">h</span><span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f_aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f_aux</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">f</span> <span class="bound">d</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">N</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">N</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">.</span> <span class="skolem">f_aux</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">*</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">N</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">.</span> <span class="skolem">f_aux</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> f_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> bij 1 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(div)</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">h</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> moebius_prod_not_coprime 3<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span>
      <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"moebius_mu <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> moebius_mu <span class="free">N</span> <span class="main">*</span> moebius_mu <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mult_moebius <span class="keyword1"><span class="command">unfolding</span></span> multiplicative_function_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> moebius_mu.mult_coprime<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span><span class="free">N</span><span class="main">*</span><span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="skolem">d</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> multiplicative_function_def 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> multiplicative_function.mult_coprime<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="free">N</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">(</span><span class="free">N</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span>
         moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="skolem">d</span> <span class="main">*</span> <span class="free">h</span> <span class="skolem">d</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> 1 2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="free">h</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> multipl_div_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>6-8<span class="main"><span class="main">)</span></span> 3 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">h</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
           moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="skolem">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">h</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> multiplicative_function_divide 
             comp_to_mult 
             assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">∧</span> coprime <span class="free">N</span> <span class="bound">d</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">h</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="skolem">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> sum_divisors_moebius_mu_times_multiplicative_revisited<span class="main">[</span>
         <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">h</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>         
           assms<span class="main">(</span>8<span class="main">)</span> Ngr0 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> moebius_mu<span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span><span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="main">*</span> 
     <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span>
     <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="skolem">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="free">N</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_div_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="skolem">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">h</span> <span class="bound">p</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> 
          prod <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">h</span> <span class="bound">p</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="free">N</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">h</span> <span class="bound">p</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">div</span>
                     prod <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">h</span> <span class="bound">p</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="free">N</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prod_div_sub<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"3"</span> Ngr0 dvd_prime_factors<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">standard</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈#</span> prime_factorization <span class="free">N</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_b<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_prime_factors_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">h</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="free">f</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p_b<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span>
     <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span>prime_factors <span class="skolem">a</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">h</span> <span class="bound">p</span> <span class="main">/</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span>
     <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">N</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> eq eq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> moebius_mu<span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span><span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">f</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">F</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">N</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span> prime_factors <span class="free">N</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F_def g_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dirichlet_prod_completely_multiplicative_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ngr0 assms<span class="main"><span class="main">(</span></span>4-6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span> prime_factors <span class="free">N</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="free">F</span> <span class="free">N</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 f_N_not_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">(</span><span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span> prime_factors <span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F_def g_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dirichlet_prod_completely_multiplicative_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4-7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span> prime_factors <span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
               <span class="free">F</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 f_k_not_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> 
           <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span> prime_factors <span class="free">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span>
           <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span> prime_factors <span class="free">N</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">h</span> <span class="bound">p</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">F</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">F</span> <span class="free">N</span> <span class="keyword1">div</span> <span class="free">f</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_1 eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">F</span> <span class="free">k</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">f</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">F</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">F</span> <span class="free">k</span> <span class="main">*</span> <span class="free">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">F</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">f</span> <span class="free">N</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="free">N</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">N</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> completely_multiplicative_function_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> 2 assms<span class="main">(</span>4<span class="main">)</span> completely_multiplicative_function_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> 
             Ngr0 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> moebius_mu <span class="free">N</span> <span class="main">*</span> <span class="free">h</span> <span class="free">N</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">F</span> <span class="free">k</span> <span class="main">*</span> <span class="free">f</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">F</span> <span class="free">N</span> <span class="main">*</span> <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="free">N</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">F</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="free">F</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_k_not_z g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">*</span><span class="free">g</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">F</span><span class="main">(</span><span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*TODO remove this and substitute 
 the theorem totient_conv_moebius_mu in More_totient by 
 this version: int → of_nat*)</span>
<span class="keyword1" id="Ramanujan_Sums-totient_conv_moebius_mu_of_nat"><span class="command">lemma</span></span> totient_conv_moebius_mu_of_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>totient <span class="free">n</span><span class="main">)</span> <span class="main">=</span> dirichlet_prod moebius_mu of_nat <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> moebius_inversion<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_sum <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> totient_divisor_sum <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_sum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">corollary</span></span> ramanujan_sum_k_n_dirichlet_expr<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> of_nat <span class="main">(</span>totient <span class="free">k</span><span class="main">)</span> <span class="main">*</span> 
                moebius_mu <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">div</span> 
                of_nat <span class="main">(</span>totient <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> of_nat"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> dirichlet_prod <span class="skolem">f</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex "</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> moebius_mu <span class="bound">l</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≡</span> <span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  
  <span class="keyword1"><span class="command">have</span></span> F_is_totient_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="free">k</span> <span class="main">=</span> totient <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def f_def dirichlet_prod_commutes totient_conv_moebius_mu_of_nat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F_is_totient_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">N</span> <span class="main">=</span> totient <span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def f_def dirichlet_prod_commutes totient_conv_moebius_mu_of_nat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">c</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="keyword1">s</span> id moebius_mu <span class="free">k</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ramanujan_sum_conv_gen_ramanujan_sum assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="keyword1">s</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="free">k</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> f_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">k</span> <span class="main">*</span> <span class="skolem">h</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff h_def g_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicative_function <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">s</span> <span class="skolem">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">k</span> <span class="main">*</span> <span class="skolem">h</span> <span class="bound">k</span><span class="main">)</span> <span class="free">k</span> <span class="free">n</span> <span class="main">=</span>
           dirichlet_prod of_nat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">k</span> <span class="main">*</span> <span class="skolem">h</span> <span class="bound">k</span><span class="main">)</span> <span class="free">k</span> <span class="main">*</span>
           <span class="main">(</span>moebius_mu <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">h</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
           dirichlet_prod of_nat <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="bound">k</span> <span class="main">*</span> <span class="skolem">h</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> assms mult_of_nat_c
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gen_ramanujan_sum_dirichlet_expr<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_nat <span class="main">(</span>totient <span class="free">k</span><span class="main">)</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="main">(</span>totient <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F_is_totient_k F_is_totient_N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def F_def N_def f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> ramanujan_sum <span class="main">(</span><span class="quoted">"<span class="keyword1">c</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> gen_ramanujan_sum <span class="main">(</span><span class="quoted">"<span class="keyword1">s</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Gauss_Sums">
<div class="head">
<h1>Theory Gauss_Sums</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Gauss_Sums.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM

  Gauss sums and more on Dirichlet characters: induced moduli, separability, primitive characters
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Gauss_Sums
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Algebra/Coset.html">HOL-Algebra.Coset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Real_Asymp/Real_Asymp.html">HOL-Real_Asymp.Real_Asymp</a>"</span>
  <a href="Ramanujan_Sums.html">Ramanujan_Sums</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Gauss sums›</span></span>

<span class="keyword1"><span class="command">bundle</span></span> vec_lambda_notation
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">notation</span></span> vec_lambda <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">χ</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">bundle</span></span> no_vec_lambda_notation
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> vec_lambda <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">χ</span>"</span> 10<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> no_vec_lambda_notation


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition and basic properties›</span></span>
<span class="keyword1"><span class="command">context</span></span> dcharacter
<span class="keyword2"><span class="keyword">begin</span></span>                            

<span class="comment1">(* TODO remove when integrating periodic and periodic_function *)</span>
<span class="keyword1" id="Gauss_Sums-dir_periodic_arithmetic"><span class="command">lemma</span></span> dir_periodic_arithmetic<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">χ</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> periodic<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gauss_sum</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gauss_Sums-gauss_sum_periodic"><span class="command">lemma</span></span> gauss_sum_periodic<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gauss_sum <span class="bound">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">χ</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dir_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="skolem">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="var">?h</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> scalar_mult_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="skolem">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> per_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> periodic_arithmetic <span class="main">(</span><span class="var">?h</span> <span class="bound">m</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fin_sum_periodic_arithmetic_set<span class="main">[</span><span class="operator">OF</span> per_all<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-ramanujan_sum_conv_gauss_sum"><span class="command">lemma</span></span> ramanujan_sum_conv_gauss_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ramanujan_sum <span class="free">n</span> <span class="free">k</span> <span class="main">=</span> gauss_sum <span class="free">k</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">from</span></span> assms  
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">χ</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="skolem">m</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">χ</span><span class="main">(</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> principal_dchar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">n</span> <span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ramanujan_sum <span class="free">n</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ramanujan_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-cnj_mult_self"><span class="command">lemma</span></span> cnj_mult_self<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="free">χ</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">χ</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="free">χ</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">χ</span> <span class="free">k</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">χ</span> <span class="free">k</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute complex_mult_cnj cmod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.9›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gauss_sum_reduction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">k</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="free">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> n_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">χ</span> <span class="free">k</span> <span class="main">*</span> <span class="free">χ</span> <span class="bound">r</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cnj_mult_self<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">χ</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span><span class="main">=</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span> <span class="bound">r</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">r</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="bound">r</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dir_periodic_arithmetic unity_periodic_arithmetic mult_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">n</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_remove_homothecy<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 1 n_pos<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> n<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following variant takes an integer argument instead.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gauss_sum_int</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> gauss_sum_int<span class="main">:</span> periodic_fun_simple <span class="quoted">gauss_sum_int</span> <span class="quoted"><span class="quoted">"int <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gauss_sum_int <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> int <span class="free">n</span><span class="main">)</span> <span class="main">=</span> gauss_sum_int <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gauss_sum_int_def ring_distribs unity_root_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-gauss_sum_int_cong"><span class="command">lemma</span></span> gauss_sum_int_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"gauss_sum_int <span class="free">a</span> <span class="main">=</span> gauss_sum_int <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> int <span class="free">n</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> cong_iff_lin<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gauss_sum_int.plus_of_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-gauss_sum_conv_gauss_sum_int"><span class="command">lemma</span></span> gauss_sum_conv_gauss_sum_int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">=</span> gauss_sum_int <span class="main">(</span>int <span class="free">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def gauss_sum_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums-gauss_sum_int_conv_gauss_sum"><span class="command">lemma</span></span> gauss_sum_int_conv_gauss_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gauss_sum_int <span class="free">k</span> <span class="main">=</span> gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gauss_sum_int <span class="main">(</span>int <span class="main">(</span>nat <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gauss_sum_conv_gauss_sum_int<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gauss_sum_int <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gauss_sum_int_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-gauss_int_periodic"><span class="command">lemma</span></span> gauss_int_periodic<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic gauss_sum_int <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> periodic_arithmetic_def gauss_sum_int_conv_gauss_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">proposition</span></span> dcharacter_fourier_expansion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">n</span> <span class="main">*</span> gauss_sum_int <span class="main">(</span><span class="main">-</span><span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> per<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">χ</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dir_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fourier_expansion_periodic_arithmetic<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ per<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> int <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> g_per<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="skolem">g</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fourier_expansion_periodic_arithmetic<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ per<span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fact_per<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> g_per<span class="main">]</span> unity_periodic_arithmetic_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> int <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> int <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> Suc <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> int <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">OF</span> fact_per<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span><span class="main">)</span> <span class="main">*</span> gauss_sum_int <span class="main">(</span><span class="main">-</span><span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">have</span></span> shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> per_unit<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prod_per<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> per mult_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">l</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">l</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">OF</span> prod_per<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="main">*</span> int <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> gauss_sum_int <span class="main">(</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_int_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> gauss_sum_int <span class="main">(</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">note</span></span> g_expr <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_expr<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Separability›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">separable</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> gauss_sum <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> gauss_coprime_separable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">k</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"separable <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> gauss_sum_reduction<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> separable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.10›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> global_separability_condition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> separable <span class="bound">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span>coprime <span class="bound">k</span> <span class="free">n</span> <span class="main">⟶</span> gauss_sum <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="skolem">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"separable <span class="skolem">k</span> <span class="main">⟷</span> gauss_sum <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> separable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">note</span></span> not_case <span class="main">=</span> this
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gauss_coprime_separable not_case separable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-of_real_moebius_mu"><span class="command">lemma</span></span> of_real_moebius_mu <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_real <span class="main">(</span>moebius_mu <span class="free">k</span><span class="main">)</span> <span class="main">=</span> moebius_mu <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> moebius_mu_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> principal_not_totally_separable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">.</span> separable <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> n_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> tot_0<span class="main">:</span> <span class="quoted"><span class="quoted">"totient <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"moebius_mu <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="free">n</span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> moeb_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> moebius_mu <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="bound">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">have</span></span> lem<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">k</span> <span class="main">=</span> totient <span class="free">n</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> totient <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">k</span> <span class="main">=</span> ramanujan_sum <span class="free">n</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ramanujan_sum_conv_gauss_sum<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> totient <span class="free">n</span> <span class="main">*</span> moebius_mu <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>totient <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ramanujan_sum_k_n_dirichlet_expr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> n_pos that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> lem<span class="main">[</span><span class="operator">OF</span> n_pos<span class="main">]</span> tot_0 moebius_mu_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> n_pos 2 3 <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span>coprime <span class="bound">k</span> <span class="free">n</span> <span class="main">∧</span> gauss_sum <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="skolem">k</span> <span class="free">n</span> <span class="main">∧</span> gauss_sum <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> right_not_zero <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="skolem">k</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> principal_dchar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
     <span class="keyword1"><span class="command">unfolding</span></span> separable_def <span class="keyword1"><span class="command">using</span></span> right_not_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.11›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gauss_sum_1_mod_square_eq_k<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> separable <span class="bound">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> real <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> gauss_sum <span class="main">1</span> <span class="main">*</span> cnj <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> complex_norm_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gauss_sum <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unity_root_uminus<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> gauss_sum <span class="main">1</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> gauss_sum <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>   
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="main">1</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
          gauss_sum <span class="skolem">x</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> separable_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> allE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> as <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">r</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> sum_distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">r</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="main">(</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unity_root_diff of_nat_diff unity_root_uminus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span>  <span class="free">χ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span>unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="main">(</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="main">(</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span> <span class="main">*</span> unity_root_sum <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unity_periodic_arithmetic_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">OF</span> 1 _<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root_sum <span class="free">n</span> <span class="main">(</span><span class="skolem">x</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">unfolding</span></span> unity_root_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  unity_root_sum <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="free">χ</span> <span class="skolem">x</span> <span class="main">*</span> unity_root_sum <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">r</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">r</span> <span class="main">*</span> unity_root_sum <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">using</span></span> n unity_root_sum_nonzero_iff int_ops<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">1</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> of_real_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.12›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> gauss_sum_nonzero_noncoprime_necessary_condition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≡</span> <span class="free">n</span> <span class="keyword1">div</span> gcd <span class="free">k</span> <span class="free">n</span>"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> div_dvd_iff_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">k</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">k</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_neq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">χ</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">k</span><span class="main">*</span><span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mult_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> dir_periodic_arithmetic unity_periodic_arithmetic_mult<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">χ</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">r</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">a</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_remove_homothecy<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> 1<span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong refl<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">b</span><span class="main">*</span><span class="free">d</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main">(</span>5<span class="main">)</span> cong_to_1'_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">*</span><span class="free">a</span><span class="main">*</span><span class="free">k</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="skolem">m</span><span class="main">*</span><span class="skolem">b</span><span class="main">*</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="free">k</span> <span class="free">n</span><span class="main">)</span><span class="main">*</span><span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="skolem">m</span><span class="main">*</span><span class="skolem">b</span><span class="main">*</span><span class="free">n</span><span class="main">*</span><span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> gcd <span class="free">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_mult_swap dvd_div_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="skolem">m</span><span class="main">*</span><span class="skolem">b</span><span class="main">*</span><span class="free">n</span><span class="main">*</span><span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">*</span><span class="free">a</span><span class="main">*</span><span class="free">k</span> <span class="main">=</span> <span class="skolem">m</span><span class="main">*</span><span class="free">k</span><span class="main">+</span><span class="skolem">m</span><span class="main">*</span><span class="skolem">b</span><span class="main">*</span><span class="skolem">p</span><span class="main">*</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">*</span><span class="free">a</span><span class="main">*</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">=</span> <span class="skolem">m</span><span class="main">*</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> mod_mult_self1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">a</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">a</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">a</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> zmod_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> zmod_int 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">a</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="free">χ</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">m</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> mult<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="free">χ</span><span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">χ</span><span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">=</span> <span class="free">χ</span><span class="main">(</span><span class="free">a</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Induced moduli and primitive characters›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_modulus</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Gauss_Sums-induced_modulus_dvd"><span class="command">lemma</span></span> induced_modulus_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span> <span class="main">⟹</span> <span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Gauss_Sums-induced_modulusI"><span class="command">lemma</span></span> induced_modulusI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> induced_modulus <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums-induced_modulusD"><span class="command">lemma</span></span> induced_modulusD<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span> <span class="main">⟹</span> coprime <span class="free">a</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Gauss_Sums-zero_not_ind_mod"><span class="command">lemma</span></span> zero_not_ind_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>induced_modulus <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Gauss_Sums-div_gcd_dvd1"><span class="command">lemma</span></span> div_gcd_dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_gcd<span class="main">)</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">b</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_def dvd_div_mult_self gcd_dvd1<span class="main">)</span>

<span class="keyword1" id="Gauss_Sums-div_gcd_dvd2"><span class="command">lemma</span></span> div_gcd_dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_gcd<span class="main">)</span> <span class="keyword1">div</span> gcd <span class="free">a</span> <span class="free">b</span> <span class="keyword1">dvd</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_gcd_dvd1 gcd.commute<span class="main">)</span>

<span class="keyword1" id="Gauss_Sums-g_non_zero_ind_mod"><span class="command">lemma</span></span> g_non_zero_ind_mod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="free">k</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"induced_modulus <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="free">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> gcd <span class="free">k</span> <span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_div_mult_self dvd_triv_left gcd.commute gcd_dvd1<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span> <span class="keyword1">div</span> gcd <span class="free">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms n gauss_sum_nonzero_noncoprime_necessary_condition<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-induced_modulus_modulus"><span class="command">lemma</span></span> induced_modulus_modulus<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">safe</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq_zero_iff zero_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.13›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> one_induced_iff_principal<span class="main">:</span>
 <span class="quoted"><span class="quoted">"induced_modulus <span class="main">1</span> <span class="main">⟷</span> <span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> principal_dchar_def <span class="keyword1"><span class="command">using</span></span> eq_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> principal_dchar_def as <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> primitive_dchar <span class="main">=</span> dcharacter <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_induced_modulus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> nonprimitive_dchar <span class="main">=</span> dcharacter <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> induced_modulus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> induced_modulus <span class="bound">d</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nonprimitive_dchar<span class="main">)</span> nonprimitive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> primitive_dchar <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"residue_mult_group <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">χ</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A.no_induced_modulus induced_modulus <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> primitive_dchar_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primitive_dchar <span class="free">n</span> <span class="free">χ</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_dchar_def primitive_dchar_axioms_def
  <span class="keyword1"><span class="command">using</span></span> dcharacter_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> residues_nat<span class="main">)</span> principal_not_primitive<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>primitive_dchar <span class="free">n</span> <span class="main">(</span>principal_dchar <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> principal.primitive_dchar_iff
  <span class="keyword1"><span class="command">using</span></span> principal.one_induced_iff_principal n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> not_primitive_imp_nonprimitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nonprimitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms dcharacter_axioms
  <span class="keyword1"><span class="command">unfolding</span></span> nonprimitive_dchar_def primitive_dchar_def
            primitive_dchar_axioms_def nonprimitive_dchar_axioms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.14›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> prime_nonprincipal_is_primitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">≠</span> principal_dchar <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="skolem">m</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms prime_nat_iff induced_modulus_def
          one_induced_iff_principal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> primitive_dchar_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.15›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> primitive_dchar<span class="main">)</span> primitive_encoding<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span>coprime <span class="bound">k</span> <span class="free">n</span> <span class="main">⟶</span> gauss_sum <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> separable <span class="bound">k</span>"</span></span>
  <span class="quoted"><span class="quoted">"norm <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>coprime <span class="skolem">k</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> gcd <span class="skolem">k</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> g_non_zero_ind_mod<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> gcd <span class="skolem">k</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> coprime_iff_gcd_eq_1 div_eq_dividend_iff le_less_trans
                linorder_neqE_nat nat_dvd_not_less principal.div_gcd_dvd2 zero_le_one<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> no_induced_modulus <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> separable <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> global_separability_condition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"separable <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gauss_sum_1_mod_square_eq_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.16›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> induced_modulus_altdef1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span> <span class="main">⟷</span>
     <span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">b</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">χ</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> induced_modulus_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">b</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span><span class="main">(</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">χ</span><span class="main">(</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">b</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">χ</span><span class="main">(</span><span class="skolem">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">a'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cong_solve <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">a'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cong_dvd_modulus_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">a'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eq cong_imp_coprime cong_sym coprime_divisors gcd_nat.refl one_dvd<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span><span class="main">*</span><span class="free">χ</span><span class="main">(</span><span class="skolem">a'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">a'</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">*</span><span class="skolem">a'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_scalar_right<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">*</span><span class="skolem">a'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>›</span></span> calculation cong_sym cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">b</span><span class="main">*</span><span class="skolem">a'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">b</span><span class="main">*</span><span class="skolem">a'</span><span class="main">)</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>2<span class="main">)</span> cong_imp_coprime<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 induced_modulus_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">b</span><span class="main">)</span><span class="main">*</span><span class="free">χ</span><span class="main">(</span><span class="skolem">a'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 3 4 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">χ</span><span class="main">(</span><span class="skolem">b</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> mult_cancel_left
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">a'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">b</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">χ</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="main">1</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coprime_1_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Exercise 8.4›</span></span>

<span class="keyword1" id="Gauss_Sums-induced_modulus_altdef2_lemma"><span class="command">lemma</span></span> induced_modulus_altdef2_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">a</span> <span class="free">d</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∏</span> <span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≡</span> <span class="free">a</span> <span class="main">+</span> <span class="free">q</span> <span class="main">*</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cong_add_lcancel_0_nat cong_mult_self_right<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> this assms 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span><span class="main">*</span><span class="free">d</span>"</span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_add_right_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">d</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span> prime_dvd_mult_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
      <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>  
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">∏</span> <span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_dvd_prod_iff<span class="main">[</span><span class="operator">OF</span> fin 4<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span> <span class="main">∧</span> prime <span class="skolem">x</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primes_dvd_imp_eq<span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> True c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> True assms <span class="quoted">"4"</span><span class="main">(</span>1<span class="main">)</span> coprime_def not_prime_unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">from</span></span> a1 a2 a3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
       <span class="keyword1"><span class="command">have</span></span> in_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False 4<span class="main">(</span>3<span class="main">)</span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">using</span></span> dvd_prodI<span class="main">[</span><span class="operator">OF</span> fin in_s <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">q</span><span class="main">*</span><span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>2<span class="main">)</span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_add_left_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> lem <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> coprime_iff_gcd_eq_1<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> 
     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
     <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> lem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> not_prime_1 <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">a</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> prime_prime_factor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lem <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.17›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The case <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>d = 1›</span></span></span></span> is exactly the case described in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> dcharacter.one_induced_iff_principal<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> induced_modulus_altdef2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Φ</span><span class="main">.</span> dcharacter <span class="free">d</span> <span class="bound">Φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">Φ</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> n_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> as_im<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">+</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span>
         <span class="main">0</span>
       <span class="keyword1">else</span> <span class="main">(</span>prod id <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="bound">k</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">*</span><span class="free">d</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">k</span> <span class="free">d</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> induced_modulus_altdef2_lemma<span class="main">[</span><span class="operator">OF</span> n_pos as<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> m_prop <span class="main">=</span> this
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> coprime <span class="bound">n</span> <span class="free">d</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">χ</span><span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> Φ_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> induced_modulus_altdef1 assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> as_im 
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> coprime <span class="bound">a</span> <span class="free">n</span> <span class="main">∧</span> coprime <span class="bound">b</span> <span class="free">n</span> <span class="main">∧</span> 
                 <span class="main">[</span><span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">χ</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">χ</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> Φ_periodic<span class="main">:</span>  <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">Φ</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="bound">a</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> gcd <span class="skolem">a</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="free">d</span><span class="main">)</span> <span class="free">d</span> <span class="main">=</span> coprime <span class="skolem">a</span> <span class="free">d</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> coprime_iff_gcd_eq_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">d</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> True cop <span class="keyword1"><span class="command">have</span></span> cop_ad<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="free">d</span><span class="main">)</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> m_prop<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">+</span><span class="free">d</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> cop_ad<span class="main">]</span> 
              m_prop<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span><span class="main">,</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> m_prop<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">+</span><span class="free">d</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> cop_ad<span class="main">]</span>
              m_prop<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 
      <span class="keyword1"><span class="command">from</span></span> b p1 p2 <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> Φ_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cop<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cop<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>  
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> Φ_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> totatives <span class="free">d</span> <span class="main">⟶</span>
          <span class="bound">b</span> <span class="main">∈</span> totatives <span class="free">d</span> <span class="main">⟶</span> <span class="skolem">Φ</span> <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="bound">a</span> <span class="main">*</span> <span class="skolem">Φ</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> totatives <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> totatives <span class="free">d</span>"</span></span>  
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ab<span class="main">)</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">d</span> <span class="main">∧</span> coprime <span class="skolem">b</span> <span class="free">d</span>"</span></span> <span class="main">|</span> 
             <span class="main">(</span>a<span class="main">)</span>  <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="skolem">b</span> <span class="free">d</span>"</span></span> <span class="main">|</span>
             <span class="main">(</span>b<span class="main">)</span>  <span class="quoted"><span class="quoted">"coprime <span class="skolem">b</span> <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="skolem">a</span> <span class="free">d</span>"</span></span> <span class="main">|</span>
             <span class="main">(</span>n<span class="main">)</span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="skolem">a</span> <span class="free">d</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="skolem">b</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Φ</span> <span class="skolem">b</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> ab 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_ab<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">b</span><span class="main">)</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">b</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span><span class="main"><span class="main">*</span></span><span class="skolem"><span class="skolem">b</span></span>"</span></span></span><span class="main">,</span> <span class="operator">OF</span> c_ab<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="free">n</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="skolem">b</span><span class="main">)</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">a</span></span>"</span></span></span><span class="main">,</span><span class="operator">OF</span> c_ab<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
              m_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">b</span></span>"</span></span></span><span class="main">,</span><span class="operator">OF</span> c_ab<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> p1s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">b</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> p1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">f</span><span class="main">(</span><span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span><span class="main">(</span><span class="skolem">b</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> p2<span class="main">(</span>1<span class="main">)</span> p2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_mult cong_sym<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> p2s<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">*</span><span class="skolem">f</span> <span class="skolem">b</span><span class="main">)</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p2<span class="main">(</span>2<span class="main">)</span> p2<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">f</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> p1s p2s p1<span class="main">(</span>2<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_ab<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Φ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> d_gr_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Φ</span><span class="main">.</span> dcharacter <span class="free">d</span> <span class="bound">Φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">Φ</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> conjI<span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dcharacter <span class="free">d</span> <span class="skolem">Φ</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> dcharacter_def residues_nat_def dcharacter_axioms_def 
      <span class="keyword1"><span class="command">using</span></span> d_gr_1 Φ_def f_def Φ_mult Φ_1 Φ_periodic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">n</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">k</span> <span class="free">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">k</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">χ</span><span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> m_prop<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹coprime <span class="skolem"><span class="skolem">k</span></span> <span class="free"><span class="free">d</span></span>›</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> principal_dchar_def <span class="quoted"><span class="quoted">‹coprime <span class="skolem">k</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹local.induced_modulus <span class="free">d</span>›</span></span> induced_modulus_altdef1 assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
                  True <span class="quoted"><span class="quoted">‹coprime <span class="skolem">k</span> <span class="free">d</span>›</span></span> m_prop<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eq_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>3<span class="main">)</span> principal_dchar_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>       
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>      
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">Φ</span><span class="main">.</span> dcharacter <span class="free">d</span> <span class="bound">Φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">Φ</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dcharacter <span class="free">d</span> <span class="skolem">Φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def    
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span><span class="operator">fact</span><span class="main"><span class="keyword3">,</span></span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">k</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> principal_dchar_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dcharacter.mod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">(</span><span class="main">1</span> <span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> dcharacter.mod <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dcharacter.Suc_0<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The conductor of a character›</span></span>

<span class="keyword1"><span class="command">context</span></span> dcharacter
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">conductor</span> <span class="main">=</span> Min <span class="main">{</span><span class="bound">d</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Gauss_Sums-conductor_fin"><span class="command">lemma</span></span> conductor_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">d</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-conductor_induced"><span class="command">lemma</span></span> conductor_induced<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus conductor"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> induced_modulus_modulus <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"induced_modulus conductor"</span></span>             
    <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> conductor_fin <span class="main">]</span> conductor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-conductor_le_iff"><span class="command">lemma</span></span> conductor_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="main">≤</span> <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">≤</span><span class="free">a</span><span class="main">.</span> induced_modulus <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conductor_def <span class="keyword1"><span class="command">using</span></span> conductor_fin induced_modulus_modulus <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Min_le_iff<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums-conductor_ge_iff"><span class="command">lemma</span></span> conductor_ge_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="main">≥</span> <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">d</span><span class="main">.</span> induced_modulus <span class="bound">d</span> <span class="main">⟶</span> <span class="bound">d</span> <span class="main">≥</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conductor_def <span class="keyword1"><span class="command">using</span></span> conductor_fin induced_modulus_modulus <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Min_ge_iff<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums-conductor_leI"><span class="command">lemma</span></span> conductor_leI<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="free">d</span> <span class="main">⟹</span> conductor <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> conductor_le_iff<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums-conductor_geI"><span class="command">lemma</span></span> conductor_geI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> induced_modulus <span class="bound">d</span> <span class="main">⟹</span> <span class="bound">d</span> <span class="main">≥</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> conductor <span class="main">≥</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> conductor_ge_iff<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Gauss_Sums-conductor_dvd"><span class="command">lemma</span></span> conductor_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conductor_induced <span class="keyword1"><span class="command">unfolding</span></span> induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Gauss_Sums-conductor_le_modulus"><span class="command">lemma</span></span> conductor_le_modulus<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conductor_dvd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_imp_le<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> n <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Gauss_Sums-conductor_gr_0"><span class="command">lemma</span></span> conductor_gr_0<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conductor_def <span class="keyword1"><span class="command">using</span></span> zero_not_ind_mod 
  <span class="keyword1"><span class="command">using</span></span> conductor_def conductor_induced neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Gauss_Sums-conductor_eq_1_iff_principal"><span class="command">lemma</span></span> conductor_eq_1_iff_principal<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"conductor <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"induced_modulus <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conductor_induced <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_induced_iff_principal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> im_1<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> one_induced_iff_principal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"conductor <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conductor <span class="main">≤</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> conductor_fin Min_le<span class="main">[</span><span class="operator">OF</span> conductor_fin<span class="main">,</span><span class="operator">simplified</span><span class="main">,</span><span class="operator">OF</span> im_1<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conductor_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> conductor_gr_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-conductor_principal"><span class="command">lemma</span></span> conductor_principal <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span> <span class="main">⟹</span> conductor <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> conductor_eq_1_iff_principal<span class="main">)</span>
  
<span class="keyword1" id="Gauss_Sums-nonprimitive_imp_conductor_less"><span class="command">lemma</span></span> nonprimitive_imp_conductor_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"conductor <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> primitive_dchar_iff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> d<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conductor <span class="main">≤</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conductor_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nonprimitive_dchar<span class="main">)</span> conductor_less_modulus<span class="main">:</span> <span class="quoted"><span class="quoted">"conductor <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nonprimitive_imp_conductor_less nonprimitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.18›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> primitive_principal_form<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">≠</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Φ</span><span class="main">.</span> primitive_dchar conductor <span class="bound">Φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Φ</span><span class="main">(</span><span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(*
    TODO: perhaps residues_nat should be relaxed to allow n = 1.
    Then we could remove the unnecessary precondition here.
    It makes no real difference though.
  *)</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> n_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> conductor"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> induced<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> conductor_induced <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d_not_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> one_induced_iff_principal assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> d_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conductor_gr_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> induced <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> Φ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"dcharacter <span class="skolem">d</span> <span class="skolem">Φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">Φ</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d_not_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> induced_modulus_altdef2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def conductor_dvd χ<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> phi_dchars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">∈</span> dcharacters <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Φ_def dcharacters_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">interpret</span></span> Φ<span class="main">:</span> dcharacter <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="quoted">"residue_mult_group <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="skolem">Φ</span></span>
    <span class="keyword1"><span class="command">using</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> Φ_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_dchar <span class="skolem">d</span> <span class="skolem">Φ</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive_dchar <span class="skolem">d</span> <span class="skolem">Φ</span>"</span></span>   
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">d</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">∧</span> Φ.induced_modulus <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Φ.induced_modulus_def Φ.primitive_dchar_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"induced_modulus <span class="skolem">q</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> mod_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">k</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">*</span><span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">Φ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> cop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms principal_dchar_def<span class="main">)</span>  
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> 1 mod_1 Φ.induced_modulus_def 
                <span class="quoted"><span class="quoted">‹induced_modulus <span class="skolem">d</span>›</span></span> cop induced_modulus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> induced_modulus_def <span class="quoted">"1"</span> <span class="quoted"><span class="quoted">‹induced_modulus <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
     
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≤</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conductor_leI<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>     

  <span class="keyword1"><span class="command">from</span></span> Φ_def Φ_prim d_def phi_dchars <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primitive_extension</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primitive_extension</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">Φ</span><span class="main">.</span> primitive_dchar conductor <span class="bound">Φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">Φ</span> <span class="bound">k</span> <span class="main">*</span> principal_dchar <span class="free">n</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonprincipal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">≠</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> primitive_primitive_extension<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_dchar conductor primitive_extension"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> principal_decomposition<span class="main">:</span>       <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">k</span> <span class="main">=</span> primitive_extension <span class="free">k</span> <span class="main">*</span> principal_dchar <span class="free">n</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> someI_ex<span class="main">[</span><span class="operator">OF</span> primitive_principal_form<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonprincipal<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> primitive_extension_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primitive_dchar conductor primitive_extension"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">k</span> <span class="main">=</span> primitive_extension <span class="free">k</span> <span class="main">*</span> principal_dchar <span class="free">n</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The connection between primitivity and separability›</span></span>

<span class="keyword1" id="Gauss_Sums-residue_mult_group_coset"><span class="command">lemma</span></span> residue_mult_group_coset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">G</span> <span class="free">H</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> residue_mult_group <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≡</span> residue_mult_group <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">∈</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">∈</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m2</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> h_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> residue_mult_group_def totatives_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> cos_expr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">#&gt;</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> RCOSETS_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> residue_mult_group_def totatives_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_solve_coprime_nat<span class="main">[</span><span class="operator">OF</span> cop<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">a'</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> cong_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">*</span><span class="skolem">a'</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">h</span><span class="main">∈</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">.</span> <span class="main">{</span><span class="bound">h</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">h</span><span class="main">∈</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">.</span> <span class="main">{</span><span class="bound">h</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_coset_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> cos_expr assms<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">h</span><span class="main">∈</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">h</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">h</span><span class="main">∈</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">h</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> residue_mult_group_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1'</span></span> <span class="skolem"><span class="skolem">m2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    m_expr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m1'</span><span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∧</span> <span class="skolem">m1'</span> <span class="main">∈</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m2'</span><span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∧</span> <span class="skolem">m2'</span> <span class="main">∈</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> eq_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">m1'</span><span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m_expr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m1'</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> euclidean_semiring_cancel_class.mod_mod_cancel assms<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m1'</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> m_expr<span class="main">(</span>1<span class="main">)</span> h_1 <span class="keyword1"><span class="command">unfolding</span></span> kernel_def assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">m2'</span><span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m_expr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m2'</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> euclidean_semiring_cancel_class.mod_mod_cancel assms<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m2'</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> m_expr<span class="main">(</span>2<span class="main">)</span> h_1 <span class="keyword1"><span class="command">unfolding</span></span> kernel_def assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> eq_1 eq_2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Gauss_Sums-residue_mult_group_kernel_partition"><span class="command">lemma</span></span> residue_mult_group_kernel_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">G</span> <span class="free">H</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> residue_mult_group <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≡</span> residue_mult_group <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">m</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="free">m</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span><span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span><span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> card <span class="free">b</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_imp_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> mn <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>›</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> n<span class="main">:</span> residues_nat <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">G</span></span>
    <span class="keyword1"><span class="command">using</span></span> mn <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> m<span class="main">:</span> residues_nat <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">H</span></span>
    <span class="keyword1"><span class="command">using</span></span> mn <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  
  <span class="keyword1"><span class="command">from</span></span> mn <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> carrier <span class="free">G</span> <span class="main">⊆</span> carrier <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> residue_mult_group_def totatives_def
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> coprime_common_divisor_nat <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> super_set<span class="main">:</span> <span class="quoted"><span class="quoted">"carrier <span class="free">H</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> carrier <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">k</span> <span class="free">m</span>"</span></span>             
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> residue_mult_group_def totatives_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mn <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">∈</span> carrier <span class="free">H</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totatives_less assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> residue_mult_group_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> prime_factors <span class="free">n</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">∏</span><span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def a_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factors <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="skolem">a</span> <span class="main">=</span> set_mset <span class="main">(</span>sum prime_factorization <span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">using</span></span> mn
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_factorization_prod<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def prime_factors_dvd prime_gt_0_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum prime_factorization <span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">{#</span><span class="bound">p</span><span class="main">#}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def prime_factorization_prime prime_factors_dvd<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> mn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">m</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> coprime_iff_prime_factors_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> binary_chinese_remainder_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>1<span class="main">)</span> mn k <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coprime_common_divisor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
      
    <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cong_imp_coprime cong_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">x</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k cong_imp_coprime<span class="main">[</span><span class="operator">OF</span> cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> coprime <span class="skolem">x</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mn
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> coprime_cong_prime_factors<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_product P_def in_prime_factors_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">∈</span> totatives <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> totatives_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>1<span class="main">)</span> k mn <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cong_def mod_mod_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> residue_mult_group_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> image_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> carrier <span class="free">G</span> <span class="main">=</span> carrier <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">k</span> <span class="main">⊗</span><span class="hidden">⇘</span><sub><span class="free">H</span></sub><span class="hidden">⇙</span> <span class="free">f</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">l</span>
    <span class="keyword1"><span class="command">using</span></span> that mn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> residue_mult_group_def totatives_def
                                 mod_mod_cancel mod_mult_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> group_hom <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">f</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>carrier <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def  
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f.FactGroup_inj_on <span class="keyword1"><span class="command">unfolding</span></span> FactGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> carrier <span class="free">G</span> <span class="main">=</span> carrier <span class="free">H</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> subset super_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> the_elem <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> carrier <span class="free">H</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f.FactGroup_onto<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> FactGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partition <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> carrier <span class="free">G</span> <span class="main">⟹</span>
         <span class="main">∃!</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> a_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
       <span class="comment1">(*exists*)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">∈</span> <span class="bound">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a_in n.rcosets_part_G<span class="main">[</span><span class="operator">OF</span> f.subgroup_kernel<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> group.rcos_disjoint<span class="main">[</span><span class="operator">OF</span> n.is_group f.subgroup_kernel<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>       
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">⊆</span> carrier <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n.rcosets_part_G f.subgroup_kernel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
   
  <span class="comment1">(* sizes *)</span>
  <span class="keyword1"><span class="command">have</span></span> lagr<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> group.lagrange_finite<span class="main">[</span><span class="operator">OF</span> n.is_group n.fin f.subgroup_kernel<span class="main">]</span> Coset.order_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">have</span></span> k_size<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> f.subgroup_kernel finite_subset n.subgroupE<span class="main">(</span>1<span class="main">)</span> n.subgroupE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> G_size<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n.order Coset.order_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> H_size<span class="main">:</span> <span class="quoted"><span class="quoted">" totient <span class="free">m</span> <span class="main">=</span> card <span class="main">(</span>carrier <span class="free">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n.order Coset.order_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>carrier <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> f.FactGroup_iso<span class="main">[</span><span class="operator">OF</span> image_eq<span class="main">]</span> card_image f.FactGroup_inj_on f.FactGroup_onto image_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="keyword1">div</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> FactGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="keyword1">div</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lagr k_size<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> totient <span class="free">n</span> <span class="keyword1">div</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"totient <span class="free">m</span> <span class="main">=</span> totient <span class="free">n</span> <span class="keyword1">div</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> totient_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">dvd</span> totient <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> lagr <span class="quoted"><span class="quoted">‹card <span class="main">(</span>carrier <span class="free">G</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">m</span> <span class="main">*</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">dvd</span> totient <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="free">m</span> <span class="main">=</span> totient <span class="free">m</span> <span class="main">*</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">div</span> totient <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹totient <span class="free">m</span> <span class="main">*</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nonzero_mult_div_cancel_left<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹totient <span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> H_size<span class="main">:</span> <span class="quoted"><span class="quoted">" totient <span class="free">m</span> <span class="main">=</span> card <span class="main">(</span>carrier <span class="free">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n.order Coset.order_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>carrier <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> f.FactGroup_iso<span class="main">[</span><span class="operator">OF</span> image_eq<span class="main">]</span> card_image f.FactGroup_inj_on f.FactGroup_onto image_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>carrier <span class="main">(</span><span class="free">G</span> <span class="keyword1">Mod</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> FactGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> totient <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">=</span> card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>›</span></span> f.subgroup_kernel n.card_rcosets_equal n.subgroupE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_size<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">assume</span></span> b_cos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="free">G</span></sub><span class="hidden">⇙</span> kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>kernel <span class="free">G</span> <span class="free">H</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> card <span class="free">b</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> group.card_rcosets_equal<span class="main">[</span><span class="operator">OF</span> n.is_group b_cos<span class="main">]</span> 
          f.subgroup_kernel subgroup.subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>    
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Gauss_Sums-primitive_iff_separable_lemma"><span class="command">lemma</span></span> primitive_iff_separable_lemma<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">Φ</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> primitive_dchar <span class="free">d</span> <span class="free">Φ</span>"</span></span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">d</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">d</span><span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> Φ<span class="main">:</span> primitive_dchar <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="quoted">"residue_mult_group <span class="free">d</span>"</span></span> <span class="quoted"><span class="free">Φ</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> residue_mult_group <span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> residue_mult_group <span class="free">d</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">mod</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
  
  <span class="keyword1"><span class="command">from</span></span> residue_mult_group_kernel_partition<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fin_cosets<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>         
   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">d</span>›</span></span> card.infinite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G_def H_def f_def<span class="main">)</span>
          
  <span class="keyword1"><span class="command">have</span></span> fin_G<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>carrier <span class="skolem">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G_def residue_mult_group_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> carrier <span class="skolem">G</span> <span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> residue_mult_group_def totatives_def G_def
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>carrier <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> disjoint_sum <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> fin_G fin_cosets residue_mult_group_kernel_partition<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
          <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> G_def H_def f_def›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∑</span><span class="bound">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">(</span><span class="main">∑</span><span class="bound">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="bound">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> eq eq' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eq'''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> b_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> b_not_empty <span class="main">=</span> residue_mult_group_kernel_partition<span class="main">(</span>4<span class="main">)</span>
                         <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span> b_in<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> G_def H_def f_def<span class="main"><span class="main">]</span></span><span class="main">]</span> 
  
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m1</span> <span class="skolem">m2</span>
      <span class="keyword3"><span class="command">assume</span></span> m_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> m_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="keyword1">mod</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">m2</span> <span class="keyword1">mod</span> <span class="free">d</span>"</span></span>   
        <span class="keyword1"><span class="command">using</span></span> residue_mult_group_coset<span class="main">[</span><span class="operator">OF</span> b_in<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> G_def H_def f_def<span class="main"><span class="main">]</span></span> m_in <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> m_mod <span class="main">=</span> this
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m1</span> <span class="skolem">m2</span>
      <span class="keyword3"><span class="command">assume</span></span> m_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">∈</span> <span class="skolem">b</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="skolem">m1</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">m1</span><span class="main">)</span> <span class="main">=</span> <span class="free">Φ</span> <span class="skolem">m2</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">m2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> Φ_periodic<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">Φ</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Φ.dir_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="skolem">m1</span> <span class="main">=</span> <span class="free">Φ</span> <span class="skolem">m2</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> mod_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹periodic_arithmetic <span class="free">Φ</span> <span class="free">d</span>›</span></span> m_mod<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_in<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
       <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"unity_root <span class="free">d</span> <span class="skolem">m1</span> <span class="main">=</span> unity_root <span class="free">d</span> <span class="skolem">m2</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> m_mod<span class="main">[</span><span class="operator">OF</span> m_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> unity_root_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zmod_int<span class="main">)</span>
       <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> all_eq_in_coset <span class="main">=</span> this   
   
    <span class="keyword1"><span class="command">from</span></span> all_eq_in_coset b_not_empty 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">b</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">y</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> 
                                <span class="free">Φ</span> <span class="skolem">l</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="skolem">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Φ</span> <span class="skolem">l</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="skolem">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="skolem">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="skolem">l</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>              
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> all_eq_in_coset l_prop <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="skolem">b</span> <span class="main">*</span> <span class="free">Φ</span> <span class="skolem">l</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">Φ</span> <span class="skolem">l</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> residue_mult_group_kernel_partition<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span><span class="main">]</span> 
              residue_mult_group_kernel_partition<span class="main">(</span>5<span class="main">)</span>
                <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span> b_in <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> G_def H_def f_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="skolem">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
         <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">Φ</span> <span class="skolem">l</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> b_not_empty 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> foral<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">b</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> m_mod l_prop <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> the_elem_image_unique<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">,</span> <span class="operator">OF</span> b_not_empty foral<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> per<span class="main">:</span> <span class="quoted"><span class="quoted">"periodic_arithmetic <span class="free">Φ</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod Φ.dir_periodic_arithmetic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">using</span></span> mod_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> per<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="keyword1">mod</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def unity_root_mod zmod_int<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">∈</span> <span class="skolem">b</span><span class="main">.</span> <span class="free">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 <span class="main">(</span><span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">b</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">rcosets</span><span class="hidden">⇘</span><sub><span class="skolem">G</span></sub><span class="hidden">⇙</span> kernel <span class="skolem">G</span> <span class="skolem">H</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span>the_elem <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> eq''<span class="main">:</span> <span class="quoted"><span class="quoted">"
     <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">h</span> <span class="main">∈</span> carrier <span class="skolem">H</span> <span class="main">.</span> <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span><span class="bound">h</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H_def G_def f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> residue_mult_group_kernel_partition<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">k</span><span class="main">.</span> <span class="free">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> 
                  <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">h</span> <span class="main">∈</span> carrier <span class="skolem">H</span> <span class="main">.</span>  <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span><span class="bound">h</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">h</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq'' eq''' sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>totient <span class="free">k</span> <span class="keyword1">div</span> totient <span class="free">d</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">d</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">d</span> <span class="main">.</span> <span class="main">(</span><span class="free">Φ</span> <span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">d</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> H_def residue_mult_group_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totatives_def Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 8.19›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> primitive_iff_separable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primitive_dchar <span class="free">n</span> <span class="free">χ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> separable <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> principal_not_primitive principal_not_totally_separable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">note</span></span> nonprincipal <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> primitive_dchar <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"residue_mult_group <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">χ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> separable <span class="bound">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> n A.primitive_encoding<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> tot_separable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> separable <span class="bound">k</span>"</span></span> 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="bound">r</span> <span class="free">n</span> <span class="main">∧</span> gauss_sum <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> conductor"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> conductor_gr_0 <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonprincipal d_def conductor_eq_1_iff_principal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> nonprimitive_imp_conductor_less<span class="main">[</span><span class="operator">OF</span> as<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> conductor_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> dvd_div_gt0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">r</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> r_def 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gcd_nat.absorb1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> gcd <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="skolem">r</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> principal_dchar <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> primitive_principal_form<span class="main">[</span><span class="operator">OF</span> nonprincipal<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
           prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">k</span><span class="main">)</span><span class="main">*</span><span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> primitive_dchar <span class="skolem">d</span> <span class="skolem">Φ</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> d_def <span class="keyword1"><span class="command">unfolding</span></span> χ<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prod1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">k</span><span class="main">)</span><span class="main">*</span><span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"primitive_dchar <span class="skolem">d</span> <span class="skolem">Φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> Φ<span class="main">:</span> primitive_dchar <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="quoted">"residue_mult_group <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="skolem">Φ</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">r</span>  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">*</span><span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod<span class="main">)</span> 
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">*</span><span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> χ<span class="hidden">⇩</span><sub>1</sub>_def principal_dchar_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">*</span><span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">m</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> coprime <span class="bound">m</span> <span class="free">n</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="skolem">d</span> <span class="main">(</span>int <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> unity_div_num<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> r_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                     <span class="skolem">Φ</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">χ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="main">(</span>int <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">n</span><span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> χ<span class="hidden">⇩</span><sub>1</sub>_def principal_dchar_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="skolem">d</span><span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> primitive_iff_separable_lemma<span class="main">[</span><span class="operator">OF</span> prod <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> Φ.gauss_sum <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ.gauss_sum <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">d</span> <span class="main">.</span> <span class="skolem">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="main">(</span>int <span class="main">(</span><span class="bound">m</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Φ.gauss_sum_def<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">.</span> <span class="skolem">Φ</span> <span class="bound">m</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="main">(</span>int <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="skolem">d</span><span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Φ.eq_zero <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ.gauss_sum <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">d</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="skolem">d</span><span class="main">.</span> <span class="skolem">Φ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="skolem">d</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> g_expr<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span>totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> Φ.gauss_sum <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> t_non_0<span class="main">:</span> <span class="quoted"><span class="quoted">"totient <span class="free">n</span> <span class="keyword1">div</span> totient <span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> dvd_div_gt0 totient_dvd<span class="main">)</span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="main">(</span>Φ.gauss_sum <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Φ.primitive_encoding<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ.gauss_sum <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_sum <span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> g_expr t_non_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> 0 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="bound">r</span> <span class="free">n</span> <span class="main">∧</span> gauss_sum <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> contr <span class="main">=</span> this
   
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive_dchar <span class="free">n</span> <span class="free">χ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span> coprime <span class="skolem">r</span> <span class="free">n</span> <span class="main">∧</span> gauss_sum <span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> contr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> global_separability_condition tot_separable 
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">¬</span> coprime <span class="bound">k</span> <span class="free">n</span> <span class="main">⟶</span> gauss_sum <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Theorem 8.20›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> primitive_dchar<span class="main">)</span> fourier_primitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> no_vec_lambda_notation
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">τ</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≡</span> gauss_sum <span class="main">1</span> <span class="main">/</span> sqrt <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">m</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">/</span> sqrt <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="free">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"norm <span class="free">τ</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> chi_not_principal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">≠</span> principal_dchar <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> principal_not_totally_separable primitive_encoding<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> case_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">χ</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> periodic_arithmetic_sum_periodic_arithmetic_shift<span class="main">[</span><span class="operator">OF</span> dir_periodic_arithmetic<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> n
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">.</span> <span class="free">χ</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_dcharacter_block chi_not_principal <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">m</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> gauss_sum_int <span class="main">(</span><span class="main">-</span> int <span class="bound">k</span><span class="main">)</span> <span class="main">*</span>
      unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dcharacter_fourier_expansion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
      unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gauss_sum_int_conv_gauss_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> mp<span class="main">[</span><span class="operator">OF</span> spec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> primitive_encoding<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> True<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> separable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nat_0<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gauss_sum <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> nat_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> gauss_sum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> case_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nat_0 zero_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> gauss_sum <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> 
                    gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span>int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>   
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unity_root_mod_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">*</span><span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_mod_as_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> unity_root_cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def mod_mult_right_eq <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> zmod_int of_nat_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                 gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span>
                 unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_mod_as_int<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> nat<span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="bound">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">-</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">-</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n eq_nat_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">-</span>int <span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span> int <span class="skolem">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_int_iff cong_minus_minus_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cong a1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1<span class="main">(</span>1<span class="main">)</span> local.cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> image_def 
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_le_iff of_nat_diff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊇</span> <span class="var">?B</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span>int <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_ops<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> conjI<span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> 1 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
        gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span>int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
        gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_right_eq zmod_int<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_minus_eq of_nat_mod<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> mod_mult_right_eq<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> add.inverse_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> add.inverse_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> minus_mult_minus<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> mod_mult_right_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span>"</span></span><span class="main">]</span> 
                 unity_root_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">" <span class="main">-</span> <span class="main">(</span>int <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
         gauss_sum <span class="main">1</span> <span class="main">*</span>
         unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span>int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
         gauss_sum <span class="main">1</span> <span class="main">*</span>
         unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span><span class="main">-</span> int <span class="skolem">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
          gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span><span class="main">-</span> int <span class="bound">x</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">md</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">md</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span>
          unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">md</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> sum.reindex_bij_betw<span class="main">[</span><span class="operator">OF</span> b<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">md</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">md</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">md</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
        <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span>
        unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
        gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> nat <span class="main">(</span>int <span class="bound">k</span> <span class="keyword1">mod</span> int <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span>
        <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span>
        unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span>
         <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span>
         unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> zero_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> zero_eq_0 mod_periodic_arithmetic<span class="main">[</span><span class="operator">OF</span> dir_periodic_arithmetic<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_shift_lb_Suc0_0<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.mono_neutral_left<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">τ</span> <span class="main">/</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span>  <span class="main">*</span> gauss_sum <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">=</span> gauss_sum <span class="main">1</span> <span class="main">/</span> sqrt <span class="free">n</span> <span class="main">/</span> sqrt <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gauss_sum <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>sqrt <span class="free">n</span> <span class="main">*</span> sqrt <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> divide_divide_eq_left<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> of_real_mult<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gauss_sum <span class="main">1</span> <span class="main">/</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> real_sqrt_mult_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> 
     <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> of_nat <span class="free">n</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> gauss_sum <span class="main">1</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="free">τ</span> <span class="main">/</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">*</span> 
         <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">*</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span>  unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">τ</span> <span class="main">/</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="free">m</span> <span class="main">*</span> int <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sqrt <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gauss_sum_1_mod_square_eq_k<span class="main">[</span><span class="operator">OF</span> primitive_encoding<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cmod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="free">τ</span> <span class="main">=</span> norm <span class="main">(</span>gauss_sum <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">¦</span>sqrt <span class="free">n</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_divide<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">τ</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> vec_lambda_notation

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Polya_Vinogradov">
<div class="head">
<h1>Theory Polya_Vinogradov</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Polya_Vinogradov.thy
  Authors:  Rodrigo Raya, EPFL; Manuel Eberl, TUM

  The Pólya–Vinogradov inequality, both the general case and the stronger variant for
  primitive characters.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Pólya--Vinogradov Inequality›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Polya_Vinogradov
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Gauss_Sums.html">Gauss_Sums</a>
  <span class="quoted">"<a href="../Dirichlet_Series/Divisor_Count.html">Dirichlet_Series.Divisor_Count</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> no_vec_lambda_notation

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The case of primitive characters›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We first prove a stronger variant of the Pólya--Vinogradov inequality for primitive characters.
  The fully general variant will then simply be a corollary of this. First, we need some bounds on
  logarithms, exponentials, and the harmonic numbers:
›</span></span>

<span class="comment1">(* TODO: Move? *)</span>
<span class="keyword1" id="Polya_Vinogradov-ln_add_one_self_less_self"><span class="command">lemma</span></span> ln_add_one_self_less_self<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"exp <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">+</span><span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> exp <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_lower_Taylor_quadratic<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">&lt;</span> exp <span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> ln <span class="main">(</span>exp <span class="main">(</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ln_less_cancel_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span><span class="main">+</span><span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹exp<span class="main">(</span><span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Polya_Vinogradov-exp_1_bounds"><span class="command">lemma</span></span> exp_1_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_add_one_self_less_self assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> powr_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_neg_imp_decreasing_at_top<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="keyword1">has_field_derivative</span> <span class="main">(</span>ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ln_add_one_self_less_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> t assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">(</span><span class="bound">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">real_asymp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Polya_Vinogradov-harm_aux_ineq_1"><span class="command">lemma</span></span> harm_aux_ineq_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">k</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>   
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">-</span><span class="main">1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> exp_1_bounds<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span><span class="main">-</span><span class="main">1</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms not_exp_less_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span>exp<span class="main">(</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln_exp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_less_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"exp<span class="main">(</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">,</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span>
          exp_1_bounds<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">k</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">&gt;</span></span> <span class="main"><span class="main">0</span></span>›</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ln_powr n_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Polya_Vinogradov-harm_aux_ineq_2_lemma"><span class="command">lemma</span></span> harm_aux_ineq_2_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="numeral">2</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_neg_imp_decreasing_at_top<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">^</span><span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_pos_nonneg<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="keyword1">has_field_derivative</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> assms t *<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> refl <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pos_pos<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">t</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_neg_pos mult_pos_pos add_pos_nonneg<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="var">?f</span> <span class="keyword1">has_real_derivative</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">real_asymp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="numeral">2</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Polya_Vinogradov-harm_aux_ineq_2"><span class="command">lemma</span></span> harm_aux_ineq_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> harm_aux_ineq_2_lemma assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span> add_pos_pos mult.commute mult_imp_div_pos_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Polya_Vinogradov-nat_0_1_induct"><span class="command">lemma</span></span> nat_0_1_induct <span class="main">[</span><span class="operator">case_names</span> 0 1 step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ less.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_nat_numeral le_Suc_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Polya_Vinogradov-harm_less_ln"><span class="command">lemma</span></span> harm_less_ln<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"harm <span class="free">m</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_0_1_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> harm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="main">1</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹harm <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>›</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> ln3_gt_1<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> harm <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> Suc_eq_plus1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> harm_Suc<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> inverse_eq_divide<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> ln <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> ln <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="numeral">2</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> harm_aux_ineq_2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span>›</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="numeral">2</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ln_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">+</span><span class="numeral">2</span><span class="main">/</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* END TODO *)</span>
  

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Theorem 8.21›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> primitive_dchar<span class="main">)</span> polya_vinogradov_inequality_primitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> sqrt <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> gauss_sum <span class="main">1</span> <span class="keyword1">div</span> sqrt <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> τ_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">τ</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fourier_primitive<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> τ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="skolem">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fourier_primitive<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> τ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> chi_expr <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> chi_expr <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span>  <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span> <span class="keyword1">div</span> sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">τ</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> norm<span class="main">(</span><span class="skolem">τ</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span>sqrt <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">(</span>sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="main">(</span>sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_mult τ_mod<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> norm_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">(</span><span class="main">∑</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sum_aux</span></span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sum_aux</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">m</span> <span class="main">*</span> int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sum_aux</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm_le_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">sum_aux</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">sum_aux</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sum_aux</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_le_one_le<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" norm <span class="main">(</span>cnj <span class="main">(</span><span class="free">χ</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
           norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">m</span> <span class="main">*</span> int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>
           <span class="main">≤</span> norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">m</span> <span class="main">*</span> int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> sum_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm<span class="main">(</span><span class="skolem">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sqrt <span class="free">n</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span><span class="main">(</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm<span class="main">(</span><span class="skolem">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">int</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> cnj<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="bound">m</span><span class="main">*</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="bound">m</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> int <span class="skolem">xa</span> <span class="main">-</span> int <span class="free">n</span> <span class="main">*</span> int <span class="skolem">xa</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> int <span class="skolem">xa</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mod_diff_cong<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span>int <span class="skolem">xa</span> <span class="main">*</span> <span class="main">(</span>int <span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="skolem">xa</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ring_distribs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> unity_root_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cnj<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cnj <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">m</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cnj <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">m</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> cnj<span class="main">(</span>unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span> int <span class="bound">m</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cnj_sum<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> unity_root <span class="free">n</span> <span class="main">(</span>int <span class="bound">m</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unity_root_uminus<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> cnj<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> norm<span class="main">(</span>cnj<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> eq <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> 25<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"odd <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                    <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"even <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                    <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>  <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> n 
        <span class="keyword1"><span class="command">using</span></span> div_mult_self1_is_m<span class="main">[</span><span class="operator">OF</span> pos2<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main">]</span> 
              odd_two_times_div_two_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">∪</span><span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> g_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> eq int_ops<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">∪</span> <span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> g_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> eq int_ops<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    
    <span class="comment1">(* expression for each f(n) *)</span>
    <span class="keyword1"><span class="command">{</span></span><span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> unity_root <span class="free">n</span> <span class="main">(</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> exp <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> z_def <span class="keyword1"><span class="command">using</span></span> exp_double<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> y_def unity_root_conv_exp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> z_not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> z_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> unity_root_eq_1_iff_int <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>›</span></span> not_less
            unity_root_eq_1_iff_int y_def zdvd_not_zless <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">x</span> <span class="main">.</span> <span class="skolem">y</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> f_def y_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> unity_root_pow<span class="main"><span class="keyword3">,</span></span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">+</span><span class="main">1</span> <span class="main">.</span> <span class="skolem">y</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">x</span><span class="main">+</span><span class="main">1</span> <span class="main">.</span> <span class="skolem">y</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.atLeast_Suc_lessThan<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> geometric_sum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="main">1</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeast0LessThan<span class="main">)</span>   
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> divide_diff_eq_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span><span class="main">^</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">^</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> z_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span></span></span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">^</span><span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_not_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>36<span class="main"><span class="main">)</span></span> right_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span><span class="main">^</span><span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span>  right_diff_distrib'<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">*</span><span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib' semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span> right_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span> <span class="main">/</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span> <span class="main">/</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span> <span class="main">*</span> inverse <span class="skolem">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_eq_divide<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square right_inverse<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
            <span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">*</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span><span class="main">*</span><span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> 1<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> 2<span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  <span class="main">(</span><span class="skolem">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span> <span class="main">/</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> 3<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span><span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="comment1">(* inequality for each f(k) *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> norm<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> norm<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> norm_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">^</span><span class="free">x</span> <span class="main">-</span>inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> inverse<span class="main">(</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> norm_power<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹norm<span class="main">(</span><span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm<span class="main">(</span><span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> 
                     <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">^</span> <span class="free">x</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> z_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> exp_of_nat_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span><span class="skolem">z</span> <span class="main">^</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> inverse <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">^</span> <span class="free">x</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_minus<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse<span class="main">(</span><span class="skolem">z</span><span class="main">^</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">z</span> <span class="main">=</span> exp <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exp_minus z_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">*</span> sin<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> cos<span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> cos<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Euler Im_complex_of_real Im_divide_of_nat Im_i_times Re_complex_of_real
                complex_Re_of_int complex_i_mult_minus exp_zero mult.assoc mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span>cos<span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
              <span class="main">(</span>cos<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">*</span> sin<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword1"><span class="command">qed</span></span>
    
      <span class="keyword1"><span class="command">have</span></span> den<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">*</span> sin<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> cos<span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">=</span> cos<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Euler Im_complex_of_real Im_divide_of_nat Im_i_times Re_complex_of_real 
                complex_Re_of_int complex_i_mult_minus exp_zero mult.assoc mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span>cos<span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
              <span class="main">(</span>cos<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> sin<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">*</span> sin<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
      <span class="keyword1"><span class="command">qed</span></span> 
    
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> 
                     <span class="main">(</span>exp <span class="main">(</span><span class="main">-</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">-</span> exp <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            norm<span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">*</span> sin<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="main">-</span><span class="numeral">2</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">*</span> sin<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> num den <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm<span class="main">(</span>sin<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> sin<span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_divide<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">div</span> norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>sin <span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>   
        <span class="keyword1"><span class="command">using</span></span> divide_right_mono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹norm <span class="main">(</span>sin <span class="main">(</span><span class="free">x</span><span class="main">*</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 26<span class="main">:</span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">div</span> norm<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="comment1">(* inequality with sin *)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> pi <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"convex_on <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>sin <span class="bound">x</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> convex_on_realI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> cos <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cos_monotone_0_pi_le<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> convex_onD_Icc'<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sin<span class="main">(</span><span class="skolem">t</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">div</span> pi<span class="main">)</span><span class="main">*</span><span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> sin_ineq <span class="main">=</span> this
    
    <span class="keyword1"><span class="command">have</span></span> sin_ineq_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"sin <span class="main">(</span><span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pi <span class="main">/</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span> <span class="main">=</span> <span class="main">(</span>pi <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>pi <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> mult_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"pi <span class="main">/</span> <span class="free">n</span>"</span></span><span class="main">]</span> 
              <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> pi <span class="main">/</span> real <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> pi <span class="main">/</span> <span class="numeral">2</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>     
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span> <span class="main">≤</span> pi <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> pi<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>pi <span class="main">*</span> <span class="skolem">k</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> sin<span class="main">(</span><span class="main">(</span>pi <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sin_ineq<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sin<span class="main">(</span><span class="main">(</span>pi <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> 26 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">div</span> abs<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> abs<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sin_ineq_inst <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> abs<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="keyword1">div</span> abs<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> abs<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹abs<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹abs<span class="main">(</span><span class="main">(</span>sin <span class="main">(</span>pi<span class="main">*</span><span class="skolem">k</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> abs<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span><span class="main">/</span><span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frac_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≥</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> ineq <span class="main">=</span> this

  <span class="comment1">(* inequality for the odd and even case*)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span> <span class="main">*</span> norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ineq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>›</span></span><span class="main">]</span> True n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> 24 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span> <span class="main">*</span> norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> 
               <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 25<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span>  real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> real <span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> int <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ineq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> int <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹int <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">(</span>real <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>real <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_distrib_left<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> 
                  <span class="main">(</span>real <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> norm<span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> harm_def inverse_eq_divide <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>   
      <span class="keyword3"><span class="command">case</span></span> True 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> harm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">4</span> <span class="main">/</span> <span class="numeral">3</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span> ln2_ge_two_thirds <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>                
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> ln <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> harm_less_ln <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹even <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>      
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">&lt;</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">1</span> <span class="main">/</span> real <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_left_mono harm_aux_ineq_1<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>         
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span> ln <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹real <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span>          
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> 24 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span> <span class="main">*</span> norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 25<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> real <span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> int <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ineq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> int <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹int <span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_distrib_left<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>int <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> 
                  <span class="main">(</span>real <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">*</span> harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> harm_def inverse_eq_divide <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"harm <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> ln <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> harm_less_ln <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span> <span class="main">*</span> norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> sqrt <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> sqrt <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span><span class="main">)</span> <span class="main">/</span> sqrt <span class="free">n</span> <span class="main">=</span> sqrt <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> sqrt <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mult_imp_less_div_pos<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹sqrt <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> 2<span class="main">]</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General case›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now first prove the inequality for the general case in terms of the divisor function:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> polya_vinogradov_inequality_explicit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonprincipal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">≠</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> sqrt conductor <span class="main">*</span> ln conductor <span class="main">*</span> divisor_count <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> conductor<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">write</span></span> primitive_extension <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">Φ</span></span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">write</span></span> conductor <span class="main">(</span><span class="quoted">"<span class="keyword1">c</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> Φ<span class="main">:</span> primitive_dchar <span class="quoted"><span class="keyword1">c</span></span> <span class="quoted"><span class="quoted">"residue_mult_group <span class="keyword1">c</span>"</span></span> <span class="quoted">primitive_extension</span>
    <span class="keyword1"><span class="command">using</span></span> primitive_primitive_extension nonprincipal <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="skolem">b</span> <span class="main">⟷</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> that antisym_conv div_le_mono div_mult_self1_is_m
              less_imp_le not_less times_div_less_eq_dividend<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">using</span></span> n that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nonprincipal <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">m</span></span> <span class="main">|</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">∧</span> coprime <span class="bound">m</span> <span class="free">n</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_zero_iff principal_decomposition<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">m</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">m</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_moebius_mu_divisors'<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> sum.mono_neutral_cong_left<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_iff_gcd_eq_1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> coprime_imp_gcd_eq_1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> gcd <span class="bound">m</span> <span class="free">n</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">m</span> <span class="main">*</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">m</span> <span class="main">*</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">m</span><span class="main">:</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">m</span> <span class="main">*</span> moebius_mu <span class="bound">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Sigma<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">d</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">d</span><span class="main">:</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="keyword1">Φ</span> <span class="main">(</span><span class="bound">d</span> <span class="main">*</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">d</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">q</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">d</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">q</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">d</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">m</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="bound"><span class="bound"><span class="bound">d</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">d</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">m</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">div</span></span></span> <span class="bound"><span class="bound"><span class="bound">d</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * ** Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="keyword1">Φ</span> <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">q</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Sigma <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_distrib_left mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≤</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> norm <span class="main">(</span>moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="keyword1">Φ</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> norm <span class="main">(</span><span class="main">∑</span><span class="bound">q</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">.</span> <span class="keyword1">Φ</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_norm_le<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> norm <span class="main">(</span>moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="keyword1">Φ</span> <span class="bound">d</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="keyword1">c</span> <span class="main">*</span> ln <span class="keyword1">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?lhs</span> <span class="main">_</span> <span class="main">&lt;</span> sum <span class="var">?rhs</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_strict_mono_ex1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?lhs</span> <span class="bound">d</span> <span class="main">≤</span> <span class="var">?rhs</span> <span class="bound">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ballI mult_left_mono less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Φ.polya_vinogradov_inequality_primitive<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">∈</span><span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="var">?lhs</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="var">?rhs</span> <span class="bound">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> mult_strict_left_mono Φ.polya_vinogradov_inequality_primitive<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> n <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sqrt <span class="keyword1">c</span> <span class="main">*</span> ln <span class="keyword1">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> norm <span class="main">(</span>moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="keyword1">Φ</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left sum_distrib_right mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">.</span> norm <span class="main">(</span>moebius_mu <span class="bound">d</span> <span class="main">*</span> <span class="keyword1">Φ</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> squarefree <span class="bound">d</span> <span class="main">∧</span> coprime <span class="bound">d</span> <span class="keyword1">c</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> moebius_mu_def Φ.eq_zero_iff norm_mult norm_power Φ.norm<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> squarefree <span class="bound">d</span> <span class="main">∧</span> coprime <span class="bound">d</span> <span class="keyword1">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> squarefree <span class="bound">d</span> <span class="main">∧</span> coprime <span class="bound">d</span> <span class="keyword1">c</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dvd_div_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">c</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> n conductor_dvd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_divisors_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"squarefree <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">d</span> <span class="keyword1">c</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> multiplicity_le_imp_dvd<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">≤</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> d <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> squarefree_factorial_semiring' in_prime_factors_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="keyword1">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> conductor_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> d p <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">d</span>›</span></span> coprime_common_divisor not_prime_unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> p prime_dvd_mult_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n p conductor_dvd dvd_div_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">c</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicity_geI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_dvd_imp_multiplicity_0<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> divisor_count <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisor_count_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>sum <span class="free">χ</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> sqrt <span class="keyword1">c</span> <span class="main">*</span> ln <span class="keyword1">c</span> <span class="main">*</span> divisor_count <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="keyword1">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conductor_gr_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move? *)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we obtain a suitable upper bound on the number of divisors of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>:
›</span></span>
<span class="keyword1" id="Polya_Vinogradov-divisor_count_upper_bound_aux"><span class="command">lemma</span></span> divisor_count_upper_bound_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"divisor_count <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">=</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">*</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">*</span> sqrt <span class="free">n</span> <span class="main">⟷</span> sqrt <span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> sqrt <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">&lt;</span> sqrt <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ** n of_nat_0_less_iff mult_less_iff1 real_sqrt_gt_0_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"divisor_count <span class="free">n</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisor_count_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> sqrt <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&gt;</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> sqrt <span class="free">n</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&gt;</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&gt;</span> sqrt <span class="free">n</span><span class="main">}</span> <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&lt;</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bij_betwI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">d</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">div</span></span></span> <span class="bound"><span class="bound"><span class="bound">d</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Real.real_of_nat_div real_sqrt_divide <span class="dynamic"><span class="dynamic">field_simps</span></span> * ***<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&gt;</span> sqrt <span class="free">n</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&lt;</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"divisor_count <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Polya_Vinogradov-divisor_count_upper_bound"><span class="command">lemma</span></span> divisor_count_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"divisor_count <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"divisor_count <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> sqrt <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divisor_count_upper_bound_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> sqrt <span class="free">n</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="main">1</span><span class="main">..</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff le_floor_iff Suc_le_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Polya_Vinogradov-divisor_count_upper_bound'"><span class="command">lemma</span></span> divisor_count_upper_bound'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>divisor_count <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>divisor_count <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> divisor_count_upper_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(* END TODO *)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We are now ready to prove the `regular' Pólya--Vinogradov inequality.

  Apostol formulates it in the following way (Theorem 13.15, notation adapted):
  `If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>χ›</span></span></span></span> is any nonprincipal character mod <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>, then for all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ≥ 2›</span></span></span></span> we have
  $\sum_{m\leq x} \chi(m) = O(\sqrt{n}\log n)$.'

  The precondition <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x ≥ 2›</span></span></span></span> here is completely unnecessary. The `Big-O' notation is somewhat
  problematic since it does not make explicit in what way the variables are quantified
  (in particular the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>χ›</span></span></span></span>). The statement of the theorem in this way (for a fixed
  character <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>χ›</span></span></span></span>) seems to suggest that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is fixed here, which would make the use of `Big-O'
  completely vacuous, since it is an asymptotic statement about <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>.

  We therefore decided to formulate the inequality in the following more explicit way,
  even giving an explicit constant factor:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dcharacter<span class="main">)</span> polya_vinogradov_inequality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonprincipal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">≠</span> principal_dchar <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> conductor <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n conductor_dvd dvd_div_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted">conductor</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> sqrt conductor <span class="main">*</span> ln conductor <span class="main">*</span> divisor_count <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> conductor<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonprincipal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> polya_vinogradov_inequality_explicit<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sqrt conductor <span class="main">*</span> ln conductor <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> conductor<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conductor_gr_0 <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="keyword1">div</span> conductor <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono divisor_count_upper_bound'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> conductor<span class="main">)</span> <span class="main">=</span> sqrt <span class="free">n</span> <span class="main">/</span> sqrt conductor"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conductor_dvd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Real.real_of_nat_div real_sqrt_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt conductor <span class="main">*</span> ln conductor <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="free">n</span> <span class="main">/</span> sqrt conductor<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">n</span> <span class="main">*</span> ln conductor"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conductor_gr_0 n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conductor_le_modulus conductor_gr_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> vec_lambda_notation

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>