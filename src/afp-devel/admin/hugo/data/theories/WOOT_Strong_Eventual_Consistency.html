<div id="ErrorMonad">
<div class="head">
<h1>Theory ErrorMonad</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Notes›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Algorithms in Isabelle›</span></span>
<span class="keyword1"><span class="command">theory</span></span> ErrorMonad
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../Certification_Monads/Error_Monad.html">Certification_Monads.Error_Monad</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\noindent Isabelle's functions are mathematical functions and not necessarily algorithms. For
  example, it is possible to define a non-constructible function:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">non_constructible_function</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">non_constructible_function</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\noindent and even prove properties of them, like for example:

  \begin{center}
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"non_constructible_function <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span>Suc <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">::</span></span> nat<span class="main"><span class="main">)</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">auto</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  \end{center}

  In addition to that, some native functions in Isabelle are under-defined, e.g.,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. But it is still possible to show lemmas about these undefined values, e.g.:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">a</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">!</span></span> <span class="numeral"><span class="numeral">3</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  While it is possible to define a notion of algorithm in Isabelle~\cite{klein2018java}, we think
  that this is not necessary for the purpose of this formalization, since the reader needs to verify
  that the formalized functions correctly model the algorithms described by
  Oster et al.~\cite{oster2006data} anyway.
  However, we show that Isabelle can generate code for the functions, indicating that
  non-constructible terms are not being used within the algorithms.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> error <span class="main">=</span> <span class="quoted">String.literal</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">assert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> error <span class="main">+</span> unit"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">assert</span> False <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Assertion failed.''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">assert</span> True <span class="main">=</span> return <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fromSingleton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> error <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fromSingleton</span> <span class="main">[]</span> <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Expected list of length 1''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">fromSingleton</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> return <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">fromSingleton</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Expected list of length 1''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, we use the error monad---modelled using the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> sum<span class="antiquote"><span class="antiquote">}</span></span></span></span> type---and
  build wrappers around partially defined Isabelle functions such that the
  evaluation of undefined terms and violation of invariants expected by the
  algorithms result in error values.

  We are able to show that all operations succeed without reaching unexpected states during the
  execution of the framework.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Data">
<div class="head">
<h1>Theory Data</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The WOOT Framework \label{sec:wootFramework}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Data
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="../Datatype_Order_Generator/Order_Generator.html">Datatype_Order_Generator.Order_Generator</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹%
  \begin{figure}[t]
    \centering
    \begin{tikzpicture}[
      peernode/.style={rectangle, draw=black, thick, scale=0.8},
      eventnode/.style={rectangle, draw=black, fill=black!20, thick,rounded corners=.1cm,
      scale=0.8},
      statenode/.style={rectangle, draw=black, thick,rounded corners=.1cm,
      scale=0.8},
    ]
    % Nodes.
    \node[peernode] (peerA) at (0, 0) {Peer A};
    \node[peernode] (peerB) at (4, 0) {Peer B};
    \node[peernode] (peerC) at (8, 0) {Peer C};
    \node[statenode] (stateA1) at (0, -1) {$[]$};
    \node[statenode] (stateB1) at (4, -1) {$[]$};
    \node[statenode] (stateC1) at (8, -1) {$[]$};
    \node[eventnode] (eventA1) at (0, -2) {\emph{Send} (InsM $\vdash (A,0) \dashv I)$};
    \node[eventnode] (eventB1) at (4, -2) {\emph{Send} (InsM $\vdash (B,0) \dashv N)$};
    \node[eventnode] (eventB2) at (4, -3) {\emph{Recv} $(B,0)$};
        % Lines.
    \node[statenode] (stateB2) at (4, -4) {$[N_{(B,0)}]$};
    \node[eventnode] (eventB3) at (4, -6) {\emph{Recv} $(A,0)$};
        % Lines
    \node[statenode] (stateB3) at (4, -7) {$[I_{(A,0)} N_{(B,0)}]$};
     \node[eventnode] (eventB4) at (4, -8) {\emph{Recv} $(C,1)$};
        % Lines.
    \node[statenode] (stateB4) at (4, -9) {$[I_{(A,0)} N_{(B,0)} K_{(C,1)}]$};
    \node[eventnode] (eventA2) at (0, -3) {\emph{Recv} $(A,0)$};
    \node[statenode] (stateA2) at (0, -4) {$[I_{(A,0)}]$};
    \node[eventnode] (eventA3) at (0, -6) {\emph{Recv} $(B,0)$};
    \node[statenode] (stateA3) at (0, -7) {$[I_{(A,0)}  N_{(B,0)}]$};
    \node[eventnode] (eventA4) at (0, -8) {\emph{Recv} $(C,1)$};
    \node[statenode] (stateA4) at (0, -9) {$[I_{(A,0)} N_{(B,0)} K_{(C,1)}]$};
    \node[eventnode] (eventC1) at (8, -3) {\emph{Recv} $(A,0)$};
    \node[statenode] (stateC2) at (8, -4) {$[I_{(A,0)}]$};
    \node[eventnode] (eventC2) at (8, -5) {\emph{Send} $InsM (A,0)  (C,1) \dashv K$};
    \node[eventnode] (eventC3) at (8, -6) {\emph{Recv} $(C,1)$};
    \node[statenode] (stateC3) at (8, -7) {$[I_{(A,0)} K_{(C,1)}]$};
    \node[eventnode] (eventC4) at (8, -8) {\emph{Recv} $(B,0)$};
    \node[statenode] (stateC4) at (8, -9) {$[I_{(A,0)} N_{(B,0)} K_{(C,1)}]$};
        % Lines.
    \draw[-&gt;] (peerA.south) -- (stateA1.north);
    \draw[-&gt;] (peerB.south) -- (stateB1.north);
    \draw[-&gt;] (peerC.south) -- (stateC1.north);
    \draw[-&gt;] (stateA1.south) -- (eventA1.north);
    \draw[-&gt;] (eventA1.south) -- (eventA2.north);
    \draw[-&gt;] (eventA2.south) -- (stateA2.north);
    \draw[-&gt;] (stateA2.south) -- (eventA3.north);
    \draw[-&gt;] (eventA3.south) -- (stateA3.north);
    \draw[-&gt;] (stateA3.south) -- (eventA4.north);
    \draw[-&gt;] (eventA4.south) -- (stateA4.north);
    \draw[-&gt;] (stateB1.south) -- (eventB1.north);
    \draw[-&gt;] (eventB1.south) -- (eventB2.north);
    \draw[-&gt;] (eventB2.south) -- (stateB2.north);
    \draw[-&gt;] (stateB2.south) -- (eventB3.north);
    \draw[-&gt;] (eventB3.south) -- (stateB3.north);
    \draw[-&gt;] (stateB3.south) -- (eventB4.north);
    \draw[-&gt;] (eventB4.south) -- (stateB4.north);
    \draw[-&gt;] (stateC1.south) -- (eventC1.north);
    \draw[-&gt;] (eventC1.south) -- (stateC2.north);
    \draw[-&gt;] (stateC2.south) -- (eventC2.north);
    \draw[-&gt;] (eventC2.south) -- (eventC3.north);
    \draw[-&gt;] (eventC3.south) -- (stateC3.north);
    \draw[-&gt;] (stateC3.south) -- (eventC4.north);
    \draw[-&gt;] (eventC4.south) -- (stateC4.north);
    \end{tikzpicture}%
    \caption{Example session with 3 peers. Each peer creates an update message and sends a copy of
      it to the other two peers. Each peer integrates the messages in a different order.
    The white rounded boxes represent states, for brevity we only show the W-character's symbol and
    identifier. Although a W-character's data structure stores the identifiers of its predecessor
    and successor from its original creation event. The gray round boxes represent events,
    we abbreviate the reception events, with the identifier of the W-character, although the peer
    receives the full insert message.}%
    \label{fig:session}%
  \end{figure}
  Following the presentation by Oster et al.~\cite{oster2006data} we describe the WOOT framework as
  an operation-based CRDT~\cite{shapiro2011conflict}.

  In WOOT, the shared data type is a string over an alphabet <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"'Σ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Each peer starts with a prescribed initial state representing the empty string.
  Users can perform two types of edit operations on the string at their peer:
  \begin{itemize}
    \item Insert a new character.
    \item Delete an existing character.
  \end{itemize}

  Whenever a user performs one of these operations, their peer will create an update message (see
  Section~\ref{sec:edit}), integrate it immediately into its state, and send it to every other peer.

  An update message created at a peer may depend on at most two of the previously integrated
  messages at that peer.
  A message cannot be delivered to a peer if its antecedents have not been delivered to it yet.
  In Section~\ref{sec:networkModel} we describe a few possible methods to implement this
  requirement, as there is a trade-off between causal consistency and scalability.

  Once delivered to a remote peer, an update message will be integrated to the peers' state.
  The integration algorithm for an update message is the same whether the message originated at the
  same or at a different peer (see Section~\ref{sec:integrate}).

  The interaction of the WOOT Framework can be visualized using a space-time
  diagram~\cite{kshemkalyani2011distributed}.
  An example session between 3 peers is shown in Figure~\ref{fig:session}.
  Note that, each peer sees the edit operations in a different order.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Symbol Identifiers \label{sec:symbolIdentifiers}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The WOOT Framework requires a unique identifier for each insert operation, which it keeps
  associated with the inserted symbol.
  The identifier may not be used for another insertion operation on the same or any other peer.
  Moreover the set of identifiers must be endowed with a total linear order.
  We will denote the set of identifiers by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"'ℐ :: linorder"</span></span> <span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  Note that the order on the identifiers is not directly used as a global order over the inserted
  symbols, in contrast to the sort-key based approaches: LSEQ, LOGOOT, or TreeDoc. In particular,
  this means we do not require the identifier space to be dense.

  In the modelling in Section \ref{sec:networkModel}, we will use the pair consisting of a unique
  identifier for the peer and the count of messages integrated or sent by that peer, with the
  lexicographic order induced by the Cartesian product of the peer identifier and the counter.

  It is however possible to use other methods to generate unique identifiers, as long as the above
  requirements are fulfilled.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extended Identifiers›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'ℐ</span> extended
  <span class="main">=</span> Begin <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊢</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> InString <span class="tfree"><span class="quoted"><span class="tfree">'ℐ</span></span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(1</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⟦</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⟧</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> End <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊣</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">extended</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We embed the set of identifiers in an extension containing two additional elements
  denoting the smallest (resp. largest) element of the extension. The order of identifiers with
  respect to each other is preserved. The extended set is used in the corner cases, where a
  W-character is inserted at the beginning or end of the string - and there is no preceeding resp.
  succeeding W-character to reference. See also the following section.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Messages \label{sec:messages}›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> insert_message <span class="main">=</span>
  InsertMessage <span class="main">(</span><span class="free"><span class="entity">P</span></span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="tfree">'ℐ</span> extended"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">I</span></span><span class="main">:</span><span class="tfree"><span class="quoted"><span class="tfree">'ℐ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">S</span></span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="tfree">'ℐ</span> extended"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">Σ</span></span><span class="main">:</span><span class="tfree"><span class="quoted"><span class="tfree">'Σ</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'ℐ</span> delete_message <span class="main">=</span> DeleteMessage <span class="tfree"><span class="quoted"><span class="tfree">'ℐ</span></span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> message <span class="main">=</span>
  Insert <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> insert_message"</span></span> <span class="main">|</span>
  Delete <span class="quoted"><span class="quoted">"<span class="tfree">'ℐ</span> delete_message"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two kinds of update messages are exchanged in the WOOT Framework, indicating
  respectively an insertion or a deletion of a character. Thus the set of messages is a sum
  type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> "message"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  An insert message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has the following four components:
  \begin{itemize}
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"P <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"S <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denote the identifiers  of the character immediately
     preceding (resp. succeeding) the character at the time of its insertion.
     The special value <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊢</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊣</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) indicates that there
     was no such character, i.e., that it was inserted at the beginning (resp. end) of the string.
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"I <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes the unique identifier associated to the character (as described in
     Subsection~\ref{sec:symbolIdentifiers}).
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Σ <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes the inserted character.
  \end{itemize}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹States \label{sec:states}›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span> option<span class="main">)</span> insert_message"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A W-character <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the representation of an inserted character in the state of a
  peer. It has the same semantics and notation for its components as an insert message, with the
  difference that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Σ <span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denoting an inserted character, or
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"None"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the character has already been deleted.
  Because of this overlap in semantics, we define the type of W-characters as a type synonym.

  The state of a peer is then a string of W-characters
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s :: ('ℐ, 'Σ) woot_character list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The initial state is the empty string <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The string the user sees is the sequence of symbols omitting <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"None"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s, i.e., the sequence:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"[σ. Some σ ← map Σ s]"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">to_woot_char</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> insert_message <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">to_woot_char</span> <span class="main">(</span>InsertMessage <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span> InsertMessage <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An insert message can be converted into a W-character by applying <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Some</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the symbol
  component.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BasicAlgorithms">
<div class="head">
<h1>Theory BasicAlgorithms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Algorithms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> BasicAlgorithms
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Data.html">Data</a> <a href="ErrorMonad.html">ErrorMonad</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we introduce preliminary definitions and functions, required by the
  integration and edit algorithms in the following sections.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ext_ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> <span class="tfree">'ℐ</span> extended list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ext_ids</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">⊢</span><span class="main">#</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> I <span class="bound">x</span> <span class="main">⟧</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="main">⊣</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ext_ids</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> returns the set of extended identifiers in a string <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  including the beginning and end markers <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊢</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊣</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> <span class="tfree">'ℐ</span> extended <span class="main">⇒</span> error <span class="main">+</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">idx</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fromSingleton <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>ext_ids <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="main">(</span>ext_ids <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">idx</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> returns the index in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of a W-character with a given identifier
   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  %
  \begin{itemize}
  \item If the identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> occurs exactly once in the string then
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"idx <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">⟦</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">⟧</span></span> <span class="main"><span class="main">=</span></span> return <span class="main"><span class="main">(</span></span><span class="free"><span class="free">j</span></span><span class="main"><span class="main">+</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"I <span class="main"><span class="main">(</span></span><span class="free"><span class="free">s</span></span> <span class="main"><span class="main">!</span></span> <span class="free"><span class="free">j</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, otherwise
        <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"idx <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">⟦</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">⟧</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be an error.
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"idx <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">⊢</span></span> <span class="main"><span class="main">=</span></span> Inr <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"idx <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">⊣</span></span> <span class="main"><span class="main">=</span></span> return <span class="main"><span class="main">(</span></span>length <span class="free"><span class="free">w</span></span> <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \end{itemize}
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> nat <span class="main">⇒</span> error <span class="main">+</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nth</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Index has to be &gt;= 1.''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">nth</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Index has to be &lt;= length s''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">nth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> returns the W-character at a given index in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The first character has the index 1.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_update</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character <span class="main">⇒</span> 
  error <span class="main">+</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">list_update</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span>
          return <span class="main">(</span>List.list_update <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span>
          error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Illegal arguments.''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">list_update</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Illegal arguments.''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">list_update</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> substitutes the W-character at the index <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the W-character <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As before, we use the convention of using the index 1
  for the first character.
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CreateAlgorithms">
<div class="head">
<h1>Theory CreateAlgorithms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Edit Operations \label{sec:edit}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CreateAlgorithms
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="BasicAlgorithms.html">BasicAlgorithms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_visible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_visible</span> <span class="main">(</span>InsertMessage <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nth_visible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> nat <span class="main">⇒</span> error <span class="main">+</span> <span class="tfree">'ℐ</span> extended"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nth_visible</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> ext_ids <span class="main">(</span>filter is_visible <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span> 
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="bound">v</span> <span class="keyword1">then</span> 
        return <span class="main">(</span><span class="bound">v</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> 
      <span class="keyword1">else</span> 
        error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Argument k out of bounds.''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be the count of visible symbols in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The function
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nth_visible <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  %
  \begin{itemize}
  \item Returns the identifier of the $n$-th visible element in $s$ if $1 \leq n \leq l$.
  \item Returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">⊢</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if $n = 0$, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">⊣</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if $n = l + 1$.
  \item Returns an error otherwise.
  \end{itemize}
  %
  Note that, with this definition, the first visible character in the string has the index $1$.

  Algorithms <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">create_insert</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">create_delete</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> detail the process by which messages
  are created in response to a user action.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">from_non_extended</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ℐ</span> extended <span class="main">⇒</span> error <span class="main">+</span> <span class="tfree">'ℐ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">from_non_extended</span> <span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟧</span> <span class="main">=</span> Inr <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">from_non_extended</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Expected InString''</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">create_insert</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'Σ</span> <span class="main">⇒</span>  <span class="tfree">'ℐ</span> <span class="main">⇒</span> error <span class="main">+</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> message"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">create_insert</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">p</span> <span class="main">←</span> nth_visible <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
      <span class="bound">q</span> <span class="main">←</span> nth_visible <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">;</span>
      return <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In particular, when a user inserts a character <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">σ'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> between visible position
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and its successor of the string of a peer with state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">create_insert</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  starts by retrieving the identifiers <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the last visible character before <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">w</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">⊢</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if no such character exists) and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">q</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the first
  visible one after <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">⊣</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).

  It then broadcasts the message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Insert <span class="main"><span class="main">(</span></span>InsertMessage <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">q</span></span> <span class="free"><span class="free">σ'</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the new
  identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">create_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character list <span class="main">⇒</span> nat <span class="main">⇒</span> error <span class="main">+</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> message"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">create_delete</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">m</span> <span class="main">←</span> nth_visible <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
      <span class="bound">i</span> <span class="main">←</span> from_non_extended <span class="bound">m</span><span class="main">;</span>
      return <span class="main">(</span>Delete <span class="main">(</span>DeleteMessage <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When the user deletes the visible character at position <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">create_delete</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  retrieves the identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'th visible character in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
  broadcasts the message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Delete <span class="main"><span class="main">(</span></span>DeleteMessage <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  In both cases the message will be integrated into the peer's own state, with the same
  algorithm that integrates messages received from other peers.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="IntegrateAlgorithm">
<div class="head">
<h1>Theory IntegrateAlgorithm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Integration algorithm \label{sec:integrate}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we describe the algorithm to integrate a received message into a peers'
  state.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IntegrateAlgorithm
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="BasicAlgorithms.html">BasicAlgorithms</a> <a href="Data.html">Data</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fromSome</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> error <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fromSome</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> return <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">fromSome</span> None <span class="main">=</span> error <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Expected Some''</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntegrateAlgorithm-fromSome_ok_simp"><span class="command">lemma</span></span> fromSome_ok_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fromSome <span class="free">x</span> <span class="main">=</span> Inr <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">substr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">substr</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> take <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">-</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">concurrent</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list
  <span class="main">⇒</span> nat
  <span class="main">⇒</span> nat
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character
  <span class="main">⇒</span> error <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span> extended list<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">concurrent</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">p_pos</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>P <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">;</span>
        <span class="bound">s_pos</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">p_pos</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="bound">s_pos</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">⟦</span>I <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">⟧</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>
      <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">integrate_insert</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">integrate_insert</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">l</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
        <span class="bound">u</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
        assert <span class="main">(</span><span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">u</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1">if</span> Suc <span class="bound">l</span> <span class="main">=</span> <span class="bound">u</span> <span class="keyword1">then</span>
          return <span class="main">(</span><span class="main">(</span>take <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">@</span><span class="main">[</span>to_woot_char <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">@</span><span class="main">(</span>drop <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">d</span> <span class="main">←</span> mapM <span class="main">(</span>concurrent <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span>substr <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">l</span> <span class="bound">u</span><span class="main">)</span><span class="main">;</span>
          assert <span class="main">(</span>concat <span class="bound">d</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span>
          <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">←</span> fromSome <span class="main">(</span>find <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">⟦</span>I <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span> 
                        <span class="main">(</span>zip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span>concat <span class="bound">d</span><span class="main">)</span> <span class="main">(</span>concat <span class="bound">d</span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="free">integrate_insert</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">p'</span> <span class="bound">s'</span>
        <span class="main">}</span>
      <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">integrate_delete</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> delete_message
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list
  <span class="main">⇒</span> error <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">integrate_delete</span> <span class="main">(</span>DeleteMessage <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">k</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟧</span><span class="main">;</span>
        <span class="bound">w</span> <span class="main">←</span> nth <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">k</span><span class="main">;</span>
        list_update <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">k</span> 
          <span class="main">(</span><span class="keyword1">case</span> <span class="bound">w</span> <span class="keyword1">of</span> <span class="main">(</span>InsertMessage <span class="bound">p</span> <span class="bound">i</span> <span class="bound">u</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> InsertMessage <span class="bound">p</span> <span class="bound">i</span> <span class="bound">u</span> None<span class="main">)</span>
      <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">integrate</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message
  <span class="main">⇒</span> error <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">integrate</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> integrate_insert <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>P <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">integrate</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> integrate_delete <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">integrate</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes the main function that is called when a new message
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has to be integrated into the state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of a peer.
  It is called both when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> was generated locally or received from another peer.
  Note that we require that the antecedant messages have already been integrated. See also 
  Section \ref{sec:networkModel} for the delivery assumptions that ensure this requirement.

  Algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">integrate_delete</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes the procedure to integrate a delete message:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"DeleteMessage <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The algorithm just replaces the symbol of the W-character with identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the value
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"None"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  It is not possible to entirely remove a W-character if it is deleted, since there might be 
  unreceived insertion messages that depend on its position.

  Algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">integrate_insert</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes the procedure to integrate an insert message:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">m</span></span> <span class="main"><span class="main">=</span></span> InsertMessage <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Since insertion operations can happen concurrently and the order of message delivery is not fixed,
  it can happen that a remote peer receiving <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> finds multiple possible insertion points 
  between the predecessor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and successor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that were recorded when the message 
  was generated.
  An example of this situation is the conflict between
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"InsertMessage <span class="main"><span class="main">⊢</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">A</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">::</span></span> nat<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊣</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">CHR</span></span> <span class="inner_quoted"><span class="inner_quoted">''I''</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"InsertMessage <span class="main"><span class="main">⊢</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">B</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">::</span></span> nat<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⊣</span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">CHR</span></span> <span class="inner_quoted"><span class="inner_quoted">''N''</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  in Figure~\ref{fig:session}.

  A first attempt to resolve this would be to insert the W-characters by choosing an insertion point
  using the order induced by their identifiers to achieve a consistent ordering.
  But this method fails in some cases: a counter-example was found by 
  Oster et al.~\cite[section 2]{oster2006data}.

  The solution introduced by the authors of WOOT is to restrict the identifier comparison to the 
  set of W-characters in the range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"substr <span class="free"><span class="free">l</span></span> <span class="free"><span class="free">u</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose predecessor and successor are
  outside of the possible range, i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"idx s (P w) ≤ l"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"idx s (S w) ≥ u"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  New narrowed bounds are selected by finding the first W-character within that restricted set 
  with an identifier strictly larger than the identifier of the new W-character.

  This leads to a narrowed range where the found character forms an upper bound and its immediately
  preceeding character the lower bound. The method is applied recursively until the insertion point 
  is uniquely determined.

  Note that the fact that this strategy leads to a consistent ordering has only been verified for a
  bounded model.
  One of the contributions of this paper is to provide a complete proof for it.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DistributedExecution">
<div class="head">
<h1>Theory DistributedExecution</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Network Model \label{sec:networkModel}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the past subsections, we described the algorithms each peer uses to integrate received
  messages and broadcast new messages when an edit operation has been made on that peer.

  In this section, we model the WOOT Framework as a distributed application and set the
  basis for the consistency properties, we want to establish.

  We assume a finite set of peers starting with the same initial state of an empty W-string, each
  peer reaches a finite set of subsequent states, caused by the integration of received (or locally
  generated messages). A message is always generated from a concrete state of a peer, using the
  algorithms described in Section \ref{sec:edit}. Moreover, we assume that the same message will only
  be delivered once to a peer. Finally, we assume that the happened before relation, formed by
  \begin{itemize}
  \item Subsequent states of the same peer
  \item States following the reception and states that were the generation sites
  \end{itemize}
  do not contain loops. (Equivalently that the transitive closure of the relation is a strict
  partial order.)

  The latter is a standard assumption in the modelling of distributed systems (compare e.g.
  \cite[Chapter 6.1]{raynal2013}) effectively implied by the fact that there are no physical causal
  loops.

  Additionally, we assume that a message will be only received by a peer, when the antecedent
  messages have already been received by the peer. This is a somewhat technical assumption to
  simplify the description of the system. In a practical implementation a peer would buffer the set
  of messages that cannot yet be integrated. Note that this assumption is automatically implied if
  causal delivery is assumed.

  We establish two properties under the above assumptions
  \begin{itemize}
  \item The integration algorithm never fails.
  \item Two peers having received the same set of messages will be in the same state.
  \end{itemize}

  The model assumptions are derived from Gomes et al.\cite{gomes2017verifying} and
  Shapiro et al.\cite{shapiro:inria-00555588} with minor modifications required for WOOT.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DistributedExecution
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="IntegrateAlgorithm.html">IntegrateAlgorithm</a> <a href="CreateAlgorithms.html">CreateAlgorithms</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'p</span> event_id <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> event <span class="main">=</span>
  Send <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> event_id<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message"</span></span> <span class="main">|</span>
  Receive <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> event_id"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> event_id<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The type variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes a unique identifier identifying a peer.
  We model each peer's history as a finite sequence of events, where each event is either
  the reception or broadcast of a message.
  The index of the event in a peer's history and its identifier form a pair uniquely identifying
  an event in a distributed execution of the framework.
  In the case of a reception, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Receive <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> indicated the reception of the message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  sent at event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  In the following we introduce the locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"dist_execution_preliminary"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from which the
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"dist_execution"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> locale will inherit. The reason for the introduction of two
  locales is technical - in particular, it is not possible to interleave definitions and assumptions
  within the definition of a locale. The preliminary locale only introduces the assumption that the
  set of participating peers is finite.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> dist_execution_preliminary <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> event list"</span></span>
  <span class="comment1">― ‹We introduce a locale fixing the sequence of events per peer.›</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> fin_peers<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'p</span> set<span class="main">)</span>"</span></span>
  <span class="comment1">― ‹We are assuming a finite set of peers.›</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_valid_event_id</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_valid_event_id</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">events</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">event_pred</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">event_pred</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>  <span class="main">=</span> <span class="main">(</span>is_valid_event_id <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free">events</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">event_at</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">event_at</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> event_pred <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">(=)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_reception</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_reception</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> event_pred <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">e</span> <span class="keyword1">of</span> Receive <span class="bound">s</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">happened_immediately_before</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">happened_immediately_before</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span>
     is_valid_event_id <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span>
     is_valid_event_id <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> Suc <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">∨</span> is_reception <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">happened_immediately_before</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes immediate causal precedence:
  \begin{itemize}
    \item An events causally precedes the following event on the same peer.
    \item A message broadcast event causally precedes the reception event of it.
  \end{itemize}

  The transitive closure of this relation is the famous happened before relation introduced
  by Lamport\cite{Lamport1978}.

  In the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"dist_execution"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we will assume that the relation is acyclic - which implies that
  the transitive closure <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"happened_immediately_before<span class="main"><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a strict partial
  order.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Each peer passes through a sequence of states, which may change after receiving a message.
  We denote the initial state of peer $p$ as $(p,0)$ and the state after
  event $(p,i)$ as $(p,i+1)$. Note that there is one more state per peer than events, since we
  are count both the initial and terminal state of a peer.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_valid_state_id</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_valid_state_id</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> length <span class="main">(</span><span class="free">events</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">received_messages</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">received_messages</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>Receive <span class="main">_</span> m<span class="main">)</span> <span class="main">←</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span><span class="free">events</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">state</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> foldM integrate <span class="main">[]</span> <span class="main">(</span>received_messages <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Everytime a peer receives a message its state is updated by integrating the message. The
  function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">state</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> returns the state for a given state id.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">deps</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computes the identifiers a message depends on. ›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">extended_to_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> extended <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">extended_to_set</span> <span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟧</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">extended_to_set</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'id</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message <span class="main">⇒</span> <span class="tfree">'id</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">deps</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> extended_to_set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> extended_to_set <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">deps</span> <span class="main">(</span>Delete <span class="main">(</span>DeleteMessage <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> dist_execution <span class="main">=</span> dist_execution_preliminary <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> no_data_corruption<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">s</span> <span class="bound">m</span><span class="main">.</span> event_at <span class="bound">i</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> event_at <span class="bound">s</span> <span class="main">(</span>Send <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹A received message must also have been actually broadcast. Note that, we do not
  assume that a broadcast message will be received by all peers, similar to the modelling made by
  \cite[Section 5.2]{gomes2017verifying}.›</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> at_most_once<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">s</span> <span class="bound">m</span><span class="main">.</span>
    event_at <span class="bound">i</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span>
    event_at <span class="bound">j</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span>
    fst <span class="bound">i</span> <span class="main">=</span> fst <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span>"</span></span>
  <span class="comment1">― ‹A peer will never receive the same message twice. Note that this is something
  that can be easily implemented in the application layer, if the underlying transport mechanism
  does not guarantee it.›</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> acyclic_happened_before<span class="main">:</span>
    <span class="quoted"><span class="quoted">"acyclicP happened_immediately_before"</span></span>
  <span class="comment1">― ‹The immediate causal precendence relation is acyclic, which implies that its
  closure, the \emph{happened before} relation is a strict partial order.›</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> semantic_causal_delivery<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">s</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">i'</span><span class="main">.</span> event_at <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i'</span> <span class="main">∈</span> deps <span class="bound">m</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">s'</span> <span class="bound">j'</span> <span class="bound">m'</span><span class="main">.</span> event_at <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j'</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s'</span> <span class="main">(</span>Insert <span class="bound">m'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> I <span class="bound">m'</span> <span class="main">=</span> <span class="bound">i'</span>"</span></span>
  <span class="comment1">― ‹A message will only be delivered to a peer, if its
  antecedents have already been delivered. (See beginning of this Section for the reason of this
  assumption).›</span>

  <span class="keyword2"><span class="keyword">assumes</span></span> send_correct<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">i</span><span class="main">.</span> event_at <span class="bound">i</span> <span class="main">(</span>Send <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">σ</span><span class="main">.</span> return <span class="bound">m</span> <span class="main">=</span> state <span class="bound">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_insert <span class="bound">s</span> <span class="bound">n</span> <span class="bound">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> return <span class="bound">m</span> <span class="main">=</span> state <span class="bound">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_delete <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹A peer broadcasts messages by running the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">create_insert</span><span class="antiquote">}</span></span> or <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">create_delete</span><span class="antiquote">}</span></span>
     algorithm on its current state. In the case of an insertion the new character is assigned
     the event id as its identifier. Note that, it would be possible to assume, a different choice
     for allocating unique identifiers to new W-characters. We choose the event id since it is
     automatically unique.›</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Based on the assumptions above we show in Section \ref{sec:strong_eventual_consistency}:
  \begin{itemize}
    \item \emph{Progress}: All reached states <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"state <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be successful, i.e., the
          algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">integrate</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> terminates and does not fail.
    \item \emph{Strong Eventual Consistency}: Any pair of states  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"state <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
          and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"state <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which have been reached after receiving the same set of messages,
          i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"set <span class="main"><span class="main">(</span></span>received_messages <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> set <span class="main"><span class="main">(</span></span>received_messages <span class="free"><span class="free">j</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be equal.
  \end{itemize}›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SortKeys">
<div class="head">
<h1>Theory SortKeys</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Formalized Proof \label{sec:proof}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SortKeys
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Data.html">Data</a> <span class="quoted">"<a href="../../HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> sort_dir <span class="main">=</span>
  Left <span class="main">|</span>
  Right
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">sort_dir</span>

<span class="keyword1" id="SortKeys-sort_dir_less_def"><span class="command">lemma</span></span> sort_dir_less_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> Left <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> Right<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_sort_dir_def<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> sort_key <span class="main">=</span> 
  NonFinal <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> sort_dir<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sort_key"</span></span> <span class="main">|</span> 
  Final <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'id</span> position <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'id</span> sort_key extended"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_dir</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">embed_dir</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>Left<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">embed_dir</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>Right<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SortKeys-embed_dir_inj"><span class="command">lemma</span></span> embed_dir_inj <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>embed_dir <span class="free">x</span> <span class="main">=</span> embed_dir <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="SortKeys-embed_dir_mono"><span class="command">lemma</span></span> embed_dir_mono <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>embed_dir <span class="free">x</span> <span class="main">&lt;</span> embed_dir <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="free"><span class="free">y</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_sort_dir_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sort_key_embedding</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> sort_key <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
   <span class="quoted"><span class="quoted">"<span class="free">sort_key_embedding</span> <span class="main">(</span>NonFinal <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> embed_dir <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="main">(</span><span class="free">sort_key_embedding</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
   <span class="quoted"><span class="quoted">"<span class="free">sort_key_embedding</span> <span class="main">(</span>Final <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span> 

<span class="keyword1" id="SortKeys-sort_key_embedding_injective"><span class="command">lemma</span></span> sort_key_embedding_injective<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sort_key_embedding <span class="free">x</span> <span class="main">=</span> sort_key_embedding <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> embed_dir_inj list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.inject sort_key.exhaust
      sort_key_embedding.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.inject sort_key.exhaust
      sort_key_embedding.simps<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sort_key <span class="main">::</span> <span class="main">(</span><span class="quoted">ord</span><span class="main">)</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> sort_key_less_eq_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ord<span class="main">)</span> sort_key<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> 
    <span class="main">(</span>sort_key_embedding <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> sort_key_embedding <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> sort_key_less_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ord<span class="main">)</span> sort_key<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> 
    <span class="main">(</span>sort_key_embedding <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> sort_key_embedding <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sort_key <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le_not_le sort_key_embedding_injective<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sort_key <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> less_imp_le not_le sort_key_less_eq_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Psi">
<div class="head">
<h1>Theory Psi</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of \texorpdfstring{$\Psi$}{Psi}\label{sec:psi}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Psi
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SortKeys.html">SortKeys</a> <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">extended_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> sort_key<span class="main">)</span> extended <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">extended_size</span> <span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">extended_size</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Psi-extended_simps"><span class="command">lemma</span></span> extended_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊢</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="main">⊢</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟦</span><span class="free">x'</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="main">⟦</span><span class="free">y'</span><span class="main">⟧</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x'</span> <span class="main">&lt;</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x'</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="main">⊣</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">⟦</span><span class="free">x'</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="main">⊢</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">⊣</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟦</span><span class="free">x'</span><span class="main">⟧</span> <span class="main">≤</span> <span class="main">⟦</span><span class="free">y'</span><span class="main">⟧</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x'</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">≤</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">⊣</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">⟦</span><span class="free">x'</span><span class="main">⟧</span> <span class="main">≤</span> <span class="main">⊢</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊣</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">⊣</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_extended_def less_eq_extended_def le_less<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_size</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">int_size</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>extended_size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>extended_size <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Psi-position_cases"><span class="command">lemma</span></span> position_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⟦</span>NonFinal <span class="main">(</span><span class="bound">y</span><span class="main">,</span>Left<span class="main">)</span> <span class="bound">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⟦</span>NonFinal <span class="main">(</span><span class="bound">y</span><span class="main">,</span>Right<span class="main">)</span> <span class="bound">z</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⟦</span>Final <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⊢</span> <span class="main">⟹</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⊣</span> <span class="main">⟹</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms embed_dir.cases extended_size.cases sort_key_embedding.cases<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">derive_pos</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">×</span> sort_dir <span class="main">⇒</span> <span class="tfree">'a</span> sort_key extended <span class="main">⇒</span> <span class="tfree">'a</span> sort_key extended"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">derive_pos</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⟦</span>NonFinal <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">⊣</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="main">⊢</span> <span class="keyword1">else</span> <span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">derive_pos</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⟦</span>Final <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> fst <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> fst <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> snd <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> Left <span class="keyword1">then</span> <span class="main">⊣</span> <span class="keyword1">else</span> <span class="main">⊢</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">derive_pos</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⊢</span> <span class="main">=</span> <span class="main">⊢</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">derive_pos</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⊣</span> <span class="main">=</span> <span class="main">⊣</span>"</span></span>

<span class="keyword1" id="Psi-derive_pos_mono"><span class="command">lemma</span></span> derive_pos_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> derive_pos <span class="free">h</span> <span class="free">x</span> <span class="main">≤</span> derive_pos <span class="free">h</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="free">h</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> position <span class="main">⇒</span> sort_dir <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> sort_dir"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">⟦</span>NonFinal <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">⟦</span>Final <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">⊢</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">⊣</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">derive_left</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derive_left</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>derive_pos <span class="main">(</span>γ <span class="free"><span class="bound"><span class="entity">l</span></span></span> Right<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> derive_pos <span class="main">(</span>γ <span class="free"><span class="bound"><span class="entity">l</span></span></span> Right<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">derive_right</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">derive_right</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>derive_pos <span class="main">(</span>γ <span class="free"><span class="bound"><span class="entity">u</span></span></span> Left<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> derive_pos <span class="main">(</span>γ <span class="free"><span class="bound"><span class="entity">u</span></span></span> Left<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_interval</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_interval</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">elem</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">elem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subset</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">subset</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">method</span></span> interval_split <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> position <span class="main">×</span> <span class="tfree">'a</span> position"</span></span> <span class="main">=</span> 
  <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="keyword3">,</span></span> 
   <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
   <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"snd <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Psi-derive_size"><span class="command">lemma</span></span> derive_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="free">x</span> <span class="main">∧</span> is_interval <span class="free">x</span> <span class="main">⟹</span> int_size <span class="main">(</span>derive_left <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> int_size <span class="free">x</span>"</span></span> 
  <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">∧</span> is_interval <span class="free">x</span> <span class="main">⟹</span> int_size <span class="main">(</span>derive_right <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> int_size <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>less_SucI<span class="main">)</span>

<span class="keyword1" id="Psi-derive_interval"><span class="command">lemma</span></span> derive_interval<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="free">x</span> <span class="main">⟹</span> is_interval <span class="free">x</span> <span class="main">⟹</span> is_interval <span class="main">(</span>derive_left <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> is_interval <span class="free">x</span> <span class="main">⟹</span> is_interval <span class="main">(</span>derive_right <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">Ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> position <span class="main">×</span> <span class="tfree">'a</span> position <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> sort_key"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Final <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="main">⟦</span>Final <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟧</span> <span class="main">∧</span> <span class="main">⟦</span>Final <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> NonFinal <span class="main">(</span>γ <span class="free"><span class="bound"><span class="entity">l</span></span></span> Right<span class="main">)</span> <span class="main">(</span><span class="free">Ψ</span> <span class="main">(</span>derive_left <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟧</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> NonFinal <span class="main">(</span>γ <span class="free"><span class="bound"><span class="entity">u</span></span></span> Left<span class="main">)</span> <span class="main">(</span><span class="free">Ψ</span> <span class="main">(</span>derive_right <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">⟧</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">Ψ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> undefined"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI old.prod.exhaust<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> int_size <span class="bound">p</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> derive_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">proposition</span></span> psi_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="free">x</span> <span class="main">⟹</span> elem <span class="main">⟦</span>Ψ <span class="free">x</span> <span class="free">i</span><span class="main">⟧</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"int_size <span class="free">x</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x</span>"</span></span> <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> elem.simps prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> a
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"elem  <span class="main">⟦</span>Ψ <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 derive_size<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> derive_interval<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> c 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"elem  <span class="main">⟦</span>Ψ <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 derive_size<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> derive_interval<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> psi_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> <span class="free">i2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_interval <span class="free">x</span> <span class="main">⟹</span> Ψ <span class="free">x</span> <span class="free">i1</span> <span class="main">&lt;</span> Ψ <span class="free">x</span> <span class="free">i2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"int_size <span class="free">x</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> 
    <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x</span> <span class="main">∧</span> <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x</span>"</span></span> <span class="main">|</span> 
    <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x</span> <span class="main">∧</span> elem <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span> 
    <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>d<span class="main">)</span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span> <span class="skolem">x</span>  <span class="main">∧</span> elem <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>e<span class="main">)</span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span> <span class="skolem">x</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>f<span class="main">)</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i2</span><span class="main">⟧</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i1</span><span class="main">⟧</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> dual_order.strict_trans elem.simps
        fst_conv leI snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> a
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span> <span class="free">i1</span>  <span class="main">&lt;</span> Ψ <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span> <span class="free">i2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 derive_size<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> derive_interval<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> c
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"γ <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> Right <span class="main">=</span> γ <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> Left"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True 
      <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"is_interval <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> derive_interval<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"derive_left <span class="skolem">x</span> <span class="main">=</span> derive_right <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"Ψ <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span> <span class="free">i1</span> <span class="main">&lt;</span> Ψ <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span> <span class="free">i2</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> f<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.hyps"</span> <span class="quoted">"1.prems"</span> c derive_size<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> e f<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> h True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"γ <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> Right <span class="main">&lt;</span> γ <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> Left"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> c
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> d
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> e
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> f
    <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ψ <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span> <span class="free">i1</span>  <span class="main">&lt;</span> Ψ <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span> <span class="free">i2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 1 derive_size<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> derive_interval<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> psi_narrow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Ψ <span class="free">x'</span> <span class="free">i</span><span class="main">⟧</span> <span class="free">x</span> <span class="main">⟹</span> subset <span class="free">x</span> <span class="free">x'</span> <span class="main">⟹</span> Ψ <span class="free">x'</span> <span class="free">i</span> <span class="main">=</span> Ψ <span class="free">x</span> <span class="free">i</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"int_size <span class="free">x'</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans elem.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_interval.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"is_interval <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">consider</span></span>
    <span class="main">(</span>before<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x'</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>between<span class="main">)</span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="skolem">x'</span>"</span></span> <span class="main">|</span> 
    <span class="main">(</span>after<span class="main">)</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x'</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> elem.simps leI prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> before
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span> <span class="main">≤</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> before 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans fst_conv subset.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Ψ <span class="skolem">x'</span> <span class="free">i</span> <span class="main">=</span> NonFinal <span class="main">(</span>γ <span class="main">(</span>fst <span class="skolem">x'</span><span class="main">)</span> Right<span class="main">)</span> <span class="skolem">z</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> before d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"γ <span class="main">(</span>fst <span class="skolem">x'</span><span class="main">)</span> Right <span class="main">=</span> γ <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> Right"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">)</span> z_def <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst <span class="skolem">x'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"subset <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>derive_left <span class="skolem">x'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>derive_pos_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Ψ <span class="main">(</span>derive_left <span class="skolem">x'</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_def before d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>NonFinal <span class="main">(</span>γ <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span> Right<span class="main">)</span> <span class="skolem">z</span><span class="main">⟧</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> z_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span><span class="skolem">z</span><span class="main">⟧</span> <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> before b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main">(</span>derive_left <span class="skolem">x'</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> Ψ <span class="main">(</span>derive_left <span class="skolem">x</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> before d c1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>g<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> derive_size<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> before b a d c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> between
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> after
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">≤</span> <span class="main">⟦</span>Final <span class="free">i</span><span class="main">⟧</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> after 1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> dual_order.trans prod.exhaust_sel
          subset.simps<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_def<span class="main">:</span><span class="quoted"><span class="quoted">"Ψ <span class="skolem">x'</span> <span class="free">i</span> <span class="main">=</span> NonFinal <span class="main">(</span>γ <span class="main">(</span>snd <span class="skolem">x'</span><span class="main">)</span> Left<span class="main">)</span> <span class="skolem">z</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> after d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"γ <span class="main">(</span>snd <span class="skolem">x'</span><span class="main">)</span> Left <span class="main">=</span> γ <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> Left"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">)</span> z_def <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> position_cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"snd <span class="skolem">x'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> after
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"subset <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>derive_right <span class="skolem">x'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c <span class="quoted">"1"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>derive_pos_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Ψ <span class="main">(</span>derive_right <span class="skolem">x'</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_def after d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>NonFinal <span class="main">(</span>γ <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span> Left<span class="main">)</span> <span class="skolem">z</span><span class="main">⟧</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> z_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span><span class="skolem">z</span><span class="main">⟧</span> <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> after b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">interval_split</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>Ψ.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main">(</span>derive_right <span class="skolem">x'</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> Ψ <span class="main">(</span>derive_right <span class="skolem">x</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> after d c1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>g<span class="main">)</span>   
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> derive_size<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> after b a d c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preserve_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">preserve_order</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> psi_preserve_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">l'</span> <span class="free">u</span> <span class="free">u'</span> <span class="free">i</span> <span class="free">i'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">u'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="free">i'</span><span class="main">⟧</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preserve_order <span class="free">i</span> <span class="free">i'</span> <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free">l'</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span> <span class="free">i'</span><span class="main">⟧</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">u</span><span class="main">)</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">(</span>max <span class="free">l</span> <span class="free">l'</span><span class="main">,</span> min <span class="free">u</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> psi_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"Ψ <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">u</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> Ψ <span class="main">(</span>max <span class="free">l</span> <span class="free">l'</span><span class="main">,</span> min <span class="free">u</span> <span class="free">u'</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_narrow<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">&lt;</span> <span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">u'</span><span class="main">)</span> <span class="free">i'</span><span class="main">⟧</span> <span class="main">(</span>max <span class="free">l</span> <span class="free">l'</span><span class="main">,</span> min <span class="free">u</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> psi_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"Ψ <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">u'</span><span class="main">)</span> <span class="free">i'</span> <span class="main">=</span> Ψ <span class="main">(</span>max <span class="free">l</span> <span class="free">l'</span><span class="main">,</span> min <span class="free">u</span> <span class="free">u'</span><span class="main">)</span> <span class="free">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_narrow<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"max <span class="free">l</span> <span class="free">l'</span> <span class="main">&lt;</span> min <span class="free">u</span> <span class="free">u'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> preserve_order_def b c<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> psi_mono extended_simps<span class="main">(</span>2<span class="main">)</span> is_interval.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sorting">
<div class="head">
<h1>Theory Sorting</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sorting›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some preliminary lemmas about sorting.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sorting
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL/List.html">HOL.List</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sorting-insort"><span class="command">lemma</span></span> insort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">l</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span><span class="main">(</span>take <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">@</span><span class="free">v</span><span class="main">#</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">@</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth length_take min_less_iff_conj nth_take<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> less_Suc_eq sorted_wrt_nth_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Suc <span class="free">l</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">l</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>in_set_conv_nth add.commute less_diff_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_diff_cancel_left' diff_Suc_Suc diff_is_0_eq'
        leI le_less_trans less_imp_le sorted_wrt_iff_nth_less<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sorted_wrt_append <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>append_take_drop_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-sorted_wrt_irrefl_distinct"><span class="command">lemma</span></span> sorted_wrt_irrefl_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irreflp <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">r</span> <span class="free">xs</span> <span class="main">⟶</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> irreflp_def<span class="main">)</span>

<span class="keyword1" id="Sorting-sort_set_unique_h"><span class="command">lemma</span></span> sort_set_unique_h<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irreflp <span class="free">r</span> <span class="main">∧</span> transp <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">r</span> <span class="free">x</span> <span class="bound">z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="free">r</span> <span class="free">y</span> <span class="bound">z</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms insert_eq_iff irreflp_def list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> set_ConsD transpD<span class="main">)</span>

<span class="keyword1" id="Sorting-sort_set_unique_rel"><span class="command">lemma</span></span> sort_set_unique_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irreflp <span class="free">r</span> <span class="main">∧</span> transp <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">x</span> <span class="main">=</span> set <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">r</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">r</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> length <span class="free">y</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sorted_wrt_irrefl_distinct distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> sort_set_unique_h<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-sort_set_unique"><span class="command">lemma</span></span> sort_set_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">x</span> <span class="main">=</span> set <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sorted_wrt_map<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> irreflp_def less_irrefl sort_set_unique_rel 
      transpD transpI transp_less<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If two sequences contain the same element and strictly increasing with respect.›</span></span>

<span class="keyword1" id="Sorting-subseq_imp_sorted"><span class="command">lemma</span></span> subseq_imp_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subseq <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">p</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">p</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">¬</span> sorted_wrt <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_emb.induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(=)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> list_emb_set assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">t</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is sorted with respect to a relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">p</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then a subsequence will 
  be as well.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">to_ord</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_ord</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Sorting-trancl_idemp"><span class="command">lemma</span></span> trancl_idemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">x</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r_into_rtranclp reflclp_tranclp rtranclp_idemp rtranclp_reflclp 
      rtranclp_tranclp_tranclp tranclp.cases tranclp.r_into_trancl<span class="main">)</span>

<span class="keyword1" id="Sorting-top_sort"><span class="command">lemma</span></span> top_sort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rp</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"acyclicP <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> sorted_wrt <span class="main">(</span>to_ord <span class="free">r</span><span class="main">)</span> <span class="bound">l</span> <span class="main">∧</span> distinct <span class="bound">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"card <span class="free">s</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"acyclicP <span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>acyclic_def trancl_def trancl_idemp<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"acyclic <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">×</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> acyclic_subset inf_le1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">×</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.infinite finite_Int finite_SigmaI nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        wf_iff_acyclic_if_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span>  <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∩</span> <span class="skolem">s</span> <span class="main">×</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_in_conv wf_eq_minimal<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span> <span class="skolem">z</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">z</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_Diff_singleton_if card.infinite 
        diff_Suc_Suc diff_zero nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">z</span><span class="main">}</span> <span class="main">∧</span> sorted_wrt <span class="main">(</span>to_ord <span class="free">r</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">∧</span> distinct <span class="skolem">l</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Zero_not_Suc card.infinite finite_Diff Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">z</span><span class="main">#</span><span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">l</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">y</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_def l_def rtranclpD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insert_absorb l_def list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> 
        sorted_wrt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> to_ord.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-top_sort_eff"><span class="command">lemma</span></span> top_sort_eff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irreflp <span class="free">p</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span>to_ord <span class="free">p</span><span class="main">)</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> sorted_wrt_nth_less r_into_rtranclp reflclp_tranclp
          rtranclp_idemp rtranclp_reflclp to_ord.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irreflp_def nat_neq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Consistency">
<div class="head">
<h1>Theory Consistency</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consistency of sets of WOOT Messages \label{sec:consistency}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Consistency
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SortKeys.html">SortKeys</a> <a href="Psi.html">Psi</a> <a href="Sorting.html">Sorting</a> <a href="DistributedExecution.html">DistributedExecution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert_messages</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> message set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> insert_message set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insert_messages</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> Insert <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Consistency-insert_insert_message"><span class="command">lemma</span></span> insert_insert_message<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_messages_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete_messages</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message set <span class="main">⇒</span> <span class="tfree">'a</span> delete_message set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete_messages</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> Delete <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">depends_on</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">depends_on</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> I <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">a_conditions</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> insert_message set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> extended <span class="main">⇒</span> <span class="tfree">'a</span> position<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a_conditions</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊢</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⊣</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>P <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>S <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span>
                   <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟦</span>I <span class="bound">m</span><span class="main">⟧</span> <span class="main">=</span> <span class="main">⟦</span>Ψ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>P <span class="bound">m</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>S <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>I <span class="bound">m</span><span class="main">)</span><span class="main">⟧</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">consistent</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span>
    inj_on I <span class="main">(</span>insert_messages <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>deps <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>I <span class="main">`</span> insert_messages <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    wfP <span class="main">(</span>depends_on <span class="main">(</span>insert_messages <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> a_conditions <span class="main">(</span>insert_messages <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Consistency-consistent_subset"><span class="command">lemma</span></span> consistent_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>deps <span class="main">`</span> <span class="free">M</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>I <span class="main">`</span> insert_messages <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"insert_messages <span class="free">M</span> <span class="main">⊆</span> insert_messages <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> insert_messages_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"inj_on I <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> consistent_def inj_on_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">(</span>insert_messages <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"depends_on <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> depends_on <span class="main">(</span>insert_messages <span class="free">N</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a wf_subset <span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">N</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> a a_conditions_def subset_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b c assms<span class="main">(</span>3<span class="main">)</span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Consistency-pred_is_dep"><span class="command">lemma</span></span> pred_is_dep<span class="main">:</span> <span class="quoted"><span class="quoted">"P <span class="free">m</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff deps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> extended.set_intros extended.simps<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span>
      extended_to_set.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insert_message.exhaust_sel<span class="main">)</span>

<span class="keyword1" id="Consistency-succ_is_dep"><span class="command">lemma</span></span> succ_is_dep<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="free">m</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">i</span> <span class="main">⟧</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right deps.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> extended_to_set.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> insertI1
      insert_message.exhaust_sel<span class="main">)</span>

<span class="keyword1" id="Consistency-a_subset"><span class="command">lemma</span></span> a_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="free">N</span> <span class="free">a</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">N</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>a_conditions_def insert_messages_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete_maybe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ℐ</span>  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> message set <span class="main">⇒</span> <span class="tfree">'Σ</span>  <span class="main">⇒</span> <span class="tfree">'Σ</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">delete_maybe</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Delete <span class="main">(</span>DeleteMessage <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_woot_character</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> message set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> insert_message <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'ℐ</span><span class="main">,</span> <span class="tfree">'Σ</span><span class="main">)</span> woot_character"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">to_woot_character</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span>
       <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span>
         <span class="main">(</span>InsertMessage <span class="bound">l</span> <span class="bound">i</span> <span class="bound">u</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> InsertMessage <span class="bound">l</span> <span class="bound">i</span> <span class="bound">u</span> <span class="main">(</span>delete_maybe <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Consistency-to_woot_character_keeps_i"><span class="command">lemma</span></span> to_woot_character_keeps_i <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"I <span class="main">(</span>to_woot_character <span class="free">M</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> I <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>to_woot_character_def<span class="main">)</span>

<span class="keyword1" id="Consistency-to_woot_character_keeps_i_lifted"><span class="command">lemma</span></span> to_woot_character_keeps_i_lifted <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"I <span class="main">`</span> to_woot_character <span class="free">M</span> <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> I <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_cong image_image to_woot_character_keeps_i<span class="main">)</span>

<span class="keyword1" id="Consistency-to_woot_character_keeps_P"><span class="command">lemma</span></span> to_woot_character_keeps_P <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"P <span class="main">(</span>to_woot_character <span class="free">M</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> P <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>to_woot_character_def<span class="main">)</span>

<span class="keyword1" id="Consistency-to_woot_character_keeps_S"><span class="command">lemma</span></span> to_woot_character_keeps_S <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">(</span>to_woot_character <span class="free">M</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> S <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>to_woot_character_def<span class="main">)</span>

<span class="keyword1" id="Consistency-to_woot_character_insert_no_eff"><span class="command">lemma</span></span> to_woot_character_insert_no_eff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"to_woot_character <span class="main">(</span>insert <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> to_woot_character <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> HOL.ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>delete_maybe_def to_woot_character_def insert_message.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_associated_string</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_associated_string</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span>
    consistent <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span>
    set <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> to_woot_character <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">`</span> <span class="main">(</span>insert_messages <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> a_conditions <span class="main">(</span>insert_messages <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟶</span> 
         sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="bound">a</span> <span class="main">(</span>ext_ids <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_certified_associated_string</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_certified_associated_string</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> is_associated_string <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_certified_associated_string</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Consistency-associated_string_unique"><span class="command">lemma</span></span> associated_string_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">M</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def is_associated_string_def consistent_def
         sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sort_set_unique<span class="main">)</span>

<span class="keyword1" id="Consistency-is_certified_associated_string_unique"><span class="command">lemma</span></span> is_certified_associated_string_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="free">M</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="free">M</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>associated_string_unique<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Consistency-empty_consistent"><span class="command">lemma</span></span> empty_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">{}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">⊢</span> <span class="main">⇒</span> <span class="main">⊢</span> <span class="main">|</span> <span class="main">⊣</span> <span class="main">⇒</span> <span class="main">⊣</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_conditions_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> a_conditions <span class="main">{}</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wfP_eq_minimal<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def insert_messages_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Consistency-empty_associated"><span class="command">lemma</span></span> empty_associated<span class="main">:</span> <span class="quoted"><span class="quoted">"is_associated_string <span class="main">{}</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def insert_messages_def empty_consistent 
      ext_ids_def a_conditions_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty set of messages is consistent and the associated string is the empty string.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CreateConsistent">
<div class="head">
<h1>Theory CreateConsistent</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Create Consistent\label{sec:create_consistent}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CreateConsistent
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="CreateAlgorithms.html">CreateAlgorithms</a> <a href="Consistency.html">Consistency</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="CreateConsistent-nth_visible_inc'"><span class="command">lemma</span></span> nth_visible_inc'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">a</span> <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nth_visible <span class="free">s</span> <span class="free">n</span> <span class="main">=</span> Inr <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nth_visible <span class="free">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Inr <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subseq <span class="main">(</span>ext_ids <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext_ids_def subseq_map<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">a</span> <span class="main">(</span>ext_ids <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> subseq_imp_sorted sorted_wrt_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> sorted_wrt_nth_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-nth_visible_eff"><span class="command">lemma</span></span> nth_visible_eff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nth_visible <span class="free">s</span> <span class="free">n</span> <span class="main">=</span> Inr <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extended_to_set <span class="free">i</span> <span class="main">⊆</span> I <span class="main">`</span> set <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext_ids_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> extended.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-subset_mono"><span class="command">lemma</span></span> subset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"I <span class="main">`</span> insert_messages <span class="free">N</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert_messages <span class="free">N</span> <span class="main">⊆</span> insert_messages <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_mono_iff insert_messages_def subsetCE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-deps_insert"><span class="command">lemma</span></span> deps_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>deps <span class="main">`</span> <span class="free">M</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>I <span class="main">`</span> insert_messages <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"deps <span class="free">m</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>deps <span class="main">`</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deps <span class="free">m</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> subset_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_upper1 order_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> rev_subsetD subsetI subset_insertI subset_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-wf_add"><span class="command">lemma</span></span> wf_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> insert_message"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> I <span class="free">m</span> <span class="main">∉</span> deps <span class="main">(</span>Insert <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
           I <span class="bound">y</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="bound">z</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> insert_message set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> I <span class="bound">y</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="bound">z</span><span class="main">)</span>
           <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">∈</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">M</span><span class="main">)</span> <span class="main">∧</span> I <span class="bound">y</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="bound">z</span><span class="main">)</span>
             <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> depends_on.simps assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wfP_eq_minimal<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> DiffD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wfP_eq_minimal<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-create_insert_p_s_ordered"><span class="command">lemma</span></span> create_insert_p_s_ordered<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">N</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">N</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inr <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span> <span class="main">=</span> create_insert <span class="free">s</span> <span class="free">n</span> <span class="free">σ</span> <span class="free">new_id</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq_def<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"create_insert <span class="free">s</span> <span class="free">n</span> <span class="free">σ</span> <span class="free">new_id</span> <span class="main">=</span> Inr <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="skolem">p</span> <span class="free">new_id</span> <span class="skolem">q</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right 
        create_insert.elims sum.case_eq_if sum.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bind_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">p</span> <span class="main">=</span> nth_visible <span class="free">s</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pq_def Error_Monad.bindE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">q</span> <span class="main">=</span> nth_visible <span class="free">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> pq_def Error_Monad.bindE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">p</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_associated_string_def nth_visible_inc'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> InsertMessage <span class="skolem">p</span> <span class="free">new_id</span> <span class="skolem">q</span> <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> pq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pq_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-create_insert_consistent"><span class="command">lemma</span></span> create_insert_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">N</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">m</span> <span class="main">=</span> create_insert <span class="free">s</span> <span class="free">n</span> <span class="free">σ</span> <span class="free">new_id</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">new_id</span> <span class="main">∉</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"create_insert <span class="free">s</span> <span class="free">n</span> <span class="free">σ</span> <span class="free">new_id</span> <span class="main">=</span> Inr <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="skolem">p</span> <span class="free">new_id</span> <span class="skolem">q</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right 
        create_insert.elims assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> sum.case_eq_if sum.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bind_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> InsertMessage <span class="skolem">p</span> <span class="free">new_id</span> <span class="skolem">q</span> <span class="free">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Insert <span class="skolem">m'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pq_def assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"create_insert <span class="free">s</span> <span class="free">n</span> <span class="free">σ</span> <span class="free">new_id</span> <span class="main">=</span> Inr <span class="main">(</span>Insert <span class="skolem">m'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pq_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"I <span class="skolem">m'</span> <span class="main">=</span> <span class="free">new_id</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on I <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m'</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inj_on I <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> pq_def m'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Inr_inject insert_insert_message<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span><span class="quoted"><span class="quoted">"extended_to_set <span class="skolem">p</span> <span class="main">⊆</span> I <span class="main">`</span> set <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pq_def nth_visible_eff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"extended_to_set <span class="skolem">q</span> <span class="main">⊆</span> I <span class="main">`</span> set <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>nth_visible.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nth_visible <span class="free">s</span> <span class="free">n</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nth_visible <span class="free">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_visible_eff<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extended_to_set <span class="skolem">p</span> <span class="main">∪</span> extended_to_set <span class="skolem">q</span> <span class="main">⊆</span> I <span class="main">`</span> set <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extended_to_set <span class="skolem">p</span> <span class="main">∪</span> extended_to_set <span class="skolem">q</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_associated_string_def to_woot_character_keeps_i_lifted<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"extended_to_set <span class="skolem">p</span> <span class="main">∪</span> extended_to_set <span class="skolem">q</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> subset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"deps <span class="free">m</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pq_def assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>deps <span class="main">`</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> consistent_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> deps_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m'</span><span class="main">}</span><span class="main">.</span> deps <span class="main">(</span>Insert <span class="bound">n</span><span class="main">)</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a c consistent_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Sup_le_iff imageI insert_iff 
        insert_is_Un insert_messages_def mem_Collect_eq sup.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m'</span><span class="main">}</span><span class="main">.</span> I <span class="skolem">m'</span> <span class="main">∉</span> deps <span class="main">(</span>Insert <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right insert_absorb wf_add assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        consistent_def sup_bot.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> consistent_def  assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">⟦</span> <span class="free">new_id</span> <span class="main">⟧</span> <span class="keyword1">then</span> <span class="main">⟦</span>Ψ <span class="main">(</span><span class="skolem">a</span> <span class="main">(</span>P <span class="skolem">m'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a</span><span class="main">(</span>S <span class="skolem">m'</span><span class="main">)</span><span class="main">)</span> <span class="free">new_id</span><span class="main">⟧</span> <span class="keyword1">else</span> <span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span>"</span></span>   
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">⊢</span> <span class="main">&lt;</span> <span class="skolem">a'</span> <span class="main">⊣</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a'_def a_conditions_def a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m''</span><span class="main">.</span> <span class="bound">m''</span> <span class="main">∈</span> <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m'</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span> 
          <span class="skolem">a'</span><span class="main">(</span>P <span class="bound">m''</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">a'</span><span class="main">(</span>S <span class="bound">m''</span><span class="main">)</span>  <span class="main">∧</span>
          <span class="skolem">a'</span> <span class="main">⟦</span>I <span class="bound">m''</span><span class="main">⟧</span> <span class="main">=</span> <span class="main">⟦</span>Ψ <span class="main">(</span><span class="skolem">a'</span><span class="main">(</span>P <span class="bound">m''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">(</span>S <span class="bound">m''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>I <span class="bound">m''</span><span class="main">)</span><span class="main">⟧</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m''</span>
      <span class="keyword3"><span class="command">assume</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="skolem">m''</span> <span class="main">∈</span> <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">m'</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span><span class="main">(</span>P <span class="skolem">m''</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">a'</span><span class="main">(</span>S <span class="skolem">m''</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">a'</span> <span class="main">⟦</span> I <span class="skolem">m''</span><span class="main">⟧</span> <span class="main">=</span> 
            <span class="main">⟦</span>Ψ <span class="main">(</span><span class="skolem">a'</span><span class="main">(</span>P <span class="skolem">m''</span><span class="main">)</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">(</span>S <span class="skolem">m''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>I <span class="skolem">m''</span><span class="main">)</span><span class="main">⟧</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m''</span> <span class="main">∈</span> insert_messages <span class="free">M</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deps <span class="main">(</span>Insert <span class="skolem">m''</span><span class="main">)</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> e w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"P <span class="skolem">m''</span> <span class="main">≠</span> <span class="main">⟦</span> <span class="free">new_id</span> <span class="main">⟧</span> <span class="main">∧</span> S <span class="skolem">m''</span> <span class="main">≠</span> <span class="main">⟦</span> <span class="free">new_id</span> <span class="main">⟧</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> contra_subsetD pred_is_dep succ_is_dep<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"I <span class="skolem">m''</span> <span class="main">≠</span> <span class="free">new_id</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_def True 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_conditions_def a'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"I <span class="skolem">m''</span> <span class="main">=</span> <span class="free">new_id</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False b e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deps <span class="main">(</span>Insert <span class="skolem">m''</span><span class="main">)</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False a c e <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"P <span class="skolem">m''</span> <span class="main">≠</span> <span class="main">⟦</span> <span class="free">new_id</span> <span class="main">⟧</span> <span class="main">∧</span> S <span class="skolem">m''</span> <span class="main">≠</span> <span class="main">⟦</span> <span class="free">new_id</span> <span class="main">⟧</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> contra_subsetD pred_is_dep succ_is_dep<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">N</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> a_def a_subset assms is_associated_string_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">(</span>P <span class="skolem">m'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="main">(</span>S <span class="skolem">m'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> d create_insert_p_s_ordered<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">(</span>P <span class="skolem">m''</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">a'</span> <span class="main">(</span>S <span class="skolem">m''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation a'_def False e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e a'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a_conditions_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a insert_insert_message<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> consistent_def a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_insert_message<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="CreateConsistent-bind_simp"><span class="command">lemma</span></span> bind_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> <span class="free">y</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> Inr <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">y</span> <span class="main">(</span>projr <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Inr <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> isOK_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="CreateConsistent-create_delete_consistent"><span class="command">lemma</span></span> create_delete_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">N</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">m</span> <span class="main">=</span> create_delete <span class="free">s</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> pq_def<span class="main">:</span> <span class="quoted"><span class="quoted">"create_delete <span class="free">s</span> <span class="free">n</span> <span class="main">=</span> Inr <span class="main">(</span>Delete <span class="main">(</span>DeleteMessage <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Error_Monad.bindE create_delete.simps assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Delete <span class="main">(</span>DeleteMessage <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> insert_messages <span class="free">M</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_messages_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> pq_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_def ext_ids_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> I <span class="main">`</span> set <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pq_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&lt;</span> length <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_simp ext_ids_def nth_append<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> filter_is_subset imageI in_set_conv_nth subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> length <span class="main">(</span>filter is_visible <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_def ext_ids_def nth_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_associated_string_def to_woot_character_keeps_i_lifted<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"deps <span class="free">m</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> deps.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> singletonD subsetCE subsetI subset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="IntegrateInsertCommute">
<div class="head">
<h1>Theory IntegrateInsertCommute</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Termination Proof for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">integrate_insert</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\label{sec:integrate_term}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IntegrateInsertCommute
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="IntegrateAlgorithm.html">IntegrateAlgorithm</a> <a href="Consistency.html">Consistency</a> <a href="CreateConsistent.html">CreateConsistent</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following we show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">integrate_insert</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> terminates. Note that, this does not
  yet imply that the return value will not be an error state.›</span></span>

<span class="keyword1" id="IntegrateInsertCommute-substr_simp"><span class="command">lemma</span></span> substr_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span> <span class="main">=</span> nths <span class="free">s</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="bound">k</span> <span class="main">∧</span> Suc <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>nths <span class="main">(</span>take <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="bound">k</span> <span class="main">∧</span> Suc <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_nths<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>take <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="bound">k</span> <span class="main">∧</span> Suc <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="main">(</span><span class="free">u</span><span class="main">-</span>Suc <span class="free">l</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">s</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>take <span class="free">l</span> <span class="free">s</span> <span class="main">@</span> drop <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="bound">k</span> <span class="main">∧</span> Suc <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span> <span class="main">=</span> substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nths_append <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>append_take_drop_id<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>nths <span class="free">s</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="bound">k</span> <span class="main">∧</span> Suc <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_nths<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">s</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="bound">k</span> <span class="main">∧</span> Suc <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> substr.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Instead of simplifying <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">substr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with its definition we use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] substr_simp<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  as a simplification rule. The right hand side of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] substr_simp<span class="antiquote"><span class="antiquote">}</span></span></span></span> is a better
  representation within proofs. However, we cannot directly define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">substr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the right
  hand side as it is not constructible term for Isabelle.›</span></span>

<span class="keyword1" id="IntegrateInsertCommute-int_ins_loop_term_1"><span class="command">lemma</span></span> int_ins_loop_term_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>mapM <span class="main">(</span>concurrent <span class="free">w</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="main">(</span>projr <span class="main">(</span>mapM <span class="main">(</span>concurrent <span class="free">w</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>InString <span class="main">∘</span> I<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_simp <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps set_concat<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-fromSingleton_simp"><span class="command">lemma</span></span> fromSingleton_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fromSingleton <span class="free">xs</span> <span class="main">=</span> Inr <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fromSingleton.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-filt_simp"><span class="command">lemma</span></span> filt_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> filter <span class="free">p</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="free">p</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">p</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">b</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast_upt cancel_comm_monoid_add_class.diff_cancel 
      filter_empty_conv lessThan_iff less_Suc_eq neq0_conv zero_less_diff<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-substr_eff"><span class="command">lemma</span></span> substr_eff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>InString <span class="main">∘</span> I<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>substr <span class="free">w</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>idx <span class="free">w</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="main">(</span>projr <span class="main">(</span>idx <span class="free">w</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>projr <span class="main">(</span>idx <span class="free">w</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">w</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_nths image_iff fromSingleton_simp filt_simp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_mono length_map less_SucI list_update_id
        list_update_same_conv map_update nth_Cons_Suc nth_append<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-find_zip"><span class="command">lemma</span></span> find_zip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="free">cond</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span><span class="free">p</span><span class="main">#</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">v</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="free">v</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="free">cond</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∨</span> <span class="main">(</span><span class="free">y</span> <span class="main">∈</span> set <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>zip <span class="main">(</span><span class="free">p</span><span class="main">#</span><span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="free">cond</span> <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>find_Some_iff<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">v</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> i_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv in_set_conv_nth length_0_conv length_Cons length_append_singleton
        less_Suc_eq less_Suc_eq_0_disj nth_Cons_Suc nth_append nth_zip snd_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="free">v</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="free">cond</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq fst_conv i_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> length_Cons
        length_append_singleton lessI nth_Cons_Suc nth_append nth_mem nth_zip<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq' i_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> in_set_conv_nth length_Cons
        length_append_singleton less_Suc_eq_le nth_Cons_0 nth_append nth_zip snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_ins_measure'</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">int_ins_measure'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">l</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
        <span class="bound">u</span> <span class="main">←</span> idx <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
        assert <span class="main">(</span><span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">u</span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span><span class="bound">u</span> <span class="main">-</span> <span class="bound">l</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_ins_measure</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">int_ins_measure</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> id <span class="main">(</span>int_ins_measure' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that during the iteration of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">integrate_insert</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the arguments are decreasing
  with respect to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">int_ins_measure</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note, this means that the distance between the
  W-characters with identifiers <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) is decreasing.›</span></span>

<span class="keyword1" id="IntegrateInsertCommute-int_ins_loop_term"><span class="command">lemma</span></span> int_ins_loop_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">w</span> <span class="free">p</span> <span class="main">=</span> Inr <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">w</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mapM <span class="main">(</span>concurrent <span class="free">w</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>substr <span class="free">w</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Inr <span class="free">d</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"concat <span class="free">d</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span> 
    <span class="main">(</span>zip <span class="main">(</span><span class="free">p</span><span class="main">#</span>concat <span class="free">d</span><span class="main">)</span> <span class="main">(</span>concat <span class="free">d</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"int_ins_measure <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">-</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> idx <span class="free">w</span> <span class="bound">x</span> <span class="main">=</span> Inr <span class="bound">y</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> int_ins_loop_term_1 substr_eff assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isOK_I sum.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> concat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> diff_is_0_eq less_imp_le_nat
        mapM.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less_eq substr.simps sum.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take0<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"int_ins_measure' <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ps_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">w</span> <span class="skolem">p'</span> <span class="main">=</span> Inr <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">w</span> <span class="skolem">s'</span> <span class="main">=</span> Inr <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ps_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_simp <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≥</span> <span class="free">l</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">∧</span> <span class="skolem">u'</span> <span class="main">&gt;</span> <span class="free">l</span> <span class="main">∧</span> <span class="skolem">u'</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">l'</span> <span class="main">&gt;</span> <span class="free">l</span> <span class="main">∨</span> <span class="skolem">u'</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a b ps_def find_zip<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Inr_inject order.order_iff_strict<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ps_def ps'_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_simp <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">u'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-assert_ok_simp"><span class="command">lemma</span></span> assert_ok_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>assert <span class="free">p</span> <span class="main">=</span> Inr <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">integrate_insert</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure int_ins_measure"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> int_ins_loop_term <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Integrate Commutes›</span></span>

<span class="keyword1"><span class="command">locale</span></span> integrate_insert_commute <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> extended <span class="main">⇒</span> <span class="tfree">'a</span> position"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> associated_string_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">M</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_conditions_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="IntegrateInsertCommute-dist_ext_ids"><span class="command">lemma</span></span> dist_ext_ids<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> associated_string_assm a_conditions_assm
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def sorted_wrt_map<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> irreflp_def le_less not_le sorted_wrt_irrefl_distinct<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-I_inj_on_S"><span class="command">lemma</span></span> I_inj_on_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">∧</span> I<span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> I<span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dist_ext_ids <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> nth_eq_iff_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="IntegrateInsertCommute-idx_find"><span class="command">lemma</span></span> idx_find<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="free">s</span> <span class="main">!</span> <span class="free">x</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> Inr <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms dist_ext_ids nth_eq_iff_index_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>filt_simp fromSingleton_simp<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-obtain_idx"><span class="command">lemma</span></span> obtain_idx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> idx <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> idx_find assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-sorted_a"><span class="command">lemma</span></span> sorted_a<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">y</span> <span class="main">=</span> Inr <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">≤</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">a</span> <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> associated_string_assm a_conditions_assm is_associated_string_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>filt_simp fromSingleton_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD leI le_less length_map nth_map sorted_wrt_nth_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-sorted_a_le"><span class="command">lemma</span></span> sorted_a_le<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> Inr <span class="free">l</span> <span class="main">⟹</span> idx <span class="free">s</span> <span class="free">y</span> <span class="main">=</span> Inr <span class="free">u</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> sorted_a not_le<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-idx_intro_ext"><span class="command">lemma</span></span> idx_intro_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> idx <span class="free">s</span> <span class="main">(</span>ext_ids <span class="free">s</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dist_ext_ids <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fromSingleton_simp filt_simp  nth_eq_iff_index_eq<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-idx_intro"><span class="command">lemma</span></span> idx_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="main">⟦</span>I <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">⟧</span> <span class="main">=</span> Inr <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="free">s</span>  <span class="main">!</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟦</span>I <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">⟧</span> <span class="main">∧</span> Suc <span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def nth_append<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> idx_intro_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> integrate_insert_commute_insert <span class="main">=</span> integrate_insert_commute <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consistent_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> insert_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Insert <span class="free">m</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_conditions_assm_2<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invariant</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">invariant</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
   subset <span class="main">(</span><span class="free">a</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">,</span> <span class="free">a</span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
   elem <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">,</span> <span class="free">a</span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_concurrent</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">is_concurrent</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free">s</span> <span class="main">∧</span> 
   subset <span class="main">(</span><span class="free">a</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">,</span> <span class="free">a</span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">(</span>P <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free">a</span> <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
   elem <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">,</span> <span class="free">a</span> <span class="free"><span class="bound"><span class="entity">sm</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntegrateInsertCommute-no_id_collision"><span class="command">lemma</span></span> no_id_collision<span class="main">:</span> <span class="quoted"><span class="quoted">"I <span class="free">m</span> <span class="main">∉</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on I <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> consistent_def consistent_assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"I <span class="free">m</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="free">M</span> <span class="main">⟶</span> Insert <span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff inj_on_eq_iff insert_messages_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert_assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1" id="IntegrateInsertCommute-not_deleted"><span class="command">lemma</span></span> not_deleted<span class="main">:</span> <span class="quoted"><span class="quoted">"to_woot_char <span class="free">m</span> <span class="main">=</span> to_woot_character <span class="free">M</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Delete <span class="main">(</span>DeleteMessage <span class="main">(</span>I <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Delete <span class="main">(</span>DeleteMessage <span class="main">(</span>I <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"deps <span class="main">(</span>Delete <span class="main">(</span>DeleteMessage <span class="main">(</span>I <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> consistent_assm associated_string_assm
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def is_associated_string_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> image_subset_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> no_id_collision <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"to_woot_char <span class="free">m</span> <span class="main">=</span> to_woot_character <span class="free">M</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>to_woot_character_def delete_maybe_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-invariant_imp_sorted"><span class="command">lemma</span></span> invariant_imp_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">l</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">(</span>ext_ids <span class="free">s</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free">a</span><span class="main">(</span>ext_ids <span class="free">s</span> <span class="main">!</span> <span class="main">(</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">a</span> <span class="main">(</span>ext_ids <span class="main">(</span><span class="main">(</span>take <span class="free">l</span> <span class="free">s</span><span class="main">)</span><span class="main">@</span>to_woot_char <span class="free">m</span><span class="main">#</span>drop <span class="free">l</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> length <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="main">(</span>take <span class="free">l</span> <span class="free">s</span><span class="main">@</span>to_woot_char <span class="free">m</span><span class="main">#</span>drop <span class="free">l</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">#</span><span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def take_map drop_map<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms associated_string_assm is_associated_string_def a_conditions_assm
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span>take_map drop_map<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insort<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-no_self_dep"><span class="command">lemma</span></span> no_self_dep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> depends_on <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="free">m</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> consistent_assm
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right insert_insert_message sup_bot.right_neutral<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq wfP_eq_minimal<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-pred_succ_order"><span class="command">lemma</span></span> pred_succ_order<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">∈</span> <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">(</span>P <span class="free">m'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="free">m'</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span><span class="main">(</span>S <span class="free">m'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="free">m'</span><span class="main">⟧</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> elem.simps is_interval.simps psi_elem a_conditions_def 
      a_conditions_assm_2 insert_insert_message<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-find_dep"><span class="command">lemma</span></span> find_dep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">m'</span> <span class="main">∈</span> <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="free">m'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span><span class="main">⟧</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">=</span> <span class="free">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms consistent_assm
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> I <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms True no_self_dep <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnE image_Un image_empty image_insert 
          insert_insert_message singletonD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">m'</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms is_associated_string_def associated_string_assm consistent_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Union_iff contra_subsetD image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> I <span class="main">`</span> <span class="main">(</span>set <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> associated_string_assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span><span class="main">⟧</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def image_iff<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-find_pred"><span class="command">lemma</span></span> find_pred<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">∈</span> <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> P <span class="free">m'</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_dep <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"P <span class="free">m'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def insert_messages_def pred_is_dep<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-find_succ"><span class="command">lemma</span></span> find_succ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">∈</span> <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> S <span class="free">m'</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_dep <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"S <span class="free">m'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def insert_messages_def succ_is_dep<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_certified_associated_string'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_certified_associated_string'</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    set <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> 
      <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">a</span> <span class="main">(</span>ext_ids <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_certified_associated_string'</span> <span class="main">(</span>Inl <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> 

<span class="keyword1" id="IntegrateInsertCommute-integrate_insert_final_step"><span class="command">lemma</span></span> integrate_insert_final_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">pm</span> <span class="free">sm</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">pm</span> <span class="main">=</span> Inr <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">sm</span> <span class="main">=</span> Inr <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string' <span class="main">(</span>Inr <span class="main">(</span>take <span class="free">l</span> <span class="free">s</span><span class="main">@</span><span class="main">(</span>to_woot_char <span class="free">m</span><span class="main">)</span><span class="main">#</span>drop <span class="free">l</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">l</span> <span class="free">s</span><span class="main">@</span><span class="main">(</span>to_woot_char <span class="free">m</span><span class="main">)</span><span class="main">#</span>drop <span class="free">l</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">t</span> <span class="main">=</span> set <span class="free">s</span> <span class="main">∪</span> <span class="main">{</span>to_woot_char <span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right append_take_drop_id list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> 
        set_append sup_bot.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 
    <span class="quoted"><span class="quoted">"set <span class="skolem">t</span> <span class="main">=</span> to_woot_character <span class="free">M</span> <span class="main">`</span> insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>to_woot_character <span class="free">M</span> <span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_deleted <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> associated_string_assm is_associated_string_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 
    <span class="quoted"><span class="quoted">"set <span class="skolem">t</span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_woot_character_insert_no_eff<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> insert_insert_message <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="free">a</span> <span class="main">(</span>ext_ids <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms invariant_imp_sorted
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def fromSingleton_simp filt_simp t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> t_def associated_string_assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-concurrent_eff"><span class="command">lemma</span></span> concurrent_eff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">pm</span> <span class="main">=</span> Inr <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">sm</span> <span class="main">=</span> Inr <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">d</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mapM <span class="main">(</span>concurrent <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Inr <span class="free">d</span> <span class="main">∧</span> 
    set <span class="main">(</span>concat <span class="free">d</span><span class="main">)</span> <span class="main">=</span> InString <span class="main">`</span> I <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> is_concurrent <span class="free">pm</span> <span class="free">sm</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">t</span> <span class="main">⊆</span> set <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>isOK <span class="main">(</span>mapM <span class="main">(</span>concurrent <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
    set <span class="main">(</span>concat <span class="main">(</span>projr <span class="main">(</span>mapM <span class="main">(</span>concurrent <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    InString <span class="main">`</span> I <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">t</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">(</span>P <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">pm</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">(</span>S <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span> <span class="free">a</span> <span class="free">sm</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">th</span> <span class="skolem">tt</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">th</span> <span class="main">∈</span> to_woot_character <span class="free">M</span> <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> associated_string_assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_associated_string_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">th'</span></span> <span class="keyword2"><span class="keyword">where</span></span> th'_def<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">th'</span> <span class="main">∈</span> insert_messages <span class="free">M</span> <span class="main">∧</span> P <span class="skolem">th'</span> <span class="main">=</span> P <span class="skolem">th</span> <span class="main">∧</span> S <span class="skolem">th'</span> <span class="main">=</span> S <span class="skolem">th</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff to_woot_character_keeps_P to_woot_character_keeps_S<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="main">(</span>P <span class="skolem">th</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> th'_def find_pred obtain_idx <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> u'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="main">(</span>S <span class="skolem">th</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> th'_def find_succ obtain_idx <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⟦</span>I <span class="skolem">th</span><span class="main">⟧</span> <span class="main">∧</span> <span class="skolem">l'</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">∧</span> <span class="free">u</span> <span class="main">≤</span> <span class="skolem">u'</span><span class="main">}</span> <span class="main">=</span> 
      InString <span class="main">`</span> I <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">th</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">(</span>P <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">pm</span> <span class="main">∧</span> <span class="free">a</span> <span class="free">sm</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">(</span>S <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_a l'_def u'_def assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_simp l'_def u'_def 
          concurrent.simps<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> w<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">th</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">s</span> <span class="main">∧</span> <span class="free">a</span> <span class="free">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="bound">x</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="bound">x</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">sm</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_nths in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_a_le idx_intro assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
    isOK <span class="main">(</span>mapM <span class="main">(</span>concurrent <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
    set <span class="main">(</span>concat <span class="main">(</span>projr <span class="main">(</span>mapM <span class="main">(</span>concurrent <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>substr <span class="free">s</span> <span class="free">l</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      InString <span class="main">`</span> I <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> is_concurrent <span class="free">pm</span> <span class="free">sm</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>t_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-concurrent_eff_2"><span class="command">lemma</span></span> concurrent_eff_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invariant <span class="free">pm</span> <span class="free">sm</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_concurrent <span class="free">pm</span> <span class="free">sm</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preserve_order <span class="main">⟦</span>I <span class="free">x</span><span class="main">⟧</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">x</span><span class="main">⟧</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> to_woot_character <span class="free">M</span> <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> associated_string_assm is_associated_string_def 
      is_concurrent.elims<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"I <span class="free">x</span> <span class="main">=</span> I <span class="skolem">x'</span> <span class="main">∧</span> P <span class="free">x</span> <span class="main">=</span> P <span class="skolem">x'</span> <span class="main">∧</span> S <span class="free">x</span> <span class="main">=</span> S <span class="skolem">x'</span> <span class="main">∧</span> <span class="skolem">x'</span> <span class="main">∈</span> insert_messages <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> to_woot_character_keeps_P to_woot_character_keeps_S 
      to_woot_character_keeps_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">x</span><span class="main">⟧</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"elem <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">(</span>P <span class="free">x</span><span class="main">)</span><span class="main">,</span> <span class="free">a</span> <span class="main">(</span>S <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invariant_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_insert_message a_conditions_assm_2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"preserve_order <span class="main">(</span>I <span class="free">x</span><span class="main">)</span> <span class="main">(</span>I <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">x</span><span class="main">⟧</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_conditions_def psi_preserve_order x'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preserve_order_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-concurrent_eff_3"><span class="command">lemma</span></span> concurrent_eff_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">pm</span> <span class="main">=</span> Inr <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="free">sm</span> <span class="main">=</span> Inr <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">l</span> <span class="main">&lt;</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> is_concurrent <span class="free">pm</span> <span class="free">sm</span> <span class="bound">x</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> insert_messages <span class="free">M</span> <span class="main">∧</span> <span class="free">a</span> <span class="free">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="bound">x</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟦</span>I <span class="bound">x</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">sm</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> associated_string_assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_def is_associated_string_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> insert_messages <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"depends_on <span class="skolem">H</span> <span class="main">≤</span> depends_on <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span>depends_on <span class="skolem">H</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_subset <span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fromSingleton_simp filt_simp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span>I<span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟦</span>I<span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">sm</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sorted_a_le assms u idx_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"I <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI associated_string_assm is_associated_string_def nth_mem 
        to_woot_character_keeps_i_lifted u<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> depends_on <span class="skolem">H</span> <span class="bound">y</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∉</span> <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wfP_eq_minimal<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="skolem">z</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="free">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span><span class="bound">x</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟦</span><span class="bound">x</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">sm</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> deps <span class="main">(</span>Insert <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> insert_messages_def associated_string_assm 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def is_associated_string_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> H_def z_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> insert_messages <span class="free">M</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> I <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∉</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> z_def 
      <span class="keyword1"><span class="command">using</span></span> a depends_on.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="free">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⟦</span><span class="skolem">x</span><span class="main">⟧</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">⟦</span><span class="skolem">x</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">sm</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H_def x'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="free">s</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="main">⊢</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="free">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">⊢</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_less_zero  sorted_a_le assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> idx_intro_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="free">s</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊣</span> <span class="main">∧</span> Suc <span class="main">(</span>length <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_append ext_ids_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>Suc <span class="main">(</span>length <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fromSingleton_simp filt_simp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">a</span> <span class="main">⊣</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">sm</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sorted_a_le assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> idx_intro_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span>P <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">pm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b c pred_is_dep pred_succ_order H_def z_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"P <span class="skolem">z</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span>S <span class="skolem">z</span><span class="main">)</span> <span class="main">≥</span> <span class="free">a</span> <span class="free">sm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b c succ_is_dep pred_succ_order H_def z_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"S <span class="skolem">z</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_woot_character <span class="free">M</span> <span class="skolem">z</span> <span class="main">∈</span> set <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> f associated_string_assm is_associated_string_def z_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_concurrent <span class="free">pm</span> <span class="free">sm</span> <span class="main">(</span>to_woot_character <span class="free">M</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H_def z_def<span class="main">(</span>1<span class="main">)</span> d e <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-integrate_insert_result_helper"><span class="command">lemma</span></span> integrate_insert_result_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invariant <span class="free">pm</span> <span class="free">sm</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> 
  is_certified_associated_string' <span class="main">(</span>integrate_insert <span class="free">m'</span> <span class="free">s'</span> <span class="free">pm</span> <span class="free">sm</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m'</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quoted"><span class="free">pm</span></span> <span class="quoted"><span class="free">sm</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>integrate_insert.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">m'</span> <span class="skolem">s'</span> <span class="skolem">pm</span> <span class="skolem">sm</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="skolem">pm</span> <span class="main">=</span> Inr <span class="skolem">l</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> invariant_def obtain_idx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u_def<span class="main">:</span> <span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="skolem">sm</span> <span class="main">=</span> Inr <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> invariant_def obtain_idx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>l_def u_def 1 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps is_certified_associated_string'.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> l_def u_def integrate_insert_final_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="skolem">sm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invariant_def <span class="quoted">"1"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_a_le  l_def u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mapM <span class="main">(</span>concurrent <span class="free">s</span> <span class="skolem">l</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>substr <span class="free">s</span> <span class="skolem">l</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">d</span> <span class="main">∧</span>  
      set <span class="main">(</span>concat <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> InString <span class="main">`</span> I <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> is_concurrent <span class="skolem">pm</span> <span class="skolem">sm</span> <span class="bound">x</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> concurrent_eff l_def u_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"concat <span class="skolem">d</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI concurrent_eff_3 False l_def u_def 
          a d_def empty_set image_is_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="skolem">d</span><span class="main">)</span> <span class="main">⟹</span> 
      preserve_order <span class="bound">x</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
       <span class="free">a</span> <span class="skolem">pm</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">a</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="skolem">sm</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> d_def concurrent_eff_2 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>set_concat <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pm'</span></span> <span class="skolem"><span class="skolem">sm'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">sm</span><span class="main">)</span> <span class="main">∘</span> snd<span class="main">)</span>
         <span class="main">(</span>zip <span class="main">(</span><span class="skolem">pm</span> <span class="main">#</span> concat <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>concat <span class="skolem">d</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">sm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">pm'</span><span class="main">,</span><span class="skolem">sm'</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>find_None_iff<span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_decomp in_set_impl_in_set_zip2 length_Cons 
              length_append_singleton<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">pm'</span> <span class="main">=</span> <span class="skolem">pm</span> <span class="main">∨</span> <span class="skolem">pm'</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ps'_def b
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> find_zip<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pm'</span> <span class="main">∈</span> set <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c 1<span class="main">(</span>2<span class="main">)</span> invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pm'</span> <span class="main">∈</span> InString <span class="main">`</span> I <span class="main">`</span> insert_messages <span class="free">M</span> <span class="main">∨</span> <span class="skolem">pm'</span> <span class="main">=</span> <span class="main">⊢</span> <span class="main">∨</span> <span class="skolem">pm'</span> <span class="main">=</span> <span class="main">⊣</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_image associated_string_assm is_associated_string_def 
          to_woot_character_keeps_i_lifted<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pm'</span> <span class="main">≠</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_id_collision <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pm'</span> <span class="main">=</span> <span class="skolem">pm</span> <span class="main">∨</span> <span class="skolem">pm'</span> <span class="main">&lt;</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">sm'</span> <span class="main">=</span> <span class="skolem">sm</span> <span class="main">∨</span> <span class="skolem">sm'</span> <span class="main">&gt;</span> <span class="main">⟦</span>I <span class="free">m</span><span class="main">⟧</span> <span class="main">∧</span> <span class="skolem">sm'</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ps'_def b find_zip<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> find_zip<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> find_zip<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_linear<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> e<span class="main">:</span><span class="quoted"><span class="quoted">"invariant <span class="skolem">pm'</span> <span class="skolem">sm'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> c d <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>set_concat<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.strict_trans leD leI preserve_order_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> integrate_insert.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> a b e ps'_def 1 d_def False l_def u_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>1 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>idx.simps integrate_insert.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="IntegrateInsertCommute-integrate_insert_result"><span class="command">lemma</span></span> integrate_insert_result<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_certified_associated_string' <span class="main">(</span>integrate_insert <span class="free">m</span> <span class="free">s</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invariant <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> find_pred find_succ pred_succ_order <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>invariant_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> integrate_insert_result_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="IntegrateInsertCommute-integrate_insert_result"><span class="command">lemma</span></span> integrate_insert_result<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Insert <span class="free">m</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">M</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>integrate_insert <span class="free">m</span> <span class="free">s</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>integrate_insert <span class="free">m</span> <span class="free">s</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">t</span> <span class="main">∧</span>
    set <span class="skolem">t</span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tt</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>integrate_insert <span class="free">m</span> <span class="free">s</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Inr <span class="bound">t</span> <span class="main">∧</span>
          set <span class="bound">t</span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="skolem">tt</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> consistent_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms a_subset is_associated_string_def a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">interpret</span></span> integrate_insert_commute_insert <span class="quoted"><span class="quoted">"<span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrate_insert_commute_insert_def integrate_insert_commute_def <span class="comment1">(*
                *)</span> integrate_insert_commute_insert_axioms.intro<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">tt</span></span> <span class="keyword1"><span class="command">using</span></span> a integrate_insert_result
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"integrate_insert <span class="free">m</span> <span class="free">s</span> <span class="main">(</span>P <span class="free">m</span><span class="main">)</span> <span class="main">(</span>S <span class="free">m</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟹</span> 
    sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="bound">a</span> <span class="main">(</span>ext_ids <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Insert <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms a_subset is_associated_string_def c <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">interpret</span></span> integrate_insert_commute_insert <span class="quoted"><span class="quoted">"<span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrate_insert_commute_insert_def integrate_insert_commute_def <span class="comment1">(*
                *)</span> integrate_insert_commute_insert_axioms.intro<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="skolem">a</span> <span class="main">(</span>ext_ids <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> integrate_insert_result t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b t_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">locale</span></span> integrate_insert_commute_delete <span class="main">=</span> integrate_insert_commute <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consistent_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main">(</span>InsertMessage <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> InsertMessage <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete_only_m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> woot_character"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">delete_only_m</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> DeleteMessage <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">then</span> delete <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="IntegrateInsertCommute-set_s"><span class="command">lemma</span></span> set_s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">s</span> <span class="main">=</span> to_woot_character <span class="free">M</span> <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> associated_string_assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-delete_only_m_effect"><span class="command">lemma</span></span> delete_only_m_effect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delete_only_m <span class="main">(</span>to_woot_character <span class="free">M</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>to_woot_character_def delete_maybe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> delete_only_m_def insert_message.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> delete.simps<span class="main">)</span>

<span class="keyword1" id="IntegrateInsertCommute-integrate_delete_result"><span class="command">lemma</span></span> integrate_delete_result<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>integrate_delete <span class="free">m</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>DeleteMessage <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deps <span class="main">(</span>Delete <span class="free">m</span><span class="main">)</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> consistent_assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>consistent_def DeleteMessage<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DeleteMessage <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> I <span class="main">`</span> set <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_messages_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"I <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="free">s</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟦</span><span class="skolem">i</span><span class="main">⟧</span> <span class="main">∧</span> Suc <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> g<span class="main">:</span><span class="quoted"><span class="quoted">"idx <span class="free">s</span> <span class="main">⟦</span><span class="skolem">i</span><span class="main">⟧</span> <span class="main">=</span> Inr <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fromSingleton_simp filt_simp<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> dist_ext_ids nth_eq_iff_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> List.list_update <span class="free">s</span> <span class="skolem">k</span> <span class="main">(</span>delete <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"integrate_delete <span class="free">m</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_def DeleteMessage <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>DeleteMessage <span class="main">(</span>I<span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">j</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DeleteMessage<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> I_inj_on_S k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"List.list_update <span class="free">s</span> <span class="skolem">k</span> <span class="main">(</span>delete <span class="main">(</span><span class="free">s</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map delete_only_m <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>k_def delete_only_m_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">t</span> <span class="main">=</span> delete_only_m <span class="main">`</span> set <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_s delete_only_m_effect image_cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span>
    <span class="quoted"><span class="quoted">"set <span class="skolem">t</span> <span class="main">=</span> to_woot_character <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_messages_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ext_ids <span class="free">s</span> <span class="main">=</span> ext_ids <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>t_def ext_ids_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> insert_message.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_update_id map_update<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⟹</span> sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="bound">a</span> <span class="main">(</span>ext_ids <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> associated_string_assm is_associated_string_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span>
                  <span class="main">⟹</span> sorted_wrt <span class="main">(&lt;)</span> <span class="main">(</span>map <span class="bound">a</span> <span class="main">(</span>ext_ids <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_messages_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>a is_associated_string_def b c<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> consistent_assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="IntegrateInsertCommute-integrate_delete_result"><span class="command">lemma</span></span> integrate_delete_result<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">M</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>integrate_delete <span class="free">m</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span>Delete <span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> consistent_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"a_conditions <span class="main">(</span>insert_messages <span class="free">M</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms a_subset is_associated_string_def a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">interpret</span></span> integrate_insert_commute_delete <span class="quoted"><span class="quoted">"<span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> integrate_insert_commute_def integrate_insert_commute_delete.intro
            integrate_insert_commute_delete_axioms.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> integrate_delete_result <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> message<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">is_delete</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">is_delete</span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> integrate_insert_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_delete <span class="free">m</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">∉</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free">M</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span><span class="free">M</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>integrate <span class="free">s</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms integrate_insert_result integrate_delete_result <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="StrongConvergence">
<div class="head">
<h1>Theory StrongConvergence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong Convergence›</span></span>

<span class="keyword1"><span class="command">theory</span></span> StrongConvergence
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="IntegrateInsertCommute.html">IntegrateInsertCommute</a> <a href="CreateConsistent.html">CreateConsistent</a> <a href="../../HOL/HOL/Finite_Set.html">HOL.Finite_Set</a> <a href="DistributedExecution.html">DistributedExecution</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> happened_before_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">events</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>happened_immediately_before<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> Suc <span class="free">i</span> <span class="main">+</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> less_iff_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_valid_event_id <span class="main">(</span><span class="free">k</span><span class="main">,</span> Suc <span class="free">i</span> <span class="main">+</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>happened_immediately_before<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> Suc <span class="free">i</span> <span class="main">+</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tranclp.r_into_trancl<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessD add_Suc_right fst_conv happened_immediately_before.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> 
        is_valid_event_id.simps snd_conv tranclp.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> is_valid_event_id.simps v_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">make_set</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">make_set</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">j</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="StrongConvergence-make_set_nil"><span class="command">lemma</span></span> make_set_nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"make_set <span class="main">0</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>make_set_def<span class="main">)</span>

<span class="keyword1" id="StrongConvergence-make_set_suc"><span class="command">lemma</span></span> make_set_suc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"make_set <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> make_set <span class="free">k</span> <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="free">k</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>make_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> received_messages_eff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>received_messages <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> make_set <span class="free">j</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>make_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> finite_valid_event_ids<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> is_valid_event_id <span class="bound">i</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="free">events</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">events</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="main">(</span>length <span class="main">(</span><span class="free">events</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt_ex insert_iff le_less_trans less_imp_not_less not_le_imp_less<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> length <span class="main">(</span><span class="free">events</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_def fin_peers <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> is_valid_event_id <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">m</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_mono_iff less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="skolem">X</span> <span class="main">×</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> is_valid_event_id <span class="bound">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">X</span> <span class="main">×</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">m</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fin_peers finite_Collect_less_nat finite_cartesian_product
        infinite_super subset_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> send_insert_id_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state <span class="free">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_insert <span class="bound">s</span> <span class="free">n</span> <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> I <span class="free">m</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> send_insert_id_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state <span class="free">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_delete <span class="bound">s</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> send_insert_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"event_at <span class="free">i</span> <span class="main">(</span>Send <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> I <span class="free">m</span> <span class="main">=</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> send_correct send_insert_id_1 send_insert_id_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> recv_insert_once<span class="main">:</span>
  <span class="quoted"><span class="quoted">"event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span>Receive <span class="free">s</span> <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="free">t</span> <span class="main">(</span>Insert <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_data_corruption send_insert_id at_most_once
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Pair_inject event_pred.simps fst_conv is_valid_event_id.simps<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> integrate_insert_commute'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="free">m</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_delete <span class="free">m</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">∉</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"deps <span class="free">m</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="free">T</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="free">T</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span><span class="free">T</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> integrate <span class="bound">t</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>deps <span class="main">`</span> <span class="main">(</span><span class="free">T</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="main">(</span><span class="free">T</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> Inr <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>is_associated_string_def consistent_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.trans subset_insertI subset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="free">T</span> <span class="main">∪</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms consistent_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> integrate_insert_commute assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> Inr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StrongConvergence-foldM_rev"><span class="command">lemma</span></span> foldM_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"foldM <span class="free">f</span> <span class="free">s</span> <span class="main">(</span><span class="free">li</span><span class="main">@</span><span class="main">[</span><span class="free">ll</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> foldM <span class="free">f</span> <span class="free">s</span> <span class="free">li</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="free">ll</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">li</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> state_is_associated_string'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">M</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="main">(</span><span class="free">events</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"make_set <span class="free">j</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span>make_set <span class="free">j</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_associated<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">events</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">events</span> <span class="free">i</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Receive <span class="skolem">s</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_delete <span class="skolem">m</span> <span class="main">∨</span> <span class="skolem">m</span> <span class="main">∉</span> <span class="main">(</span>make_set <span class="skolem">j</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> recv_insert_once Receive b <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> make_set_def<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> nat_neq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deps <span class="skolem">m</span> <span class="main">⊆</span> I <span class="main">`</span> insert_messages <span class="main">(</span>make_set <span class="skolem">j</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> semantic_causal_delivery Receive b <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_messages_def image_iff make_set_def<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>take_Suc_conv_app_nth foldM_rev<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> integrate_insert_commute' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> sent_before_recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="free">s</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">events</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"event_at <span class="free">s</span> <span class="main">(</span>Send <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> happened_immediately_before<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"event_at <span class="free">s</span> <span class="main">(</span>Send <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms no_data_corruption <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"happened_immediately_before <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> event.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>happened_immediately_before<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">s</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happened_before_same 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tranclp_into_tranclp2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> irrefl_p<span class="main">:</span> <span class="quoted"><span class="quoted">"irreflp <span class="main">(</span>happened_immediately_before<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> acyclic_def dist_execution.acyclic_happened_before
      dist_execution_axioms irreflpI tranclp_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> new_messages_keep_consistency<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"event_at <span class="free">i</span> <span class="main">(</span>Send <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>received_messages <span class="free">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> I <span class="main">`</span> insert_messages <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="main">(</span>insert <span class="free">m</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"is_valid_state_id <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> 
    <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">σ</span><span class="main">.</span> Inr <span class="free">m</span> <span class="main">=</span> <span class="main">(</span>state <span class="free">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_insert <span class="bound">s</span> <span class="bound">n</span> <span class="bound">σ</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span>   Inr <span class="free">m</span> <span class="main">=</span> <span class="main">(</span>state <span class="free">i</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_delete <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> send_correct assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"Inr <span class="skolem">s</span> <span class="main">=</span> state <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">m</span> <span class="main">=</span> create_insert <span class="skolem">s</span> <span class="skolem">n'</span> <span class="skolem">σ</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"state <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="main">(</span>set <span class="main">(</span>received_messages <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>received_messages_eff<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> s_def<span class="main">(</span>1<span class="main">)</span> state_is_associated_string'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_certified_associated_string.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> create_insert_consistent s_def assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right sup_bot.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"Inr <span class="skolem">s</span> <span class="main">=</span> state <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">m</span> <span class="main">=</span> create_delete <span class="skolem">s</span> <span class="skolem">n'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"state <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bind_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="main">(</span>set <span class="main">(</span>received_messages <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>received_messages_eff<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> s_def<span class="main">(</span>1<span class="main">)</span> state_is_associated_string'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> is_certified_associated_string.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> create_delete_consistent s_def assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_insert_right sup_bot.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> sent_messages_consistent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"consistent <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> event_at <span class="bound">i</span> <span class="main">(</span>Send <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ids</span></span> <span class="keyword2"><span class="keyword">where</span></span> ids_def<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ids</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> is_valid_event_id <span class="bound">i</span><span class="main">}</span> <span class="main">∧</span> 
    sorted_wrt <span class="main">(</span>to_ord <span class="main">(</span>happened_immediately_before<span class="main">)</span><span class="main">)</span> <span class="skolem">ids</span> <span class="main">∧</span> distinct <span class="skolem">ids</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> top_sort finite_valid_event_ids  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> acyclic_happened_before<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> happened_immediately_before<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ids</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">ids</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> converse_tranclpE ids_def tranclp.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> happened_immediately_before<span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">ids</span> <span class="main">∧</span> <span class="skolem">ids</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">ids</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> top_sort_eff ids_def  distinct_Ex1 irrefl_p<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">ids</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">ids</span> <span class="main">⟹</span> consistent <span class="main">(</span>make_set <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> event_at <span class="main">(</span><span class="skolem">ids</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Send <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> empty_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ij_def<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">ids</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">ids</span>"</span></span>
      <span class="quoted"><span class="quoted">"is_valid_event_id <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems Suc_le_lessD ids_def is_valid_event_id.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_valid_state_id.simps
          le_eq_less_or_eq mem_Collect_eq nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>received_messages <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> make_set <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> event_at <span class="main">(</span><span class="skolem">ids</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Send <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ij_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>received_messages_eff <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>received_messages.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> sent_before_recv a <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>make_set_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> distinct_Ex1 ids_def in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∉</span> I <span class="main">`</span> insert_messages <span class="main">(</span>make_set <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> event_at <span class="main">(</span><span class="skolem">ids</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Send <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_messages_def image_iff make_set_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>event_at.simps<span class="main">)</span>  
        <span class="keyword1"><span class="command">using</span></span> ids_def le_eq_less_or_eq nth_eq_iff_index_eq send_insert_id  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.strict_trans1 ij_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ij_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_not_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">events</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> new_messages_keep_consistency <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"make_set <span class="skolem">n</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">x</span><span class="main">.</span> event_at <span class="main">(</span><span class="skolem">ids</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Send <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> event_at <span class="bound">i</span> <span class="main">(</span>Send <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>make_set_def n_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> surjective_pairing<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>event_pred.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ids_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv in_set_conv_nth is_valid_event_id.simps mem_Collect_eq prod.exhaust_sel snd_conv<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ids_def n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> received_messages_were_sent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"make_set <span class="free">j</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> event_at <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> event_at <span class="bound">i</span> <span class="main">(</span>Send <span class="bound">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_data_corruption <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>make_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> state_is_associated_string<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_certified_associated_string <span class="main">(</span>set <span class="main">(</span>received_messages <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> state_is_associated_string' received_messages_eff
    sent_messages_consistent received_messages_were_sent assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SEC">
<div class="head">
<h1>Theory SEC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Strong Eventual Consistency \label{sec:strong_eventual_consistency}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SEC
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="StrongConvergence.html">StrongConvergence</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following theorem we establish that all reached states are successful. This
implies with the unconditional termination property (Section \ref{sec:integrate_term}) of it that 
the integration algorithm never fails.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> no_failure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>state <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"state <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms state_is_associated_string is_certified_associated_string.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorem establishes that any pair of peers having received the same
set of updates, will be in the same state.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dist_execution<span class="main">)</span> strong_convergence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_state_id <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>received_messages <span class="free">i</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>received_messages <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state <span class="free">i</span> <span class="main">=</span> state <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> state_is_associated_string is_certified_associated_string_unique <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As we noted in Section~\ref{sec:networkModel}, we have not assumed eventual delivery, but
  a corollary of this theorem with the eventual delivery assumption implies eventual consistency.
  Since finally all peer would have received all messages, i.e., an equal set.›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Code generation›</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">integrate</span></span> <span class="quoted"><span class="quoted">create_insert</span></span> <span class="quoted"><span class="quoted">create_delete</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell
  <span class="keyword2"><span class="keyword">module_name</span></span> WOOT <span class="keyword2"><span class="keyword">file_prefix</span></span> <span class="quoted">"code"</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proof Outline\label{sec:proof_outline}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we outline and motivate the approach we took to prove the strong eventual
  consistency of WOOT.

  While introducing operation-based CRDTs Shapiro et al. also establish
  \cite{shapiro2011conflict}[Theorem 2.2]. If the following two conditions are met:
  \begin{itemize}
    \item
      Concurrent operations commute, i.e., if a pair of operations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"m<span class="hidden">⇩</span><sub>1</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"m<span class="hidden">⇩</span><sub>2</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is concurrent with respect to the order induced by the happened-before
      relation, and they are both applicable to a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the message
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"m<span class="hidden">⇩</span><sub>1</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"m<span class="hidden">⇩</span><sub>2</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) is still applicable on the state reached by
      applying  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"m<span class="hidden">⇩</span><sub>2</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"m<span class="hidden">⇩</span><sub>1</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the resulting
      states are equal.
    \item Assuming causal delivery, the messages are applicable.
  \end{itemize}
  Then the CRDT has strong convergence.
  The same authors extend the above result in \cite[Proposition 2.2]{shapiro:inria-00555588}
  to more general delivery orders $\xrightarrow{d}$ (weaker than the one induced by the
  happened-before relation), i.e., two messages may be causally dependent but concurrent with
  respect to $\xrightarrow{d}$. Assuming operations that are concurrent with respect to
  $\xrightarrow{d}$ commute, and messages are applicable, when the
  delivery order respects $\xrightarrow{d}$ then again the CRDT has strong convergence.

  A key difficulty of the consistency proof of the WOOT framework is that the applicability
  condition for the WOOT framework has three constraints:
  \begin{enumerate}
    \item \label{en:proof:deps_are_met} Dependencies must be met.
    \item \label{en:proof:id_distinct} Identifiers must be distinct.
    \item The order must be consistent, i.e. the predecessor W-character must appear before the
      successor W-character in the state an insert message is being integrated.
  \end{enumerate}

  The first constraint is a direct consequence of the semantic causal delivery order. The uniqueness
  of identifiers can be directly established by analyzing the implementation of the message creation
  algorithms. Alternatively, Gomes et al.~\cite{gomes2017verifying} use an axiomatic approach, where
  they require the underlying network protocol to deliver messages with unique identifiers. They
  provide a formal framework in Isabelle/HOL that can be used to show consistency of arbitrary
  CRDTs. Their results could be used to establish constraints \ref{en:proof:deps_are_met} and
  \ref{en:proof:id_distinct}.

  The last constraint is the most intricate one, and forces us to use a different method to
  establish the strong eventual consistency. The fact that the order constraint is fulfilled is a
  consequence of the consistency property. But the current fundamental lemmas require applicability
  of the operations in the first place to establish consistency, which would result in a circular
  argument.

  Zeller et. al. actually predict the above circumstance in the context of state-based CRDTs
  \cite{DBLP:conf/forte/ZellerBP14}:
  \begin{displayquote}
  In theory it could even be the case that there are two reachable states for which the merge
  operation does not yield the correct result, but where the two states can never be reached in the
  same execution.
  \end{displayquote}

  Because of the above, we treat WOOT as a distributed message passing algorithm and show
  convergence by establishing a global invariant, which is maintained during the execution of the
  framework. The invariant captures that the W-characters appear in the same order on all peers.
  It has strong convergence as a consequence, in the special case, when peers have received
  the same set of updates. It also implies that the generated messages will be applicable.

  \begin{figure}
    \centering
    \begin{tikzpicture}[
      statenode/.style={circle, draw=black, fill=black!20, thick, minimum size=5mm},
      curstatenode/.style={circle, draw=black, fill=black!60, thick, minimum size=5mm},
      peernode/.style={rectangle, draw=black, thick, minimum size=5mm},
    ]
    %Nodes
    \node[peernode] (peerA) at (1.5cm, 3cm) {Peer A};
    \node[peernode] (peerB) at (1.5cm, 2cm) {Peer B};
    \node[peernode] (peerC) at (1.5cm, 1cm) {Peer C};
    \node[statenode] (stateA2) at (4cm, 3cm) {};
    \node[curstatenode] (stateB2) at (5cm, 2cm) {};
    \node[statenode] (stateC2) at (3.5cm, 1cm) {};
    \node[statenode] (stateA3) at (5.5cm, 3cm) {};
    \node[statenode] (stateB3) at (7cm, 2cm) {};
    \node[statenode] (stateC3) at (6.5cm, 1cm) {};
    \node[statenode] (stateA4) at (7.5cm, 3cm) {};
    \draw[-&gt;] (peerA.east) -- (stateA2.west);
    \draw[-&gt;] (peerB.east) -- (stateB2.west);
    \draw[-&gt;] (peerC.east) -- (stateC2.west);
    \draw[-&gt;] (stateA2.east) -- (stateA3.west);
    \draw[-&gt;] (stateB2.east) -- (stateB3.west);
    \draw[-&gt;] (stateC2.east) -- (stateC3.west);
    \draw[-&gt;] (stateC2) -- (stateA2);
    \draw[-&gt;] (stateC2) -- (stateB2);
    \draw[-&gt;] (stateA3) -- (stateC3);
    \draw[-&gt;] (stateA3) -- (stateB3);
    \draw[-&gt;] (stateA3) -- (stateA4);
    \draw (5cm,3.5cm) to[bend right] (4.8cm,0.5cm);
    \end{tikzpicture}
    \caption{Example state graph, where the consistency is established left of the bend curve.}
    \label{fig:state_graph}
  \end{figure}

  In Figure~\ref{fig:state_graph}, we exemplify an induction step in a proof over the execution
  of the framework. The invariant is established for all states left of the dashed lines, and we
  show that it remains true if we include the state, drawn in dark gray. Note that induction
  proceeds in an order consistent with the happened-before relation.

  The technique we are using is to define a relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">is_associated_string</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from a set of
  messages to the final state their application leads to. Crucially, that relation can be defined
  in a message-order independent way. We show that it correctly models the behaviour of Algorithm
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"integrate"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by establishing that applying the integration algorithm to the associated
  string of a set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> leads to the associated string of the set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∪</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">m</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  in Proposition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] integrate_insert_commute<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  We also show that at most one <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> fulfills <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"is_associated_string <span class="free"><span class="free">M</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  which automatically implies commutativity (cf. Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "associated_string_unique"<span class="antiquote"><span class="antiquote">}</span></span></span></span>).

  Note that the domain of the relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"is_associated_string"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> consists of the sets of
  messages that we call <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"consistent"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We show that, in every state of a peer, the set of
  received messages will be consistent.
  The main ingredient required for the definition of a consistent set of messages as the relation
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"is_associated_string"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are \emph{sort keys} associated to the W-characters, which we will
  explain in the following Section.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Sort Keys ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  There is an implicit sort key, which is deterministically computable, using the immutable data
  associated to a W-character and the data of the W-characters it (transitively) depends on.

  We show that Algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"integrate"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> effectively maintains the W-characters ordered with
  respect to that sort key, which is the reason we can construct the mapping
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"is_associated_string"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a message-order
  independent way. An alternative viewpoint would be to see Algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"integrate_insert"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as
  an optimized version of a more mundane algorithm, that just inserts the W-characters using this
  implicit sort key.

  Since the sort key is deterministically computable using the immutable data associated to a
  W-character and the data of the W-characters it (transitively) depends on, all peers could
  perform this computation independently, which leads to the conclusion that the W-characters
  will be ordered consistently across all peers.

  The construction relies on a combinator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that computes the sort key for a
  W-character, and which requires as input:
  \begin{itemize}
    \item The unique identifier associated to a W-character.
    \item The sort keys of the predecessor/successor W-characters.
  \end{itemize}
  Its values are elements of a totally ordered space.

  Note that the predecessor (resp. successor) W-character of a W-character is the W-character that
  was immediately before (resp. after) it at the time it was inserted. Like its unique identifier,
  it is immutable data associated with that W-character. Sometimes a W-character is inserted at the
  beginning (resp. end) of the string. For those W-characters, we use the special smallest
  (resp. largest) sort keys, denoted by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊢</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊣</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) as predecessor
  (resp. successor). These keys themselves are never associated to a W-character.

  We will write <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the value computed by the combinator for a W-character
  with identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, assuming the sort key of its predecessor (resp. successor) is
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (resp. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).

  For example, the sort key for a W-character with identifier <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> inserted in an empty
  string (hence its predecessor is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊢</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and its successor is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⊣</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) 
  will be  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⊢</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">⊣</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. A W-character
  inserted between that character and the end of the string, with identifier j, would be assigned
  the sort key <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟦</span></span>Ψ <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⊢</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">⊣</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">⟧</span></span><span class="main"><span class="main">,</span></span><span class="main"><span class="main">⊣</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  The sort key needs to fulfill a couple of properties, to be useful:

  There should never be a pair of W-characters with the same sort key. Note, if this happens, even
  if those W-characters were equal or ordered consistently, we would not be able to insert a new
  W-character between those W-characters.

  Since the W-characters have themselves unique identifiers, a method to insure the above property
  is to require that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be injective with respect to the identifier of the W-character
  it computes a sort key for, i.e.,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">i</span></span> <span class="main"><span class="main">=</span></span> Ψ <span class="main"><span class="main">(</span></span><span class="free"><span class="free">l'</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">u'</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">i'</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">i</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">i'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  Another essential property is that the W-characters with predecessor having the sort key
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and successor having the sort key <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>  should have a sort key that is between
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, such that the W-character is inserted between the preceding and
  succeeding W-character, i.e., <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"l &lt; Ψ (l,u) i &lt; u"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  This latter property ensures intention preservation, i.e. the inserted W-character will be placed
  at the place the user intended.

  If we review function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"concurrent"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then we see that the algorithm compares W-characters
  by identifier, in the special case, when the inserted W-character is compared to a W-character
  whose predecessor and successor are outside of the range it is to be inserted in. A careful
  investigation, leads to the conclusion that:

  If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"l ≤ l' &lt; Ψ (l,u) i &lt; u' ≤ u"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Ψ(l,u) i"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be compared
  with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Ψ(l',u') i'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by comparing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"i"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"i'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e.:
  \begin{itemize}
    \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"i &lt; i' ⟹ Ψ (l,u) i &lt; Ψ(l',u') i'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  \end{itemize}

  In Section \ref{sec:psi} we show that a combinator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the above properties can
  be constructed (cf. Propositions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] psi_narrow psi_mono psi_elem<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
  Using the sort keys we can define the notion of a consistent set of messages as well as the
  relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"is_associated_string"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a message-order independent way.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Induction ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have a couple of criteria that define a consistent set of messages:

  \begin{itemize}
    \item Each insert message in the set has a unique identifier.
    \item If a message depends on another message identifier, a message with that identifier will
      be present. Note that for insert messages, these are the predecessor/successor W-characters
      if present. For delete messages it is the corresponding insert message.
    \item The dependencies form a well-order, i.e., there is no dependency cycle.
    \item It is possible to assign sort keys to each insert message, such that
      the assigned sort key for each insert message is equal to the value returned by the
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Ψ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for it, using the associated sort keys of its predecessor and successors,
      i.e.,
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span>P <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span>S <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span>
              <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⟦</span></span>I <span class="free"><span class="free">m</span></span><span class="main"><span class="main">⟧</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⟦</span></span>Ψ <span class="main"><span class="main">(</span></span><span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span>P <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span>S <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>I <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">⟧</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
      Note that we also require that sort key of the predecessor is smaller than the sort key of the
      successor.
  \end{itemize}

  The relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"is_associated_string"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is then defined by ordering the insert messages
  according to the assigned sort keys above and marking W-characters, for which there are delete
  messages as deleted.

  The induction proof (Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] dist_execution.sent_messages_consistent<span class="antiquote"><span class="antiquote">}</span></span></span></span>) over the
  states of the framework is straight forward: Using Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] top_sort<span class="antiquote"><span class="antiquote">}</span></span></span></span> we find a
  possible order of the states consistent with the happened before relation. The induction invariant
  is that the set of generated messages by all peers is
  consistent (independent of whether they have been received by all peers (yet)). The latter also
  implies that the subset a peer has received in any of those states is consistent, using the
  additional fact that each messages dependencies will be delivered before the message itself
  (see also Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] consistent_subset<span class="antiquote"><span class="antiquote">}</span></span></span></span> and
  Proposition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] integrate_insert_commute'<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
  For the induction step, we rely on the results from Section \ref{sec:create_consistent} that any
  additional created messages will keep the set of messages consistent and that the peers' states
  will be consistent with the (consistent subset of) messages they received (Lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source]
  dist_execution.state_is_associated_string'<span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Example">
<div class="head">
<h1>Theory Example</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Example\label{sec:example}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Example
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SEC.html">SEC</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we formalize the example from Figure \ref{fig:session} for a possible run of 
the WOOT framework with three peers, each performing an edit operation. We verify that it fulfills
the conditions of the locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> dist_execution<span class="antiquote"><span class="antiquote">}</span></span></span></span> and apply the theorems.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> example_peers
  <span class="main">=</span> PeerA
  <span class="main">|</span> PeerB
  <span class="main">|</span> PeerC
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">example_peers</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">example_events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers <span class="main">⇒</span> <span class="main">(</span>example_peers<span class="main">,</span> char<span class="main">)</span> event list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">example_events</span> PeerA <span class="main">=</span> <span class="main">[</span>
      Send <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⟦</span><span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>  <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''R''</span><span class="main">)</span><span class="main">)</span>
  <span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">example_events</span> PeerB <span class="main">=</span> <span class="main">[</span>
      Send <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⟦</span><span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>  <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''R''</span><span class="main">)</span><span class="main">)</span>
  <span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">example_events</span> PeerC <span class="main">=</span> <span class="main">[</span>
      Receive <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Send <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⟦</span><span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>  <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''R''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⟦</span><span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>  <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''R''</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      Receive <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span><span class="main">)</span><span class="main">)</span>
  <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">example_events</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> returns the sequence of events that each 
peer evaluates. We instantiate the preliminary context by showing that the set of 
peers is finite.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> example<span class="main">:</span> dist_execution_preliminary <span class="quoted"><span class="quoted">"example_events"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="main">{</span>PeerA<span class="main">,</span> PeerB<span class="main">,</span> PeerC<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> example_events.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> example_peers set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>a<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To prove that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">happened_before</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> relation is acyclic, we provide an  order on the state
  that is consistent with it, i.e.:
  \begin{itemize}
  \item  The assigned indicies for
  successive states of the same peer are increasing.
  \item The assigned index of a state receiving a message is 
    larger than the assigned index of the messages source state.
  \end{itemize}
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">witness_acyclic_events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers event_id <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">7</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">8</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">9</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">8</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">9</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_acyclic_events</span> <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To prove that the created messages make sense, we provide the edit operation
  that results with it. The first function is the inserted letter and the second
  function is the position the letter was inserted.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">witness_create_letter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers event_id <span class="main">⇒</span> char"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">witness_create_letter</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_create_letter</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_create_letter</span> <span class="main">(</span>PeerC<span class="main">,</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''R''</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">witness_create_position</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers event_id <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">witness_create_position</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_create_position</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_create_position</span> <span class="main">(</span>PeerC<span class="main">,</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To prove that dependencies of a message are received before a message, we
  provide the event id as well as the message, when the peer received a 
  messages dependency.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">witness_deps_received_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers event_id <span class="main">⇒</span> example_peers event_id <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_deps_received_at</span> <span class="main">(</span>PeerA<span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_deps_received_at</span> <span class="main">(</span>PeerB<span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_deps_received_at</span> <span class="main">(</span>PeerC<span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">witness_deps_received_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers event_id <span class="main">⇒</span> example_peers event_id <span class="main">⇒</span> <span class="main">(</span>example_peers event_id<span class="main">,</span> char<span class="main">)</span> insert_message"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_deps_received_is</span> <span class="main">(</span>PeerA<span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_deps_received_is</span> <span class="main">(</span>PeerB<span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">witness_deps_received_is</span> <span class="main">(</span>PeerC<span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Example-well_order_consistent"><span class="command">lemma</span></span> well_order_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">j</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"example.happened_immediately_before <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"witness_acyclic_events <span class="free">i</span> <span class="main">&lt;</span> witness_acyclic_events <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we show that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">example_events</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> meet the assumptions
  for the distributed execution context.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> example<span class="main">:</span> dist_execution <span class="quoted"><span class="quoted">"example_events"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">s</span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"dist_execution_preliminary.event_at example_events <span class="skolem">i</span> <span class="main">(</span>Receive <span class="skolem">s</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
     dist_execution_preliminary.event_at example_events <span class="skolem">s</span> <span class="main">(</span>Send <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"example_peers event_id"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"example.event_at <span class="skolem">i</span> <span class="main">(</span>Receive <span class="skolem">s</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
       example.event_at <span class="skolem">j</span> <span class="main">(</span>Receive <span class="skolem">s</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="skolem">i</span> <span class="main">=</span> fst <span class="skolem">j</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">j</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>inv_image <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span> witness_acyclic_events<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> example.happened_immediately_before <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">≤</span>
    inv_image <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span> witness_acyclic_events"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> well_order_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP example.happened_immediately_before"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> well_order_consistent wfP_def wf_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"acyclicP example.happened_immediately_before"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wfP_acyclicP <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">s</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">i'</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"example.event_at <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>Receive <span class="skolem">s</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="skolem">i'</span> <span class="main">∈</span> deps <span class="skolem">m</span> <span class="main">⟹</span>
      example.event_at <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> witness_deps_received_at <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>Receive <span class="main">(</span>I <span class="main">(</span>witness_deps_received_is <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Insert <span class="main">(</span>witness_deps_received_is <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> witness_deps_received_at <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> I <span class="main">(</span>witness_deps_received_is <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"example.event_at <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>Receive <span class="skolem">s</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
       <span class="skolem">i'</span> <span class="main">∈</span> deps <span class="skolem">m</span> <span class="main">⟹</span>
       <span class="main">∃</span><span class="bound">s'</span> <span class="bound">j'</span> <span class="bound">m'</span><span class="main">.</span>
          example.event_at <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">j'</span><span class="main">)</span> <span class="main">(</span>Receive <span class="bound">s'</span> <span class="main">(</span>Insert <span class="bound">m'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> I <span class="bound">m'</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"example.event_at <span class="skolem">i</span> <span class="main">(</span>Send <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
        Inr <span class="skolem">m</span> <span class="main">=</span> example.state <span class="skolem">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_insert <span class="bound">s</span> <span class="main">(</span>witness_create_position <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>witness_create_letter <span class="skolem">i</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> witness_acyclic_events.cases <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"example.event_at <span class="skolem">i</span> <span class="main">(</span>Send <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">σ</span><span class="main">.</span> return <span class="skolem">m</span> <span class="main">=</span> example.state <span class="skolem">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_insert <span class="bound">s</span> <span class="bound">n</span> <span class="bound">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
           <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> return <span class="skolem">m</span> <span class="main">=</span> example.state <span class="skolem">i</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> create_delete <span class="bound">s</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As expected all peers reach the same final state.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"example.state <span class="main">(</span>PeerA<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">[</span>
    InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="main">(</span>Some <span class="keyword1">CHR</span> <span class="inner_quoted">''B''</span><span class="main">)</span><span class="main">,</span>
    InsertMessage <span class="main">⊢</span> <span class="main">(</span>PeerB<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊣</span> <span class="main">(</span>Some <span class="keyword1">CHR</span> <span class="inner_quoted">''A''</span><span class="main">)</span><span class="main">,</span>
    InsertMessage <span class="main">⟦</span><span class="main">(</span>PeerA<span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>  <span class="main">(</span>PeerC<span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊣</span> <span class="main">(</span>Some <span class="keyword1">CHR</span> <span class="inner_quoted">''R''</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"example.state <span class="main">(</span>PeerA<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">=</span> example.state <span class="main">(</span>PeerB<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"example.state <span class="main">(</span>PeerB<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">=</span> example.state <span class="main">(</span>PeerC<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>substr_simp <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ext_ids_def substr.simps less_example_peers_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also derive the equivalence of states using the strong
  convergence theorem. For example the set of received messages in
  the third state of peer A and B is equivalent, even though they were
  not received in the same order:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"example.state <span class="main">(</span>PeerA<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> example.state <span class="main">(</span>PeerB<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"example.is_valid_state_id <span class="main">(</span>PeerA<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"example.is_valid_state_id <span class="main">(</span>PeerB<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>example.received_messages <span class="main">(</span>PeerA<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     set <span class="main">(</span>example.received_messages <span class="main">(</span>PeerB<span class="main">,</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> example.strong_convergence<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similarly we can conclude that reached states are successful.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>example.state <span class="main">(</span>PeerC<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"example.is_valid_state_id <span class="main">(</span>PeerC<span class="main">,</span> <span class="numeral">4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> example.no_failure<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>