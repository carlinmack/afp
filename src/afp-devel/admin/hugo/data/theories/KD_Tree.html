<div id="KD_Tree">
<div class="head">
<h1>Theory KD_Tree</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     KD_Tree.thy
  Author:   Martin Rau, TU München
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Definition of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree"</span></span>

<span class="keyword1"><span class="command">theory</span></span> KD_Tree
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Finite_Cartesian_Product.html">HOL-Analysis.Finite_Cartesian_Product</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Topology_Euclidean_Space.html">HOL-Analysis.Topology_Euclidean_Space</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d tree is a space-partitioning data structure for organizing points in a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-dimensional space.
  In principle the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d tree is a binary tree. The leafs hold the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-dimensional points and the nodes
  contain left and right subtrees as well as a discriminator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> at a particular axis <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
  Every node divides the space into two parts by splitting along a hyperplane.
  Consider a node <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> with associated discriminator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> at axis <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
  All points in the left subtree must have a value at axis <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> that is less than or
  equal to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> and all points in the right subtree must have a value at axis <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> that is
  greater than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.

  Deviations from the papers:

  The chosen tree representation is taken from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "DBLP:journals/toms/FriedmanBF77"<span class="antiquote"><span class="antiquote">}</span></span></span></span> with one minor
  adjustment. Originally the leafs hold buckets of points of size <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span>. This representation fixes the
  bucket size to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b = 1›</span></span></span></span>, a single point per Leaf. This is only a minor adjustment since the paper
  proves that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b = 1›</span></span></span></span> is the optimal bucket size for minimizing the running time of the nearest neighbor
  algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "DBLP:journals/toms/FriedmanBF77"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, only simplifies building the optimized
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d trees <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "DBLP:journals/toms/FriedmanBF77"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and has little influence on the
  search algorithm <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "DBLP:journals/cacm/Bentley75"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'k</span> point <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real<span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> vec"</span></span>

<span class="keyword1" id="KD_Tree-dist_point_def"><span class="command">lemma</span></span> dist_point_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">.</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">-</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="bound">k</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dist_vec_def L2_set_def dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'k</span> kdt <span class="main">=</span>
  Leaf <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> point"</span></span>
<span class="main">|</span> Node <span class="tfree"><span class="quoted"><span class="tfree">'k</span></span></span> <span class="quoted">real</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree Invariant and Related Functions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">set_kdt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span> point<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_kdt</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">set_kdt</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">set_kdt</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">set_kdt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spread</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> point set <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spread</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">in</span> Max <span class="bound">V</span> <span class="main">-</span> Min <span class="bound">V</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">widest_spread_axis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> set <span class="main">⇒</span> <span class="tfree">'k</span> point set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">widest_spread_axis</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">.</span> spread <span class="bound">k'</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≤</span> spread <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> kdt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span>
    widest_spread_axis <span class="free"><span class="bound"><span class="entity">k</span></span></span> UNIV <span class="main">(</span>set_kdt <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> set_kdt <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">invar</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">invar</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_kdt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size_kdt</span> <span class="main">(</span>Leaf <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size_kdt</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size_kdt</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">size_kdt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">height</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Leaf <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">height</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">height</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">min_height</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_height</span> <span class="main">(</span>Leaf <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_height</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span><span class="free">min_height</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">min_height</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">balanced</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">balanced</span> <span class="free"><span class="bound"><span class="entity">kdt</span></span></span> <span class="main">⟷</span> height <span class="free"><span class="bound"><span class="entity">kdt</span></span></span> <span class="main">-</span> min_height <span class="free"><span class="bound"><span class="entity">kdt</span></span></span> <span class="main">≤</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">complete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> kdt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">complete</span> <span class="main">(</span>Leaf <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">complete</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">complete</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">complete</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1" id="KD_Tree-invar_l"><span class="command">lemma</span></span> invar_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> invar <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KD_Tree-invar_r"><span class="command">lemma</span></span> invar_r<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> invar <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KD_Tree-invar_l_le_k"><span class="command">lemma</span></span> invar_l_le_k<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free">l</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KD_Tree-invar_r_ge_k"><span class="command">lemma</span></span> invar_r_ge_k<span class="main">:</span>
  <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free">r</span><span class="main">.</span> <span class="free">v</span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KD_Tree-invar_set"><span class="command">lemma</span></span> invar_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_kdt <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> set_kdt <span class="free">l</span> <span class="main">∪</span> set_kdt <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas adapted from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOL-Library.Tree›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree›</span></span>

<span class="keyword1" id="KD_Tree-size_ge0"><span class="command">lemma</span></span> size_ge0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> size_kdt <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-eq_size_1"><span class="command">lemma</span></span> eq_size_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> size_ge0 nat_less_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="KD_Tree-eq_1_size"><span class="command">lemma</span></span> eq_1_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> size_kdt <span class="free">kdt</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_size_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="KD_Tree-neq_Leaf_iff"><span class="command">lemma</span></span> neq_Leaf_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">v</span> <span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Node <span class="bound">k</span> <span class="bound">v</span> <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-eq_height_0"><span class="command">lemma</span></span> eq_height_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"height <span class="free">kdt</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-eq_0_height"><span class="command">lemma</span></span> eq_0_height<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> height <span class="free">kdt</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-eq_min_height_0"><span class="command">lemma</span></span> eq_min_height_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-eq_0_min_height"><span class="command">lemma</span></span> eq_0_min_height<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> min_height <span class="free">kdt</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-size_height"><span class="command">lemma</span></span> size_height<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">≤</span> height <span class="skolem">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> size_kdt <span class="skolem">l</span> <span class="main">+</span> size_kdt <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def mult_2<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> size_kdt <span class="skolem">l</span> <span class="main">+</span> size_kdt <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def mult_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KD_Tree-min_height_le_height"><span class="command">lemma</span></span> min_height_le_height<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span> <span class="main">≤</span> height <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-min_height_size"><span class="command">lemma</span></span> min_height_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> min_height <span class="free">kdt</span> <span class="main">≤</span> size_kdt <span class="free">kdt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> size_kdt <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="KD_Tree-complete_iff_height"><span class="command">lemma</span></span> complete_iff_height<span class="main">:</span>
  <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span> <span class="main">⟷</span> <span class="main">(</span>min_height <span class="free">kdt</span> <span class="main">=</span> height <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_antisym le_trans min_height_le_height<span class="main">)</span>

<span class="keyword1" id="KD_Tree-size_if_complete"><span class="command">lemma</span></span> size_if_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span> <span class="main">⟹</span> size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="KD_Tree-complete_if_size_height"><span class="command">lemma</span></span> complete_if_size_height<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span> <span class="main">⟹</span> complete <span class="free">kdt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"height <span class="free">kdt</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">kdt</span> <span class="main">=</span> Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neq_Leaf_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span> <span class="main">≤</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> height <span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">kdt</span> <span class="main">=</span> size_kdt <span class="skolem">l</span> <span class="main">+</span> size_kdt <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> size_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size_kdt <span class="skolem">kdt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">kdt</span> <span class="main">&lt;</span> size_kdt <span class="skolem">kdt</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> height <span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">kdt</span> <span class="main">=</span> size_kdt <span class="skolem">l</span> <span class="main">+</span> size_kdt <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> size_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size_kdt <span class="skolem">kdt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">kdt</span> <span class="main">&lt;</span> size_kdt <span class="skolem">kdt</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 4 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">l</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> size_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> size_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * Suc<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KD_Tree-complete_if_size_min_height"><span class="command">lemma</span></span> complete_if_size_min_height<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="free">kdt</span> <span class="main">⟹</span> complete <span class="free">kdt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">kdt</span> <span class="main">=</span> Leaf <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">kdt</span> <span class="main">=</span> Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> neq_Leaf_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> min_height <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≤</span> min_height <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">h</span> <span class="main">&lt;</span> min_height <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">&lt;</span> min_height <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">kdt</span> <span class="main">=</span> size_kdt <span class="skolem">l</span> <span class="main">+</span> size_kdt <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> min_height_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> min_height_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="skolem">l</span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_less_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="skolem">r</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size_kdt <span class="skolem">kdt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">h</span> <span class="main">&lt;</span> min_height <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">&lt;</span> min_height <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">kdt</span> <span class="main">=</span> size_kdt <span class="skolem">l</span> <span class="main">+</span> size_kdt <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> min_height_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> min_height_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="skolem">r</span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_less_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="skolem">l</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span><span class="main">(</span>xtrans<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size_kdt <span class="skolem">kdt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 4 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"min_height <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="quoted"><span class="quoted">"min_height <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">l</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> min_height_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> min_height_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * Suc<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_iff_height<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KD_Tree-complete_iff_size"><span class="command">lemma</span></span> complete_iff_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span> <span class="main">⟷</span> size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complete_if_size_height size_if_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KD_Tree-size_height_if_incomplete"><span class="command">lemma</span></span> size_height_if_incomplete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> complete <span class="free">kdt</span> <span class="main">⟹</span> size_kdt <span class="free">kdt</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> antisym_conv complete_iff_size not_le size_height<span class="main">)</span>

<span class="keyword1" id="KD_Tree-min_height_size_if_incomplete"><span class="command">lemma</span></span> min_height_size_if_incomplete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> complete <span class="free">kdt</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="free">kdt</span> <span class="main">&lt;</span> size_kdt <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> complete_if_size_min_height le_less min_height_size<span class="main">)</span>

<span class="keyword1" id="KD_Tree-balanced_subtreeL"><span class="command">lemma</span></span> balanced_subtreeL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> balanced <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_def<span class="main">)</span>

<span class="keyword1" id="KD_Tree-balanced_subtreeR"><span class="command">lemma</span></span> balanced_subtreeR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> balanced <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_def<span class="main">)</span>

<span class="keyword1" id="KD_Tree-balanced_optimal"><span class="command">lemma</span></span> balanced_optimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">≤</span> size_kdt <span class="free">kdt'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">kdt</span> <span class="main">≤</span> height <span class="free">kdt'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> height <span class="free">kdt</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span> <span class="main">=</span> size_kdt <span class="free">kdt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_iff_height size_if_complete<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> size_kdt <span class="free">kdt'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> size_height<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="free">kdt</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="free">kdt</span> <span class="main">&lt;</span> size_kdt <span class="free">kdt</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> min_height_size_if_incomplete<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> size_kdt <span class="free">kdt'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt'</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> size_height<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> min_height <span class="free">kdt</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> height <span class="free">kdt'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span> <span class="main">&lt;</span> height <span class="free">kdt'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> height <span class="free">kdt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_height_le_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_iff_height balanced_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas adapted from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOL-Library.Tree_Real›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree›</span></span>

<span class="keyword1" id="KD_Tree-size_height_log"><span class="command">lemma</span></span> size_height_log<span class="main">:</span>
  <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span> <span class="main">≤</span> height <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log2_of_power_le size_height<span class="main">)</span>

<span class="keyword1" id="KD_Tree-min_height_size_log"><span class="command">lemma</span></span> min_height_size_log<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_log2_of_power min_height_size<span class="main">)</span>

<span class="keyword1" id="KD_Tree-size_log_if_complete"><span class="command">lemma</span></span> size_log_if_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span> <span class="main">⟹</span> height <span class="free">kdt</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complete_iff_size log2_of_power_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="KD_Tree-min_height_size_log_if_incomplete"><span class="command">lemma</span></span> min_height_size_log_if_incomplete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> complete <span class="free">kdt</span> <span class="main">⟹</span> min_height <span class="free">kdt</span> <span class="main">&lt;</span> log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_log2_of_power min_height_size_if_incomplete<span class="main">)</span>

<span class="keyword1" id="KD_Tree-min_height_balanced"><span class="command">lemma</span></span> min_height_balanced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">kdt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_height <span class="free">kdt</span> <span class="main">=</span> nat<span class="main">(</span>floor<span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> min_height <span class="free">kdt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complete_iff_height size_if_complete<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> log2_of_power_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> complete <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"height <span class="free">kdt</span> <span class="main">=</span> min_height <span class="free">kdt</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms min_height_le_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_def complete_iff_height<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>min_height <span class="free">kdt</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * size_height_if_incomplete<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span> <span class="main">&lt;</span> min_height <span class="free">kdt</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> log2_of_power_less size_ge0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> min_height_size_log<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KD_Tree-height_balanced"><span class="command">lemma</span></span> height_balanced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">kdt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">kdt</span> <span class="main">=</span> nat<span class="main">(</span>ceiling<span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_if_complete<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> log2_of_power_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> complete <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="free">kdt</span> <span class="main">=</span> min_height <span class="free">kdt</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms min_height_le_height<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_def complete_iff_height<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>min_height <span class="free">kdt</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_height<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span>  log2_of_power_le<span class="main">[</span><span class="operator">OF</span> this size_ge0<span class="main">]</span> min_height_size_log_if_incomplete<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> **
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KD_Tree-balanced_Node_if_wbal1"><span class="command">lemma</span></span> balanced_Node_if_wbal1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">l</span> <span class="main">=</span> size_kdt <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">l</span> <span class="main">=</span> size_kdt <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span>log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_kdt <span class="free">r</span><span class="main">)</span><span class="main">⌉</span> <span class="main">≥</span> nat <span class="main">⌈</span>log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">r</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> nat_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ceiling_mono<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"height<span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">⌈</span>log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_kdt <span class="free">r</span><span class="main">)</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> height_balanced<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> height_balanced<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nat_ceiling_le_eq <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> size_kdt <span class="free">r</span><span class="main">)</span><span class="main">⌋</span> <span class="main">≥</span> nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">r</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> nat_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> floor_mono<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"min_height<span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="main">(</span>size_kdt <span class="free">r</span><span class="main">)</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_height_balanced<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> min_height_balanced<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">r</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">≤</span> size_kdt <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">r</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_power_ivl1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">&lt;</span> size_kdt <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 floor_log_nat_eq_if<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> ceiling_log_nat_eq_if<span class="main">[</span><span class="operator">OF</span> i1<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>balanced_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="KD_Tree-balanced_sym"><span class="command">lemma</span></span> balanced_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> balanced <span class="main">(</span>Node <span class="free">k'</span> <span class="free">v'</span> <span class="free">r</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> balanced_def<span class="main">)</span>

<span class="keyword1" id="KD_Tree-balanced_Node_if_wbal2"><span class="command">lemma</span></span> balanced_Node_if_wbal2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"abs<span class="main">(</span>int<span class="main">(</span>size_kdt <span class="free">l</span><span class="main">)</span> <span class="main">-</span> int<span class="main">(</span>size_kdt <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">l</span> <span class="main">=</span> size_kdt <span class="free">r</span> <span class="main">∨</span> <span class="main">(</span>size_kdt <span class="free">l</span> <span class="main">=</span> size_kdt <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> size_kdt <span class="free">r</span> <span class="main">=</span> size_kdt <span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∨</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_def min_def max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> balanced_optimal le_antisym le_less<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> balanced_sym balanced_Node_if_wbal1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Build">
<div class="head">
<h1>Theory Build</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Build.thy
  Author:   Martin Rau, TU München
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Building a balanced <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree from a List of Points›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Build
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="KD_Tree.html">KD_Tree</a>
  <a href="../Median_Of_Medians_Selection/Median_Of_Medians_Selection.html">Median_Of_Medians_Selection.Median_Of_Medians_Selection</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Build a balanced <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree by recursively partition the points into two lists.
  The partitioning criteria will be the median at a particular axis <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>.
  The left list will contain all points <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span><span class="main"><span class="main">$</span></span><span class="free"><span class="free">k</span></span> <span class="main"><span class="main">≤</span></span> median"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The right list will contain all points with median at axis <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"median <span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">$</span></span><span class="free"><span class="free">k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  The left and right list differ in length by one or none.
  The axis <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> will the widest spread axis.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary Lemmas"</span></span>

<span class="keyword1" id="Build-length_filter_mset_sorted_nth"><span class="command">lemma</span></span> length_filter_mset_sorted_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">#}</span> <span class="main">=</span> mset <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> filter_mset_is_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Build-length_filter_sort_nth"><span class="command">lemma</span></span> length_filter_sort_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> sort <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> sort <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> sort <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_sort<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size <span class="main">(</span>mset <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> sort <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_mset <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size <span class="main">(</span><span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> sort <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mset_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> size <span class="main">(</span>mset <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_filter_mset_sorted_nth assms sorted_sort distinct_sort length_sort <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Widest Spread Axis›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">calc_spread</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">calc_spread</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="bound">ps</span> <span class="main">⇒</span>
    <span class="keyword1">let</span> <span class="bound">ks</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">ps</span><span class="main">)</span> <span class="keyword1">in</span>
    fold max <span class="bound">ks</span> <span class="main">(</span><span class="main">(</span>hd <span class="bound">ps</span><span class="main">)</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">-</span> fold min <span class="bound">ks</span> <span class="main">(</span><span class="main">(</span>hd <span class="bound">ps</span><span class="main">)</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">widest_spread</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">×</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">widest_spread</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">widest_spread</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> calc_spread <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">widest_spread</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">=</span> <span class="free">widest_spread</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> calc_spread <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">s</span> <span class="main">≤</span> <span class="bound">s'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Build-calc_spread_spec"><span class="command">lemma</span></span> calc_spread_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"calc_spread <span class="free">k</span> <span class="free">ps</span> <span class="main">=</span> spread <span class="free">k</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max.set_eq_fold<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="free">ps</span><span class="main">)</span><span class="main">$</span><span class="free">k</span>"</span></span><span class="main">]</span> Min.set_eq_fold<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="free">ps</span><span class="main">)</span><span class="main">$</span><span class="free">k</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def spread_def calc_spread_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> set_map<span class="main">)</span>

<span class="keyword1" id="Build-widest_spread_calc_spread"><span class="command">lemma</span></span> widest_spread_calc_spread<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ks</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> calc_spread <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> widest_spread.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>

<span class="keyword1" id="Build-widest_spread_axis_Un"><span class="command">lemma</span></span> widest_spread_axis_Un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"widest_spread_axis <span class="free">k</span> <span class="free">K</span> <span class="free">P</span> <span class="main">⟹</span> spread <span class="free">k'</span> <span class="free">P</span> <span class="main">≤</span> spread <span class="free">k</span> <span class="free">P</span> <span class="main">⟹</span> widest_spread_axis <span class="free">k</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">k'</span> <span class="main">}</span><span class="main">)</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"widest_spread_axis <span class="free">k</span> <span class="free">K</span> <span class="free">P</span> <span class="main">⟹</span> spread <span class="free">k</span> <span class="free">P</span> <span class="main">≤</span> spread <span class="free">k'</span> <span class="free">P</span> <span class="main">⟹</span> widest_spread_axis <span class="free">k'</span> <span class="main">(</span><span class="free">K</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">k'</span> <span class="main">}</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> widest_spread_axis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Build-widest_spread_spec"><span class="command">lemma</span></span> widest_spread_spec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="free">ps</span> <span class="main">⟹</span> widest_spread_axis <span class="free">k</span> <span class="main">(</span>set <span class="free">ks</span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> widest_spread.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ks</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">K'</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> K'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">K'</span><span class="main">,</span> <span class="skolem">S'</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="main">(</span><span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"widest_spread_axis <span class="skolem">K'</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> spread <span class="skolem">K'</span> <span class="main">(</span>set <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K'_def widest_spread_calc_spread calc_spread_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> calc_spread <span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> spread <span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>set <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calc_spread_spec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≤</span> <span class="skolem">S'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"widest_spread_axis <span class="skolem">K'</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 1 widest_spread_axis_Un<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IH<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True K'_def S_def <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"widest_spread_axis <span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 0 1 widest_spread_axis_Un<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> IH<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False K'_def S_def <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> widest_spread_axis_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fast Axis Median›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">axis_median</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">axis_median</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">in</span> fast_select <span class="bound">n</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Build-length_filter_le_axis_median"><span class="command">lemma</span></span> length_filter_le_axis_median<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> axis_median <span class="free">k</span> <span class="free">ps</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">ps</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ps</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fast_select <span class="var">?n</span> <span class="var">?ps</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> length <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">=</span> select <span class="var">?n</span> <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fast_select_correct<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> axis_median <span class="free">k</span> <span class="free">ps</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span>
        length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> sort <span class="var">?ps</span> <span class="main">!</span> <span class="var">?n</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> axis_median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def select_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fast_select.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≤</span> sort <span class="var">?ps</span> <span class="main">!</span> <span class="var">?n</span><span class="main">)</span> <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> comp_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_filter_sort_nth<span class="main">[</span><span class="operator">OF</span> 1 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition_by_median</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">×</span> real <span class="main">×</span> <span class="tfree">'k</span> point list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partition_by_median</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> axis_median <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> partition <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> <span class="bound">m</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1" id="Build-set_partition_by_median"><span class="command">lemma</span></span> set_partition_by_median<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span> <span class="main">⟹</span> set <span class="free">ps</span> <span class="main">=</span> set <span class="free">l</span> <span class="main">∪</span> set <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Build-filter_partition_by_median"><span class="command">lemma</span></span> filter_partition_by_median<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">l</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">r</span><span class="main">.</span> <span class="main">¬</span><span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Build-sum_length_partition_by_median"><span class="command">lemma</span></span> sum_length_partition_by_median<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">l</span> <span class="main">+</span> length <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">$</span> <span class="free">k</span> <span class="main">≤</span> axis_median <span class="free">k</span> <span class="free">ps</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def o_def<span class="main">)</span>

<span class="keyword1" id="Build-length_l_partition_by_median"><span class="command">lemma</span></span> length_l_partition_by_median<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">ps</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def length_filter_le_axis_median<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> lengths_partition_by_median_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">-</span> length <span class="free">r</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">≤</span> length <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_l_partition_by_median<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> sum_length_partition_by_median<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> lengths_partition_by_median_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_l_partition_by_median<span class="main">[</span><span class="operator">OF</span> * assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> sum_length_partition_by_median<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> length_partition_by_median <span class="main">=</span>
  sum_length_partition_by_median length_l_partition_by_median
  lengths_partition_by_median_1 lengths_partition_by_median_2


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Building the Tree›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>domintros<span class="main">,</span> sequential<span class="main">)</span> <span class="entity">build</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> <span class="tfree">'k</span> kdt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">build</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">build</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=</span> Leaf <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">build</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    Node <span class="bound">k</span> <span class="bound">m</span> <span class="main">(</span><span class="free">build</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free">build</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1" id="Build-build_domintros3"><span class="command">lemma</span></span> build_domintros3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">s</span> <span class="skolem">l</span> <span class="skolem">m</span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="skolem">k</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build.domintros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Build-build_termination"><span class="command">lemma</span></span> build_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span> <span class="main">|</span> <span class="main">(</span>C<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">zs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> C
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xyzs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> ks_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lmr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="skolem">k</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> xyzs_def ks_def lmr_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">$</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">$</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lmr_def <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quoted">"1.prems"</span> distinct_map_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted">"1.prems"</span><span class="main">]</span> length_partition_by_median<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ <span class="quoted">"1.prems"</span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> build_domintros3 defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> build.domintros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Build-build_psimp_1"><span class="command">lemma</span></span> build_psimp_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">[</span><span class="free">p</span><span class="main">]</span> <span class="main">⟹</span> build <span class="free">k</span> <span class="free">ps</span> <span class="main">=</span> Leaf <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build.domintros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> build.psimps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Build-build_psimp_2"><span class="command">lemma</span></span> build_psimp_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"build <span class="free">ks</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> Node <span class="free">k</span> <span class="free">m</span> <span class="main">(</span>build <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>build <span class="free">ks</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms build_domintros3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> build.psimps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Build-length_xs_gt_1"><span class="command">lemma</span></span> length_xs_gt_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv<span class="main">)</span>

<span class="keyword1" id="Build-build_psimp_3"><span class="command">lemma</span></span> build_psimp_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="free">k</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"build_dom <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"build <span class="free">ks</span> <span class="free">ps</span> <span class="main">=</span> Node <span class="free">k</span> <span class="free">m</span> <span class="main">(</span>build <span class="free">ks</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>build <span class="free">ks</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> build_psimp_2 length_xs_gt_1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> build_psimps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> build_psimp_1 build_psimp_3


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Theorems›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> set_build<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟹</span> set <span class="free">ps</span> <span class="main">=</span> set_kdt <span class="main">(</span>build <span class="free">ks</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> ks_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lmr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="skolem">k</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lmr_def <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Let_def distinct_map_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
                  <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            lmr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">=</span> set_kdt <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">r</span> <span class="main">=</span> set_kdt <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">=</span> set <span class="skolem">l</span> <span class="main">∪</span> set <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lmr_def <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"build <span class="free">ks</span> <span class="skolem">ps</span> <span class="main">=</span> Node <span class="skolem">k</span> <span class="skolem">m</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> build_psimp_3<span class="main">[</span><span class="operator">OF</span> True ks_def lmr_def<span class="main">]</span> build_termination D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> invar_build<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟹</span> set <span class="free">ks</span> <span class="main">=</span> UNIV <span class="main">⟹</span> invar <span class="main">(</span>build <span class="free">ks</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> ks_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lmr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="skolem">k</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lmr_def <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Let_def distinct_map_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
                  <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            lmr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">l</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">r</span><span class="main">.</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">$</span><span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> filter_partition_by_median<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lmr_def<span class="main">]</span>
            filter_partition_by_median<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lmr_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"widest_spread_axis <span class="skolem">k</span> UNIV <span class="main">(</span>set <span class="skolem">l</span> <span class="main">∪</span> set <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> widest_spread_spec<span class="main">[</span><span class="operator">OF</span> ks_def<span class="main">]</span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> set_partition_by_median<span class="main">[</span><span class="operator">OF</span> lmr_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"build <span class="free">ks</span> <span class="skolem">ps</span> <span class="main">=</span> Node <span class="skolem">k</span> <span class="skolem">m</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> build_psimp_3<span class="main">[</span><span class="operator">OF</span> True ks_def lmr_def<span class="main">]</span> build_termination D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> set_build<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span> D<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> set_build<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">r</span>›</span></span> D<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> size_build<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟹</span> size_kdt <span class="main">(</span>build <span class="free">ks</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> ks_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lmr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="skolem">k</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lmr_def <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Let_def distinct_map_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
                  <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            lmr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"build <span class="free">ks</span> <span class="skolem">ps</span> <span class="main">=</span> Node <span class="skolem">k</span> <span class="skolem">m</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> build_psimp_3<span class="main">[</span><span class="operator">OF</span> True ks_def lmr_def<span class="main">]</span> build_termination D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lmr_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> balanced_build<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟹</span> balanced <span class="main">(</span>build <span class="free">ks</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> ks_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> widest_spread <span class="free">ks</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lmr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> partition_by_median <span class="skolem">k</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lmr_def <span class="keyword1"><span class="command">unfolding</span></span> partition_by_median_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Let_def distinct_map_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">l</span>"</span></span>
                  <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            length_partition_by_median<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            lmr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"balanced <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"build <span class="free">ks</span> <span class="skolem">ps</span> <span class="main">=</span> Node <span class="skolem">k</span> <span class="skolem">m</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>build <span class="free">ks</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> build_psimp_3<span class="main">[</span><span class="operator">OF</span> True ks_def lmr_def<span class="main">]</span> build_termination D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="skolem">l</span> <span class="main">∨</span> length <span class="skolem">r</span> <span class="main">=</span> length <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_partition_by_median<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> lmr_def<span class="main">]</span>
            length_partition_by_median<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lmr_def<span class="main">]</span>
            length_partition_by_median<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lmr_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> balanced_Node_if_wbal1<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span> balanced_Node_if_wbal2<span class="main">[</span><span class="operator">OF</span> IH<span class="main">]</span>
            size_build<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">l</span>›</span></span> D<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> size_build<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">r</span>›</span></span> D<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> balanced_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Build-complete_if_balanced_size_2powh"><span class="command">lemma</span></span> complete_if_balanced_size_2powh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"balanced <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"complete <span class="free">kdt</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> complete <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>min_height <span class="free">kdt</span><span class="main">)</span> <span class="main">&lt;</span> size_kdt <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"size_kdt <span class="free">kdt</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> height <span class="free">kdt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_height_size_if_incomplete size_height_if_incomplete<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"height <span class="free">kdt</span> <span class="main">-</span> min_height <span class="free">kdt</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> balanced <span class="free">kdt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> balanced_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> complete_build<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">h</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟹</span> complete <span class="main">(</span>build <span class="free">k</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_build complete_if_balanced_size_2powh size_build<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> height_build<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> height <span class="main">(</span>build <span class="free">k</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> complete_build<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> size_build<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> complete_iff_size<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Range_Search">
<div class="head">
<h1>Theory Range_Search</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Range_Search.thy
  Author:   Martin Rau, TU München
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Range Searching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Range_Search
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="KD_Tree.html">KD_Tree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Given two <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-dimensional points <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> which bound the search space, the search should
  return only the points which satisfy the following criteria:

  For every point p in the resulting set: \newline
  \hspace{1cm}  For every axis <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: \newline
  \hspace{2cm}    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">$</span></span><span class="free"><span class="free">k</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">$</span></span><span class="free"><span class="free">k</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">$</span></span><span class="free"><span class="free">k</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">$</span></span><span class="free"><span class="free">k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \newline

  For a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>2›</span></span></span></span>-d tree a query corresponds to selecting all the points in the rectangle that
  has <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p<span class="hidden">⇩</span><sub>1</sub>›</span></span></span></span> as its defining edges.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rectangle Definition›</span></span>

<span class="keyword1" id="Range_Search-cbox_point_def"><span class="command">lemma</span></span> cbox_point_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">≤</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∙</span> axis <span class="bound">k</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">p</span> <span class="main">∙</span> axis <span class="bound">k</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∙</span> axis <span class="bound">k</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∙</span> axis <span class="bound">k</span> <span class="main">1</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cbox_def <span class="keyword1"><span class="command">using</span></span> axis_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner_axis<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">≤</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">$</span><span class="bound">k</span> <span class="main">≤</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="bound">k</span> <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Search Function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">search</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point <span class="main">⇒</span> <span class="tfree">'k</span> point <span class="main">⇒</span> <span class="tfree">'k</span> kdt <span class="main">⇒</span> <span class="tfree">'k</span> point set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">search</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> cbox <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">then</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">search</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span>
      <span class="free">search</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span>
      <span class="free">search</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">search</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∪</span> <span class="free">search</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1" id="Range_Search-l_empty"><span class="command">lemma</span></span> l_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">&lt;</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">$</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_kdt <span class="free">l</span> <span class="main">∩</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free">l</span><span class="main">.</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span> <span class="main">&lt;</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">$</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free">l</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cbox_point_def leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Range_Search-r_empty"><span class="command">lemma</span></span> r_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="free">k</span> <span class="main">&lt;</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_kdt <span class="free">r</span> <span class="main">∩</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free">r</span><span class="main">.</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">$</span><span class="free">k</span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">$</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set_kdt <span class="free">r</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∉</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cbox_point_def leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Theorem›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> search_cbox<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">kdt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"search <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">kdt</span> <span class="main">=</span> set_kdt <span class="free">kdt</span> <span class="main">∩</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms l_empty r_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Nearest_Neighbors">
<div class="head">
<h1>Theory Nearest_Neighbors</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Nearest_Neighbors.thy
  Author:   Martin Rau, TU München
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nearest Neighbor Search on the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d Tree›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Nearest_Neighbors
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="KD_Tree.html">KD_Tree</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Verifying nearest neighbor search on the k-d tree. Given a <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>-d tree and a point <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>,
  which might not be in the tree, find the points <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ps›</span></span></span></span> that are closest to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> using the
  Euclidean metric.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas about <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sorted_wrt›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> sorted_wrt_take<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sorted_wrt_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_wrt_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_wrt_dist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted_wrt_dist</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_insort_key"><span class="command">lemma</span></span> sorted_wrt_dist_insort_key<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span> <span class="main">⟹</span> sorted_wrt_dist <span class="free">p</span> <span class="main">(</span>insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_dist_def set_insort_key<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_take_drop"><span class="command">lemma</span></span> sorted_wrt_dist_take_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_append<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">ps</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_dist_def<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_last_take_mono"><span class="command">lemma</span></span> sorted_wrt_dist_last_take_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>take <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="free">ps</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sorted_wrt_dist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Cons'<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_last_insort_key_eq"><span class="command">lemma</span></span> sorted_wrt_dist_last_insort_key_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span> <span class="main">≠</span> <span class="free">ps</span> <span class="main">@</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> last <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sorted_wrt_dist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_last"><span class="command">lemma</span></span> sorted_wrt_dist_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="free">ps</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="skolem">ps'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p'</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rev_exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="main">(</span><span class="skolem">ps'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_wrt_dist_def <span class="keyword1"><span class="command">using</span></span> sorted_wrt_append<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ps'</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">p'</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Neighbors Sorted wrt. Distance›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upd_nbors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point <span class="main">⇒</span> <span class="tfree">'k</span> point <span class="main">⇒</span> <span class="tfree">'k</span> point list <span class="main">⇒</span> <span class="tfree">'k</span> point list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">upd_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_nbors"><span class="command">lemma</span></span> sorted_wrt_dist_nbors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="main">(</span>upd_nbors <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="main">(</span>insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_dist_insort_key <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_dist_def sorted_wrt_take upd_nbors_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_nbors_diff"><span class="command">lemma</span></span> sorted_wrt_dist_nbors_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∪</span> <span class="main">{</span><span class="free">q</span><span class="main">}</span> <span class="main">-</span> set <span class="main">(</span>upd_nbors <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>upd_nbors <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="bound">s</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">r</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">q</span> <span class="main">}</span> <span class="main">=</span> set <span class="var">?ps'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_insort_key<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?ps'</span> <span class="main">=</span> set <span class="main">(</span>take <span class="free">n</span> <span class="var">?ps'</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="var">?ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> append_take_drop_id set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">∪</span> <span class="main">{</span> <span class="free">q</span> <span class="main">}</span> <span class="main">-</span> set <span class="main">(</span>take <span class="free">n</span> <span class="var">?ps'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="var">?ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="var">?ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_dist_insort_key <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_nbors_def <span class="keyword1"><span class="command">using</span></span> sorted_wrt_dist_take_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Nearest_Neighbors-sorted_wrt_dist_last_upd_nbors_mono"><span class="command">lemma</span></span> sorted_wrt_dist_last_upd_nbors_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>upd_nbors <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="free">ps</span><span class="main">)</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span> <span class="main">=</span> <span class="free">ps</span> <span class="main">@</span> <span class="main">[</span><span class="free">q</span><span class="main">]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_nbors_def <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_dist_last_take_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> last <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_wrt_dist_last_insort_key_eq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>upd_nbors  <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="main">(</span>insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upd_nbors_def <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_dist_last_take_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"insort_key <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> dist <span class="bound">q</span> <span class="free">p</span><span class="main">)</span> <span class="free">q</span> <span class="free">ps</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_dist_insort_key<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Recursive Nearest Neighbor Algorithm›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nearest_nbors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point list <span class="main">⇒</span> <span class="tfree">'k</span> point <span class="main">⇒</span> <span class="tfree">'k</span> kdt <span class="main">⇒</span> <span class="tfree">'k</span> point list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nearest_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Leaf <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> upd_nbors <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nearest_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="bound">candidates</span> <span class="main">=</span> <span class="free">nearest_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> length <span class="bound">candidates</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>last <span class="bound">candidates</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="bound">candidates</span>
      <span class="keyword1">else</span>
        <span class="free">nearest_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">candidates</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">candidates</span> <span class="main">=</span> <span class="free">nearest_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> length <span class="bound">candidates</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>last <span class="bound">candidates</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">$</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="bound">candidates</span>
      <span class="keyword1">else</span>
        <span class="free">nearest_nbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">candidates</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1" id="Nearest_Neighbors-cutoff_r"><span class="command">lemma</span></span> cutoff_r<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">$</span><span class="free">k</span> <span class="main">≤</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="free">r</span><span class="main">.</span> dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="bound">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set_kdt <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> dist <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="free">v</span> <span class="main">+</span> dist <span class="free">v</span> <span class="main">(</span><span class="skolem">q</span><span class="main">$</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dist <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span><span class="main">$</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_vec_nth_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Nearest_Neighbors-cutoff_l"><span class="command">lemma</span></span> cutoff_l<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="main">(</span>Node <span class="free">k</span> <span class="free">v</span> <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≤</span> <span class="free">p</span><span class="main">$</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="free">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="free">l</span><span class="main">.</span> dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="bound">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set_kdt <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="free">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> dist <span class="free">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="main">+</span> dist <span class="main">(</span><span class="skolem">q</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dist <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span><span class="main">$</span><span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_vec_nth_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="free">c</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Main Theorems›</span></span>

<span class="keyword1" id="Nearest_Neighbors-set_nns"><span class="command">lemma</span></span> set_nns<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span> <span class="main">⊆</span> set_kdt <span class="free">kdt</span> <span class="main">∪</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upd_nbors_def set_insort_key<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> in_set_takeD set_insort_key <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Nearest_Neighbors-length_nns"><span class="command">lemma</span></span> length_nns<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span> <span class="main">=</span> min <span class="free">n</span> <span class="main">(</span>size_kdt <span class="free">kdt</span> <span class="main">+</span> length <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upd_nbors_def<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-length_nns_gt_0"><span class="command">lemma</span></span> length_nns_gt_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def upd_nbors_def<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-length_nns_n"><span class="command">lemma</span></span> length_nns_n<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set_kdt <span class="free">kdt</span> <span class="main">∪</span> set <span class="free">ps</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">v</span> <span class="main">∧</span> length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>C<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">∧</span> length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>D<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> B
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="var">?nnsl</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsl</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span>set_kdt <span class="skolem">l</span> <span class="main">∪</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsl</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span>set_kdt <span class="skolem">r</span> <span class="main">∪</span> set <span class="var">?nnsl</span> <span class="main">-</span> set <span class="var">?nns</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_nns<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B Node.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> D
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="var">?nnsr</span> <span class="free">p</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsr</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span>set_kdt <span class="skolem">r</span> <span class="main">∪</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsr</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">⟶</span> <span class="main">(</span>set_kdt <span class="skolem">l</span> <span class="main">∪</span> set <span class="var">?nnsr</span> <span class="main">-</span> set <span class="var">?nns</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_nns<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D Node.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_nbors_def min_def set_insort_key<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-sorted_nns"><span class="command">lemma</span></span> sorted_nns<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span> <span class="main">⟹</span> sorted_wrt_dist <span class="free">p</span> <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_wrt_dist_nbors <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-distinct_nns"><span class="command">lemma</span></span> distinct_nns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">∩</span> set_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">∩</span> set_kdt <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">∩</span> set_kdt <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> DCLR<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?nnsl</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?nnsr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node invar_l invar_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?nnsl</span> <span class="main">∩</span> set_kdt <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?nnsr</span> <span class="main">∩</span> set_kdt <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> set_nns <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="var">?nnsl</span> <span class="free">p</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="var">?nnsr</span> <span class="free">p</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> DCLR invar_l invar_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> DCLR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_nbors_def distinct_insort<span class="main">)</span>

<span class="keyword1" id="Nearest_Neighbors-last_nns_mono"><span class="command">lemma</span></span> last_nns_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="free">ps</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="var">?nnsl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="var">?nnsr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_nns<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="var">?nnsl</span> <span class="free">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="var">?nnsr</span> <span class="free">p</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_nns Node invar_l invar_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="var">?nnsl</span> <span class="free">p</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="skolem">ps</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="var">?nnsr</span> <span class="free">p</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="skolem">ps</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> Node.prems invar_l length_nns_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Node <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_dist_last_upd_nbors_mono<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> dist_nns<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">∩</span> set_kdt <span class="free">kdt</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="free">kdt</span> <span class="main">∪</span> set <span class="free">ps</span> <span class="main">-</span> set <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span><span class="main">.</span> dist <span class="main">(</span>last <span class="main">(</span>nearest_nbors <span class="free">n</span> <span class="free">ps</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kdt</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="skolem">r</span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nnsr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="skolem">ps</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span> <span class="main">∪</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nnsl</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span> Node.prems invar_l invar_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span> <span class="main">∪</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nnsr</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span> Node.prems invar_r invar_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> SORTED_L<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="var">?nnsl</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_nns Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> SORTED_R<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="var">?nnsr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_nns Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> DISTINCT_L<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?nnsl</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.prems distinct_nns invar_set invar_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> DISTINCT_R<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?nnsr</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.prems distinct_nns invar_set invar_r
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf_bot_right inf_sup_absorb inf_sup_aci<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sup.commute<span class="main">)</span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">v</span> <span class="main">∧</span> length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>C<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">∧</span> length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
         <span class="main">|</span> <span class="main">(</span>D<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">$</span><span class="skolem">k</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> dist <span class="free">p</span> <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">v</span> <span class="main">(</span><span class="free">p</span><span class="main">$</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> A
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> cutoff_r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dist_commute<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IHL A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> B

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="var">?nnsl</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?nnsl</span> <span class="main">⊆</span> set_kdt <span class="skolem">l</span> <span class="main">∪</span> set <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">∩</span> set_kdt <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_nns Node.prems<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_nns disjoint_iff_not_equal<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?nnsl</span> <span class="main">∩</span> set_kdt <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> IHLR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span> <span class="main">∪</span> set <span class="var">?nnsl</span> <span class="main">-</span> set <span class="var">?nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ SORTED_L _ DISTINCT_L Node.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Node.prems<span class="main">(</span>1<span class="main">)</span> invar_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nnsl</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nnsl</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_nns_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> LAST<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> last_nns_mono SORTED_L invar_r Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IHL * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LAST <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span> <span class="main">∪</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span> <span class="main">-</span> set <span class="var">?nnsl</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span> <span class="main">-</span> set <span class="var">?nnsl</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsl</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_nns_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> LAST<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> last_nns_mono SORTED_L invar_r Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nnsl</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IHL * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LAST <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span> <span class="main">-</span> set <span class="var">?nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B R L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> C
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> cutoff_l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dist_commute less_imp_le<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> IHR C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> D

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nearest_nbors <span class="free">n</span> <span class="var">?nnsr</span> <span class="free">p</span> <span class="skolem">l</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?nnsr</span> <span class="main">⊆</span> set_kdt <span class="skolem">r</span> <span class="main">∪</span> set <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">∩</span> set_kdt <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_nns Node.prems<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_nns disjoint_iff_not_equal<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?nnsr</span> <span class="main">∩</span> set_kdt <span class="skolem">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> IHRL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span> <span class="main">∪</span> set <span class="var">?nnsr</span> <span class="main">-</span> set <span class="var">?nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ SORTED_R _ DISTINCT_R Node.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> Node.prems<span class="main">(</span>1<span class="main">)</span> invar_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nnsr</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nnsr</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_nns_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> LAST<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> last_nns_mono SORTED_R invar_l Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IHR * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LAST <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">l</span> <span class="main">∪</span> set <span class="skolem">ps</span> <span class="main">-</span> set <span class="var">?nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHRL <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span> <span class="main">-</span> set <span class="var">?nnsr</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span> <span class="main">-</span> set <span class="var">?nnsr</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?nnsr</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_nns_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> LAST<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> last_nns_mono SORTED_R invar_l Node.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nnsr</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IHR * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="skolem">q</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LAST <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="skolem">r</span> <span class="main">-</span> set <span class="var">?nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="var">?nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHRL <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D R L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_wrt_dist_nbors_diff upd_nbors_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nearest Neighbors Definition and Theorems›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nearest_neighbors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">::</span>finite<span class="main">)</span> point <span class="main">⇒</span> <span class="tfree">'k</span> kdt <span class="main">⇒</span> <span class="tfree">'k</span> point list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nearest_neighbors</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">kdt</span></span></span> <span class="main">=</span> nearest_nbors <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">kdt</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> length_nearest_neighbors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>nearest_neighbors <span class="free">n</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span> <span class="main">=</span> min <span class="free">n</span> <span class="main">(</span>size_kdt <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_nns nearest_neighbors_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> sorted_wrt_dist_nearest_neighbors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt_dist <span class="free">p</span> <span class="main">(</span>nearest_neighbors <span class="free">n</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_nns <span class="keyword1"><span class="command">unfolding</span></span> nearest_neighbors_def sorted_wrt_dist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">theorem</span></span> set_nearest_neighbors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>nearest_neighbors <span class="free">n</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span> <span class="main">⊆</span> set_kdt <span class="free">kdt</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nearest_neighbors_def <span class="keyword1"><span class="command">using</span></span> set_nns <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">theorem</span></span> distinct_nearest_neighbors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">kdt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>nearest_neighbors <span class="free">n</span> <span class="free">p</span> <span class="free">kdt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_nns nearest_neighbors_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> dist_nearest_neighbors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invar <span class="free">kdt</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">nns</span> <span class="main">=</span> nearest_neighbors <span class="free">n</span> <span class="free">p</span> <span class="free">kdt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>set_kdt <span class="free">kdt</span> <span class="main">-</span> set <span class="free">nns</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">nns</span><span class="main">.</span> dist <span class="bound">r</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="free">kdt</span> <span class="main">-</span> set <span class="free">nns</span><span class="main">.</span> dist <span class="main">(</span>last <span class="free">nns</span><span class="main">)</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nearest_neighbors_def dist_nns<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ _ True<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nearest_neighbors_def sorted_wrt_dist_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set_kdt <span class="free">kdt</span> <span class="main">-</span> set <span class="free">nns</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> set <span class="free">nns</span><span class="main">.</span> dist <span class="bound">n</span> <span class="free">p</span> <span class="main">≤</span> dist <span class="bound">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sorted_wrt_dist_nearest_neighbors<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">kdt</span></span><span class="main">]</span> sorted_wrt_dist_last<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">nns</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nearest_neighbors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">nns</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> nearest_neighbors_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_nns<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>