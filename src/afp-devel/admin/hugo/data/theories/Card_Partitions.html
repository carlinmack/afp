<div id="Set_Partition">
<div class="head">
<h1>Theory Set_Partition</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Set Partitions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Set_Partition
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FuncSet.html">HOL-Library.FuncSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Useful Additions to Main Theories›</span></span>

<span class="keyword1" id="Set_Partition-set_eqI'"><span class="command">lemma</span></span> set_eqI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Set_Partition-comp_image"><span class="command">lemma</span></span> comp_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(`)</span> <span class="free">f</span> <span class="main">∘</span> <span class="main">(`)</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(`)</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Introduction and Elimination Rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> partition_on<span class="antiquote"><span class="antiquote">}</span></span></span></span> is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="../../HOL/HOL-Library/Disjoint_Sets.html"></a><a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="comment1">(* TODO: move the following theorems to Disjoint Sets *)</span>

<span class="keyword1" id="Set_Partition-partition_onI"><span class="command">lemma</span></span> partition_onI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def disjoint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Set_Partition-partition_onE"><span class="command">lemma</span></span> partition_onE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟹</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def disjoint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Facts on Set Partitions›</span></span>

<span class="keyword1" id="Set_Partition-partition_onD4"><span class="command">lemma</span></span> partition_onD4<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_def disjoint_def<span class="main">)</span>

<span class="keyword1" id="Set_Partition-partition_subset_imp_notin"><span class="command">lemma</span></span> partition_subset_imp_notin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">⊂</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">∉</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X'</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_onD3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X'</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X'</span> <span class="main">⊂</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="free">X</span> <span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjnt_def disjointD inf.strict_order_iff partition_onD2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X'</span> <span class="main">⊂</span> <span class="free">X</span>›</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> all_not_in_conv disjnt_iff psubsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_Diff"><span class="command">lemma</span></span> partition_on_Diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟹</span> partition_on <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">⋃</span><span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P P<span class="main">[</span><span class="operator">THEN</span> partition_onD4<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_def disjoint_def<span class="main">)</span>

<span class="keyword1" id="Set_Partition-partition_on_UN"><span class="command">lemma</span></span> partition_on_UN<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> partition_on <span class="bound">b</span> <span class="main">(</span><span class="free">P</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B<span class="main">[</span><span class="operator">THEN</span> partition_onD1<span class="main">]</span> A<span class="main">[</span><span class="operator">THEN</span> partition_onD1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> B<span class="main">[</span><span class="operator">THEN</span> partition_onD3<span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">P</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∩</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> i j <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> B<span class="main">[</span><span class="operator">THEN</span> partition_onD2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjointD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i j A<span class="main">[</span><span class="operator">THEN</span> partition_onD2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pairwise_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">⊆</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">⊆</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B<span class="main">[</span><span class="operator">THEN</span> partition_onD1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> B<span class="main">[</span><span class="operator">THEN</span> partition_onD1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjnt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_notemptyI"><span class="command">lemma</span></span> partition_on_notemptyI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>

<span class="keyword1" id="Set_Partition-partition_on_disjoint"><span class="command">lemma</span></span> partition_on_disjoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">B</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∩</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>

<span class="keyword1" id="Set_Partition-partition_on_eq_implies_eq_carrier"><span class="command">lemma</span></span> partition_on_eq_implies_eq_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">B</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>

<span class="keyword1" id="Set_Partition-partition_on_insert"><span class="command">lemma</span></span> partition_on_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="free">A</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">X</span> <span class="main">=</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A'</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_def disjoint_def disjnt_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An alternative formulation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> partition_on_insert<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>
<span class="keyword1" id="Set_Partition-partition_on_insert'"><span class="command">lemma</span></span> partition_on_insert'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjnt <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjnt_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> this assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">X</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_on_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">⊆</span> <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_partition sup_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_insert_singleton"><span class="command">lemma</span></span> partition_on_insert_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A'</span> <span class="main">(</span>insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partition_on_def disjoint_def disjnt_def<span class="main">)</span>

<span class="keyword1" id="Set_Partition-partition_on_remove_singleton"><span class="command">lemma</span></span> partition_on_remove_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">-</span> <span class="free">X</span> <span class="main">=</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A'</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms partition_on_Diff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_cancel Diff_subset cSup_singleton insert_subset<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Unique Part Containing an Element in a Set Partition›</span></span>

<span class="keyword1" id="Set_Partition-partition_on_partition_on_unique"><span class="command">lemma</span></span> partition_on_partition_on_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> partition_onE disjoint_iff_not_equal<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this X <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_the_part_mem"><span class="command">lemma</span></span> partition_on_the_part_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_partition_on_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> theI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_in_the_unique_part"><span class="command">lemma</span></span> partition_on_in_the_unique_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_partition_on_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> theI'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_the_part_eq"><span class="command">lemma</span></span> partition_on_the_part_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_partition_on_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> the1_equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Set_Partition-the_unique_part_alternative_def"><span class="command">lemma</span></span> the_unique_part_alternative_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> partition_on_in_the_unique_part <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> partition_on_the_part_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> partition_on_the_part_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_all_in_part_eq_part"><span class="command">lemma</span></span> partition_on_all_in_part_eq_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X'</span><span class="main">}</span> <span class="main">=</span> <span class="free">X'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X'</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> partition_on_in_the_unique_part <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X'</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X'</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X'</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> partition_on_the_part_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">X'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_part_characteristic"><span class="command">lemma</span></span> partition_on_part_characteristic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> partition_onE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_the_part_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> the_unique_part_alternative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_no_partition_outside_carrier"><span class="command">lemma</span></span> partition_on_no_partition_outside_carrier<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cardinality of Parts in a Set Partition›</span></span>

<span class="keyword1" id="Set_Partition-partition_on_le_set_elements"><span class="command">lemma</span></span> partition_on_le_set_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">P</span> <span class="main">≤</span> card <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">≤</span> card <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> prop_partition_on<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="skolem">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> Int_iff UnionI empty_iff insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> prop_partition_on A_eq <span class="keyword1"><span class="command">have</span></span> partition_on<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="skolem">A</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partition_onI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> insert.hyps<span class="main">(</span>3<span class="main">)</span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this insert<span class="main">(</span>1<span class="main">,</span> 2<span class="main">,</span> 4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_elements<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> partition_on<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> p_def <span class="keyword1"><span class="command">have</span></span> a_notmem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span> <span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">∉</span> <span class="bound">p'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> p_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def disjoint_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_insert_absorb Diff_subset inf.orderE mk_disjoint_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="skolem">A</span> <span class="var">?P'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this p_def <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span><span class="main">∈</span>insert <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Diff_eq_empty_iff subset_singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> p_def this <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span> a_notmem <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>insert <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pa</span> <span class="bound">pa'</span><span class="main">.</span> <span class="bound">pa</span><span class="main">∈</span>insert <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">pa'</span><span class="main">∈</span>insert <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">pa</span> <span class="main">≠</span> <span class="bound">pa'</span> <span class="main">⟹</span> <span class="bound">pa</span> <span class="main">∩</span> <span class="bound">pa'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> p_def a_notmem
        <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def disjoint_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal insert_Diff insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="skolem">A</span> <span class="var">?P'</span>›</span></span> finite_elements <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_def <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> card.remove <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="skolem">A</span> <span class="var">?P'</span>›</span></span> insert.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_le <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations on Set Partitions›</span></span>

<span class="keyword1" id="Set_Partition-partition_on_union"><span class="command">lemma</span></span> partition_on_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">B</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">B</span> <span class="free">Q</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">B</span> <span class="free">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> UnE partition_onE<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_split1"><span class="command">lemma</span></span> partition_on_split1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="main">⋃</span><span class="free">P</span><span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Un_iff partition_onE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">p'</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∩</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_onE subsetCE sup_ge1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_split2"><span class="command">lemma</span></span> partition_on_split2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span><span class="free">P</span> <span class="main">∪</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="main">⋃</span><span class="free">Q</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms partition_on_split1 sup_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Set_Partition-partition_on_intersect_on_elements"><span class="command">lemma</span></span> partition_on_intersect_on_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">C</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">P</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">p'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∩</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_insert_elements"><span class="command">lemma</span></span> partition_on_insert_elements<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">B</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">_</span> <span class="var">?P</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> partition_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹partition_on <span class="free">B</span> <span class="free">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="var">?P</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">B</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="var">?P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="var">?P</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X'</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> <span class="var">?P</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Y'</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">Y'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≠</span> <span class="skolem">Y</span>›</span></span> X' Y' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">≠</span> <span class="skolem">Y'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this X' Y' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∩</span> <span class="skolem">Y'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">B</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> X' Y' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y'</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">B</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">∩</span> <span class="skolem">Y'</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> X' Y' <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">≠</span> <span class="skolem">Y'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-partition_on_map"><span class="command">lemma</span></span> partition_on_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">p'</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∩</span> <span class="bound">p'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> IntI empty_iff rev_image_eqI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Set_Partition-set_of_partition_on_map"><span class="command">lemma</span></span> set_of_partition_on_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI'<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_on_map<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">=</span> <span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(`)</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(`)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI'<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> X mem <span class="keyword1"><span class="command">have</span></span> in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI'<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> in_range <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_the_inv_into_f<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> in_range x' <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> f_the_inv_into_f<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">A</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> x' <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">A</span>›</span></span> mem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">Y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_the_inv_into_f<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(`)</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="free">f</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_the_inv_into<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_on_map<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Injectivity_Solver">
<div class="head">
<h1>Theory Injectivity_Solver</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combinatorial Basics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Injectivity_Solver
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
These lemmas shall be added to the Disjoint Set theory.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Injectivity and Disjoint Families›</span></span>

<span class="keyword1" id="Injectivity_Solver-inj_on_impl_disjoint_family_on_singleton"><span class="command">lemma</span></span> inj_on_impl_disjoint_family_on_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms disjoint_family_on_def inj_on_contraD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Cardinality Theorems for Set.bind›</span></span>

<span class="keyword1" id="Injectivity_Solver-card_bind"><span class="command">lemma</span></span> card_bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> finite <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> card <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> card <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_UN_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Injectivity_Solver-card_bind_constant"><span class="command">lemma</span></span> card_bind_constant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> finite <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> card <span class="free">S</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind<span class="main">)</span>

<span class="keyword1" id="Injectivity_Solver-card_bind_singleton"><span class="command">lemma</span></span> card_bind_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind_constant inj_on_impl_disjoint_family_on_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Third Version of Injectivity Solver›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here, we provide a third version of the injectivity solver. The original first version was provided
in the AFP entry `Spivey's Generalized Recurrence for Bell Numbers`. From that method, I derived a
second version in the AFP entry `Cardinality of Equivalence Relations`. At roughly the same time,
Makarius improved the injectivity solver in the development version of the first AFP entry. This
third version now includes the improvements of the second version and Makarius improvements
to the first, and it further extends the method to handle the new cases in the cardinality proof
of this AFP entry.

As the implementation of the injectivity solver only evolves in the development branch of the AFP,
the submissions of the three AFP entries that employ the injectivity solver, have to create clones
of the injectivity solver for the identified and needed method adjustments. Ultimately, these three
clones should only remain in the stable branches of the AFP from Isabelle2016 to Isabelle2017
to work with their corresponding release versions.
In the development version, I have now consolidated the three versions here.
In the next step, I will move this version of the injectivity solver in
the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="../../HOL/HOL-Library/Disjoint_Sets.html"></a><a href="../../HOL/HOL-Library/Disjoint_Sets.html">HOL-Library.Disjoint_Sets</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span> and it will hopefully only evolve further there.
›</span></span>

<span class="keyword1" id="Injectivity_Solver-disjoint_family_onI"><span class="command">lemma</span></span> disjoint_family_onI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="free">A</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> disjoint_family_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Injectivity_Solver-disjoint_bind"><span class="command">lemma</span></span> disjoint_bind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">T</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">S</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">T</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">s</span> <span class="main">∩</span> <span class="bound">g</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">S</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⤜</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">T</span> <span class="bound">t</span><span class="main">}</span> <span class="main">⤜</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Injectivity_Solver-disjoint_bind'"><span class="command">lemma</span></span> disjoint_bind'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">T</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">f</span> <span class="bound">s</span> <span class="main">∩</span> <span class="bound">g</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">S</span> <span class="main">⤜</span> <span class="bound">f</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="bound">T</span> <span class="main">⤜</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Injectivity_Solver-injectivity_solver_CollectE"><span class="command">lemma</span></span> injectivity_solver_CollectE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="free">a'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">P'</span> <span class="free">a'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">W</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">W</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Injectivity_Solver-injectivity_solver_prep_assms_Collect"><span class="command">lemma</span></span> injectivity_solver_prep_assms_Collect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Injectivity_Solver-injectivity_solver_prep_assms"><span class="command">lemma</span></span> injectivity_solver_prep_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Injectivity_Solver-disjoint_terminal_singleton"><span class="command">lemma</span></span> disjoint_terminal_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">X</span> <span class="main">=</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">X</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Injectivity_Solver-disjoint_terminal_Collect"><span class="command">lemma</span></span> disjoint_terminal_Collect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="free">S</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">T</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">S</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">T</span> <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Injectivity_Solver-disjoint_terminal"><span class="command">lemma</span></span> disjoint_terminal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Injectivity_Solver-elim_singleton"><span class="command">lemma</span></span> elim_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∧</span> <span class="free">x'</span> <span class="main">∈</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">x'</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">method</span></span> injectivity_solver <span class="keyword2"><span class="keyword">uses</span></span> rule <span class="main">=</span>
  <span class="operator">insert</span> <span class="dynamic"><span class="dynamic">method_facts</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">use</span> nothing <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹
    ((<span class="operator">drule</span> injectivity_solver_prep_assms_Collect <span class="keyword3">|</span> <span class="operator">drule</span> injectivity_solver_prep_assms)<span class="keyword3">+</span>)<span class="keyword3">?</span><span class="keyword3">;</span>
    <span class="operator">rule</span> disjoint_family_onI<span class="keyword3">;</span>
    ((<span class="operator">rule</span> disjoint_bind <span class="keyword3">|</span> <span class="operator">rule</span> disjoint_bind')<span class="keyword3">+</span>)<span class="keyword3">?</span><span class="keyword3">;</span>
    (<span class="operator">erule</span> elim_singleton)<span class="keyword3">?</span><span class="keyword3">;</span>
    (<span class="operator">erule</span> disjoint_terminal_singleton <span class="keyword3">|</span> <span class="operator">erule</span> disjoint_terminal_Collect <span class="keyword3">|</span> <span class="operator">erule</span> disjoint_terminal)<span class="keyword3">;</span>
    (<span class="operator">elim</span> injectivity_solver_CollectE)<span class="keyword3">?</span><span class="keyword3">;</span>
    <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">rule</span></span><span class="keyword3">;</span>
    <span class="operator">assumption</span><span class="keyword3">+</span>
  ›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Card_Partitions">
<div class="head">
<h1>Theory Card_Partitions</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Cardinality of Set Partitions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Card_Partitions
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stirling.html">HOL-Library.Stirling</a>"</span>
  <a href="Set_Partition.html">Set_Partition</a>
  <a href="Injectivity_Solver.html">Injectivity_Solver</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Card_Partitions-set_partition_on_insert_with_fixed_card_eq"><span class="command">lemma</span></span> set_partition_on_insert_with_fixed_card_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
     <span class="bound">P</span> <span class="main">&lt;-</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="free">k</span><span class="main">}</span><span class="main">;</span>
     <span class="bound">p</span> <span class="main">&lt;-</span> <span class="bound">P</span><span class="main">;</span>
     <span class="main">{</span>insert <span class="main">(</span>insert <span class="free">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">P</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>
  <span class="main">}</span><span class="main">)</span>
  <span class="main">∪</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">P</span> <span class="main">&lt;-</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span><span class="main">;</span>
    <span class="main">{</span>insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span>
  <span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?T</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="var">?T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?T</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> partition_on_Diff<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Diff_singleton<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_ge_0_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">{</span>insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="var">?p</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="var">?p'</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partition_on_in_the_unique_part <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partition_on_the_part_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partition_subset_imp_notin <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="free">a</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">note</span></span> facts_on_the_part_of <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="free">a</span> <span class="free">A</span>›</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite.insertI finite_elements<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="var">?p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="var">?p'</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts_on_the_part_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_on_remove_singleton<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="var">?P'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts_on_the_part_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_on_insert <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjnt_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?P'</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="free">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">∈</span> <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">(</span>insert <span class="free">a</span> <span class="var">?p</span><span class="main">)</span> <span class="main">(</span><span class="var">?P'</span> <span class="main">-</span> <span class="main">{</span><span class="var">?p</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facts_on_the_part_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="free">k</span><span class="main">}</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{</span>insert <span class="main">(</span>insert <span class="free">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">P</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?T</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?subexpr1</span> <span class="main">∪</span> <span class="var">?subexpr2</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?subexpr1</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">(</span>insert <span class="free">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P'</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_remove_singleton<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> <span class="main">_</span>›</span></span> finite_elements <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="skolem">p</span> <span class="main">∉</span> <span class="skolem">P'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> <span class="main">_</span>›</span></span> this <span class="quoted"><span class="quoted">‹card <span class="skolem">P'</span> <span class="main">=</span> Suc <span class="free">k</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_on_insert <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> partition_onD1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjnt_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?subexpr2</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P'</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="skolem">P'</span>›</span></span> finite_elements <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="skolem">P'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">P'</span> <span class="main">=</span> <span class="free">k</span>›</span></span> this <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">A</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_insert_singleton<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Card_Partitions-injectivity_subexpr1"><span class="command">lemma</span></span> injectivity_subexpr1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">X'</span> <span class="main">∈</span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>insert <span class="free">a</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>insert <span class="free">a</span> <span class="free">X'</span><span class="main">)</span> <span class="main">(</span><span class="free">P'</span> <span class="main">-</span> <span class="main">{</span><span class="free">X'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partition_on <span class="free">A</span> <span class="free">P</span> <span class="main">∧</span> card <span class="free">P</span> <span class="main">=</span> Suc <span class="free">k'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>partition_on <span class="free">A</span> <span class="free">P'</span> <span class="main">∧</span> card <span class="free">P'</span> <span class="main">=</span> Suc <span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">X</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">X'</span> <span class="main">∉</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">X</span> <span class="main">=</span> insert <span class="free">a</span> <span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff insertE insertI1 mem_simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> partition_onD1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">X'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> <span class="free">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">X'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> insert_ident<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹insert <span class="free">a</span> <span class="free">X</span> <span class="main">=</span> insert <span class="free">a</span> <span class="free">X'</span>›</span></span> <span class="quoted"><span class="quoted">‹insert <span class="free">a</span> <span class="free">X</span> <span class="main">∉</span> <span class="free">P</span>›</span></span> <span class="quoted"><span class="quoted">‹insert <span class="free">a</span> <span class="free">X'</span> <span class="main">∉</span> <span class="free">P'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_Diff insert_absorb insert_commute insert_ident<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Card_Partitions-injectivity_subexpr2"><span class="command">lemma</span></span> injectivity_subexpr2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partition_on <span class="free">A</span> <span class="free">P</span> <span class="main">∧</span> card <span class="free">P</span> <span class="main">=</span> <span class="free">k'</span><span class="main">)</span> <span class="main">∧</span> partition_on <span class="free">A</span> <span class="free">P'</span> <span class="main">∧</span> card <span class="free">P'</span> <span class="main">=</span> <span class="free">k'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_onD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> insert <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="free">P'</span> <span class="main">-</span> <span class="main">{</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∉</span> <span class="free">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> card_partition_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_empty eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_eq_0_iff finite_UnionD<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 0 insert <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subexpr1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">P</span> <span class="main">&lt;-</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span><span class="main">;</span>
      <span class="bound">p</span> <span class="main">&lt;-</span> <span class="bound">P</span><span class="main">;</span>
      <span class="main">{</span>insert <span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">P</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subexpr2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">P</span> <span class="main">&lt;-</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">k'</span><span class="main">}</span><span class="main">;</span>
      <span class="main">{</span>insert <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?subexpr1</span> <span class="main">∪</span> <span class="var">?subexpr2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> card <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_partition_on_insert_with_fixed_card_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="skolem">k'</span> <span class="main">+</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">*</span> Suc <span class="skolem">k'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?subexpr1</span> <span class="main">∧</span> card <span class="var">?subexpr1</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">*</span> Suc <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finitely_many_partition_on<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> finite <span class="main">(</span><span class="bound">X</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{</span>insert <span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> finite_elements <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> finite_bind
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite.emptyI finite_insert mem_Collect_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{</span>insert <span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">P</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> injectivity_subexpr1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">P</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{</span>insert <span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> that <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> finite_elements <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> insert <span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> that injectivity_subexpr1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind_singleton<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?subexpr1</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span> <span class="main">*</span> Suc <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind_constant<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?subexpr1</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">*</span> Suc <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?subexpr1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> Suc <span class="skolem">k'</span><span class="main">}</span><span class="main">.</span> finite <span class="main">(</span><span class="bound">X</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">{</span>insert <span class="main">(</span>insert <span class="skolem">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">X</span> <span class="main">-</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?subexpr2</span> <span class="main">∧</span> card <span class="var">?subexpr2</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="skolem">k'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">k'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finitely_many_partition_on<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" inj_on <span class="main">(</span>insert <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">k'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> injectivity_subexpr2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> <span class="skolem">A</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?subexpr2</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">k'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind_singleton<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?subexpr2</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="skolem">A</span><span class="main">)</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?subexpr2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">k'</span><span class="main">}</span>›</span></span> finite_bind<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subexpr1</span> <span class="main">∩</span> <span class="var">?subexpr2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="var">?subexpr1</span><span class="main">.</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∉</span> <span class="bound">P</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="var">?subexpr2</span><span class="main">.</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∈</span> <span class="bound">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subexpr1</span> <span class="main">∩</span> <span class="var">?subexpr2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Stirling <span class="main">(</span>card <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> card_partition_on_at_most_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> Stirling <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"card"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_UN_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> finitely_many_partition_on<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> Stirling <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_partition_on<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> partition_on_size1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> P this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Suc_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> UnionE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">X'</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_1_singletonE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> this X<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">∈</span> <span class="skolem">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_onI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> P this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> card_partition_on_size1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms partition_on_size1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Card_Partitions-card_partition_on_size1_eq_1"><span class="command">lemma</span></span> card_partition_on_size1_eq_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> partition_on_size1 <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="free">A</span> <span class="main">≤</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_partition_on_size1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Card_Partitions-card_partition_on_size1_eq_0"><span class="command">lemma</span></span> card_partition_on_size1_eq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">A</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> partition_on_size1 <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">P</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> card <span class="bound">X</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Collect_empty_eq leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card.empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>